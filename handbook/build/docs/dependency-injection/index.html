<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.8">
<link rel="alternate" type="application/rss+xml" href="/furion/blog/rss.xml" title="Furion RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/furion/blog/atom.xml" title="Furion Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Furion" href="/furion/opensearch.xml"><title data-react-helmet="true">12. 依赖注入/控制反转 | Furion</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://furion.pro/furion/docs/dependency-injection"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="12. 依赖注入/控制反转 | Furion"><meta data-react-helmet="true" name="description" content="由于很多朋友第一次接触 依赖注入/控制反转 的架构理念，所以没搞明白 作用域 和 多线程解析服务 的问题，从而不正确的使用导致内存不断飙高，正确的方式应该是："><meta data-react-helmet="true" property="og:description" content="由于很多朋友第一次接触 依赖注入/控制反转 的架构理念，所以没搞明白 作用域 和 多线程解析服务 的问题，从而不正确的使用导致内存不断飙高，正确的方式应该是："><link data-react-helmet="true" rel="shortcut icon" href="/furion/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://furion.pro/furion/docs/dependency-injection"><link data-react-helmet="true" rel="alternate" href="https://furion.pro/furion/docs/dependency-injection" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://furion.pro/furion/docs/dependency-injection" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/furion/assets/css/styles.2db0c50f.css">
<link rel="preload" href="/furion/assets/js/runtime~main.0ed34235.js" as="script">
<link rel="preload" href="/furion/assets/js/main.355f4384.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div class="furion-give-me-star"><div class="Typist"></div></div><div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_2qcr"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/furion/"><div class="navbar__logo"><img src="/furion/img/furionlogo.png" alt="Furion Logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/furion/img/furionlogo.png" alt="Furion Logo" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">Furion</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/furion/docs">文档</a><a class="navbar__item navbar__link" href="/furion/docs/global/app">静态类</a><a class="navbar__item navbar__link" href="/furion/docs/settings/appsettings">配置</a><a class="navbar__item navbar__link" href="/furion/blog">博客✨</a><a class="navbar__item navbar__link" href="/furion/docs/upgrade">更新日志</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link">源码</a><ul class="dropdown__menu"><li><a href="https://gitee.com/dotnetchina/Furion" target="_blank" rel="noopener noreferrer" class="dropdown__link"><span>Gitee<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://github.com/MonkSoul/Furion" target="_blank" rel="noopener noreferrer" class="dropdown__link"><span>GitHub<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><a href="https://www.chinadot.net" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>社区<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a class="navbar__item navbar__link" href="/furion/docs/case">案例</a><a class="navbar__item navbar__link" href="/furion/docs/donate">支持</a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">🌜</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">🌞</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_35hR" type="button"></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo sidebarWithHideableNavbar_267A"><a tabindex="-1" class="sidebarLogo_3h0W" href="/furion/"><img src="/furion/img/furionlogo.png" alt="Furion Logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/furion/img/furionlogo.png" alt="Furion Logo" class="themedImage_1VuW themedImage--dark_hz6m"><b>Furion</b></a><nav class="menu thin-scrollbar menu_Bmed"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">1. 序言</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">2. 入门指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/appstartup">3. 应用启动 Startup</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">4. 配置与选项</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/dynamic-api-controller">5. 动态 WebAPI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/specification-document">6. 规范化接口文档 (Swagger)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/friendly-exception">7. 友好异常处理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/data-validation">8. 数据校验</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">9. 数据库操作指南（EFCore）</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">10. SqlSugar 或其他 ORM</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/saas">11. SaaS 多租户</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/furion/docs/dependency-injection">12. 依赖注入/控制反转</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/object-mapper">13. 对象数据映射 Mapper</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/cache">14. 分布式缓存</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/auth-control">15. 安全鉴权</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/cors">16. CORS 跨域</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/view-engine">17. 视图引擎</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/logging">18. 日志记录</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/http">19. 远程请求 (HttpClient)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/encryption">20. 数据加解密</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/local-language">21. 全球化和本地化（多语言）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/event-bus">22. 事件总线（New）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/json-serialization">23. JSON 序列化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/signalr">24. 即时通讯</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/process-service">25. 辅助角色服务 (Worker Service)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/job">26. 定时任务/后台任务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/idgenerator">27. 分布式 ID 生成</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/module-dev">28. 模块化开发</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/clayobj">29. 粘土对象</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/sensitive-detection">30. 脱敏处理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/file-provider">31. 虚拟文件系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/sesssion-state">32. 会话和状态管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/ipc">33. IPC 进程通信</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">34. 托管部署</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">35. 持续部署集成</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">36. 测试指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/dotnet-tools">37. 编写包管理工具 (Tools)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/furion/docs/contribute">38. 贡献指南</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>12. 依赖注入/控制反转</h1></header><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>阅前必读</h5></div><div class="admonition-content"><p>由于很多朋友第一次接触 <code>依赖注入/控制反转</code> 的架构理念，所以没搞明白 <code>作用域</code> 和 <code>多线程解析服务</code> 的问题，从而不正确的使用导致内存不断飙高，正确的方式应该是：</p><ul><li>尽可能的采用构造函数注入（如果这个类支持）</li><li>在非静态中（<strong>但在 Web 请求有效的声明周期内</strong>）可安全使用 <code>App.GetService&lt;&gt;</code> 解析服务，如果是 <code>单例服务</code>，优先推荐构造函数注入或 <code>App.RootServices.GetService&lt;&gt;</code> 方式</li><li>🤐 <strong>在非 <code>Web</code> 环境、多线程环境、物联网等环境（含事件总线、定时任务等）🏒 除单例服务以外 🏒 必须采用 <code>Scoped.Create()</code> 方式创建作用域且服务在内部委托中解析！</strong> 🤐</li></ul></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="121-依赖注入">12.1 依赖注入<a aria-hidden="true" class="hash-link" href="#121-依赖注入" title="Direct link to heading">​</a></h2><p>所谓依赖注入，是指程序运行过程中，如果需要调用另一个对象协助时，无须在代码中创建被调用者，而是依赖于外部的注入。</p><p>通俗来讲，就是把有依赖关系的类放到容器中，然后在我们需要这些类时，容器自动解析出这些类的实例。</p><p>依赖注入最大的好处时实现类的解耦，利于程序拓展、单元测试、自动化模拟测试等。</p><p>依赖注入的英文为：<code>Dependency Injection</code>，简称 <code>DI</code></p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="122-控制反转">12.2 控制反转<a aria-hidden="true" class="hash-link" href="#122-控制反转" title="Direct link to heading">​</a></h2><p>控制反转只是一个概念，也就是将创建对象实例的控制权（原本是程序员）从代码控制权剥离到 <code>IOC 容器</code> 中控制。</p><p>控制反转的英文为：<code>Inversion of Control</code>，简称 <code>IOC</code></p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="123-iocdi-优缺点">12.3 <code>IOC/DI</code> 优缺点<a aria-hidden="true" class="hash-link" href="#123-iocdi-优缺点" title="Direct link to heading">​</a></h2><p>传统的代码，每个对象负责管理与自己需要依赖的对象，导致如果需要切换依赖对象的实现类时，需要修改多处地方。同时，过度耦合也使得对象难以进行单元测试。</p><ul><li><p>优点</p><ul><li>依赖注入把对象的创造交给外部去管理,很好的解决了代码紧耦合（tight couple）的问题，是一种让代码实现松耦合（loose couple）的机制</li><li>松耦合让代码更具灵活性，能更好地应对需求变动，以及方便单元测试</li></ul></li><li><p>缺点</p><ul><li>目前主流的 <code>IOC/DI</code> 基本采用反射的方式来实现依赖注入，在一定程度会影响性能</li></ul></li></ul><div class="admonition admonition-important alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>特别说明</h5></div><div class="admonition-content"><p>在本章节不打算细讲 <code>依赖注入/控制反转</code> 具体实现和应用场景，想了解更多知识，可查阅 【<a href="https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-5.0" target="_blank" rel="noopener noreferrer">ASP.NET Core 依赖注入</a>】 官方文档。</p></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="124-依赖注入的三种方式">12.4 依赖注入的三种方式<a aria-hidden="true" class="hash-link" href="#124-依赖注入的三种方式" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="1241-构造方法注入">12.4.1 构造方法注入<a aria-hidden="true" class="hash-link" href="#1241-构造方法注入" title="Direct link to heading">​</a></h3><p>目前构造方法注入是依赖注入推荐使用方式。</p><ul><li><p>优点</p><ul><li>在构造方法中体现出对其他类的依赖，一眼就能看出这个类需要依赖哪些类才能工作</li><li>脱离了 IOC 框架，这个类仍然可以工作，POJO 的概念</li><li>一旦对象初始化成功了，这个对象的状态肯定是正确的</li></ul></li><li><p>缺点</p><ul><li>构造函数会有很多参数（Bad smell）</li><li>有些类是需要默认构造函数的，比如 MVC 框架的 Controller 类，一旦使用构造函数注入，就无法使用默认构造函数</li><li>这个类里面的有些方法并不需要用到这些依赖（Bad smell）</li></ul></li></ul><p>代码示例：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">public class FurionService</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    private readonly IRepository _repository;</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">    public FurionService(IRepository repository)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        _repository = repository;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="1242-属性方式注入">12.4.2 属性方式注入<a aria-hidden="true" class="hash-link" href="#1242-属性方式注入" title="Direct link to heading">​</a></h3><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>特别声明</h5></div><div class="admonition-content"><p>在 <code>Furion</code> 新版本中，已经移除属性注入功能，建议使用构造函数或方法方式注入，也可以通过 <code>App.GetService&lt;TService&gt;</code> 方式注入。</p></div></div><p><strong>通过属性方式注入容易和类的实例属性混淆，不建议使用。</strong></p><ul><li><p>优点</p><ul><li>在对象的整个生命周期内，可以随时动态的改变依赖</li><li>非常灵活</li></ul></li><li><p>缺点</p><ul><li>对象在创建后，被设置依赖对象之前这段时间状态是不对的</li><li>不直观，无法清晰地表示哪些属性是必须的</li></ul></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">public class FurionService</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">    public IRepository Repository { get; set; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="1243-方法参数注入">12.4.3 方法参数注入<a aria-hidden="true" class="hash-link" href="#1243-方法参数注入" title="Direct link to heading">​</a></h3><p>方法参数注入的意思是在创建对象后，通过自动调用某个方法来注入依赖。</p><ul><li><p>优点：</p><ul><li>比较灵活</li></ul></li><li><p>缺点：</p><ul><li>新加入依赖时会破坏原有的方法签名，如果这个方法已经被其他很多模块用到就很麻烦</li><li>与构造方法注入一样，会有很多参数</li></ul></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">public class FurionService</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">    public Person GetById([FromServices]IRepository repository, int id)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        return repository.Find(id);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="125-注册对象生存期">12.5 注册对象生存期<a aria-hidden="true" class="hash-link" href="#125-注册对象生存期" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="1251-暂时瞬时-生存期">12.5.1 <code>暂时/瞬时</code> 生存期<a aria-hidden="true" class="hash-link" href="#1251-暂时瞬时-生存期" title="Direct link to heading">​</a></h3><p>暂时生存期服务是每次从服务容器进行请求时创建的。 这种生存期适合轻量级、 无状态的服务。</p><p>在处理请求的应用中，在请求结束时会释放暂时服务。</p><p>通常我们使用 <code>ITransient</code> 接口依赖表示该生命周期。</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="1252-作用域-生存期">12.5.2 <code>作用域</code> 生存期<a aria-hidden="true" class="hash-link" href="#1252-作用域-生存期" title="Direct link to heading">​</a></h3><p>作用域生存期服务针对每个客户端请求（连接）创建一次。在处理请求的应用中，在请求结束时会释放有作用域的服务。</p><p>通常我们使用 <code>IScoped</code> 接口依赖表示该生命周期。</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="1253-单例-生存期">12.5.3 <code>单例</code> 生存期<a aria-hidden="true" class="hash-link" href="#1253-单例-生存期" title="Direct link to heading">​</a></h3><p>在首次请求它们时进行创建，之后每个后续请求都使用相同的实例。</p><p>通常我们使用 <code>ISingleton</code> 接口依赖表示该生命周期。</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>了解更多</h5></div><div class="admonition-content"><p>想了解更多 <code>服务生存期</code> 知识可查阅 <a href="https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-5.0#service-lifetimes" target="_blank" rel="noopener noreferrer">ASP.NET Core - 依赖注入 - 服务生存期</a> 章节。</p></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="126-内置依赖接口">12.6 内置依赖接口<a aria-hidden="true" class="hash-link" href="#126-内置依赖接口" title="Direct link to heading">​</a></h2><p><code>Furion</code> 框架提供三个接口依赖分别对应不同的服务生存期：</p><ul><li><code>ITransient</code>：对应暂时/瞬时作用域服务生存期</li><li><code>IScoped</code>：对应请求作用域服务生存期</li><li><code>ISingleton</code>：对应单例作用域服务生存期</li></ul><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>特别注意</h5></div><div class="admonition-content"><p>以上三个接口只能实例类实现，其他静态类、抽象类、及接口不能实现。</p></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="127-常见使用">12.7 常见使用<a aria-hidden="true" class="hash-link" href="#127-常见使用" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="1271-第一个例子">12.7.1 第一个例子<a aria-hidden="true" class="hash-link" href="#1271-第一个例子" title="Direct link to heading">​</a></h3><p>创建 <code>IBusinessService</code> 接口和 <code>BusinessService</code> 实现类，代码如下：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Furion.Core;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Furion.DatabaseAccessor;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Furion.DependencyInjection;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">namespace Furion.Application</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">    public interface IBusinessService</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        Person Get(int id);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">    public class BusinessService : IBusinessService, ITransient</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        private readonly IRepository&lt;Person&gt; _personRepository;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        public BusinessService(IRepository&lt;Person&gt; personRepository)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            _personRepository = personRepository;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        public Person Get(int id)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            return _personRepository.Find(id);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>创建 <code>PersonController</code> 控制器，代码如下：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Furion.Application;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Mvc;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">namespace Furion.Web.Entry.Controllers</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    [Route(&quot;api/[controller]&quot;)]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    [ApiController]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    public class PersonController : ControllerBase</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        private readonly IBusinessService _businessService;</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">        public PersonController(IBusinessService businessService)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            _businessService = businessService;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        [HttpGet]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        public IActionResult Get(int id)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">            var person = _businessService.Get(id);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            return new JsonResult(person);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><img src="/furion/img/di1.gif"><hr><p><strong>例子解说</strong></p><p><code>Furion</code> 框架提供了非常灵活且方便的实现依赖注入的方式，只需要实例类继承对应生存期的接口即可，这里继承了 <code>ITransient</code>，也就表明了这是一个 <code>暂时/瞬时</code> 作用域实例类。该类就可以作为被注入对象，同时也能注入其他接口对象。</p><p>上面的例子中，<code>BusinessService</code> 注入了 <code>IRepository&lt;Person&gt;</code> 仓储接口，同时 <code>PersonController</code> 控制器注入了 <code>IBusinessService</code> 接口。</p><p>这样 <code>PersonController</code> 和 <code>BusinessService</code> 之间就实现了解耦，不再依赖于具体的 <code>BusinessService</code> 实例。</p><p>这就是依赖注入/控制反转最经典的例子。</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="1272-注册泛型实例">12.7.2 注册泛型实例<a aria-hidden="true" class="hash-link" href="#1272-注册泛型实例" title="Direct link to heading">​</a></h3><p>创建 <code>IBusinessService&lt;T&gt;</code> 接口和 <code>BusinessService&lt;T&gt;</code> 实现类，代码如下：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Furion.Core;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Furion.DatabaseAccessor;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Furion.DependencyInjection;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">namespace Furion.Application</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">    public interface IBusinessService&lt;T&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        Person Get(int id);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">    public class BusinessService&lt;T&gt; : IBusinessService&lt;T&gt;, ITransient</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        private readonly IRepository&lt;Person&gt; _personRepository;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        public BusinessService(IRepository&lt;Person&gt; personRepository)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            _personRepository = personRepository;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        public Person Get(int id)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            return _personRepository.Find(id);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>创建 <code>PersonController</code> 控制器，代码如下：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Furion.Application;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Mvc;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">namespace Furion.Web.Entry.Controllers</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    [Route(&quot;api/[controller]&quot;)]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    [ApiController]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    public class PersonController : ControllerBase</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        private readonly IBusinessService&lt;int&gt; _businessService;</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">        public PersonController(IBusinessService&lt;int&gt; businessService)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            _businessService = businessService;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        [HttpGet]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        public IActionResult Get(int id)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">            var person = _businessService.Get(id);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            return new JsonResult(person);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="1273-一个接口多个实现">12.7.3 一个接口多个实现<a aria-hidden="true" class="hash-link" href="#1273-一个接口多个实现" title="Direct link to heading">​</a></h3><p>默认情况下，一个接口只对应一个实现类，但有些特殊情况，需要多个实现类注册同一个接口，如 <code>DbContext</code> 多数据库情况。</p><p>这个时候我们可以通过依赖注入 <code>Func&lt;string, IPrivateDependency, object&gt;</code> 委托来解析多个实例，其中委托的参数分别为：</p><ul><li>参数 1：<code>string</code> 类型，不同实现类唯一标识，默认为 <code>nameof(实现类)</code> 名称</li><li>参数 2：<code>Type</code> 类型，<code>IPrivateDependency</code> 派生接口，也就是 <code>ITransient</code>、<code>IScoped</code>、<code>ISingleton</code></li><li>返回值：<code>object</code> 类型，返回具体的实现类实例</li></ul><p>创建 <code>IBusinessService</code> 接口和 <code>BusinessService</code>、<code>OtherBusinessService</code> 两个实现类，代码如下：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Furion.DependencyInjection;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">namespace Furion.Application</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">    public interface IBusinessService</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        string GetName();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">    public class BusinessService : IBusinessService, ITransient</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        public string GetName()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            return &quot;我是：&quot; + nameof(BusinessService);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">    public class OtherBusinessService : IBusinessService, ITransient</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        public string GetName()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            return &quot;我是：&quot; + nameof(OtherBusinessService);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>创建 <code>ValueController</code> 控制器，代码如下：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Furion.Application;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Furion.DependencyInjection;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Mvc;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">namespace Furion.Web.Entry.Controllers</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    [Route(&quot;api/[controller]&quot;)]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    [ApiController]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    public class ValueController : ControllerBase</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        private readonly IBusinessService _businessService;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        private readonly IBusinessService _otherBusinessService;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">        public ValueController(Func&lt;string, ITransient, object&gt; resolveNamed)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">            _businessService = resolveNamed(&quot;BusinessService&quot;, default) as IBusinessService;</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">            _otherBusinessService = resolveNamed(&quot;OtherBusinessService&quot;, default) as IBusinessService;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        [HttpGet]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        public string GetName()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            return _businessService.GetName() + &quot;----------&quot; + _otherBusinessService.GetName();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><img src="/furion/img/di2.gif"><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>小知识</h5></div><div class="admonition-content"><p>如果需要自定义解析名称，只需要贴 <code>[Injection(Named = &quot;名称&quot;)]</code> 即可，如：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Furion.DependencyInjection;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">namespace Furion.Application</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">    [Injection(Named = &quot;BusName1&quot;)]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    public class BusinessService : IBusinessService, ITransient</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // ...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">    [Injection(Named = &quot;BusName2&quot;)]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    public class OtherBusinessService : IBusinessService, ITransient</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // ...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>解析服务：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">_businessService = resolveNamed(&quot;BusName1&quot;, default) as IBusinessService;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">_otherBusinessService = resolveNamed(&quot;BusName2&quot;, default) as IBusinessService;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="1274-无接口方式">12.7.4 无接口方式<a aria-hidden="true" class="hash-link" href="#1274-无接口方式" title="Direct link to heading">​</a></h3><p>有些时候，我们不想定义接口，而是想把实例类作为可依赖注入的对象，如 MVC 中的控制器。</p><p>创建 <code>SelfService</code> 实例类，代码如下：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Furion.Core;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Furion.DatabaseAccessor;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Furion.DependencyInjection;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">namespace Furion.Application</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">    public class SelfService : ITransient</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        private readonly IRepository&lt;Person&gt; _personRepository;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">        public SelfService(IRepository&lt;Person&gt; personRepository)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            _personRepository = personRepository;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        public Person Get(int id)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            return _personRepository.Find(id);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>创建 <code>ValueController</code> 控制器，代码如下：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Furion.Application;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Furion.Core;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Microsoft.AspNetCore.Mvc;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">namespace Furion.Web.Entry.Controllers</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    [Route(&quot;api/[controller]&quot;)]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    [ApiController]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    public class ValueController : ControllerBase</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        private readonly SelfService _selfService;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">        public ValueController(SelfService selfService)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            _selfService = selfService;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        [HttpGet]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        public Person Get(int id)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">            return _selfService.Get(id);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="128-injection-特性配置">12.8 <code>[Injection]</code> 特性配置<a aria-hidden="true" class="hash-link" href="#128-injection-特性配置" title="Direct link to heading">​</a></h2><p><code>Furion</code> 框架提供 <code>[Injection]</code> 特性可以改变注册方式，同时还能配置 <code>AOP</code> 拦截。</p><p><code>[Injection]</code> 提供以下配置支持：</p><ul><li><code>Action</code>：配置注册行为，<code>InjectionActions</code> 类型，可选值：<ul><li><code>Add</code>：<strong>默认值</strong>，表示无限制添加注册服务，该方式支持一个接口多个实现</li><li><code>TryAdd</code>：表示注册已存在则跳过注册</li></ul></li><li><code>Pattern</code>：配置注册选项，<code>InjectionPatterns</code> 类型，可选值：<ul><li><code>Self</code>：只注册自己</li><li><code>FirstInterface</code>：只注册第一个接口</li><li><code>SelfWithFirstInterface</code>：注册自己和第一个接口</li><li><code>ImplementedInterfaces</code>：注册所有接口</li><li><code>All</code>：注册自己包括所有接口 ，<strong>默认值</strong></li></ul></li><li><code>Named</code>：配置实例别名，通过别名可以解析接口，如同一个接口有多个实现，那么可以通过别名解析不同的实现，默认只为实现类的类名</li><li><code>Order</code>：注册排序，数字越大，则越在最后注册，默认 <code>0</code></li><li><code>Proxy</code>：配置代理拦截类型，也就是 <code>AOP</code>，<strong>代理类型必须继承 <code>AspectDispatchProxy</code> 类和 <code>IDispatchProxy</code> 接口</strong>，无默认值</li><li><code>ExpectInterfaces</code>：配置忽略注册的接口，<code>Type[]</code> 类型</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="129-自定义高级注册">12.9 自定义高级注册<a aria-hidden="true" class="hash-link" href="#129-自定义高级注册" title="Direct link to heading">​</a></h2><p>默认情况下，<code>Furion</code> 提供的注册方式可以满足大多数依赖注入的需求，如有特别注册需求，只需要在 <code>Startup</code> 中配置即可，如：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">services.AddScoped(typeof(ISpecService), provider = &gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // 自定义任何创建实例的方式</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    var instance = new SpecService();  // 或者可以通过 AOP插件返回代理实例</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    return instance;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">});</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>补充说明</h5></div><div class="admonition-content"><p><code>Furion</code> 框架中的 <code>AppDbContext</code> 数据库上下文还有 <code>ISqlDispatchProxy</code> 都是通过这种方式创建的。</p></div></div><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>知识导航</h5></div><div class="admonition-content"><p>想了解更多自定义高级中注册，可查阅 【<a href="https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-5.0" target="_blank" rel="noopener noreferrer">ASP.NET Core 依赖注入</a>】 官方文档。</p></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="1210-appsettingsjson-配置注册">12.10 <code>appsettings.json</code> 配置注册<a aria-hidden="true" class="hash-link" href="#1210-appsettingsjson-配置注册" title="Direct link to heading">​</a></h2><p>除了在代码中实现依赖注入，也可以实现动态依赖注入，无需修改代码或重新编译即可实现热插拔（插件）效果。配置如下：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;DependencyInjectionSettings&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;Definitions&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;Interface&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Furion.Application;Furion.Application.ITestService&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;Service&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Furion.Application;Furion.Application.TestService&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;RegisterType&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Transient&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;Action&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Add&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;Pattern&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;SelfWithFirstInterface&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;Named&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;TestService&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;Order&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;Proxy&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Furion.Application;Furion.Application.LogDispathProxy&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>配置说明：</p><ul><li><code>DependencyInjectionSettings</code>：依赖注入配置根节点<ul><li><code>Definitions</code>：动态依赖注入配置节点，<code>ExternalService</code> 数组类型<ul><li><code>ExternalService</code>：配置单个依赖注入信息<ul><li><code>Interface</code>：配置依赖接口信息，格式：<code>程序集名称;接口完整名称</code>，如：<code>Furion.Application;Furion.Application.ITestService</code></li><li><code>Service</code>：配置接口实现信息，格式同上</li><li><code>RegisterType</code>：配置依赖注入的对象生存期，取值：<code>Transient</code>，<code>Scoped</code>，<code>Singleton</code></li><li><code>Action</code>：注册行为，可选值：<code>Add</code>，<code>TryAdd</code>，参见 <a href="#128-injection-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE">#128-injection-特性配置</a></li><li><code>Pattern</code>：注册选项，参见 <a href="#128-injection-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE">#128-injection-特性配置</a></li><li><code>Named</code>：注册别名，参见 <a href="#128-injection-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE">#128-injection-特性配置</a></li><li><code>Order</code>：注册排序，参见 <a href="#128-injection-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE">#128-injection-特性配置</a></li><li><code>Proxy</code>：配置代理拦截，格式：<code>程序集名称;代理类完整名称</code>，参见 <a href="#128-injection-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE">#128-injection-特性配置</a></li></ul></li></ul></li></ul></li></ul><div class="admonition admonition-important alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>关于外部程序集</h5></div><div class="admonition-content"><p>如果动态注入的对象是外部程序集，那么首先先注册外部程序集：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;AppSettings&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;ExternalAssemblies&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;外部程序集名称&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Taobao.Pay&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// 支持多个</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="1211-注册顺序和优先级">12.11 注册顺序和优先级<a aria-hidden="true" class="hash-link" href="#1211-注册顺序和优先级" title="Direct link to heading">​</a></h2><p><code>Furion</code> 框架中，默认注册顺序是按照程序集扫描顺序进行注册，如果需要改变注册顺序，可通过 <code>[Injection(Order)]</code> 特性指定，<code>Order</code> 值越大，则越在最后注册。</p><p>另外 <code>appsettings.json</code> 配置的优先级最大，<code>appsettings.json</code> 配置的注册会覆盖之前所有注册。</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="1212-aop-注册拦截">12.12 <code>Aop</code> 注册拦截<a aria-hidden="true" class="hash-link" href="#1212-aop-注册拦截" title="Direct link to heading">​</a></h2><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>关于动态 API 和服务的区别</h5></div><div class="admonition-content"><p>如果您的服务是动态 API，那么请使用 <a href="/furion/docs/dynamic-api-controller#511-%E5%85%B3%E4%BA%8E-aop-%E6%8B%A6%E6%88%AA">动态 API - AOP 拦截</a>，原因是动态 API 本质是控制器，所以采用 <code>Filter</code> 方式。</p></div></div><p><code>AOP</code> 是非常重要的思想和技术，也就是 <code>面向切面</code> 编程，可以让我们在不改动原来代码的情况下进行动态篡改业务代码。</p><p>在 <code>Furion</code> 框架中，实现 <code>Aop</code> 非常简单，如：</p><p>假设我们有 <code>ITestService</code> 和 <code>TestService</code> 两个类型：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">public interface ITestService</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    string SayHello(string word);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">public class TestService: ITestService, ITransient</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    public string SayHello(string word)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        return $&quot;Hello {word}&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>现在我们有一个需求，我们希望调用 <code>SayHello</code> 的时候可以记录日志和权限控制（之前没有考虑到的需求）。</p><p>这个时候我们只需要创建一个代理类即可，如 <code>LogDispatchProxy</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">using Furion.DependencyInjection;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using System;</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">using System.Reflection;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">namespace Furion.Application</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">    public class LogDispatchProxy : AspectDispatchProxy, IDispatchProxy</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        /// 当前服务实例</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        public object Target { get; set; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        /// 服务提供器，可以用来解析服务，如：Services.GetService()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        public IServiceProvider Services { get; set; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        /// 拦截方法</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;param name=&quot;method&quot;&gt;&lt;/param&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;param name=&quot;args&quot;&gt;&lt;/param&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        /// &lt;returns&gt;&lt;/returns&gt;</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">        public override object Invoke(MethodInfo method, object[] args)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Console.WriteLine(&quot;SayHello 方法被调用了&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            var result = method.Invoke(Target, args);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Console.WriteLine(&quot;SayHello 方法返回值：&quot; + result);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            return result;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // 异步无返回值</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">        public override async Task InvokeAsync(MethodInfo method, object[] args)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Console.WriteLine(&quot;SayHello 方法被调用了&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            var task = method.Invoke(Target, args) as Task;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            await task;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">             Console.WriteLine(&quot;SayHello 方法调用完成&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // 异步带返回值</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">        public override async Task&lt;T&gt; InvokeAsyncT&lt;T&gt;(MethodInfo method, object[] args)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Console.WriteLine(&quot;SayHello 方法被调用了&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            var taskT = method.Invoke(Target, args) as Task&lt;T&gt;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            var result = await taskT;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Console.WriteLine(&quot;SayHello 方法返回值：&quot; + result);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            return result;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="admonition admonition-important alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>获取特性</h5></div><div class="admonition-content"><p>如果需要获取方法的特性，只需要通过 <code>method.GetActualCustomAttribute&lt;TArrbute&gt;()</code> 即可。所有获取真实的特性统一采用 <code>method.GetActual....()</code> 方法开头。</p></div></div><p>之后我们只需要为 <code>TestService</code> 增加 <code>[Injection]</code> 特性即可，如：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">[Injection(Proxy = typeof(LogDispatchProxy))]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">public class TestService: ITestService, ITransient</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    public string SayHello(string word)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        return $&quot;Hello {word}&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>之后 <code>SayHello</code> 方法被调用的时候就可以实现动态拦截了，比如这里写日志。</p><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="12121-全局aop拦截">12.12.1 <code>全局Aop拦截</code><a aria-hidden="true" class="hash-link" href="#12121-全局aop拦截" title="Direct link to heading">​</a></h3><p><code>Furion</code> 框架也提供了全局拦截的方式，只需要将 <code>IDispatchProxy</code> 修改为 <code>IGlobalDispatchProxy</code> 即可。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">using Furion;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Reflection;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">namespace Furion.Application</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    public class LogDispatchProxy : AspectDispatchProxy, IGlobalDispatchProxy</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // ....</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>这样就会拦截所有的 <code>Service</code>，当然也可以通过给特定类贴 <code>[SuppressProxy]</code> 跳过全局拦截操作。</p><div class="admonition admonition-important alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>拦截优先级</h5></div><div class="admonition-content"><p><code>[SuppressProxy]</code> &gt; <code>[Injection(Proxy = typeof(LogDispatchProxy))]</code> &gt; <code>全局拦截</code>。</p></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="12122-aop-注入解析服务">12.12.2 <code>AOP</code> 注入解析服务<a aria-hidden="true" class="hash-link" href="#12122-aop-注入解析服务" title="Direct link to heading">​</a></h3><p><code>Furion</code> 框架未提供 <code>Proxy</code> 构造函数注入功能，但是提供了 <code>Services</code> 属性，如果需要解析服务，则可以通过以下方式：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">var someServices = Services.GetService&lt;ISomeService&gt;(); // 推荐方式</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// 或</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">var someServices = App.GetService&lt;ISomeService&gt;();</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="12123-aop-的作用">12.12.3 <code>AOP</code> 的作用<a aria-hidden="true" class="hash-link" href="#12123-aop-的作用" title="Direct link to heading">​</a></h3><p>这种面向切面的能力（动态拦截/代理）可以实现很多很多功能，如：</p><ul><li>动态日志记录</li><li>动态修改参数</li><li>动态修改返回值</li><li>动态方法重定向</li><li>动态修改代码逻辑</li><li>动态实现异常监听</li></ul><p>还可以做更多更多的事情。</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="1213-反馈与建议">12.13 反馈与建议<a aria-hidden="true" class="hash-link" href="#1213-反馈与建议" title="Direct link to heading">​</a></h2><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>与我们交流</h5></div><div class="admonition-content"><p>给 Furion 提 <a href="https://gitee.com/dotnetchina/Furion/issues/new?issue" target="_blank" rel="noopener noreferrer">Issue</a>。</p></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://gitee.com/dotnetchina/Furion/tree/master/handbook/docs/dependency-injection.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2021-07-19T09:29:18.000Z">7/19/2021</time></b> by <b>Monk</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/furion/docs/saas"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« <!-- -->11. SaaS 多租户</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/furion/docs/object-mapper"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">13. 对象数据映射 Mapper<!-- --> »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#121-依赖注入" class="table-of-contents__link toc-highlight">12.1 依赖注入</a></li><li><a href="#122-控制反转" class="table-of-contents__link toc-highlight">12.2 控制反转</a></li><li><a href="#123-iocdi-优缺点" class="table-of-contents__link toc-highlight">12.3 <code>IOC/DI</code> 优缺点</a></li><li><a href="#124-依赖注入的三种方式" class="table-of-contents__link toc-highlight">12.4 依赖注入的三种方式</a><ul><li><a href="#1241-构造方法注入" class="table-of-contents__link toc-highlight">12.4.1 构造方法注入</a></li><li><a href="#1242-属性方式注入" class="table-of-contents__link toc-highlight">12.4.2 属性方式注入</a></li><li><a href="#1243-方法参数注入" class="table-of-contents__link toc-highlight">12.4.3 方法参数注入</a></li></ul></li><li><a href="#125-注册对象生存期" class="table-of-contents__link toc-highlight">12.5 注册对象生存期</a><ul><li><a href="#1251-暂时瞬时-生存期" class="table-of-contents__link toc-highlight">12.5.1 <code>暂时/瞬时</code> 生存期</a></li><li><a href="#1252-作用域-生存期" class="table-of-contents__link toc-highlight">12.5.2 <code>作用域</code> 生存期</a></li><li><a href="#1253-单例-生存期" class="table-of-contents__link toc-highlight">12.5.3 <code>单例</code> 生存期</a></li></ul></li><li><a href="#126-内置依赖接口" class="table-of-contents__link toc-highlight">12.6 内置依赖接口</a></li><li><a href="#127-常见使用" class="table-of-contents__link toc-highlight">12.7 常见使用</a><ul><li><a href="#1271-第一个例子" class="table-of-contents__link toc-highlight">12.7.1 第一个例子</a></li><li><a href="#1272-注册泛型实例" class="table-of-contents__link toc-highlight">12.7.2 注册泛型实例</a></li><li><a href="#1273-一个接口多个实现" class="table-of-contents__link toc-highlight">12.7.3 一个接口多个实现</a></li><li><a href="#1274-无接口方式" class="table-of-contents__link toc-highlight">12.7.4 无接口方式</a></li></ul></li><li><a href="#128-injection-特性配置" class="table-of-contents__link toc-highlight">12.8 <code>[Injection]</code> 特性配置</a></li><li><a href="#129-自定义高级注册" class="table-of-contents__link toc-highlight">12.9 自定义高级注册</a></li><li><a href="#1210-appsettingsjson-配置注册" class="table-of-contents__link toc-highlight">12.10 <code>appsettings.json</code> 配置注册</a></li><li><a href="#1211-注册顺序和优先级" class="table-of-contents__link toc-highlight">12.11 注册顺序和优先级</a></li><li><a href="#1212-aop-注册拦截" class="table-of-contents__link toc-highlight">12.12 <code>Aop</code> 注册拦截</a><ul><li><a href="#12121-全局aop拦截" class="table-of-contents__link toc-highlight">12.12.1 <code>全局Aop拦截</code></a></li><li><a href="#12122-aop-注入解析服务" class="table-of-contents__link toc-highlight">12.12.2 <code>AOP</code> 注入解析服务</a></li><li><a href="#12123-aop-的作用" class="table-of-contents__link toc-highlight">12.12.3 <code>AOP</code> 的作用</a></li></ul></li><li><a href="#1213-反馈与建议" class="table-of-contents__link toc-highlight">12.13 反馈与建议</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">文档</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/furion/docs/get-start">入门</a></li><li class="footer__item"><a class="footer__link-item" href="/furion/docs">指南</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">社区</h4><ul class="footer__items"><li class="footer__item"><a href="https://gitee.com/dotnetchina/Furion/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">讨论</a></li><li class="footer__item"><a href="https://gitee.com/dotnetchina/Furion/board" target="_blank" rel="noopener noreferrer" class="footer__link-item">看板</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">更多</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/furion/blog">博客</a></li><li class="footer__item"><a href="https://gitee.com/dotnetchina/Furion" target="_blank" rel="noopener noreferrer" class="footer__link-item">仓库</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://gitee.com/dotnetchina" target="_blank" rel="noopener noreferrer" class="footerLogoLink_qW4Z"><img class="footer__logo" src="/furion/img/chinadotnet.png" style="background:#fff;padding:5px 10px"></a></div><div class="footer__copyright">Copyright © 2020-2021 百小僧, Baiqian Co.,Ltd.</div></div></div></footer></div>
<script src="/furion/assets/js/runtime~main.0ed34235.js"></script>
<script src="/furion/assets/js/main.355f4384.js"></script>
</body>
</html>