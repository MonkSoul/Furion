---
id: unittest
title: 36.1 å•å…ƒ/é›†æˆæµ‹è¯•
sidebar_label: 36.1 å•å…ƒ/é›†æˆæµ‹è¯•
---

import Tag from "@site/src/components/Tag.js";

<details>
  <summary>ğŸ“ æ¨¡å—æ›´æ–°æ—¥å¿—</summary>
  <div>
<div>

- **é—®é¢˜ä¿®å¤**

  - &nbsp;<Tag>ä¿®å¤</Tag> `Furion.Xunit/Furion.Pure.Xunit` å•å…ƒæµ‹è¯•ä¾èµ–æ³¨å…¥å•ä¾‹æœåŠ¡æ—¶ä¸æ˜¯åŒä¸€å®ä¾‹é—®é¢˜ <sup>4.8.5.3</sup> <sup>â±ï¸2023.01.31</sup> [305511e](https://gitee.com/dotnetchina/Furion/commit/305511ec6322019622c392a23957042d2dcae7fb)

</div>
  </div>
</details>

import useBaseUrl from "@docusaurus/useBaseUrl";

## 36.1.1 å…³äºå•å…ƒæµ‹è¯•

å¼•ç”¨è‡ªç™¾åº¦ç™¾ç§‘ï¼š

> å•å…ƒæµ‹è¯•ï¼ˆunit testingï¼‰ï¼Œæ˜¯æŒ‡å¯¹è½¯ä»¶ä¸­çš„æœ€å°å¯æµ‹è¯•å•å…ƒè¿›è¡Œæ£€æŸ¥å’ŒéªŒè¯ã€‚å¯¹äºå•å…ƒæµ‹è¯•ä¸­å•å…ƒçš„å«ä¹‰ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè¦æ ¹æ®å®é™…æƒ…å†µå»åˆ¤å®šå…¶å…·ä½“å«ä¹‰ï¼Œå¦‚ C è¯­è¨€ä¸­å•å…ƒæŒ‡ä¸€ä¸ªå‡½æ•°ï¼ŒJava é‡Œå•å…ƒæŒ‡ä¸€ä¸ªç±»ï¼Œå›¾å½¢åŒ–çš„è½¯ä»¶ä¸­å¯ä»¥æŒ‡ä¸€ä¸ªçª—å£æˆ–ä¸€ä¸ªèœå•ç­‰ã€‚æ€»çš„æ¥è¯´ï¼Œå•å…ƒå°±æ˜¯äººä¸ºè§„å®šçš„æœ€å°çš„è¢«æµ‹åŠŸèƒ½æ¨¡å—ã€‚å•å…ƒæµ‹è¯•æ˜¯åœ¨è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­è¦è¿›è¡Œçš„æœ€ä½çº§åˆ«çš„æµ‹è¯•æ´»åŠ¨ï¼Œè½¯ä»¶çš„ç‹¬ç«‹å•å…ƒå°†åœ¨ä¸ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†ç›¸éš”ç¦»çš„æƒ…å†µä¸‹è¿›è¡Œæµ‹è¯•ã€‚

## 36.1.2 å•å…ƒæµ‹è¯•å¥½å¤„

- **æ¶ˆç­ä½çº§é”™è¯¯**

åŸºæœ¬çš„å•å…ƒæµ‹è¯•ï¼Œå¯ä»¥åœ¨ç³»ç»Ÿæµ‹è¯•ä¹‹å‰ï¼ŒæŠŠå¤§éƒ¨åˆ†æ¯”è¾ƒä½çº§çš„é”™è¯¯éƒ½æ¶ˆç­æ‰ï¼Œå‡å°‘ç³»ç»Ÿæµ‹è¯•è¿‡ç¨‹ä¸­çš„é—®é¢˜ï¼Œè¿™æ ·ä¹Ÿå°±å‡å°‘äº†ç³»ç»Ÿæµ‹è¯•ä¸­å®šä½å’Œè§£å†³é—®é¢˜çš„æ—¶é—´æˆæœ¬äº†ã€‚

- **æ‰¾å‡ºæ½œåœ¨çš„ bug**

æŸäº›ç±»å‹çš„ bugï¼Œé ç³»ç»Ÿæµ‹è¯•æ˜¯å¾ˆéš¾æ‰¾åˆ°çš„ã€‚ä¾‹å¦‚ä¸€äº›ä»£ç åˆ†æ”¯ï¼Œå¹³æ—¶ 99%çš„åœºæ™¯åŸºæœ¬ä¸Šéƒ½èµ°ä¸åˆ°ï¼Œä½†ä¸€æ—¦èµ°åˆ°äº†ï¼Œå¦‚æœæ²¡æœ‰æå‰æµ‹è¯•å¥½ï¼Œé‚£ä¹ˆå¯èƒ½å°±æ˜¯ä¸€ä¸ªç¾éš¾ã€‚

- **ä¸Šçº¿å‰çš„ä¿è¯**

åŠ äº†æ–°ä»£ç ï¼Œä¸Šçº¿å‰è·‘ä¸€æŠŠå•å…ƒæµ‹è¯•ï¼Œéƒ½é€šè¿‡ï¼Œè¯´æ˜ä»£ç å¯èƒ½æ²¡æœ‰å½±å“åˆ°ä¹‹å‰çš„é€»è¾‘ï¼Œè¿™æ ·ä¸Šçº¿ä¹Ÿæ¯”è¾ƒæ”¾å¿ƒã€‚å¦‚æœä¹‹å‰çš„å•å…ƒæµ‹è¯•è·‘ä¸è¿‡ï¼Œé‚£ä¹ˆå¾ˆæœ‰å¯èƒ½æ–°çš„ä»£ç æœ‰æ½œåœ¨çš„é—®é¢˜ï¼Œèµ¶ç´§ä¿®å¤å»å§ã€‚

- **é‡æ„ä»£ç çš„æœºä¼š**

å†™å•å…ƒæµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œä½ å¯èƒ½ä¼šé¡ºæ‰‹æŠŠä¸€äº› code é‡æ„äº†ï¼Œä¸ºä»€ä¹ˆï¼Ÿä¸¾ä¾‹ï¼Œä¸€äº›é•¿å¾—éå¸¸åƒçš„ä»£ç ï¼Œå¦‚æœæ¯æ¬¡éƒ½è¦å†™ä¸€å †æµ‹è¯•ä»£ç å»æµ‹åŒæ ·çš„ codeï¼Œä½ ä¼šä¸ä¼šæŠ“ç‹‚ï¼Ÿä¸æµ‹å§ï¼Œè¦†ç›–ç‡åˆä¸Šä¸å»ï¼Œäºæ˜¯æˆ‘å°±ä¼šæƒ³æ–¹è®¾æ³•æŠŠå¾…æµ‹è¯•çš„ code æ”¹å¾—å°½é‡çš„ç²¾ç®€ï¼Œé‡å¤ä»£ç å‡å°‘ï¼Œè¿™æ ·è¦†ç›–ç‡ä¸Šå»äº†ï¼Œæµ‹è¯•ä¹Ÿå¥½æµ‹äº†ï¼Œä»£ç ä¹Ÿç®€æ´äº†ã€‚å¦‚æœæ²¡æœ‰å•å…ƒæµ‹è¯•å’Œè¦†ç›–ç‡çš„è¦æ±‚çš„è¯ï¼Œå¦ç™½è¯´å¯èƒ½ä¸€æ¥è‡ªå·±ä¸ä¼šå‘ç°è¿™äº›é‡å¤çš„ codeï¼Œå¦ä¸€æ–¹é¢å³ä½¿å‘ç°äº†ï¼Œå¯èƒ½ä¹Ÿæ²¡æœ‰å¤ªå¤§çš„åŠ¨åŠ›å»æ”¹è¿›ã€‚

å¦å¤–ï¼Œç”±äºå•å…ƒæµ‹è¯•ä¸­ï¼Œä½ éœ€è¦å°è¯•å»è¦†ç›–ä¸€äº›å¼‚å¸¸åˆ†æ”¯ï¼Œè¿™æ˜¯ç³»ç»Ÿæµ‹è¯•å¸¸å¸¸èµ°ä¸åˆ°çš„åœ°æ–¹ï¼Œäºæ˜¯å°±ä¼šå¼•èµ·ä½ çš„ä¸€äº›æ€è€ƒï¼Œä¾‹å¦‚è¿™ä¸ªå¼‚å¸¸åˆ†æ”¯æ˜¯å¦çœŸçš„éœ€è¦ï¼Ÿæ˜¯å¦çœŸçš„ä¼šå‘ç”Ÿï¼Ÿå¯¹äºä¸€äº›å®é™…ä¸Šç»å¯¹ä¸ä¼šå‡ºé”™çš„å‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘è§‰å¾—å¯èƒ½å¼‚å¸¸åˆ†æ”¯æ˜¯æ²¡å¿…è¦å­˜åœ¨çš„ã€‚

- **é‡æ–° review ä»£ç çš„æœºä¼š**

å†™ UT çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘æ€»æ˜¯ä¼šå¥½å¥½çœ‹å“ªäº›ä»£ç æ‰§è¡Œåˆ°äº†ï¼Œå“ªäº›ä»£ç æ²¡æœ‰æ‰§è¡Œåˆ°ï¼Œè¿™å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ª review è‡ªå·±ä»£ç çš„æœºä¼šï¼Œæœ‰äº›æ—¶å€™ï¼Œå¹¶ä¸æ˜¯ UT æœ¬èº«å¸®æˆ‘æ‰¾åˆ° bugï¼Œè€Œæ˜¯å›å¤´ review è‡ªå·±ä»£ç çš„æ—¶å€™å‘ç°çš„ã€‚

## 36.1.3 å•å…ƒæµ‹è¯•ç±»å‹

- åŸºäº API æ¥å£æµ‹è¯•ï¼ˆç™½ç›’ + æµ…åº¦é»‘ç›’æµ‹è¯•ï¼‰
- åŸºäºé¡¹ç›®ä»£ç æµ‹è¯•ï¼ˆæ·±åº¦ç™½ç›’æµ‹è¯•ï¼‰

## 36.1.4 ä¸»æµçš„å•å…ƒæµ‹è¯•åº“

- `xUnit`ï¼ˆ**æœ€æµè¡Œçš„åº“ï¼Œæ¨è**ï¼‰
- `NUnit`
- `MSTest`

**åœ¨æœ¬ç« èŠ‚ï¼Œ`Furion` æ¡†æ¶ä½¿ç”¨ `xUnit` åº“è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚**

## 36.1.5 ç¬¬ä¸€ä¸ªä¾‹å­

### 36.1.5.1 åˆ›å»º `xUnit` å•å…ƒæµ‹è¯•é¡¹ç›®

<img src={useBaseUrl("img/ut1.png")} />

### 36.1.5.2 ç¬¬ä¸€ä¸ªæµ‹è¯•æ–¹æ³•

```cs showLineNumbers  {1,7,10}
using Xunit;

namespace TestProject1
{
    public class UnitTest1
    {
        [Fact]
        public void Test1()
        {
            Assert.Equal(2, 1 + 1);
        }
    }
}
```

å•å…ƒæµ‹è¯•å®é™…ä¸Šæ˜¯é€šè¿‡æ™®é€šçš„ç±»çš„æ–¹æ³•è¿›è¡Œæ¨¡å—åŠŸèƒ½æµ‹è¯•ï¼Œå…·ä½“æµ‹è¯•åˆ™æ˜¯æ ‡è®°äº† `[Fact]` ç‰¹æ€§çš„æ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä¸­ä½¿ç”¨ `Assert` ç±»æä¾›çš„é™æ€æ–¹æ³•è¿›è¡Œ `æ–­è¨€`ï¼Œ`æ–­è¨€` æˆåŠŸï¼Œåˆ™æµ‹è¯•é€šè¿‡ï¼Œå¦åˆ™æµ‹è¯•ä¸é€šè¿‡ã€‚

### 36.1.5.3 è¿è¡Œæµ‹è¯•

åœ¨å•å…ƒæµ‹è¯•é¡¹ç›®ä¸­ `å³é”®` é€‰æ‹© `è¿è¡Œæµ‹è¯•` å¹¶æ‰“å¼€ `æµ‹è¯•èµ„æºç®¡ç†å™¨` å³å¯æŸ¥çœ‹æµ‹è¯•ç»“æœã€‚

<img src={useBaseUrl("img/ut2.png")} />

<img src={useBaseUrl("img/ut3.png")} />

### 36.1.5.4 å¤šä¸ªæµ‹è¯•æ–¹æ³•æµ‹è¯•

<img src={useBaseUrl("img/ut4.png")} />

### 36.1.5.5 é‡å¤/å›å½’æµ‹è¯•

åç»­æ·»åŠ æ›´å¤šæµ‹è¯•æ–¹æ³•åªéœ€åœ¨ `æµ‹è¯•èµ„æºç®¡ç†å™¨` ç‚¹å‡» `åœ¨è§†å›¾ä¸­è¿è¡Œæ‰€æœ‰æµ‹è¯•` æ’­æ”¾æŒ‰é’®å³å¯ï¼Œå¦‚ä¸‹å›¾

<img src={useBaseUrl("img/ut5.png")} />

## 36.1.6 é›†æˆ `Furion` å¼ºå¤§åŠŸèƒ½

`Furion` æ˜¯è·¨å¹³å°ã€è·¨é¡¹ç›®çš„å¼€å‘æ¡†æ¶ï¼Œæ”¯æŒä»»æ„é¡¹ç›®ç±»å‹ï¼ŒåŒ…æ‹¬å•å…ƒæµ‹è¯•é¡¹ç›®ã€‚

### 36.1.6.1 å®‰è£… `Furion.Xunit` åŒ…

:::note `Furion` çº¯å‡€ç‰ˆ

å¦‚æœä½¿ç”¨çš„æ˜¯ `Furion.Pure` åˆ™å®‰è£… `Furion.Pure.Xunit` è¿™ä¸ªæ‹“å±•åŒ…ã€‚

:::

æ‰“å¼€ `NuGet` ç¨‹åºåŒ…æ§åˆ¶å°ï¼Œå®‰è£… `Furion.Xunit` åŒ…

<img src={useBaseUrl("img/ut6.png")} />

:::important ç‰¹åˆ«æ³¨æ„

`Furion.Xunit` å·²ç»åŒ…å« `Furion` æ— éœ€å†æ¬¡å®‰è£… `Furion`ã€‚

:::

### 36.1.6.2 æ·»åŠ åˆå§‹é…ç½®ç±»

åœ¨å•å…ƒæµ‹è¯•é¡¹ç›®æ ¹ç›®å½•ä¸‹æ·»åŠ  `TestProgram.cs` ç±»ï¼Œå¹¶å†™ä¸‹ä»¥ä¸‹ä»£ç ï¼š

```cs showLineNumbers {6,13,18} title="TestProgram.cs"
using Furion.Xunit;
using Xunit.Abstractions;
using Xunit.Sdk;

// é…ç½®å¯åŠ¨ç±»ç±»å‹ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ TestProgram ç±»å®Œæ•´é™å®šåï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å½“å‰é¡¹ç›®ç¨‹åºé›†åç§°
[assembly: TestFramework("TestProject1.TestProgram", "TestProject1")]

namespace TestProject1;

/// <summary>
/// å•å…ƒæµ‹è¯•å¯åŠ¨ç±»
/// </summary>
public class TestProgram : TestStartup
{
    public TestProgram(IMessageSink messageSink) : base(messageSink)
    {
        // åˆå§‹åŒ– Furion
        Serve.RunNative();
    }
}
```

:::tip å°æç¤º

`TestProgram.cs` åç§°å¯éšæ„ï¼Œåªéœ€è¦ç»§æ‰¿ `TestStartup` ç±»å³å¯ã€‚**ä½†ç±»å‹å¿…é¡»æ˜¯ `public` å…¬å¼€çš„**ã€‚

:::

### 36.1.6.3 ä½¿ç”¨ `Furion` å®Œæ•´åŠŸèƒ½

`Furion` æ˜¯è·¨å¹³å°ã€è·¨é¡¹ç›®çš„å¼€å‘æ¡†æ¶ï¼Œä¸‹é¢åœ¨å•å…ƒæµ‹è¯•ä¸­æ¼”ç¤º `è¿œç¨‹è¯·æ±‚` å¹¶è¯·æ±‚ `https://www.baidu.com` æ•°æ®ï¼Œå¹¶æµ‹è¯•æ˜¯å¦è¯·æ±‚æˆåŠŸã€‚

`Furion` æä¾›äº†ä»¥ä¸‹ä¸¤ç§æ–¹å¼æ³¨å†ŒæœåŠ¡ï¼š

- `Serve.RunNative` æ–¹å¼ï¼ˆ**æ¨è**ï¼‰

```cs showLineNumbers {1,4}
Serve.RunNative(services =>
{
    // æ³¨å†Œè¿œç¨‹æœåŠ¡
    services.AddRemoteRequest();
});
```

- `Startup.cs` æ–¹å¼

```cs showLineNumbers {8,13} title="Startup.cs"
using Furion;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.DependencyInjection;

namespace TestProject1;

public class Startup : AppStartup
{
    public void ConfigureServices(IServiceCollection services)
    {
        // æ³¨å†Œè¿œç¨‹æœåŠ¡
        services.AddRemoteRequest();
    }

    public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
    {
    }
}
```

- ç¼–å†™æµ‹è¯•æ–¹æ³•

```cs showLineNumbers
[Fact]
public async Task æµ‹è¯•è¯·æ±‚ç™¾åº¦()
{
    var rep = await "https://www.baidu.com".GetAsync();
    Assert.True(rep.IsSuccessStatusCode);
}
```

- æŸ¥çœ‹æµ‹è¯•ç»“æœ

<img src={useBaseUrl("img/ut7.png")} />

å¾ˆç¥å¥‡å§ï¼`Furion` æ”¯æŒä»»ä½•é¡¹ç›®ç±»å‹ï¼Œä»»ä½•å¹³å°ä½¿ç”¨ã€‚

## 36.1.7 å¸¦å‚æ•°çš„æµ‹è¯•æ–¹æ³•

ä¸Šé¢ä¾‹å­ä¸­ï¼Œæµ‹è¯•æ–¹æ³•éƒ½æ˜¯æ²¡æœ‰å‚æ•°çš„ï¼Œæœ‰æ—¶å€™éœ€è¦åŒä¸€ä¸ªæ–¹æ³•è¾“å…¥å¤šä¸ªä¸åŒçš„å€¼è¿›è¡Œæµ‹è¯•ï¼Œè¿™æ—¶å€™å°±éœ€è¦ç”¨åˆ° `[Theory]` å’Œ `[InlineData]` ç‰¹æ€§äº†ã€‚

å¦‚ï¼Œä¸‹é¢æµ‹è¯•ä¸¤ä¸ªæ•°çš„å’Œæ˜¯ `å¥‡æ•°`ï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š

```cs showLineNumbers  {1-4}
[Theory]
[InlineData(1, 2)]
[InlineData(3, 4)]
[InlineData(5, 7)]
public void å¸¦å‚æ•°æµ‹è¯•(int i, int j)
{
    Assert.NotEqual(0, (i + j) % 2);
}
```

æµ‹è¯•ç»“æœï¼š

<img src={useBaseUrl("img/ut8.png")} />

## 36.1.8 å¦‚ä½•è¿›è¡Œä¾èµ–æ³¨å…¥

æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æµ‹è¯•æŸæ¥å£ï¼Œæˆ–è€…è¿›è¡Œä¾èµ–æ³¨å…¥æ–¹å¼è§£ææœåŠ¡å¹¶è°ƒç”¨ï¼Œ`Furion.Xunit` æä¾›å®Œæ•´çš„æ„é€ å‡½æ•°æ³¨å…¥ã€‚

### 36.1.8.1 ç¼–å†™ä¸€ä¸ª `ICalcService` æ¥å£åŠå®ç°ç±»

```cs showLineNumbers  {5,10}
using Furion.DependencyInjection;

namespace TestProject1.Services;

public interface ICalcService
{
    int Plus(int i, int j);
}

public class CalcService : ICalcService, ITransient // æ”¯æŒä»»ä½•ç”Ÿå‘½å‘¨æœŸ
{
    public int Plus(int i, int j)
    {
        return i + j;
    }
}
```

### 36.1.8.2 åœ¨æµ‹è¯•ç±»ä¸­è°ƒç”¨

```cs showLineNumbers  {9,15,17}
using TestProject1.Services;
using Xunit;

namespace TestProject1;

public class UnitTest1
{
    private readonly ICalcService _calcService;
    public UnitTest1(ICalcService calcService)
    {
        _calcService = calcService;
    }

    [Fact]
    public void æµ‹è¯•ä¸¤ä¸ªæ•°çš„å’Œ()
    {
        Assert.Equal(3, _calcService.Plus(1, 2));
    }
}
```

<img src={useBaseUrl("img/ut9.png")} />

### 36.1.8.3 è¾“å‡ºæ—¥å¿—

å¦‚æœåœ¨å•å…ƒæµ‹è¯•ä¸­æƒ³è¾“å‡ºæ—¥å¿—ï¼Œåªéœ€è¦åœ¨æ„é€ å‡½æ•°æ³¨å…¥ `ITestOutputHelper` å³å¯ï¼Œå¦‚ï¼š

```cs showLineNumbers  {2,10,12,18}
using Xunit;
using Xunit.Abstractions;

namespace TestProject1
{
    public class UnitTest1
    {
        private readonly ITestOutputHelper Output;

        public UnitTest1(ITestOutputHelper tempOutput)
        {
            Output = tempOutput;
        }

        [Fact]
        public void Test_String_Equal()
        {
            Output.WriteLine("å“ˆå“ˆå“ˆå“ˆï¼Œæˆ‘æ˜¯ Furion");
            Assert.NotEqual("Furion", "Fur");
        }
    }
}
```

<img src={useBaseUrl("img/un3.png")} />

### 36.1.8.4 å…³äºä¾èµ–æ³¨å…¥ä½œç”¨åŸŸé‡Šæ”¾

`Furion` ä¼šåœ¨åˆ›å»ºå•å…ƒæµ‹è¯•å®ä¾‹æ—¶åˆ›å»ºä¸€ä¸ª `IServiceScope` å¯¹è±¡ï¼Œç­‰è¯¥å®ä¾‹æ‰€æœ‰æµ‹è¯•æ¡ˆä¾‹æ‰§è¡Œå®Œæ¯•è‡ªåŠ¨è°ƒç”¨ `Dispose`ï¼Œç¼–å†™æµ‹è¯•çš„å¼€å‘è€…æ— éœ€å…³æ³¨ã€‚

### 36.1.8.5 æµ‹è¯•é‡Šæ”¾èµ„æº

æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æµ‹è¯•æˆåŠŸåé‡Šæ”¾ä¸€äº›ä¸èƒ½åŠæ—¶é‡Šæ”¾çš„å¯¹è±¡ï¼Œè¿™æ—¶ï¼Œåªéœ€è¦å®ç° `IDisposable` æ¥å£å³å¯ï¼š

```cs showLineNumbers  {6,14-17}
using System;
using Xunit;

namespace TestProject1
{
    public class UnitTest1 : IDisposable
    {
        [Fact]
        public void Test_String_Equal()
        {
            Assert.NotEqual("Furion", "Fur");
        }

        public void Dispose()
        {
            // é‡Šæ”¾ä½ çš„å¯¹è±¡
        }
    }
}
```

### 36.1.8.6 `[AssemblyFixture]` ç‰¹æ€§

æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½ä¸éœ€è¦å¯¹ç±»è¿›è¡Œä¾èµ–æ³¨å†Œï¼Œæˆ–è€…æ— æ³•é€šè¿‡å¤–éƒ¨è¿›è¡Œæ³¨å†Œï¼Œè¿™æ—¶å€™å¯ä»¥é€šè¿‡ `[AssemblyFixture]` ç‰¹æ€§å®ç°æ„é€ å‡½æ•°æ³¨å…¥ä»»ä½•ç±»ï¼Œå¦‚ï¼š

:::important æœ‰æ•ˆèŒƒå›´è¯´æ˜

`[AssemblyFixture]` æ–¹å¼å¯¹æ•´ä¸ªå•å…ƒæµ‹è¯•ç±»æ„é€ å‡½æ•°éƒ½æœ‰æ•ˆï¼Œå¦‚éœ€ä¸ªåˆ«å•å…ƒæµ‹è¯•ç±»æœ‰æ•ˆå¯ä½¿ç”¨ `IClassFixture<>` æˆ– `ICollectionFixture<>` + `[Collection]` ç»„åˆæ–¹å¼ã€‚

:::

- **å®šä¹‰éœ€è¦æ³¨å…¥è¿›å•å…ƒæµ‹è¯•æ„é€ å‡½æ•°ä¸­çš„ç±»**

```cs showLineNumbers {1}
public class MyAssemblyFixture : IDisposable
{
    public static int InstantiationCount;

    public MyAssemblyFixture()
    {
        InstantiationCount++;
    }

    public void Dispose()
    {
        // åšä¸€äº›é‡Šæ”¾å·¥ä½œ
    }
}
```

- **åœ¨ `TestProgram.cs` é¡¶éƒ¨å…¨å±€æ³¨å†Œ**

```cs showLineNumbers {11} title="TestProgram.cs"
using Furion.Xunit;
using TestProject1;
using Xunit;
using Xunit.Abstractions;
using Xunit.Sdk;

// é…ç½®å¯åŠ¨ç±»ç±»å‹ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ TestProgram ç±»å®Œæ•´é™å®šåï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å½“å‰é¡¹ç›®ç¨‹åºé›†åç§°
[assembly: TestFramework("TestProject1.TestProgram", "TestProject1")]

// æ”¯æŒå¤šä¸ª
[assembly: AssemblyFixture(typeof(MyAssemblyFixture))]
// [assembly: AssemblyFixture(typeof(XXXXFixture))]

namespace TestProject1;

/// <summary>
/// å•å…ƒæµ‹è¯•å¯åŠ¨ç±»
/// </summary>
public class TestProgram : TestStartup
{
    public TestProgram(IMessageSink messageSink) : base(messageSink)
    {
        Serve.Run(silence: true);
    }
}
```

- **åœ¨æµ‹è¯•ç±»æ„é€ å‡½æ•°æ³¨å…¥**

```cs showLineNumbers {12,27}
using TestProject1.Services;
using Xunit;

namespace TestProject1;

public class UnitTest1
{
    private readonly ICalcService _calcService;
    private readonly MyAssemblyFixture _fixture;

    public UnitTest1(ICalcService calcService
        , MyAssemblyFixture fixture)
    {
        _calcService = calcService;
        _fixture = fixture;
    }

    [Fact]
    public void æµ‹è¯•ä¸¤ä¸ªæ•°çš„å’Œ()
    {
        Assert.Equal(3, _calcService.Plus(1, 2));
    }

    [Fact]
    public void EnsureSingleton()
    {
        Assert.Equal(1, MyAssemblyFixture.InstantiationCount);
    }
}
```

<img src={useBaseUrl("img/ut10.png")} />

### 36.1.8.7 `IClassFixture<>` å•ä¸ªæ³¨å…¥

é€šè¿‡ä¸Šé¢ `[AssemblyFixture]` æ–¹å¼æˆ‘ä»¬çŸ¥é“æ­¤æ–¹å¼å¯¹å…¨å±€çš„å•å…ƒæµ‹è¯•ç±»éƒ½æœ‰æ•ˆï¼Œä½†æœ‰æ—¶å€™æˆ‘ä»¬åªéœ€è¦ç‰¹å®šå•å…ƒæµ‹è¯•ç±»æœ‰æ•ˆï¼Œåˆ™å¯é€šè¿‡ `IClassFixture<>` æ–¹å¼ï¼Œå¦‚ï¼š

- **å®šä¹‰éœ€è¦æ³¨å…¥è¿›å•å…ƒæµ‹è¯•æ„é€ å‡½æ•°ä¸­çš„ç±»**

```cs showLineNumbers {1}
public class MyClassFixture : IDisposable
{
    public static int InstantiationCount;

    public MyClassFixture()
    {
        InstantiationCount++;
    }

    public void Dispose()
    {
        // åšä¸€äº›é‡Šæ”¾å·¥ä½œ
    }
}
```

- **åœ¨æµ‹è¯•ç±»æ„é€ å‡½æ•°æ³¨å…¥**

```cs showLineNumbers {6,14,34}
using TestProject1.Services;
using Xunit;

namespace TestProject1;

public class UnitTest1 : IClassFixture<MyClassFixture>
{
    private readonly ICalcService _calcService;
    private readonly MyAssemblyFixture _fixture;
    private readonly MyClassFixture _classFixture;

    public UnitTest1(ICalcService calcService
        , MyAssemblyFixture fixture
        , MyClassFixture classFixture)
    {
        _calcService = calcService;
        _fixture = fixture;
        _classFixture = classFixture;
    }

    [Fact]
    public void æµ‹è¯•ä¸¤ä¸ªæ•°çš„å’Œ()
    {
        Assert.Equal(3, _calcService.Plus(1, 2));
    }

    [Fact]
    public void EnsureSingleton()
    {
        Assert.Equal(1, MyAssemblyFixture.InstantiationCount);
    }

    [Fact]
    public void EnsureClassSingleton()
    {
        Assert.Equal(1, MyClassFixture.InstantiationCount);
    }
}
```

<img src={useBaseUrl("img/ut11.png")} />

### 36.1.8.8 `ICollectionFixture<>` å¤šä¸ªæ³¨å…¥

`ICollectionFixture<>` æ–¹å¼å’Œ `IClassFixture<>` æ–¹å¼æœ€å¤§çš„ä¸åŒå°±æ˜¯åè€…åªèƒ½é…ç½®ä¸ºå•ä¸ªæµ‹è¯•ç±»ä½¿ç”¨ï¼Œè€Œ `ICollectionFixture<>` åˆ™é€šè¿‡ `[Collection]` æ–¹å¼é…ç½®å¤šä¸ªæµ‹è¯•ç±»æœ‰æ•ˆï¼Œå¦‚ï¼š

- **å®šä¹‰éœ€è¦æ³¨å…¥è¿›å•å…ƒæµ‹è¯•æ„é€ å‡½æ•°ä¸­çš„ç±»**

:::important ç‰¹åˆ«æ³¨æ„

è¿™é‡ŒåŒºåˆ«äº `IClassFixture<>` æ–¹å¼ï¼Œéœ€å®šä¹‰é…ç½®å™¨å¹¶å®ç° `ICollectionFixture<>` æ¥å£ã€‚

:::

```cs showLineNumbers {5,20-21}
using Xunit;

namespace TestProject1;

public class MyCollectionFixture : IDisposable
{
    public static int InstantiationCount;

    public MyCollectionFixture()
    {
        InstantiationCount++;
    }

    public void Dispose()
    {
        // åšä¸€äº›é‡Šæ”¾å·¥ä½œ
    }
}

[CollectionDefinition("MyCollection")]
public class MyCollection : ICollectionFixture<MyCollectionFixture>
{
}
```

- **åœ¨æµ‹è¯•ç±»æ„é€ å‡½æ•°æ³¨å…¥**

```cs showLineNumbers {6,17,44}
using TestProject1.Services;
using Xunit;

namespace TestProject1;

[Collection("MyCollection")]
public class UnitTest1 : IClassFixture<MyClassFixture>
{
    private readonly ICalcService _calcService;
    private readonly MyAssemblyFixture _fixture;
    private readonly MyClassFixture _classFixture;
    private readonly MyCollectionFixture _collectionFixture;

    public UnitTest1(ICalcService calcService
        , MyAssemblyFixture fixture
        , MyClassFixture classFixture
        , MyCollectionFixture collectionFixture)
    {
        _calcService = calcService;
        _fixture = fixture;
        _classFixture = classFixture;
        _collectionFixture = collectionFixture;
    }

    [Fact]
    public void æµ‹è¯•ä¸¤ä¸ªæ•°çš„å’Œ()
    {
        Assert.Equal(3, _calcService.Plus(1, 2));
    }

    [Fact]
    public void EnsureSingleton()
    {
        Assert.Equal(1, MyAssemblyFixture.InstantiationCount);
    }

    [Fact]
    public void EnsureClassSingleton()
    {
        Assert.Equal(1, MyClassFixture.InstantiationCount);
    }

    [Fact]
    public void EnsureCollectionSingleton()
    {
        Assert.Equal(1, MyCollectionFixture.InstantiationCount);
    }
}
```

<img src={useBaseUrl("img/ut12.png")} />

## 36.1.9 `Web` é›†æˆæµ‹è¯•

`Web` é›†æˆæµ‹è¯•æœ‰ä¸‰ç§æ–¹å¼ï¼Œé€šè¿‡è¿™ä¸‰ç§æ–¹å¼å¯ä»¥å¯¹é¡¹ç›®è¿›è¡Œå…¨æ–¹ä½çš„æµ‹è¯•ï¼Œä¿è¯éƒ¨ç½²ä¸Šçº¿æ˜¯æµ‹è¯•æœŸç›¼æ•ˆæœã€‚

### 36.1.9.1 å¯¹ç°æœ‰é¡¹ç›®è¿›è¡Œé›†æˆæµ‹è¯•

è¿™ç§æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„æ–¹å¼ï¼Œæ— éœ€éƒ¨ç½²åˆ°æœåŠ¡å™¨ç›´æ¥åœ¨æœ¬åœ°å³å¯æµ‹è¯•ï¼Œå¦‚ï¼š

1. åˆ›å»º `Xunit` å•å…ƒæµ‹è¯•é¡¹ç›®

<img src={useBaseUrl("img/ut1.png")} />

2. æ·»åŠ  `Microsoft.AspNetCore.Mvc.Testing` å¾®è½¯æä¾›çš„é›†æˆæµ‹è¯•æ‹“å±•

<img src={useBaseUrl("img/ut13.png")} />

3. æ·»åŠ æµ‹è¯•é¡¹ç›®æˆ–ä½¿ç”¨å·²æœ‰çš„æµ‹è¯•é¡¹ç›®**å¼•ç”¨**

<img src={useBaseUrl("img/ut14.png")} />

4. é…ç½® `Web` é¡¹ç›®å¯åŠ¨å±‚

- `.NET5`

åœ¨éœ€è¦æµ‹è¯•çš„ `Web` é¡¹ç›®å¯åŠ¨å±‚æ·»åŠ  `FakeStarup.cs` ç±»

```cs showLineNumbers title="FakeStarup.cs"
namespace WebApplication1;

/// <summary>
/// ä¾›é›†æˆæµ‹è¯•ä½¿ç”¨
/// </summary>
public class FakeStartup
{
}
```

- `.NET6+`

ï¼ˆ`.NET6+`ï¼‰ç¼–è¾‘ `WebApplication1.csproj`ï¼Œæ·»åŠ  `<InternalsVisibleTo Include="é›†æˆæµ‹è¯•é¡¹ç›®åç§°" />`

```xml showLineNumbers {2}
<ItemGroup>
    <InternalsVisibleTo Include="TestProject2" />
</ItemGroup>
```

ï¼ˆ`.NET6+`ï¼‰ç¼–è¾‘ `Program.cs` æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```cs showLineNumbers
public partial class Program { }
```

5. ç¼–å†™æµ‹è¯• `Web` é¡¹ç›®æ¥å£æµ‹è¯•æ¡ˆä¾‹

```cs showLineNumbers {6,8-12,15,16}
using Microsoft.AspNetCore.Mvc.Testing;
using Xunit;

namespace TestProject2;

public class UnitTest1 : IClassFixture<WebApplicationFactory<WebApplication1.FakeStartup>>
{
    private readonly WebApplicationFactory<WebApplication1.FakeStartup> _factory;
    public UnitTest1(WebApplicationFactory<WebApplication1.FakeStartup> factory)
    {
        _factory = factory;
    }

    [Theory]
    [InlineData("/default")]
    public async Task TestEnsureSuccessStatusCode(string url)
    {
        using var client = _factory.CreateClient();
        using var response = await client.GetAsync(url);
        response.EnsureSuccessStatusCode();
    }
}
```

:::note ä¸»æœºæ›´å¤šé…ç½®è¯´æ˜

å¦‚éœ€æ·»åŠ æ›´å¤šé…ç½®ï¼Œå¦‚ç¯å¢ƒå˜é‡è®¾ç½®ï¼Œå¯é€šè¿‡ä»¥ä¸‹æ–¹å¼ï¼š

```cs showLineNumbers {11-14}
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Mvc.Testing;

namespace TestProject2;

public class UnitTest1 : IClassFixture<WebApplicationFactory<WebApplication1.FakeStartup>>
{
    private readonly WebApplicationFactory<WebApplication1.FakeStartup> _factory;
    public UnitTest1(WebApplicationFactory<WebApplication1.FakeStartup> factory)
    {
        _factory = factory.WithWebHostBuilder(builder =>
        {
            builder.UseEnvironment("Stage");   // è®¾ç½®ç¯å¢ƒ
        });
    }

    // ....
}
```

:::

:::tip `.NET6+` æ³›å‹å‚æ•°

å¦‚æœæ˜¯ `.NET6+(å«)`ï¼Œåªéœ€è¦å°† `WebApplicationFactory<WebApplication1.FakeStartup>` æ³›å‹å‚æ•°æ”¹ä¸ºï¼š`WebApplicationFactory<Program>` å³å¯ã€‚

:::

`/default` æ¥å£å¯¹åº”æ§åˆ¶å™¨å®šä¹‰å¦‚ä¸‹ï¼š

```cs showLineNumbers {10,12}
using Microsoft.AspNetCore.Mvc;

namespace WebApplication1.Controllers
{
    [ApiController]
    [Route("[controller]")]
    public class DefaultController : ControllerBase
    {
        [HttpGet]
        public string Get()
        {
            return "Furion é›†æˆæµ‹è¯•";
        }
    }
}
```

<img src={useBaseUrl("img/ut15.png")} />

6. å…è®¸æµ‹è¯•

<img src={useBaseUrl("img/ut16.png")} />

### 36.1.9.2 ç‹¬ç«‹ä¸»æœºæ–¹å¼æµ‹è¯•

ç‹¬ç«‹ä¸»æœºçš„æ–¹å¼å°±æ˜¯åˆ©ç”¨å•å…ƒæµ‹è¯•çš„æ¯ä¸€ä¸ªæµ‹è¯•æ¡ˆä¾‹æ„å»ºä¸»æœºè¿›è¡Œæµ‹è¯•ã€‚

1. åˆ›å»º `Xunit` å•å…ƒæµ‹è¯•é¡¹ç›®

<img src={useBaseUrl("img/ut1.png")} />

2. æ·»åŠ  `Microsoft.AspNetCore.Mvc.Testing` å¾®è½¯æä¾›çš„é›†æˆæµ‹è¯•æ‹“å±•

<img src={useBaseUrl("img/ut13.png")} />

3. å„ç§åˆ›å»ºä¸»æœºæ–¹å¼ç¤ºä¾‹

```cs showLineNumbers {15,33}
using Microsoft.AspNetCore.Builder;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Xunit;

namespace TestProject3;

public class UnitTest1
{
    /// <summary>
    /// åˆ›å»ºä¸»æœºå¹¶æ³¨å†ŒæœåŠ¡
    /// </summary>
    /// <remarks>å¯ç”¨æ¥åˆ¤æ–­æœåŠ¡æ˜¯å¦æ³¨å†Œ</remarks>
    [Fact]
    public void Test1()
    {
        var builder = WebApplication.CreateBuilder();

        // æ³¨å†ŒæœåŠ¡
        builder.Services.AddScoped<IYourService, YourService>();

        using var app = builder.Build();
        var services = app.Services;

        services.GetRequiredService<IYourService>();
    }

    /// <summary>
    /// æµ‹è¯•é…ç½®
    /// </summary>
    /// <remarks>æ¯”å¦‚æ·»åŠ  JSON æ–‡ä»¶é…ç½®åè¯»å–</remarks>
    [Fact]
    public void Test2()
    {
        var builder = WebApplication.CreateBuilder();
        var host = builder.Host;
        host.ConfigureAppConfiguration(builder =>
        {
            builder.Sources.Clear();
        });

        var config = builder.Configuration["é…ç½®"];

        // åˆ¤æ–­ä¸ä¸ºç©º
    }
}
```

### 36.1.9.3 ç³»ç»Ÿé›†æˆ/ç¯å¢ƒ/é…ç½®éƒ¨ç½²æµ‹è¯•

æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦æµ‹è¯• `Web` ä¸»æœºå„ç§æƒ…å†µï¼Œæ¯”å¦‚ç«¯å£æ˜¯å¦æœ‰æ•ˆï¼Œç¯å¢ƒé…ç½®æ˜¯å¦æœ‰æ•ˆï¼Œç³»ç»Ÿé›†æˆæƒ…å†µç­‰ç­‰ï¼Œè¿™æ—¶å€™åªéœ€è¦æ·»åŠ  `Microsoft.AspNetCore.TestHost` æ‹“å±•ï¼Œç„¶ååœ¨æµ‹è¯•ç±»é¡¶éƒ¨è´´ï¼š

```cs showLineNumbers
[assembly: HostingStartup(typeof(WebApplicationTests.TestHostingStartup))]
```

å¾®è½¯å·²ç»æä¾›äº†éå¸¸è¯¦ç»†çš„ä¾‹å­ï¼Œè¿™é‡Œç›´æ¥æ”¾é“¾æ¥ [https://github.com/dotnet/aspnetcore/tree/main/src/DefaultBuilder/test/Microsoft.AspNetCore.Tests](https://github.com/dotnet/aspnetcore/tree/main/src/DefaultBuilder/test/Microsoft.AspNetCore.Tests)

`WebApplicationTests.TestHostingStartup` ä¸ºæ‚¨è¦æµ‹è¯•çš„ `Web` é¡¹ç›®å¯åŠ¨ç±»ã€‚

### 36.1.9.4 é›†æˆ `Furion.Xunit` æ‹“å±•

`Web` é›†æˆæµ‹è¯•æ”¯æŒå®Œæ•´çš„ `Furion` ç‰¹æ€§ï¼Œå‚è€ƒä¸Šé¢å•å…ƒæµ‹è¯•é›†æˆ `Furion` ç« èŠ‚ã€‚

:::note `Furion` çº¯å‡€ç‰ˆ

å¦‚æœä½¿ç”¨çš„æ˜¯ `Furion.Pure` åˆ™å®‰è£… `Furion.Pure.Xunit` è¿™ä¸ªæ‹“å±•åŒ…ã€‚

:::

## 36.1.10 `Assert` æ–­è¨€

`Assert` æ˜¯å•å…ƒæµ‹è¯•åˆ¤å®šæˆåŠŸçš„ä¾æ®ï¼Œé€šå¸¸ç¬¬ä¸€ä¸ªå‚æ•°ä¸º `æœŸæœ›å€¼`ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸º `å®é™…å€¼`ï¼Œå¯¹æ¯”è¿™ä¸¤ä¸ªå€¼æ˜¯å¦ä¸€è‡´å³å¯åˆ¤æ–­æˆåŠŸä¸å¦ã€‚è¯¦ç»†çš„ `Assert` é™æ€æ–¹æ³•å¯æŸ¥é˜…å®˜æ–¹åº“ [Assert æ–¹æ³•](https://github.com/xunit/assert.xunit)

## 36.1.11 å•å…ƒæµ‹è¯•è¦†ç›–ç‡

`Visual Studio` æä¾›äº†åˆ†æå•å…ƒæµ‹è¯•è¦†ç›–ç‡å·¥å…·ï¼Œå¦‚ï¼š

<img src={useBaseUrl("img/fgl.png")} />

## 36.1.12 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::

---

:::note äº†è§£æ›´å¤š

æƒ³äº†è§£æ›´å¤š `å•å…ƒæµ‹è¯•` çŸ¥è¯†å¯æŸ¥é˜… [åœ¨ .NET ä¸­æµ‹è¯•](https://docs.microsoft.com/zh-cn/dotnet/core/testing/) ç« èŠ‚ã€‚

:::
