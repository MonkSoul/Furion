---
id: dbcontext-function
title: 9.15 å‡½æ•°æ“ä½œ
sidebar_label: 9.15 å‡½æ•°æ“ä½œ
---

:::important æ¸©é¦¨æç¤º

æ¨èä½¿ç”¨ ã€Š[9.18 Sql é«˜çº§ä»£ç†](dbcontext-sql-proxy.mdx)ã€‹ä»£æ›¿æœ¬ç« èŠ‚åŠŸèƒ½ã€‚`Sql é«˜çº§ä»£ç†` èƒ½å¤Ÿæä¾›æ›´å®¹æ˜“ä¸”æ›´æ˜“ç»´æŠ¤çš„æ–¹å¼ã€‚

:::

import useBaseUrl from "@docusaurus/useBaseUrl";

## 9.15.1 æ•°æ®åº“å‡½æ•°

å¼•ç”¨ç™¾åº¦ç™¾ç§‘ï¼š

> æ•°æ®åº“å‡½æ•°æ˜¯æŒ‡å½“éœ€è¦åˆ†ææ•°æ®æ¸…å•ä¸­çš„æ•°å€¼æ˜¯å¦ç¬¦åˆç‰¹å®šæ¡ä»¶æ—¶ï¼Œä½¿ç”¨æ•°æ®åº“å·¥ä½œè¡¨å‡½æ•°ã€‚

ç®€å•æ¥è¯´ï¼Œæ•°æ®åº“å‡½æ•°å°±æ˜¯ç”¨äºå­è®¡ç®—çš„å‡½æ•°ã€‚å…¶è®¡ç®—çš„ç»“æœå¯ä»¥ç”¨äºæ„å»º `sql` è¯­å¥ã€‚

### 9.15.1.1 æ”¯æŒæ ‡é‡å‡½æ•°çš„æ•°æ®åº“

| SqlServer | Sqlite | Cosmos | InMemoryDatabase | MySql | PostgreSQL | Oracle | Firebird | Dm  |
| --------- | ------ | ------ | ---------------- | ----- | ---------- | ------ | -------- | --- |
| âœ”         |        | âœ”      |                  | âœ”     | âœ”          | âœ”      |          |     |

### 9.15.1.2 æ”¯æŒè¡¨å€¼å‡½æ•°çš„æ•°æ®åº“

| SqlServer | Sqlite | Cosmos | InMemoryDatabase | MySql | PostgreSQL | Oracle | Firebird | Dm  |
| --------- | ------ | ------ | ---------------- | ----- | ---------- | ------ | -------- | --- |
| âœ”         |        | âœ”      |                  |       | âœ”          | âœ”      |          |     |

## 9.15.2 æ•°æ®åº“å‡½æ•°ç±»å‹

åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œæ•°æ®åº“å‡½æ•°æœ‰è¿™ä¸¤ç§ç±»å‹ï¼š

- `æ ‡é‡å‡½æ•°`ï¼šåªèƒ½è¿”å›å•ä¸ªå€¼
- `è¡¨å€¼å‡½æ•°`ï¼šåªèƒ½è¿”å›ä¸€ä¸ªç»“æœé›†

## 9.15.3 å‡½æ•°çš„ä½¿ç”¨

### 9.15.3.1 æ ‡é‡å‡½æ•°è¿”å› `object`

```cs showLineNumbers
// ISqlRepository æ–¹æ³•
var value = _sqlRepository.SqlFunctionScalar("func_GetValue");

// ISqlDispatchProxy æ–¹å¼
var value = _sqlExecuteProxy.GetValue();  // æ¨èæ–¹å¼

// å®ä½“ä»“å‚¨æ–¹å¼
var value = _personRepository.SqlFunctionScalar("func_GetValue");

// IRepository éæ³›å‹æ–¹å¼
var value = _repository.Sql().SqlFunctionScalar("func_GetValue");

// å˜æ€æ‡’äººæ–¹å¼ï¼Œç›´æ¥é€šè¿‡å‡½æ•°åæ‰§è¡Œ
var value = "func_GetValue".SqlFunctionScalar();
```

:::note å…³äºå¼‚æ­¥

`Furion` æ¡†æ¶æ¯ä¸€ä¸ªæ•°æ®åº“æ“ä½œéƒ½æ”¯æŒå¼‚æ­¥æ–¹å¼ï¼Œç”±äºç¯‡å¹…æœ‰é™ï¼Œå°±ä¸åˆ—ä¸¾å¼‚æ­¥æ–¹å¼äº†ã€‚

:::

### 9.15.3.2 æ ‡é‡å‡½æ•°è¿”å› `T`

```cs showLineNumbers
// ISqlRepository æ–¹æ³•
var value = _sqlRepository.SqlFunctionScalar<string>("func_GetValue");

// ISqlDispatchProxy æ–¹å¼
var value = _sqlExecuteProxy.GetValue();  // æ¨èæ–¹å¼

// å®ä½“ä»“å‚¨æ–¹å¼
var value = _personRepository.SqlFunctionScalar<string>("func_GetValue");

// IRepository éæ³›å‹æ–¹å¼
var value = _repository.Sql().SqlFunctionScalar<string>("func_GetValue");

// å˜æ€æ‡’äººæ–¹å¼ï¼Œç›´æ¥é€šè¿‡å‡½æ•°åæ‰§è¡Œ
var value = "func_GetValue".SqlFunctionScalar<string>();
```

:::note å…³äºå¼‚æ­¥

`Furion` æ¡†æ¶æ¯ä¸€ä¸ªæ•°æ®åº“æ“ä½œéƒ½æ”¯æŒå¼‚æ­¥æ–¹å¼ï¼Œç”±äºç¯‡å¹…æœ‰é™ï¼Œå°±ä¸åˆ—ä¸¾å¼‚æ­¥æ–¹å¼äº†ã€‚

:::

### 9.15.3.3 è¡¨å€¼å‡½æ•°è¿”å› `DataTable`

```cs showLineNumbers
// ISqlRepository æ–¹æ³•
var value = _sqlRepository.SqlFunctionQuery("func_GetTable");

// ISqlDispatchProxy æ–¹å¼
var value = _sqlExecuteProxy.GetTable();  // æ¨èæ–¹å¼

// å®ä½“ä»“å‚¨æ–¹å¼
var value = _personRepository.SqlFunctionQuery("func_GetTable");

// IRepository éæ³›å‹æ–¹å¼
var value = _repository.Sql().SqlFunctionQuery("func_GetTable");

// å˜æ€æ‡’äººæ–¹å¼ï¼Œç›´æ¥é€šè¿‡å‡½æ•°åæ‰§è¡Œ
var value = "func_GetTable".SqlFunctionQuery();
```

:::note å…³äºå¼‚æ­¥

`Furion` æ¡†æ¶æ¯ä¸€ä¸ªæ•°æ®åº“æ“ä½œéƒ½æ”¯æŒå¼‚æ­¥æ–¹å¼ï¼Œç”±äºç¯‡å¹…æœ‰é™ï¼Œå°±ä¸åˆ—ä¸¾å¼‚æ­¥æ–¹å¼äº†ã€‚

:::

### 9.15.3.4 è¡¨å€¼å‡½æ•°è¿”å› `List<T>`

```cs showLineNumbers
// ISqlRepository æ–¹æ³•
var value = _sqlRepository.SqlFunctionQuery<Person>("func_GetTable");

// ISqlDispatchProxy æ–¹å¼
var value = _sqlExecuteProxy.GetTable();  // æ¨èæ–¹å¼

// å®ä½“ä»“å‚¨æ–¹å¼
var value = _personRepository.SqlFunctionQuery<Person>("func_GetTable");

// IRepository éæ³›å‹æ–¹å¼
var value = _repository.Sql().SqlFunctionQuery<Person>("func_GetTable");

// å˜æ€æ‡’äººæ–¹å¼ï¼Œç›´æ¥é€šè¿‡å‡½æ•°åæ‰§è¡Œ
var value = "func_GetTable".SqlFunctionQuery<Person>();
```

:::note å…³äºå¼‚æ­¥

`Furion` æ¡†æ¶æ¯ä¸€ä¸ªæ•°æ®åº“æ“ä½œéƒ½æ”¯æŒå¼‚æ­¥æ–¹å¼ï¼Œç”±äºç¯‡å¹…æœ‰é™ï¼Œå°±ä¸åˆ—ä¸¾å¼‚æ­¥æ–¹å¼äº†ã€‚

:::

## 9.15.4 åœ¨ `Linq` ä¸­ä½¿ç”¨ `æ ‡é‡å‡½æ•°`

`Furion` æ¡†æ¶æä¾›éå¸¸çµæ´»çš„åœ¨ `Linq` ä¸­ä½¿ç”¨æ ‡é‡å‡½æ•°çš„æ–¹æ³•ã€‚å¦‚æœåƒä½¿ç”¨è¿™æ ·çš„æ–¹å¼ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š

- æ ‡é‡å‡½æ•°å¿…é¡»å®šä¹‰åœ¨**å…¬å¼€é™æ€ç±»**ä¸­ï¼Œä¸”è‡ªå·±ä¹Ÿæ˜¯**å…¬å¼€é™æ€æ–¹æ³•**
- è¯¥**å…¬å¼€é™æ€æ–¹æ³•**å¿…é¡»è´´æœ‰ `[QueryableFunction]` ç‰¹æ€§

ç¤ºä¾‹å¦‚ä¸‹ï¼š

### 9.15.4.1 åˆ›å»ºæ ‡é‡å‡½æ•°

```sql showLineNumbers
CREATE FUNCTION FN_GetId
(
    @id INT
)
RETURNS INT
AS
BEGIN
    RETURN @id + 1;
END;
```

### 9.15.4.2 åˆ›å»ºé™æ€ç±»å’Œé™æ€æ–¹æ³•

åˆ›å»ºé™æ€ç±»ï¼Œå¦‚ `QueryFunctions`ï¼Œå°†è¯¥ `æ ‡é‡å‡½æ•°` æ”¾åœ¨é™æ€ç±»ä¸­ï¼š

```cs showLineNumbers  {1, 7, 10-11}
using Furion.DatabaseAccessor;
using System;

namespace Furion.Application
{
    // å¿…é¡»æ˜¯å…¬å¼€é™æ€çš„
    public static class QueryFunctions
    {
        // å¿…é¡»æ˜¯é™æ€æ–¹æ³•
        [QueryableFunction("FN_GetId", "dbo")]  // é…ç½®æ ‡é‡å‡½æ•°
        public static int GetId(int id) => throw new NotSupportedException();
    }
}
```

### 9.15.4.3 åœ¨ `Linq` ä¸­ä½¿ç”¨

```cs showLineNumbers
_personRepository.Where(u => u.Id > QueryFunctions.GetId(1)).ToList();
```

```sql showLineNumbers
SELECT [p].[Id], [p].[Address], [p].[Age], [p].[CreatedTime], [p].[IsDeleted], [p].[Name], [p].[UpdatedTime]
FROM [Person] AS [p]
WHERE [p].[Id] > [dbo].[FN_GetId](1)    // ğŸ’¥ æ³¨æ„è¿™é‡Œ
```

<img src={useBaseUrl("img/fn1.png")} />

## 9.15.5 åœ¨ `Linq` ä¸­ä½¿ç”¨ `è¡¨å€¼å‡½æ•°`

`EF Core 5.0` ç‰ˆæœ¬æ”¯æŒåœ¨ `Linq` ä¸­æ“ä½œ `è¡¨å€¼å‡½æ•°`ï¼Œæ“ä½œæœ‰ç‚¹ç±»ä¼¼ `è§†å›¾æ“ä½œ`

ç¤ºä¾‹å¦‚ä¸‹ï¼š

### 9.15.5.1 åˆ›å»ºè¡¨å€¼å‡½æ•°

```sql showLineNumbers
CREATE FUNCTION dbo.GetPersons
(
    @id INT
)
RETURNS TABLE
AS
RETURN
(
    SELECT Id,
           Name,
           Age,
           Address
    FROM dbo.Person
    WHERE Id > @id
);
```

### 9.15.5.2 åˆ›å»ºè¡¨å€¼å‡½æ•°æ¨¡å‹

```cs showLineNumbers
namespace Furion.Core
{
    public class F_Person
    {
        /// <summary>
        /// ä¸»é”®Id
        /// </summary>
        public int Id { get; set; }

        /// <summary>
        /// å§“å
        /// </summary>
        public string Name { get; set; }

        /// <summary>
        /// å¹´é¾„
        /// </summary>
        public int Age { get; set; }

        /// <summary>
        /// ä½å€
        /// </summary>
        public string Address { get; set; }
    }
}
```

### 9.15.5.3 è¡¨å€¼å‡½æ•°é…ç½®

åœ¨ `DbContext` ç±»ä¸­å®šä¹‰æ–¹æ³•ï¼š

```cs showLineNumbers  {3,10,20-21}
using Furion.DatabaseAccessor;
using Microsoft.EntityFrameworkCore;
using System.Linq;

namespace Furion.EntityFramework.Core
{
    [AppDbContext("Sqlite3ConnectionString")]
    public class FurionDbContext : AppDbContext<FurionDbContext>
    {
        public IQueryable<F_Person> GetPersons(int id) => FromExpression(() => GetPersons(id));

        public FurionDbContext(DbContextOptions<FurionDbContext> options) : base(options)
        {
        }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);

            modelBuilder.Entity(typeof(F_Person)).HasNoKey();
            modelBuilder.HasDbFunction(() => GetPersons(default));
        }
    }
}
```

### 9.15.5.4 åœ¨ `Linq` ä¸­ä½¿ç”¨

```cs showLineNumbers
IQueryable<F_Person> query = _repository.DynamicDbContext.GetPersons(1);
var result = query.Where(u => u.Name.Equals("Furion")).ToList();
```

æœ€ç»ˆç”Ÿæˆ `Sql`

```sql showLineNumbers
SELECT [g].Id, [g].Name, [g].Age, [g].Address
FROM dbo.GetPersons(1) AS [g]
WHERE [g].Name == N'Furion';
```

## 9.15.6 åœ¨ `EF Core` å†…ç½®å‡½æ•°

`EF Core` ä¸ºæˆ‘ä»¬æä¾›äº†å¾ˆå¤šå¸¸ç”¨çš„å†…ç½®å‡½æ•°ï¼Œå¯ä»¥åœ¨ `Lambda` æ¡ä»¶ä¸­ä½¿ç”¨ï¼Œä¸»è¦æ˜¯é€šè¿‡ EF.Functions è°ƒç”¨ï¼Œå¦‚ï¼š

```cs showLineNumbers
_repository.Where(u => EF.Functions.DateDiffHour(u.CreatedDt, DateTime.Now) > 8).FirstOrDefault();
```

è¿™ä¸ªè¯­å¥ä½¿ç”¨äº† EF.Functions.DateDiffHour æœ€ç»ˆç”Ÿæˆçš„ Sql å¦‚ä¸‹ï¼š

```sql showLineNumbers
SELECT TOP(1) [a].*
FROM [dbo].[TEST] AS [a]
WHERE DATEDIFF(HOUR, [a].[CREATED_DT], GETDATE()) > 8
```

`EF Core` å†…ç½®å‡½æ•°å°±ä¸ä¸€ä¸€åˆ—å‡ºäº†ï¼Œå¯ä»¥é€šè¿‡ `EF.Functions` æŸ¥çœ‹æ›´å¤šï¼Œå¦‚æœä¸èƒ½æ»¡è¶³è‡ªå·±çš„éœ€æ±‚ï¼Œé‚£ä¹ˆå¯ä»¥è‡ªå®šä¹‰ `Linq` æ ‡é‡å‡½æ•°

## 9.15.7 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::
