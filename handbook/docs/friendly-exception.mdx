---
id: friendly-exception
title: 7. å‹å¥½å¼‚å¸¸å¤„ç†
sidebar_label: 7. å‹å¥½å¼‚å¸¸å¤„ç†
---

import useBaseUrl from "@docusaurus/useBaseUrl";

## 7.1 ä»€ä¹ˆæ˜¯å¼‚å¸¸

å¼‚å¸¸ä¸€èˆ¬æ˜¯æŒ‡è¿è¡ŒæœŸï¼ˆæ­¤å¤„ç‰¹æŒ‡ `Exception` ç±»ï¼‰ä¼šå‘ç”Ÿçš„å¯¼è‡´ç¨‹åºæ„å¤–ä¸­æ­¢çš„é—®é¢˜ï¼Œæ˜¯ä¸€ç§å¯¹é—®é¢˜çš„æè¿°åçš„å°è£…å¯¹è±¡ã€‚

åœ¨è¿‡å»å¼€å‘ä¸­ï¼Œé€šå¸¸å¼‚å¸¸ç”±ç³»ç»Ÿè¿è¡Œæ—¶å‡ºé”™æŠ›å‡ºï¼Œä½†ç°åœ¨çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åº”åœ¨ç¨‹åºå¼€å‘ä¸­åˆç†çš„æŠ›å‡ºå¼‚å¸¸ï¼Œæ¯”å¦‚æ›´æ–°ä¸€æ¡ä¸å­˜åœ¨çš„å®ä½“ï¼Œæˆ–æŸ¥è¯¢ä¸€ä¸ªä¸å­˜åœ¨çš„æ•°æ®ç­‰ç­‰ã€‚

## 7.2 å¤„ç†å¼‚å¸¸æ–¹å¼

- ä¸å¤„ç†ï¼Œç›´æ¥ä¸­æ–­ç¨‹åºæ‰§è¡Œï¼ˆä¸æ¨èï¼‰
- é€šè¿‡ `try catch finally` å¤„ç†ï¼ˆä¸æ¨èï¼‰
- å…¨å±€ç»Ÿä¸€å¤„ç†ï¼Œå¹¶è®°å½•å¼‚å¸¸ä¿¡æ¯**ï¼ˆæ¨èï¼‰**
- å¼‚å¸¸æ³¨è§£æ–¹å¼å¤„ç†ï¼Œæ”¯æŒ**æœ¬åœ°åŒ–** **ï¼ˆæ¨èï¼‰**

## 7.3 ä»€ä¹ˆæ˜¯å‹å¥½å¼‚å¸¸å¤„ç†

### 7.3.1 éå‹å¥½å¼‚å¸¸å¤„ç†

åœ¨äº†è§£å‹å¥½å¼‚å¸¸å¤„ç†ä¹‹å‰å¯ä»¥çœ‹çœ‹éå‹å¥½å¼‚å¸¸å¤„ç†ï¼š

- å¯¹ç»ˆç«¯ç”¨æˆ·æŠ›å‡º `500çŠ¶æ€ç ` å †æ ˆä¿¡æ¯
- å¤§é‡çš„ `try catch` ä»£ç ï¼Œæ±¡æŸ“æ­£å¸¸ä¸šåŠ¡é€»è¾‘
- æ²¡æœ‰è§„èŒƒåŒ–çš„å¼‚å¸¸çŠ¶æ€ç å’Œå¼‚å¸¸æ¶ˆæ¯ç®¡ç†
- æ²¡æœ‰å¼‚å¸¸æ—¥å¿—æ”¶é›†è®°å½•
- ä¸æ”¯æŒå¼‚å¸¸æ¶ˆæ¯æœ¬åœ°åŒ–å¤„ç†
- ä¸æ”¯æŒå¼‚å¸¸ç­–ç•¥ï¼Œå¤±è´¥åç¨‹åºç«‹å³ç»ˆæ­¢
- ä¸æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡ CAP
- ä¸æ”¯æŒå¼‚å¸¸ä¼ æ’­
- è¿”å›çš„å¼‚å¸¸æ ¼å¼æ‚ä¹±

### 7.3.2 å‹å¥½å¼‚å¸¸å¤„ç†

- å¯¹ç»ˆç«¯ç”¨æˆ·æç¤ºå‹å¥½
- å¯¹åç«¯å¼€å‘äººå‘˜æä¾›è¯¦ç»†çš„å¼‚å¸¸å †æ ˆ
- ä¸å¹²æ‰°æ­£å¸¸ä¸šåŠ¡é€»è¾‘ä»£ç ï¼Œå¦‚ æ²¡æœ‰ `try catch` ä»£ç 
- æ”¯æŒå¼‚å¸¸çŠ¶æ€ç å¤šæ–¹è®¾ç½®
- æ”¯æŒå¼‚å¸¸æ¶ˆæ¯æœ¬åœ°åŒ–
- å¼‚å¸¸ä¿¡æ¯ç»Ÿä¸€é…ç½®ç®¡ç†
- æ”¯æŒå¼‚å¸¸ç­–ç•¥ï¼Œå¦‚é‡è¯•
- æ”¯æŒå¼‚å¸¸æ—¥å¿—æ”¶é›†è®°å½•
- æ”¯æŒ CAP åˆ†å¸ƒå¼äº‹åŠ¡å…³è”
- æ”¯æŒå†…éƒ¨å¼‚å¸¸å¤–éƒ¨ä¼ æ’­
- æ”¯æŒè¿”å›ç»Ÿä¸€çš„å¼‚å¸¸æ ¼å¼æ•°æ®

## 7.4 å‹å¥½å¼‚å¸¸å¤„ç†ä½¿ç”¨ç¤ºä¾‹

`Fur` æ¡†æ¶æä¾›äº†éå¸¸çµæ´»çš„å‹å¥½å¼‚å¸¸å¤„ç†æ–¹å¼ã€‚

:::important å¤‡æ³¨

`.AddFriendlyException()` é»˜è®¤å·²ç»ç»§æ‰¿åœ¨ `AddInject()` ä¸­äº†ï¼Œæ— éœ€å†æ¬¡æ³¨å†Œã€‚ä¹Ÿå°±æ˜¯ `7.4.1` ç« èŠ‚å¯ä¸é…ç½®ã€‚

:::

### 7.4.1 æ³¨å†Œå‹å¥½å¼‚å¸¸æœåŠ¡

```cs {11} title="Fur.Web.Core\FurWebCoreStartup.cs"
using Microsoft.Extensions.DependencyInjection;

namespace Fur.Web.Core
{
    [AppStartup(800)]
    public sealed class FurWebCoreStartup : AppStartup
    {
        public void ConfigureServices(IServiceCollection services)
        {
            services.AddControllers()
                    .AddFriendlyException();
        }
    }
}
```

:::important ç‰¹åˆ«æ³¨æ„

`.AddFriendlyException()` éœ€åœ¨ `services.AddControllers()` ä¹‹åæ³¨å†Œã€‚

:::

### 7.4.2 ä¸¤ä¸ªä¾‹å­

#### ç®€å•æŠ›ä¸ªå¼‚å¸¸

```cs {2,12}
using Fur.DynamicApiController;
using Fur.FriendlyException;

namespace Fur.Application
{
    public class FurAppService : IDynamicApiController
    {
        public int Get(int id)
        {
            if (id < 3)
            {
                throw Oops.Oh($"{id} ä¸èƒ½å°äº3");
            }

            return id;
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/yhyc1.gif")} />

#### æŠ›å‡ºç‰¹å®šç±»å‹å¼‚å¸¸

```cs {2,13}
using Fur.DynamicApiController;
using Fur.FriendlyException;
using System;

namespace Fur.Application
{
    public class FurAppService : IDynamicApiController
    {
        public int Get(int id)
        {
            if (id < 3)
            {
                throw Oops.Oh($"{id} ä¸èƒ½å°äº3ã€‚", typeof(InvalidOperationException));
            }

            return id;
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/yhyc2.png")} />

## 7.5 å…³äº Oops.Oh

é€šè¿‡ä¸Šé¢çš„ä¾‹å­å¯ä»¥çœ‹å‡ºï¼Œ`Oops.Oh(errorMessage)` å¯ä»¥ç»“åˆ `throw` æŠ›å‡ºå¼‚å¸¸ã€‚å¯¹äºç†Ÿæ‚‰`C#`çš„äººå‘˜æ¥è¯´ï¼Œ`throw` åé¢åªèƒ½ `Exception` å®ä¾‹ã€‚`Oops.Oh(...)` æ–¹æ³•è¿”å›æ­£æ˜¯ `Exception` å®ä¾‹ã€‚

### 7.6.1 ä¸ºä»€ä¹ˆèµ·è¿™ä¸ªåå­—ï¼Ÿ

è¿™ä¸ªåå­—æ¥æºäºä¸€ä¸ªè‹±è¯­å¥å­ï¼š`Oh, Oops!`ï¼Œæ„æ€æ˜¯ **å™¢ï¼ˆå“ï¼‰ï¼Œå‡ºé”™äº†ï¼**ï¼Œæ‰€ä»¥å°±æœ‰äº† `Oops.Oh`ã€‚

### 7.6.2 `Oops.Oh` é‡è½½æ–¹æ³•

```cs {13,22,30,39}
using System;

namespace Fur.FriendlyException
{
    public static class Oops
    {
        /// <summary>
        /// æŠ›å‡ºå­—ç¬¦ä¸²å¼‚å¸¸
        /// </summary>
        /// <param name="errorMessage">å¼‚å¸¸æ¶ˆæ¯</param>
        /// <param name="args">String.Format å‚æ•°</param>
        /// <returns>å¼‚å¸¸å®ä¾‹</returns>
        public static Exception Oh(string errorMessage, params object[] args);

        /// <summary>
        /// æŠ›å‡ºå­—ç¬¦ä¸²å¼‚å¸¸
        /// </summary>
        /// <param name="errorMessage">å¼‚å¸¸æ¶ˆæ¯</param>
        /// <param name="exceptionType">å…·ä½“å¼‚å¸¸ç±»å‹</param>
        /// <param name="args">String.Format å‚æ•°</param>
        /// <returns>å¼‚å¸¸å®ä¾‹</returns>
        public static Exception Oh(string errorMessage, Type exceptionType, params object[] args);

        /// <summary>
        /// æŠ›å‡ºé”™è¯¯ç å¼‚å¸¸
        /// </summary>
        /// <param name="errorCode">é”™è¯¯ç </param>
        /// <param name="args">String.Format å‚æ•°</param>
        /// <returns>å¼‚å¸¸å®ä¾‹</returns>
        public static Exception Oh(object errorCode, params object[] args);

        /// <summary>
        /// æŠ›å‡ºé”™è¯¯ç å¼‚å¸¸
        /// </summary>
        /// <param name="errorCode">é”™è¯¯ç </param>
        /// <param name="exceptionType">å…·ä½“å¼‚å¸¸ç±»å‹</param>
        /// <param name="args">String.Format å‚æ•°</param>
        /// <returns>å¼‚å¸¸å®ä¾‹</returns>
        public static Exception Oh(object errorCode, Type exceptionType, params object[] args);
    }
}
```

## 7.6 æœ€ä½³å®è·µ ğŸ¤—

åœ¨ `Fur` æ¡†æ¶ä¸­ï¼Œæä¾›äº†éå¸¸çµæ´»ä¸”è§„èŒƒåŒ–çš„å‹å¥½å¼‚å¸¸å¤„ç†æ–¹å¼ï¼Œé€šè¿‡è¿™ä¸ªæ–¹å¼å¯ä»¥æ–¹ä¾¿ç®¡ç†å¼‚å¸¸çŠ¶æ€ç ã€å¼‚å¸¸ä¿¡æ¯åŠå¼‚å¸¸æœ¬åœ°åŒ–ã€‚

### 7.6.1 åˆ›å»ºå¼‚å¸¸ä¿¡æ¯ç±»å‹

å®ç°è‡ªå®šä¹‰å¼‚å¸¸ä¿¡æ¯ç±»å‹å¿…é¡»éµå¾ªä»¥ä¸‹é…ç½®ï¼š

- ç±»å‹å¿…é¡»æ˜¯å…¬å¼€ä¸”æ—¶ `Enum` æšä¸¾ç±»å‹
- æšä¸¾ç±»å‹å¿…é¡»è´´æœ‰ `[ErrorCodeType]` ç‰¹æ€§
- æšä¸¾ä¸­æ¯ä¸€é¡¹å¿…é¡»è´´æœ‰ `[ErrorCodeItemMetadata]` ç‰¹æ€§

```cs {1,5,8,11,14,17}
using Fur.FriendlyException;

namespace Fur.Application
{
    [ErrorCodeType]
    public enum ErrorCodes
    {
        [ErrorCodeItemMetadata("{0} ä¸èƒ½å°äº {1}")]
        z1000,

        [ErrorCodeItemMetadata("æ•°æ®ä¸å­˜åœ¨")]
        x1000,

        [ErrorCodeItemMetadata("{0} å‘ç° {1} ä¸ªå¼‚å¸¸", "ç™¾å°åƒ§", 2)]
        x1001,

        [ErrorCodeItemMetadata("æœåŠ¡å™¨è¿è¡Œå¼‚å¸¸", ErrorCode = "Error")]
        SERVER_ERROR
    }
}
```

:::important

`Fur` æ¡†æ¶æä¾›äº† `[ErrorCodeType]` ç‰¹æ€§å’Œ `IErrorCodeTypeProvider` æä¾›å™¨æ¥å£æ¥æä¾›å¼‚å¸¸ä¿¡æ¯æ‰«æï¼Œè¿™é‡Œç”¨çš„æ˜¯ `[ErrorCodeType]` ç‰¹æ€§ç±»ã€‚

:::

### 7.6.2 å…³äº `[ErrorCodeItemMetadata]`

`Fur` æ¡†æ¶æä¾›äº†`[ErrorCodeItemMetadata]` ç‰¹æ€§ç”¨æ¥æ ‡è¯†**æšä¸¾å­—æ®µ**å¼‚å¸¸å…ƒæ•°æ®ï¼Œè¯¥ç‰¹æ€§æ”¯æŒä¼ å…¥ `æ¶ˆæ¯å†…å®¹` å’Œ `æ ¼å¼åŒ–å‚æ•°`ã€‚æœ€ç»ˆä¼šä½¿ç”¨ `String.Format(æ¶ˆæ¯å†…å®¹ï¼Œæ ¼å¼åŒ–å‚æ•°)` è¿›è¡Œæ ¼å¼åŒ–ã€‚

å¦‚æœæ¶ˆæ¯å†…å®¹ä¸­åŒ…å«`æ ¼å¼åŒ–å ä½ç¬¦`ä½†æœªæŒ‡å®š`æ ¼å¼åŒ–å‚æ•°`ï¼Œé‚£ä¹ˆä¼šæŸ¥æ‰¾å¼‚å¸¸æ‰€åœ¨æ–¹æ³•æ˜¯å¦è´´æœ‰ `[IfException]` ç‰¹æ€§ä¸”å«æœ‰æ ¼å¼åŒ–å‚æ•°ï¼Œæ¥ç€å°±ä¼šæŸ¥æ‰¾ `Oops.Oh` ä¸­æŒ‡å®šçš„ `æ ¼å¼åŒ–å‚æ•°`ã€‚

### 7.6.3 é™æ€å¼‚å¸¸ç±»ä½¿ç”¨

```cs {2,12}
using Fur.DynamicApiController;
using Fur.FriendlyException;

namespace Fur.Application
{
    public class FurAppService : IDynamicApiController
    {
        public int Get(int id)
        {
            if (id < 3)
            {
                throw Oops.Oh(ErrorCodes.z1000, id, 3);
            }

            return id;
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/yhyc3.gif")} />

### 7.6.4 æ›´å¤šä¾‹å­

```cs
throw Oops.Oh(1000);
throw Oops.Oh(ErrorCodes.x1000);
throw Oops.Oh("å“ˆå“ˆå“ˆå“ˆ");
throw Oops.Oh(errorCode: "x1001");
throw Oops.Oh(1000, typeof(Exception));
```

## 7.7 å¤šä¸ªå¼‚å¸¸ä¿¡æ¯ç±»å‹

```cs {5-6,21-22}
using Fur.FriendlyException;

namespace Fur.Application
{
    [ErrorCodeType]
    public enum ErrorCodes
    {
        [ErrorCodeItemMetadata("{0} ä¸èƒ½å°äº {1}")]
        z1000,

        [ErrorCodeItemMetadata("æ•°æ®ä¸å­˜åœ¨")]
        x1000,

        [ErrorCodeItemMetadata("{0} å‘ç° {1} ä¸ªå¼‚å¸¸", "ç™¾å°åƒ§", 2)]
        x1001,

        [ErrorCodeItemMetadata("æœåŠ¡å™¨è¿è¡Œå¼‚å¸¸", ErrorCode = "Error")]
        SERVER_ERROR
    }

    [ErrorCodeType]
    public enum UserErrorCodes
    {
        [ErrorCodeItemMetadata("ç”¨æˆ·æ•°æ®ä¸å­˜åœ¨")]
        u1000,

        [ErrorCodeItemMetadata("å…¶ä»–å¼‚å¸¸")]
        u1001
    }
}
```

:::important ç‰¹åˆ«æ³¨æ„

å¤šä¸ªå¼‚å¸¸é™æ€ç±»ä¸­ä¹Ÿå¿…é¡»ä¿è¯å¸¸é‡å€¼å”¯ä¸€æ€§ï¼Œä¸å¯é‡å¤ã€‚

:::

## 7.8 `IErrorCodeTypeProvider` æä¾›å™¨

åœ¨ `Fur` æ¡†æ¶ä¸­ï¼Œè¿˜æä¾›äº† `IErrorCodeTypeProvider` å¼‚å¸¸æ¶ˆæ¯æä¾›å™¨æ¥å£ï¼Œæ–¹ä¾¿åœ¨ä¸èƒ½è´´ `[ErrorCodeType]` ç‰¹æ€§æƒ…å†µä¸‹ä½¿ç”¨ï¼š

```cs {2,6,8-11}
using Fur.FriendlyException;
using System;

namespace Fur.Application
{
    public class CustomErrorCodeTypeProvider : IErrorCodeTypeProvider
    {
        public Type[] Definitions => new[] {
            typeof(ErrorCodes),
            typeof(ErrorCodes2)
        };
    }
}
```

å¯ç”¨ `IErrorCodeTypeProvider` æä¾›å™¨ï¼š

```cs {11} title="Fur.Web.Core\FurWebCoreStartup.cs"
using Microsoft.Extensions.DependencyInjection;

namespace Fur.Web.Core
{
    [AppStartup(800)]
    public sealed class FurWebCoreStartup : AppStartup
    {
        public void ConfigureServices(IServiceCollection services)
        {
            services.AddControllers()
                    .AddFriendlyException<CustomErrorCodeTypeProvider>();
        }
    }
}
```

:::tip å°çŸ¥è¯†

åªæœ‰ä½¿ç”¨ `IErrorCodeTypeProvider` æ–¹å¼æ‰éœ€ä½¿ç”¨æ³›å‹æ–¹å¼æ³¨å†Œã€‚é€šè¿‡ä¸Šé¢çš„æ–¹å¼æ³¨å†Œå¯ä»¥åŒæ—¶æ”¯æŒ `IErrorCodeTypeProvider` å’Œ `[ErrorCodeType]` æ–¹å¼ã€‚

:::

## 7.9 `appsetting.json` ä¸­é…ç½®

`Fur` æ¡†æ¶è¿˜æä¾›äº†éå¸¸çµæ´»çš„é…ç½®æ–‡ä»¶é…ç½®å¼‚å¸¸ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥å®ç°å¼‚å¸¸ä¿¡æ¯åæœŸé…ç½®ï¼Œä¹Ÿå°±æ˜¯æ— éœ€åœ¨å¼€å‘é˜¶æ®µé¢„å…ˆå®šä¹‰ã€‚

```json {2-8} title="Fur.Web.Entry/appsettings.json"
{
  "ErrorCodeMessageSettings": {
    "Definitions": [
      [5000, "{0} ä¸èƒ½å°äº {1}"],
      [5001, "æˆ‘å« {0} åå­—", "ç™¾å°åƒ§"],
      [5002, "Oops! å‡ºé”™äº†"]
    ]
  }
}
```

`Definitions` ç±»å‹ä¸ºäºŒç»´æ•°ç»„ï¼ŒäºŒç»´æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªæ•°ç»„ç¬¬ä¸€ä¸ªå‚æ•°ä¸º `ErrorCode` ä¹Ÿå°±æ˜¯é”™è¯¯ç ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸º `ErrorMessage` æ¶ˆæ¯å†…å®¹ï¼Œå‰©ä½™å‚æ•°ä½œä¸º `ErrorMessage` çš„æ ¼å¼åŒ–å‚æ•°ã€‚

#### ä½¿ç”¨ç¤ºä¾‹

```cs {2,12}
using Fur.DynamicApiController;
using Fur.FriendlyException;

namespace Fur.Application
{
    public class FurAppService : IDynamicApiController
    {
        public int Get(int id)
        {
            if (id < 3)
            {
                throw Oops.Oh(5000, id, 3); // å¯ä»¥å°† 5000ä½œä¸ºå¸¸é‡é…ç½®èµ·æ¥
            }

            return id;
        }
    }
}
```

:::tip å°çŸ¥è¯†

`[ErrorCodeType]` å’Œ `IErrorCodeTypeProvider` å’Œ `appsettings.json` å¯ä»¥åŒæ—¶ä½¿ç”¨ã€‚

:::

## 7.10 `[IfException]` ä½¿ç”¨

`Fur` æ¡†æ¶æä¾›äº† `[IfException]` ç‰¹æ€§å¯ä»¥**è¦†ç›–é»˜è®¤æ¶ˆæ¯é…ç½®**ã€‚ä¹Ÿå°±æ˜¯è¦†ç›– `å¼‚å¸¸æ¶ˆæ¯ç±»å‹` å’Œ `appsettings.json` ä¸­çš„é…ç½®ã€‚

:::caution ç‰¹åˆ«æ³¨æ„

`[IfException]` åªèƒ½è´´åœ¨æ–¹æ³•ä¸Šï¼Œæ”¯æŒå¤šä¸ªï¼Œè€Œä¸”è¯¥æ–¹æ³•æ‰€åœ¨çš„ç±»ç±»å‹å¿…é¡»æ˜¯ `ControllerBase` å­ç±» æˆ– å®ç° `IDynamicApiController` æ¥å£ã€‚

:::

### 7.10.1 ä½¿ç”¨ç¤ºä¾‹

- å¼‚å¸¸æ¶ˆæ¯ç±»å®šä¹‰

```cs {1,4}
[ErrorCodeType]
public static class ErrorCodes
{
   [ErrorCodeItemMetadata("{0} ä¸èƒ½å°äº {1}")]
   z1000
}
```

- è¦†ç›–é»˜è®¤é…ç½®

```cs {8}
using Fur.DynamicApiController;
using Fur.FriendlyException;

namespace Fur.Application
{
    public class FurAppService : IDynamicApiController
    {
        [IfException(ErrorCodes.z1000, ErrorMessage = "æˆ‘è¦†ç›–äº†é»˜è®¤çš„ï¼š{0} ä¸èƒ½å°äº {1}")]
        public int Get(int id)
        {
            if (id < 3)
            {
                throw Oops.Oh(ErrorCodes.z1000, id, 3);
            }

            return id;
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/yhyc4.png")} />

### 7.10.2 æ›´å¤šä¾‹å­

```cs {2,8-11}
using Fur.DynamicApiController;
using Fur.FriendlyException;

namespace Fur.Application
{
    public class FurAppService : IDynamicApiController
    {
        [IfException(ErrorCodes.z1000, ErrorMessage = "æˆ‘è¦†ç›–äº†é»˜è®¤çš„ï¼š{0} ä¸èƒ½å°äº {1}")]
        [IfException(ErrorCodes.x1001, "æ ¼å¼åŒ–å‚æ•°1", "æ ¼å¼åŒ–å‚æ•°2", ErrorMessage = "æˆ‘è¦†ç›–äº†é»˜è®¤çš„ï¼š{0} ä¸èƒ½å°äº {1}")]
        [IfException(ErrorCodes.x1000, "æ ¼å¼åŒ–å‚æ•°1", "æ ¼å¼åŒ–å‚æ•°2")]
        [IfException(ErrorCodes.SERVER_ERROR, "æ ¼å¼åŒ–å‚æ•°1", "æ ¼å¼åŒ–å‚æ•°2")]
        public int Get(int id)
        {
            if (id < 3)
            {
                throw Oops.Oh(ErrorCodes.z1000, id, 3);
            }

            return id;
        }
    }
}
```

:::important æ ¼å¼åŒ–æµç¨‹

å¦‚æœæ¶ˆæ¯å†…å®¹ä¸­åŒ…å«`æ ¼å¼åŒ–å ä½ç¬¦`ä½†æœªæŒ‡å®š`æ ¼å¼åŒ–å‚æ•°`ï¼Œé‚£ä¹ˆä¼šæŸ¥æ‰¾å¼‚å¸¸æ‰€åœ¨æ–¹æ³•æ˜¯å¦è´´æœ‰ `[IfException]` ç‰¹æ€§ä¸”å«æœ‰æ ¼å¼åŒ–å‚æ•°ï¼Œæ¥ç€å°±ä¼šæŸ¥æ‰¾ `Oops.Oh` ä¸­æŒ‡å®šçš„ `æ ¼å¼åŒ–å‚æ•°`ã€‚

:::

## 7.11 å¼‚å¸¸æ¶ˆæ¯ä¼˜å…ˆçº§

`[ErrorCodeItemMetadata]` -> `appsettings.json` -> `[IfException]`ã€‚**ï¼ˆä½ -> é«˜ï¼‰**

- `[IfException]` ä¼šè¦†ç›– `appsettings.json` å®šä¹‰çš„çŠ¶æ€ç æ¶ˆæ¯ã€‚
- `appsettings.json` ä¼šè¦†ç›– `[ErrorCodeItemMetadata]` å®šä¹‰çš„æ¶ˆæ¯ã€‚

## 7.12 å¤šè¯­è¨€æ”¯æŒ

æ–‡æ¡£æ•´ç†ä¸­...

## 7.13 å¼‚å¸¸æ¨¡å‹æä¾›å™¨

`Fur` æ¡†æ¶æä¾› `è§„èŒƒåŒ–ç»“æœ` åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡å®ç° `IUnifyResultProvider` æä¾›å™¨å®ç°å¼‚å¸¸è¿”å›å€¼å®šåˆ¶ï¼Œå¦‚ï¼š`RESTfulResultProvider`ï¼š

```cs
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Filters;
using Microsoft.AspNetCore.Mvc.ModelBinding;
using System.Collections.Generic;

namespace Fur.UnifyResult
{
    /// <summary>
    /// RESTful é£æ ¼è¿”å›å€¼
    /// </summary>
    public class RESTfulResultProvider : IUnifyResultProvider
    {
        /// <summary>
        /// å¼‚å¸¸è¿”å›å€¼
        /// </summary>
        /// <param name="context"></param>
        /// <returns></returns>
        public IActionResult OnException(ExceptionContext context)
        {
            return new JsonResult(new RESTfulResult
            {
                StatusCode = StatusCodes.Status500InternalServerError,
                Successed = false,
                Data = null,
                Errors = context.Exception.Message
            });
        }

        /// <summary>
        /// æˆåŠŸè¿”å›å€¼
        /// </summary>
        /// <param name="context"></param>
        /// <returns></returns>
        public IActionResult OnSuccessed(ActionExecutedContext context)
        {
            object data;
            // å¤„ç†å†…å®¹ç»“æœ
            if (context.Result is ContentResult contentResult) data = contentResult.Content;
            // å¤„ç†å¯¹è±¡ç»“æœ
            else if (context.Result is ObjectResult objectResult) data = objectResult.Value;
            else return null;

            return new JsonResult(new RESTfulResult
            {
                StatusCode = context.Result is EmptyResult ? StatusCodes.Status204NoContent : StatusCodes.Status200OK,
                Successed = true,
                Data = data,
                Errors = null
            });
        }

        /// <summary>
        /// éªŒè¯å¤±è´¥è¿”å›å€¼
        /// </summary>
        /// <param name="context"></param>
        /// <param name="modelStates"></param>
        /// <param name="validationResults"></param>
        /// <param name="validateFaildMessage"></param>
        /// <returns></returns>
        public IActionResult OnValidateFailed(ActionExecutingContext context, ModelStateDictionary modelStates, Dictionary<string, IEnumerable<string>> validationResults, string validateFaildMessage)
        {
            return new JsonResult(new RESTfulResult
            {
                StatusCode = StatusCodes.Status400BadRequest,
                Successed = false,
                Data = null,
                Errors = validationResults
            });
        }
    }
}
```

ä¹‹ååœ¨ `Startup.cs` ä¸­æ³¨å†Œå³å¯ï¼š

```cs
services.AddControllers().AddUnifyResult<RESTfulResult, RESTfulResultProvider>();
```

## 7.14 å…¨å±€å¼‚å¸¸å¤„ç†æä¾›å™¨

é€šå¸¸æˆ‘ä»¬éœ€è¦åœ¨å¼‚å¸¸æ•è·çš„æ—¶å€™å†™æ—¥å¿—ï¼Œè¿™æ—¶å€™å°±éœ€è¦ä½¿ç”¨åˆ° `IGlobalExceptionHandler` å¼‚å¸¸å®šä¹‰å¤„ç†ç¨‹åºï¼Œå¦‚ï¼š

```cs {8}
using Fur.DependencyInjection;
using Fur.FriendlyException;
using Microsoft.AspNetCore.Mvc.Filters;
using System.Threading.Tasks;

namespace Fur.Application
{
    public class LogExceptionHandler : IGlobalExceptionHandler, ISingleton
    {
        public Task OnExceptionAsync(ExceptionContext context)
        {
            // å†™æ—¥å¿—

            return Task.CompletedTask;
        }
    }
}
```

## 7.15 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Fur æ [Issue](https://gitee.com/monksoul/Fur/issues/new?issue)ã€‚

:::
