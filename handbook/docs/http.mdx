---
id: http
title: 19. è¿œç¨‹è¯·æ±‚
sidebar_label: 19. è¿œç¨‹è¯·æ±‚ (HttpClient)
---

import Tag from "@site/src/components/Tag.js";

<details>
  <summary>ğŸ“ æ¨¡å—æ›´æ–°æ—¥å¿—</summary>
  <div>
<div>

- **æ–°ç‰¹æ€§**

  - &nbsp;<Tag>æ–°å¢</Tag> è¿œç¨‹è¯·æ±‚ `[HttpMethod]ToSaveAsync` ä¸‹è½½è¿œç¨‹æ–‡ä»¶å¹¶ä¿å­˜åˆ°ç£ç›˜æ–¹æ³• <sup>4.8.7.32</sup> <sup>â±ï¸2023.04.02</sup> [bfd02c1](https://gitee.com/dotnetchina/Furion/commit/bfd02c1a2ce4229e90fc825fe5657ada59e1892f)
  - &nbsp;<Tag>æ–°å¢</Tag> è¿œç¨‹è¯·æ±‚æ”¯æŒ `Content-Type` ä¸º `text/html` å’Œ `text/plain` å¤„ç† <sup>4.8.7.22</sup> <sup>â±ï¸2023.03.27</sup> [#I6QMLR](https://gitee.com/dotnetchina/Furion/issues/I6QMLR)
  - &nbsp;<Tag>æ–°å¢</Tag> è¿œç¨‹è¯·æ±‚ `HttpRequestMessage` æ‹“å±•æ–¹æ³• `AppendHeaders` <sup>4.8.7.10</sup> <sup>â±ï¸2023.03.14</sup> [#I6MVHT](https://gitee.com/dotnetchina/Furion/issues/I6MVHT)
  - &nbsp;<Tag>æ–°å¢</Tag> è¿œç¨‹è¯·æ±‚é…ç½® `SetHttpVersion(version)` é…ç½®ï¼Œå¯é…ç½® `HTTP` è¯·æ±‚ç‰ˆæœ¬ï¼Œé»˜è®¤ä¸º `1.1` <sup>4.8.5.8</sup> <sup>â±ï¸2023.02.06</sup> [#I6D64H](https://gitee.com/dotnetchina/Furion/issues/I6D64H)
  - &nbsp;<Tag>æ–°å¢</Tag> è¿œç¨‹è¯·æ±‚ `[QueryString]` ç‰¹æ€§æ·»åŠ æ—¶é—´æ ¼å¼åŒ– `Format` å±æ€§ <sup>4.8.1.2</sup> <sup>â±ï¸2022.11.24</sup> [!670](https://gitee.com/dotnetchina/Furion/pulls/670)

- **é—®é¢˜ä¿®å¤**

  - &nbsp;<Tag>ä¿®å¤</Tag> è¿œç¨‹è¯·æ±‚è·å–å“åº” `Cookies` è¢«æˆªæ–­é—®é¢˜ <sup>4.8.8.54</sup> <sup>â±ï¸2023.11.08</sup> [#I8EV1Z](https://gitee.com/dotnetchina/Furion/issues/I8EV1Z)
  - &nbsp;<Tag>ä¿®å¤</Tag> è¿œç¨‹è¯·æ±‚ä¸Šä¼ æ–‡ä»¶åœ¨å…¶ä»–ç¼–ç¨‹è¯­è¨€è·å–æ–‡ä»¶åå­˜åœ¨åŒå¼•å·é—®é¢˜ <sup>4.8.8.53</sup> <sup>â±ï¸2023.11.07</sup> [#I8EF1S](https://gitee.com/dotnetchina/Furion/issues/I8EF1S)
  - &nbsp;<Tag>ä¿®å¤</Tag> è¿œç¨‹è¯·æ±‚åœ¨è¢«è¯·æ±‚ç«¯è¿”å›é `200` çŠ¶æ€ç ä½†å®é™…è¯·æ±‚å·²å¤„ç†ä¹ŸæŠ›å¼‚å¸¸é—®é¢˜ <sup>4.8.8.14</sup> <sup>â±ï¸2023.05.12</sup> [b14a51f](https://gitee.com/dotnetchina/Furion/commit/b14a51fd6f85a905da50729d521a2232b5c9afc1)
  - &nbsp;<Tag>ä¿®å¤</Tag> è¿œç¨‹è¯·æ±‚ `Body` å‚æ•°ä¸ºç²˜åœŸå¯¹è±¡ `Clay` ç±»å‹åºåˆ—åŒ–æœ‰è¯¯ <sup>4.8.8.1</sup> <sup>â±ï¸2023.04.18</sup> [#I6WKRZ](https://gitee.com/dotnetchina/Furion/issues/I6WKRZ)
  - &nbsp;<Tag>ä¿®å¤</Tag> è¿œç¨‹è¯·æ±‚è·å– `Cookies` æ—¶å¦‚æœåŒ…å«ç›¸åŒ `Key` å¼‚å¸¸é—®é¢˜ <sup>4.8.7.44</sup> <sup>â±ï¸2023.04.12</sup> [#I6V3T7](https://gitee.com/dotnetchina/Furion/issues/I6V3T7)
  - &nbsp;<Tag>ä¿®å¤</Tag> è¿œç¨‹è¯·æ±‚ä»£ç†æ¨¡å¼é…ç½®äº† `WithEncodeUrl = false` æ— æ•ˆé—®é¢˜ <sup>4.8.6.4</sup> <sup>â±ï¸2023.02.16</sup> [89639ba](https://gitee.com/dotnetchina/Furion/commit/89639ba1db8a7df750d9bca66a887e252622b219)
  - &nbsp;<Tag>ä¿®å¤</Tag> ç”±äº [#I6D64H](https://gitee.com/dotnetchina/Furion/issues/I6D64H) å¯¼è‡´è¿œç¨‹è¯·æ±‚å‡ºç° `Specified method is not supported.` é—®é¢˜ <sup>4.8.5.9</sup> <sup>â±ï¸2023.02.07</sup> [#I6DEEE](https://gitee.com/dotnetchina/Furion/issues/I6DEEE) [#I6D64H](https://gitee.com/dotnetchina/Furion/issues/I6D64H)
  - &nbsp;<Tag>ä¿®å¤</Tag> ~~ä¼˜åŒ–è¿œç¨‹è¯·æ±‚ `ReadAsStringAsync` åº•å±‚æ–¹æ³•ï¼Œå°è¯•ä¿®å¤ `Error while copying content to a stream.` é”™è¯¯ <sup>4.8.5.8</sup> <sup>â±ï¸2023.02.06</sup> [#I6D64H](https://gitee.com/dotnetchina/Furion/issues/I6D64H)~~
  - &nbsp;<Tag>ä¿®å¤</Tag> è¿œç¨‹è¯·æ±‚é…ç½® `WithEncodeUrl(false)` å¯¹ `application/x-www-form-urlencoded` è¯·æ±‚ç±»å‹æ— æ•ˆ <sup>4.8.4</sup> <sup>â±ï¸2022.12.30</sup> [#I682DX](https://gitee.com/dotnetchina/Furion/issues/I682DX)

- **å…¶ä»–æ›´æ”¹**

  - &nbsp;<Tag>è°ƒæ•´</Tag> å–æ¶ˆè¿œç¨‹è¯·æ±‚ `GET/HEAD` ä¸èƒ½ä¼ é€’ `Body` çš„é™åˆ¶ <sup>4.8.8.39</sup> <sup>â±ï¸2023.08.02</sup> [8113460](https://gitee.com/dotnetchina/Furion/commit/8113460ab8b23cbf392c49b79fe4eb77a89c8010)

- **æ–‡æ¡£**

  - &nbsp;<Tag>æ–°å¢</Tag> è¿œç¨‹è¯·æ±‚ `[QueryString]` é…ç½®æ—¶é—´ç±»å‹ `Format` æ ¼å¼åŒ–æ–‡æ¡£ <sup>4.8.1.2</sup> <sup>â±ï¸2022.11.25</sup> [!673](https://gitee.com/dotnetchina/Furion/pulls/673)

</div>
  </div>
</details>

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 1.16.0 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

## 19.1 å…³äºè¿œç¨‹è¯·æ±‚

åœ¨äº’è”ç½‘å¤§æ•°æ®çš„é©±åŠ¨ä¸‹ï¼Œå¹³å°æˆ–ç³»ç»Ÿå…ä¸äº†éœ€è¦å’Œç¬¬ä¸‰æ–¹è¿›è¡Œæ•°æ®äº¤äº’ï¼Œè€Œç¬¬ä¸‰æ–¹å¾€å¾€æä¾›äº† `RESTful API` æ¥å£è§„èŒƒï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦é€šè¿‡ `Http` è¯·æ±‚ç¬¬ä¸‰æ–¹æ¥å£è¿›è¡Œæ•°æ®ä¼ è¾“äº¤äº’ã€‚

ä¹Ÿå°±æ˜¯æœ¬ç« èŠ‚æ‰€è¯´çš„è¿œç¨‹è¯·æ±‚ã€‚

## 19.2 è¿œç¨‹è¯·æ±‚çš„ä½œç”¨

- è·¨ç³»ç»Ÿã€è·¨è®¾å¤‡é€šä¿¡
- å®ç°å¤šä¸ªç³»ç»Ÿæ•°æ®ä¼ è¾“äº¤äº’
- è·¨ç¼–ç¨‹è¯­è¨€ååŒå¼€å‘

## 19.3 åŸºç¡€ä½¿ç”¨

### 19.3.1 æ³¨å†ŒæœåŠ¡

ä½¿ç”¨ä¹‹å‰éœ€åœ¨ `Startup.cs` æ³¨å†Œ `è¿œç¨‹è¯·æ±‚æœåŠ¡`

```cs showLineNumbers  {3}
public void ConfigureServices(IServiceCollection services)
{
    services.AddRemoteRequest();
}
```

### 19.3.2 ä½¿ç”¨æ–¹å¼

`Furion` æä¾›ä¸¤ç§æ–¹å¼è®¿é—®å‘é€è¿œç¨‹è¯·æ±‚ã€‚

<Tabs
  defaultValue="IHttpDispatchProxy ä»£ç†æ–¹å¼"
  values={[
    {
      label: "IHttpDispatchProxy ä»£ç†æ–¹å¼",
      value: "IHttpDispatchProxy ä»£ç†æ–¹å¼",
    },
    { label: "å­—ç¬¦ä¸²æ‹“å±•æ–¹å¼", value: "å­—ç¬¦ä¸²æ‹“å±•æ–¹å¼" },
  ]}
>
  <TabItem value="IHttpDispatchProxy ä»£ç†æ–¹å¼">

å®šä¹‰ä»£ç†è¯·æ±‚çš„ `æ¥å£` å¹¶ç»§æ‰¿ `IHttpDispatchProxy` æ¥å£

```cs showLineNumbers  {1,3,6,9,12,15,18}
public interface IHttp : IHttpDispatchProxy
{
    [Get("http://furion.baiqian.ltd/get")]
    Task<Result> GetXXXAsync();

    [Post("http://furion.baiqian.ltd/post")]
    Task<Result> PostXXXAsync();

    [Put("http://furion.baiqian.ltd/put")]
    Task<Result> PutXXXAsync();

    [Delete("http://furion.baiqian.ltd/delete")]
    Task<Result> DeleteXXXAsync();

    [Patch("http://furion.baiqian.ltd/patch")]
    Task<Result> PatchXXXAsync();

    [Head("http://furion.baiqian.ltd/head")]
    Task<Result> HeadXXXAsync();
}
```

é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ `æ¥å£`

```cs showLineNumbers  {9,16}
using Furion.DynamicApiController;
using Furion.RemoteRequest.Extensions;

namespace Furion.Application
{
    public class RemoteRequestService : IDynamicApiController
    {
        private readonly IHttp _http;
        public RemoteRequestService(IHttp http)
        {
            _http = http;
        }

        public async Task GetData()
        {
            var data = await _http.GetXXXAsync();
        }
    }
}
```

  </TabItem>
  <TabItem value="å­—ç¬¦ä¸²æ‹“å±•æ–¹å¼">

```cs showLineNumbers
var response = await "http://furion.baiqian.ltd/get".GetAsync();

var response = await "http://furion.baiqian.ltd/post".PostAsync();

var response = await "http://furion.baiqian.ltd/put".PutAsync();

var response = await "http://furion.baiqian.ltd/delete".DeleteAsync();

var response = await "http://furion.baiqian.ltd/patch".PatchAsync();

var response = await "http://furion.baiqian.ltd/head".HeadAsync();
```

éœ€å¼•å…¥ `using Furion.RemoteRequest.Extensions` å‘½åç©ºé—´ã€‚

  </TabItem>
</Tabs>

## 19.4 å­—ç¬¦ä¸²æ–¹å¼ä½¿ç”¨ç¤ºä¾‹

:::important æ¸©é¦¨æç¤º

æ¨èä½¿ç”¨ ã€Š[19.5 ä»£ç†æ–¹å¼](http.mdx#195-ihttpdispatchproxy-ä»£ç†æ–¹å¼)ã€‹ä»£æ›¿æœ¬å°èŠ‚åŠŸèƒ½ã€‚`ä»£ç†æ–¹å¼` èƒ½å¤Ÿæä¾›æ›´å®¹æ˜“ä¸”æ›´æ˜“ç»´æŠ¤çš„æ–¹å¼ã€‚

:::

### 19.4.1 å†…ç½®è¯·æ±‚æ–¹å¼

```cs showLineNumbers
// å‘é€ Get è¯·æ±‚
var response = await "http://furion.baiqian.ltd/get".GetAsync();

// å‘é€ Post è¯·æ±‚
var response = await "http://furion.baiqian.ltd/post".PostAsync();

// å‘é€ Put è¯·æ±‚
var response = await "http://furion.baiqian.ltd/put".PutAsync();

// å‘é€ Delete è¯·æ±‚
var response = await "http://furion.baiqian.ltd/delete".DeleteAsync();

// å‘é€ Patch è¯·æ±‚
var response = await "http://furion.baiqian.ltd/patch".PatchAsync();

// å‘é€ Head è¯·æ±‚
var response = await "http://furion.baiqian.ltd/head".HeadAsync();

// æ‰‹åŠ¨æŒ‡å®šå‘é€ç‰¹å®šè¯·æ±‚
var response = await "http://furion.baiqian.ltd/post".SetHttpMethod(HttpMethod.Post)
                                                  .SendAsync();
```

### 19.4.2 è®¾ç½®è¯·æ±‚åœ°å€

```cs showLineNumbers
// è¯¥æ–¹å¼åœ¨ Furion v3.0.0 å·²ç§»é™¤ï¼Œå¤šæ­¤ä¸€ä¸¾äº†
await "".SetRequestUrl("http://furion.baiqian.ltd/");
```

### 19.4.3 è®¾ç½®è¯·æ±‚æ–¹å¼

```cs showLineNumbers
await "http://furion.baiqian.ltd/post".SetHttpMethod(HttpMethod.Get);
```

### 19.4.4 è®¾ç½®åœ°å€æ¨¡æ¿

```cs showLineNumbers
// å­—å…¸æ–¹å¼
await "http://furion.baiqian.ltd/post/{id}?name={name}&id={p.Id}".SetTemplates(new Dictionary<string , object> {
    { "id", 1 },
    { "name", "Furion" },
    { "p.Id", new Person { Id = 1 } }
});

// å¯¹è±¡/åŒ¿åå¯¹è±¡æ–¹å¼
await "http://furion.baiqian.ltd/post/{id}?name={name}".SetTemplates(new {
    id = 1,
    name = "Furion"
});
```

**æ³¨ï¼šæ¨¡æ¿æ›¿æ¢åŒºåˆ†å¤§å°å†™ã€‚**

### 19.4.5 è®¾ç½®è¯·æ±‚æŠ¥æ–‡å¤´

```cs showLineNumbers
// å­—å…¸æ–¹å¼
await "http://furion.baiqian.ltd/post".SetHeaders(new Dictionary<string , object> {
    { "Authorization", "Bearer ä½ çš„token"},
    { "X-Authorization", "Bearer ä½ çš„åˆ·æ–°token"}
});

// å¯¹è±¡/åŒ¿åå¯¹è±¡æ–¹å¼
await "http://furion.baiqian.ltd/post".SetHeaders(new {
    Authorization = "Bearer ä½ çš„token"
});
```

### 19.4.6 è®¾ç½® `URL` åœ°å€å‚æ•°

```cs showLineNumbers
// å­—å…¸æ–¹å¼
await "http://furion.baiqian.ltd/get".SetQueries(new Dictionary<string , object> {
    { "id", 1 },
    { "name", "Furion"}
});

// å¯¹è±¡/åŒ¿åå¯¹è±¡æ–¹å¼
await "http://furion.baiqian.ltd/get".SetQueries(new {
    id = 1,
    name = "Furion"
});

// Furion 4.7.3+ æ–°å¢å¿½ç•¥ null å€¼é‡è½½
await "http://furion.baiqian.ltd/get".SetQueries(new {
    id = 1,
    name = "Furion",
    nullValue = default(object)
}, true);   // è®¾ç½® true åˆ™å¿½ç•¥ null å€¼
```

æœ€ç»ˆè¾“å‡ºæ ¼å¼ä¸ºï¼š`http://furion.baiqian.ltd/get?id=1&name=Furion`ã€‚

### 19.4.7 è®¾ç½®è¯·æ±‚å®¢æˆ·ç«¯

- **å…¨å±€é…ç½®æ–¹å¼**

```cs showLineNumbers  {1,3-4,12}
services.AddRemoteRequest(options=>
{
    // é…ç½® Github åŸºæœ¬ä¿¡æ¯
    options.AddHttpClient("github", c =>
    {
        c.BaseAddress = new Uri("https://api.github.com/");
        c.DefaultRequestHeaders.Add("Accept", "application/vnd.github.v3+json");
        c.DefaultRequestHeaders.Add("User-Agent", "HttpClientFactory-Sample");
    });
});

await "get".SetClient("github");
```

æœ€ç»ˆç”Ÿæˆè¯·æ±‚åœ°å€ä¸ºï¼š`https://api.github.com/get`ã€‚

- **å±€éƒ¨é…ç½®æ–¹å¼**

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.3.8 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

```cs showLineNumbers
await "http://furion.baiqian.ltd".SetClient(() => new HttpClient());
```

### 19.4.8 è®¾ç½® `Body` å‚æ•°

```cs showLineNumbers
// ä¼ å…¥å¯¹è±¡
await "http://furion.baiqian.ltd/api/user/add".SetBody(new User { Id = 1, Name = "Furion" });

// é…ç½® Content-Type
await "http://furion.baiqian.ltd/api/user/add".SetBody(new { Id = 1, Name = "Furion" }, "application/json");

// è®¾ç½® Encoding ç¼–ç 
await  "http://furion.baiqian.ltd/api/user/add".SetBody(new User { Id = 1, Name = "Furion" }, "application/json", Encoding.UTF8);

// å¤„ç† application/x-www-form-urlencoded è¯·æ±‚
await "http://furion.baiqian.ltd/api/user/add".SetBody(new Dictionary<string , object> {
    { "Id", 1 },
    { "Name", "Furion"}
}, "application/x-www-form-urlencoded");

// å¤„ç† application/xmlã€text/xml
await "http://furion.baiqian.ltd/api/user/add".SetBody("<SomeDto><SomeTag>somevalue</SomeTag></SomeDto>", "application/xml");
```

:::important ç‰¹åˆ«æ³¨æ„

å¦‚æœè¯·æ±‚ `Content-Type` è®¾ç½®ä¸º `application/x-www-form-urlencoded` ç±»å‹ï¼Œé‚£ä¹ˆåº•å±‚è‡ªåŠ¨å°†æ•°æ®è¿›è¡Œ `UrlEncode` ç¼–ç å¤„ç†ï¼Œæ— éœ€å¤–éƒ¨å¤„ç†ã€‚

:::

### 19.4.9 è®¾ç½® `Content-Type`

```cs showLineNumbers
await "http://furion.baiqian.ltd/post".SetContentType("application/json");
```

### 19.4.10 è®¾ç½®å†…å®¹ç¼–ç 

```cs showLineNumbers
await "http://furion.baiqian.ltd/post".SetContentEncoding(Encoding.UTF8);
```

### 19.4.11 è®¾ç½® `JSON` åºåˆ—åŒ–æä¾›ç¨‹åº

`Furion` é»˜è®¤æƒ…å†µä¸‹é‡‡ç”¨ `System.Text.Json` è¿›è¡Œ `JSON` åºåˆ—åŒ–å¤„ç†ï¼Œå¦‚éœ€è®¾ç½®ç¬¬ä¸‰æ–¹ `JSON` æä¾›å™¨ï¼Œåˆ™å¯ä»¥é€šè¿‡ä»¥ä¸‹é…ç½®ï¼š

```cs showLineNumbers
// æ³›å‹æ–¹å¼
await "http://furion.baiqian.ltd/api/user/add".SetJsonSerialization<NewtonsoftJsonSerializerProvider>();

// éæ³›å‹æ–¹å¼
await "http://furion.baiqian.ltd/api/user/add".SetJsonSerialization(typeof(NewtonsoftJsonSerializerProvider));

// æ·»åŠ æ›´å¤šé…ç½®
await "http://furion.baiqian.ltd/api/user/add".SetJsonSerialization<NewtonsoftJsonSerializerProvider>(new JsonSerializerSettings {

});

// æ¯”å¦‚é…ç½®ç¼ºçœçš„åºåˆ—åŒ–é€‰é¡¹
await "http://furion.baiqian.ltd".SetJsonSerialization(default, new JsonSerializerOptions
    {
        // ä¸­æ–‡ä¹±ç 
        Encoder = JavaScriptEncoder.UnsafeRelaxedJsonEscaping
    })
    .GetAsAsync();
```

:::important å…³äº `JSON` åºåˆ—åŒ–æä¾›å™¨

å¦‚éœ€äº†è§£æ›´å¤š `JSON` åºåˆ—åŒ–çŸ¥è¯†å¯æŸ¥é˜… [23. JSON åºåˆ—åŒ–](json-serialization#2351-è‡ªå®šä¹‰åºåˆ—åŒ–æä¾›å™¨) ç« èŠ‚

:::

### 19.4.12 å¯ç”¨ `Body` å‚æ•°éªŒè¯

```cs showLineNumbers
await "http://furion.baiqian.ltd/api/user/add".SetValidationState();

// è®¾ç½®ä¸éªŒè¯ null å€¼
await "http://furion.baiqian.ltd/api/user/add".SetValidationState(includeNull: true);
```

æ”¯æŒç±»ä¸­ `[Required]` ç­‰å®Œæ•´æ¨¡å‹éªŒè¯ç‰¹æ€§ã€‚

### 19.4.13 è¯·æ±‚æ‹¦æˆª

```cs showLineNumbers
await "http://furion.baiqian.ltd/".OnRequesting((client, req) => {
    // req ä¸º HttpRequestMessage å¯¹è±¡
    // è¿½åŠ æ›´å¤šå‚æ•°
    req.AppendQueries(new Dictionary<string, object> {
        { "access_token", "xxxx"}
    });
});
```

**æ”¯æŒå¤šæ¬¡æ‹¦æˆª**

### 19.4.14 `HttpClient` æ‹¦æˆª

```cs showLineNumbers
await "http://furion.baiqian.ltd/".OnClientCreating(client => {
    // client ä¸º HttpClient å¯¹è±¡
    client.Timeout = TimeSpan.FromSeconds(30); // è®¾ç½®è¶…æ—¶æ—¶é—´
});
```

**æ”¯æŒå¤šæ¬¡æ‹¦æˆª**

### 19.4.15 è¯·æ±‚ä¹‹å‰æ‹¦æˆª

```cs showLineNumbers
await "http://furion.baiqian.ltd/".OnRequesting((client, req) => {
    // req ä¸º HttpRequestMessage å¯¹è±¡
});
```

**æ”¯æŒå¤šæ¬¡æ‹¦æˆª**

### 19.4.16 æˆåŠŸè¯·æ±‚æ‹¦æˆª

```cs showLineNumbers
await "http://furion.baiqian.ltd/".OnResponsing((client, res) => {
    // res ä¸º HttpResponseMessage å¯¹è±¡
});
```

**æ”¯æŒå¤šæ¬¡æ‹¦æˆª**

### 19.4.17 è¯·æ±‚å¼‚å¸¸æ‹¦æˆª

```cs showLineNumbers
await "http://furion.baiqian.ltd/".OnException((client, res, errors) => {
    // res ä¸º HttpResponseMessage å¯¹è±¡
});
```

**æ”¯æŒå¤šæ¬¡æ‹¦æˆª**

### 19.4.18 å„ç§è¿”å›å€¼å¤„ç†

`Furion` è¿œç¨‹è¯·æ±‚é»˜è®¤æä¾›å››ç§è¿”å›å€¼ç±»å‹ï¼š

- `HttpResponseMessage`ï¼šè¯·æ±‚å“åº”æ¶ˆæ¯ç±»å‹
- `Stream`ï¼šæµç±»å‹ï¼Œå¯ç”¨æ¥ä¸‹è½½æ–‡ä»¶
- `T`ï¼šæ³›å‹ `T` ç±»å‹
- `String`ï¼šå­—ç¬¦ä¸²ç±»å‹ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥å°†ç½‘ç»œè¯·æ±‚ç»“æœå†…å®¹å­—ç¬¦ä¸²åŒ–
- `Byte[]`ï¼šå­—èŠ‚æ•°ç»„ç±»å‹

å¦‚ï¼š

```cs showLineNumbers
// HttpResponseMessage
var res = await "http://furion.baiqian.ltd/".GetAsync();

// Streamï¼Œå¯ç”¨æ¥ä¸‹è½½æ–‡ä»¶
var (stream, encoding) = await "http://furion.baiqian.ltd/".GetAsStreamAsync();

// T
var user = await "http://furion.baiqian.ltd/".GetAsAsync<User>();

// String
var str = await "https://www.baidu.com".GetAsStringAsync();
```

### 19.4.19 è®¾ç½® `Byte[]/Stream` ç±»å‹/ä¸Šä¼ æ–‡ä»¶

:::warning `Furion 4.4.0` ä»¥ä¸‹ç‰ˆæœ¬

åœ¨ `Furion 4.4.0+` ç‰ˆæœ¬ç§»é™¤äº† `.SetBodyBytes` æ–¹å¼ï¼ŒåŸå› æ˜¯æ‹“å±•æ€§å¤ªå·®ï¼Œ**æ–°ç‰ˆæœ¬è¯·ä½¿ç”¨ `.SetFiles` æ–¹å¼**ã€‚

:::

æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦ä¸Šä¼ æ–‡ä»¶ï¼Œéœ€è¦è®¾ç½® `Content-Type` ä¸º `multipart/form-data` ç±»å‹ï¼Œå¦‚ï¼š

```cs showLineNumbers {3,7,10,15}
// æ”¯æŒå•æ–‡ä»¶ï¼Œbytes å¯ä»¥é€šè¿‡ File.ReadAllBytes(æ–‡ä»¶è·¯å¾„) è·å–
var res = await "http://furion.baiqian.ltd/upload".SetContentType("multipart/form-data")
                                               .SetBodyBytes(("é”®", bytes, "æ–‡ä»¶å")).PostAsync();

// æ”¯æŒå¤šä¸ªæ–‡ä»¶
var res = await "http://furion.baiqian.ltd/upload".SetContentType("multipart/form-data")
                                               .SetBodyBytes(("é”®", bytes, "æ–‡ä»¶å"),("é”®", bytes, "æ–‡ä»¶å")).PostAsync();

// æ”¯æŒå•æ–‡ä»¶ï¼ŒFurion 4.5.8 ç‰ˆæœ¬æ”¯æŒ Stream æ–¹å¼æ›´æ–°
var res = await "http://furion.baiqian.ltd/upload".SetContentType("multipart/form-data")
                                               .SetBodyBytes(("é”®", fileStream, "æ–‡ä»¶å")).PostAsync();

// æ”¯æŒå¤šä¸ªæ–‡ä»¶ï¼ŒFurion 4.5.8 ç‰ˆæœ¬æ”¯æŒ Stream æ–¹å¼æ›´æ–°
var res = await "http://furion.baiqian.ltd/upload".SetContentType("multipart/form-data")
                                               .SetBodyBytes(("é”®", fileStream, "æ–‡ä»¶å"),("é”®", fileStream, "æ–‡ä»¶å")).PostAsync();
```

:::note å…³äºå¾®ä¿¡ä¸Šä¼ æ¥å£

å¦‚æœé‡åˆ°å¾®ä¿¡ä¸Šä¼ å‡ºç°é—®é¢˜ï¼Œåˆ™å¯è®¾ç½® `Content-Type` ä¸ºï¼š`application/octet-stream`ï¼Œå¦‚ï¼š

```cs showLineNumbers
var result = await $"https://api.weixin.qq.com/wxa/img_sec_check?access_token={token}"
                .SetBodyBytes(("media", bytes, Path.GetFileName(imgPath)))
                .SetContentType("application/octet-stream")
                .PostAsStringAsync();
```

:::

:::tip `Furion 4.4.0+` ç‰ˆæœ¬

å¦‚æœä½¿ç”¨ `Furion 4.4.0+` ç‰ˆæœ¬ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹çš„ `.SetFiles` æ›¿ä»£ `.SetBodyBytes` æ“ä½œã€‚

:::

```cs showLineNumbers {3,7}
// bytes å¯ä»¥é€šè¿‡ File.ReadAllBytes(æ–‡ä»¶è·¯å¾„) è·å–
var res = await "http://furion.baiqian.ltd/upload".SetContentType("multipart/form-data")
                                               .SetFiles(HttpFile.Create("file", bytes, "image.png")).PostAsync();

// æ”¯æŒå¤šä¸ªæ–‡ä»¶
var res = await "http://furion.baiqian.ltd/upload".SetContentType("multipart/form-data")
                                               .SetFiles(HttpFile.CreateMultiple("files", (bytes, "image1.png"), (bytes, "image2.png"))).PostAsync();
```

### 19.4.20 è®¾ç½® `IServiceProvider`

æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦æ„å»ºä¸€ä¸ªä½œç”¨åŸŸçš„ `IServiceProvider`ï¼Œè¿™æ—¶åªéœ€è¦è®¾ç½®å³å¯ï¼š

```cs showLineNumbers
var res = await "http://furion.baiqian.ltd/upload".SetRequestScoped(services);
```

### 19.4.21 æ”¯æŒæ¨¡æ¿é…ç½®

æ¨¡æ¿æ ¼å¼ä¸ºï¼š`#(é…ç½®è·¯å¾„)`

```cs showLineNumbers
var res = await "#(Furion:Address)/upload".GetAsync();
```

```json showLineNumbers
{
  "Furion": {
    "Address": "http://furion.baiqian.ltd"
  }
}
```

### 19.4.22 é‡è¯•ç­–ç•¥

åœ¨ `Furion v2.18+` ç‰ˆæœ¬æ”¯æŒé…ç½®é‡è¯•ç­–ç•¥ï¼Œå¦‚ï¼š

```cs showLineNumbers
var res = await "http://furion.baiqian.ltd".SetRetryPolicy(3, 1000).GetAsync();
```

ä»¥ä¸Šä»£ç è¡¨ç¤ºè¯·æ±‚å¤±è´¥é‡è¯• `3` æ¬¡ï¼Œæ¯æ¬¡å»¶è¿Ÿ `1000ms` ã€‚

### 19.4.23 æ”¯æŒ `GZip` å‹ç¼©

åœ¨ `Furion v3.2.0+` ç‰ˆæœ¬æ”¯æŒ`GZip` å‹ç¼©ï¼Œå¦‚ï¼š

```cs showLineNumbers
var res = await "http://furion.baiqian.ltd".WithGZip().GetAsync();
```

### 19.4.24 è®¾ç½® `Url` è½¬ç 

è¿‡å»ç‰ˆæœ¬ä¼šå¯¹æ‰€æœ‰çš„ `Url` è¿›è¡Œ `Uri.EscapeDataString` è½¬ç ï¼Œåœ¨ `Furion v3.8.0+` ç‰ˆæœ¬æ”¯æŒ `Url` è½¬ç è®¾ç½®ï¼Œå¦‚ï¼š

```cs showLineNumbers
var res = await "http://furion.baiqian.ltd".WithEncodeUrl(false).GetAsync();
```

### 19.4.25 è®¾ç½® `HTTP` ç‰ˆæœ¬

å¯è§£å†³ä¸€äº› `HTTP` å’Œ `HTTPS` è¯·æ±‚é—®é¢˜ã€‚

```cs showLineNumbers
var res = await "http://furion.baiqian.ltd".SetHttpVersion("1.0").GetAsync();  // Furion 4.8.5.8+ æ”¯æŒ
```

### 19.4.26 ä¸‹è½½è¿œç¨‹æ–‡ä»¶å¹¶ä¿å­˜

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.7.32 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

```cs showLineNumbers
await "http://furion.baiqian.ltd/img/rm1.png".GetToSaveAsync("D:/rm3.png");
await "http://furion.baiqian.ltd/img/rm1.png".PostToSaveAsync("D:/rm3.png");
...
```

## 19.5 `IHttpDispatchProxy` ä»£ç†æ–¹å¼

### 19.5.1 æ”¯æŒå¤šç§ä»£ç†æ–¹å¼

```cs showLineNumbers
public interface IHttp : IHttpDispatchProxy
{
    // å‘é€ Get è¯·æ±‚
    [Get("http://furion.baiqian.ltd/get")]
    Task<HttpResponseMessage> GetXXXAsync();

    // å‘é€ Post è¯·æ±‚
    [Post("http://furion.baiqian.ltd/post")]
    Task<HttpResponseMessage> PostXXXAsync();

    // å‘é€ Put è¯·æ±‚
    [Put("http://furion.baiqian.ltd/put")]
    Task<HttpResponseMessage> PutXXXAsync();

    // å‘é€ Delete è¯·æ±‚
    [Delete("http://furion.baiqian.ltd/delete")]
    Task<HttpResponseMessage> DeleteXXXAsync();

    // å‘é€ Patch è¯·æ±‚
    [Patch("http://furion.baiqian.ltd/patch")]
    Task<HttpResponseMessage> PatchXXXAsync();

    // å‘é€ Head è¯·æ±‚
    [Head("http://furion.baiqian.ltd/head")]
    Task<HttpResponseMessage> HeadXXXAsync();
}
```

### 19.5.2 è®¾ç½®åœ°å€æ¨¡æ¿

```cs showLineNumbers
public interface IHttp : IHttpDispatchProxy
{
    [Get("http://furion.baiqian.ltd/get/{id}?name={name}&number={p.PersonDetail.PhonNumber}")]
    Task<HttpResponseMessage> GetXXXAsync(int id, string name, Person p);
}
```

**æ³¨ï¼šæ¨¡æ¿æ›¿æ¢åŒºåˆ†å¤§å°å†™ã€‚**

### 19.5.3 è®¾ç½®è¯·æ±‚æŠ¥æ–‡å¤´

`Furion` æ¡†æ¶è¿œç¨‹è¯·æ±‚ä»£ç†æ¨¡å¼æä¾›ä¸‰ç§æ–¹å¼è®¾ç½®è¯·æ±‚æŠ¥æ–‡å¤´ï¼š

- æ”¯æŒåœ¨æ¥å£ä¸­å£°æ˜
- æ”¯æŒåœ¨æ–¹æ³•ä¸­å£°æ˜
- æ”¯æŒåœ¨å‚æ•°ä¸­å£°æ˜

```cs showLineNumbers  {1-2,5,9,12}
[Headers("key","value")]
[Headers("key1","value2")] // è®¾ç½®å¤šä¸ª
public interface IHttp : IHttpDispatchProxy
{
    [Get("http://furion.baiqian.ltd/get/{id}?name={name}"), Headers("key2","value2")]
    Task<HttpResponseMessage> GetXXXAsync(int id, string name);

    [Get("http://furion.baiqian.ltd")]
    Task<HttpResponseMessage> GetXXX2Async(int id, [Headers]string token = default);

    [Get("http://furion.baiqian.ltd")]
    Task<HttpResponseMessage> GetXXX2Async(int id, string name, [Headers("åˆ«å")]string token = default);
}
```

---

**å¦‚éœ€åŠ¨æ€è®¾ç½®ï¼Œå¯ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼ˆæ·»åŠ å‚æ•°æ‹¦æˆªå™¨ï¼‰ï¼š**

```cs showLineNumbers {5}
public interface IHttp : IHttpDispatchProxy
{
    // é€šè¿‡å‚æ•°æ‹¦æˆª
    [Post("http://furion.baiqian.ltd/post")]
    Task<HttpResponseMessage> PostXXXAsync(string name, [Interceptor(InterceptorTypes.Request)] Action<HttpClient, HttpRequestMessage> action = default);
}
```

è°ƒç”¨ï¼š

```cs showLineNumbers {1,3,9,15}
_http.PostXXXAsync("ç™¾å°åƒ§", (client, requestMessage) =>
{
    requestMessage.AppendHeaders(new Dictionary<string , object> {
        { "Authorization", "Bearer ä½ çš„token"},
        { "X-Authorization", "Bearer ä½ çš„åˆ·æ–°token"}
    });

    // ä¹Ÿæ”¯æŒå¯¹è±¡ï¼ŒåŒ¿åæ–¹å¼
    requestMessage.AppendHeaders(new {
        Authorization = "Bearer ä½ çš„token",
        Others = "å…¶ä»–"
    });

    // ä¹Ÿå¯ä»¥ä½¿ç”¨åŸç”Ÿ
    requestMessage.Headers.TryAddWithoutValidation("Authorization", "Bearer ä½ çš„token");
    requestMessage.Headers.TryAddWithoutValidation("key", "value");
});
```

### 19.5.4 è®¾ç½® `URL` åœ°å€å‚æ•°

```cs showLineNumbers  {4,7,10,13,17,21,25}
public interface IHttp : IHttpDispatchProxy
{
    [Get("http://furion.baiqian.ltd/get/{id}?name={name}")]
    Task<HttpResponseMessage> GetXXXAsync(int id, string name);

    [Get("http://furion.baiqian.ltd/get/{p.Id}?name={p.Name}")]
    Task<HttpResponseMessage> GetXXXAsync(Person p);

    [Get("http://furion.baiqian.ltd/get")]
    Task<HttpResponseMessage> GetXXXAsync([QueryString]int id, [QueryString]string name);

    [Get("http://furion.baiqian.ltd/get")]
    Task<HttpResponseMessage> GetXXXAsync([QueryString]int id, [QueryString("åˆ«å")]string name);

    // Furion 4.8.1.4 æ–°å¢ [QueryString(Format)] é…ç½®æ—¶é—´ç±»å‹æ ¼å¼åŒ–
    [Get("http://furion.baiqian.ltd/get")]
    Task<HttpResponseMessage> GetXXXAsync([QueryString(Format = "yyyy-MM-dd HH:mm:ss")] DateTime queryStartTime, [QueryString(Format = "yyyy-MM-dd HH:mm:ss")] DateTime queryEndTime);

    // Furion 4.8.1.4 æ–°å¢ [QueryString(Format)] é…ç½®æ—¶é—´ç±»å‹æ ¼å¼åŒ–
    [Get("http://furion.baiqian.ltd/get")]
    Task<HttpResponseMessage> GetXXXAsync([QueryString(Format = "yyyy-MM-dd HH:mm:ss")] DateTimeOffset queryStartTime, [QueryString(Format = "yyyy-MM-dd HH:mm:ss")] DateTimeOffset queryEndTime);

    // Furion 4.7.3 æ–°å¢ IgnoreNullValueQueries é…ç½®å¿½ç•¥ç©ºå€¼
    [Get("http://furion.baiqian.ltd/get", IgnoreNullValueQueries = true)]
    Task<HttpResponseMessage> GetXXXAsync([QueryString]int id, [QueryString]string name, [QueryString]string nullValue);
}
```

æœ€ç»ˆè¾“å‡ºæ ¼å¼ä¸ºï¼š`http://furion.baiqian.ltd/get?id=1&name=Furion`ã€‚

:::tip å…³äºå¯¹è±¡ç±»å‹ç›´æ¥ä½œä¸ºæ¨¡æ¿å‚æ•°

åœ¨å¯¹æ¥æŸäº›ç¬¬ä¸‰æ–¹æ¥å£çš„æ—¶å€™å¯èƒ½é‡åˆ°ä¸€ç§æƒ…å†µï¼Œéœ€è¦æŠŠå¯¹è±¡åºåˆ—åŒ–æˆ–è€…è¿›è¡ŒæŸç§å¤„ç†åä½œä¸º `Url` å‚æ•°ï¼Œå¦‚ï¼š

```cs showLineNumbers {1}
[Get("http://furion.baiqian.ltd/get?json={p}", WithEncodeUrl = false)]    // è¿™é‡Œå°† p ä½œä¸ºæ¨¡æ¿ä¼ å…¥
Task<HttpResponseMessage> GetXXXAsync(Person p);
```

å¦‚æœ `Person` ç±»å‹ä¸åšä»»ä½•å¤„ç†ï¼Œé‚£ä¹ˆæœ€ç»ˆä¼ é€’çš„æ˜¯ `Person` çš„å‘½åç©ºé—´ï¼š`http://furion.baiqian.ltd/get?json=YourProject.Person`ï¼Œä½†è¿™å¹¶éæ˜¯æˆ‘ä»¬çš„é¢„æœŸã€‚

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åªéœ€è¦é‡å†™ `Person` çš„ `ToString` æ–¹æ³•å³å¯ï¼Œå¦‚ï¼š

```cs showLineNumbers {5-8}
public class Person
{
    public string Name { get; set; }

    public override string ToString()
    {
        return JsonSerializer.Serialize(this);  // æ¯”å¦‚è¿™é‡Œåšåºåˆ—åŒ–å¤„ç†
        // å¦‚æœåŸºç±»ä¸­ overrideï¼Œå¯ä½¿ç”¨ return JsonSerializer.Serialize<object>(this);
    }
}
```

:::

### 19.5.5 è®¾ç½®è¯·æ±‚å®¢æˆ·ç«¯

- **å…¨å±€é…ç½®æ–¹å¼**

```cs showLineNumbers  {1,3-4,12,15}
services.AddRemoteRequest(options=>
{
    // é…ç½® Github åŸºæœ¬ä¿¡æ¯
    options.AddHttpClient("github", c =>
    {
        c.BaseAddress = new Uri("https://api.github.com/");
        c.DefaultRequestHeaders.Add("Accept", "application/vnd.github.v3+json");
        c.DefaultRequestHeaders.Add("User-Agent", "HttpClientFactory-Sample");
    });
});

[Client("github")]  // å¯ä»¥åœ¨æ¥å£ä¸­å…¨å±€ä½¿ç”¨
public interface IHttp : IHttpDispatchProxy
{
    [Get("get"), Client("github")]  // ä¹Ÿå¯ä»¥åœ¨æ–¹æ³•ä¸­å±€éƒ¨ä½¿ç”¨
    Task<HttpResponseMessage> GetXXXAsync();
}
```

æœ€ç»ˆç”Ÿæˆè¯·æ±‚åœ°å€ä¸ºï¼š`https://api.github.com/get`ã€‚

- **å±€éƒ¨é…ç½®æ–¹å¼**

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.3.8 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

```cs showLineNumbers {5,7-11}
public interface IHttp : IHttpDispatchProxy
{
    // å±€éƒ¨æ–¹å¼
    [Get("get")]
    Task<HttpResponseMessage> GetXXXAsync([Interceptor(InterceptorTypes.Initiate)]Func<HttpClient> clientProvider);

    // å…¨å±€é™æ€æ–¹å¼
    [Interceptor(InterceptorTypes.Initiate)]
    static HttpClient CreateHttpClient()
    {
        return new HttpClient(...);
    }
}
```

### 19.5.6 è®¾ç½® `Body` å‚æ•°

```cs showLineNumbers  {3,6,9}
public interface IHttp : IHttpDispatchProxy
{
    [Post("http://furion.baiqian.ltd/post")]
    Task<HttpResponseMessage> PostXXXAsync([Body]User user);

    [Post("http://furion.baiqian.ltd/post")]
    Task<HttpResponseMessage> PostXXXAsync([Body("application/x-www-form-urlencoded")]User user);

    [Post("http://furion.baiqian.ltd/post")]
    Task<HttpResponseMessage> PostXXXAsync([Body("application/x-www-form-urlencoded", "UTF-8")]User user);
}
```

### 19.5.7 è®¾ç½® `JSON` åºåˆ—åŒ–æä¾›ç¨‹åº

`Furion` é»˜è®¤æƒ…å†µä¸‹é‡‡ç”¨ `System.Text.Json` è¿›è¡Œ `JSON` åºåˆ—åŒ–å¤„ç†ï¼Œå¦‚éœ€è®¾ç½®ç¬¬ä¸‰æ–¹ `JSON` æä¾›å™¨ï¼Œåˆ™å¯ä»¥é€šè¿‡ä»¥ä¸‹é…ç½®ï¼š

```cs showLineNumbers  {3,6-7}
public interface IHttp : IHttpDispatchProxy
{
    [Post("http://furion.baiqian.ltd/post"), JsonSerialization(typeof(NewtonsoftJsonSerializerProvider))]
    Task<HttpResponseMessage> PostXXXAsync([Body]User user);

    [Post("http://furion.baiqian.ltd/post"), JsonSerialization(typeof(NewtonsoftJsonSerializerProvider))]
    Task<HttpResponseMessage> PostXXXAsync([Body]User user, [JsonSerializerOptions]object jsonSerializerOptions = default);

    /// <summary>
    /// ç¼ºçœåºåˆ—åŒ–é…ç½®
    /// </summary>
    /// <returns></returns>
    [JsonSerializerOptions]
    static object GetJsonSerializerOptions()
    {
        // è¿™é‡Œä¹Ÿå¯ä»¥é€šè¿‡ JSON.GetSerializerOptions<JsonSerializerOptions>() è·å– Startup.cs ä¸­çš„é…ç½®
        return new JsonSerializerOptions
        {

        };
    }
}
```

`[JsonSerializerOptions]` å¯ä»¥æ ‡è®°å‚æ•°æ˜¯ä¸€ä¸ª `JSON` åºåˆ—åŒ–é…ç½®å‚æ•°ã€‚

:::important å…³äº `JSON` åºåˆ—åŒ–æä¾›å™¨

å¦‚éœ€äº†è§£æ›´å¤š `JSON` åºåˆ—åŒ–çŸ¥è¯†å¯æŸ¥é˜… [23. JSON åºåˆ—åŒ–](json-serialization#2351-è‡ªå®šä¹‰åºåˆ—åŒ–æä¾›å™¨) ç« èŠ‚

:::

### 19.5.8 å‚æ•°éªŒè¯

```cs showLineNumbers  {4,7}
public interface IHttp : IHttpDispatchProxy
{
    [Post("http://furion.baiqian.ltd/post")]
    Task<HttpResponseMessage> PostXXXAsync([Range(1,10)]int id, [Required, MaxLength(10)]string name);

    [Post("http://furion.baiqian.ltd/post")]
    Task<HttpResponseMessage> PostXXXAsync([Required]User user);  // å¯¹è±¡ç±»å‹æ”¯æŒå±æ€§é…ç½®ç‰¹æ€§éªŒè¯
}
```

### 19.5.9 è¯·æ±‚æ‹¦æˆª

`Furion` è¿œç¨‹è¯·æ±‚ä»£ç†æ–¹å¼æä¾›ä¸¤ç§æ‹¦æˆªæ–¹å¼ï¼š

- æ¥å£é™æ€æ–¹æ³•æ‹¦æˆª
- å‚æ•°æ ‡è®°æ‹¦æˆª

```cs showLineNumbers  {5,8,18}
public interface IHttp : IHttpDispatchProxy
{
    // é€šè¿‡å‚æ•°æ‹¦æˆª
    [Post("http://furion.baiqian.ltd/post")]
    Task<HttpResponseMessage> PostXXXAsync([Interceptor(InterceptorTypes.Request)] Action<HttpClient, HttpRequestMessage> action = default);

    // å…¨å±€æ‹¦æˆªï¼Œç±»ä¸­æ¯ä¸€ä¸ªæ–¹æ³•éƒ½ä¼šè§¦å‘
    [Interceptor(InterceptorTypes.Request)]
    static void OnRequesting1(HttpClient client, HttpRequestMessage req)
    {
        // è¿½åŠ æ›´å¤šå‚æ•°
        req.AppendQueries(new Dictionary<string, object> {
            { "access_token", "xxxx"}
        });
    }

    // å…¨å±€æ‹¦æˆªï¼Œç±»ä¸­æ¯ä¸€ä¸ªæ–¹æ³•éƒ½ä¼šè§¦å‘
    [Interceptor(InterceptorTypes.Request)]
    static void OnRequesting2(HttpClient client, HttpRequestMessage req)
    {

    }
}
```

**æ”¯æŒå¤šæ¬¡æ‹¦æˆª**

### 19.5.10 `HttpClient` æ‹¦æˆª

`Furion` è¿œç¨‹è¯·æ±‚ä»£ç†æ–¹å¼æä¾›ä¸¤ç§æ‹¦æˆªæ–¹å¼ï¼š

- æ¥å£é™æ€æ–¹æ³•æ‹¦æˆª
- å‚æ•°æ ‡è®°æ‹¦æˆª

```cs showLineNumbers  {5,8,15}
public interface IHttp : IHttpDispatchProxy
{
    // é€šè¿‡å‚æ•°æ‹¦æˆª
    [Post("http://furion.baiqian.ltd/post")]
    Task<HttpResponseMessage> PostXXXAsync([Interceptor(InterceptorTypes.Client)] Action<HttpClient> action = default);

    // å…¨å±€æ‹¦æˆªï¼Œç±»ä¸­æ¯ä¸€ä¸ªæ–¹æ³•éƒ½ä¼šè§¦å‘
    [Interceptor(InterceptorTypes.Client)]
    static void onClientCreating1(HttpClient client)
    {

    }

    // å…¨å±€æ‹¦æˆªï¼Œç±»ä¸­æ¯ä¸€ä¸ªæ–¹æ³•éƒ½ä¼šè§¦å‘
    [Interceptor(InterceptorTypes.Client)]
    static void onClientCreating2(HttpClient client)
    {

    }
}
```

**æ”¯æŒå¤šæ¬¡æ‹¦æˆª**

### 19.5.11 è¯·æ±‚ä¹‹å‰æ‹¦æˆª

`Furion` è¿œç¨‹è¯·æ±‚ä»£ç†æ–¹å¼æä¾›ä¸¤ç§æ‹¦æˆªæ–¹å¼ï¼š

- æ¥å£é™æ€æ–¹æ³•æ‹¦æˆª
- å‚æ•°æ ‡è®°æ‹¦æˆª

```cs showLineNumbers  {5,8,15}
public interface IHttp : IHttpDispatchProxy
{
    // é€šè¿‡å‚æ•°æ‹¦æˆª
    [Post("http://furion.baiqian.ltd/post")]
    Task<HttpResponseMessage> PostXXXAsync([Interceptor(InterceptorTypes.Request)] Action<HttpClient, HttpRequestMessage> action = default);

    // å…¨å±€æ‹¦æˆªï¼Œç±»ä¸­æ¯ä¸€ä¸ªæ–¹æ³•éƒ½ä¼šè§¦å‘
    [Interceptor(InterceptorTypes.Request)]
    static void OnRequest1(HttpClient client, HttpRequestMessage req)
    {

    }

    // å…¨å±€æ‹¦æˆªï¼Œç±»ä¸­æ¯ä¸€ä¸ªæ–¹æ³•éƒ½ä¼šè§¦å‘
    [Interceptor(InterceptorTypes.Request)]
    static void OnRequest2(HttpClient client, HttpRequestMessage req)
    {

    }
}
```

**æ”¯æŒå¤šæ¬¡æ‹¦æˆª**

### 19.5.12 æˆåŠŸè¯·æ±‚æ‹¦æˆª

`Furion` è¿œç¨‹è¯·æ±‚ä»£ç†æ–¹å¼æä¾›ä¸¤ç§æ‹¦æˆªæ–¹å¼ï¼š

- æ¥å£é™æ€æ–¹æ³•æ‹¦æˆª
- å‚æ•°æ ‡è®°æ‹¦æˆª

```cs showLineNumbers  {5,8,15}
public interface IHttp : IHttpDispatchProxy
{
    // é€šè¿‡å‚æ•°æ‹¦æˆª
    [Post("http://furion.baiqian.ltd/post")]
    Task<HttpResponseMessage> PostXXXAsync([Interceptor(InterceptorTypes.Response)] Action<HttpClient, HttpResponseMessage> action = default);

    // å…¨å±€æ‹¦æˆªï¼Œç±»ä¸­æ¯ä¸€ä¸ªæ–¹æ³•éƒ½ä¼šè§¦å‘
    [Interceptor(InterceptorTypes.Response)]
    static void OnResponsing1(HttpClient client, HttpResponseMessage res)
    {

    }

    // å…¨å±€æ‹¦æˆªï¼Œç±»ä¸­æ¯ä¸€ä¸ªæ–¹æ³•éƒ½ä¼šè§¦å‘
    [Interceptor(InterceptorTypes.Response)]
    static void OnResponsing2(HttpClient client, HttpResponseMessage res)
    {

    }
}
```

**æ”¯æŒå¤šæ¬¡æ‹¦æˆª**

### 19.5.13 è¯·æ±‚å¼‚å¸¸æ‹¦æˆª

`Furion` è¿œç¨‹è¯·æ±‚ä»£ç†æ–¹å¼æä¾›ä¸¤ç§æ‹¦æˆªæ–¹å¼ï¼š

- æ¥å£é™æ€æ–¹æ³•æ‹¦æˆª
- å‚æ•°æ ‡è®°æ‹¦æˆª

```cs showLineNumbers  {5,8,15}
public interface IHttp : IHttpDispatchProxy
{
    // é€šè¿‡å‚æ•°æ‹¦æˆª
    [Post("http://furion.baiqian.ltd/post")]
    Task<HttpResponseMessage> PostXXXAsync([Interceptor(InterceptorTypes.Exception)] Action<HttpClient, HttpResponseMessage, string> action = default);

    // å…¨å±€æ‹¦æˆªï¼Œç±»ä¸­æ¯ä¸€ä¸ªæ–¹æ³•éƒ½ä¼šè§¦å‘
    [Interceptor(InterceptorTypes.Exception)]
    static void OnException1(HttpClient client, HttpResponseMessage res, string errors)
    {

    }

    // å…¨å±€æ‹¦æˆªï¼Œç±»ä¸­æ¯ä¸€ä¸ªæ–¹æ³•éƒ½ä¼šè§¦å‘
    [Interceptor(InterceptorTypes.Exception)]
    static void OnException2(HttpClient client, HttpResponseMessage res, string errors)
    {

    }
}
```

**æ”¯æŒå¤šæ¬¡æ‹¦æˆª**

### 19.5.14 å„ç§è¿”å›å€¼å¤„ç†

`Furion` è¿œç¨‹è¯·æ±‚é»˜è®¤æä¾›å››ç§è¿”å›å€¼ç±»å‹ï¼š

- `HttpResponseMessage`ï¼šè¯·æ±‚å“åº”æ¶ˆæ¯ç±»å‹
- `Stream`ï¼šæµç±»å‹ï¼Œå¯ç”¨æ¥ä¸‹è½½æ–‡ä»¶
- `T`ï¼šæ³›å‹ `T` ç±»å‹
- `String`ï¼šå­—ç¬¦ä¸²ç±»å‹ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥å°†ç½‘ç»œè¯·æ±‚ç»“æœå†…å®¹å­—ç¬¦ä¸²åŒ–

å¦‚ï¼š

```cs showLineNumbers
public interface IHttp : IHttpDispatchProxy
{
    // HttpResponseMessage
    [Post("http://furion.baiqian.ltd/post")]
    Task<HttpResponseMessage> PostXXXAsync();

    // Streamï¼Œå¯ç”¨æ¥ä¸‹è½½æ–‡ä»¶
    [Post("http://furion.baiqian.ltd/post")]
    Task<Stream> PostXXXAsync();

    // T
    [Post("http://furion.baiqian.ltd/post")]
    Task<User> PostXXXAsync();

    // String
    [Post("http://furion.baiqian.ltd/post")]
    Task<string> PostXXXAsync();
}
```

### 19.5.15 è®¾ç½® `Byte[]/Stream` ç±»å‹/ä¸Šä¼ æ–‡ä»¶

:::warning `Furion 4.4.0` ä»¥ä¸‹ç‰ˆæœ¬

åœ¨ `Furion 4.4.0+` ç‰ˆæœ¬ç§»é™¤äº† `[BodyBytes]` æ–¹å¼ï¼ŒåŸå› æ˜¯æ‹“å±•æ€§å¤ªå·®ï¼Œ**æ–°ç‰ˆæœ¬è¯·ä½¿ç”¨ `HttpFile` æ–¹å¼**ã€‚

:::

æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦ä¸Šä¼ æ–‡ä»¶ï¼Œéœ€è¦è®¾ç½® `Content-Type` ä¸º `multipart/form-data` ç±»å‹ï¼Œå¦‚ï¼š

```cs showLineNumbers {3,4}
public interface IHttp : IHttpDispatchProxy
{
    [Post("http://furion.baiqian.ltd/upload", ContentType = "multipart/form-data")] // bytes å¯ä»¥é€šè¿‡ File.ReadAllBytes(æ–‡ä»¶è·¯å¾„) è·å–
    Task<HttpResponseMessage> PostXXXAsync([BodyBytes("é”®","æ–‡ä»¶å")]Byte[] bytes);

    // æ”¯æŒå¤šä¸ªæ–‡ä»¶
    [Post("http://furion.baiqian.ltd/upload", ContentType = "multipart/form-data")] // bytes å¯ä»¥é€šè¿‡ File.ReadAllBytes(æ–‡ä»¶è·¯å¾„) è·å–
    Task<HttpResponseMessage> PostXXXAsync([BodyBytes("é”®","æ–‡ä»¶å")]Byte[] bytes,[BodyBytes("é”®","æ–‡ä»¶å")]Byte[] bytes2);
}
```

:::tip `Furion 4.4.0+` ç‰ˆæœ¬

å¦‚æœä½¿ç”¨ `Furion 4.4.0+` ç‰ˆæœ¬ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹çš„ `HttpFile` æ›¿ä»£ `[BodyBytes]` æ“ä½œã€‚è¯·æ±‚æœ‰é¢å¤–å‚æ•°æ—¶ `HttpFile` å¿…é¡»è®¾ç½® `fileName` å€¼ã€‚

:::

```cs showLineNumbers {3-4,7-8,11-12,15-16}
public interface IHttp : IHttpDispatchProxy
{
    [Post("http://furion.baiqian.ltd/upload", ContentType = "multipart/form-data")]
    Task<HttpResponseMessage> PostXXXAsync(HttpFile file);


    [Post("http://furion.baiqian.ltd/upload", ContentType = "multipart/form-data")]
    Task<HttpResponseMessage> PostXXXAsync(HttpFile file, [Body("multipart/form-data")]User user);

    // æ”¯æŒå¤šä¸ªæ–‡ä»¶
    [Post("http://furion.baiqian.ltd/upload", ContentType = "multipart/form-data")]
    Task<HttpResponseMessage> PostXXXAsync(HttpFile[] files);

    // æ”¯æŒå¤šä¸ªæ–‡ä»¶
    [Post("http://furion.baiqian.ltd/upload", ContentType = "multipart/form-data")]
    Task<HttpResponseMessage> PostXXXAsync(IList<HttpFile> files);
}
```

### 19.5.16 æ”¯æŒæ¨¡æ¿é…ç½®

æ¨¡æ¿æ ¼å¼ä¸ºï¼š`#(é…ç½®è·¯å¾„)`

```cs showLineNumbers
public interface IHttp : IHttpDispatchProxy
{
    [Post("#(Furion:Address)/upload")]
    Task<HttpResponseMessage> PostXXXAsync([Body]User user);
}
```

```json showLineNumbers
{
  "Furion": {
    "Address": "http://furion.baiqian.ltd"
  }
}
```

æ–¹æ³•çš„ä¼˜å…ˆçº§é«˜äºæ¥å£å®šä¹‰çš„ä¼˜å…ˆçº§ã€‚

### 19.5.17 é‡è¯•ç­–ç•¥

åœ¨ `Furion v2.18+` ç‰ˆæœ¬æ”¯æŒé…ç½®é‡è¯•ç­–ç•¥ï¼Œå¦‚ï¼š

```cs showLineNumbers
[RetryPolicy(3, 1000)] // æ”¯æŒå…¨å±€
public interface IHttp : IHttpDispatchProxy
{
    [Post("http://furion.baiqian.ltd"), RetryPolicy(3, 1000)]    // æ”¯æŒå±€éƒ¨
    Task<HttpResponseMessage> PostXXXAsync([Body]User user);
}
```

ä»¥ä¸Šä»£ç è¡¨ç¤ºè¯·æ±‚å¤±è´¥é‡è¯• `3` æ¬¡ï¼Œæ¯æ¬¡å»¶è¿Ÿ `1000ms` ã€‚

### 19.5.18 æ”¯æŒ `GZip`

åœ¨ `Furion v3.2.0+` ç‰ˆæœ¬æ”¯æŒ `GZip`ï¼Œå¦‚ï¼š

```cs showLineNumbers
public interface IHttp : IHttpDispatchProxy
{
    [Post("http://furion.baiqian.ltd", WithGZip = true)]
    Task<HttpResponseMessage> PostXXXAsync([Body]User user);
}
```

### 19.5.19 è®¾ç½® `Url` è½¬ç 

è¿‡å»ç‰ˆæœ¬ä¼šå¯¹æ‰€æœ‰çš„ `Url` è¿›è¡Œ `Uri.EscapeDataString` è½¬ç ï¼Œåœ¨ `Furion v3.8.0+` ç‰ˆæœ¬æ”¯æŒ `Url` è½¬ç è®¾ç½®ï¼Œå¦‚ï¼š

```cs showLineNumbers
public interface IHttp : IHttpDispatchProxy
{
    [Post("http://furion.baiqian.ltd", WithEncodeUrl = false)]
    Task<HttpResponseMessage> PostXXXAsync([Body]User user);
}
```

### 19.5.20 è®¾ç½® `HTTP` ç‰ˆæœ¬

å¯è§£å†³ä¸€äº› `HTTP` å’Œ `HTTPS` è¯·æ±‚é—®é¢˜ã€‚

```cs showLineNumbers
public interface IHttp : IHttpDispatchProxy
{
    [Post("http://furion.baiqian.ltd", HttpVersion = "1.1")]
    Task<HttpResponseMessage> PostXXXAsync([Body]User user);
}
```

## 19.6 è¯·æ±‚å®¢æˆ·ç«¯é…ç½®

`Furion` æ¡†æ¶ä¹Ÿæä¾›äº†å¤šä¸ªè¯·æ±‚å®¢æˆ·ç«¯é…ç½®ï¼Œå¯ä»¥ä¸ºå¤šä¸ªå®¢æˆ·ç«¯è¯·æ±‚é…ç½®é»˜è®¤è¯·æ±‚ä¿¡æ¯ï¼Œç›®å‰æ”¯æŒå››ç§æ¨¡å¼è¿›è¡Œé…ç½®ã€‚

### 19.6.1 `Startup.cs` ç»Ÿä¸€é…ç½®

```cs showLineNumbers  {4,9}
services.AddRemoteRequest(options=>
{
    // é…ç½®é»˜è®¤ HttpClient
    options.AddHttpClient(string.Empty, c => {
        // å…¶ä»–é…ç½®
    });

    // é…ç½®ç‰¹å®šå®¢æˆ·ç«¯
    options.AddHttpClient("github", c =>
    {
        c.BaseAddress = new Uri("https://api.github.com/");
        c.DefaultRequestHeaders.Add("Accept", "application/vnd.github.v3+json");
        c.DefaultRequestHeaders.Add("User-Agent", "HttpClientFactory-Sample");
    });
})
```

**é…ç½®äº†å‘½åå®¢æˆ·ç«¯åï¼Œæ¯æ¬¡è¯·æ±‚éƒ½ä¼šè‡ªåŠ¨åŠ ä¸Šè¿™äº›é…ç½®ã€‚**

- åœ¨ `ä»£ç†è¯·æ±‚` ä½¿ç”¨

```cs showLineNumbers {1,7}
// åœ¨æ¥å£å®šä¹‰ä¸­ä½¿ç”¨
[Client("github")]
public interface IHttp: IHttpDispatchProxy
{
}

// åœ¨æ–¹æ³•ä¸­ä½¿ç”¨
[Get("api/getdata"), Client("github")]
Task<User> GetData();

[Put("api/getdata"), Client("facebook")]
Task<User> GetData();
```

- åœ¨ `å­—ç¬¦ä¸²æ‹“å±•` ä½¿ç”¨

```cs showLineNumbers
// è®¾ç½®è¯·æ±‚æ‹¦æˆª
var response = await "http://47.100.247.61/api/sysdata/categories".SetClient("github").PostAsync();
```

- åœ¨ `IHttpClientFactory` ä¸­ä½¿ç”¨

```cs showLineNumbers {3,13}
public class ValuesController : Controller
{
    private readonly IHttpClientFactory _httpClientFactory;

    public ValuesController(IHttpClientFactory httpClientFactory)
    {
        _httpClientFactory = httpClientFactory;
    }

    [HttpGet]
    public async Task<ActionResult> Get()
    {
        var client = _httpClientFactory.CreateClient("github");
        string result = await client.GetStringAsync("/");
        return Ok(result);
    }
}
```

### 19.6.2 é…ç½®å®¢æˆ·ç«¯ `Timeout`

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`HttpClient` è¯·æ±‚è¶…æ—¶æ—¶é—´ä¸º `100ç§’`ï¼Œå¯æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œè®¾ç½®ï¼š

```cs showLineNumbers {4,10}
// é…ç½®é»˜è®¤ HttpClient
options.AddHttpClient(string.Empty, c =>
{
    c.Timeout = TimeSpan.FromMinutes(2);
});

// é…ç½®ç‰¹å®šå®¢æˆ·ç«¯
options.AddHttpClient("github", c =>
{
    c.Timeout = TimeSpan.FromMinutes(2);
});
```

### 19.6.3 é…ç½®å®¢æˆ·ç«¯ç”Ÿå­˜æœŸ

æ¯æ¬¡å¯¹ `IHttpClientFactory` è°ƒç”¨ `CreateClient` éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–° `HttpClient` å®ä¾‹ã€‚ æ¯ä¸ªå‘½åå®¢æˆ·ç«¯éƒ½åˆ›å»ºä¸€ä¸ª `HttpMessageHandler`ã€‚ å·¥å‚ç®¡ç† `HttpMessageHandler` å®ä¾‹çš„ç”Ÿå­˜æœŸã€‚

`IHttpClientFactory` å°†å·¥å‚åˆ›å»ºçš„ `HttpMessageHandler` å®ä¾‹æ±‡é›†åˆ°æ± ä¸­ï¼Œä»¥å‡å°‘èµ„æºæ¶ˆè€—ã€‚ æ–°å»º `HttpClient` å®ä¾‹æ—¶ï¼Œå¯èƒ½ä¼šé‡ç”¨æ± ä¸­çš„ `HttpMessageHandler` å®ä¾‹ï¼ˆå¦‚æœç”Ÿå­˜æœŸå°šæœªåˆ°æœŸçš„è¯ï¼‰ã€‚

å¤„ç†ç¨‹åºçš„é»˜è®¤ç”Ÿå­˜æœŸä¸º**ä¸¤åˆ†é’Ÿ**ã€‚ å¯åœ¨æ¯ä¸ªå‘½åå®¢æˆ·ç«¯ä¸Šé‡å†™é»˜è®¤å€¼ï¼š

```cs showLineNumbers {3,7}
// é…ç½®é»˜è®¤ HttpClient
options.AddHttpClient(string.Empty, c => { ... })
       .SetHandlerLifetime(TimeSpan.FromMinutes(5));

// é…ç½®ç‰¹å®šå®¢æˆ·ç«¯
options.AddHttpClient("github", c => { ... })
       .SetHandlerLifetime(TimeSpan.FromMinutes(5));
```

### 19.6.4 è‡ªå®šä¹‰ `Client` ç±»æ–¹å¼

æˆ‘ä»¬å¯ä»¥æŒ‰ç…§ä¸€å®šçš„è§„åˆ™ç¼–å†™ç‰¹å®šæœåŠ¡çš„è¯·æ±‚å®¢æˆ·ç«¯ï¼Œå¦‚ï¼š

```cs showLineNumbers {1,3,5}
public class GitHubClient
{
    public HttpClient Client { get; private set; }

    public GitHubClient(HttpClient httpClient)
    {
        httpClient.BaseAddress = new Uri("https://api.github.com/");
        httpClient.DefaultRequestHeaders.Add("Accept", "application/vnd.github.v3+json");
        httpClient.DefaultRequestHeaders.Add("User-Agent", "HttpClientFactory-Sample");
        Client = httpClient;
    }
}
```

ç„¶ååœ¨ `Startup.cs` ä¸­æ³¨å†Œï¼š

```cs showLineNumbers
services.AddHttpClient<GitHubClient>();
```

ä½¿ç”¨å¦‚ä¸‹ï¼š

```cs showLineNumbers {3,13}
public class ValuesController : Controller
{
    private readonly GitHubClient _gitHubClient;;

    public ValuesController(GitHubClient gitHubClient)
    {
        _gitHubClient = gitHubClient;
    }

    [HttpGet]
    public async Task<ActionResult> Get()
    {
        string result = await _gitHubClient.Client.GetStringAsync("/");
        return Ok(result);
    }
}
```

### 19.6.5 è‡ªå®šä¹‰ `Client` ç±» + æ¥å£æ–¹å¼

æˆ‘ä»¬ä¹Ÿå¯ä»¥å®šä¹‰æ¥å£ï¼Œé€šè¿‡æ¥å£çš„æä¾›å…·ä½“çš„æœåŠ¡ `API` æ“ä½œï¼Œæ— éœ€æ‰‹åŠ¨é…ç½® `Url`ï¼Œå¦‚ä¸Šé¢çš„ `GetStringAsync("/")`ã€‚

```cs showLineNumbers {1,3,6,10,18-21}
public interface IGitHubClient
{
    Task<string> GetData();
}

public class GitHubClient : IGitHubClient
{
    private readonly HttpClient _client;

    public GitHubClient(HttpClient httpClient)
    {
        httpClient.BaseAddress = new Uri("https://api.github.com/");
        httpClient.DefaultRequestHeaders.Add("Accept", "application/vnd.github.v3+json");
        httpClient.DefaultRequestHeaders.Add("User-Agent", "HttpClientFactory-Sample");
        _client = httpClient;
    }

    public async Task<string> GetData()
    {
        return await _client.GetStringAsync("/");
    }
}
```

ç„¶ååœ¨ `Startup.cs` ä¸­æ³¨å†Œï¼š

```cs showLineNumbers
services.AddHttpClient<IGitHubClient, GitHubClient>();
```

ä½¿ç”¨ï¼š

```cs showLineNumbers {3,13}
public class ValuesController : Controller
{
    private readonly IGitHubClient _gitHubClient;;

    public ValuesController(IGitHubClient gitHubClient)
    {
        _gitHubClient = gitHubClient;
    }

    [HttpGet]
    public async Task<ActionResult> Get()
    {
        string result = await _gitHubClient.GetData();
        return Ok(result);
    }
}
```

### 19.6.6 `HttpClient` è¶…æ—¶é—®é¢˜

æœ‰æ—¶å€™ä¼šé‡åˆ° `HttpClient` è¶…æ—¶é—®é¢˜å¯å°è¯•åœ¨ `Startup.cs` ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```cs showLineNumbers
AppContext.SetSwitch("System.Net.DisableIPv6",true);
```

## 19.7 `SSL/https` è¯ä¹¦é…ç½®

æœ‰æ—¶å€™æˆ‘ä»¬è¯·æ±‚è¿œç¨‹æ¥å£æ—¶ä¼šé‡åˆ° `The SSL connection could not be established, see inner exception.` è¿™æ ·çš„é”™è¯¯ï¼ŒåŸå› æ˜¯è¯ä¹¦é…ç½®ä¸æ­£ç¡®é—®é¢˜ï¼Œä¸‹é¢æœ‰å‡ ç§è§£å†³æ–¹æ³•ã€‚

### 19.7.1 ä½¿ç”¨é»˜è®¤ `SSL` è¯ä¹¦

åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œå¯ç›´æ¥ä½¿ç”¨é»˜è®¤è¯ä¹¦å³å¯è§£å†³é—®é¢˜ï¼Œå¦‚ï¼š

```cs showLineNumbers {5,7-8,13,15-16}
services.AddRemoteRequest(options=>
{
    // é»˜è®¤ HttpClient åœ¨ Furion æ¡†æ¶å†…éƒ¨å·²ç»é…ç½®äº†è¯¥æ“ä½œ
    options.AddHttpClient(string.Empty)
            .ConfigurePrimaryHttpMessageHandler(u => new HttpClientHandler
            {
                AllowAutoRedirect = true,
                UseDefaultCredentials = true
            });

    // é…ç½®ç‰¹å®šå®¢æˆ·ç«¯
    options.AddHttpClient("github", c => { /*å…¶ä»–é…ç½®*/ })
           .ConfigurePrimaryHttpMessageHandler(u => new HttpClientHandler
            {
                AllowAutoRedirect = true,
                UseDefaultCredentials = true
            });
});
```

### 19.7.2 å¿½ç•¥ç‰¹å®šå®¢æˆ·ç«¯ `SSL` è¯ä¹¦æ£€æŸ¥

```cs showLineNumbers {5,7,12,14}
services.AddRemoteRequest(options=>
{
    // é»˜è®¤ HttpClient åœ¨ Furion æ¡†æ¶å†…éƒ¨å·²ç»é…ç½®äº†è¯¥æ“ä½œ
    options.AddHttpClient(string.Empty)
            .ConfigurePrimaryHttpMessageHandler(u => new HttpClientHandler
            {
                ServerCertificateCustomValidationCallback = (_, _, _, _) => true,
            });

    // é…ç½®ç‰¹å®šå®¢æˆ·ç«¯
    options.AddHttpClient("github", c => { /*å…¶ä»–é…ç½®*/ })
           .ConfigurePrimaryHttpMessageHandler(u => new HttpClientHandler
            {
                ServerCertificateCustomValidationCallback = (_, _, _, _) => true,
            });
});
```

:::tip å…³äº `HttpClientHandler` å’Œ `SocketsHttpHandler`

åœ¨ `.NET6` ä¹‹åé»˜è®¤ä½¿ç”¨ `SocketsHttpHandler ` ä½œä¸ºé»˜è®¤åº•å±‚ç½‘ç»œé€šä¿¡ï¼Œä½†æ¯” `HttpClientHandler` æä¾›äº†æ›´å¤šå¹³å°æ— å·®å¼‚çš„åŠŸèƒ½ï¼Œå¯¹ `HttpClientHandler` çš„ä»»ä½•è®¾ç½®éƒ½ä¼šè½¬å‘åˆ° `SocketsHttpHandler` ä¸­ï¼Œå¦‚éœ€ä½¿ç”¨ `SocketsHttpHandler` é…ç½®å¯å‚è€ƒï¼š

```cs showLineNumbers {3,5-8}
// å¿½ç•¥ SSL ä¸å®‰å…¨æ£€æŸ¥ï¼Œæˆ– https ä¸å®‰å…¨æˆ– https è¯ä¹¦æœ‰è¯¯
options.AddHttpClient(string.Empty)
       .ConfigurePrimaryHttpMessageHandler(u => new SocketsHttpHandler
        {
            SslOptions = new SslClientAuthenticationOptions
            {
                RemoteCertificateValidationCallback = (sender, certificate, chain, sslPolicyErrors) => true
            }
    });
```

:::

### 19.7.3 æ‰‹åŠ¨æŒ‡å®š `SSL` è¯ä¹¦

```cs showLineNumbers {5,8-13}
services.AddRemoteRequest(options=>
{
    // é…ç½®ç‰¹å®šå®¢æˆ·ç«¯
    options.AddHttpClient("github", c => { /*å…¶ä»–é…ç½®*/ })
           .ConfigurePrimaryHttpMessageHandler(u => new HttpClientHandler
           {
                // æ‰‹åŠ¨é…ç½®è¯ä¹¦
                ClientCertificateOptions = ClientCertificateOption.Manual,
                ClientCertificates = {
                    new X509Certificate2("...","..."),
                    new X509Certificate2("...","..."),
                    new X509Certificate2("...","...")
                }
            });
});
```

### 19.7.4 å¿½ç•¥æ‰€æœ‰å®¢æˆ·ç«¯è¯ä¹¦æ£€æŸ¥

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion v3.6.6+` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

```cs showLineNumbers {1,4}
services.AddRemoteRequest(options=>
{
    // éœ€åœ¨æ‰€æœ‰å®¢æˆ·ç«¯æ³¨å†Œä¹‹å‰æ³¨å†Œ
    options.ApproveAllCerts();
});
```

## 19.8 é…ç½®å®¢æˆ·ç«¯è¯·æ±‚ä»£ç†

```cs showLineNumbers {4,8,10-11,16,18-19}
services.AddRemoteRequest(options =>
{
    // åˆ›å»º Web ä»£ç†å¯¹è±¡
    var webProxy = new WebProxy(new Uri("http://192.168.31.11:8080"), BypassOnLocal: false);

    // é»˜è®¤å®¢æˆ·ç«¯é…ç½®
    options.AddHttpClient(string.Empty)
            .ConfigurePrimaryHttpMessageHandler(u => new HttpClientHandler
            {
                Proxy = webProxy,
                UseProxy = true
            });

    // ç‰¹å®šå®¢æˆ·ç«¯é…ç½®
    options.AddHttpClient("github", c => { /*å…¶ä»–é…ç½®*/ })
           .ConfigurePrimaryHttpMessageHandler(u => new HttpClientHandler
           {
               Proxy = webProxy,
               UseProxy = true
           });
});
```

## 19.9 å…³äºè¿”å›å€¼é `200` æ—¶å¿½ç•¥ `HttpçŠ¶æ€`

`Furion` æä¾›äº†éå¸¸æ–¹ä¾¿çš„è¯·æ±‚å¹¶ä¸”åºåˆ—åŒ–è¯·æ±‚ç»“æœ `PostAsAsync<T>`
åœ¨ `2.8.8` åŠä»¥ä¸‹ç‰ˆæœ¬ï¼Œå½“è¿”å›ç»“æœçš„ `Http` çŠ¶æ€ä¸ºé `200` æ—¶ï¼Œä¼šç›´æ¥æˆªæ–­ã€‚è€ƒè™‘åˆ°è¯·æ±‚æ¥å£çš„å¤šæ ·æ€§ï¼Œåœ¨ `2.8.9` åŠä»¥ä¸Šç‰ˆæœ¬å¢åŠ å¿½ç•¥è¿”å› `Http` çŠ¶æ€ï¼Œç›´æ¥åºåˆ—åŒ–ç»“æœçš„æ–¹å¼ã€‚

```cs showLineNumbers
// è¯·æ±‚å¹¶ä¸”åºåˆ—åŒ–è¯·æ±‚ç»“æœ
var result = await "https://api.facebook.com/"
    // å¦‚æœä¸åŠ  OnExceptionï¼Œåˆ™ä¼šç›´æ¥æˆªæ–­
    .OnException((client, res, errors)=> {
        // æ¿€æ´»å¼‚æ­¥æ‹¦æˆª æ­¤å¤„å¯ä»¥åšè®°å½•æ—¥å¿—æ“ä½œ ä¹Ÿå¯ä¿æŒç°çŠ¶
    })
    .PostAsAsync<T>();
```

`PostAsStringAsync()` ä¹Ÿä½¿ç”¨åŒæ ·çš„ `OnException` æ“ä½œä½¿å¾—å¿½ç•¥è¿”å› `Http` çŠ¶æ€,åŸæ ·è¿”å› `Http` è¯·æ±‚ç»“æœ

:::important ç‰¹åˆ«è¯´æ˜

å¦‚æœä¸åŠ  `OnException`ï¼Œåˆ™ä¼šç›´æ¥æˆªæ–­ã€‚
å¦‚æœéœ€è¦å¤æ‚çš„ `Http Post` è¯·æ±‚ï¼Œå»ºè®®ç›´æ¥ä½¿ç”¨ `PostAsync`,è¿”å›å€¼ä¸º `HttpResponseMessage`ï¼Œå¯ä»¥æ›´çµæ´»çš„æ§åˆ¶ç»“æœã€‚

:::

## 19.10 å…³äºåŒæ­¥è¯·æ±‚

`Furion` æ¡†æ¶å†…éƒ¨é»˜è®¤ä¸æä¾›åŒæ­¥è¯·æ±‚æ“ä½œï¼Œå»ºè®®æ€»æ˜¯ä½¿ç”¨å¼‚æ­¥çš„æ–¹å¼è¯·æ±‚ã€‚å¦‚åœ¨ä¸èƒ½ä½¿ç”¨å¼‚æ­¥çš„æƒ…å†µä¸‹ï¼Œå¯è‡ªè¡Œè½¬æ¢ä¸ºåŒæ­¥æ‰§è¡Œã€‚å¦‚ï¼š

- å­—ç¬¦ä¸²æ‹“å±•æ–¹å¼ï¼š

```cs showLineNumbers {1,4}
var result = "https://api.facebook.com".GetAsync().GetAwaiter().GetResult();

// å¦‚æœä¸è€ƒè™‘ Task å¼‚å¸¸æ•è·ï¼Œå¯ä»¥ç›´æ¥ .Result
var result = "https://api.facebook.com".GetAsync().Result;
```

- ä»£ç†æ–¹å¼

```cs showLineNumbers {8,11}
public interface IHttp : IHttpDispatchProxy
{
    [Get("https://api.facebook.com")]
    Task<HttpResponseMessage> GetAsync();
}

// åŒæ­¥è°ƒç”¨
var result = _http.GetAsync().GetAwaiter().GetResult();

// å¦‚æœä¸è€ƒè™‘ Task å¼‚å¸¸æ•è·ï¼Œå¯ä»¥ç›´æ¥ .Result
var result = _http.GetAsync().Result;
```

## 19.11 é™æ€ `Default` æ–¹å¼æ„å»º

è¿™ç§æ–¹å¼æ¯”å­—ç¬¦ä¸²æ‹“å±•å¥½ï¼Œé¿å…äº†ç›´æ¥åœ¨å­—ç¬¦ä¸²ä¸Šæ‹“å±•ã€‚

```cs showLineNumbers
await HttpRequestPart.Default().SetRequestUrl("https://www.baidu.com").GetAsStringAsync();
```

## 19.12 å…³é—­ `Http` è¯·æ±‚æ—¥å¿—

åœ¨ `Furion` æ¡†æ¶åº•å±‚ä¸­ï¼Œ`HttpClient` å¯¹è±¡é»˜è®¤é€šè¿‡ `IHttpClientFactory` åˆ›å»ºçš„ï¼Œåªè¦å‘é€è¯·æ±‚å°±ä¼šè‡ªåŠ¨æ‰“å°æ—¥å¿—ï¼Œå¦‚ï¼š

```bash showLineNumbers {13-22}
info: 2022-10-26 11:38:16(+08:00) æ˜ŸæœŸä¸‰ L System.Logging.EventBusService[0] #1
      EventBus Hosted Service is running.
info: 2022-10-26 11:38:17(+08:00) æ˜ŸæœŸä¸‰ L Microsoft.Hosting.Lifetime[14] #1
      Now listening on: https://localhost:5001
info: 2022-10-26 11:38:17(+08:00) æ˜ŸæœŸä¸‰ L Microsoft.Hosting.Lifetime[14] #1
      Now listening on: http://localhost:5000
info: 2022-10-26 11:38:17(+08:00) æ˜ŸæœŸä¸‰ L Microsoft.Hosting.Lifetime[0] #1
      Application started. Press Ctrl+C to shut down.
info: 2022-10-26 11:38:17(+08:00) æ˜ŸæœŸä¸‰ L Microsoft.Hosting.Lifetime[0] #1
      Hosting environment: Development
info: 2022-10-26 11:38:17(+08:00) æ˜ŸæœŸä¸‰ L Microsoft.Hosting.Lifetime[0] #1
      Content root path: D:\Workplaces\OpenSources\Furion\samples\Furion.Web.Entry\
info: 2022-10-26 11:39:00(+08:00) æ˜ŸæœŸä¸‰ L System.Net.Http.HttpClient.Default.LogicalHandler[100] #8
      Start processing HTTP request GET https://www.baidu.com/
info: 2022-10-26 11:39:00(+08:00) æ˜ŸæœŸä¸‰ L System.Net.Http.HttpClient.Default.ClientHandler[100] #8
      Sending HTTP request GET https://www.baidu.com/
info: 2022-10-26 11:39:00(+08:00) æ˜ŸæœŸä¸‰ L System.Net.Http.HttpClient.Default.ClientHandler[101] #6
      Received HTTP response headers after 288.0665ms - 200
info: 2022-10-26 11:39:00(+08:00) æ˜ŸæœŸä¸‰ L System.Net.Http.HttpClient.Default.LogicalHandler[101] #6
      End processing HTTP request after 326.1497ms - 200
info: 2022-10-26 11:39:04(+08:00) æ˜ŸæœŸä¸‰ L System.Net.Http.HttpClient.Default.LogicalHandler[100] #3
      Start processing HTTP request GET https://www.baidu.com/
```

å¦‚éœ€å…³é—­åªéœ€åœ¨ `appsettings.json` å’Œ `appsettings.Development.json` ä¸­æ·»åŠ  `System.Net.Http.HttpClient` æ—¥å¿—ç±»åˆ«è¿‡æ»¤å³å¯ï¼Œå¦‚ï¼š

```json showLineNumbers {2,7}
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Information",
      "System.Net.Http.HttpClient": "Warning"
    }
  }
}
```

## 19.13 è·å– `Cookies`

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.7.4 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

- å­—ç¬¦ä¸²æ–¹å¼

```cs showLineNumbers {2}
var response = await "http://furion.baiqian.ltd/".GetAsync();
var cookies = response.GetCookies();
```

- ä»£ç†æ–¹å¼

```cs showLineNumbers {4,8}
public interface IHttp : IHttpDispatchProxy
{
    [Get("http://furion.baiqian.ltd/")]
    Task<HttpResponseMessage> GetAsync();
}

var response = await _http.GetAsync();
var cookies = response.GetCookies();
```

:::important é‡å¤ `Key` å¤„ç†

**ç”±äº `Cookies` æ˜¯æ”¯æŒé‡å¤ `Key` çš„ï¼Œæ‰€ä»¥é€šè¿‡ç´¢å¼•æ–¹å¼å¦‚ `cookies[key]` ä¼šæŠ›å‡ºå¼‚å¸¸**ï¼Œè¿™æ—¶å¯ä»¥é€šè¿‡ `.Lookup()` è¿›è¡Œåˆ†ç»„å¤„ç†ç„¶åè¿”å›æ–°çš„å­—å…¸é›†åˆï¼Œå¦‚ï¼š

```cs showLineNumbers {1-2,4}
var dicCookies = cookies.ToLookup(u => u.Key, u => u.Value)
                        .ToDictionary(u => u.Key, u => u.First()); // å–é‡å¤ç¬¬ä¸€ä¸ª .First();

var cookie1 = dicCookies["key"];
```

:::

## 19.14 åœ¨ `WinForm/WPF` ä¸­ä½¿ç”¨

è¿œç¨‹è¯·æ±‚å¯åœ¨ `WinForm/WPF` ä¸­ä½¿ç”¨ï¼Œåªéœ€è¦å°†æ–¹æ³•/äº‹ä»¶æ ‡è®°ä¸º `async` å³å¯ã€‚

```cs showLineNumbers {1,3}
private async void button1_Click(object sender, EventArgs e)
{
    var result = await "http://furion.baiqian.ltd".GetAsStringAsync();
}
```

## 19.15 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::

---

:::note äº†è§£æ›´å¤š

æƒ³äº†è§£æ›´å¤š `HttpClient` çŸ¥è¯†å¯æŸ¥é˜… [ASP.NET Core - HTTP è¯·æ±‚](https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/http-requests?view=aspnetcore-5.0) ç« èŠ‚

:::
