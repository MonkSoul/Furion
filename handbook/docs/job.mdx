---
id: job
title: 26.1 è°ƒåº¦ä½œä¸š
sidebar_label: 26.1 è°ƒåº¦ä½œä¸š
---

import Tag from "@site/src/components/Tag.js";

<details>
  <summary>ğŸ“ æ¨¡å—æ›´æ–°æ—¥å¿—</summary>
  <div>
<div>

- **æ–°ç‰¹æ€§**

  - &nbsp;<Tag>æ–°å¢</Tag> å®šæ—¶ä»»åŠ¡ `Dashboard` æŸ¥çœ‹ä½œä¸šè§¦å‘å™¨æœ€è¿‘è¿è¡Œè®°å½•åŠŸèƒ½ <sup>4.8.4.3</sup> <sup>â±ï¸2023.01.03</sup> [e7d24d8](https://gitee.com/dotnetchina/Furion/commit/e7d24d84bcc448b0a13f8e0b76328669261af44b)
  - &nbsp;<Tag>æ–°å¢</Tag> å®šæ—¶ä»»åŠ¡ä½œä¸šè§¦å‘å™¨ `trigger.GetTimelines()` è·å–æœ€è¿‘ `10` æ¡è¿è¡Œè®°å½•åˆ—è¡¨ <sup>4.8.4.3</sup> <sup>â±ï¸2023.01.03</sup> [e7d24d8](https://gitee.com/dotnetchina/Furion/commit/e7d24d84bcc448b0a13f8e0b76328669261af44b)
  - &nbsp;<Tag>æ–°å¢</Tag> **å®šæ—¶ä»»åŠ¡ `Dashboard` çœ‹æ¿** <sup>4.8.4</sup> <sup>â±ï¸2022.12.30</sup> [d3f9669](https://gitee.com/dotnetchina/Furion/commit/d3f966921dfa757c12c2bd071fb19fc166a2f24e)
  - &nbsp;<Tag>æ–°å¢</Tag> å®šæ—¶ä»»åŠ¡ `IScheduler.GetEnumerable()` æ–¹æ³•ï¼Œå¯å°†ä½œä¸šè®¡åˆ’è½¬æ¢æˆå¯æšä¸¾å­—å…¸ <sup>4.8.4</sup> <sup>â±ï¸2022.12.30</sup> [4d5235c](https://gitee.com/dotnetchina/Furion/commit/4d5235c37a9ef5e66e92847e65ef9786bcd7387c)
  - &nbsp;<Tag>æ–°å¢</Tag> å®šæ—¶ä»»åŠ¡é…ç½®é€‰é¡¹ `options.JobDetail.LogEnabled` é…ç½®ï¼Œå¯è‡ªåŠ¨è¾“å‡ºæ‰§è¡Œæ—¥å¿— <sup>4.8.3.7</sup> <sup>â±ï¸2022.12.14</sup> [58d2c20](https://gitee.com/dotnetchina/Furion/commit/58d2c20de05dc458b206863f7814e89866e7522b)
  - &nbsp;<Tag>æ–°å¢</Tag> **å®šæ—¶ä»»åŠ¡ `IScheduler` å¯¹è±¡æ¯æ¬¡æ“ä½œåè‡ªåŠ¨åˆ·æ–°å’Œæä¾›æ‰‹åŠ¨åˆ·æ–° `Reload()` æ–¹æ³•** <sup>4.8.3.3</sup> <sup>â±ï¸2022.12.09</sup> [#I65EQ1](https://gitee.com/dotnetchina/Furion/issues/I65EQ1#note_15047484_link)
  - &nbsp;<Tag>æ–°å¢</Tag> å®šæ—¶ä»»åŠ¡é—´éš”åˆ†é’Ÿä½œä¸šè§¦å‘å™¨ `Triggers.PeriodMinutes(5)` å’Œ `[PeriodMinutes(5)]` ç‰¹æ€§ <sup>4.8.2.8</sup> <sup>â±ï¸2022.12.01</sup> [8e1f06f](https://gitee.com/dotnetchina/Furion/commit/8e1f06fa2161ee2bf8bcea29af8aaa5a60ef9db9)
  - &nbsp;<Tag>æ–°å¢</Tag> å®šæ—¶ä»»åŠ¡å·¥ä½œæ—¥ä½œä¸šè§¦å‘å™¨ `Triggers.Workday()` å’Œ `[Workday]` ç‰¹æ€§ <sup>4.8.2.6</sup> <sup>â±ï¸2022.11.30</sup> [28b2d20](https://gitee.com/dotnetchina/Furion/commit/28b2d20b3f6034a4cdf5827576c34412315fbb15)
  - &nbsp;<Tag>æ–°å¢</Tag> å®šæ—¶ä»»åŠ¡ä½œä¸šæ ¡å¯¹åŠŸèƒ½ï¼Œå¯å¯¹è¯¯å·®è¿›è¡Œæ ¡æ­£ <sup>4.8.2.6</sup> <sup>â±ï¸2022.11.30</sup> [f725a25](https://gitee.com/dotnetchina/Furion/commit/f725a252e6a89f9dea6489d4e54452077b1935e5)
  - &nbsp;<Tag>æ–°å¢</Tag> **å®šæ—¶ä»»åŠ¡ `Triggers` æ‰€æœ‰å¸¦ `At` çš„ `Cron` è¡¨è¾¾å¼è§¦å‘å™¨æ„å»ºå™¨åŠç‰¹æ€§** <sup>4.8.2.5</sup> <sup>â±ï¸2022.11.29</sup> [#I63PLR](https://gitee.com/dotnetchina/Sundial/issues/I63PLR)
  - &nbsp;<Tag>æ–°å¢</Tag> å®šæ—¶ä»»åŠ¡æ‰¹é‡æ·»åŠ  `SchedulerBuilder` ä½œä¸šåŠŸèƒ½ <sup>4.8.2.4</sup> <sup>â±ï¸2022.11.29</sup> [5faa67b](https://gitee.com/dotnetchina/Furion/commit/5faa67b7817459cb0ee0add86a6e53c17ff51a05)
  - &nbsp;<Tag>æ–°å¢</Tag> å®šæ—¶ä»»åŠ¡ `BuildSqlType` é…ç½®ï¼Œå¯è®¾ç½®ç”Ÿæˆä¸åŒæ•°æ®åº“ç±»å‹çš„ `SQL` è¯­å¥ <sup>4.8.2.3</sup> <sup>â±ï¸2022.11.29</sup> [293f9bc](https://gitee.com/dotnetchina/Furion/commit/293f9bce34fc4f70eacae1043ed697d31da88409) [!675](https://gitee.com/dotnetchina/Furion/pulls/675)
  - &nbsp;<Tag>æ–°å¢</Tag> `JobDetail` å’Œ `Trigger` è‡ªå®šä¹‰ `ConvertToSQL` è¾“å‡º `SQL` é…ç½® <sup>4.8.2</sup> <sup>â±ï¸2022.11.27</sup> [0bb9d8f](https://gitee.com/dotnetchina/Furion/commit/0bb9d8f1f3606af145b44c2984b87fdc020f02e1)
  - &nbsp;<Tag>æ–°å¢</Tag> **ä½œä¸šè§¦å‘å™¨ `ResetOnlyOnce` å±æ€§ï¼Œæ”¯æŒåªè¿è¡Œä¸€æ¬¡çš„ä½œä¸šé‡æ–°å¯åŠ¨æœåŠ¡é‡å¤æ‰§è¡Œ** <sup>4.8.1.5</sup> <sup>â±ï¸2022.11.25</sup> [a8be728](https://gitee.com/dotnetchina/Furion/commit/a8be728eac986ebc5f44718b08c67aaee8b89dc6)
  - &nbsp;<Tag>æ–°å¢</Tag> åŠ¨æ€ä½œä¸šå¤„ç†ç¨‹åºå§”æ‰˜æ”¯æŒ <sup>4.8.1.8</sup> <sup>â±ï¸2022.11.27</sup> [e02266c](https://gitee.com/dotnetchina/Furion/commit/e02266c44187dbc2b416abe1ca4112ce13c89180)

- **çªç ´æ€§å˜åŒ–**

  - &nbsp;<Tag>è°ƒæ•´</Tag> **å®šæ—¶ä»»åŠ¡åº•å±‚æ‰€æœ‰ä»£ç ï¼Œæ—¥å¿—ï¼Œæ³¨é‡Šï¼Œæ–‡æ¡£** <sup>4.8.1.10</sup> <sup>â±ï¸2022.12.05</sup>

- **é—®é¢˜ä¿®å¤**

  - &nbsp;<Tag>ä¿®å¤</Tag> å®šæ—¶ä»»åŠ¡åœæ­¢ä½œä¸šè§¦å‘å™¨åè¿è¡Œè®°å½•ä¸èƒ½å†™å…¥æœ€æ–°è®°å½•é—®é¢˜ <sup>4.8.4.8</sup> <sup>â±ï¸2023.01.05</sup> [d4c553f](https://gitee.com/dotnetchina/Furion/commit/d4c553fb9b0037ab29942ccc2a25a386fc28c1db)
  - &nbsp;<Tag>ä¿®å¤</Tag> å®šæ—¶ä»»åŠ¡ä½¿ç”¨ `Furion.Pure` åŒ…è®¿é—® `Dashboard` å‡ºç° `404` é—®é¢˜ <sup>4.8.4.2</sup> <sup>â±ï¸2023.01.02</sup> [21977b7](https://gitee.com/dotnetchina/Furion/commit/21977b70ef84fd674bb306ab86ef032f7f28c7a7)
  - &nbsp;<Tag>ä¿®å¤</Tag> å®šæ—¶ä»»åŠ¡é€šè¿‡ `scheduler.RemoveTrigger(triggerId)` æŠ¥å¼‚å¸¸é—®é¢˜ <sup>4.8.3.3</sup> <sup>â±ï¸2022.12.09</sup> [#I65EQ1](https://gitee.com/dotnetchina/Furion/issues/I65EQ1#note_15047484_link)
  - &nbsp;<Tag>ä¿®å¤</Tag> å®šæ—¶ä»»åŠ¡ä½œä¸šè§¦å‘å™¨é…ç½®äº† `EndTime` å’Œ `StartTime` ä¹‹å `Status` æ²¡æœ‰å¯¹åº”ä¸Š <sup>4.8.3.1</sup> <sup>â±ï¸2022.12.09</sup> [52a5506](https://gitee.com/dotnetchina/Furion/commit/52a5506c2fda7c31df01b2e90af7ad6b0c5f94aa)
  - &nbsp;<Tag>ä¿®å¤</Tag> å®šæ—¶ä»»åŠ¡é€šè¿‡ `scheduler.AddTrigger(triggerBuilder)` æ— æ•ˆçš„é—®é¢˜ <sup>4.8.3.1</sup> <sup>â±ï¸2022.12.09</sup> [#I65EQ1](https://gitee.com/dotnetchina/Furion/issues/I65EQ1)
  - &nbsp;<Tag>ä¿®å¤</Tag> ä½œä¸šæ‹¥æœ‰å¤šä¸ªè§¦å‘å™¨æ—¶æš‚åœä½œä¸šåä¾ç„¶å­˜åœ¨ä¸ªåˆ«æœªæš‚åœçš„æ¸…ç©ºï¼ˆå¹¶å‘é—®é¢˜ï¼‰ <sup>4.8.2.12</sup> <sup>â±ï¸2022.12.07</sup> [#I655W9](https://gitee.com/dotnetchina/Furion/issues/I655W9)
  - &nbsp;<Tag>ä¿®å¤</Tag> ä½œä¸šè§¦å‘å™¨ä¸ç¬¦åˆä¸‹ä¸€æ¬¡æ‰§è¡Œè§„å¾‹ä½† `NextRunTime` ä¸ä¸º `null` æƒ…å†µ <sup>4.8.1.5</sup> <sup>â±ï¸2022.11.25</sup> [a8be728](https://gitee.com/dotnetchina/Furion/commit/a8be728eac986ebc5f44718b08c67aaee8b89dc6)
  - &nbsp;<Tag>ä¿®å¤</Tag> è¿è¡Œæ—¶å¯åŠ¨/æš‚åœä½œä¸šæ— æ•ˆé—®é¢˜ <sup>4.8.1.6</sup> <sup>â±ï¸2022.11.25</sup> [#I6368M](https://gitee.com/dotnetchina/Furion/issues/I6368M)
  - &nbsp;<Tag>ä¿®å¤</Tag> å®šæ—¶ä»»åŠ¡ç”Ÿæˆçš„ `SQL` è¯­å¥ä¸æ”¯æŒ `MySQL` é—®é¢˜ <sup>4.8.1.7</sup> <sup>â±ï¸2022.11.26</sup> [#I638ZC](https://gitee.com/dotnetchina/Furion/issues/I638ZC)

- **å…¶ä»–æ›´æ”¹**

  - &nbsp;<Tag>è°ƒæ•´</Tag> å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨æ—¶é—´ç²¾åº¦ï¼Œæ§åˆ¶æŒç»­æ‰§è¡Œä¸€å¹´è¯¯å·®åœ¨ `100ms` ä»¥å†… <sup>4.8.2.9</sup> <sup>â±ï¸2022.12.01</sup> [334d089](https://gitee.com/dotnetchina/Furion/commit/334d08989503bacd8bf2abb2cc87cf2031dc9da6)
  - &nbsp;<Tag>è°ƒæ•´</Tag> å®šæ—¶ä»»åŠ¡ä½œä¸šè®¡åˆ’å·¥å‚ `GetNextRunJobs()` æ–¹æ³•é€»è¾‘ <sup>4.8.2.7</sup> <sup>â±ï¸2022.11.30</sup> [#I63VS2](https://gitee.com/dotnetchina/Furion/issues/I63VS2)

- **æ–‡æ¡£**

  - &nbsp;<Tag>æ–°å¢</Tag> ä½œä¸šæ‰§è¡Œå™¨å®ç°è¶…æ—¶æ–‡æ¡£ <sup>4.8.3.8</sup> <sup>â±ï¸2022.12.20</sup>
  - &nbsp;<Tag>æ–°å¢</Tag> ä½œä¸šè§¦å‘å™¨ `ResetOnlyOnce` æ–‡æ¡£ <sup>4.8.1.5</sup> <sup>â±ï¸2022.11.25</sup> [a8be728](https://gitee.com/dotnetchina/Furion/commit/a8be728eac986ebc5f44718b08c67aaee8b89dc6)
  - &nbsp;<Tag>æ–°å¢</Tag> **é€šè¿‡ `Roslyn` åŠ¨æ€ç¼–è¯‘ä»£ç åˆ›å»º `IJob` ç±»å‹æ–‡æ¡£** <sup>4.8.1.5</sup> <sup>â±ï¸2022.11.25</sup> [2c5e5be](https://gitee.com/dotnetchina/Furion/commit/2c5e5befc7a335d6ef0e75eea0061aee1e4dd061)
  - &nbsp;<Tag>æ–°å¢</Tag> è‡ªå®šä¹‰ `JobDetail` å’Œ `Trigger` è¾“å‡º `SQL` æ–‡æ¡£ <sup>4.8.2</sup> <sup>â±ï¸2022.11.27</sup> [0bb9d8f](https://gitee.com/dotnetchina/Furion/commit/0bb9d8f1f3606af145b44c2984b87fdc020f02e1)

</div>
  </div>
</details>

:::warning 4.8.0 ä»¥ä¸‹ç‰ˆæœ¬è¯´æ˜

**åœ¨ `Furion 4.8.0+` ç‰ˆæœ¬é‡‡ç”¨ [Sundial](https://gitee.com/dotnetchina/Sundial) å®šæ—¶ä»»åŠ¡æ›¿æ¢åŸæœ‰çš„ `TaskScheduler`**ï¼Œ[æŸ¥çœ‹æ—§æ–‡æ¡£](/docs/job-old)

:::

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.0 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

import useBaseUrl from "@docusaurus/useBaseUrl";
import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

## 26.1.1 å…³äºè°ƒåº¦ä½œä¸š

è°ƒåº¦ä½œä¸šåˆç§°å®šæ—¶ä»»åŠ¡ï¼Œé¡¾åæ€ä¹‰ï¼Œå®šæ—¶ä»»åŠ¡å°±æ˜¯åœ¨ç‰¹å®šçš„æ—¶é—´æˆ–ç¬¦åˆæŸç§æ—¶é—´è§„å¾‹è‡ªåŠ¨è§¦å‘å¹¶æ‰§è¡Œä»»åŠ¡ã€‚

<img src={useBaseUrl("img/scdr.png")} />

### 26.1.1.1 ä½¿ç”¨åœºæ™¯

å®šæ—¶ä»»åŠ¡çš„åº”ç”¨åœºæ™¯éå¸¸å¹¿ï¼Œå‡ ä¹æ˜¯æ¯ä¸€ä¸ªè½¯ä»¶ç³»ç»Ÿå¿…å¤‡åŠŸèƒ½ï¼š

- å«ä½ èµ·åºŠçš„é—¹é’Ÿ
- æ—¥å†æ—¥ç¨‹æé†’
- ç”Ÿæ—¥çºªå¿µæ—¥æé†’
- å®šæ—¶å¤‡ä»½æ•°æ®åº“
- å®šæ—¶æ¸…ç†åƒåœ¾æ•°æ®
- å®šæ—¶å‘é€è¥é”€ä¿¡æ¯ï¼Œé‚®ä»¶
- å®šæ—¶ä¸Šçº¿äº§å“ï¼Œæ¯”å¦‚é¢„å”®äº§å“ï¼ŒåŒåä¸€æ´»åŠ¨
- å®šæ—¶å‘é€ä¼˜æƒ åˆ¸
- å®šæ—¶å‘å¸ƒï¼Œå®ç° Devops åŠŸèƒ½ï¼Œå¦‚ Jenkins
- å®šæ—¶çˆ¬è™«æŠ“æ•°æ®
- å®šæ—¶å¯¼å‡ºæŠ¥è¡¨ï¼Œå†å²ç»Ÿè®¡ï¼Œè€ƒå‹¤ç»Ÿè®¡
- ...

## 26.1.2 å¿«é€Ÿå…¥é—¨

1. å®šä¹‰ä½œä¸šå¤„ç†ç¨‹åº `MyJob`ï¼š

```cs showLineNumbers {1,9,11}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation($"{context}");
        return Task.CompletedTask;
    }
}
```

2. åœ¨ `Startup.cs` æ³¨å†Œ `Schedule` æœåŠ¡ï¼š

```cs showLineNumbers {1,3-4}
services.AddSchedule(options =>
{
    // æ³¨å†Œä½œä¸šï¼Œå¹¶é…ç½®ä½œä¸šè§¦å‘å™¨
    options.AddJob<MyJob>(Triggers.Secondly()); // è¡¨ç¤ºæ¯ç§’æ‰§è¡Œ
});
```

3. æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœ

```bash showLineNumbers {6,8,10,12,14,16,18}
info: 2022-12-02 16:51:33.5032989 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      Schedule hosted service is running.
info: 2022-12-02 16:51:33.5180669 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      Schedule hosted service is preloading...
info: 2022-12-02 16:51:34.1452041 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      The <job1_trigger1> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-02 16:51:34.1541701 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      The scheduler of <job1> successfully appended to the schedule.
warn: 2022-12-02 16:51:34.1748401 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      Schedule hosted service preload completed, and a total of <1> schedulers are appended.
info: 2022-12-02 16:51:35.0712571 +08:00 æ˜ŸæœŸäº” L MyJob[0] #4
      <job1> [C] <job1 job1_trigger1> * * * * * * 1ts 2022-12-02 16:51:35.000 -> 2022-12-02 16:51:36.000
info: 2022-12-02 16:51:36.0317375 +08:00 æ˜ŸæœŸäº” L MyJob[0] #14
      <job1> [C] <job1 job1_trigger1> * * * * * * 2ts 2022-12-02 16:51:36.000 -> 2022-12-02 16:51:37.000
info: 2022-12-02 16:51:37.0125007 +08:00 æ˜ŸæœŸäº” L MyJob[0] #9
      <job1> [C] <job1 job1_trigger1> * * * * * * 3ts 2022-12-02 16:51:37.000 -> 2022-12-02 16:51:38.000
info: 2022-12-02 16:51:38.0179920 +08:00 æ˜ŸæœŸäº” L MyJob[0] #8
      <job1> [C] <job1 job1_trigger1> * * * * * * 4ts 2022-12-02 16:51:38.000 -> 2022-12-02 16:51:39.000
```

`JobExecutionContext` é‡å†™äº† `ToString()` æ–¹æ³•å¹¶æä¾›ä»¥ä¸‹å‡ ç§æ ¼å¼ï¼š

```bash showLineNumbers {2,5}
# æŒç»­è¿è¡Œæ ¼å¼
<ä½œä¸šId> ä½œä¸šæè¿° [å¹¶è¡ŒC/ä¸²è¡ŒS] <ä½œä¸šId è§¦å‘å™¨Id> è§¦å‘å™¨å­—ç¬¦ä¸² è§¦å‘å™¨æè¿° è§¦å‘æ¬¡æ•°ts è§¦å‘æ—¶é—´ -> ä¸‹ä¸€æ¬¡è§¦å‘æ—¶é—´

# è§¦å‘åœæ­¢æ ¼å¼
<ä½œä¸šId> ä½œä¸šæè¿° [å¹¶è¡ŒC/ä¸²è¡ŒS] <ä½œä¸šId è§¦å‘å™¨Id> è§¦å‘å™¨å­—ç¬¦ä¸² è§¦å‘å™¨æè¿° è§¦å‘æ¬¡æ•°ts è§¦å‘æ—¶é—´ [è§¦å‘å™¨ç»ˆæ­¢çŠ¶æ€]
```

### 26.1.2.1 æŒ‡å®šä½œä¸š `Id`

é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸æŒ‡å®šä½œä¸š `Id` ä¼šè‡ªåŠ¨ç”Ÿæˆ `job[ç¼–å·]`ã€‚

```cs showLineNumbers {3}
services.AddSchedule(options =>
{
    options.AddJob<MyJob>("myjob", Triggers.Secondly());
});
```

æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœï¼š

```bash showLineNumbers {6,8,12,14,16}
info: 2022-12-02 17:15:43.3024818 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      Schedule hosted service is running.
info: 2022-12-02 17:15:43.3107918 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      Schedule hosted service is preloading...
info: 2022-12-02 17:15:43.9498664 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      The <myjob_trigger1> trigger for scheduler of <myjob> successfully appended to the schedule.
info: 2022-12-02 17:15:43.9532894 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      The scheduler of <myjob> successfully appended to the schedule.
warn: 2022-12-02 17:15:43.9941565 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      Schedule hosted service preload completed, and a total of <1> schedulers are appended.
info: 2022-12-02 17:15:44.1230353 +08:00 æ˜ŸæœŸäº” L MyJob[0] #6
      <myjob> [C] <myjob myjob_trigger1> * * * * * * 1ts 2022-12-02 17:15:44.000 -> 2022-12-02 17:15:45.000
info: 2022-12-02 17:15:45.0854893 +08:00 æ˜ŸæœŸäº” L MyJob[0] #9
      <myjob> [C] <myjob myjob_trigger1> * * * * * * 2ts 2022-12-02 17:15:45.000 -> 2022-12-02 17:15:46.000
info: 2022-12-02 17:15:46.0100813 +08:00 æ˜ŸæœŸäº” L MyJob[0] #13
      <myjob> [C] <myjob myjob_trigger1> * * * * * * 3ts 2022-12-02 17:15:46.000 -> 2022-12-02 17:15:47.000
```

### 26.1.2.2 å¤šä¸ªä½œä¸šè§¦å‘å™¨

æœ‰æ—¶å€™ï¼Œä¸€ä¸ªä½œä¸šæ”¯æŒå¤šç§è§¦å‘æ—¶é—´ï¼Œæ¯”å¦‚ `æ¯åˆ†é’Ÿ` æ‰§è¡Œä¸€æ¬¡ï¼Œæ¯ `5ç§’` æ‰§è¡Œä¸€æ¬¡ï¼Œæ¯åˆ†é’Ÿç¬¬ `3/7/8ç§’` æ‰§è¡Œä¸€æ¬¡ã€‚

```cs showLineNumbers {3-5}
services.AddSchedule(options =>
{
    options.AddJob<MyJob>(Triggers.Minutely()   // æ¯åˆ†é’Ÿå¼€å§‹
     , Triggers.Period(5000)   // æ¯ 5 ç§’ï¼Œè¿˜æ”¯æŒ Triggers.PeriodSeconds(5)ï¼ŒTriggers.PeriodMinutes(5)ï¼ŒTriggers.PeriodHours(5)
     , Triggers.Cron("3,7,8 * * * * ?", CronStringFormat.WithSeconds));  // æ¯åˆ†é’Ÿç¬¬ 3/7/8 ç§’
});
```

æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœï¼š

```cs showLineNumbers {6,8,10,12,16,18,20,24,26}
info: 2022-12-02 17:18:53.3593518 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      Schedule hosted service is running.
info: 2022-12-02 17:18:53.3663583 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      Schedule hosted service is preloading...
info: 2022-12-02 17:18:54.0381456 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      The <job1_trigger1> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-02 17:18:54.0708796 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      The <job1_trigger2> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-02 17:18:54.0770193 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      The <job1_trigger3> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-02 17:18:54.0800017 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      The scheduler of <job1> successfully appended to the schedule.
warn: 2022-12-02 17:18:54.1206816 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      Schedule hosted service preload completed, and a total of <1> schedulers are appended.
info: 2022-12-02 17:18:59.0040452 +08:00 æ˜ŸæœŸäº” L MyJob[0] #9
      <job1> [C] <job1 job1_trigger2> 5000ms 1ts 2022-12-02 17:18:58.927 -> 2022-12-02 17:19:03.944
info: 2022-12-02 17:19:00.0440142 +08:00 æ˜ŸæœŸäº” L MyJob[0] #15
      <job1> [C] <job1 job1_trigger1> * * * * * 1ts 2022-12-02 17:19:00.000 -> 2022-12-02 17:20:00.000
info: 2022-12-02 17:19:03.0149075 +08:00 æ˜ŸæœŸäº” L MyJob[0] #6
      <job1> [C] <job1 job1_trigger3> 3,7,8 * * * * ? 1ts 2022-12-02 17:19:03.000 -> 2022-12-02 17:19:07.000
info: 2022-12-02 17:19:03.9519350 +08:00 æ˜ŸæœŸäº” L MyJob[0] #15
      <job1> [C] <job1 job1_trigger2> 5000ms 2ts 2022-12-02 17:19:03.944 -> 2022-12-02 17:19:08.919
info: 2022-12-02 17:19:07.0116797 +08:00 æ˜ŸæœŸäº” L MyJob[0] #4
      <job1> [C] <job1 job1_trigger3> 3,7,8 * * * * ? 2ts 2022-12-02 17:19:07.000 -> 2022-12-02 17:19:08.000
info: 2022-12-02 17:19:08.0078132 +08:00 æ˜ŸæœŸäº” L MyJob[0] #15
      <job1> [C] <job1 job1_trigger3> 3,7,8 * * * * ? 3ts 2022-12-02 17:19:08.000 -> 2022-12-02 17:20:03.000
info: 2022-12-02 17:19:08.9298393 +08:00 æ˜ŸæœŸäº” L MyJob[0] #14
      <job1> [C] <job1 job1_trigger2> 5000ms 3ts 2022-12-02 17:19:08.919 -> 2022-12-02 17:19:13.897
info: 2022-12-02 17:19:13.9056247 +08:00 æ˜ŸæœŸäº” L MyJob[0] #8
      <job1> [C] <job1 job1_trigger2> 5000ms 4ts 2022-12-02 17:19:13.897 -> 2022-12-02 17:19:18.872
info: 2022-12-02 17:19:18.8791123 +08:00 æ˜ŸæœŸäº” L MyJob[0] #12
      <job1> [C] <job1 job1_trigger2> 5000ms 5ts 2022-12-02 17:19:18.872 -> 2022-12-02 17:19:23.846
```

### 26.1.2.3 `ä¸²è¡Œ` æ‰§è¡Œ

é»˜è®¤æƒ…å†µä¸‹ï¼Œä½œä¸šé‡‡ç”¨ `å¹¶è¡Œ` æ‰§è¡Œæ–¹å¼ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šç­‰å¾…ä¸Šä¸€æ¬¡ä½œä¸šæ‰§è¡Œå®Œæˆï¼Œåªè¦è§¦å‘æ—¶é—´åˆ°äº†å°±è‡ªåŠ¨æ‰§è¡Œï¼Œä½†ä¸€äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½å¸Œæœ›ç­‰å¾…ä¸Šä¸€æ¬¡ä½œä¸šå®Œæˆå†æ‰§è¡Œï¼Œå¦‚ï¼š

```cs showLineNumbers {3}
services.AddSchedule(options =>
{
    options.AddJob<MyJob>(concurrent: false, Triggers.Secondly()); // ä¸²è¡Œï¼Œæ¯ç§’æ‰§è¡Œ
});
```

```cs showLineNumbers {12}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation($"{context.JobId} {context.TriggerId} {context.OccurrenceTime} {context.Trigger}");
        await Task.Delay(2000, stoppingToken); // è¿™é‡Œæ¨¡æ‹Ÿè€—æ—¶æ“ä½œï¼Œæ¯”å¦‚è€—æ—¶2ç§’
    }
}
```

æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœï¼š

```cs showLineNumbers {6,8,12,14,16,18,20}
info: 2022-12-02 17:23:27.3726863 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      Schedule hosted service is running.
info: 2022-12-02 17:23:27.3830366 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      Schedule hosted service is preloading...
info: 2022-12-02 17:23:27.9083148 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      The <job1_trigger1> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-02 17:23:27.9184699 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      The scheduler of <job1> successfully appended to the schedule.
warn: 2022-12-02 17:23:27.9740028 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      Schedule hosted service preload completed, and a total of <1> schedulers are appended.
info: 2022-12-02 17:23:28.0638789 +08:00 æ˜ŸæœŸäº” L MyJob[0] #9
      <job1> [S] <job1 job1_trigger1> * * * * * * 1ts 2022-12-02 17:23:28.000 -> 2022-12-02 17:23:29.000
warn: 2022-12-02 17:23:29.1119269 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #9
      12/02/2022 17:23:29: The <job1_trigger1> trigger of job <job1> failed to execute as scheduled due to blocking.
warn: 2022-12-02 17:23:30.0090551 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #9
      12/02/2022 17:23:30: The <job1_trigger1> trigger of job <job1> failed to execute as scheduled due to blocking.
info: 2022-12-02 17:23:31.0121694 +08:00 æ˜ŸæœŸäº” L MyJob[0] #9
      <job1> [S] <job1 job1_trigger1> * * * * * * 2ts 2022-12-02 17:23:31.000 -> 2022-12-02 17:23:32.000
warn: 2022-12-02 17:23:32.0243646 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #9
      12/02/2022 17:23:32: The <job1_trigger1> trigger of job <job1> failed to execute as scheduled due to blocking.
```

:::caution `ä¸²è¡Œ` æ‰§è¡Œè§„åˆ™è¯´æ˜

`ä¸²è¡Œ` æ‰§è¡Œå¦‚æœé‡åˆ°ä¸Šä¸€æ¬¡ä½œä¸šè¿˜æœªå®Œæˆé‚£ä¹ˆå®ƒä¼šç­‰åˆ°ä¸‹ä¸€æ¬¡è§¦å‘æ—¶é—´åˆ°äº†å†æ‰§è¡Œï¼Œä»¥æ­¤é‡å¤ã€‚

:::

é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ `ä¸²è¡Œ` æ‰§è¡Œä½†å› ä¸ºè€—æ—¶å¯¼è‡´**è§¦å‘æ—¶é—´åˆ°äº†ä½†å®é™…æœªèƒ½æ‰§è¡Œ**ä¼šé»˜è®¤è¾“å‡º `warn` è­¦å‘Šæ—¥å¿—ï¼Œå¦‚éœ€å…³é—­åªéœ€è¦ï¼š

```cs showLineNumbers {3}
services.AddSchedule(options =>
{
    options.LogEnabled = false;
    options.AddJob<MyJob>(concurrent: false, Triggers.Secondly()); // æ¯ç§’æ‰§è¡Œ
});
```

æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœï¼š

```bash showLineNumbers {2,4,6,8,10}
info: 2022-12-02 17:27:13.1136450 +08:00 æ˜ŸæœŸäº” L MyJob[0] #12
      <job1> [S] <job1 job1_trigger1> * * * * * * 1ts 2022-12-02 17:27:13.000 -> 2022-12-02 17:27:14.000
info: 2022-12-02 17:27:16.0092433 +08:00 æ˜ŸæœŸäº” L MyJob[0] #8
      <job1> [S] <job1 job1_trigger1> * * * * * * 2ts 2022-12-02 17:27:16.000 -> 2022-12-02 17:27:17.000
info: 2022-12-02 17:27:19.0092363 +08:00 æ˜ŸæœŸäº” L MyJob[0] #6
      <job1> [S] <job1 job1_trigger1> * * * * * * 3ts 2022-12-02 17:27:19.000 -> 2022-12-02 17:27:20.000
info: 2022-12-02 17:27:22.0183594 +08:00 æ˜ŸæœŸäº” L MyJob[0] #9
      <job1> [S] <job1 job1_trigger1> * * * * * * 4ts 2022-12-02 17:27:22.000 -> 2022-12-02 17:27:23.000
info: 2022-12-02 17:27:25.0152323 +08:00 æ˜ŸæœŸäº” L MyJob[0] #4
      <job1> [S] <job1 job1_trigger1> * * * * * * 5ts 2022-12-02 17:27:25.000 -> 2022-12-02 17:27:26.000
```

### 26.1.2.4 æ‰“å°ä½œä¸šå®Œæ•´ä¿¡æ¯

æ¡†æ¶æä¾›äº†å››ç§æ–¹å¼æ‰“å°ä½œä¸šå®Œæ•´ä¿¡æ¯ã€‚

- **ç¬¬ä¸€ç§ï¼šè¾“å‡ºå®Œæ•´çš„ä½œä¸š `JSON` ä¿¡æ¯ï¼š`context.ConvertToJSON()`**

```cs showLineNumbers {11}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation(context.ConvertToJSON());
        await Task.CompletedTask;
    }
}
```

æŸ¥çœ‹ä½œä¸šæ‰“å°ç»“æœï¼š

```json showLineNumbers {3,14}
info: 2022-12-02 18:00:59.4140802 +08:00 æ˜ŸæœŸäº” L MyJob[0] #13
      {
        "jobDetail": {
        "jobId": "job1",
        "groupName": null,
        "jobType": "MyJob",
        "assemblyName": "ConsoleApp32",
        "description": null,
        "concurrent": true,
        "includeAnnotations": false,
        "properties": "{}",
        "updatedTime": "2022-12-02 18:00:59.390"
      },
        "trigger": {
        "triggerId": "job1_trigger1",
        "jobId": "job1",
        "triggerType": "Furion.Schedule.PeriodSecondsTrigger",
        "assemblyName": "Furion",
        "args": "[5]",
        "description": null,
        "status": 2,
        "startTime": null,
        "endTime": null,
        "lastRunTime": "2022-12-02 18:00:59.326",
        "nextRunTime": "2022-12-02 18:01:04.358",
        "numberOfRuns": 1,
        "maxNumberOfRuns": 0,
        "numberOfErrors": 0,
        "maxNumberOfErrors": 0,
        "numRetries": 0,
        "retryTimeout": 1000,
        "startNow": true,
        "runOnStart": false,
        "resetOnlyOnce": true,
        "updatedTime": "2022-12-02 18:00:59.390"
      }
      }
```

- **ç¬¬äºŒç§ï¼šè¾“å‡ºå•ç‹¬çš„ä½œä¸š `JSON` ä¿¡æ¯ï¼š`jobDetail.ConvertToJSON()` æˆ– `trigger.ConvertToJSON()`**

```cs showLineNumbers {11-12}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation(context.JobDetail.ConvertToJSON());
        _logger.LogInformation(context.Trigger.ConvertToJSON(NamingConventions.UnderScoreCase));    // æ”¯æŒä¸‰ç§å±æ€§åè¾“å‡ºè§„åˆ™

        await Task.CompletedTask;
    }
}
```

æŸ¥çœ‹ä½œä¸šæ‰“å°ç»“æœï¼š

```json showLineNumbers {2-12,14-35}
info: 2022-12-02 18:02:10.7923360 +08:00 æ˜ŸæœŸäº” L MyJob[0] #8
      {
        "jobId": "job1",
        "groupName": null,
        "jobType": "MyJob",
        "assemblyName": "ConsoleApp32",
        "description": null,
        "concurrent": true,
        "includeAnnotations": false,
        "properties": "{}",
        "updatedTime": "2022-12-02 18:02:10.774"
      }
info: 2022-12-02 18:02:10.8008708 +08:00 æ˜ŸæœŸäº” L MyJob[0] #8
      {
        "trigger_id": "job1_trigger1",
        "job_id": "job1",
        "trigger_type": "Furion.Schedule.PeriodSecondsTrigger",
        "assembly_name": "Furion",
        "args": "[5]",
        "description": null,
        "status": 2,
        "start_time": null,
        "end_time": null,
        "last_run_time": "2022-12-02 18:02:10.727",
        "next_run_time": "2022-12-02 18:02:15.733",
        "number_of_runs": 1,
        "max_number_of_runs": 0,
        "number_of_errors": 0,
        "max_number_of_errors": 0,
        "num_retries": 0,
        "retry_timeout": 1000,
        "start_now": true,
        "run_on_start": false,
        "reset_only_once": true,
        "updated_time": "2022-12-02 18:02:10.774"
      }
```

- **ç¬¬ä¸‰ç§ï¼šè¾“å‡ºå•ç‹¬çš„ä½œä¸š `SQL` ä¿¡æ¯ï¼š`jobDetail.ConvertToSQL()` æˆ– `trigger.ConvertToSQL()`**

```cs showLineNumbers {11-12,14-16}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        var jobDetail = context.JobDetail;
        var trigger = context.Trigger;

        _logger.LogInformation(jobDetail.ConvertToSQL("ä½œä¸šä¿¡æ¯è¡¨å", PersistenceBehavior.Appended));  // è¾“å‡ºæ–°å¢è¯­å¥
        _logger.LogInformation(trigger.ConvertToSQL("ä½œä¸šè§¦å‘å™¨è¡¨å", PersistenceBehavior.Removed, NamingConventions.Pascal));    // è¾“å‡ºåˆ é™¤è¯­å¥
        _logger.LogInformation(trigger.ConvertToSQL("ä½œä¸šè§¦å‘å™¨è¡¨å", PersistenceBehavior.Updated, NamingConventions.UnderScoreCase));    // è¾“å‡ºæ›´æ–°è¯­å¥

        await Task.CompletedTask;
    }
}
```

æŸ¥çœ‹ä½œä¸šæ‰“å°ç»“æœï¼š

```sql showLineNumbers {2,25,28}
info: 2022-12-02 18:03:11.8543760 +08:00 æ˜ŸæœŸäº” L MyJob[0] #13
      INSERT INTO ä½œä¸šä¿¡æ¯è¡¨å(
          jobId,
          groupName,
          jobType,
          assemblyName,
          description,
          concurrent,
          includeAnnotations,
          properties,
          updatedTime
      )
      VALUES(
          'job1',
          NULL,
          'MyJob',
          'ConsoleApp32',
          NULL,
          1,
          0,
          '{}',
          '2022-12-02 18:03:11.836'
      );
info: 2022-12-02 18:03:11.8636268 +08:00 æ˜ŸæœŸäº” L MyJob[0] #13
      DELETE FROM ä½œä¸šè§¦å‘å™¨è¡¨å
      WHERE TriggerId = 'job1_trigger1' AND JobId = 'job1';
info: 2022-12-02 18:03:11.8669134 +08:00 æ˜ŸæœŸäº” L MyJob[0] #13
      UPDATE ä½œä¸šè§¦å‘å™¨è¡¨å
      SET
          trigger_id = 'job1_trigger1',
          job_id = 'job1',
          trigger_type = 'Furion.Schedule.PeriodSecondsTrigger',
          assembly_name = 'Furion',
          args = '[5]',
          description = NULL,
          status = 2,
          start_time = NULL,
          end_time = NULL,
          last_run_time = '2022-12-02 18:03:11.778',
          next_run_time = '2022-12-02 18:03:16.794',
          number_of_runs = 1,
          max_number_of_runs = 0,
          number_of_errors = 0,
          max_number_of_errors = 0,
          num_retries = 0,
          retry_timeout = 1000,
          start_now = 1,
          run_on_start = 0,
          reset_only_once = 1,
          updated_time = '2022-12-02 18:03:11.836'
      WHERE trigger_id = 'job1_trigger1' AND job_id = 'job1';
```

- **ç¬¬å››ç§ï¼šè¾“å‡ºå•ç‹¬çš„ä½œä¸š `Monitor` ä¿¡æ¯ï¼š`jobDetail.ConvertToMonitor()` æˆ– `trigger.ConvertToMonitor()`**

```cs showLineNumbers {11-12}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation(context.JobDetail.ConvertToMonitor());
        _logger.LogInformation(context.Trigger.ConvertToMonitor());

        await Task.CompletedTask;
    }
}
```

æŸ¥çœ‹ä½œä¸šæ‰“å°ç»“æœï¼š

```bash showLineNumbers {2,16}
info: 2022-12-02 18:04:06.2833095 +08:00 æ˜ŸæœŸäº” L MyJob[0] #8
      â”â”â”â”â”â”â”â”â”â”â”â”  JobDetail â”â”â”â”â”â”â”â”â”â”â”
      â”£ MyJob
      â”£
      â”£ jobIdï¼š                     job1
      â”£ groupNameï¼š
      â”£ jobTypeï¼š                   MyJob
      â”£ assemblyNameï¼š              ConsoleApp32
      â”£ descriptionï¼š
      â”£ concurrentï¼š                True
      â”£ includeAnnotationsï¼š        False
      â”£ propertiesï¼š                {}
      â”£ updatedTimeï¼š               2022-12-02 18:04:06.254
      â”—â”â”â”â”â”â”â”â”â”â”â”  JobDetail â”â”â”â”â”â”â”â”â”â”â”
info: 2022-12-02 18:04:06.2868205 +08:00 æ˜ŸæœŸäº” L MyJob[0] #8
      â”â”â”â”â”â”â”â”â”â”â”â”  Trigger â”â”â”â”â”â”â”â”â”â”â”
      â”£ Furion.Schedule.PeriodSecondsTrigger
      â”£
      â”£ triggerIdï¼š                job1_trigger1
      â”£ jobIdï¼š                    job1
      â”£ triggerTypeï¼š              Furion.Schedule.PeriodSecondsTrigger
      â”£ assemblyNameï¼š             Furion
      â”£ argsï¼š                     [5]
      â”£ descriptionï¼š
      â”£ statusï¼š                   Running
      â”£ startTimeï¼š
      â”£ endTimeï¼š
      â”£ lastRunTimeï¼š              2022-12-02 18:04:06.189
      â”£ nextRunTimeï¼š              2022-12-02 18:04:11.212
      â”£ numberOfRunsï¼š             1
      â”£ maxNumberOfRunsï¼š          0
      â”£ numberOfErrorsï¼š           0
      â”£ maxNumberOfErrorsï¼š        0
      â”£ numRetriesï¼š               0
      â”£ retryTimeoutï¼š             1000
      â”£ startNowï¼š                 True
      â”£ runOnStartï¼š               False
      â”£ resetOnlyOnceï¼š            True
      â”£ updatedTimeï¼š              2022-12-02 18:04:06.254
      â”—â”â”â”â”â”â”â”â”â”â”â”  Trigger â”â”â”â”â”â”â”â”â”â”â”
```

### 26.1.2.5 è¿è¡Œæ—¶ï¼ˆåŠ¨æ€ï¼‰æ“ä½œä½œä¸š

æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¿è¡Œæ—¶å¯¹ä½œä¸šåŠ¨æ€çš„å¢åŠ ï¼Œæ›´æ–°ï¼Œåˆ é™¤ç­‰æ“ä½œï¼Œå¦‚åŠ¨æ€æ·»åŠ ä½œä¸šï¼š

1. æ³¨å†Œ `services.AddSchedule()` æœåŠ¡

```cs showLineNumbers {2,5}
// å¯ä»¥å®Œå…¨åŠ¨æ€æ“ä½œï¼Œåªéœ€è¦æ³¨å†ŒæœåŠ¡å³å¯
services.AddSchedule();

// ä¹Ÿå¯ä»¥éƒ¨åˆ†é™æ€ï¼Œéƒ¨åˆ†åŠ¨æ€æ³¨å†Œ
services.AddSchedule(options =>
{
    options.AddJob<MyJob>(concurrent: false, Triggers.PeriodSeconds(5));
});
```

2. æ³¨å…¥ `ISchedulerFactory` æœåŠ¡

```cs showLineNumbers {4,11}
public class YourService: IYourService
{
    private readonly ISchedulerFactory _schedulerFactory;
    public YourService(ISchedulerFactory schedulerFactory)
    {
        _schedulerFactory = schedulerFactory;
    }

    public void AddJob()
    {
        _schedulerFactory.AddJob<MyJob>("åŠ¨æ€ä½œä¸š Id", Triggers.Secondly());
    }
}
```

3. æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœ

```bash showLineNumbers {6,8,12,14,16,18,22,24}
info: 2022-12-02 18:07:33.7799062 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      Schedule hosted service is running.
info: 2022-12-02 18:07:33.7971487 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      Schedule hosted service is preloading...
info: 2022-12-02 18:07:33.8751390 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      The <job1_trigger1> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-02 18:07:33.8805159 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      The scheduler of <job1> successfully appended to the schedule.
warn: 2022-12-02 18:07:33.9013656 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      Schedule hosted service preload completed, and a total of <1> schedulers are appended.
info: 2022-12-02 18:07:38.9241031 +08:00 æ˜ŸæœŸäº” L MyJob[0] #9
      <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-02 18:07:38.813 -> 2022-12-02 18:07:43.863
info: 2022-12-02 18:07:43.0865787 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #16
      The <åŠ¨æ€ä½œä¸š Id_trigger1> trigger for scheduler of <åŠ¨æ€ä½œä¸š Id> successfully appended to the schedule.
warn: 2022-12-02 18:07:43.0894163 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #16
      Schedule hosted service cancels hibernation and GC.Collect().
info: 2022-12-02 18:07:43.1129824 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #16
      The scheduler of <åŠ¨æ€ä½œä¸š Id> successfully appended to the schedule.
info: 2022-12-02 18:07:43.8810686 +08:00 æ˜ŸæœŸäº” L MyJob[0] #17
      <job1> [C] <job1 job1_trigger1> 5s 2ts 2022-12-02 18:07:43.863 -> 2022-12-02 18:07:48.848
info: 2022-12-02 18:07:44.0104025 +08:00 æ˜ŸæœŸäº” L MyJob[0] #16
      <åŠ¨æ€ä½œä¸š Id> [C] <åŠ¨æ€ä½œä¸š Id åŠ¨æ€ä½œä¸š Id_trigger1> * * * * * * 1ts 2022-12-02 18:07:44.000 -> 2022-12-02 18:07:45.000
info: 2022-12-02 18:07:45.0092441 +08:00 æ˜ŸæœŸäº” L MyJob[0] #8
      <åŠ¨æ€ä½œä¸š Id> [C] <åŠ¨æ€ä½œä¸š Id åŠ¨æ€ä½œä¸š Id_trigger1> * * * * * * 2ts 2022-12-02 18:07:45.000 -> 2022-12-02 18:07:46.000
```

### 26.1.2.6 ä½œä¸šè§¦å‘å™¨ç‰¹æ€§

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¡†æ¶ä¸ä¼šæ‰«æ `IJob` å®ç°ç±»çš„ä½œä¸šè§¦å‘å™¨ç‰¹æ€§ï¼Œä½†å¯ä»¥è®¾ç½®ä½œä¸šçš„ `IncludeAnnotations` è¿›è¡Œå¯ç”¨ã€‚

1. å¯ç”¨ `IncludeAnnotations` æ‰«æ

```cs showLineNumbers {3,7,10}
services.AddSchedule(options =>
{
    options.AddJob(JobBuilder.Create<MyJob>().SetIncludeAnnotations(true)
        , Triggers.PeriodSeconds(5));     // è¿™é‡Œå¯ä¼ å¯ä¸ä¼ ï¼Œä¼ äº†åˆ™ä¼šè‡ªåŠ¨è½½å…¥ç‰¹æ€§å’Œè¿™é‡Œé…ç½®çš„ä½œä¸šè§¦å‘å™¨

    // è¿˜å¯ä»¥æ›´ç®€å•~~
    options.AddJob(typeof(MyJob).ScanToBuilder());

    // è¿˜å¯ä»¥æ‰¹é‡æ–°å¢ Furion 4.8.2.4+
    options.AddJob(App.EffectiveTypes.ScanToBuilders());
});
```

2. åœ¨ `MyJob` ä¸­æ·»åŠ å¤šä¸ªä½œä¸šè§¦å‘å™¨ç‰¹æ€§

```cs showLineNumbers {1-2}
[Minutely]
[Cron("3,7,8 * * * * ?", CronStringFormat.WithSeconds)]
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation($"{context}");
        await Task.CompletedTask;
    }
}
```

3. æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœ

```bash showLineNumbers {6,8,10,12,16,18,20,24,26}
info: 2022-12-02 18:12:56.4199663 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      Schedule hosted service is running.
info: 2022-12-02 18:12:56.4287962 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      Schedule hosted service is preloading...
info: 2022-12-02 18:12:56.6149505 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      The <job1_trigger1> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-02 18:12:56.6205117 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      The <job1_trigger2> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-02 18:12:56.6266132 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      The <job1_trigger3> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-02 18:12:56.6291006 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      The scheduler of <job1> successfully appended to the schedule.
warn: 2022-12-02 18:12:56.6454334 +08:00 æ˜ŸæœŸäº” L System.Logging.ScheduleService[0] #1
      Schedule hosted service preload completed, and a total of <1> schedulers are appended.
info: 2022-12-02 18:13:00.0842828 +08:00 æ˜ŸæœŸäº” L MyJob[0] #15
      <job1> [C] <job1 job1_trigger2> * * * * * 1ts 2022-12-02 18:13:00.000 -> 2022-12-02 18:14:00.000
info: 2022-12-02 18:13:01.5260220 +08:00 æ˜ŸæœŸäº” L MyJob[0] #16
      <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-02 18:13:01.494 -> 2022-12-02 18:13:06.492
info: 2022-12-02 18:13:03.0076111 +08:00 æ˜ŸæœŸäº” L MyJob[0] #6
      <job1> [C] <job1 job1_trigger3> 3,7,8 * * * * ? 1ts 2022-12-02 18:13:03.000 -> 2022-12-02 18:13:07.000
info: 2022-12-02 18:13:06.4954400 +08:00 æ˜ŸæœŸäº” L MyJob[0] #13
      <job1> [C] <job1 job1_trigger1> 5s 2ts 2022-12-02 18:13:06.492 -> 2022-12-02 18:13:11.463
info: 2022-12-02 18:13:07.0180453 +08:00 æ˜ŸæœŸäº” L MyJob[0] #6
      <job1> [C] <job1 job1_trigger3> 3,7,8 * * * * ? 2ts 2022-12-02 18:13:07.000 -> 2022-12-02 18:13:08.000
info: 2022-12-02 18:13:08.0114292 +08:00 æ˜ŸæœŸäº” L MyJob[0] #13
      <job1> [C] <job1 job1_trigger3> 3,7,8 * * * * ? 3ts 2022-12-02 18:13:08.000 -> 2022-12-02 18:14:03.000
info: 2022-12-02 18:13:11.4774564 +08:00 æ˜ŸæœŸäº” L MyJob[0] #16
      <job1> [C] <job1 job1_trigger1> 5s 3ts 2022-12-02 18:13:11.463 -> 2022-12-02 18:13:16.445
```

## 26.1.3 ä½œä¸šä¿¡æ¯ `JobDetail` åŠæ„å»ºå™¨

### 26.1.3.1 å…³äºä½œä¸šä¿¡æ¯

æ¡†æ¶æä¾›äº† `JobDetail` ç±»å‹æ¥æè¿°ä½œä¸šä¿¡æ¯ï¼Œ`JobDetail` ç±»å‹æä¾›ä»¥ä¸‹**åªè¯»å±æ€§**ï¼š

| å±æ€§å               | å±æ€§ç±»å‹    | é»˜è®¤å€¼  | è¯´æ˜                                                                     |
| -------------------- | ----------- | ------- | ------------------------------------------------------------------------ |
| `JobId`              | `string`    |         | ä½œä¸š `Id`                                                                |
| `GroupName`          | `string`    |         | ä½œä¸šç»„åç§°                                                               |
| `JobType`            | `string`    |         | ä½œä¸šå¤„ç†ç¨‹åºç±»å‹ï¼Œå­˜å‚¨çš„æ˜¯ç±»å‹çš„ `FullName`                              |
| `AssemblyName`       | `string`    |         | ä½œä¸šå¤„ç†ç¨‹åºç±»å‹æ‰€åœ¨ç¨‹åºé›†ï¼Œå­˜å‚¨çš„æ˜¯ç¨‹åºé›† `Name`                        |
| `Description`        | `string`    |         | æè¿°ä¿¡æ¯                                                                 |
| `Concurrent`         | `bool`      | `true`  | ä½œä¸šæ‰§è¡Œæ–¹å¼ï¼Œå¦‚æœè®¾ç½®ä¸º `false`ï¼Œé‚£ä¹ˆä½¿ç”¨ `ä¸²è¡Œ` æ‰§è¡Œï¼Œå¦åˆ™ `å¹¶è¡Œ` æ‰§è¡Œ |
| `IncludeAnnotations` | `bool`      | `false` | æ˜¯å¦æ‰«æ `IJob` å®ç°ç±» `[Trigger]` ç‰¹æ€§è§¦å‘å™¨                            |
| `Properties`         | `string`    | `"{}"`  | ä½œä¸šä¿¡æ¯é¢å¤–æ•°æ®ï¼Œç”± `Dictionary<string, object>` åºåˆ—åŒ–æˆå­—ç¬¦ä¸²å­˜å‚¨     |
| `UpdatedTime`        | `DateTime?` |         | ä½œä¸šæ›´æ–°æ—¶é—´                                                             |

### 26.1.3.2 å…³äºä½œä¸šä¿¡æ¯æ„å»ºå™¨

ä½œä¸šä¿¡æ¯ `JobDetail` æ˜¯ä½œä¸šè°ƒåº¦æ¨¡å—æä¾›è¿è¡Œæ—¶çš„**åªè¯»ç±»å‹**ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•åˆ›å»ºæˆ–å˜æ›´ `JobDetail` å¯¹è±¡å‘¢ï¼Ÿ

`JobBuilder` æ˜¯ä½œä¸šè°ƒåº¦æ¨¡å—æä¾›å¯ç”¨æ¥ç”Ÿæˆè¿è¡Œæ—¶ `JobDetail` çš„ç±»å‹ï¼Œè¿™æ ·åšçš„å¥½å¤„å¯é¿å…å¤–éƒ¨ç›´æ¥ä¿®æ”¹è¿è¡Œæ—¶ `JobDetail` æ•°æ®ï¼Œè¿˜èƒ½å®ç°ä»»ä½•ä¿®æ”¹åŠ¨ä½œç›‘å¬ï¼Œä¹Ÿèƒ½é¿å…å¤šçº¿ç¨‹æŠ¢å æƒ…å†µã€‚

ä½œä¸šè°ƒåº¦æ¨¡å—æä¾›äº†å¤šç§æ–¹å¼ç”¨æ¥åˆ›å»º `JobBuilder` å¯¹è±¡ã€‚

1. **é€šè¿‡ `Create` é™æ€æ–¹æ³•åˆ›å»º**

```cs showLineNumbers {2,5,8,11,14}
// æ ¹æ®ä½œä¸š Id åˆ›å»º
var jobBuilder = JobBuilder.Create("job1");

// æ ¹æ® IJob å®ç°ç±»ç±»å‹åˆ›å»º
var jobBuilder = JobBuilder.Create<MyJob>();

// æ ¹æ®ç¨‹åºé›†åç§°å’Œç±»å‹å®Œå…¨é™å®šåï¼ˆFullNameï¼‰åˆ›å»º
var jobBuilder = JobBuilder.Create("YourProject", "YourProject.MyJob");

// æ ¹æ® Type ç±»å‹åˆ›å»º
var jobBuilder = JobBuilder.Create(typeof(MyJob));

// é€šè¿‡å§”æ‰˜åˆ›é€ åŠ¨æ€ä½œä¸š
var jobBuilder = JobBuilder.Create((serviceProvider, context, stoppingToken) =>
{
      serviceProvider.GetLogger().LogInformation($"{context}");
      return Task.CompletedTask;
});
```

2. **é€šè¿‡ `JobDetail` ç±»å‹åˆ›å»º**

è¿™ç§æ–¹å¼å¸¸ç”¨äºåœ¨è¿è¡Œæ—¶æ›´æ–°ä½œä¸šä¿¡æ¯ã€‚

```cs showLineNumbers
var jobBuilder = JobBuilder.From(jobDetail);

//ä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼
var jobBuilder = jobDetail.GetBuilder();
```

3. **é€šè¿‡ `JSON` å­—ç¬¦ä¸²åˆ›å»º**

è¯¥æ–¹å¼éå¸¸çµæ´»ï¼Œå¯ä»é…ç½®æ–‡ä»¶ï¼Œ`JSON` å­—ç¬¦ä¸²ï¼Œæˆ–å…¶ä»–èƒ½å¤Ÿè¿”å› `JSON` å­—ç¬¦ä¸²çš„åœ°æ–¹åˆ›å»ºã€‚

```cs showLineNumbers {2-12}
var jobBuilder = JobBuilder.From(@"{
	""jobId"": ""job1"",
	""groupName"": null,
	""jobType"": ""MyJob"",
	""assemblyName"": ""ConsoleApp13"",
	""description"": null,
	""concurrent"": true,
	""includeAnnotations"": false,
	""properties"": ""{}"",
	""updatedTime"": null
}");
```

å¦‚æœä½¿ç”¨çš„æ˜¯ `.NET7`ï¼Œå¯ä½¿ç”¨ `"""` é¿å…è½¬ä¹‰ï¼Œå¦‚ï¼š

```cs showLineNumbers {2-12}
var jobBuilder = JobBuilder.From("""
{
	"jobId": "job1",
	"groupName": null,
	"jobType": "MyJob",
	"assemblyName": "ConsoleApp13",
	"description": null,
	"concurrent": true,
	"includeAnnotations": false,
	"properties": "{}",
	"updatedTime": "2022-12-02 18:00:59.390"
}
""");
```

:::important å…³äºå±æ€§ååŒ¹é…è§„åˆ™

æ”¯æŒ `CamelCaseï¼ˆé©¼å³°å‘½åæ³•ï¼‰`ï¼Œ`Pascalï¼ˆå¸•æ–¯å¡å‘½åæ³•ï¼‰` å‘½åæ–¹å¼ã€‚

**ä¸æ”¯æŒ `UnderScoreCaseï¼ˆä¸‹åˆ’çº¿å‘½åæ³•ï¼‰`** ï¼Œå¦‚ `"include_annotations": true`

:::

4. **è¿˜å¯ä»¥é€šè¿‡ `Clone` é™æ€æ–¹æ³•ä»ä¸€ä¸ª `JobBuilder` åˆ›å»º**

```cs showLineNumbers
var jobBuilder = JobBuilder.Clone(fromJobBuilder);
```

:::important å…‹éš†è¯´æ˜

å…‹éš†æ“ä½œåªä¼šå…‹éš† `AssemblyName`ï¼Œ`JobType`ï¼Œ`GroupName`ï¼Œ`Description`ï¼Œ`Concurrent`ï¼Œ`IncludeAnnotations`ï¼Œ`Properties`ï¼Œ`DynamicExecuteAsync`ï¼ˆåŠ¨æ€ä½œä¸šï¼‰ã€‚

- **ä¸ä¼šå…‹éš† `JobId`ï¼Œ`UpdatedTime`ã€‚**

:::

5. **è¿˜å¯ä»¥é€šè¿‡ `LoadFrom` å®ä¾‹æ–¹æ³•å¡«å……å½“å‰çš„ `JobBuilder`**

æ¯”å¦‚å¯ä»¥ä¼ é€’åŒ¿åç±»å‹ï¼Œç±»ç±»å‹ï¼Œå­—å…¸ `Dictionary<string, object>` ç±»å‹ï¼š

```cs showLineNumbers {2,9,14,17,22,25}
// ä¼šè¦†ç›–æ‰€æœ‰ç›¸åŒçš„å€¼
jobBuilder.LoadFrom(new
{
      Description = "æˆ‘æ˜¯æè¿°",
      Concurrent = false
});

// æ”¯æŒå¤šä¸ªå¡«å……ï¼Œè¿˜å¯ä»¥é…ç½®è·³è¿‡ null å€¼è¦†ç›–
jobBuilder.LoadFrom(new
{
      Description = "æˆ‘æ˜¯å¦å¤–ä¸€ä¸ªæè¿°",
      Concurrent = false,
      IncludeAnnotations = default(object)      // ä¼šè·³è¿‡èµ‹å€¼
}, ignoreNullValue: true);

// æ”¯æŒå¿½ç•¥ç‰¹å®šå±æ€§åæ˜ å°„
jobBuilder.LoadFrom(new
{
      Description = "æˆ‘æ˜¯å¦å¤–ä¸€ä¸ªæè¿°",
      Concurrent = false,
      IncludeAnnotations = default(object)      // ä¼šè·³è¿‡èµ‹å€¼
}, ignorePropertyNames: new[]{ "description" });

// æ”¯æŒå­—å…¸ç±»å‹
jobBuilder.LoadFrom(new Dictionary<string, object>
{
      {"Description", "è¿™æ˜¯æ–°çš„æè¿°" },
      {"include_annotations", false },
      {"updatedTime", DateTime.Now }
});
```

:::important å…³äºå±æ€§ååŒ¹é…è§„åˆ™

æ”¯æŒ `CamelCaseï¼ˆé©¼å³°å‘½åæ³•ï¼‰`ï¼Œ`Pascalï¼ˆå¸•æ–¯å¡å‘½åæ³•ï¼‰` å’Œ `UnderScoreCaseï¼ˆä¸‹åˆ’çº¿å‘½åæ³•ï¼‰` å‘½åæ–¹å¼ã€‚

:::

### 26.1.3.3 è®¾ç½®ä½œä¸šä¿¡æ¯æ„å»ºå™¨

`JobBuilder` æä¾›äº†å’Œ `JobDetail` å®Œå…¨åŒ¹é…çš„ `Set[å±æ€§å]` æ–¹æ³•æ¥é…ç½®ä½œä¸šä¿¡æ¯å„ä¸ªå±æ€§ï¼Œå¦‚ï¼š

```cs showLineNumbers {3,20}
services.AddSchedule(options =>
{
    var jobBuilder = JobBuilder.Create<MyJob>()
        .SetJobId("job1")   // ä½œä¸š Id
        .SetGroupName("group1") // ä½œä¸šç»„åç§°
        .SetJobType("Furion.Application", "Furion.Application.MyJob") // ä½œä¸šç±»å‹ï¼Œæ”¯æŒå¤šä¸ªé‡è½½
        .SetJobType<MyJob>()    // ä½œä¸šç±»å‹ï¼Œæ”¯æŒå¤šä¸ªé‡è½½
        .SetJobType(typeof(MyJob))  // ä½œä¸šç±»å‹ï¼Œæ”¯æŒå¤šä¸ªé‡è½½
        .SetDescription("è¿™æ˜¯ä¸€æ®µæè¿°")   // ä½œä¸šæè¿°
        .SetConcurrent(false)   // å¹¶è¡Œè¿˜æ˜¯ä¸²è¡Œæ–¹å¼ï¼Œfalse ä¸º ä¸²è¡Œ
        .SetIncludeAnnotations(true)    // æ˜¯å¦æ‰«æ IJob ç±»å‹çš„è§¦å‘å™¨ç‰¹æ€§ï¼Œtrue ä¸º æ‰«æ
        .SetProperties("{}")    // ä½œä¸šé¢å¤–æ•°æ® Dictionary<string, object> ç±»å‹åºåˆ—åŒ–ï¼Œæ”¯æŒå¤šä¸ªé‡è½½
        .SetProperties(new Dictionary<string, object> { { "name", "Furion" } })  // ä½œä¸šç±»å‹é¢å¤–æ•°æ®ï¼Œæ”¯æŒå¤šä¸ªé‡è½½ï¼Œæ¨èï¼ï¼ï¼
        .SetDynamicExecuteAsync((serviceProvider, context, stoppingToken) => {
            serviceProvider.GetLogger().LogInformation($"{context}");
            return Task.CompletedTask;
        })  // åŠ¨æ€å§”æ‰˜å¤„ç†ç¨‹åºï¼Œä¸€æ—¦è®¾ç½®äº†æ­¤å§”æ‰˜ï¼Œé‚£ä¹ˆä¼˜å…ˆçº§å°†å¤§äº MyJob çš„ ExecuteAsync
        ;

    options.AddJob(jobBuilder, Triggers.PeriodSeconds(5));
});
```

### 26.1.3.4 ä½œä¸šä¿¡æ¯/æ„å»ºå™¨é¢å¤–æ•°æ®

æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦åœ¨ä½œä¸šè¿è¡Œçš„æ—¶å€™æ·»åŠ ä¸€äº›é¢å¤–æ•°æ®ï¼Œæˆ–è€…å®ç°å¤šä¸ªè§¦å‘å™¨å…±äº«æ•°æ®ï¼Œç»å¸¸ç”¨äº `ä¸²è¡Œ` æ‰§è¡Œä¸­ï¼ˆ`å¹¶è¡Œ` ä¹ŸåŒæ ·å·¥ä½œï¼‰ï¼Œåé¢ä¸€ä¸ªè§¦å‘å™¨éœ€ç­‰å¾…å‰ä¸€ä¸ªè§¦å‘å™¨å®Œæˆã€‚

```cs showLineNumbers {13-14,16}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        var jobDetail = context.JobDetail;

        var count = jobDetail.GetProperty<int>("count");
        jobDetail.AddOrUpdateProperty("count", count + 1);  // é€’å¢ count

        _logger.LogInformation($"count: {count} {context}");

        await Task.CompletedTask;
    }
}
```

æŸ¥çœ‹ä½œä¸šè¿è¡Œæ—¥å¿—ï¼š

```bash showLineNumbers {12,14,16,18}
info: 2022-12-03 23:16:46.5150228 +08:00 æ˜ŸæœŸå…­ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is running.
info: 2022-12-03 23:16:46.5197497 +08:00 æ˜ŸæœŸå…­ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is preloading...
info: 2022-12-03 23:16:46.6987703 +08:00 æ˜ŸæœŸå…­ L System.Logging.ScheduleService[0] #1
      The <job1_trigger1> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-03 23:16:46.7003295 +08:00 æ˜ŸæœŸå…­ L System.Logging.ScheduleService[0] #1
      The scheduler of <job1> successfully appended to the schedule.
warn: 2022-12-03 23:16:46.7248216 +08:00 æ˜ŸæœŸå…­ L System.Logging.ScheduleService[0] #1
      Schedule hosted service preload completed, and a total of <1> schedulers are appended.
info: 2022-12-03 23:16:51.7013640 +08:00 æ˜ŸæœŸå…­ L MyJob[0] #8
      count: 0 <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-03 23:16:51.663 -> 2022-12-03 23:16:56.656
info: 2022-12-03 23:16:56.6768044 +08:00 æ˜ŸæœŸå…­ L MyJob[0] #9
      count: 1 <job1> [C] <job1 job1_trigger1> 5s 2ts 2022-12-03 23:16:56.656 -> 2022-12-03 23:17:01.635
info: 2022-12-03 23:17:01.6454604 +08:00 æ˜ŸæœŸå…­ L MyJob[0] #8
      count: 2 <job1> [C] <job1 job1_trigger1> 5s 3ts 2022-12-03 23:17:01.635 -> 2022-12-03 23:17:06.608
info: 2022-12-03 23:17:06.6247917 +08:00 æ˜ŸæœŸå…­ L MyJob[0] #6
      count: 3 <job1> [C] <job1 job1_trigger1> 5s 4ts 2022-12-03 23:17:06.608 -> 2022-12-03 23:17:11.586
```

ä½œä¸šè°ƒåº¦æ¨¡å—ä¸º `JobDetail` å’Œ `JobBuilder` æä¾›äº†å¤šä¸ªæ–¹æ³•æ“ä½œé¢å¤–æ•°æ®ï¼š

```cs showLineNumbers {2,5,8,11,14,17,20,23}
// æŸ¥çœ‹æ‰€æœ‰é¢å¤–æ•°æ®
var properties = jobDetail.GetProperties();

// æŸ¥çœ‹å•ä¸ªé¢å¤–æ•°æ®ï¼Œè¿”å› object
var value = jobBuilder.GetProperty("key");

// æŸ¥çœ‹å•ä¸ªé¢å¤–æ•°æ®æ³›å‹
var value = jobDetail.GetProperty<int>("key");

// æ·»åŠ æ–°çš„é¢å¤–æ•°æ®ï¼Œæ”¯æŒé“¾å¼æ“ä½œï¼Œå¦‚æœé”®å·²å­˜åœ¨ï¼Œåˆ™è·³è¿‡
jobDetail.AddProperty("key", "Furion").AddProperty("key1", 2);

// æ·»åŠ æˆ–æ›´æ–°é¢å¤–æ•°æ®ï¼Œæ”¯æŒé“¾å¼æ“ä½œï¼Œä¸å­˜åœ¨åˆ™æ–°å¢ï¼Œå­˜åœ¨åˆ™æ›¿æ¢ï¼Œæ¨è
jobDetail.AddOrUpdateProperty("key", "Furion").AddOrUpdateProperty("key1", 2);

// è¿˜å¯ä»¥é€šè¿‡å§”æ‰˜çš„æ–¹å¼ï¼šå¦‚æœé”®ä¸å­˜åœ¨åˆ™æ’å…¥ count = newValueï¼Œå¦åˆ™æ›´æ–°ä¸º valueï¼ˆæ—§å€¼ï¼‰+1
jobDetail.AddOrUpdateProperty("count", newValue, value => value + 1);

// åˆ é™¤æŸä¸ªé¢å¤–æ•°æ®ï¼Œæ”¯æŒé“¾å¼æ“ä½œï¼Œå¦‚æœ key ä¸å­˜åœ¨åˆ™è·³è¿‡
jobDetail.RemoveProperty("key").RemoveProperty("key1");

// æ¸…ç©ºæ‰€æœ‰é¢å¤–æ•°æ®
jobDetail.ClearProperties();
```

:::important ä½œä¸šé¢å¤–æ•°æ®ç±»å‹æ”¯æŒ

ä½œä¸šé¢å¤–æ•°æ®æ¯ä¸€é¡¹çš„å€¼åªæ”¯æŒ `int32`ï¼Œ`string`ï¼Œ`bool`ï¼Œ`null` æˆ–å®ƒä»¬ç»„æˆçš„æ•°ç»„ç±»å‹ã€‚

:::

### 26.1.3.5 ä½œä¸šä¿¡æ¯ç‰¹æ€§

ä½œä¸šä¿¡æ¯ç‰¹æ€§ `[JobDetail]` æ˜¯ä¸ºäº†æ–¹ä¾¿è¿è¡Œæ—¶æˆ–å¯åŠ¨æ—¶å¿«é€Ÿåˆ›å»ºä½œä¸šè®¡åˆ’æ„å»ºå™¨è€Œæä¾›çš„ï¼Œå¯åœ¨å¯åŠ¨æ—¶æˆ–è¿è¡Œæ—¶é€šè¿‡ä»¥ä¸‹æ–¹å¼åˆ›å»ºï¼Œå¦‚ï¼š

```cs showLineNumbers {1}
[JobDetail("job1", "è¿™æ˜¯ä¸€æ®µæè¿°")]
[PeriodSeconds(5, TriggerId = "trigger1")]
public class MyJob : IJob
{
}
```

- **å¯åŠ¨ `IncludeAnnotations` å±æ€§è‡ªåŠ¨å¡«å……**

```cs showLineNumbers {4}
services.AddSchedule(options =>
{
    options.AddJob(JobBuilder.Create<MyJob>()
      .SetIncludeAnnotations(true));      // æ­¤æ—¶ [JobDetail] é…ç½®çš„éç©ºå±æ€§å°†è‡ªåŠ¨å¤åˆ¶ç»™ JobBuilderï¼Œ[PeriodSeconds] ä¹Ÿä¼šè‡ªåŠ¨åˆ›å»º TriggerBuilder
});
```

- **æ‰‹åŠ¨æ‰«æå¹¶åˆ›å»ºä½œä¸šè®¡åˆ’æ„å»ºå™¨**

```cs showLineNumbers
var schedulerBuilder = typeof(MyJob).ScanToBuilder();
```

- **é€šè¿‡ç¨‹åºé›†ç±»å‹æ‰«ææ‰¹é‡åˆ›å»ºä½œä¸šè®¡åˆ’æ„å»ºå™¨**

ä¹Ÿå¯ä»¥ç”¨äºä½œä¸šæŒä¹…åŒ– `Preload` åˆå§‹åŒ–æ—¶ä½¿ç”¨ï¼š

```cs showLineNumbers {1,4-5,8}
public IEnumerable<SchedulerBuilder> Preload()
{
      // æ‰«ææ‰€æœ‰ç±»å‹å¹¶åˆ›å»º
      return App.EffectiveTypes.Where(t => t.IsJobType())
                              .Select(t => t.ScanToBuilder());

      // è¿˜å¯ä»¥æ›´ç®€å•~~
      return App.EffectiveTypes.ScanToBuilders();
}
```

---

**ä½œä¸šä¿¡æ¯ç‰¹æ€§è¿˜æä¾›äº†å¤šä¸ªå±æ€§é…ç½®**ï¼Œå¦‚ï¼š

- `JobId`ï¼šä½œä¸šä¿¡æ¯ Idï¼Œ`string` ç±»å‹
- `GroupName`ï¼šä½œä¸šç»„åç§°ï¼Œ`string` ç±»å‹
- `Description`ï¼šæè¿°ä¿¡æ¯ï¼Œ`string` ç±»å‹
- `Concurrent`ï¼šæ˜¯å¦é‡‡ç”¨å¹¶è¡Œæ‰§è¡Œï¼Œ`bool` ç±»å‹ï¼Œå¦‚æœè®¾ç½®ä¸º `false`ï¼Œé‚£ä¹ˆä½¿ç”¨ `ä¸²è¡Œ` æ‰§è¡Œ

ä½¿ç”¨å¦‚ä¸‹ï¼š

```cs showLineNumbers {1-5}
[JobDetail("jobId")]    // ä»…ä½œä¸š Id
[JobDetail("jobId", "è¿™æ˜¯ä¸€æ®µæè¿°")] // æè¿°
[JobDetail("jobId", false)] // ä¸²è¡Œ
[JobDetail("jobId", false, "è¿™æ˜¯ä¸€æ®µæè¿°")] // ä¸²è¡Œ + æè¿°
[JobDetail("jobId", Concurrent = false, Description = "è¿™æ˜¯ä¸€æ®µæè¿°")]
public class MyJob : IJob
{
      // ....
}
```

### 26.1.3.6 å¤šç§æ ¼å¼å­—ç¬¦ä¸²è¾“å‡º

`JobDetail` å’Œ `JobBuilder` éƒ½æä¾›äº†å¤šç§å°†è‡ªèº«è½¬æ¢æˆç‰¹å®šæ ¼å¼çš„å­—ç¬¦ä¸²ã€‚

1. **è½¬æ¢æˆ `JSON` å­—ç¬¦ä¸²**

```cs showLineNumbers
var json = jobDetail.ConvertToJSON();
```

å­—ç¬¦ä¸²æ‰“å°å¦‚ä¸‹ï¼š

```json showLineNumbers
{
  "jobId": "job1",
  "groupName": null,
  "jobType": "MyJob",
  "assemblyName": "ConsoleApp13",
  "description": null,
  "concurrent": true,
  "includeAnnotations": false,
  "properties": "{}",
  "updatedTime": "2022-12-04 11:51:00.483"
}
```

2. **è½¬æ¢æˆ `SQL` å­—ç¬¦ä¸²**

```cs showLineNumbers {2,6,9,13,16,20}
// è¾“å‡ºæ–°å¢ SQLï¼Œä½¿ç”¨ CamelCase å±æ€§å‘½å
var insertSql = jobDetail.ConvertToSQL("tbName"
      , PersistenceBehavior.Appended
      , NamingConventions.CamelCase);
// æ›´ä¾¿æ·æ‹“å±•
var insertSql = jobDetail.ConvertToInsertSQL("tbName", NamingConventions.CamelCase);

// è¾“å‡ºåˆ é™¤ SQLï¼Œä½¿ç”¨ Pascal å±æ€§å‘½å
var deleteSql = jobDetail.ConvertToSQL("tbName"
      , PersistenceBehavior.Removed
      , NamingConventions.Pascal);
// æ›´ä¾¿æ·æ‹“å±•
var deleteSql = jobDetail.ConvertToDeleteSQL("tbName", NamingConventions.Pascal);

// è¾“å‡ºæ›´æ–° SQLï¼Œä½¿ç”¨ UnderScoreCase å±æ€§å‘½å
var updateSql = jobDetail.ConvertToSQL("tbName"
      , PersistenceBehavior.Updated
      , NamingConventions.UnderScoreCase);
// æ›´ä¾¿æ·æ‹“å±•
var updateSql = jobDetail.ConvertToUpdateSQL("tbName", NamingConventions.UnderScoreCase);
```

å­—ç¬¦ä¸²æ‰“å°å¦‚ä¸‹ï¼š

```sql showLineNumbers {2,25,28}
-- æ–°å¢è¯­å¥
INSERT INTO tbName(
      jobId,
      groupName,
      jobType,
      assemblyName,
      description,
      concurrent,
      includeAnnotations,
      properties,
      updatedTime
)
VALUES(
      'job1',
      NULL,
      'MyJob',
      'ConsoleApp13',
      NULL,
      1,
      0,
      '{}',
      '2022-12-04 11:53:05.489'
);
-- åˆ é™¤è¯­å¥
DELETE FROM tbName
WHERE JobId = 'job1';
-- æ›´æ–°è¯­å¥
UPDATE tbName
SET
      job_id = 'job1',
      group_name = NULL,
      job_type = 'MyJob',
      assembly_name = 'ConsoleApp13',
      description = NULL,
      concurrent = 1,
      include_annotations = 0,
      properties = '{}',
      updated_time = '2022-12-04 11:53:05.489'
WHERE job_id = 'job1';
```

3. **è½¬æ¢æˆ `Monitor` å­—ç¬¦ä¸²**

```cs showLineNumbers
var monitor = jobDetail.ConvertToMonitor();
```

å­—ç¬¦ä¸²æ‰“å°å¦‚ä¸‹ï¼š

```bash showLineNumbers
â”â”â”â”â”â”â”â”â”â”â”â”  JobDetail â”â”â”â”â”â”â”â”â”â”â”
â”£ MyJob
â”£
â”£ jobIdï¼š                     job1
â”£ groupNameï¼š
â”£ jobTypeï¼š                   MyJob
â”£ assemblyNameï¼š              ConsoleApp13
â”£ descriptionï¼š
â”£ concurrentï¼š                True
â”£ includeAnnotationsï¼š        False
â”£ propertiesï¼š                {}
â”£ updatedTimeï¼š               2022-12-04 11:55:11.186
â”—â”â”â”â”â”â”â”â”â”â”â”  JobDetail â”â”â”â”â”â”â”â”â”â”â”
```

4. **ç®€è¦å­—ç¬¦ä¸²è¾“å‡º**

```cs showLineNumbers
var str = jobDetail.ToString();
```

å­—ç¬¦ä¸²æ‰“å°å¦‚ä¸‹ï¼š

```bash showLineNumbers
<job1> è¿™æ˜¯ä¸€æ®µæè¿° [C]
```

### 26.1.3.7 è‡ªå®šä¹‰ `SQL` è¾“å‡ºé…ç½®

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.2 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

```cs showLineNumbers {1,3,8,13,18}
services.AddSchedule(options =>
{
    options.JobDetail.ConvertToSQL = (tableName, columnNames, jobDetail, behavior, naming) =>
    {
      // ç”Ÿæˆæ–°å¢ SQL
      if (behavior == PersistenceBehavior.Appended)
      {
            return jobDetail.ConvertToInsertSQL(tableName, naming);
      }
      // ç”Ÿæˆæ›´æ–° SQL
      else if (behavior == PersistenceBehavior.Updated)
      {
            return jobDetail.ConvertToUpdateSQL(tableName, naming);
      }
      // ç”Ÿæˆåˆ é™¤ SQL
      else if (behavior == PersistenceBehavior.Removed)
      {
            return jobDetail.ConvertToDeleteSQL(tableName, naming);
      }

      return string.Empty;
    };
});
```

- `ConvertToSQL` å§”æ‰˜å‚æ•°è¯´æ˜
  - `tableName`ï¼šæ•°æ®åº“è¡¨åç§°ï¼Œ`string` ç±»å‹
  - `columnNames`ï¼šæ•°æ®åº“åˆ—åï¼š`string[]` ç±»å‹ï¼Œåªèƒ½é€šè¿‡ `ç´¢å¼•` è·å–
  - `jobDetail`ï¼šä½œä¸šä¿¡æ¯ `JobDetail` å¯¹è±¡
  - `behavior`ï¼šæŒä¹…åŒ– `PersistenceBehavior` ç±»å‹ï¼Œç”¨äºæ ‡è®° `æ–°å¢`ï¼Œ`æ›´æ–°` è¿˜æ˜¯ `åˆ é™¤` æ“ä½œ
  - `naming`ï¼šå‘½åæ³• `NamingConventions` ç±»å‹ï¼ŒåŒ…å« `CamelCaseï¼ˆé©¼å³°å‘½åæ³•ï¼‰`ï¼Œ`Pascalï¼ˆå¸•æ–¯å¡å‘½åæ³•ï¼‰` å’Œ `UnderScoreCaseï¼ˆä¸‹åˆ’çº¿å‘½åæ³•ï¼‰`

:::caution æ³¨æ„äº‹é¡¹

å¦‚æœåœ¨è¯¥è‡ªå®šä¹‰ `SQL` è¾“å‡ºæ–¹æ³•ä¸­è°ƒç”¨ `jobDetail.ConvertToSQL(..)` ä¼šå¯¼è‡´æ­»å¾ªç¯ã€‚

:::

### 26.1.3.8 å¯ç”¨ä½œä¸šæ‰§è¡Œæ—¥å¿—è¾“å‡º

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.3.7 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

é€šå¸¸æˆ‘ä»¬éœ€è¦åœ¨ `IJob` å®ç°ç±»ä¸­è¾“å‡ºä½œä¸šè§¦å‘æ—¥å¿—ï¼Œå¦‚ `_logger.LogInformation($"{context}");`

```cs showLineNumbers {11}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation($"{context}");
        return Task.CompletedTask;
    }
}
```

**ä½†è¿™æ ·çš„ `èŒƒå¼ä»£ç ` å‡ ä¹æ¯ä¸€ä¸ª `IJob` å®ç°ç±»éƒ½å¯èƒ½è¾“å‡º**ï¼Œæ‰€ä»¥åœ¨ `Furion 4.8.3.7+` ç‰ˆæœ¬æä¾›äº†æ›´ä¾¿æ·çš„é…ç½®ï¼Œæ— éœ€æ¯ä¸€ä¸ª `IJob` ç¼–å†™ `_logger.LogInformation($"{context}");`ã€‚

é…ç½®å¯ç”¨å¦‚ä¸‹ï¼š

```cs showLineNumbers {3}
services.AddSchedule(options =>
{
    options.JobDetail.LogEnabled = true;  // é»˜è®¤ false
});
```

ä¹‹å `MyJob` å¯ä»¥æ›´åŠ ç²¾ç®€äº†ï¼Œæ—¥å¿—ç±»åˆ«è‡ªåŠ¨è®¾ç½®ä¸º `MyJob` ç±»å‹å®Œæ•´é™å®šåã€‚

```cs showLineNumbers {5}
public class MyJob : IJob
{
    public Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        // è¿™é‡Œå†™ä¸šåŠ¡é€»è¾‘å³å¯ï¼Œæ— éœ€è°ƒç”¨ _logger.LogInformation($"{context}");
        return Task.CompletedTask;
    }
}
```

ä½œä¸šæ‰§è¡Œæ—¥å¿—å¦‚ä¸‹ï¼š

```bash showLineNumbers {1,3,5}
info: 2022-12-14 11:56:12.3963326 +08:00 æ˜ŸæœŸä¸‰ L Furion.Application.MyJob[0] #4
      <job1> [C] <job1 job1_trigger2> 5s 1ts 2022-12-14 11:56:08.361 -> 2022-12-14 11:56:13.366
info: 2022-12-14 11:56:13.4100745 +08:00 æ˜ŸæœŸä¸‰ L Furion.Application.MyJob[0] #6
      <job1> [C] <job1 job1_trigger2> 5s 2ts 2022-12-14 11:56:13.366 -> 2022-12-14 11:56:18.376
info: 2022-12-14 11:56:18.3931380 +08:00 æ˜ŸæœŸä¸‰ L Furion.Application.MyJob[0] #9
      <job1> [C] <job1 job1_trigger2> 5s 3ts 2022-12-14 11:56:18.376 -> 2022-12-14 11:56:23.360
```

## 26.1.4 ä½œä¸šå¤„ç†ç¨‹åº `IJob`

ä½œä¸šå¤„ç†ç¨‹åºæ˜¯ä½œä¸šç¬¦åˆè§¦å‘æ—¶é—´æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘ä»£ç ï¼Œé€šå¸¸ç”±ç¨‹åºå‘˜ç¼–å†™ï¼Œä½œä¸šå¤„ç†ç¨‹åºéœ€å®ç° `IJob` æ¥å£ã€‚

### 26.1.4.1 å¦‚ä½•å®šä¹‰

```cs showLineNumbers {1,3,5}
public class MyJob : IJob
{
    public Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        // your code...
    }
}
```

### 26.1.4.2 `JobExecutingContext` ä¸Šä¸‹æ–‡

`JobExecutingContext` ä¸Šä¸‹æ–‡ä½œä¸º `ExecuteAsync` æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ŒåŒ…å«ä»¥ä¸‹è¿è¡Œæ—¶ä¿¡æ¯ï¼š

- **`JobExecutingContext` å±æ€§åˆ—è¡¨**
  - `JobId`ï¼šä½œä¸š `Id`
  - `TriggerId`ï¼šå½“å‰è§¦å‘å™¨ `Id`
  - `JobDetail`ï¼šä½œä¸šä¿¡æ¯
  - `Trigger`ï¼šä½œä¸šè§¦å‘å™¨
  - `OccurrenceTime`ï¼šä½œä¸šè®¡åˆ’è§¦å‘æ—¶é—´ï¼Œæœ€å‡†ç¡®çš„è®°å½•æ—¶é—´
  - `ExecutingTime`ï¼šå®é™…æ‰§è¡Œæ—¶é—´ï¼ˆå¯èƒ½å­˜åœ¨è¯¯å·®ï¼‰
- **`JobExecutingContext` æ–¹æ³•åˆ—è¡¨**
  - `.ConvertToJSON(naming)`ï¼šå°†ä¸Šä¸‹æ–‡è½¬æ¢æˆ `JSON` å­—ç¬¦ä¸²
  - `.ToString()`ï¼šè¾“å‡ºä¸ºå­—ç¬¦ä¸²

### 26.1.4.3 ä¾èµ–æ³¨å…¥

å®ç° `IJob` çš„ä½œä¸šå¤„ç†ç¨‹åºç±»å‹é»˜è®¤æ³¨å†Œä¸º `å•ä¾‹`ï¼Œ**é‚£ä¹ˆåªè¦æ˜¯å•ä¾‹çš„æœåŠ¡ï¼Œçš†å¯ä»¥é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥**ï¼Œå¦‚ï¼š`ILogger<>`ï¼Œ`IConfiguration`ã€‚

```cs showLineNumbers {3-4,6-7}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    private readonly IConfiguration _configuration;

    public MyJob(ILogger<MyJob> logger
        , IConfiguration configuration)
    {
        _logger = logger;
        _configuration = configuration;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation($"{context} {_configuration["key"]}");
        await Task.CompletedTask;
    }
}
```

- **å¦‚æœæ˜¯é `å•ä¾‹` çš„æ¥å£ï¼Œå¦‚ `ç¬æ—¶` æˆ– `èŒƒå›´` æœåŠ¡ï¼Œå¯é€šè¿‡ `IServiceProvder` åˆ›å»º**

```cs showLineNumbers {5,9,18-19}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    private readonly IConfiguration _configuration;
    private readonly IServiceProvider _serviceProvider;

    public MyJob(ILogger<MyJob> logger
        , IConfiguration configuration
        , IServiceProvider serviceProvider)
    {
        _logger = logger;
        _configuration = configuration;
        _serviceProvider = serviceProvider;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        using var serviceScope = _serviceProvider.CreateScope();
        var repository = serviceScope.ServiceProvider.GetService<IRepository<User>>();

        _logger.LogInformation($"{context} {_configuration["key"]}");
        await Task.CompletedTask;
    }
}
```

- **é’ˆå¯¹é«˜é¢‘å®šæ—¶ä»»åŠ¡ï¼Œæ¯”å¦‚æ¯ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œæˆ–è€…æ›´é¢‘ç¹çš„ä»»åŠ¡**

ä¸ºäº†é¿å…é¢‘ç¹åˆ›å»ºä½œç”¨åŸŸå’Œé”€æ¯ä½œç”¨åŸŸï¼Œå¯åˆ›å»ºé•¿èŒƒå›´çš„ä½œç”¨åŸŸã€‚

```cs showLineNumbers {1,5,13,18,25,27}
public class MyJob : IJob, IDisposable
{
    private readonly ILogger<MyJob> _logger;
    private readonly IConfiguration _configuration;
    private readonly IServiceScope _serviceScope;

    public MyJob(ILogger<MyJob> logger
        , IConfiguration configuration
        , IServiceProvider serviceProvider)
    {
        _logger = logger;
        _configuration = configuration;
        _serviceScope = serviceProvider.CreateScope();
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        var repository = _serviceScope.ServiceProvider.GetService<IRepository<User>>();
        var user = await repository.GetAsync(1);

        _logger.LogInformation($"{context} {_configuration["key"]}");
        await Task.CompletedTask;
    }

    public void Dispose()
    {
        _serviceScope?.Dispose();
    }
}
```

### 26.1.4.4 åŠ¨æ€ä½œä¸š `DynamicJob`

æ¡†æ¶æä¾›äº†ä¾¿æ·çš„åŠ¨æ€ä½œä¸š `DynamicJob` ç±»å‹ï¼Œå¯é€šè¿‡ `Func<IServiceProvider, JobExecutingContext, CancellationToken, Task>` å§”æ‰˜ä¼ å…¥ï¼Œæ— éœ€åˆ›å»º `IJob` å®ç°ç±»å‹ã€‚

æ¡†æ¶è¿˜ä¸ºå§”æ‰˜çš„ç¬¬ä¸€ä¸ªå‚æ•° `IServiceProvder` æä¾›äº† `.GetLogger()` æ‹“å±•æ–¹æ³•ï¼Œæ–¹ä¾¿å¿«é€Ÿè·å– `ILogger<System.Logging.DynamicJob>` æ—¥å¿—å¯¹è±¡å®ä¾‹ã€‚

```cs showLineNumbers {2,9,18,26}
// é€šè¿‡ JobBuilder åˆ›å»º
var jobBuilder = JobBuilder.Create((serviceProvider, context, stoppingToken) =>
{
      serviceProvider.GetLogger().LogInformation($"{context}");
      return Task.CompletedTask;
});

// é€šè¿‡ jobBuilder æ–¹æ³• SetDynamicExecuteAsync åˆ›å»º
jobBuilder.SetDynamicExecuteAsync((serviceProvider, context, stoppingToken) =>
{
      serviceProvider.GetLogger().LogInformation($"{context}");
      return Task.CompletedTask;
});

// é€šè¿‡ AddJob åˆ›å»º
service.AddSchedule(options =>
{
      options.AddJob((serviceProvider, context, stoppingToken) =>
      {
            serviceProvider.GetLogger().LogInformation($"{context}");
            return Task.CompletedTask;
      }, Triggers.PeriodSeconds(5));
});

// é€šè¿‡ ISchedulerFactory åˆ›å»º
_schedulerFactory.AddJob((serviceProvider, context, stoppingToken) =>
{
      serviceProvider.GetLogger().LogInformation($"{context}");
      return Task.CompletedTask;
}, Triggers.PeriodSeconds(5));
```

åŠ¨æ€ä½œä¸šæ‰§è¡Œç»“æœï¼š

```bash showLineNumbers {6,8,10,11,13}
info: 2022-12-04 12:26:18.6562296 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is running.
info: 2022-12-04 12:26:18.6618404 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is preloading...
info: 2022-12-04 12:26:18.8727764 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      The <job1_trigger1> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-04 12:26:18.8745765 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      The scheduler of <job1> successfully appended to the schedule.
warn: 2022-12-04 12:26:18.9013540 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service preload completed, and a total of <1> schedulers are appended.
info: 2022-12-04 12:26:23.8753926 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.DynamicJob[0] #6
      <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-04 12:26:23.837 -> 2022-12-04 12:26:28.835
info: 2022-12-04 12:26:28.8686474 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.DynamicJob[0] #6
      <job1> [C] <job1 job1_trigger1> 5s 2ts 2022-12-04 12:26:28.835 -> 2022-12-04 12:26:33.823
info: 2022-12-04 12:26:33.8531796 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.DynamicJob[0] #13
      <job1> [C] <job1 job1_trigger1> 5s 3ts 2022-12-04 12:26:33.823 -> 2022-12-04 12:26:38.820
```

:::tip åŠ¨æ€ä½œä¸šå’Œæ™®é€šä½œä¸šçš„åŒºåˆ«

- åŠ¨æ€ä½œä¸šå¤„ç†ç¨‹åºç±»å‹æ˜¯ï¼š`DynamicJob` ç±»å‹
- åŠ¨æ€ä½œä¸šæä¾›çš„ `.GetLogger()` æ‹“å±•è¾“å‡ºæ—¥å¿—ç±»åˆ«æ˜¯ï¼š`System.Logging.DynamicJob`
- å¦‚æœæ™®é€šä½œä¸šåŒæ—¶è®¾ç½®äº† `SetJobType` å’Œ `SetDynamicExecuteAsync`ï¼Œé‚£ä¹ˆä¼˜å…ˆä½œä¸ºåŠ¨æ€ä½œä¸šæ‰§è¡Œã€‚
- åŠ¨æ€ä½œä¸šæ— æ³•å°† `Func<..>` è¿›è¡Œåºåˆ—åŒ–æŒä¹…åŒ–å­˜å‚¨ï¼Œéœ€åœ¨å†…å­˜ï¼ˆ`IJobPersistence.OnLoading`ï¼‰ä¸­é‡æ–°èµ‹å€¼

:::

### 26.1.4.5 ä½¿ç”¨ `Roslyn/Natasha` åŠ¨æ€åˆ›å»º

æŒ‰ç…§ç¨‹åºå¼€å‘çš„æ­£å¸¸æ€ç»´ï¼Œç†åº”å…ˆåœ¨ä»£ç ä¸­åˆ›å»ºä½œä¸šå¤„ç†ç¨‹åºç±»å‹ï¼Œä½†æˆ‘ä»¬å¯ä»¥å€ŸåŠ© `Roslyn` åŠ¨æ€ç¼–è¯‘ `C#` ä»£ç ã€‚

1. **ç¼–è¾‘å¯åŠ¨é¡¹ç›® `.csproj` æ–‡ä»¶ï¼Œæ·»åŠ  `<PreserveCompilationContext>true</PreserveCompilationContext>`**

```xml showLineNumbers {3}
<PropertyGroup>
      <TargetFramework>net7.0</TargetFramework>
      <PreserveCompilationContext>true</PreserveCompilationContext>
</PropertyGroup>
```

2. **å®‰è£… `DotNetCore.Natasha.CSharp` æ‹“å±•åŒ…**

[DotNetCore.Natasha.CSharp](https://github.com/dotnetcore/Natasha) æ˜¯å›½äººåŸºäº `Roslyn` å¼€å‘çš„éå¸¸å¼ºå¤§çš„åŠ¨æ€ç¼–è¯‘ `C#` åº“ã€‚

```bash showLineNumbers
dotnet add package DotNetCore.Natasha.CSharp
```

3. **æ ¹æ®å­—ç¬¦ä¸²åˆ›å»º `IJob` ç±»å‹**

```cs showLineNumbers {2,4,10-34,37}
// åˆå§‹åŒ–
NatashaInitializer.Preheating();
// åˆ›å»ºç¨‹åºé›†ï¼ˆå¯è‡ªå®šä¹‰ç¼–å†™ç¨‹åºé›†åç§°ï¼‰
var oop = new AssemblyCSharpBuilder("JobAssembly")
{
    Domain = DomainManagement.Random()
};

// æ·»åŠ ä»£ç 
oop.Add(@"
using Furion.Schedule;
using Microsoft.Extensions.Logging;
using System;
using System.Threading;
using System.Threading.Tasks;

namespace YourProject;

public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;

    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation($""æˆ‘æ˜¯ Roslyn æ–¹å¼åˆ›å»ºçš„ï¼š{context}"");
        await Task.CompletedTask;
    }
}
");

// ç”Ÿæˆè¿è¡Œæ—¶ MyJob ç±»å‹
var jobType = oop.GetTypeFromShortName("MyJob");
```

4. **æ³¨å†Œä½œä¸š**

```cs showLineNumbers {4,9}
// å¯ä»¥åœ¨å¯åŠ¨çš„æ—¶å€™æ·»åŠ 
services.AddSchedule(options =>
{
     options.AddJob(jobType
            , Triggers.PeriodSeconds(5));
});

// ä¹Ÿå¯ä»¥å®Œå…¨åœ¨è¿è¡Œæ—¶æ·»åŠ ï¼ˆå¸¸ç”¨ï¼‰
_schedulerFactory.AddJob(jobType
            , Triggers.PeriodSeconds(5));
```

æŸ¥çœ‹ä½œä¸šæ‰§è¡Œæ—¥å¿—ï¼š

```bash showLineNumbers {6,8,10,12,14,16}
info: 2022-12-04 12:38:00.6249410 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is running.
info: 2022-12-04 12:38:00.6294089 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is preloading...
info: 2022-12-04 12:38:00.7496005 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      The <job1_trigger1> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-04 12:38:00.7514579 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      The scheduler of <job1> successfully appended to the schedule.
warn: 2022-12-04 12:38:00.7836777 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service preload completed, and a total of <1> schedulers are appended.
info: 2022-12-04 12:38:05.7389682 +08:00 æ˜ŸæœŸæ—¥ L YourProject.MyJob[0] #6
      æˆ‘æ˜¯ Roslyn æ–¹å¼åˆ›å»ºçš„ï¼š<job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-04 12:38:05.713 -> 2022-12-04 12:38:10.692
info: 2022-12-04 12:38:10.7108416 +08:00 æ˜ŸæœŸæ—¥ L YourProject.MyJob[0] #11
      æˆ‘æ˜¯ Roslyn æ–¹å¼åˆ›å»ºçš„ï¼š<job1> [C] <job1 job1_trigger1> 5s 2ts 2022-12-04 12:38:10.692 -> 2022-12-04 12:38:15.673
info: 2022-12-04 12:38:15.6925578 +08:00 æ˜ŸæœŸæ—¥ L YourProject.MyJob[0] #11
      æˆ‘æ˜¯ Roslyn æ–¹å¼åˆ›å»ºçš„ï¼š<job1> [C] <job1 job1_trigger1> 5s 3ts 2022-12-04 12:38:15.673 -> 2022-12-04 12:38:20.656
```

**æƒŠä¸æƒŠå–œï¼Œæ„å¤–æ„å¤–~**ã€‚

:::tip å°çŸ¥è¯†

é€šè¿‡ `Roslyn` çš„æ–¹å¼æ”¯æŒåˆ›å»º `IJob`ï¼Œ`JobDetail`ï¼Œ`Trigger`ï¼Œ`Scheduler` å“¦ï¼Œè‡ªè¡Œæµ‹è¯•ã€‚ğŸ˜Š

:::

### 26.1.4.6 ä½œä¸šè°ƒåº¦å™¨è¢«å–æ¶ˆå¤„ç†

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä½œä¸šè°ƒåº¦å™¨æ„å¤–å…³é—­æˆ–æ‰‹åŠ¨å…³é—­ï¼Œä½†ä½œä¸šå¤„ç†ç¨‹åºå¼‚æ­¥æ“ä½œè¿˜æœªå¤„ç†å®Œæˆï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥é€‰æ‹©å–æ¶ˆè¿˜æ˜¯ç»§ç»­æ‰§è¡Œï¼Œå¦‚æœé€‰æ‹©å–æ¶ˆï¼š

```cs showLineNumbers {15,19,23,30}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation($"{context}");

        try
        {
            await SomeMethodAsync(stoppingToken);
        }
        catch (TaskCanceledException)
        {
            _logger.LogWarning("ä½œä¸šè¢«å–æ¶ˆäº†~");
        }
        catch (AggregateException ex) when (ex.InnerExceptions.Count == 1 && ex.InnerExceptions[0] is TaskCanceledException)
        {
            _logger.LogWarning("ä½œä¸šè¢«å–æ¶ˆäº†~");
        }
    }

    private async Task SomeMethodAsync(CancellationToken stoppingToken)
    {
        // æ¨¡æ‹Ÿè€—æ—¶
        await Task.Delay(1000 * 60 * 60, stoppingToken);
    }
}
```

è¿™æ ·å½“ä½œä¸šè°ƒåº¦å™¨è¢«å…³é—­æ—¶ï¼Œ`SomeMethodAsync` å¦‚æœæœªå¤„ç†å®Œæˆä¹Ÿä¼šå–æ¶ˆæ“ä½œã€‚

```bash showLineNumbers {14,16,18,20}
info: 2022-12-04 12:49:00.2636929 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is running.
info: 2022-12-04 12:49:00.2686096 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is preloading...
info: 2022-12-04 12:49:00.4252737 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      The <job1_trigger1> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-04 12:49:00.4266075 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      The scheduler of <job1> successfully appended to the schedule.
warn: 2022-12-04 12:49:00.4468654 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service preload completed, and a total of <1> schedulers are appended.
info: 2022-12-04 12:49:05.4397629 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #4
      <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-04 12:49:05.390 -> 2022-12-04 12:49:10.393
info: 2022-12-04 12:49:08.6301592 +08:00 æ˜ŸæœŸæ—¥ L Microsoft.Hosting.Lifetime[0] #14
      Application is shutting down...
warn: 2022-12-04 12:49:08.7247004 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #6
      ä½œä¸šè¢«å–æ¶ˆäº†~
warn: 2022-12-04 12:49:10.4257861 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #6
      Schedule hosted service cancels hibernation and GC.Collect().
crit: 2022-12-04 12:49:10.4360088 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #6
      Schedule hosted service is stopped.
```

## 26.1.5 ä½œä¸šè§¦å‘å™¨ `Trigger` åŠæ„å»ºå™¨

### 26.1.5.1 å…³äºä½œä¸šè§¦å‘å™¨

æ¡†æ¶æä¾›äº† `Trigger` ç±»å‹æ¥æè¿°ä½œä¸šå…·ä½“çš„è§¦å‘æ—¶é—´ï¼Œ`Trigger` ç±»å‹æä¾›ä»¥ä¸‹**åªè¯»å±æ€§**ï¼š

| å±æ€§å              | å±æ€§ç±»å‹        | é»˜è®¤å€¼  | è¯´æ˜                                                                 |
| ------------------- | --------------- | ------- | -------------------------------------------------------------------- |
| `TriggerId`         | `string`        |         | ä½œä¸šè§¦å‘å™¨ `Id`                                                      |
| `JobId`             | `string`        |         | ä½œä¸š `Id`                                                            |
| `TriggerType`       | `string`        |         | ä½œä¸šè§¦å‘å™¨ç±»å‹ï¼Œå­˜å‚¨çš„æ˜¯ç±»å‹çš„ `FullName`                            |
| `AssemblyName`      | `string`        |         | ä½œä¸šè§¦å‘å™¨ç±»å‹æ‰€åœ¨ç¨‹åºé›†ï¼Œå­˜å‚¨çš„æ˜¯ç¨‹åºé›† `Name`                      |
| `Args`              | `string`        |         | ä½œä¸šè§¦å‘å™¨å‚æ•°ï¼Œè¿è¡Œæ—¶å°†ååºåˆ—åŒ–ä¸º `object[]` ç±»å‹å¹¶ä½œä¸ºæ„é€ å‡½æ•°å‚æ•° |
| `Description`       | `string`        |         | æè¿°ä¿¡æ¯                                                             |
| `Status`            | `TriggerStatus` | `Ready` | ä½œä¸šè§¦å‘å™¨çŠ¶æ€                                                       |
| `StartTime`         | `DateTime?`     |         | èµ·å§‹æ—¶é—´                                                             |
| `EndTime`           | `DateTime?`     |         | ç»“æŸæ—¶é—´                                                             |
| `LastRunTime`       | `DateTime?`     |         | æœ€è¿‘è¿è¡Œæ—¶é—´                                                         |
| `NextRunTime`       | `DateTime?`     |         | ä¸‹ä¸€æ¬¡è¿è¡Œæ—¶é—´                                                       |
| `NumberOfRuns`      | `long`          | `0`     | è§¦å‘æ¬¡æ•°                                                             |
| `MaxNumberOfRuns`   | `long`          | `0`     | æœ€å¤§è§¦å‘æ¬¡æ•°ï¼Œ`0`ï¼šä¸é™åˆ¶ï¼Œ`n`ï¼šN æ¬¡                                 |
| `NumberOfErrors`    | `long`          | `0`     | å‡ºé”™æ¬¡æ•°                                                             |
| `MaxNumberOfErrors` | `long`          | `0`     | æœ€å¤§å‡ºé”™æ¬¡æ•°ï¼Œ`0`ï¼šä¸é™åˆ¶ï¼Œ`n`ï¼šN æ¬¡                                 |
| `NumRetries`        | `int`           | `0`     | é‡è¯•æ¬¡æ•°                                                             |
| `RetryTimeout`      | `int`           | `1000`  | é‡è¯•é—´éš”æ—¶é—´ï¼Œæ¯«ç§’å•ä½                                               |
| `StartNow`          | `bool`          | `true`  | æ˜¯å¦ç«‹å³å¯åŠ¨                                                         |
| `RunOnStart`        | `bool`          | `false` | æ˜¯å¦å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡                                                   |
| `ResetOnlyOnce`     | `bool`          | `true`  | æ˜¯å¦åœ¨å¯åŠ¨æ—¶é‡ç½®æœ€å¤§è§¦å‘æ¬¡æ•°ç­‰äºä¸€æ¬¡çš„ä½œä¸š                           |
| `UpdatedTime`       | `DateTime?`     |         | ä½œä¸šè§¦å‘å™¨æ›´æ–°æ—¶é—´                                                   |

### 26.1.5.2 ä½œä¸šè§¦å‘å™¨çŠ¶æ€

ä½œä¸šè§¦å‘å™¨çŠ¶æ€æŒ‡ç¤ºäº†å½“å‰ä½œä¸šè§¦å‘å™¨çš„çŠ¶æ€ï¼Œä½¿ç”¨ `TriggerStatus` æšä¸¾ç±»å‹ï¼ˆ`uint`ï¼‰ï¼Œè¯¥ç±»å‹åŒ…å«ä»¥ä¸‹æšä¸¾æˆå‘˜ã€‚

| æšä¸¾å         | æšä¸¾å€¼ | è¯´æ˜                                                         |
| -------------- | ------ | ------------------------------------------------------------ |
| `Backlog`      | `0`    | ç§¯å‹ï¼Œèµ·å§‹æ—¶é—´å¤§äºå½“å‰æ—¶é—´                                   |
| `Ready`        | `1`    | å°±ç»ª                                                         |
| `Running`      | `2`    | æ­£åœ¨è¿è¡Œ                                                     |
| `Pause`        | `3`    | æš‚åœ                                                         |
| `Blocked`      | `4`    | é˜»å¡ï¼Œæœ¬è¯¥æ‰§è¡Œä½†æ˜¯æ²¡æœ‰æ‰§è¡Œ                                   |
| `ErrorToReady` | `5`    | ç”±å¤±è´¥è¿›å…¥å°±ç»ªï¼Œè¿è¡Œé”™è¯¯å½“å¹¶æœªè¶…å‡ºæœ€å¤§é”™è¯¯æ•°ï¼Œè¿›å…¥ä¸‹ä¸€è½®å°±ç»ª |
| `Archived`     | `6`    | å½’æ¡£ï¼Œç»“æŸæ—¶é—´å°äºå½“å‰æ—¶é—´                                   |
| `Panic`        | `7`    | å´©æºƒï¼Œé”™è¯¯æ¬¡æ•°è¶…å‡ºäº†æœ€å¤§é”™è¯¯æ•°                               |
| `Overrun`      | `8`    | è¶…é™ï¼Œè¿è¡Œæ¬¡æ•°è¶…å‡ºäº†æœ€å¤§é™åˆ¶                                 |
| `Unoccupied`   | `9`    | æ— è§¦å‘æ—¶é—´ï¼Œä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´ä¸º `null`                          |
| `NotStart`     | `10`   | åˆå§‹åŒ–æ—¶æœªå¯åŠ¨                                               |
| `Unknown`      | `11`   | æœªçŸ¥ä½œä¸šè§¦å‘å™¨ï¼Œä½œä¸šè§¦å‘å™¨è¿è¡Œæ—¶ç±»å‹ä¸º `null`                |
| `Unhandled`    | `12`   | æœªçŸ¥ä½œä¸šå¤„ç†ç¨‹åºï¼Œä½œä¸šå¤„ç†ç¨‹åºç±»å‹è¿è¡Œæ—¶ç±»å‹ä¸º `null`        |

### 26.1.5.3 å…³äºä½œä¸šè§¦å‘å™¨æ„å»ºå™¨

ä½œä¸šè§¦å‘å™¨ `Trigger` æ˜¯ä½œä¸šè°ƒåº¦æ¨¡å—æä¾›è¿è¡Œæ—¶çš„**åªè¯»ç±»å‹**ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•åˆ›å»ºæˆ–å˜æ›´ `Trigger` å¯¹è±¡å‘¢ï¼Ÿ

`TriggerBuilder` æ˜¯ä½œä¸šè°ƒåº¦æ¨¡å—æä¾›å¯ç”¨æ¥ç”Ÿæˆè¿è¡Œæ—¶ `Trigger` çš„ç±»å‹ï¼Œè¿™æ ·åšçš„å¥½å¤„å¯é¿å…å¤–éƒ¨ç›´æ¥ä¿®æ”¹è¿è¡Œæ—¶ `Trigger` æ•°æ®ï¼Œè¿˜èƒ½å®ç°ä»»ä½•ä¿®æ”¹åŠ¨ä½œç›‘å¬ï¼Œä¹Ÿèƒ½é¿å…å¤šçº¿ç¨‹æŠ¢å æƒ…å†µã€‚

ä½œä¸šè°ƒåº¦æ¨¡å—æä¾›äº†å¤šç§æ–¹å¼ç”¨æ¥åˆ›å»º `TriggerBuilder` å¯¹è±¡ã€‚

1. **é€šè¿‡ `Create` é™æ€æ–¹æ³•åˆ›å»º**

```cs showLineNumbers {2,5,8,11,14,17,20}
// æ ¹æ®ä½œä¸šè§¦å‘å™¨ Id åˆ›å»º
var triggerBuilder = TriggerBuilder.Create("trigger1");

// æ ¹æ® Trigger æ´¾ç”Ÿç±»ç±»å‹åˆ›å»º
var triggerBuilder = TriggerBuilder.Create<PeriodTrigger>();

// æ ¹æ® Trigger æ´¾ç”Ÿç±»ç±»å‹ + æ„é€ å‡½æ•°å‚æ•°åˆ›å»º
var triggerBuilder = TriggerBuilder.Create<CronTrigger>("* * * * *", CronStringFormat.Default);

// æ ¹æ®ç¨‹åºé›†åç§°å’Œç±»å‹å®Œå…¨é™å®šåï¼ˆFullNameï¼‰åˆ›å»º
var triggerBuilder = TriggerBuilder.Create("Furion", "Furion.Schedule.PeriodTrigger");

// æ ¹æ®ç¨‹åºé›†åç§°å’Œç±»å‹å®Œå…¨é™å®šåï¼ˆFullNameï¼‰ + æ„é€ å‡½æ•°å‚æ•°åˆ›å»º
var triggerBuilder = TriggerBuilder.Create("Furion", "Furion.Schedule.PeriodTrigger", 1000);

// æ ¹æ® Type ç±»å‹åˆ›å»º
var triggerBuilder = TriggerBuilder.Create(typeof(PeriodTrigger));

// æ ¹æ® Type ç±»å‹ + æ„é€ å‡½æ•°å‚æ•°åˆ›å»º
var triggerBuilder = TriggerBuilder.Create(typeof(CronTrigger), "* * * * *", CronStringFormat.Default);
```

2. **é€šè¿‡ `Trigger` ç±»å‹åˆ›å»º**

è¿™ç§æ–¹å¼å¸¸ç”¨äºåœ¨è¿è¡Œæ—¶æ›´æ–°ä½œä¸šè§¦å‘å™¨ã€‚

```cs showLineNumbers
var triggerBuilder = TriggerBuilder.From(trigger);

//ä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼
var triggerBuilder = trigger.GetBuilder();
```

3. **é€šè¿‡ `JSON` å­—ç¬¦ä¸²åˆ›å»º**

è¯¥æ–¹å¼éå¸¸çµæ´»ï¼Œå¯ä»é…ç½®æ–‡ä»¶ï¼Œ`JSON` å­—ç¬¦ä¸²ï¼Œæˆ–å…¶ä»–èƒ½å¤Ÿè¿”å› `JSON` å­—ç¬¦ä¸²çš„åœ°æ–¹åˆ›å»ºã€‚

```cs showLineNumbers {2-24}
var triggerBuilder = Triggers.From(@"
{
	""triggerId"": ""job1_trigger1"",
	""jobId"": ""job1"",
	""triggerType"": ""Furion.Schedule.CronTrigger"",
	""assemblyName"": ""Furion"",
	""args"": ""[\""* * * * *\"",0]"",
	""description"": null,
	""status"": 1,
	""startTime"": null,
	""endTime"": null,
	""lastRunTime"": ""2022-12-04 16:13:00.000"",
	""nextRunTime"": null,
	""numberOfRuns"": 1,
	""maxNumberOfRuns"": 0,
	""numberOfErrors"": 0,
	""maxNumberOfErrors"": 0,
	""numRetries"": 0,
	""retryTimeout"": 1000,
	""startNow"": true,
	""runOnStart"": false,
	""resetOnlyOnce"": true,
	""updatedTime"": ""2022-12-04 16:13:00.045""
}");
```

å¦‚æœä½¿ç”¨çš„æ˜¯ `.NET7`ï¼Œå¯ä½¿ç”¨ `"""` é¿å…è½¬ä¹‰ï¼Œå¦‚ï¼š

```cs showLineNumbers {2-24}
var triggerBuilder = Triggers.From("""
{
      "triggerId": "job1_trigger1",
      "jobId": "job1",
      "triggerType": "Furion.Schedule.CronTrigger",
      "assemblyName": "Furion",
      "args": "[\"* * * * *\",0]",
      "description": null,
      "status": 8,
      "startTime": null,
      "endTime": null,
      "lastRunTime": "2022-12-04 16:13:00.000",
      "nextRunTime": null,
      "numberOfRuns": 1,
      "maxNumberOfRuns": 0,
      "numberOfErrors": 0,
      "maxNumberOfErrors": 0,
      "numRetries": 0,
      "retryTimeout": 1000,
      "startNow": true,
      "runOnStart": false,
      "resetOnlyOnce": true,
      "updatedTime": "2022-12-04 16:13:00.045"
}
""");
```

:::important å…³äºå±æ€§ååŒ¹é…è§„åˆ™

æ”¯æŒ `CamelCaseï¼ˆé©¼å³°å‘½åæ³•ï¼‰`ï¼Œ`Pascalï¼ˆå¸•æ–¯å¡å‘½åæ³•ï¼‰` å‘½åæ–¹å¼ã€‚

**ä¸æ”¯æŒ `UnderScoreCaseï¼ˆä¸‹åˆ’çº¿å‘½åæ³•ï¼‰`** ï¼Œå¦‚ `"include_annotations": true`

:::

4. **è¿˜å¯ä»¥é€šè¿‡ `Clone` é™æ€æ–¹æ³•ä»ä¸€ä¸ª `TriggerBuilder` åˆ›å»º**

```cs showLineNumbers
var triggerBuilder = TriggerBuilder.Clone(fromTriggerBuilder);
```

:::important å…‹éš†è¯´æ˜

å…‹éš†æ“ä½œåªä¼šå…‹éš† `AssemblyName`ï¼Œ`TriggerType`ï¼Œ`Args`ï¼Œ`Description`ï¼Œ`StartTime`ï¼Œ`EndTime`ï¼Œ`MaxNumberOfRuns`ï¼Œ`MaxNumberOfErrors`ï¼Œ`NumRetries`ï¼Œ`RetryTimeout`ï¼Œ`StartNow`ï¼Œ`RunOnStart`ï¼Œ`ResetOnlyOnce`ã€‚

**ä¸ä¼šå…‹éš† `TriggerId`ï¼Œ`JobId`ï¼Œ`Status`ï¼Œ`LastRunTime`ï¼Œ`NextRunTime`ï¼Œ`NumberOfRuns`ï¼Œ`NumberOfErrors`ï¼Œ`UpdatedTime`ã€‚**

:::

5. **è¿˜å¯ä»¥é€šè¿‡ `LoadFrom` å®ä¾‹æ–¹æ³•å¡«å……å½“å‰çš„ `TriggerBuilder`**

æ¯”å¦‚å¯ä»¥ä¼ é€’åŒ¿åç±»å‹ï¼Œç±»ç±»å‹ï¼Œå­—å…¸ `Dictionary<string, object>` ç±»å‹ï¼š

```cs showLineNumbers {2,9,16,23}
// ä¼šè¦†ç›–æ‰€æœ‰ç›¸åŒçš„å€¼
triggerBuilder.LoadFrom(new
{
      Description = "æˆ‘æ˜¯æè¿°",
      StartTime = DateTime.Now
});

// æ”¯æŒå¤šä¸ªå¡«å……ï¼Œè¿˜å¯ä»¥é…ç½®è·³è¿‡ null å€¼è¦†ç›–
triggerBuilder.LoadFrom(new
{
      Description = "æˆ‘æ˜¯å¦å¤–ä¸€ä¸ªæè¿°",
      StartTime = default(object),
}, ignoreNullValue: true);

// æ”¯æŒå¿½ç•¥ç‰¹å®šå±æ€§åæ˜ å°„
triggerBuilder.LoadFrom(new
{
      Description = "æˆ‘æ˜¯å¦å¤–ä¸€ä¸ªæè¿°",
      TriggerId = "trigger1"
}, ignorePropertyNames: new[]{ "description" });

// æ”¯æŒå­—å…¸ç±»å‹
triggerBuilder.LoadFrom(new Dictionary<string, object>
{
      {"Description", "è¿™æ˜¯æ–°çš„æè¿°" },
      {"updatedTime", DateTime.Now }
});
```

:::important å…³äºå±æ€§ååŒ¹é…è§„åˆ™

æ”¯æŒ `CamelCaseï¼ˆé©¼å³°å‘½åæ³•ï¼‰`ï¼Œ`Pascalï¼ˆå¸•æ–¯å¡å‘½åæ³•ï¼‰` å’Œ `UnderScoreCaseï¼ˆä¸‹åˆ’çº¿å‘½åæ³•ï¼‰` å‘½åæ–¹å¼ã€‚

:::

### 26.1.5.4 å†…ç½®ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨

ä¸ºäº†æ–¹ä¾¿å¿«é€Ÿå®ç°ä½œä¸šè§¦å‘å™¨ï¼Œä½œä¸šè°ƒåº¦æ¨¡å—å†…ç½®äº† `Periodï¼ˆé—´éš”ï¼‰` å’Œ `Cronï¼ˆè¡¨è¾¾å¼ï¼‰` ä½œä¸šè§¦å‘å™¨ï¼Œå¯é€šè¿‡ `TriggerBuilder` ç±»å‹æˆ– `Triggers` é™æ€ç±»åˆ›å»ºã€‚

- **`TriggerBuilder` æ–¹å¼**

```c showLineNumbers {2,5}
// åˆ›å»ºæ¯«ç§’å‘¨æœŸï¼ˆé—´éš”ï¼‰ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = TriggerBuilder.Period(5000);

// åˆ›å»º Cron è¡¨è¾¾å¼ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = TriggerBuilder.Cron("* * * * *", CronStringFormat.Default);
```

- **`Triggers` æ–¹å¼ï¼Œâ¤ï¸ æ¨è**

`Triggers` é™æ€ç±»å…·å¤‡ `TriggerBuilder` æ‰€æœ‰çš„é™æ€æ–¹æ³•åŒæ—¶è¿˜æ·»åŠ äº†ä¸å°‘æ›´åŠ ä¾¿æ·çš„é™æ€æ–¹æ³•ã€‚

```cs showLineNumbers {1,11,31}
// é—´éš” Period æ–¹å¼
// åˆ›å»ºæ¯«ç§’å‘¨æœŸï¼ˆé—´éš”ï¼‰ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.Period(5000);
// åˆ›å»ºç§’å‘¨æœŸï¼ˆé—´éš”ï¼‰ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.PeriodSeconds(5);
// åˆ›å»ºåˆ†é’Ÿå‘¨æœŸï¼ˆé—´éš”ï¼‰ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.PeriodMinutes(5);
// åˆ›å»ºå°æ—¶å‘¨æœŸï¼ˆé—´éš”ï¼‰ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.PeriodHours(5);

// Cron è¡¨è¾¾å¼æ–¹å¼
// åˆ›å»º Cron è¡¨è¾¾å¼ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.Cron("* * * * *", CronStringFormat.Default);
// åˆ›å»ºæ¯ç§’å¼€å§‹ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.Secondly();
// åˆ›å»ºæ¯åˆ†é’Ÿå¼€å§‹ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.Minutely();
// åˆ›å»ºæ¯å°æ—¶å¼€å§‹ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.Hourly();
// åˆ›å»ºæ¯å¤©ï¼ˆåˆå¤œï¼‰å¼€å§‹ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.Daily();
// åˆ›å»ºæ¯æœˆ1å·ï¼ˆåˆå¤œï¼‰å¼€å§‹ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.Monthly();
// åˆ›å»ºæ¯å‘¨æ—¥ï¼ˆåˆå¤œï¼‰å¼€å§‹ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.Weekly();
// åˆ›å»ºæ¯å¹´1æœˆ1å·ï¼ˆåˆå¤œï¼‰å¼€å§‹ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.Yearly();
// åˆ›å»ºæ¯å‘¨ä¸€è‡³å‘¨äº”ï¼ˆåˆå¤œï¼‰å¼€å§‹ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.Workday();

// Cron è¡¨è¾¾å¼ Macro At æ–¹å¼
// æ¯ç¬¬ 3 ç§’
var triggerBuilder = Triggers.SecondlyAt(3);
// æ¯ç¬¬ 3ï¼Œ5ï¼Œ6 ç§’
var triggerBuilder = Triggers.SecondlyAt(3, 5, 6);

// æ¯åˆ†é’Ÿç¬¬ 3 ç§’
var triggerBuilder = Triggers.MinutelyAt(3);
// æ¯åˆ†é’Ÿç¬¬ 3ï¼Œ5ï¼Œ6 ç§’
var triggerBuilder = Triggers.MinutelyAt(3, 5, 6);

// æ¯å°æ—¶ç¬¬ 3 åˆ†é’Ÿ
var triggerBuilder = Triggers.HourlyAt(3);
// æ¯å°æ—¶ç¬¬ 3ï¼Œ5ï¼Œ6 åˆ†é’Ÿ
var triggerBuilder = Triggers.HourlyAt(3, 5, 6);

// æ¯å¤©ç¬¬ 3 å°æ—¶æ­£ï¼ˆç‚¹ï¼‰
var triggerBuilder = Triggers.DailyAt(3);
// æ¯å¤©ç¬¬ 3ï¼Œ5ï¼Œ6 å°æ—¶æ­£ï¼ˆç‚¹ï¼‰
var triggerBuilder = Triggers.DailyAt(3, 5, 6);

// æ¯æœˆç¬¬ 3 å¤©é›¶ç‚¹æ­£
var triggerBuilder = Triggers.MonthlyAt(3);
// æ¯æœˆç¬¬ 3ï¼Œ5ï¼Œ6 å¤©é›¶ç‚¹æ­£
var triggerBuilder = Triggers.MonthlyAt(3, 5, 6);

// æ¯å‘¨æ˜ŸæœŸ 3 é›¶ç‚¹æ­£
var triggerBuilder = Triggers.WeeklyAt(3);
var triggerBuilder = Triggers.WeeklyAt("WED");  // SUNï¼ˆæ˜ŸæœŸå¤©ï¼‰ï¼ŒMONï¼ŒTUEï¼ŒWEDï¼ŒTHUï¼ŒFRIï¼ŒSAT
// æ¯å‘¨æ˜ŸæœŸ 3ï¼Œ5ï¼Œ6 é›¶ç‚¹æ­£
var triggerBuilder = Triggers.WeeklyAt(3, 5, 6);
var triggerBuilder = Triggers.WeeklyAt("WED", "FRI", "SAT");
// è¿˜æ”¯æŒæ··åˆ
var triggerBuilder = Triggers.WeeklyAt(3, "FRI", 6);

// æ¯å¹´ç¬¬ 3 æœˆ 1 æ—¥é›¶ç‚¹æ­£
var triggerBuilder = Triggers.YearlyAt(3);
var triggerBuilder = Triggers.YearlyAt("MAR");  // JANï¼ˆä¸€æœˆï¼‰ï¼ŒFEBï¼ŒMARï¼ŒAPRï¼ŒMAYï¼ŒJUNï¼ŒJULï¼ŒAUGï¼ŒSEPï¼ŒOCTï¼ŒNOVï¼ŒDEC
// æ¯å¹´ç¬¬ 3ï¼Œ5ï¼Œ6 æœˆ 1 æ—¥é›¶ç‚¹æ­£
var triggerBuilder = Triggers.YearlyAt(3);
var triggerBuilder = Triggers.YearlyAt(3, 5, 6);
var triggerBuilder = Triggers.YearlyAt("MAR", "MAY", "JUN");
// è¿˜æ”¯æŒæ··åˆ
var triggerBuilder = Triggers.YearlyAt(3, "MAY", 6);
```

### 26.1.5.5 è‡ªå®šä¹‰ä½œä¸šè§¦å‘å™¨

é™¤äº†ä½¿ç”¨æ¡†æ¶æä¾›çš„ `PeriodTrigger` å’Œ `CronTrigger` ä»¥å¤–ï¼Œè¿˜å¯ä»¥è‡ªå®šä¹‰ä½œä¸šè§¦å‘å™¨ï¼Œåªéœ€è¦ç»§æ‰¿ `Trigger` å¹¶é‡å†™ `GetNextOccurrence` æ–¹æ³•å³å¯ï¼Œå¦‚å®ç°ä¸€ä¸ªé—´éš”ä¸¤ç§’çš„ä½œä¸šè§¦å‘å™¨ã€‚

```cs showLineNumbers {1,3,5}
public class CustomTrigger : Trigger
{
    public override DateTime GetNextOccurrence(DateTime startAt)
    {
        return startAt.AddSeconds(2);
    }
}
```

ä¹‹åå¯é€šè¿‡ `TriggerBuilder.Create` æˆ– `Triggers.Create` åˆ›å»ºå³å¯ï¼š

```cs showLineNumbers {3}
services.AddSchedule(options =>
{
    options.AddJob<MyJob>(Triggers.Create<CustomTrigger>());
});
```

æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœï¼š

```bash showLineNumbers {12,14,16}
info: 2022-12-04 17:19:25.0980531 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is running.
info: 2022-12-04 17:19:25.1027083 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is preloading...
info: 2022-12-04 17:19:25.2702054 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      The <job1_trigger1> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-04 17:19:25.2723418 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      The scheduler of <job1> successfully appended to the schedule.
warn: 2022-12-04 17:19:25.2999295 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service preload completed, and a total of <1> schedulers are appended.
info: 2022-12-04 17:19:27.2849015 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #8
      <job1> [C] <job1 job1_trigger1> 1ts 2022-12-04 17:19:27.234 -> 2022-12-04 17:19:29.232
info: 2022-12-04 17:19:29.2604639 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #4
      <job1> [C] <job1 job1_trigger1> 2ts 2022-12-04 17:19:29.232 -> 2022-12-04 17:19:31.225
info: 2022-12-04 17:19:31.2422514 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #10
      <job1> [C] <job1 job1_trigger1> 3ts 2022-12-04 17:19:31.225 -> 2022-12-04 17:19:33.207
```

**å¦å¤–ï¼Œè‡ªå®šä¹‰ä½œä¸šè§¦å‘å™¨è¿˜æ”¯æŒé…ç½®æ„é€ å‡½æ•°å‚æ•°**

:::important å‚æ•°ç‰¹åˆ«è¯´æ˜

å¦‚æœè‡ªå®šä¹‰ä½œä¸šè§¦å‘å™¨åŒ…å«å‚æ•°ï¼Œé‚£ä¹ˆ**å¿…é¡»æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶**ï¼š

- **å‚æ•°å¿…é¡»é€šè¿‡å”¯ä¸€çš„æ„é€ å‡½æ•°ä¼ å…¥ï¼Œæœ‰ä¸”æœ€å¤šåªèƒ½æ‹¥æœ‰ä¸€ä¸ªæ„é€ å‡½æ•°**
- **å‚æ•°çš„ç±»å‹åªèƒ½æ˜¯ `int`ï¼Œ`string`ï¼Œ`bool`ï¼Œ`null` æˆ–ç”±å®ƒä»¬ç»„æˆçš„æ•°ç»„ç±»å‹**

:::

```cs showLineNumbers {1,3,5,8,12}
public class CustomTrigger : Trigger
{
    public CustomTrigger(int seconds) // å¯æ”¯æŒå¤šä¸ªå‚æ•°
    {
        Seconds = seconds;
    }

    private int Seconds { get; set; }

    public override DateTime GetNextOccurrence(DateTime startAt)
    {
        return startAt.AddSeconds(Seconds);
    }
}
```

ä¹‹åå¯é€šè¿‡ `TriggerBuilder.Create` æˆ– `Triggers.Create` åˆ›å»ºå¹¶ä¼ å…¥å‚æ•°ã€‚

```cs showLineNumbers {3}
services.AddSchedule(options =>
{
      options.AddJob<MyJob>(Triggers.Create<CustomTrigger>(3));
});
```

æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœï¼š

```bash showLineNumbers {12,14,16}
info: 2022-12-04 17:23:09.3029251 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is running.
info: 2022-12-04 17:23:09.3205593 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is preloading...
info: 2022-12-04 17:23:09.7081119 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      The <job1_trigger1> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-04 17:23:09.7506504 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      The scheduler of <job1> successfully appended to the schedule.
warn: 2022-12-04 17:23:09.9380816 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service preload completed, and a total of <1> schedulers are appended.
info: 2022-12-04 17:23:12.6291716 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #6
      <job1> [C] <job1 job1_trigger1> 1ts 2022-12-04 17:23:12.590 -> 2022-12-04 17:23:15.582
info: 2022-12-04 17:23:15.6141563 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #9
      <job1> [C] <job1 job1_trigger1> 2ts 2022-12-04 17:23:15.582 -> 2022-12-04 17:23:18.572
info: 2022-12-04 17:23:18.5857464 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #8
      <job1> [C] <job1 job1_trigger1> 3ts 2022-12-04 17:23:18.572 -> 2022-12-04 17:23:21.551
```

è‡ªå®šä¹‰ä½œä¸šè§¦å‘å™¨é™¤äº†å¯é‡å†™ `GetNextOccurrence` æ–¹æ³•ä¹‹åï¼Œè¿˜æä¾›äº† `ShouldRun` å’Œ `ToString` æ–¹æ³•å¯é‡å†™ï¼Œå¦‚ï¼š

```cs showLineNumbers {15,21}
public class CustomTrigger : Trigger
{
    public CustomTrigger(int seconds)
    {
        Seconds = seconds;
    }

    private int Seconds { get; set; }

    public override DateTime GetNextOccurrence(DateTime startAt)
    {
        return startAt.AddSeconds(Seconds);
    }

    public override bool ShouldRun(JobDetail jobDetail, DateTime startAt)
    {
        // åœ¨è¿™é‡Œè¿›ä¸€æ­¥æ§åˆ¶ï¼Œå¦‚æœè¿”å› falseï¼Œåˆ™ä½œä¸šè§¦å‘å™¨è·³è¿‡æ‰§è¡Œ
        return base.ShouldRun(jobDetail, startAt);
    }

    public override string ToString()
    {
        return $"<{TriggerId}> è‡ªå®šä¹‰é€’å¢ {Seconds}s è§¦å‘å™¨";
    }
}
```

æ¨èé‡å†™ `GetNextRunTime` å’Œ `ToString` æ–¹æ³•å³å¯ï¼Œå¦‚ï¼š

```cs showLineNumbers {11}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation($"{context}");
        await Task.CompletedTask;
    }
}
```

æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœï¼š

```bash showLineNumbers {12,14,16}
info: 2022-12-04 17:26:43.9120082 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is running.
info: 2022-12-04 17:26:43.9166481 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is preloading...
info: 2022-12-04 17:26:44.1786114 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      The <job1_trigger1> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-04 17:26:44.1816154 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      The scheduler of <job1> successfully appended to the schedule.
warn: 2022-12-04 17:26:44.2077386 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service preload completed, and a total of <1> schedulers are appended.
info: 2022-12-04 17:26:47.1904549 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #8
      <job1> [C] <job1_trigger1> è‡ªå®šä¹‰é€’å¢ 3s è§¦å‘å™¨ 2022-12-04 17:26:47.139 -> 2022-12-04 17:26:50.145
info: 2022-12-04 17:26:50.1652618 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #6
      <job1> [C] <job1_trigger1> è‡ªå®šä¹‰é€’å¢ 3s è§¦å‘å™¨ 2022-12-04 17:26:50.145 -> 2022-12-04 17:26:53.129
info: 2022-12-04 17:26:53.1426614 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #8
      <job1> [C] <job1_trigger1> è‡ªå®šä¹‰é€’å¢ 3s è§¦å‘å™¨ 2022-12-04 17:26:53.129 -> 2022-12-04 17:26:56.106
```

### 26.1.5.6 ä½œä¸šè§¦å‘å™¨ç‰¹æ€§åŠè‡ªå®šä¹‰

å¦‚æœ `JobBuilder` é…ç½®äº† `IncludeAnnotations` å‚æ•°ä¸”ä¸º `true`ï¼Œé‚£ä¹ˆå°†ä¼šè‡ªåŠ¨è§£æ `IJob` çš„å®ç°ç±»å‹çš„æ‰€æœ‰ç»§æ‰¿ `TriggerAttribute` çš„ç‰¹æ€§ï¼Œç›®å‰ä½œä¸šè°ƒåº¦æ¨¡å—å†…ç½®äº†ä»¥ä¸‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§ï¼š

- `[Period(5000)]`ï¼šæ¯«ç§’å‘¨æœŸï¼ˆé—´éš”ï¼‰ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[PeriodSeconds(5)]`ï¼šç§’å‘¨æœŸï¼ˆé—´éš”ï¼‰ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[PeriodMinutes(5)]`ï¼šåˆ†é’Ÿå‘¨æœŸï¼ˆé—´éš”ï¼‰ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[PeriodHours(5)]`ï¼šå°æ—¶å‘¨æœŸï¼ˆé—´éš”ï¼‰ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[Cron("* * * * *", CronStringFormat.Default)]`ï¼šCron è¡¨è¾¾å¼ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[Secondly]`ï¼šæ¯ç§’å¼€å§‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[Minutely]`ï¼šæ¯åˆ†é’Ÿå¼€å§‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[Hourly]`ï¼šæ¯å°æ—¶å¼€å§‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[Daily]`ï¼šæ¯å¤©ï¼ˆåˆå¤œï¼‰å¼€å§‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[Monthly]`ï¼šæ¯æœˆ 1 å·ï¼ˆåˆå¤œï¼‰å¼€å§‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[Weekly]`ï¼šæ¯å‘¨æ—¥ï¼ˆåˆå¤œï¼‰å¼€å§‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[Yearly]`ï¼šæ¯å¹´ 1 æœˆ 1 å·ï¼ˆåˆå¤œï¼‰å¼€å§‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[Workday]`ï¼šæ¯å‘¨ä¸€è‡³å‘¨äº”ï¼ˆåˆå¤œï¼‰å¼€å§‹è§¦å‘å™¨ç‰¹æ€§
- `[SecondlyAt]`ï¼šç‰¹å®šç§’å¼€å§‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[MinutelyAt]`ï¼šæ¯åˆ†é’Ÿç‰¹å®šç§’å¼€å§‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[HourlyAt]`ï¼šæ¯å°æ—¶ç‰¹å®šåˆ†é’Ÿå¼€å§‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[DailyAt]`ï¼šæ¯å¤©ç‰¹å®šå°æ—¶å¼€å§‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[MonthlyAt]`ï¼šæ¯æœˆç‰¹å®šå¤©ï¼ˆåˆå¤œï¼‰å¼€å§‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[WeeklyAt]`ï¼šæ¯å‘¨ç‰¹å®šæ˜ŸæœŸå‡ ï¼ˆåˆå¤œï¼‰å¼€å§‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[YearlyAt]`ï¼šæ¯å¹´ç‰¹å®šæœˆ 1 å·ï¼ˆåˆå¤œï¼‰å¼€å§‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§

ä½¿ç”¨å¦‚ä¸‹ï¼š

```cs showLineNumbers {3,6,10,13}
services.AddSchedule(options =>
{
    options.AddJob(JobBuilder.Create<MyJob>().SetIncludeAnnotations(true));

    // ä¹Ÿæ”¯æŒè‡ªå®šä¹‰é…ç½® + ç‰¹æ€§æ‰«æ
    options.AddJob(JobBuilder.Create<MyJob>().SetIncludeAnnotations(true)
                  , Triggers.PeriodSeconds(5));

    // æˆ–è€…é€šè¿‡ç±»å‹æ‰«æ
    options.AddJob(typeof(MyJobj).ScanToBuilder());

    // è¿˜å¯ä»¥æ‰¹é‡æ‰«æ Furion 4.8.2.4+
    options.AddJob(App.EffectiveTypes.ScanToBuilders());
});
```

```cs showLineNumbers {1-3}
[Minutely]
[PeriodSeconds(5)]
[Cron("*/3 * * * * *", CronStringFormat.WithSeconds)]
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation($"{context}");
        await Task.CompletedTask;
    }
}
```

æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœï¼š

```bash showLineNumbers {6,8,10,12,16,18,20,30}
info: 2022-12-04 17:35:47.0211372 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is running.
info: 2022-12-04 17:35:47.0267027 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is preloading...
info: 2022-12-04 17:35:47.2906591 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      The <job1_trigger1> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-04 17:35:47.2921849 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      The <job1_trigger2> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-04 17:35:47.2961669 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      The <job1_trigger3> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-04 17:35:47.2979859 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      The scheduler of <job1> successfully appended to the schedule.
warn: 2022-12-04 17:35:47.3194555 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service preload completed, and a total of <1> schedulers are appended.
info: 2022-12-04 17:35:48.0588231 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #8
      <job1> [C] <job1 job1_trigger3> */3 * * * * * 1ts 2022-12-04 17:35:48.000 -> 2022-12-04 17:35:51.000
info: 2022-12-04 17:35:51.0240459 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #9
      <job1> [C] <job1 job1_trigger3> */3 * * * * * 2ts 2022-12-04 17:35:51.000 -> 2022-12-04 17:35:54.000
info: 2022-12-04 17:35:52.2643935 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #12
      <job1> [C] <job1 job1_trigger2> 5s 1ts 2022-12-04 17:35:52.246 -> 2022-12-04 17:35:57.227
info: 2022-12-04 17:35:54.0175524 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #6
      <job1> [C] <job1 job1_trigger3> */3 * * * * * 3ts 2022-12-04 17:35:54.000 -> 2022-12-04 17:35:57.000
info: 2022-12-04 17:35:57.0270544 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #9
      <job1> [C] <job1 job1_trigger3> */3 * * * * * 4ts 2022-12-04 17:35:57.000 -> 2022-12-04 17:36:00.000
info: 2022-12-04 17:35:57.2433514 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #12
      <job1> [C] <job1 job1_trigger2> 5s 2ts 2022-12-04 17:35:57.227 -> 2022-12-04 17:36:02.208
info: 2022-12-04 17:36:00.0151605 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #14
      <job1> [C] <job1 job1_trigger3> */3 * * * * * 5ts 2022-12-04 17:36:00.000 -> 2022-12-04 17:36:03.000
info: 2022-12-04 17:36:00.0315972 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #8
      <job1> [C] <job1 job1_trigger1> * * * * * 1ts 2022-12-04 17:36:00.000 -> 2022-12-04 17:37:00.000
info: 2022-12-04 17:36:02.2203934 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #12
      <job1> [C] <job1 job1_trigger2> 5s 3ts 2022-12-04 17:36:02.208 -> 2022-12-04 17:36:07.184
```

---

**é™¤äº†ä½¿ç”¨å†…ç½®ç‰¹æ€§ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰ä½œä¸šè§¦å‘å™¨ç‰¹æ€§**ï¼Œå¦‚ï¼š

```cs showLineNumbers {1,2,5}
[AttributeUsage(AttributeTargets.Class, AllowMultiple = true)]
public class CustomAttribute : TriggerAttribute
{
    public CustomAttribute(int seconds)
        : base(typeof(CustomTrigger), seconds)
    {
    }
}
```

:::tip è‡ªå®šä¹‰ä½œä¸šè§¦å‘å™¨å¿…å¤‡æ¡ä»¶

- å¿…é¡»ç»§æ‰¿ `TriggerAttribute` ç‰¹æ€§ç±»
- è‡³å°‘åŒ…å«ä¸€ä¸ªæ„é€ å‡½æ•°ä¸”é€šè¿‡åŸºç±»æ„é€ å‡½æ•°é…ç½® `:base(å®é™…è§¦å‘å™¨ç±»å‹, æ„é€ å‡½æ•°å‚æ•°)`
- æ¨èæ·»åŠ  `[AttributeUsage(AttributeTargets.Class, AllowMultiple = true)]` ç‰¹æ€§

:::

ä½¿ç”¨å¦‚ä¸‹ï¼š

```cs showLineNumbers {1}
[Custom(3)]
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation($"{context}");
        await Task.CompletedTask;
    }
}
```

æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœï¼š

```bash showLineNumbers {12,14,16}
info: 2022-12-04 17:44:12.2702884 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is running.
info: 2022-12-04 17:44:12.2872399 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is preloading...
info: 2022-12-04 17:44:12.5730241 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      The <job1_trigger1> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-04 17:44:12.5751444 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      The scheduler of <job1> successfully appended to the schedule.
warn: 2022-12-04 17:44:12.6174459 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service preload completed, and a total of <1> schedulers are appended.
info: 2022-12-04 17:44:15.5850848 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #6
      <job1> [C] <job1_trigger1> è‡ªå®šä¹‰é€’å¢ 3s è§¦å‘å™¨ 2022-12-04 17:44:15.537 -> 2022-12-04 17:44:18.542
info: 2022-12-04 17:44:18.5693881 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #8
      <job1> [C] <job1_trigger1> è‡ªå®šä¹‰é€’å¢ 3s è§¦å‘å™¨ 2022-12-04 17:44:18.542 -> 2022-12-04 17:44:21.527
info: 2022-12-04 17:44:21.5396428 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #6
      <job1> [C] <job1_trigger1> è‡ªå®šä¹‰é€’å¢ 3s è§¦å‘å™¨ 2022-12-04 17:44:21.527 -> 2022-12-04 17:44:24.504
```

---

**ä½œä¸šè§¦å‘å™¨ç‰¹æ€§è¿˜æä¾›äº†å¤šä¸ªå±æ€§é…ç½®**ï¼Œå¦‚ï¼š

- `TriggerId`ï¼šä½œä¸šè§¦å‘å™¨ `Id`ï¼Œ`string` ç±»å‹
- `Description`ï¼šæè¿°ä¿¡æ¯ï¼Œ`string` ç±»å‹
- `StartTime`ï¼šèµ·å§‹æ—¶é—´ï¼Œ`string` ç±»å‹
- `EndTime`ï¼šç»“æŸæ—¶é—´ï¼Œ`string` ç±»å‹
- `MaxNumberOfRuns`ï¼šæœ€å¤§è§¦å‘æ¬¡æ•°ï¼Œ`long` ç±»å‹ï¼Œ`0`ï¼šä¸é™åˆ¶ï¼›`n`ï¼šN æ¬¡
- `MaxNumberOfErrors`ï¼šæœ€å¤§å‡ºé”™æ¬¡æ•°ï¼Œ`long` ç±»å‹ï¼Œ`0`ï¼šä¸é™åˆ¶ï¼›`n`ï¼šN æ¬¡
- `NumRetries`ï¼šé‡è¯•æ¬¡æ•°ï¼Œ`int` ç±»å‹ï¼Œé»˜è®¤å€¼ `0`
- `RetryTimeout`ï¼šé‡è¯•é—´éš”æ—¶é—´ï¼Œ`int` ç±»å‹ï¼Œé»˜è®¤å€¼ `1000`
- `StartNow`ï¼šæ˜¯å¦ç«‹å³å¯åŠ¨ï¼Œ`bool` ç±»å‹ï¼Œé»˜è®¤å€¼ `true`
- `RunOnStart`ï¼šæ˜¯å¦å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œ`bool` ç±»å‹ï¼Œé»˜è®¤å€¼ `false`
- `ResetOnlyOnce`ï¼šæ˜¯å¦åœ¨å¯åŠ¨æ—¶é‡ç½®æœ€å¤§è§¦å‘æ¬¡æ•°ç­‰äºä¸€æ¬¡çš„ä½œä¸šï¼Œ`bool` ç±»å‹ï¼Œé»˜è®¤å€¼ `true`

ä½¿ç”¨å¦‚ä¸‹ï¼š

```cs showLineNumbers {1}
[PeriodSeconds(5, TriggerId = "trigger1", Description = "è¿™æ˜¯ä¸€æ®µæè¿°")]
public class MyJob : IJob
{
      // ...
}
```

### 26.1.5.7 è®¾ç½®ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨

`TriggerBuilder` æä¾›äº†å’Œ `Trigger` å®Œå…¨åŒ¹é…çš„ `Set[å±æ€§å]` æ–¹æ³•æ¥é…ç½®ä½œä¸šè§¦å‘å™¨å„ä¸ªå±æ€§ï¼Œå¦‚ï¼š

```cs showLineNumbers {3,27}
 services.AddSchedule(options =>
 {
     var triggerBuilder = Triggers.Period(5000)
         .SetTriggerId("trigger1")   // ä½œä¸šè§¦å‘å™¨ Id
         .SetTriggerType("Furion", "Furion.Schedule.PeriodTrigger")  // ä½œä¸šè§¦å‘å™¨ç±»å‹ï¼Œæ”¯æŒå¤šä¸ªé‡è½½
         .SetTriggerType<PeriodTrigger>()    // ä½œä¸šè§¦å‘å™¨ç±»å‹ï¼Œæ”¯æŒå¤šä¸ªé‡è½½
         .SetTriggerType(typeof(PeriodTrigger))  // ä½œä¸šè§¦å‘å™¨ç±»å‹ï¼Œæ”¯æŒå¤šä¸ªé‡è½½
         .SetArgs("[5000]")  // ä½œä¸šè§¦å‘å™¨å‚æ•° object[] åºåˆ—åŒ–å­—ç¬¦ä¸²ç±»å‹ï¼Œæ”¯æŒå¤šä¸ªé‡è½½
         .SetArgs(5000)   // ä½œä¸šè§¦å‘å™¨å‚æ•°ï¼Œæ”¯æŒå¤šä¸ªé‡è½½
         .SetDescription("ä½œä¸šè§¦å‘å™¨æè¿°")  // ä½œä¸šè§¦å‘å™¨æè¿°
         .SetStatus(TriggerStatus.Ready) // ä½œä¸šè§¦å‘å™¨çŠ¶æ€
         .SetStartTime(DateTime.Now) // ä½œä¸šè§¦å‘å™¨èµ·å§‹æ—¶é—´
         .SetEndTime(DateTime.Now.AddMonths(1)) // ä½œä¸šè§¦å‘å™¨ç»“æŸæ—¶é—´
         .SetLastRunTime(DateTime.Now.AddSeconds(-5))    // ä½œä¸šè§¦å‘å™¨æœ€è¿‘è¿è¡Œæ—¶é—´
         .SetNextRunTime(DateTime.Now.AddSeconds(5)) // ä½œä¸šè§¦å‘å™¨ä¸‹ä¸€æ¬¡è¿è¡Œæ—¶é—´
         .SetNumberOfRuns(1) // ä½œä¸šè§¦å‘å™¨è§¦å‘æ¬¡æ•°
         .SetMaxNumberOfRuns(100)    // ä½œä¸šè§¦å‘å™¨æœ€å¤§è§¦å‘å™¨æ¬¡æ•°
         .SetNumberOfErrors(1)   // ä½œä¸šè§¦å‘å™¨å‡ºé”™æ¬¡æ•°
         .SetMaxNumberOfErrors(100)  // ä½œä¸šè§¦å‘å™¨æœ€å¤§å‡ºé”™æ¬¡æ•°
         .SetNumRetries(3)   // ä½œä¸šè§¦å‘å™¨å‡ºé”™é‡è¯•æ¬¡æ•°
         .SetRetryTimeout(1000)  // ä½œä¸šè§¦å‘å™¨é‡è¯•é—´éš”æ—¶é—´
         .SetStartNow(true)  // ä½œä¸šè§¦å‘å™¨æ˜¯å¦ç«‹å³å¯åŠ¨
         .SetRunOnStart(false)    // ä½œä¸šè§¦å‘å™¨æ˜¯å¦å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡
         .SetResetOnlyOnce(true)    // ä½œä¸šè§¦å‘å™¨æ˜¯å¦åœ¨å¯åŠ¨æ—¶é‡ç½®æœ€å¤§è§¦å‘æ¬¡æ•°ç­‰äºä¸€æ¬¡çš„ä½œä¸š
         ;

     options.AddJob<MyJob>(triggerBuilder);
 });
```

### 26.1.5.8 ä½œä¸šè§¦å‘å™¨æŒä¹…åŒ–æ–¹æ³•

ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨ `TriggerBuilder` æä¾›äº†ä¸‰ä¸ªæ ‡è®°ä½œä¸šæŒä¹…åŒ–è¡Œä¸ºçš„æ–¹æ³•ï¼š

- `Appended()`ï¼šæ ‡è®°ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨æ˜¯æ–°å¢çš„ï¼Œå±Šæ—¶ç”Ÿæˆçš„ `SQL` æ˜¯ `INSERT` è¯­å¥
- `Updated()`ï¼šæ ‡è®°ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨å·²è¢«æ›´æ–°ï¼Œå±Šæ—¶ç”Ÿæˆçš„ `SQL` æ˜¯ `Updated` è¯­å¥ï¼Œå¦‚æœæ ‡è®°ä¸ºæ­¤æ“ä½œï¼Œé‚£ä¹ˆå½“å‰ä½œä¸šè°ƒåº¦å™¨åˆå§‹åŒ–æ—¶å°†æ–°å¢è‡³å†…å­˜ä¸­
- `Removed()`ï¼šæ ‡è®°ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨å·²è¢«åˆ é™¤ï¼Œå±Šæ—¶ç”Ÿæˆçš„ `SQL` æ˜¯ `Deleted` è¯­å¥ï¼Œå¦‚æœæ ‡è®°ä¸ºæ­¤æ“ä½œï¼Œé‚£ä¹ˆå½“å‰ä½œä¸šè°ƒåº¦å™¨åˆå§‹åŒ–æ—¶å°†ä¸ä¼šæ·»åŠ è‡³ä½œä¸šè®¡åˆ’ä¸­

```cs showLineNumbers {4-6}
 services.AddSchedule(options =>
{
      options.AddJob<MyJob>(
            Triggers.PeriodSeconds(5).SetTriggerId("trigger1").Appended()
            , Triggers.PeriodSeconds(5).SetTriggerId("trigger2").Updated()
            , Triggers.PeriodSeconds(5).SetTriggerId("trigger3").Removed());
});
```

æŸ¥çœ‹ä½œä¸šè°ƒåº¦å™¨åˆå§‹åŒ–æ—¥å¿—ï¼š

```bash showLineNumbers {6,8,10,16,18}
info: 2022-12-04 18:29:22.3997873 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is running.
info: 2022-12-04 18:29:22.4045304 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is preloading...
info: 2022-12-04 18:29:22.5473237 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      The <trigger3> trigger for scheduler of <job1> successfully removed to the schedule.
info: 2022-12-04 18:29:22.5504289 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      The <trigger1> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-04 18:29:22.5521396 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      The <trigger2> trigger for scheduler of <job1> successfully appended and updated to the schedule.
info: 2022-12-04 18:29:22.5535657 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      The scheduler of <job1> successfully appended to the schedule.
warn: 2022-12-04 18:29:22.5896298 +08:00 æ˜ŸæœŸæ—¥ L System.Logging.ScheduleService[0] #1
      Schedule hosted service preload completed, and a total of <1> schedulers are appended.
info: 2022-12-04 18:29:27.5981907 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #14
      <job1> [C] <job1 trigger2> 5s 1ts 2022-12-04 18:29:27.507 -> 2022-12-04 18:29:32.500
info: 2022-12-04 18:29:27.6002420 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #15
      <job1> [C] <job1 trigger1> 5s 1ts 2022-12-04 18:29:27.507 -> 2022-12-04 18:29:32.500
info: 2022-12-04 18:29:32.5850223 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #12
      <job1> [C] <job1 trigger2> 5s 2ts 2022-12-04 18:29:32.500 -> 2022-12-04 18:29:37.548
info: 2022-12-04 18:29:32.6034646 +08:00 æ˜ŸæœŸæ—¥ L MyJob[0] #8
      <job1> [C] <job1 trigger1> 5s 2ts 2022-12-04 18:29:32.500 -> 2022-12-04 18:29:37.548
```

### 26.1.5.9 å¤šç§æ ¼å¼å­—ç¬¦ä¸²è¾“å‡º

`Trigger` å’Œ `TriggerBuilder` éƒ½æä¾›äº†å¤šç§å°†è‡ªèº«è½¬æ¢æˆç‰¹å®šæ ¼å¼çš„å­—ç¬¦ä¸²ã€‚

1. **è½¬æ¢æˆ `JSON` å­—ç¬¦ä¸²**

```cs showLineNumbers
var json = trigger.ConvertToJSON();
```

å­—ç¬¦ä¸²æ‰“å°å¦‚ä¸‹ï¼š

```json showLineNumbers
{
  "triggerId": "job1_trigger1",
  "jobId": "job1",
  "triggerType": "Furion.Schedule.PeriodTrigger",
  "assemblyName": "Furion",
  "args": "[5000]",
  "description": null,
  "status": 2,
  "startTime": null,
  "endTime": null,
  "lastRunTime": "2022-12-04 17:52:34.768",
  "nextRunTime": "2022-12-04 17:52:39.769",
  "numberOfRuns": 1,
  "maxNumberOfRuns": 0,
  "numberOfErrors": 0,
  "maxNumberOfErrors": 0,
  "numRetries": 0,
  "retryTimeout": 1000,
  "startNow": true,
  "runOnStart": false,
  "resetOnlyOnce": true,
  "updatedTime": "2022-12-04 17:52:34.803"
}
```

2. **è½¬æ¢æˆ `SQL` å­—ç¬¦ä¸²**

```cs showLineNumbers {2,6,9,13,16,20}
// è¾“å‡ºæ–°å¢ SQLï¼Œä½¿ç”¨ CamelCase å±æ€§å‘½å
var insertSql = trigger.ConvertToSQL("tbName"
      , PersistenceBehavior.Appended
      , NamingConventions.CamelCase);
// æ›´ä¾¿æ·æ‹“å±•
var insertSql = trigger.ConvertToInsertSQL("tbName", NamingConventions.CamelCase);

// è¾“å‡ºåˆ é™¤ SQLï¼Œä½¿ç”¨ Pascal å±æ€§å‘½å
var deleteSql = trigger.ConvertToSQL("tbName"
      , PersistenceBehavior.Removed
      , NamingConventions.Pascal);
// æ›´ä¾¿æ·æ‹“å±•
var deleteSql = trigger.ConvertToDeleteSQL("tbName", NamingConventions.Pascal);

// è¾“å‡ºæ›´æ–° SQLï¼Œä½¿ç”¨ UnderScoreCase å±æ€§å‘½å
var updateSql = trigger.ConvertToSQL("tbName"
      , PersistenceBehavior.Updated
      , NamingConventions.UnderScoreCase);
// æ›´ä¾¿æ·æ‹“å±•
var updateSql = trigger.ConvertToUpdateSQL("tbName", NamingConventions.UnderScoreCase);
```

å­—ç¬¦ä¸²æ‰“å°å¦‚ä¸‹ï¼š

```sql showLineNumbers {2,49,52}
-- æ–°å¢æ“ä½œ
INSERT INTO tbName(
      triggerId,
      jobId,
      triggerType,
      assemblyName,
      args,
      description,
      status,
      startTime,
      endTime,
      lastRunTime,
      nextRunTime,
      numberOfRuns,
      maxNumberOfRuns,
      numberOfErrors,
      maxNumberOfErrors,
      numRetries,
      retryTimeout,
      startNow,
      runOnStart,
      resetOnlyOnce,
      updatedTime
)
VALUES(
      'job1_trigger1',
      'job1',
      'Furion.Schedule.PeriodTrigger',
      'Furion',
      '[5000]',
      NULL,
      2,
      NULL,
      NULL,
      '2022-12-04 17:54:42.693',
      '2022-12-04 17:54:47.721',
      1,
      0,
      0,
      0,
      0,
      1000,
      1,
      0,
      1,
      '2022-12-04 17:54:42.754'
);
-- åˆ é™¤æ“ä½œ
DELETE FROM tbName
WHERE TriggerId = 'job1_trigger1' AND JobId = 'job1';
-- æ›´æ–°æ“ä½œ
UPDATE tbName
SET
      trigger_id = 'job1_trigger1',
      job_id = 'job1',
      trigger_type = 'Furion.Schedule.PeriodTrigger',
      assembly_name = 'Furion',
      args = '[5000]',
      description = NULL,
      status = 2,
      start_time = NULL,
      end_time = NULL,
      last_run_time = '2022-12-04 17:54:42.693',
      next_run_time = '2022-12-04 17:54:47.721',
      number_of_runs = 1,
      max_number_of_runs = 0,
      number_of_errors = 0,
      max_number_of_errors = 0,
      num_retries = 0,
      retry_timeout = 1000,
      start_now = 1,
      run_on_start = 0,
      reset_only_once = 1,
      updated_time = '2022-12-04 17:54:42.754'
WHERE trigger_id = 'job1_trigger1' AND job_id = 'job1';
```

3. **è½¬æ¢æˆ `Monitor` å­—ç¬¦ä¸²**

```cs showLineNumbers
var monitor = trigger.ConvertToMonitor();
```

å­—ç¬¦ä¸²æ‰“å°å¦‚ä¸‹ï¼š

```bash showLineNumbers
â”â”â”â”â”â”â”â”â”â”â”â”  Trigger â”â”â”â”â”â”â”â”â”â”â”
â”£ Furion.Schedule.PeriodTrigger
â”£
â”£ triggerIdï¼š                job1_trigger1
â”£ jobIdï¼š                    job1
â”£ triggerTypeï¼š              Furion.Schedule.PeriodTrigger
â”£ assemblyNameï¼š             Furion
â”£ argsï¼š                     [5000]
â”£ descriptionï¼š
â”£ statusï¼š                   Running
â”£ startTimeï¼š
â”£ endTimeï¼š
â”£ lastRunTimeï¼š              2022-12-04 17:56:55.384
â”£ nextRunTimeï¼š              2022-12-04 17:57:00.379
â”£ numberOfRunsï¼š             1
â”£ maxNumberOfRunsï¼š          0
â”£ numberOfErrorsï¼š           0
â”£ maxNumberOfErrorsï¼š        0
â”£ numRetriesï¼š               0
â”£ retryTimeoutï¼š             1000
â”£ startNowï¼š                 True
â”£ runOnStartï¼š               False
â”£ resetOnlyOnceï¼š            True
â”£ updatedTimeï¼š              2022-12-04 17:56:55.413
â”—â”â”â”â”â”â”â”â”â”â”â”  Trigger â”â”â”â”â”â”â”â”â”â”â”
```

4. **ç®€è¦å­—ç¬¦ä¸²è¾“å‡º**

```cs showLineNumbers
var str = trigger.ToString();
```

å­—ç¬¦ä¸²æ‰“å°å¦‚ä¸‹ï¼š

```bash showLineNumbers
<job1 job1_trigger1> 5s è¿™æ˜¯ä¸€æ®µæè¿° 1ts
```

### 26.1.5.10 è‡ªå®šä¹‰ `SQL` è¾“å‡ºé…ç½®

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.2 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

```cs showLineNumbers {1,3,8,13,18}
services.AddSchedule(options =>
{
    options.Trigger.ConvertToSQL = (tableName, columnNames, trigger, behavior, naming) =>
    {
      // ç”Ÿæˆæ–°å¢ SQL
      if (behavior == PersistenceBehavior.Appended)
      {
            return trigger.ConvertToInsertSQL(tableName, naming);
      }
      // ç”Ÿæˆæ›´æ–° SQL
      else if (behavior == PersistenceBehavior.Updated)
      {
            return trigger.ConvertToUpdateSQL(tableName, naming);
      }
      // ç”Ÿæˆåˆ é™¤ SQL
      else if (behavior == PersistenceBehavior.Removed)
      {
            return trigger.ConvertToDeleteSQL(tableName, naming);
      }

      return string.Empty;
    };
});
```

- `ConvertToSQL` å§”æ‰˜å‚æ•°è¯´æ˜
  - `tableName`ï¼šæ•°æ®åº“è¡¨åç§°ï¼Œ`string` ç±»å‹
  - `columnNames`ï¼šæ•°æ®åº“åˆ—åï¼š`string[]` ç±»å‹ï¼Œåªèƒ½é€šè¿‡ `ç´¢å¼•` è·å–
  - `trigger`ï¼šä½œä¸šä¿¡æ¯ `Trigger` å¯¹è±¡
  - `behavior`ï¼šæŒä¹…åŒ– `PersistenceBehavior` ç±»å‹ï¼Œç”¨äºæ ‡è®°æ–°å¢ï¼Œæ›´æ–°è¿˜æ˜¯åˆ é™¤æ“ä½œ
  - `naming`ï¼šå‘½åæ³• `NamingConventions` ç±»å‹ï¼ŒåŒ…å« `CamelCaseï¼ˆé©¼å³°å‘½åæ³•ï¼‰`ï¼Œ`Pascalï¼ˆå¸•æ–¯å¡å‘½åæ³•ï¼‰` å’Œ `UnderScoreCaseï¼ˆä¸‹åˆ’çº¿å‘½åæ³•ï¼‰`

:::caution æ³¨æ„äº‹é¡¹

å¦‚æœåœ¨è¯¥è‡ªå®šä¹‰ `SQL` è¾“å‡ºæ–¹æ³•ä¸­è°ƒç”¨ `trigger.ConvertToSQL(..)` ä¼šå¯¼è‡´æ­»å¾ªç¯ã€‚

:::

### 26.1.5.11 æŸ¥çœ‹æœ€è¿‘è¿è¡Œè®°å½•

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.4.3 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

åœ¨ `Furion 4.8.4.3+` ç‰ˆæœ¬æ–°å¢äº† `GetTimelines()` æ–¹æ³•ï¼Œå¯è·å–å†…å­˜ä¸­ä½œä¸šè§¦å‘å™¨æœ€è¿‘è¿è¡Œçš„ `10` æ¡è®°å½•ï¼Œå¦‚ï¼š

```cs showLineNumbers
var timelines = trigger.GetTimelines();   // => [{numberOfRuns: 2, lastRunTime: "2023-01-03 14:00:08"}, {numberOfRuns: 1, lastRunTime: "2023-01-03 14:00:03"}, ...]
```

## 26.1.6 ä½œä¸šè®¡åˆ’ `Scheduler` åŠæ„å»ºå™¨

### 26.1.6.1 å…³äºä½œä¸šè®¡åˆ’

æ‰€è°“çš„ä½œä¸šè®¡åˆ’ï¼ˆ`Scheduler`ï¼‰æ˜¯å°†ä½œä¸šä¿¡æ¯(`JobDetail`ï¼‰ï¼Œä½œä¸šè§¦å‘å™¨ï¼ˆ`Trigger`ï¼‰å’Œä½œä¸šå¤„ç†ç¨‹åºï¼ˆ`IJob`ï¼‰å…³è”èµ·æ¥ï¼Œå¹¶æ·»åŠ åˆ°ä½œä¸šè°ƒåº¦å™¨ä¸­ç­‰å¾…è°ƒåº¦æ‰§è¡Œã€‚

ä½œä¸ºè®¡åˆ’ï¼ˆ`Scheduler`ï¼‰ç±»å‹å¯¹å¤–æ˜¯ä¸å…¬å¼€çš„ï¼Œä½†æä¾›äº†å¯¹åº”çš„ `IScheduler` æ¥å£è¿›è¡Œæ“ä½œã€‚

### 26.1.6.2 å…³äºä½œä¸šè®¡åˆ’æ„å»ºå™¨

ä½œä¸šè®¡åˆ’ `Scheduler` æ˜¯æ¡†æ¶æä¾›è¿è¡Œæ—¶çš„**å†…éƒ¨åªè¯»ç±»å‹**ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•åˆ›å»ºæˆ–å˜æ›´ `Scheduler` å¯¹è±¡å‘¢ï¼Ÿ

`SchedulerBuilder` æ˜¯æ¡†æ¶æä¾›å¯ç”¨æ¥ç”Ÿæˆè¿è¡Œæ—¶ `Scheduler` çš„ç±»å‹ï¼Œè¿™æ ·åšçš„å¥½å¤„å¯é¿å…å¤–éƒ¨ç›´æ¥ä¿®æ”¹è¿è¡Œæ—¶ `Scheduler` æ•°æ®ï¼Œè¿˜èƒ½å®ç°ä»»ä½•ä¿®æ”¹åŠ¨ä½œç›‘å¬ï¼Œä¹Ÿèƒ½é¿å…å¤šçº¿ç¨‹æŠ¢å æƒ…å†µã€‚

ä½œä¸šè°ƒåº¦æ¨¡å—æä¾›äº†å¤šç§æ–¹å¼ç”¨æ¥åˆ›å»º `SchedulerBuilder` å¯¹è±¡ã€‚

1. **é€šè¿‡ `Create` é™æ€æ–¹æ³•åˆ›å»º**

```cs showLineNumbers {1,4,10,16,22}
// é€šè¿‡ä½œä¸š Id åˆ›å»º
var schedulerBuilder = SchedulerBuilder.Create("job1");

// é€šè¿‡æ³›å‹æ–¹å¼
var schedulerBuilder = SchedulerBuilder.Create<MyJob>(Triggers.PeriodSeconds(5), Triggers.Minutely());
var schedulerBuilder = SchedulerBuilder.Create<MyJob>(true, Triggers.PeriodSeconds(5), Triggers.Minutely());
var schedulerBuilder = SchedulerBuilder.Create<MyJob>("job1", Triggers.PeriodSeconds(5), Triggers.Minutely());
var schedulerBuilder = SchedulerBuilder.Create<MyJob>("job1", true, Triggers.PeriodSeconds(5), Triggers.Minutely());

// é€šè¿‡ç±»å‹æ–¹å¼
var schedulerBuilder = SchedulerBuilder.Create(typeof(MyJob), Triggers.PeriodSeconds(5), Triggers.Minutely());
var schedulerBuilder = SchedulerBuilder.Create(typeof(MyJob), true, Triggers.PeriodSeconds(5), Triggers.Minutely());
var schedulerBuilder = SchedulerBuilder.Create(typeof(MyJob), "job1", Triggers.PeriodSeconds(5), Triggers.Minutely());
var schedulerBuilder = SchedulerBuilder.Create(typeof(MyJob), "job1", true, Triggers.PeriodSeconds(5), Triggers.Minutely());

// é€šè¿‡å§”æ‰˜æ–¹å¼
var schedulerBuilder = SchedulerBuilder.Create((serviceProvider, context, stoppingToken) => {}, Triggers.PeriodSeconds(5), Triggers.Minutely());
var schedulerBuilder = SchedulerBuilder.Create((serviceProvider, context, stoppingToken) => {}, true, Triggers.PeriodSeconds(5), Triggers.Minutely());
var schedulerBuilder = SchedulerBuilder.Create((serviceProvider, context, stoppingToken) => {}, "job1", Triggers.PeriodSeconds(5), Triggers.Minutely());
var schedulerBuilder = SchedulerBuilder.Create((serviceProvider, context, stoppingToken) => {}, "job1", true, Triggers.PeriodSeconds(5), Triggers.Minutely());

// é€šè¿‡ JobBuilder å’Œ 0 æˆ– N ä¸ª TriggerBuilder åˆ›å»º
var schedulerBuilder = SchedulerBuilder.Create(
            JobBuilder.Create<MyJob>()
            , Triggers.PeriodSeconds(5), Triggers.Minutely());
```

2. **é€šè¿‡ `IScheduler` æ¥å£åˆ›å»º**

è¿™ç§æ–¹å¼å¸¸ç”¨äºåœ¨è¿è¡Œæ—¶æ›´æ–°ä½œä¸šä¿¡æ¯ã€‚

```cs showLineNumbers
var schedulerBuilder = SchedulerBuilder.From(scheduler);

//ä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼
var schedulerBuilder = scheduler.GetBuilder();
```

3. **é€šè¿‡ `JSON` å­—ç¬¦ä¸²åˆ›å»º**

è¯¥æ–¹å¼éå¸¸çµæ´»ï¼Œå¯ä»é…ç½®æ–‡ä»¶ï¼Œ`JSON` å­—ç¬¦ä¸²ï¼Œæˆ–å…¶ä»–èƒ½å¤Ÿè¿”å› `JSON` å­—ç¬¦ä¸²çš„åœ°æ–¹åˆ›å»ºã€‚

```cs showLineNumbers {1,3,14}
var schedulerBuilder = SchedulerBuilder.From(@"
{
	""jobDetail"": {
		""jobId"": ""job1"",
		""groupName"": null,
		""jobType"": ""MyJob"",
		""assemblyName"": ""ConsoleApp32"",
		""description"": null,
		""concurrent"": true,
		""includeAnnotations"": false,
		""properties"": ""{}"",
		""updatedTime"": ""2022-12-04 11:51:00.483""
	},
	""triggers"": [{
		""triggerId"": ""job1_trigger1"",
		""jobId"": ""job1"",
		""triggerType"": ""Furion.Schedule.PeriodTrigger"",
		""assemblyName"": ""Furion"",
		""args"": ""[5000]"",
		""description"": null,
		""status"": 2,
		""startTime"": null,
		""endTime"": null,
		""lastRunTime"": ""2022-12-04 17:52:34.768"",
		""nextRunTime"": ""2022-12-04 17:52:39.769"",
		""numberOfRuns"": 1,
		""maxNumberOfRuns"": 0,
		""numberOfErrors"": 0,
		""maxNumberOfErrors"": 0,
		""numRetries"": 0,
		""retryTimeout"": 1000,
		""startNow"": true,
		""runOnStart"": false,
		""resetOnlyOnce"": true,
		""updatedTime"": ""2022-12-04 17:52:34.803""
	}]
}
");
```

å¦‚æœä½¿ç”¨çš„æ˜¯ `.NET7`ï¼Œå¯ä½¿ç”¨ `"""` é¿å…è½¬ä¹‰ï¼Œå¦‚ï¼š

```cs showLineNumbers {1,3,14}
var schedulerBuilder = SchedulerBuilder.From("""
{
      "jobDetail": {
            "jobId": "job1",
            "groupName": null,
            "jobType": "MyJob",
            "assemblyName": "ConsoleApp32",
            "description": null,
            "concurrent": true,
            "includeAnnotations": false,
            "properties": "{}",
            "updatedTime": "2022-12-04 11:51:00.483"
      },
      "triggers": [{
            "triggerId": "job1_trigger1",
            "jobId": "job1",
            "triggerType": "Furion.Schedule.PeriodTrigger",
            "assemblyName": "Furion",
            "args": "[5000]",
            "description": null,
            "status": 2,
            "startTime": null,
            "endTime": null,
            "lastRunTime": "2022-12-04 17:52:34.768",
            "nextRunTime": "2022-12-04 17:52:39.769",
            "numberOfRuns": 1,
            "maxNumberOfRuns": 0,
            "numberOfErrors": 0,
            "maxNumberOfErrors": 0,
            "numRetries": 0,
            "retryTimeout": 1000,
            "startNow": true,
            "runOnStart": false,
            "resetOnlyOnce": true,
            "updatedTime": "2022-12-04 17:52:34.803"
      }]
}
""");
```

:::important å…³äºå±æ€§ååŒ¹é…è§„åˆ™

æ”¯æŒ `CamelCaseï¼ˆé©¼å³°å‘½åæ³•ï¼‰`ï¼Œ`Pascalï¼ˆå¸•æ–¯å¡å‘½åæ³•ï¼‰` å‘½åæ–¹å¼ã€‚

**ä¸æ”¯æŒ `UnderScoreCaseï¼ˆä¸‹åˆ’çº¿å‘½åæ³•ï¼‰`** ï¼Œå¦‚ `"include_annotations": true`

:::

4. **è¿˜å¯ä»¥é€šè¿‡ `Clone` é™æ€æ–¹æ³•ä»ä¸€ä¸ª `SchedulerBuilder` åˆ›å»º**

```cs showLineNumbers
var schedulerBuilder = SchedulerBuilder.Clone(fromSchedulerBuilder);
```

:::important å…‹éš†è¯´æ˜

å…‹éš†æ“ä½œå°†å…‹éš† `JobBuilder` å’Œ `TriggerBuilders`ï¼ŒåŒæ—¶æŒä¹…åŒ–è¡Œä¸ºä¼šè¢«æ ‡è®°ä¸º `Appended`ã€‚

:::

### 26.1.6.3 è®¾ç½®ä½œä¸šè®¡åˆ’æ„å»ºå™¨

`SchedulerBuilder` æä¾›äº†å¤šä¸ªæ–¹æ³•æ“ä½œ `JobBuilder` å’Œ `TriggerBuilder`ï¼Œå¦‚ï¼š

```cs showLineNumbers
// è·å–ä½œä¸šä¿¡æ¯æ„å»ºå™¨
var jobBuilder = schedulerBuilder.GetJobBuilder();

// è·å–æ‰€æœ‰ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilders = schedulerBuilder.GetTriggerBuilders();

// è·å–å•ä¸ªä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = schedulerBuilder.GetTriggerBuilder("job1_trigger1");
var triggerBuilder = schedulerBuilder.GetTriggerBuilder("not_found_trigger_id"); // => null

// æ›´æ–°ä½œä¸šä¿¡æ¯æ„å»ºå™¨
schedulerBuilder.UpdateJobBuilder(jobBuilder);
// å¦‚æœé€šè¿‡ .GetJobBuilder() æ–¹å¼è·å–ï¼Œé‚£ä¹ˆå¯ç›´æ¥æ›´æ–°ï¼Œæ— éœ€è°ƒç”¨ .UpdateJobBuilder(jobBuilder);
schedulerBuilder.UpdateJobBuilder(newJobBuilder, replace: true);

// æ·»åŠ ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
schedulerBuilder.AddTriggerBuilder(triggerBuilder1, triggerBuilder2, ...);

// æ›´æ–°ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
schedulerBuilder.UpdateTriggerBuilder(triggerBuilder1, triggerBuilder2, ...);
// è¿˜å¯ä»¥é€‰æ‹©è¦†ç›–æ›´æ–°è¿˜æ˜¯ä¸è¦†ç›–
schedulerBuilder.UpdateTriggerBuilder(new[] { triggerBuilder1, triggerBuilder2, ... }, replace: true);

// åˆ é™¤ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨ï¼Œæ³¨æ„ä¸æ˜¯çœŸçš„åˆ é™¤ï¼Œè€Œæ˜¯æ ‡è®°ä¸º Removed åˆ é™¤çŠ¶æ€
schedulerBuilder.RemoveTriggerBuilder("trigger1", "trigger2", ...);

// æ¸…é™¤æ‰€æœ‰ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨ï¼Œæ³¨æ„ä¸æ˜¯çœŸçš„åˆ é™¤ï¼Œè€Œæ˜¯æ ‡è®°ä¸º Removed åˆ é™¤çŠ¶æ€
schedulerBuilder.ClearTriggerBuilders();

// è¾“å‡ºä¸º JSON æ ¼å¼
var json = schedulerBuilder.ConvertToJSON();
var json = schedulerBuilder.ConvertToJSON(NamingConventions.CamelCase);

// å°†ä½œä¸šè®¡åˆ’æ„å»ºå™¨è½¬æ¢æˆå¯æšä¸¾çš„ Dictionary<JobBuilder, TriggerBuilder>
foreach(var (jobBuilder, triggerBuilder) in schedulerBuilder.GetEnumerable())
{
      // ....
}
```

### 26.1.6.4 ä½œä¸šè®¡åˆ’æ„å»ºå™¨æŒä¹…åŒ–æ–¹æ³•

ä½œä¸šè®¡åˆ’æ„å»ºå™¨ `SchedulerBuilder` æä¾›äº†ä¸‰ä¸ªæ ‡è®°ä½œä¸šæŒä¹…åŒ–è¡Œä¸ºçš„æ–¹æ³•ï¼š

- `Appended()`ï¼šæ ‡è®°ä½œä¸šè®¡åˆ’æ„å»ºå™¨æ˜¯æ–°å¢çš„ï¼Œå±Šæ—¶ç”Ÿæˆçš„ `SQL` æ˜¯ `INSERT` è¯­å¥
- `Updated()`ï¼šæ ‡è®°ä½œä¸šè®¡åˆ’æ„å»ºå™¨å·²è¢«æ›´æ–°ï¼Œå±Šæ—¶ç”Ÿæˆçš„ `SQL` æ˜¯ `Updated` è¯­å¥ï¼Œå¦‚æœæ ‡è®°ä¸ºæ­¤æ“ä½œï¼Œé‚£ä¹ˆå½“å‰ä½œä¸šè°ƒåº¦å™¨åˆå§‹åŒ–æ—¶å°†æ–°å¢è‡³å†…å­˜ä¸­
- `Removed()`ï¼šæ ‡è®°ä½œä¸šè®¡åˆ’æ„å»ºå™¨å·²è¢«åˆ é™¤ï¼Œå±Šæ—¶ç”Ÿæˆçš„ `SQL` æ˜¯ `Deleted` è¯­å¥ï¼Œå¦‚æœæ ‡è®°ä¸ºæ­¤æ“ä½œï¼Œé‚£ä¹ˆå½“å‰ä½œä¸šè°ƒåº¦å™¨åˆå§‹åŒ–æ—¶å°†ä¸ä¼šæ·»åŠ è‡³è°ƒåº¦å™¨ä¸­

```cs showLineNumbers {3-5}
services.AddSchedule(options =>
{
    options.AddJob(SchedulerBuilder.Create<MyJob>("job1").Appended()
        , SchedulerBuilder.Create<MyJob>("job2").Updated()
        , SchedulerBuilder.Create<MyJob>("job3").Removed());
});
```

æŸ¥çœ‹ä½œä¸šè°ƒåº¦å™¨åˆå§‹åŒ–æ—¥å¿—ï¼š

```bash showLineNumbers {6,8,10,12}
info: 2022-12-05 12:14:42.8481157 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is running.
info: 2022-12-05 12:14:42.8597028 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is preloading...
info: 2022-12-05 12:14:42.9360896 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      The scheduler of <job1> successfully appended to the schedule.
info: 2022-12-05 12:14:42.9471072 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      The scheduler of <job2> successfully appended and updated to the schedule.
info: 2022-12-05 12:14:42.9562673 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      The scheduler of <job3> successfully removed to the schedule.
warn: 2022-12-05 12:14:42.9748930 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      Schedule hosted service preload completed, and a total of <2> schedulers are appended.
```

### 26.1.6.5 å¤šç§æ ¼å¼å­—ç¬¦ä¸²è¾“å‡º

`Scheduler/IScheduler` å’Œ `SchedulerBuilder` éƒ½æä¾›äº†å¤šç§å°†è‡ªèº«è½¬æ¢æˆç‰¹å®šæ ¼å¼çš„å­—ç¬¦ä¸²ã€‚

1. **è½¬æ¢æˆ `JSON` å­—ç¬¦ä¸²**

```cs showLineNumbers
var json = schedulerBuilder.ConvertToJSON();
```

å­—ç¬¦ä¸²æ‰“å°å¦‚ä¸‹ï¼š

```json showLineNumbers {2,13}
{
  "jobDetail": {
    "jobId": "job1",
    "groupName": null,
    "jobType": "MyJob",
    "assemblyName": "ConsoleApp32",
    "description": null,
    "concurrent": true,
    "includeAnnotations": false,
    "properties": "{}",
    "updatedTime": "2022-12-04 11:51:00.483"
  },
  "triggers": [
    {
      "triggerId": "job1_trigger1",
      "jobId": "job1",
      "triggerType": "Furion.Schedule.PeriodTrigger",
      "assemblyName": "Furion",
      "args": "[5000]",
      "description": null,
      "status": 2,
      "startTime": null,
      "endTime": null,
      "lastRunTime": "2022-12-04 17:52:34.768",
      "nextRunTime": "2022-12-04 17:52:39.769",
      "numberOfRuns": 1,
      "maxNumberOfRuns": 0,
      "numberOfErrors": 0,
      "maxNumberOfErrors": 0,
      "numRetries": 0,
      "retryTimeout": 1000,
      "startNow": true,
      "runOnStart": false,
      "resetOnlyOnce": true,
      "updatedTime": "2022-12-04 17:52:34.803"
    }
  ]
}
```

## 26.1.7 ä½œä¸šè°ƒåº¦å™¨ `ScheduleOptionsBuilder` é…ç½®é€‰é¡¹

### 26.1.7.1 å…³äº `ScheduleOptionsBuilder`

`ScheduleOptionsBuilder` é…ç½®é€‰é¡¹ä¸»è¦æ˜¯ç”¨æ¥åˆå§‹åŒ–ä½œä¸šè°ƒåº¦å™¨åŠç›¸å…³æœåŠ¡é…ç½®çš„ã€‚åªä½œä¸º `services.AddSchedule` æœåŠ¡æ³¨å†Œçš„é…ç½®å‚æ•°ï¼Œå¦‚ï¼š

```cs showLineNumbers {2,8-9}
// é€šè¿‡å§”æ‰˜çš„æ–¹å¼é…ç½®
services.AddSchedule(options =>
{
      // options ç±»å‹ä¸º ScheduleOptionsBuilder
});

// è‡ªè¡Œåˆ›å»ºå¯¹è±¡å®ä¾‹æ–¹å¼é…ç½®
var scheduleOptionsBuilder = new ScheduleOptionsBuilder();
services.AddSchedule(scheduleOptionsBuilder);
```

### 26.1.7.2 `ScheduleOptionsBuilder` å†…ç½®å±æ€§å’Œæ–¹æ³•

- **å†…ç½®å±æ€§é…ç½®**

```cs showLineNumbers {4,7,10,13,16,21,24,29}
services.AddSchedule(options =>
{
      // æ˜¯å¦ä½¿ç”¨ UTC æ—¶é—´ï¼Œè¯¥é…ç½®ä¸»è¦ç”¨æ¥ä½œä¸ºä½œä¸šè°ƒåº¦å™¨æ£€æŸ¥æ—¶é—´æ ¼å¼çš„ä¾æ®
      options.UseUtcTimestamp = false;

      // æ˜¯å¦è¾“å‡ºä½œä¸šè°ƒåº¦å™¨æ—¥å¿—
      options.LogEnabled = true;

      // é…ç½®é›†ç¾¤ Idï¼Œé»˜è®¤å€¼ä¸ºå¯åŠ¨ç¨‹åºé›†çš„åç§°
      options.ClusterId = "cluster1";

      // é…ç½®è¾“å‡º SQL çš„æ•°æ®åº“ç±»å‹ï¼ŒFurion 4.8.2.3+
      options.BuildSqlType = SqlTypes.SqlServer;

      // é…ç½®ä½œä¸šä¿¡æ¯ JobDetail ç›¸å…³é…ç½®ï¼Œå¦‚é…ç½®è‡ªå®šä¹‰ SQL è¾“å‡º
      options.JobDetail.ConvertToSQL((tableName, columnNames, jobDetail, behavior, naming) =>
      {
      });

      // å¯ç”¨ä½œä¸šæ‰§è¡Œæ—¥å¿—è¾“å‡ºï¼ŒFurion 4.8.3.7+ ç‰ˆæœ¬æ”¯æŒ
      options.JobDetail.LogEnabled = true;      // é»˜è®¤ false

      // é…ç½®ä½œä¸šè§¦å‘å™¨ Trigger ç›¸å…³é…ç½®ï¼Œå¦‚é…ç½®è‡ªå®šä¹‰ SQL è¾“å‡º
      options.Trigger.ConvertToSQL((tableName, columnNames, trigger, behavior, naming) =>
      {
      });

      // å®šä¹‰æœªæ•è·çš„å¼‚å¸¸ï¼Œé€šå¸¸æ˜¯ Task å¼‚å¸¸
      options.UnobservedTaskExceptionHandler = (obj, args) =>
      {
      };
});
```

- **å†…ç½®æ–¹æ³•é…ç½®**

```cs showLineNumbers {4-18,21,24,27,30}
services.AddSchedule(options =>
{
      // æ·»åŠ ä½œä¸š
      options.AddJob(schedulerBuilder);
      options.AddJob(schedulerBuilder, schedulerBuilder1, ...); // Furion 4.8.2.4+
      options.AddJob(jobBuilder, triggerBuilder, ...);
      options.AddJob<MyJob>(triggerBuilder, ...);
      options.AddJob<MyJob>("ä½œä¸š Id", triggerBuilder, ...);
      options.AddJob<MyJob>("ä½œä¸š Id", concurrent: true, triggerBuilder, ...);
      options.AddJob<MyJob>(concurrent: true, triggerBuilder, ...);
      options.AddJob(typeof(MyJob), triggerBuilder, ...);
      options.AddJob(typeof(MyJob), "ä½œä¸š Id", triggerBuilder, ...);
      options.AddJob(typeof(MyJob), "ä½œä¸š Id", concurrent: true, triggerBuilder, ...);
      options.AddJob(typeof(MyJob), concurrent: true, triggerBuilder, ...);
      options.AddJob((serviceProvider, context, stoppingToken) => {}, triggerBuilder, ...);
      options.AddJob((serviceProvider, context, stoppingToken) => {}, "ä½œä¸š Id", triggerBuilder, ...);
      options.AddJob((serviceProvider, context, stoppingToken) => {}, "ä½œä¸š Id", concurrent: true, triggerBuilder, ...);
      options.AddJob((serviceProvider, context, stoppingToken) => {}, concurrent: true, triggerBuilder, ...);

      // æ·»åŠ ä½œä¸šæ‰§è¡Œç›‘è§†å™¨
      options.AddMonitor<YourJobMonitor>();

      // æ·»åŠ ä½œä¸šæ‰§è¡Œå™¨
      options.AddExecutor<YourJobMonitor>();

      // æ·»åŠ ä½œä¸šæŒä¹…åŒ–å™¨
      options.AddPersistence<YourJobPersistence>();

      // æ³¨å†Œä½œä¸šé›†ç¾¤æœåŠ¡
      options.AddClusterServer<YourClusterServer>();
});
```

## 26.1.8 ä½œä¸šç›‘è§†å™¨ `IJobMonitor`

è°ƒåº¦ä½œä¸šæœåŠ¡æä¾›äº† `IJobMonitor` ç›‘è§†å™¨æ¥å£ï¼Œå®ç°è¯¥æ¥å£å¯ä»¥ç›‘è§†æ‰€æœ‰ä½œä¸šå¤„ç†ç¨‹åºæ‰§è¡Œäº‹ä»¶ï¼ŒåŒ…æ‹¬ `æ‰§è¡Œä¹‹å‰ã€æ‰§è¡Œä¹‹åï¼Œæ‰§è¡Œå¼‚å¸¸`ã€‚

é€šè¿‡ä½œä¸šç›‘è§†å™¨å¯ä»¥å®ç°ä½œä¸šå®Œæ•´ç”Ÿå‘½å‘¨æœŸæ§åˆ¶ï¼Œè¿˜èƒ½å®ç°ä½œä¸šæ‰§è¡Œå¼‚å¸¸å‘é€çŸ­ä¿¡æˆ–é‚®ä»¶é€šçŸ¥ç®¡ç†å‘˜æˆ–é¡¹ç›®ç»´æŠ¤è€…ã€‚

å¦‚æ·»åŠ  `YourJobMonitor`ï¼š

```cs showLineNumbers  {1,9,15}
public class YourJobMonitor : IJobMonitor
{
    private readonly ILogger<YourJobMonitor> _logger;
    public YourJobMonitor(ILogger<YourJobMonitor> logger)
    {
        _logger = logger;
    }

    public Task OnExecutingAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation("æ‰§è¡Œä¹‹å‰ï¼š{context}", context);
        return Task.CompletedTask;
    }

    public Task OnExecutedAsync(JobExecutedContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation("æ‰§è¡Œä¹‹åï¼š{context}", context);

        if (context.Exception != null)
        {
            _logger.LogError(context.Exception, "æ‰§è¡Œå‡ºé”™å•¦ï¼š{context}", context);
        }

        return Task.CompletedTask;
    }
}
```

æœ€åï¼Œåœ¨æ³¨å†Œ `Schedule` æœåŠ¡ä¸­æ³¨å†Œ `YourJobMonitor`ï¼š

```cs showLineNumbers  {4}
services.AddSchedule(options =>
{
    // æ·»åŠ ä½œä¸šæ‰§è¡Œç›‘è§†å™¨
    options.AddMonitor<YourJobMonitor>();
});
```

æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š

```bash showLineNumbers {12,16,26,28}
info: 2022-12-05 14:09:47.2337395 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is running.
info: 2022-12-05 14:09:47.2401561 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is preloading...
info: 2022-12-05 14:09:47.2780446 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      The <job1_trigger1> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-05 14:09:47.2810119 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      The scheduler of <job1> successfully appended to the schedule.
warn: 2022-12-05 14:09:47.2941716 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      Schedule hosted service preload completed, and a total of <1> schedulers are appended.
info: 2022-12-05 14:09:52.3190129 +08:00 æ˜ŸæœŸä¸€ L ConsoleApp32.YourJobMonitor[0] #4
      æ‰§è¡Œä¹‹å‰ï¼š<job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:09:52.241 -> 2022-12-05 14:09:57.260
info: 2022-12-05 14:09:52.3240208 +08:00 æ˜ŸæœŸä¸€ L MyJob[0] #4
      <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:09:52.241 -> 2022-12-05 14:09:57.260
fail: 2022-12-05 14:09:52.5253398 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #4
      Error occurred executing <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:09:52.241 -> 2022-12-05 14:09:57.260.
      ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
      System.Exception: æ¨¡æ‹Ÿå‡ºé”™
         at MyJob.ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken) in D:\Workplaces\Study\CSharp\ConsoleApp32\ConsoleApp32\Program.cs:line 28
         at Furion.Schedule.ScheduleHostedService.<>c__DisplayClass23_3.<<BackgroundProcessing>b__3>d.MoveNext() in D:\Workplaces\OpenSources\Furion\framework\Furion\Schedule\HostedServices\ScheduleHostedService.cs:line 220
      --- End of stack trace from previous location ---
         at Furion.FriendlyException.Retry.InvokeAsync(Func`1 action, Int32 numRetries, Int32 retryTimeout, Boolean finalThrow, Type[] exceptionTypes, Func`2 fallbackPolicy, Action`2 retryAction) in D:\Workplaces\OpenSources\Furion\framework\Furion\FriendlyException\Retry.cs:line 87
         at Furion.Schedule.ScheduleHostedService.<>c__DisplayClass23_2.<<BackgroundProcessing>b__2>d.MoveNext() in D:\Workplaces\OpenSources\Furion\framework\Furion\Schedule\HostedServices\ScheduleHostedService.cs:line 218
      ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
info: 2022-12-05 14:09:52.5288429 +08:00 æ˜ŸæœŸä¸€ L ConsoleApp32.YourJobMonitor[0] #4
      æ‰§è¡Œä¹‹åï¼š<job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:09:52.241 -> 2022-12-05 14:09:57.260
fail: 2022-12-05 14:09:52.5318526 +08:00 æ˜ŸæœŸä¸€ L ConsoleApp32.YourJobMonitor[0] #4
      æ‰§è¡Œå‡ºé”™å•¦ï¼š<job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:09:52.241 -> 2022-12-05 14:09:57.260
      ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
      System.InvalidOperationException: Error occurred executing <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:09:52.241 -> 2022-12-05 14:09:57.260.
       ---> System.Exception: æ¨¡æ‹Ÿå‡ºé”™
         at MyJob.ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken) in D:\Workplaces\Study\CSharp\ConsoleApp32\ConsoleApp32\Program.cs:line 28
         at Furion.Schedule.ScheduleHostedService.<>c__DisplayClass23_3.<<BackgroundProcessing>b__3>d.MoveNext() in D:\Workplaces\OpenSources\Furion\framework\Furion\Schedule\HostedServices\ScheduleHostedService.cs:line 220
      --- End of stack trace from previous location ---
         at Furion.FriendlyException.Retry.InvokeAsync(Func`1 action, Int32 numRetries, Int32 retryTimeout, Boolean finalThrow, Type[] exceptionTypes, Func`2 fallbackPolicy, Action`2 retryAction) in D:\Workplaces\OpenSources\Furion\framework\Furion\FriendlyException\Retry.cs:line 87
         at Furion.Schedule.ScheduleHostedService.<>c__DisplayClass23_2.<<BackgroundProcessing>b__2>d.MoveNext() in D:\Workplaces\OpenSources\Furion\framework\Furion\Schedule\HostedServices\ScheduleHostedService.cs:line 218
         --- End of inner exception stack trace ---
      ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
```

**è¿˜å¯ä»¥è®¾ç½®æ‰§è¡Œå¤±è´¥é‡è¯•ï¼Œå¦‚ï¼š**

```cs showLineNumbers {3}
services.AddSchedule(options =>
{
      options.AddJob<MyJob>(Triggers.PeriodSeconds(5).SetNumRetries(3));      // é‡è¯• 3 æ¬¡
      options.AddMonitor<YourJobMonitor>();
});
```

æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š

```bash showLineNumbers {12,16,20,24,28,39,41}
info: 2022-12-05 14:25:15.9316915 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is running.
info: 2022-12-05 14:25:15.9391765 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is preloading...
info: 2022-12-05 14:25:15.9737767 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      The <job1_trigger1> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-05 14:25:15.9754882 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      The scheduler of <job1> successfully appended to the schedule.
warn: 2022-12-05 14:25:15.9892059 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      Schedule hosted service preload completed, and a total of <1> schedulers are appended.
info: 2022-12-05 14:25:21.0056685 +08:00 æ˜ŸæœŸä¸€ L ConsoleApp32.YourJobMonitor[0] #4
      æ‰§è¡Œä¹‹å‰ï¼š<job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:25:20.937 -> 2022-12-05 14:25:25.949
info: 2022-12-05 14:25:21.0140485 +08:00 æ˜ŸæœŸä¸€ L MyJob[0] #4
      <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:25:20.937 -> 2022-12-05 14:25:25.949
warn: 2022-12-05 14:25:21.0754973 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #4
      Retrying 1/3 times for <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:25:20.937 -> 2022-12-05 14:25:25.949
info: 2022-12-05 14:25:22.0935914 +08:00 æ˜ŸæœŸä¸€ L MyJob[0] #4
      <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:25:20.937 -> 2022-12-05 14:25:25.949
warn: 2022-12-05 14:25:22.1574937 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #4
      Retrying 2/3 times for <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:25:20.937 -> 2022-12-05 14:25:25.949
info: 2022-12-05 14:25:23.1666732 +08:00 æ˜ŸæœŸä¸€ L MyJob[0] #4
      <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:25:20.937 -> 2022-12-05 14:25:25.949
warn: 2022-12-05 14:25:23.2213212 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #4
      Retrying 3/3 times for <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:25:20.937 -> 2022-12-05 14:25:25.949
info: 2022-12-05 14:25:24.2337356 +08:00 æ˜ŸæœŸä¸€ L MyJob[0] #4
      <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:25:20.937 -> 2022-12-05 14:25:25.949
fail: 2022-12-05 14:25:24.3832385 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #4
      Error occurred executing <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:25:20.937 -> 2022-12-05 14:25:25.949.
      ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
      System.Exception: æ¨¡æ‹Ÿå‡ºé”™
         at MyJob.ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken) in D:\Workplaces\Study\CSharp\ConsoleApp32\ConsoleApp32\Program.cs:line 28
         at Furion.Schedule.ScheduleHostedService.<>c__DisplayClass23_3.<<BackgroundProcessing>b__3>d.MoveNext() in D:\Workplaces\OpenSources\Furion\framework\Furion\Schedule\HostedServices\ScheduleHostedService.cs:line 220
      --- End of stack trace from previous location ---
         at Furion.FriendlyException.Retry.InvokeAsync(Func`1 action, Int32 numRetries, Int32 retryTimeout, Boolean finalThrow, Type[] exceptionTypes, Func`2 fallbackPolicy, Action`2 retryAction) in D:\Workplaces\OpenSources\Furion\framework\Furion\FriendlyException\Retry.cs:line 99
         at Furion.FriendlyException.Retry.InvokeAsync(Func`1 action, Int32 numRetries, Int32 retryTimeout, Boolean finalThrow, Type[] exceptionTypes, Func`2 fallbackPolicy, Action`2 retryAction) in D:\Workplaces\OpenSources\Furion\framework\Furion\FriendlyException\Retry.cs:line 110
         at Furion.Schedule.ScheduleHostedService.<>c__DisplayClass23_2.<<BackgroundProcessing>b__2>d.MoveNext() in D:\Workplaces\OpenSources\Furion\framework\Furion\Schedule\HostedServices\ScheduleHostedService.cs:line 218
      ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
info: 2022-12-05 14:25:24.3857991 +08:00 æ˜ŸæœŸä¸€ L ConsoleApp32.YourJobMonitor[0] #4
      æ‰§è¡Œä¹‹åï¼š<job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:25:20.937 -> 2022-12-05 14:25:25.949
fail: 2022-12-05 14:25:24.3888126 +08:00 æ˜ŸæœŸä¸€ L ConsoleApp32.YourJobMonitor[0] #4
      æ‰§è¡Œå‡ºé”™å•¦ï¼š<job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:25:20.937 -> 2022-12-05 14:25:25.949
      ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
      System.InvalidOperationException: Error occurred executing <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:25:20.937 -> 2022-12-05 14:25:25.949.
       ---> System.Exception: æ¨¡æ‹Ÿå‡ºé”™
         at MyJob.ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken) in D:\Workplaces\Study\CSharp\ConsoleApp32\ConsoleApp32\Program.cs:line 28
         at Furion.Schedule.ScheduleHostedService.<>c__DisplayClass23_3.<<BackgroundProcessing>b__3>d.MoveNext() in D:\Workplaces\OpenSources\Furion\framework\Furion\Schedule\HostedServices\ScheduleHostedService.cs:line 220
      --- End of stack trace from previous location ---
         at Furion.FriendlyException.Retry.InvokeAsync(Func`1 action, Int32 numRetries, Int32 retryTimeout, Boolean finalThrow, Type[] exceptionTypes, Func`2 fallbackPolicy, Action`2 retryAction) in D:\Workplaces\OpenSources\Furion\framework\Furion\FriendlyException\Retry.cs:line 99
         at Furion.FriendlyException.Retry.InvokeAsync(Func`1 action, Int32 numRetries, Int32 retryTimeout, Boolean finalThrow, Type[] exceptionTypes, Func`2 fallbackPolicy, Action`2 retryAction) in D:\Workplaces\OpenSources\Furion\framework\Furion\FriendlyException\Retry.cs:line 110
         at Furion.Schedule.ScheduleHostedService.<>c__DisplayClass23_2.<<BackgroundProcessing>b__2>d.MoveNext() in D:\Workplaces\OpenSources\Furion\framework\Furion\Schedule\HostedServices\ScheduleHostedService.cs:line 218
         --- End of inner exception stack trace ---
      ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
```

### 26.1.8.1 å…³äºå‚æ•° `JobExecutionContext`

`IJobMonitor` æä¾›çš„ `OnExecutingAsync` å’Œ `OnExecutedAsync` æ¥å£æ–¹æ³•éƒ½åŒ…å«ä¸€ä¸ª `context` å‚æ•°ï¼Œå‰è€…æ˜¯ `JobExecutingContext`ï¼Œåè€…æ˜¯ `JobExecutedContext`ï¼Œå®ƒä»¬éƒ½æœ‰ä¸€ä¸ªå…±åŒçš„åŸºç±» `JobExecutionContext`ã€‚

`JobExecutionContext` æä¾›äº†ä»¥ä¸‹å…¬å…±å±æ€§å’Œå…¬å…±æ–¹æ³•:

- **`JobExecutionContext` å±æ€§åˆ—è¡¨**
  - `JobId`ï¼šä½œä¸š `Id`
  - `TriggerId`ï¼šå½“å‰è§¦å‘å™¨ `Id`
  - `JobDetail`ï¼šä½œä¸šä¿¡æ¯
  - `Trigger`ï¼šä½œä¸šè§¦å‘å™¨
  - `OccurrenceTime`ï¼š**ä½œä¸šè®¡åˆ’è§¦å‘æ—¶é—´ï¼Œæœ€å‡†ç¡®çš„è®°å½•æ—¶é—´**
- **`JobExecutionContext` æ–¹æ³•åˆ—è¡¨**
  - `.ConvertToJSON(naming)`ï¼šå°†ä½œä¸šè®¡åˆ’è½¬æ¢æˆ `JSON` å­—ç¬¦ä¸²
  - `.ToString()`ï¼šå°†ä½œä¸šæ‰§è¡Œä¿¡æ¯è¾“å‡ºä¸ºç®€è¦å­—ç¬¦ä¸²

<p></p>

- **`JobExecutingContext`** åœ¨åŸºç±»åŸºç¡€ä¸Šæ‹“å±•äº† `ExecutingTime` å±æ€§ï¼š
  - `ExecutingTime`ï¼šæ‰§è¡Œå‰æ—¶é—´
- **`JobExecutedContext`** åˆ™åœ¨åŸºç±»åŸºç¡€ä¸Šæ‹“å±•äº† `ExecutedTime` å’Œ `Exception` å±æ€§ï¼š
  - `ExecutedTime`ï¼šæ‰§è¡Œåæ—¶é—´
  - `Exception`ï¼šæ‰§è¡Œå¼‚å¸¸

## 26.1.9 ä½œä¸šæ‰§è¡Œå™¨ `IJobExecutor`

è°ƒåº¦ä½œä¸šæœåŠ¡æä¾›äº† `IJobExecutor` æ‰§è¡Œå™¨æ¥å£ï¼Œå¯ä»¥è®©å¼€å‘è€…è‡ªå®šä¹‰ä½œä¸šå¤„ç†å‡½æ•°æ‰§è¡Œç­–ç•¥ï¼Œå¦‚ `è¶…æ—¶æ§åˆ¶ï¼Œå¤±è´¥é‡è¯•ç­‰ç­‰`ã€‚

### 26.1.9.1 å®ç°é‡è¯•ç­–ç•¥

å¦‚æ·»åŠ  `YourJobExecutor`ï¼š

```cs showLineNumbers {1,12,14,17-20}
public class YourJobExecutor : IJobExecutor
{
    private readonly ILogger<YourJobExecutor> _logger;
    public YourJobExecutor(ILogger<YourJobExecutor> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, IJob jobHandler, CancellationToken stoppingToken)
    {
        // å®ç°å¤±è´¥é‡è¯•ç­–ç•¥ï¼Œå¦‚å¤±è´¥é‡è¯• 3 æ¬¡
        await Retry.InvokeAsync(async () =>
        {
            await jobHandler.ExecuteAsync(context, stoppingToken);
        }, 3, 1000
        // æ¯æ¬¡é‡è¯•è¾“å‡ºæ—¥å¿—
        , retryAction: (total, times) =>
        {
            _logger.LogWarning("Retrying {current}/{times} times for {context}", times, total, context);
        });
    }
}
```

æ¥ç€æ¨¡æ‹Ÿ `MyJob` æ‰§è¡Œå‡ºé”™ï¼š

```cs showLineNumbers {1,13}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation($"{context}");

        throw new Exception("æ¨¡æ‹Ÿå‡ºé”™");
        return Task.CompletedTask;
    }
}
```

æœ€åï¼Œåœ¨æ³¨å†Œ `Schedule` æœåŠ¡ä¸­æ³¨å†Œ `YourJobExecutor`ï¼š

```cs showLineNumbers {4}
services.AddSchedule(options =>
{
      // æ·»åŠ ä½œä¸šæ‰§è¡Œå™¨
      options.AddExecutor<YourJobExecutor>();
});
```

æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š

```bash showLineNumbers {14,18,22}
info: 2022-12-05 14:36:41.2085688 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is running.
info: 2022-12-05 14:36:41.2162510 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is preloading...
info: 2022-12-05 14:36:41.2885816 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      The <job1_trigger1> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-05 14:36:41.2912130 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      The scheduler of <job1> successfully appended to the schedule.
warn: 2022-12-05 14:36:41.3102057 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      Schedule hosted service preload completed, and a total of <1> schedulers are appended.
info: 2022-12-05 14:36:46.3329097 +08:00 æ˜ŸæœŸä¸€ L MyJob[0] #13
      <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:36:46.249 -> 2022-12-05 14:36:51.274
warn: 2022-12-05 14:36:46.3910063 +08:00 æ˜ŸæœŸä¸€ L ConsoleApp32.YourJobExecutor[0] #13
      Retrying 1/3 times for <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:36:46.249 -> 2022-12-05 14:36:51.274
info: 2022-12-05 14:36:47.4014898 +08:00 æ˜ŸæœŸä¸€ L MyJob[0] #13
      <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:36:46.249 -> 2022-12-05 14:36:51.274
warn: 2022-12-05 14:36:47.4471172 +08:00 æ˜ŸæœŸä¸€ L ConsoleApp32.YourJobExecutor[0] #13
      Retrying 2/3 times for <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:36:46.249 -> 2022-12-05 14:36:51.274
info: 2022-12-05 14:36:48.4539737 +08:00 æ˜ŸæœŸä¸€ L MyJob[0] #13
      <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:36:46.249 -> 2022-12-05 14:36:51.274
warn: 2022-12-05 14:36:48.4880918 +08:00 æ˜ŸæœŸä¸€ L ConsoleApp32.YourJobExecutor[0] #13
      Retrying 3/3 times for <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:36:46.249 -> 2022-12-05 14:36:51.274
info: 2022-12-05 14:36:49.4984333 +08:00 æ˜ŸæœŸä¸€ L MyJob[0] #13
      <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:36:46.249 -> 2022-12-05 14:36:51.274
fail: 2022-12-05 14:36:49.6714485 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #13
      Error occurred executing <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 14:36:46.249 -> 2022-12-05 14:36:51.274.
      ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
      System.Exception: æ¨¡æ‹Ÿå‡ºé”™
         at MyJob.ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken) in D:\Workplaces\Study\CSharp\ConsoleApp32\ConsoleApp32\Program.cs:line 31
         at ConsoleApp32.YourJobExecutor.<>c__DisplayClass2_0.<<ExecuteAsync>b__0>d.MoveNext() in D:\Workplaces\Study\CSharp\ConsoleApp32\ConsoleApp32\YourJobExecutor.cs:line 20
      --- End of stack trace from previous location ---
         at Furion.FriendlyException.Retry.InvokeAsync(Func`1 action, Int32 numRetries, Int32 retryTimeout, Boolean finalThrow, Type[] exceptionTypes, Func`2 fallbackPolicy, Action`2 retryAction) in D:\Workplaces\OpenSources\Furion\framework\Furion\FriendlyException\Retry.cs:line 99
         at Furion.FriendlyException.Retry.InvokeAsync(Func`1 action, Int32 numRetries, Int32 retryTimeout, Boolean finalThrow, Type[] exceptionTypes, Func`2 fallbackPolicy, Action`2 retryAction) in D:\Workplaces\OpenSources\Furion\framework\Furion\FriendlyException\Retry.cs:line 110
         at ConsoleApp32.YourJobExecutor.ExecuteAsync(JobExecutingContext context, IJob jobHandler, CancellationToken stoppingToken) in D:\Workplaces\Study\CSharp\ConsoleApp32\ConsoleApp32\YourJobExecutor.cs:line 18
         at Furion.Schedule.ScheduleHostedService.<>c__DisplayClass23_2.<<BackgroundProcessing>b__2>d.MoveNext() in D:\Workplaces\OpenSources\Furion\framework\Furion\Schedule\HostedServices\ScheduleHostedService.cs:line 232
      ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
```

### 26.1.9.2 å®ç°è¶…æ—¶æ§åˆ¶

å¦‚æ·»åŠ  `YourJobExecutor`ï¼š

```cs showLineNumbers {12}
public class YourJobExecutor : IJobExecutor
{
    private readonly ILogger<YourJobExecutor> _logger;
    public YourJobExecutor(ILogger<YourJobExecutor> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, IJob jobHandler, CancellationToken stoppingToken)
    {
        await jobHandler.ExecuteAsync(context, stoppingToken)
            .WaitAsync(TimeSpan.FromMilliseconds(3000));    // è®¾ç½® 3 ç§’è¶…æ—¶
    }
}
```

æ¥ç€æ¨¡æ‹Ÿ `MyJob` æ‰§è¡Œè¶…æ—¶ï¼š

```cs showLineNumbers {12}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation($"{context}");
        await Task.Delay(6000);     // æ¨¡æ‹Ÿè€—æ—¶ 6 ç§’
    }
}
```

æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š

```bash showLineNumbers {16}
info: 2022-12-20 13:57:01.7251541 +08:00 æ˜ŸæœŸäºŒ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is running.
info: 2022-12-20 13:57:01.7336016 +08:00 æ˜ŸæœŸäºŒ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is preloading...
info: 2022-12-20 13:57:02.2846096 +08:00 æ˜ŸæœŸäºŒ L System.Logging.ScheduleService[0] #1
      The <job1_trigger1> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-20 13:57:02.3448819 +08:00 æ˜ŸæœŸäºŒ L System.Logging.ScheduleService[0] #1
      The scheduler of <job1> successfully appended to the schedule.
warn: 2022-12-20 13:57:02.3800053 +08:00 æ˜ŸæœŸäºŒ L System.Logging.ScheduleService[0] #1
      Schedule hosted service preload completed, and a total of <1> schedulers are appended.
info: 2022-12-20 13:57:07.3261111 +08:00 æ˜ŸæœŸäºŒ L MyJob[0] #14
      <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-20 13:57:07.240 -> 2022-12-20 13:57:12.260
fail: 2022-12-20 13:57:10.5743871 +08:00 æ˜ŸæœŸäºŒ L System.Logging.ScheduleService[0] #14
      Error occurred executing <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-20 13:57:07.240 -> 2022-12-20 13:57:12.260.
      ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
      System.TimeoutException: The operation has timed out.
         at YourJobExecutor.ExecuteAsync(JobExecutingContext context, IJob jobHandler, CancellationToken stoppingToken) in D:\Workplaces\Study\CSharp\ConsoleApp32\ConsoleApp32\Program.cs:line 41
         at Furion.Schedule.ScheduleHostedService.<>c__DisplayClass23_2.<<BackgroundProcessing>b__2>d.MoveNext() in D:\Workplaces\OpenSources\Furion\framework\Furion\Schedule\HostedServices\ScheduleHostedService.cs:line 234
      ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
```

:::tip å…³äº `WaitAsync` è¯´æ˜

`WaitAsync` æ˜¯ `.NET6+` æ–°å¢çš„ `Task` æ‹“å±•æ–¹æ³•ï¼Œå¦‚éœ€åœ¨ `.NET5` ä¸­æ”¯æŒï¼Œå¯æ·»åŠ ä»¥ä¸‹æ‹“å±•ï¼š

```cs showLineNumbers
public static async Task WaitAsync(this Task task, TimeSpan timeout)
{
      using var timeoutCancellationTokenSource = new CancellationTokenSource();
      var delayTask = Task.Delay(timeout, timeoutCancellationTokenSource.Token);

      if(await Task.WhenAny(task, delayTask) == task)
      {
            timeoutCancellationTokenSource.Cancel();
            await task;
      }
      else
      {
            throw new TimeoutException("The operation has timed out.")
      }
}
```

:::

### 26.1.9.3 æ›´å¤šæ§åˆ¶

ä½œä¸šæ‰§è¡Œå™¨åŠŸèƒ½è¿œä¸æ­¢äºæ­¤ï¼Œé€šè¿‡è‡ªå®šä¹‰ä½œä¸šæ‰§è¡Œå™¨è¿˜å¯ä»¥å®ç°åˆ†ç‰‡ä½œä¸šï¼Œå…³è”å­ä½œä¸šï¼Œæ•…éšœè½¬ç§»ï¼Œé›†ç¾¤ç­‰æ§åˆ¶ã€‚

## 26.1.10 ä½œä¸šè®¡åˆ’å·¥å‚ `ISchedulerFactory`

ä½œä¸šè®¡åˆ’å·¥å‚æä¾›äº†ç¨‹åºè¿è¡Œæ—¶æ“ä½œä½œä¸šè°ƒåº¦å™¨ï¼Œä½œä¸šè®¡åˆ’ç­‰è¯¸å¤šæ–¹æ³•ã€‚

`ISchedulerFactory` è¢«æ³¨å†Œä¸º `å•ä¾‹` æœåŠ¡ï¼Œå…è®¸åœ¨ä»»ä½•å¯ä¾èµ–æ³¨å…¥çš„æœåŠ¡è·å–ï¼Œå¦‚ï¼š

```cs showLineNumbers {4,8,11,16}
public class YourService: IYourService
{
    private readonly ISchedulerFactory _schedulerFactory;
    public YourService(ISchedulerFactory schedulerFactory)
    {
        _schedulerFactory = schedulerFactory;

        // ä¹Ÿå¯ä»¥é€šè¿‡ App.GetService<ISchedulerFactory>() è·å–
    }

    public void SomeMethod([FromServices]ISchedulerFactory schedulerFactory)
    {
    }

    // .NET7+ æˆ– Furion 4.8.0+
    public void SomeMethod(ISchedulerFactory schedulerFactory)
    {
    }
}
```

### 26.1.10.1 æŸ¥æ‰¾æ‰€æœ‰ä½œä¸š

```cs showLineNumbers {1,5,9,13}
// æŸ¥æ‰¾æ‰€æœ‰ä½œä¸šï¼ŒåŒ…æ‹¬ JobType == null çš„éæœ‰æ•ˆä½œä¸š
var jobs = _schedulerFactory.GetJobs();
var jobsOfModels = _schedulerFactory.GetJobsOfModels();

// æŸ¥æ‰¾ç‰¹å®šåˆ†ç»„çš„ä½œä¸šï¼ŒåŒ…æ‹¬ JobType == null çš„éæœ‰æ•ˆä½œä¸š
var jobs = _schedulerFactory.GetJobs("group1");
var jobsOfModels = _schedulerFactory.GetJobsOfModels("group1");

// æŸ¥æ‰¾æ‰€æœ‰ä½œä¸šï¼Œä»… JobType != null æœ‰æ•ˆä½œä¸š
var jobs = _schedulerFactory.GetJobs(active: true);
var jobsOfModels = _schedulerFactory.GetJobsOfModels(active: true);

// æŸ¥æ‰¾ç‰¹å®šåˆ†ç»„çš„ä½œä¸šï¼Œä»… JobType != null æœ‰æ•ˆä½œä¸š
var jobs = _schedulerFactory.GetJobs("group1", true);
var jobsOfModels = _schedulerFactory.GetJobsOfModels("group1", true);
```

### 26.1.10.2 æŸ¥æ‰¾ä¸‹ä¸€æ‰¹è§¦å‘çš„ä½œä¸š

```cs showLineNumbers {1,5}
// æŸ¥æ‰¾ä¸‹ä¸€æ‰¹è§¦å‘çš„ä½œä¸š
var nextRunJobs = _schedulerFactory.GetNextRunJobs(DateTime.Now);
var nextRunJobsOfModels = _schedulerFactory.GetNextRunJobsOfModels(DateTime.Now);

// æŸ¥æ‰¾ç‰¹å®šåˆ†ç»„ä¸‹ä¸€æ‰¹è§¦å‘çš„ä½œä¸š
var nextRunJobs = _schedulerFactory.GetNextRunJobs(DateTime.Now, "group1");
var nextRunJobsOfModels = _schedulerFactory.GetNextRunJobsOfModels(DateTime.Now, "group1");
```

### 26.1.10.3 è·å–å•ä¸ªä½œä¸š

```cs showLineNumbers {1,6}
// è¿”å› ScheduleResult ç±»å‹
var scheduleResult = _schedulerFactory.TryGetJob("job1", out var scheduler); // å¦‚æœå­˜åœ¨è¿”å› => ScheduleResult.Succeed
var scheduleResult = _schedulerFactory.TryGetJob("not_found", out var scheduler); // => ScheduleResult.NotFound
var scheduleResult = _schedulerFactory.TryGetJob("", out var scheduler); // => ScheduleResult.NotIdentify

// è¿”å› IScheduler ç±»å‹
var scheduler = _schedulerFactory.GetJob("job1"); // å¦‚æœå­˜åœ¨è¿”å› IScheduler
var scheduler = _schedulerFactory.GetJob("not_found"); // => null
var scheduler = _schedulerFactory.GetJob(""); // => null
```

### 26.1.10.4 ä¿å­˜ä½œä¸š

ä¿å­˜ä½œä¸šæ˜¯æ¡†æ¶æä¾›å¼ºå¤§ä¸”ç®€å•çš„æ–¹æ³•ï¼Œæ”¯æŒ `æ–°å¢`ï¼Œ`ç¼–è¾‘`ï¼Œ`åˆ é™¤` ä½œä¸šï¼Œä¹Ÿå°±æ˜¯ä¸‰å¤§æ“ä½œéƒ½å¯ä»¥ç›´æ¥é€šè¿‡æ­¤æ–¹æ³•ç›´æ¥æ“ä½œã€‚

```cs showLineNumbers
// è¿”å› ScheduleResult ç±»å‹
var scheduleResult = _schedulerFactory.TrySaveJob(schedulerBuilder, out var scheduler);

// æ— è¿”å›å€¼ï¼Œæ”¯æŒå¤šä¸ª
_schedulerFactory.SaveJob(schedulerBuilder1, schedulerBuilder2, ...)
```

:::tip å…³äºä¿å­˜ä½œä¸šçš„èƒŒåè¡Œä¸º

é»˜è®¤æƒ…å†µä¸‹ï¼Œä¿å­˜ä½œä¸šéœ€è¦ä¼ é€’ `SchedulerBuilder` å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å¯é€šè¿‡ `GetJob(jobId)` è·å–ï¼Œå¦‚ï¼š

```cs showLineNumbers
var schedulerBuilder = _schedulerFactory.GetJob("jobId")?.GetBuilder();
```

æ­¤æ—¶å®ƒçš„å†…éƒ¨ `Behavior` å±æ€§è¢«æ ‡è®°ä¸º `PersistenceBehavior.Updated`ï¼Œä¹Ÿå°±æ˜¯æ›´æ–°çŠ¶æ€ï¼Œé‚£ä¹ˆå¯¹äºè¿™ä¸ªæ„å»ºå™¨çš„ä»»ä½•æ“ä½œéƒ½ä¼šæ ‡è®°ä¸º `æ›´æ–°` æ“ä½œã€‚

å¦‚æœé€šè¿‡ `.Appended()` æˆ– `.Removed()` æ–¹æ³•æ ‡è®°ä¹‹åï¼Œé‚£ä¹ˆå®ƒçš„æ“ä½œè¡Œä¸ºå°±å‘ç”Ÿå˜åŒ–äº†ã€‚

- **å¦‚æœè¢«æ ‡è®°ä¸º `.Appended()`**ï¼Œé‚£ä¹ˆå®ƒå°†è¿›è¡Œ `æ–°å¢` æ“ä½œã€‚å¦‚ï¼š

```cs showLineNumbers
schedulerBuilder.Appended();
```

- **å¦‚æœè¢«æ ‡è®°ä¸º `.Removed()`**ï¼Œé‚£ä¹ˆå®ƒå°†è¿›è¡Œ `åˆ é™¤` æ“ä½œã€‚å¦‚ï¼š

```cs showLineNumbers
schedulerBuilder.Removed();
```

æ¯”å¦‚ä»¥ä¸‹çš„ä»£ç å®åˆ™æ˜¯ `æ–°å¢` æˆ– `åˆ é™¤` æˆ– `æ›´æ–°` æ“ä½œï¼š

```cs showLineNumbers {1,4,8}
// å®é™…åšæ–°å¢æ“ä½œ
var scheduleResult = _schedulerFactory.TrySaveJob(SchedulerBuilder.Create<MyJob>(), out var scheduler); // Create æ–¹æ³•é»˜è®¤æ ‡è®°ä¸º Appended

// å®é™…åšåˆ é™¤æ“ä½œ
var schedulerBuilder = _schedulerFactory.GetJob("jobId")?.GetBuilder();
var scheduleResult = _schedulerFactory.TrySaveJob(schedulerBuilder?.Removed(), out var scheduler); // æ ‡è®°ä¸º Removed

// å®é™…åšæ›´æ–°æ“ä½œ
var scheduleResult = _schedulerFactory.TrySaveJob(SchedulerBuilder.Create<MyJob>().Updated(), out var scheduler); // Create æ–¹æ³•é»˜è®¤æ ‡è®°ä¸º Appendedï¼Œä½†è°ƒç”¨ Updated() æ–¹æ³•
```

å¦å¤–ï¼Œä½œä¸šè§¦å‘å™¨ `Trigger` ä¹Ÿå…·å¤‡ç›¸åŒçš„è¡Œä¸ºã€‚

:::

### 26.1.10.5 æ·»åŠ ä½œä¸š

æ¡†æ¶æä¾›äº†éå¸¸å¤šçš„é‡è½½æ–¹æ³•æ·»åŠ ä½œä¸šï¼Œå¦‚ï¼š

```cs showLineNumbers {1,5,9,22,35}
// SchedulerBuilder æ–¹å¼
var scheduleResult = _schedulerFactory.TryAddJob(schedulerBuilder, out var scheduler);
_schedulerFactory.AddJob(schedulerBuilder1, schedulerBuilder2, ...);

// JobBuilder + TriggerBuilders æ–¹å¼
var scheduleResult = _schedulerFactory.TryAddJob(jobBuilder, new[] { triggerBuilder1, triggerBuilder2, ...}, out var scheduler);
_schedulerFactory.TryAddJob(jobBuilder, triggerBuilder1, triggerBuilder2, ...);

// æ³›å‹æ–¹å¼
var scheduleResult = _schedulerFactory.TryAddJob<MyJob>(new[] { triggerBuilder1, triggerBuilder2, ...}, out var scheduler);
_schedulerFactory.AddJob<MyJob>(triggerBuilder1, triggerBuilder2, ...);
// æ”¯æŒé…ç½®ä½œä¸š Id
var scheduleResult = _schedulerFactory.TryAddJob<MyJob>("job1", new[] { triggerBuilder1, triggerBuilder2, ...}, out var scheduler);
_schedulerFactory.AddJob<MyJob>("job1", triggerBuilder1, triggerBuilder2, ...);
// æ”¯æŒé…ç½®ä½œä¸š Id + ä¸²è¡Œ/å¹¶è¡Œ
var scheduleResult = _schedulerFactory.TryAddJob<MyJob>("job1", true, new[] { triggerBuilder1, triggerBuilder2, ...}, out var scheduler);
_schedulerFactory.AddJob<MyJob>("job1", true, triggerBuilder1, triggerBuilder2, ...);
// æ”¯æŒé…ç½® ä¸²è¡Œ/ å¹¶è¡Œ
var scheduleResult = _schedulerFactory.TryAddJob<MyJob>(true, new[] { triggerBuilder1, triggerBuilder2, ...}, out var scheduler);
_schedulerFactory.AddJob<MyJob>(true, triggerBuilder1, triggerBuilder2, ...);

// ç±»å‹æ–¹å¼
var scheduleResult = _schedulerFactory.TryAddJob(typeof(MyJob), new[] { triggerBuilder1, triggerBuilder2, ...}, out var scheduler);
_schedulerFactory.AddJob(typeof(MyJob), triggerBuilder1, triggerBuilder2, ...);
// æ”¯æŒé…ç½®ä½œä¸š Id
var scheduleResult = _schedulerFactory.TryAddJob(typeof(MyJob), "job1", new[] { triggerBuilder1, triggerBuilder2, ...}, out var scheduler);
_schedulerFactory.AddJob(typeof(MyJob), "job1", triggerBuilder1, triggerBuilder2, ...);
// æ”¯æŒé…ç½®ä½œä¸š Id + ä¸²è¡Œ/å¹¶è¡Œ
var scheduleResult = _schedulerFactory.TryAddJob(typeof(MyJob), "job1", true, new[] { triggerBuilder1, triggerBuilder2, ...}, out var scheduler);
_schedulerFactory.AddJob(typeof(MyJob), "job1", true, triggerBuilder1, triggerBuilder2, ...);
// æ”¯æŒé…ç½® ä¸²è¡Œ/ å¹¶è¡Œ
var scheduleResult = _schedulerFactory.TryAddJob(typeof(MyJob), true, new[] { triggerBuilder1, triggerBuilder2, ...}, out var scheduler);
_schedulerFactory.AddJob(typeof(MyJob), true, triggerBuilder1, triggerBuilder2, ...);

// åŠ¨æ€ä½œä¸šå§”æ‰˜æ–¹å¼
var scheduleResult = _schedulerFactory.TryAddJob((serviceProvider, context, stoppingToken) => { }, new[] { triggerBuilder1, triggerBuilder2, ...}, out var scheduler);
_schedulerFactory.AddJob((serviceProvider, context, stoppingToken) => { }, triggerBuilder1, triggerBuilder2, ...);
// æ”¯æŒé…ç½®ä½œä¸š Id
var scheduleResult = _schedulerFactory.TryAddJob((serviceProvider, context, stoppingToken) => { }, "job1", new[] { triggerBuilder1, triggerBuilder2, ...}, out var scheduler);
_schedulerFactory.AddJob((serviceProvider, context, stoppingToken) => { }, "job1", triggerBuilder1, triggerBuilder2, ...);
// æ”¯æŒé…ç½®ä½œä¸š Id + ä¸²è¡Œ/å¹¶è¡Œ
var scheduleResult = _schedulerFactory.TryAddJob((serviceProvider, context, stoppingToken) => { }, "job1", true, new[] { triggerBuilder1, triggerBuilder2, ...}, out var scheduler);
_schedulerFactory.AddJob((serviceProvider, context, stoppingToken) => { }, "job1", true, triggerBuilder1, triggerBuilder2, ...);
// æ”¯æŒé…ç½® ä¸²è¡Œ/ å¹¶è¡Œ
var scheduleResult = _schedulerFactory.TryAddJob((serviceProvider, context, stoppingToken) => { }, true, new[] { triggerBuilder1, triggerBuilder2, ...}, out var scheduler);
_schedulerFactory.AddJob((serviceProvider, context, stoppingToken) => { }, true, triggerBuilder1, triggerBuilder2, ...);
```

### 26.1.10.6 æ›´æ–°ä½œä¸š

```cs showLineNumbers
// è¿”å› ScheduleResult æ–¹å¼
var scheduleResult = _schedulerFactory.TryUpdateJob(schedulerBuilder, out var scheduler);

// æ— è¿”å›å€¼æ–¹å¼
_schedulerFactory.UpdateJob(schedulerBuilder1, schedulerBuilder2, ...);
```

### 26.1.10.7 åˆ é™¤ä½œä¸š

```cs showLineNumbers
// è¿”å› ScheduleResult æ–¹å¼
var scheduleResult = _schedulerFactory.TryRemoveJob("job1", out var scheduler);
var scheduleResult = _schedulerFactory.TryRemoveJob(scheduler);

// æ— è¿”å›å€¼æ–¹å¼
_schedulerFactory.RemoveJob("job1", "job2", ...);
_schedulerFactory.RemoveJob(scheduler1, scheduler2, ...);
```

### 26.1.10.8 æ£€æŸ¥ä½œä¸šæ˜¯å¦å­˜åœ¨

```cs showLineNumbers {1,4}
var isExist = _schedulerFactory.ContainsJob("job1");

// è¿˜å¯ä»¥é€šè¿‡ group æŸ¥æ‰¾
var isExist = _schedulerFactory.ContainsJob("job1", "group1");
```

### 26.1.10.9 å¯åŠ¨æ‰€æœ‰ä½œä¸š

```cs showLineNumbers {1,4}
_schedulerFactory.StartAll();

// è¿˜å¯ä»¥é€šè¿‡ group å¯åŠ¨
_schedulerFactory.StartAll("group1");
```

### 26.1.10.10 æš‚åœæ‰€æœ‰ä½œä¸š

```cs showLineNumbers {1,4}
 _schedulerFactory.PauseAll();

// è¿˜å¯ä»¥é€šè¿‡ group æ“ä½œ
 _schedulerFactory.PauseAll("group1");
```

### 26.1.10.11 åˆ é™¤æ‰€æœ‰ä½œä¸š

```cs showLineNumbers {1,4}
 _schedulerFactory.RemoveAll();

// è¿˜å¯ä»¥é€šè¿‡ group æ“ä½œ
 _schedulerFactory.RemoveAll("group1");
```

### 26.1.10.12 å¼ºåˆ¶è§¦å‘æ‰€æœ‰ä½œä¸šæŒä¹…åŒ–æ“ä½œ

```cs showLineNumbers {1,4}
 _schedulerFactory.PersistAll();

// è¿˜å¯ä»¥é€šè¿‡ group æ“ä½œ
 _schedulerFactory.PersistAll("group1");
```

### 26.1.10.13 æ ¡å¯¹æ‰€æœ‰ä½œä¸š

```cs showLineNumbers {1,4}
 _schedulerFactory.CollateAll();

// è¿˜å¯ä»¥é€šè¿‡ group æ“ä½œ
 _schedulerFactory.CollateAll("group1");
```

### 26.1.10.14 å¼ºåˆ¶å”¤é†’ä½œä¸šè°ƒåº¦å™¨

æ­£å¸¸æƒ…å†µä¸‹ï¼Œä½œä¸šè°ƒåº¦å™¨ä¼šè‡ªåŠ¨ç®¡ç† `CPU` ä¼‘çœ å’Œå”¤é†’ï¼Œä½†ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹éœ€è¦å¼ºåˆ¶å”¤é†’ä½œä¸šè°ƒåº¦å™¨ï¼ˆæ¯”å¦‚è°ƒåº¦å™¨å‡æ­»äº†ï¼Œè¢«å›æ”¶äº†...ï¼‰ï¼Œå¯é€šè¿‡ä»¥ä¸‹æ–¹å¼ï¼š

```cs showLineNumbers
_schedulerFactory.CancelSleep();
```

## 26.1.11 ä½œä¸šè®¡åˆ’ `IScheduler`

ä½œä¸šè®¡åˆ’ `Scheduler` çš„é»˜è®¤å®ç°æ¥å£æ˜¯ `IScheduler`ï¼Œè¯¥æ¥å£ä¸»è¦ç”¨æ¥æ“ä½œå½“å‰ï¼ˆå•ä¸ªï¼‰ä½œä¸šã€‚

### 26.1.11.1 è·å– `SchedulerModel` å®ä¾‹

è·å– `SchedulerModel` ä¹‹åå¯ç›´æ¥è®¿é—® `JobDetail` å’Œ `Trigger` å¯¹è±¡ã€‚

```cs showLineNumbers
var schedulerModel = scheduler.GetModel();
```

### 26.1.11.2 è·å– `SchedulerBuilder`

```cs showLineNumbers
var schedulerBuilder = scheduler.GetBuilder();
```

### 26.1.11.3 è·å– `JobBuilder`

```cs showLineNumbers
var jobBuilder = scheduler.GetJobBuilder();
```

### 26.1.11.4 è·å– `TriggerBuilder` é›†åˆ

```cs showLineNumbers
var triggerBuilders = scheduler.GetTriggerBuilders();
```

### 26.1.11.5 è·å–å•ä¸ª `TriggerBuilder`

```cs showLineNumbers
var triggerBuilder = scheduler.GetTriggerBuilder("trigger1");
```

### 26.1.11.6 è·å–ä½œä¸šä¿¡æ¯

```cs showLineNumbers
var jobDetail = scheduler.GetJobDetail();
```

### 26.1.11.7 è·å–ä½œä¸šè§¦å‘å™¨é›†åˆ

```cs showLineNumbers
var triggers = scheduler.GetTriggers();
```

### 26.1.11.8 è·å–å•ä¸ªä½œä¸šè§¦å‘å™¨

```cs showLineNumbers {1,6}
// è¿”å› ScheduleResult æ–¹å¼
var scheduleResult = scheduler.TryGetTrigger("trigger1", out var trigger);    // å¦‚æœå­˜åœ¨è¿”å› ScheduleResult.Succeed
var scheduleResult = scheduler.TryGetTrigger("not_found", out var trigger);    // => ScheduleResult.NotFound
var scheduleResult = scheduler.TryGetTrigger("", out var trigger);    // => ScheduleResult.NotIdentify

// è¿”å› Trigger æ–¹å¼
var trigger = scheduler.GetTrigger("trigger1"); // å¦‚æœå­˜åœ¨è¿”å› Trigger
var trigger = scheduler.GetTrigger("not_found"); // => null
var trigger = scheduler.GetTrigger(""); // => null
```

### 26.1.11.9 ä¿å­˜ä½œä¸šè§¦å‘å™¨

ä¿å­˜ä½œä¸šè§¦å‘å™¨æ˜¯æ¡†æ¶æä¾›å¼ºå¤§ä¸”ç®€å•çš„æ–¹æ³•ï¼Œæ”¯æŒ `æ–°å¢`ï¼Œ`ç¼–è¾‘`ï¼Œ`åˆ é™¤` ä½œä¸šè§¦å‘å™¨ï¼Œä¹Ÿå°±æ˜¯ä¸‰å¤§æ“ä½œéƒ½å¯ä»¥ç›´æ¥é€šè¿‡æ­¤æ–¹æ³•ç›´æ¥æ“ä½œã€‚

```cs showLineNumbers
// è¿”å› ScheduleResult ç±»å‹
var scheduleResult = scheduler.TrySaveTrigger(triggerBuilder, out var trigger);

// æ— è¿”å›å€¼ï¼Œæ”¯æŒå¤šä¸ª
scheduler.SaveTrigger(triggerBuilder1, triggerBuilder2, ...)
```

:::tip å…³äºä¿å­˜ä½œä¸šè§¦å‘å™¨çš„èƒŒåè¡Œä¸º

é»˜è®¤æƒ…å†µä¸‹ï¼Œä¿å­˜ä½œä¸šè§¦å‘å™¨éœ€è¦ä¼ é€’ `TriggerBuilder` å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å¯é€šè¿‡ `GetTriggerBuilder(triggerId)` è·å–ï¼Œå¦‚ï¼š

```cs showLineNumbers
var triggerBuilder = scheduler.GetTriggerBuilder("trigger1");
```

æ­¤æ—¶å®ƒçš„å†…éƒ¨ `Behavior` å±æ€§è¢«æ ‡è®°ä¸º `PersistenceBehavior.Updated`ï¼Œä¹Ÿå°±æ˜¯æ›´æ–°çŠ¶æ€ï¼Œé‚£ä¹ˆå¯¹äºè¿™ä¸ªæ„å»ºå™¨çš„ä»»ä½•æ“ä½œéƒ½ä¼šæ ‡è®°ä¸º `æ›´æ–°` æ“ä½œã€‚

å¦‚æœé€šè¿‡ `.Appended()` æˆ– `.Removed()` æ–¹æ³•æ ‡è®°ä¹‹åï¼Œé‚£ä¹ˆå®ƒçš„æ“ä½œè¡Œä¸ºå°±å‘ç”Ÿå˜åŒ–äº†ã€‚

- **å¦‚æœè¢«æ ‡è®°ä¸º `.Appended()`**ï¼Œé‚£ä¹ˆå®ƒå°†è¿›è¡Œ `æ–°å¢` æ“ä½œã€‚å¦‚ï¼š

```cs showLineNumbers
triggerBuilder.Appended();
```

- **å¦‚æœè¢«æ ‡è®°ä¸º `.Removed()`**ï¼Œé‚£ä¹ˆå®ƒå°†è¿›è¡Œ `åˆ é™¤` æ“ä½œã€‚å¦‚ï¼š

```cs showLineNumbers
triggerBuilder.Removed();
```

æ¯”å¦‚ä»¥ä¸‹çš„ä»£ç å®åˆ™æ˜¯ `æ–°å¢` æˆ– `åˆ é™¤` æˆ– `æ›´æ–°` æ“ä½œï¼š

```cs showLineNumbers {1,4,8}
// å®é™…åšæ–°å¢æ“ä½œ
var scheduleResult = scheduler.TrySaveTrigger(Triggers.PeriodSeconds(5), out var trigger); // Create æ–¹æ³•é»˜è®¤æ ‡è®°ä¸º Appended

// å®é™…åšåˆ é™¤æ“ä½œ
var triggerBuilder = scheduler.GetTriggerBuilder("trigger1");
var scheduleResult = scheduler.TrySaveTrigger(triggerBuilder?.Removed(), out var trigger); // æ ‡è®°ä¸º Removed

// å®é™…åšæ›´æ–°æ“ä½œ
var scheduleResult = scheduler.TrySaveTrigger(Trigggers.PeriodSeconds(5).Updated(), out var trigger); // Create æ–¹æ³•é»˜è®¤æ ‡è®°ä¸º Appendedï¼Œä½†è°ƒç”¨ Updated() æ–¹æ³•
```

:::

### 26.1.11.10 æ›´æ–°ä½œä¸šä¿¡æ¯

```cs showLineNumbers
// è¿”å› ScheduleResult ç±»å‹
var scheduleResult = scheduler.TryUpdateDetail(jobBuilder, out var jobDetail);

// æ— è¿”å›å€¼ï¼Œæ”¯æŒå¤šä¸ª
scheduler.UpdateDetail(jobBuilder)
```

### 26.1.11.11 æ·»åŠ ä½œä¸šè§¦å‘å™¨

```cs showLineNumbers
// è¿”å› ScheduleResult ç±»å‹
var scheduleResult = scheduler.TryAddTrigger(triggerBuilder, out var trigger);

// æ— è¿”å›å€¼ï¼Œæ”¯æŒå¤šä¸ª
scheduler.AddTrigger(triggerBuilder1, triggerBuilder2, ...);
```

### 26.1.11.12 æ›´æ–°ä½œä¸šè§¦å‘å™¨

```cs showLineNumbers
// è¿”å› ScheduleResult ç±»å‹
var scheduleResult = scheduler.TryUpdateTrigger(triggerBuilder, out var trigger);

// æ— è¿”å›å€¼ï¼Œæ”¯æŒå¤šä¸ª
scheduler.UpdateTrigger(triggerBuilder1, triggerBuilder2, ...);
```

### 26.1.11.13 åˆ é™¤ä½œä¸šè§¦å‘å™¨

```cs showLineNumbers
// è¿”å› ScheduleResult ç±»å‹
var scheduleResult = scheduler.TryRemoveTrigger("trigger1", out var trigger);

// æ— è¿”å›å€¼ï¼Œæ”¯æŒå¤šä¸ª
scheduler.RemoveTrigger("trigger1", "trigger2", ...);
```

### 26.1.11.14 åˆ é™¤å½“å‰ä½œä¸š

```cs showLineNumbers
// è¿”å› ScheduleResult ç±»å‹
var scheduleResult = scheduler.TryRemove();

// æ— è¿”å›å€¼
scheduler.Remove();
```

### 26.1.11.15 åˆ¤æ–­ä½œä¸šè§¦å‘å™¨æ˜¯å¦å­˜åœ¨

```cs showLineNumbers
bool isExist = scheduler.ContainsTrigger("trigger1");
```

### 26.1.11.16 å¯åŠ¨ä½œä¸šè§¦å‘å™¨

```cs showLineNumbers
bool succeed = scheduler.StartTrigger("trigger1");
```

### 26.1.11.17 æš‚åœä½œä¸šè§¦å‘å™¨

```cs showLineNumbers
bool succeed = scheduler.PauseTrigger("trigger1");
```

### 26.1.11.18 å¼ºåˆ¶è§¦å‘ä½œä¸šæŒä¹…åŒ–æ“ä½œ

```cs showLineNumbers
scheduler.Persist();
```

### 26.1.11.19 å¯åŠ¨å½“å‰ä½œä¸š

```cs showLineNumbers
scheduler.Start();
```

### 26.1.11.20 æš‚åœå½“å‰ä½œä¸š

```cs showLineNumbers
scheduler.Start();
```

### 26.1.11.21 æ ¡å¯¹å½“å‰ä½œä¸š

```cs showLineNumbers
scheduler.Collate();
```

### 26.1.11.22 å¼ºåˆ¶åˆ·æ–°å½“å‰ä½œä¸š

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.3.3 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬é€šè¿‡ `_schedulerFactory.GetJob("jobId")` è·å–åˆ°ä½œä¸šä¹‹åï¼Œç„¶åå¯¹è¿™ä¸ªä½œä¸šè¿›è¡Œæ“ä½œï¼Œ**ä½†æ“ä½œä¹‹åè¿™ä¸ªå¯¹è±¡å¹¶ä¸èƒ½åŒæ­¥æ›´æ”¹ï¼Œéœ€è¦åå¤è°ƒç”¨ `GetJob` æ–¹æ³•ã€‚**ã€‚

æ‰€ä»¥åœ¨ `Furion 4.8.3.3+` ç‰ˆæœ¬ä¹‹åï¼Œ**`IScheduler` ä»»ä½•æ“ä½œéƒ½å°†è‡ªåŠ¨è°ƒç”¨ `Reload()` æ–¹æ³•åˆ·æ–°å˜é‡**ã€‚

```cs showLineNumbers
// ä¹Ÿå¯ä»¥è‡ªå·±æ‰‹åŠ¨å¼ºåˆ¶åˆ·æ–°ï¼ˆé€šå¸¸ä¸éœ€è¦è°ƒç”¨ä¸‹é¢ä»£ç ~~ï¼‰
scheduler.Reload();
```

### 26.1.11.23 è½¬æ¢æˆ `JSON` æ ¼å¼

```cs showLineNumbers
var json = scheduler.ConvertToJSON();
var json = scheduler.ConvertToJSON(NamingConventions.CamelCase);
```

### 26.1.11.24 è½¬æ¢æˆå¯æšä¸¾å­—å…¸

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.4 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

é€šå¸¸æˆ‘ä»¬åœ¨å¼€å‘åº”ç”¨æ—¶ï¼Œéœ€è¦å°†ä½œä¸šè®¡åˆ’ä¿¡æ¯è¿›è¡Œæ‹†è§£ï¼Œæ¯”å¦‚ä¸€ä¸ªä½œä¸šè®¡åˆ’åŒ…å«ä¸¤ä¸ªä½œä¸šè§¦å‘å™¨ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ `scheduler.GetEnumerable()` æ–¹æ³•ç”Ÿæˆå¯æšä¸¾å­—å…¸å¯¹è±¡ï¼Œå­—å…¸ä¸­çš„é¡¹æ•°é‡ç­‰äºä½œä¸šè§¦å‘å™¨æ•°é‡ã€‚

```cs showLineNumbers {1}
foreach (var (jobDetail, trigger) in scheduler.GetEnumerable())
{
      // ....
}
```

## 26.1.12 ä½œä¸šæŒä¹…åŒ–å™¨ `IJobPersistence`

### 26.1.12.1 å…³äºä½œä¸šæŒä¹…åŒ–å™¨

ä½œä¸šæŒä¹…åŒ–å™¨æŒ‡çš„æ˜¯å¯ä»¥é€šè¿‡å­˜å‚¨ä»‹è´¨å¦‚æ•°æ®åº“ä¸­åŠ è½½ä½œä¸šä¿¡æ¯åˆ°å†…å­˜ä¸­ï¼Œåˆå¯ä»¥å°†å†…å­˜ä¸­ä½œä¸šè°ƒåº¦å™¨çš„ä½œä¸šä¿¡æ¯å®æ—¶åŒæ­¥å›å­˜å‚¨ä»‹è´¨ä¸­ã€‚

### 26.1.12.2 å®ç°ä½œä¸šæŒä¹…åŒ–å™¨

è°ƒåº¦ä½œä¸šæœåŠ¡æä¾›äº†éå¸¸ç®€å•çš„ `IJobPersistence` æ¥å£ï¼Œåªéœ€å®ç°è¯¥æ¥å£å³å¯å®ç°æŒä¹…åŒ–ï¼Œå¦‚å®ç°æ•°æ®åº“æŒä¹…åŒ–ï¼š

```cs showLineNumbers {1,3,9,18,24}
public class DbJobPersistence : IJobPersistence
{
    public IEnumerable<SchedulerBuilder> Preload()
    {
        // ä½œä¸šè°ƒåº¦æœåŠ¡å¯åŠ¨æ—¶è¿è¡Œæ—¶åˆå§‹åŒ–ï¼Œå¯é€šè¿‡æ•°æ®åº“åŠ è½½ï¼Œæˆ–è€…å…¶ä»–æ–¹å¼
        return Array.Empty<SchedulerBuilder>();
    }

    public SchedulerBuilder OnLoading(SchedulerBuilder builder)
    {
        // å¦‚æœæ˜¯æ›´æ–°æ“ä½œï¼Œåˆ™ return builder.Updated(); å°†ç”Ÿæˆ UPDATE è¯­å¥
        // å¦‚æœæ˜¯æ–°å¢æ“ä½œï¼Œåˆ™ return builder.Appended(); å°†ç”Ÿæˆ INSERT è¯­å¥
        // å¦‚æœæ˜¯åˆ é™¤æ“ä½œï¼Œåˆ™ return builder.Removed(); å°†ç”Ÿæˆ DELETE è¯­å¥
        // å¦‚æœæ— éœ€æ ‡è®°æ“ä½œï¼Œè¿”å› builder é»˜è®¤å€¼å³å¯
        return builder;
    }

    public void OnChanged(PersistenceContext context)
    {
        var sql = context.ConvertToSQL("job_detail");
        // è¿™é‡Œæ‰§è¡Œ sql å³å¯ ğŸ’–
    }

    public void OnTriggerChanged(PersistenceTriggerContext context)
    {
        var sql = context.ConvertToSQL("job_trigger");
        // è¿™é‡Œæ‰§è¡Œ sql å³å¯ ğŸ’–
    }
}
```

ä¹‹ååœ¨ `Startup.cs` ä¸­æ³¨å†Œï¼š

```cs showLineNumbers {3}
services.AddSchedule(options =>
{
      options.AddPersistence<DbJobPersistence>();
});
```

å¯èƒ½æœ‰äº›å¼€å‘è€…çœ‹åˆ°è¿™é‡Œä¸€è„¸ä¸è§£ï¼ŒæŒä¹…åŒ–ä¸åº”è¯¥è¿™ä¹ˆç®€å•å•Šï¼å…¶å®å°±æ˜¯è¿™ä¹ˆç®€å•....

### 26.1.12.3 `IJobPersistence` è¯¦ç»†è¯´æ˜

`IJobPersistence` æ¥å£æä¾›äº†ä»¥ä¸‹å››ä¸ªæ–¹æ³•ï¼š

- **`Preload`ï¼šä½œä¸šè°ƒåº¦æœåŠ¡å¯åŠ¨æ—¶è°ƒç”¨ï¼Œå¯åœ¨è¿™é‡ŒåŠ¨æ€åˆ›å»ºä½œä¸šè®¡åˆ’æ„å»ºå™¨å¹¶è¿”å›ã€‚**

```cs showLineNumbers {1,3,5,9,13,16}
public IEnumerable<SchedulerBuilder> Preload()
{
      // å¯ä»¥è¿™é‡ŒæŸ¥è¯¢æ•°æ®åº“è¿”å›

      // è¿™é‡Œå¯ä»¥æ‰«æç¨‹åºé›†åŠ¨æ€åˆ›å»ºè¿”å›
      return App.EffectiveTypes.Where(t => t.IsJobType())
                               .Select(t => SchedulerBuilder.Create(JobBuilder.Create(t), t.ScanTriggers()));

      // å¦‚æœç±»å‹è´´æœ‰ [JobDetail] ç‰¹æ€§ï¼Œè¿˜å¯ä»¥ä¸€é”®æ‰«æè¿”å›
      return App.EffectiveTypes.Where(t => t.IsJobType())
                               .Select(t => t.ScanToBuilder());

      // è¿˜å¯ä»¥æ›´ç®€å•~~
      return App.EffectiveTypes.ScanToBuilders();

      // ä¹Ÿå¯ä»¥æ‰‹åŠ¨è¿”å›
      return new[]
      {
            SchedulerBuilder.Create(JobBuilder.Create<MyJob>(), Triggers.Minutely())
      }
}
```

- **`OnLoading`ï¼šä½œä¸šè®¡åˆ’åˆå§‹åŒ–é€šçŸ¥ï¼Œé€šå¸¸åœ¨è¿™é‡Œè¿›ä¸€æ­¥ä¿®æ”¹åˆå§‹åŒ–ä½œä¸šè®¡åˆ’æ„å»ºå™¨ã€‚**

åœ¨ä½œä¸šè°ƒåº¦å™¨æœåŠ¡å¯åŠ¨æ—¶ä¼šéå†ç¨‹åºä¸­æ‰€æœ‰ä½œä¸šè®¡åˆ’æ„å»ºå™¨ï¼Œç„¶åé€æ¡è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå¼€å‘è€…å¯ä»¥åœ¨è¿™é‡Œè¿›ä¸€æ­¥ä¿®æ”¹ä½œä¸šè®¡åˆ’æ„å»ºå™¨æ•°æ®ï¼Œä¹‹å**é€‰æ‹©æ€§è¿”å› `SchedulerBuilder` çš„æŒä¹…åŒ–è¡Œä¸º**ã€‚

`SchedulerBuilder` æä¾› `Updated()`ï¼Œ`Appended()` å’Œ `Removed()` æ¥ä½œä¸ºæŒä¹…åŒ–è¡Œä¸ºæ ‡è®°ã€‚æ­¤æ ‡è®°å°†å†³å®šæœ€ç»ˆç”Ÿæˆçš„ `SQL` æ˜¯ `UPDATE` è¿˜æ˜¯ `INSERT` è¿˜æ˜¯ `UPDATE`ã€‚

```cs showLineNumbers {4,8,12-13,16}
public SchedulerBuilder OnLoading(SchedulerBuilder builder)
{
      // æ¯”å¦‚è¿™é‡Œä¿®æ”¹ä½œä¸šä¿¡æ¯æè¿°
      builder.GetJobBuilder()
             .SetDescription("è¿™æ˜¯æè¿°~~");

      // è¿˜å¯ä»¥ä¿®æ”¹è§¦å‘å™¨
      builder.GetTriggerBuilder("trigger1")
             .SetDescription("è¿™æ˜¯è§¦å‘å™¨æè¿°~~");

      // è¿˜å¯ä»¥é€šè¿‡æ•°æ®åº“æŸ¥è¯¢è¿”å›å¡«å…… ğŸ˜
      builder.GetJobBuilder()
             .LoadFrom(dbJobDetail); // dbJobDetail è¡¨ç¤ºæ ¹æ® jobId æŸ¥è¯¢æ•°æ®åº“è¿”å›çš„å¯¹è±¡

      // è¿˜å¯ä»¥è·å–æšä¸¾å¯¹è±¡é€æ¡æ›´æ–°
      foreach(var (jobBuilder, triggerBuilder) in builder.GetEnumerable())
      {
            jobBuilder.SetDescription("....");
            triggerBuilder.Updated();     // æ ‡è®°è¯¥è§¦å‘å™¨å·²è¢«æ›´æ–°ï¼Œå¹¶ç”Ÿæˆ UPDATE è¯­å¥
            triggerBuilder.Removed();     // æ ‡è®°è¯¥è§¦å‘å™¨å·²è¢«åˆ é™¤ï¼Œå¹¶ç”Ÿæˆ DELETE è¯­å¥
      }

      // æ ‡è®°ä»å…¶ä»–åœ°æ–¹æ›´æ–°ï¼Œæ¯”å¦‚æ•°æ®åº“
      return builder;
}
```

å¦‚æœå­˜å‚¨ä»‹è´¨ï¼ˆå¦‚æ•°æ®åº“ï¼‰å·²ç»åˆ é™¤è¯¥ä½œä¸šï¼Œå¼€å‘è€…å¯ä»¥æ ‡è®°ä¸º `Removed()`ï¼Œè¿™æ ·è¯¥ä½œä¸šä¼šä»å†…å­˜ä¸­ç§»é™¤ã€‚

```cs showLineNumbers {3,6}
public SchedulerBuilder OnLoading(SchedulerBuilder builder)
{
      // æ¯”å¦‚è¿™é‡Œæ ¹æ® jobId æŸ¥è¯¢æ•°æ®åº“å·²ç»ç¡®è®¤æ•°æ®ä¸å­˜åœ¨äº†

      // æ ‡è®°ä»å…¶ä»–åœ°æ–¹ç§»é™¤
      return builder.Removed();
}
```

å¦‚æœå­˜å‚¨ä»‹è´¨ï¼ˆå¦‚æ•°æ®åº“ï¼‰æ–°å¢äº†æ–°ä½œä¸šä½†å†…å­˜ä¸­ä¸å­˜åœ¨ï¼Œå¼€å‘è€…å¯ä»¥æ ‡è®°ä¸º `Append()`ï¼Œè¿™æ ·è¯¥ä½œä¸šä¼šæ·»åŠ åˆ°å†…å­˜ä¸­ï¼Œ**ä½†åŸæœ‰çš„ `builder` å°±ä¼šè¢«ä¸¢å¼ƒ**ã€‚

```cs showLineNumbers {4,6,8,11}
public SchedulerBuilder OnLoading(SchedulerBuilder builder)
{
      // æ¯”å¦‚åœ¨è¿™é‡ŒåŠ¨æ€åˆ›å»ºä½œä¸šè®¡åˆ’æ„å»ºå™¨
      var newBuilder = SchedulerBuilder.Create<MyJob>(Triggers.Minutely());
      // è¿˜å¯ä»¥å…‹éš†ä¸€ä¸ª
      var newBuilder = SchedulerBuilder.Clone(builder);
      // è¿˜å¯ä»¥è¯»å–é…ç½®æ–‡ä»¶/JSON
      var newBuilder = SchedulerBuilder.From(json);

      // è¿”å›æ–°çš„ä½œä¸šè®¡åˆ’æ„å»ºå™¨å¹¶æ ‡è®°ä¸ºæ–°å¢
      return newBuilder.Appended();
}
```

- **`OnChanged`ï¼šä½œä¸šè®¡åˆ’ `Scheduler` çš„ `JobDetail` å˜åŒ–æ—¶è°ƒç”¨ã€‚**

åªè¦ä½œä¸šè®¡åˆ’æœ‰ä»»ä½•å˜åŒ–éƒ½å°†è§¦å‘è¯¥æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æœ‰ä¸€ä¸ª `PersistenceContext` ç±»å‹çš„å‚æ•° `context`ï¼Œ`PersistenceContext` åŒ…å«ä»¥ä¸‹æˆå‘˜ï¼š

- **`PersistenceContext` å±æ€§åˆ—è¡¨**
  - `JobId`ï¼šä½œä¸š `Id`ï¼Œ`string` ç±»å‹
  - `JobDetail`ï¼šä½œä¸šä¿¡æ¯ï¼Œ`JobDetail` ç±»å‹
  - `Behavior`ï¼šæŒä¹…åŒ–è¡Œä¸ºï¼Œ`PersistenceBehavior` æšä¸¾ç±»å‹ï¼ŒåŒ…å« `Appended`ï¼Œ`Updated` å’Œ `Removed` ä¸‰ä¸ªæšä¸¾æˆå‘˜
- **`PersistenceContext` æ–¹æ³•åˆ—è¡¨**
  - `ConvertToSQL`ï¼šå°† `PersistenceContext` è½¬æ¢æˆ `SQL` å­—ç¬¦ä¸²ï¼Œ`Behavior` å±æ€§å€¼ä¸åŒï¼Œç”Ÿæˆçš„ `SQL` ä¸åŒ
  - `ConvertToJSON`ï¼šå°† `PersistenceContext` è½¬æ¢æˆ `JSON` å­—ç¬¦ä¸²
  - `ConvertToMonitor`ï¼šå°† `PersistenceContext` è½¬æ¢æˆ `Monitor` å­—ç¬¦ä¸²
  - `ToString`ï¼šå°† `PersistenceContext` è½¬æ¢æˆ `ç®€è¦` å­—ç¬¦ä¸²
  - `GetNaming`ï¼šæä¾›å°†ç‰¹å®šå­—ç¬¦ä¸²è¾“å‡ºä¸åŒçš„å‘½åè§„åˆ™å­—ç¬¦ä¸²

```cs showLineNumbers {4,6,8,10}
public void OnChanged(PersistenceContext context)
{
      // è¾“å‡º CamelCaseï¼ˆé©¼å³°å‘½åæ³•ï¼‰SQL è¯­å¥ï¼Œé»˜è®¤å€¼
      var sql = context.ConvertToSQL("job_detail");
      // è¾“å‡º Pascalï¼ˆå¸•æ–¯å¡å‘½åæ³•ï¼‰ SQL è¯­å¥
      var sql = context.ConvertToSQL("job_detail", NamingConventions.Pascal);
      // è¾“å‡º UnderScoreCaseï¼ˆä¸‹åˆ’çº¿å‘½åæ³•ï¼‰ SQL è¯­å¥
      var sql = context.ConvertToSQL("job_detail", NamingConventions.UnderScoreCase);

      // ä½ è¦åšçš„åªæ˜¯æ‰§è¡Œ SQL äº†ï¼ï¼ï¼ ğŸ˜
}
```

- **`OnTriggerChanged`ï¼šä½œä¸šè®¡åˆ’ `Scheduler` çš„è§¦å‘å™¨ `Trigger` å˜åŒ–æ—¶è°ƒç”¨ã€‚**

åªè¦ä½œä¸šè®¡åˆ’**è§¦å‘å™¨**æœ‰ä»»ä½•å˜åŒ–éƒ½å°†è§¦å‘è¯¥æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æœ‰ä¸€ä¸ª `PersistenceTriggerContext` ç±»å‹çš„å‚æ•° `context`ï¼Œ`PersistenceTriggerContext` ç»§æ‰¿è‡ª `PersistenceContext`ï¼š

- **`PersistenceTriggerContext` å±æ€§åˆ—è¡¨**
  - `JobId`ï¼šä½œä¸š `Id`ï¼Œ`string` ç±»å‹
  - `JobDetail`ï¼šä½œä¸šä¿¡æ¯ï¼Œ`JobDetail` ç±»å‹
  - `TriggerId`ï¼šä½œä¸šè§¦å‘å™¨ `Id`ï¼Œ`string` ç±»å‹
  - `Trigger`ï¼šä½œä¸šè§¦å‘å™¨ï¼Œ`Trigger` ç±»å‹
  - `Behavior`ï¼šæŒä¹…åŒ–è¡Œä¸ºï¼Œ`PersistenceBehavior` æšä¸¾ç±»å‹ï¼ŒåŒ…å« `Appended`ï¼Œ`Updated` å’Œ `Removed` ä¸‰ä¸ªæšä¸¾æˆå‘˜
- **`PersistenceTriggerContext` æ–¹æ³•åˆ—è¡¨**
  - `ConvertToSQL`ï¼šå°† `PersistenceTriggerContext` è½¬æ¢æˆ `SQL` å­—ç¬¦ä¸²ï¼Œ`Behavior` å±æ€§å€¼ä¸åŒï¼Œç”Ÿæˆçš„ `SQL` ä¸åŒ
  - `ConvertToJSON`ï¼šå°† `PersistenceTriggerContext` è½¬æ¢æˆ `JSON` å­—ç¬¦ä¸²ï¼ŒåªåŒ…å« `Trigger`
  - `ConvertAllToJSON`ï¼šå°† `PersistenceTriggerContext` è½¬æ¢æˆ `JSON` å­—ç¬¦ä¸²ï¼ŒåŒ…å« `JobDetail` å’Œ `Trigger`
  - `ConvertToMonitor`ï¼šå°† `PersistenceTriggerContext` è½¬æ¢æˆ `Monitor` å­—ç¬¦ä¸²
  - `ToString`ï¼šå°† `PersistenceTriggerContext` è½¬æ¢æˆ `ç®€è¦` å­—ç¬¦ä¸²
  - `GetNaming`ï¼šæä¾›å°†ç‰¹å®šå­—ç¬¦ä¸²è¾“å‡ºä¸åŒçš„å‘½åè§„åˆ™å­—ç¬¦ä¸²

```cs showLineNumbers {4,6,8,10}
public void OnTriggerChanged(PersistenceTriggerContext context)
{
      // è¾“å‡º CamelCaseï¼ˆé©¼å³°å‘½åæ³•ï¼‰SQL è¯­å¥ï¼Œé»˜è®¤å€¼
      var sql = context.ConvertToSQL("job_trigger");
      // è¾“å‡º Pascalï¼ˆå¸•æ–¯å¡å‘½åæ³•ï¼‰ SQL è¯­å¥
      var sql = context.ConvertToSQL("job_trigger", NamingConventions.Pascal);
      // è¾“å‡º UnderScoreCaseï¼ˆä¸‹åˆ’çº¿å‘½åæ³•ï¼‰ SQL è¯­å¥
      var sql = context.ConvertToSQL("job_trigger", NamingConventions.UnderScoreCase);

      // ä½ è¦åšçš„åªæ˜¯æ‰§è¡Œ SQL äº†ï¼ï¼ï¼ ğŸ˜
}
```

:::tip å°çŸ¥è¯†

é»˜è®¤æƒ…å†µä¸‹ï¼Œç”Ÿæˆçš„ `SQL` å±äºæ ‡å‡† `SQL` è¯­å¥ï¼Œä½†æœªå¿…é€‚åˆæ‰€æœ‰æ•°æ®åº“ç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŒ‡å®š `BuildSqlType` æ¥ç”Ÿæˆç‰¹å®šæ•°æ®åº“çš„è¯­å¥ï¼Œå¦‚ï¼š

```cs showLineNumbers {4}
services.AddSchedule(options =>
{
      // é…ç½®è¾“å‡º SQL çš„æ•°æ®åº“ç±»å‹ï¼ŒFurion 4.8.2.3+
      options.BuildSqlType = SqlTypes.SqlServer;
});
```

:::

### 26.1.12.4 å„ç±»æ•°æ®åº“åˆ›å»ºä½œä¸šæŒä¹…åŒ–è¡¨è¯­å¥

<Tabs
  defaultValue="Sqlite"
  values={[
    {
      label: "Sqlite",
      value: "Sqlite",
    },
    {
      label: "SqlServer",
      value: "SqlServer",
    },
    {
      label: "MySQL",
      value: "MySQL",
    },
    {
      label: "PostgreSQL",
      value: "PostgreSQL",
    },
    {
      label: "Oracle",
      value: "Oracle",
    },
    {
      label: "Firebird",
      value: "Firebird",
    },
    {
      label: "EFCore",
      value: "EFCore",
    },
    {
      label: "SqlSugar",
      value: "SqlSugar",
    }
  ]}
>
  <TabItem value="Sqlite">

**å¯è‡ªè¡Œè°ƒæ•´åˆ—å‘½åè§„åˆ™ã€‚**

```sql showLineNumbers {1,14}
CREATE TABLE "JobDetails" (
    "Id" INTEGER NOT NULL CONSTRAINT "PK_JobDetails" PRIMARY KEY AUTOINCREMENT,
    "JobId" TEXT NOT NULL,
    "GroupName" TEXT NULL,
    "JobType" TEXT NULL,
    "AssemblyName" TEXT NULL,
    "Description" TEXT NULL,
    "Concurrent" INTEGER NOT NULL,
    "IncludeAnnotations" INTEGER NOT NULL,
    "Properties" TEXT NULL,
    "UpdatedTime" TEXT NULL
);

CREATE TABLE "JobTriggers" (
    "Id" INTEGER NOT NULL CONSTRAINT "PK_JobTriggers" PRIMARY KEY AUTOINCREMENT,
    "TriggerId" TEXT NOT NULL,
    "JobId" TEXT NOT NULL,
    "TriggerType" TEXT NULL,
    "AssemblyName" TEXT NULL,
    "Args" TEXT NULL,
    "Description" TEXT NULL,
    "Status" INTEGER NOT NULL,
    "StartTime" TEXT NULL,
    "EndTime" TEXT NULL,
    "LastRunTime" TEXT NULL,
    "NextRunTime" TEXT NULL,
    "NumberOfRuns" INTEGER NOT NULL,
    "MaxNumberOfRuns" INTEGER NOT NULL,
    "NumberOfErrors" INTEGER NOT NULL,
    "MaxNumberOfErrors" INTEGER NOT NULL,
    "NumRetries" INTEGER NOT NULL,
    "RetryTimeout" INTEGER NOT NULL,
    "StartNow" INTEGER NOT NULL,
    "RunOnStart" INTEGER NOT NULL,
    "ResetOnlyOnce" INTEGER NOT NULL,
    "UpdatedTime" TEXT NULL
);
```

  </TabItem>
  <TabItem value="SqlServer">

**å¯è‡ªè¡Œè°ƒæ•´åˆ—å‘½åè§„åˆ™ã€‚**

```sql showLineNumbers {1,16}
CREATE TABLE [JobDetails] (
    [Id] int NOT NULL IDENTITY,
    [JobId] nvarchar(max) NOT NULL,
    [GroupName] nvarchar(max) NULL,
    [JobType] nvarchar(max) NULL,
    [AssemblyName] nvarchar(max) NULL,
    [Description] nvarchar(max) NULL,
    [Concurrent] bit NOT NULL,
    [IncludeAnnotations] bit NOT NULL,
    [Properties] nvarchar(max) NULL,
    [UpdatedTime] datetime2 NULL,
    CONSTRAINT [PK_JobDetails] PRIMARY KEY ([Id])
);
GO

CREATE TABLE [JobTriggers] (
    [Id] int NOT NULL IDENTITY,
    [TriggerId] nvarchar(max) NOT NULL,
    [JobId] nvarchar(max) NOT NULL,
    [TriggerType] nvarchar(max) NULL,
    [AssemblyName] nvarchar(max) NULL,
    [Args] nvarchar(max) NULL,
    [Description] nvarchar(max) NULL,
    [Status] bigint NOT NULL,
    [StartTime] datetime2 NULL,
    [EndTime] datetime2 NULL,
    [LastRunTime] datetime2 NULL,
    [NextRunTime] datetime2 NULL,
    [NumberOfRuns] bigint NOT NULL,
    [MaxNumberOfRuns] bigint NOT NULL,
    [NumberOfErrors] bigint NOT NULL,
    [MaxNumberOfErrors] bigint NOT NULL,
    [NumRetries] int NOT NULL,
    [RetryTimeout] int NOT NULL,
    [StartNow] bit NOT NULL,
    [RunOnStart] bit NOT NULL,
    [ResetOnlyOnce] bit NOT NULL,
    [UpdatedTime] datetime2 NULL,
    CONSTRAINT [PK_JobTriggers] PRIMARY KEY ([Id])
);
```

  </TabItem>
  <TabItem value="MySQL">

**å¯è‡ªè¡Œè°ƒæ•´åˆ—å‘½åè§„åˆ™ã€‚**

```sql showLineNumbers {3,17}
ALTER DATABASE CHARACTER SET utf8mb4;

CREATE TABLE `JobDetails` (
    `Id` int NOT NULL AUTO_INCREMENT,
    `JobId` longtext CHARACTER SET utf8mb4 NOT NULL,
    `GroupName` longtext CHARACTER SET utf8mb4 NULL,
    `JobType` longtext CHARACTER SET utf8mb4 NULL,
    `AssemblyName` longtext CHARACTER SET utf8mb4 NULL,
    `Description` longtext CHARACTER SET utf8mb4 NULL,
    `Concurrent` tinyint(1) NOT NULL,
    `IncludeAnnotations` tinyint(1) NOT NULL,
    `Properties` longtext CHARACTER SET utf8mb4 NULL,
    `UpdatedTime` datetime(6) NULL,
    CONSTRAINT `PK_JobDetails` PRIMARY KEY (`Id`)
) CHARACTER SET=utf8mb4;

CREATE TABLE `JobTriggers` (
    `Id` int NOT NULL AUTO_INCREMENT,
    `TriggerId` longtext CHARACTER SET utf8mb4 NOT NULL,
    `JobId` longtext CHARACTER SET utf8mb4 NOT NULL,
    `TriggerType` longtext CHARACTER SET utf8mb4 NULL,
    `AssemblyName` longtext CHARACTER SET utf8mb4 NULL,
    `Args` longtext CHARACTER SET utf8mb4 NULL,
    `Description` longtext CHARACTER SET utf8mb4 NULL,
    `Status` int unsigned NOT NULL,
    `StartTime` datetime(6) NULL,
    `EndTime` datetime(6) NULL,
    `LastRunTime` datetime(6) NULL,
    `NextRunTime` datetime(6) NULL,
    `NumberOfRuns` bigint NOT NULL,
    `MaxNumberOfRuns` bigint NOT NULL,
    `NumberOfErrors` bigint NOT NULL,
    `MaxNumberOfErrors` bigint NOT NULL,
    `NumRetries` int NOT NULL,
    `RetryTimeout` int NOT NULL,
    `StartNow` tinyint(1) NOT NULL,
    `RunOnStart` tinyint(1) NOT NULL,
    `ResetOnlyOnce` tinyint(1) NOT NULL,
    `UpdatedTime` datetime(6) NULL,
    CONSTRAINT `PK_JobTriggers` PRIMARY KEY (`Id`)
) CHARACTER SET=utf8mb4;
```

  </TabItem>
  <TabItem value="PostgreSQL">

**å¯è‡ªè¡Œè°ƒæ•´åˆ—å‘½åè§„åˆ™ã€‚**

```sql showLineNumbers {1,15}
CREATE TABLE "JobDetails" (
    "Id" integer GENERATED BY DEFAULT AS IDENTITY,
    "JobId" text NOT NULL,
    "GroupName" text NULL,
    "JobType" text NULL,
    "AssemblyName" text NULL,
    "Description" text NULL,
    "Concurrent" boolean NOT NULL,
    "IncludeAnnotations" boolean NOT NULL,
    "Properties" text NULL,
    "UpdatedTime" timestamp with time zone NULL,
    CONSTRAINT "PK_JobDetails" PRIMARY KEY ("Id")
);

CREATE TABLE "JobTriggers" (
    "Id" integer GENERATED BY DEFAULT AS IDENTITY,
    "TriggerId" text NOT NULL,
    "JobId" text NOT NULL,
    "TriggerType" text NULL,
    "AssemblyName" text NULL,
    "Args" text NULL,
    "Description" text NULL,
    "Status" bigint NOT NULL,
    "StartTime" timestamp with time zone NULL,
    "EndTime" timestamp with time zone NULL,
    "LastRunTime" timestamp with time zone NULL,
    "NextRunTime" timestamp with time zone NULL,
    "NumberOfRuns" bigint NOT NULL,
    "MaxNumberOfRuns" bigint NOT NULL,
    "NumberOfErrors" bigint NOT NULL,
    "MaxNumberOfErrors" bigint NOT NULL,
    "NumRetries" integer NOT NULL,
    "RetryTimeout" integer NOT NULL,
    "StartNow" boolean NOT NULL,
    "RunOnStart" boolean NOT NULL,
    "ResetOnlyOnce" boolean NOT NULL,
    "UpdatedTime" timestamp with time zone NULL,
    CONSTRAINT "PK_JobTriggers" PRIMARY KEY ("Id")
);
```

  </TabItem>
  <TabItem value="Oracle">

**å¯è‡ªè¡Œè°ƒæ•´åˆ—å‘½åè§„åˆ™ã€‚**

```sql showLineNumbers {1,15}
CREATE TABLE "JobDetails" (
    "Id" NUMBER(10) GENERATED BY DEFAULT ON NULL AS IDENTITY NOT NULL,
    "JobId" NVARCHAR2(2000) NOT NULL,
    "GroupName" NVARCHAR2(2000),
    "JobType" NVARCHAR2(2000),
    "AssemblyName" NVARCHAR2(2000),
    "Description" NVARCHAR2(2000),
    "Concurrent" NUMBER(1) NOT NULL,
    "IncludeAnnotations" NUMBER(1) NOT NULL,
    "Properties" NVARCHAR2(2000),
    "UpdatedTime" TIMESTAMP(7),
    CONSTRAINT "PK_JobDetails" PRIMARY KEY ("Id")
);

CREATE TABLE "JobTriggers" (
    "Id" NUMBER(10) GENERATED BY DEFAULT ON NULL AS IDENTITY NOT NULL,
    "TriggerId" NVARCHAR2(2000) NOT NULL,
    "JobId" NVARCHAR2(2000) NOT NULL,
    "TriggerType" NVARCHAR2(2000),
    "AssemblyName" NVARCHAR2(2000),
    "Args" NVARCHAR2(2000),
    "Description" NVARCHAR2(2000),
    "Status" NUMBER(10) NOT NULL,
    "StartTime" TIMESTAMP(7),
    "EndTime" TIMESTAMP(7),
    "LastRunTime" TIMESTAMP(7),
    "NextRunTime" TIMESTAMP(7),
    "NumberOfRuns" NUMBER(19) NOT NULL,
    "MaxNumberOfRuns" NUMBER(19) NOT NULL,
    "NumberOfErrors" NUMBER(19) NOT NULL,
    "MaxNumberOfErrors" NUMBER(19) NOT NULL,
    "NumRetries" NUMBER(10) NOT NULL,
    "RetryTimeout" NUMBER(10) NOT NULL,
    "StartNow" NUMBER(1) NOT NULL,
    "RunOnStart" NUMBER(1) NOT NULL,
    "ResetOnlyOnce" NUMBER(1) NOT NULL,
    "UpdatedTime" TIMESTAMP(7),
    CONSTRAINT "PK_JobTriggers" PRIMARY KEY ("Id")
);
```

  </TabItem>
  <TabItem value="Firebird">

**å¯è‡ªè¡Œè°ƒæ•´åˆ—å‘½åè§„åˆ™ã€‚**

```sql showLineNumbers {1,15}
CREATE TABLE "JobDetails" (
    "Id" INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    "JobId" BLOB SUB_TYPE TEXT NOT NULL,
    "GroupName" BLOB SUB_TYPE TEXT,
    "JobType" BLOB SUB_TYPE TEXT,
    "AssemblyName" BLOB SUB_TYPE TEXT,
    "Description" BLOB SUB_TYPE TEXT,
    "Concurrent" BOOLEAN NOT NULL,
    "IncludeAnnotations" BOOLEAN NOT NULL,
    "Properties" BLOB SUB_TYPE TEXT,
    "UpdatedTime" TIMESTAMP,
    CONSTRAINT "PK_JobDetails" PRIMARY KEY ("Id")
);

CREATE TABLE "JobTriggers" (
    "Id" INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    "TriggerId" BLOB SUB_TYPE TEXT NOT NULL,
    "JobId" BLOB SUB_TYPE TEXT NOT NULL,
    "TriggerType" BLOB SUB_TYPE TEXT,
    "AssemblyName" BLOB SUB_TYPE TEXT,
    "Args" BLOB SUB_TYPE TEXT,
    "Description" BLOB SUB_TYPE TEXT,
    "Status" BIGINT NOT NULL,
    "StartTime" TIMESTAMP,
    "EndTime" TIMESTAMP,
    "LastRunTime" TIMESTAMP,
    "NextRunTime" TIMESTAMP,
    "NumberOfRuns" BIGINT NOT NULL,
    "MaxNumberOfRuns" BIGINT NOT NULL,
    "NumberOfErrors" BIGINT NOT NULL,
    "MaxNumberOfErrors" BIGINT NOT NULL,
    "NumRetries" INTEGER NOT NULL,
    "RetryTimeout" INTEGER NOT NULL,
    "StartNow" BOOLEAN NOT NULL,
    "RunOnStart" BOOLEAN NOT NULL,
    "ResetOnlyOnce" BOOLEAN NOT NULL,
    "UpdatedTime" TIMESTAMP,
    CONSTRAINT "PK_JobTriggers" PRIMARY KEY ("Id")
);
```

  </TabItem>
  <TabItem value="EFCore">

**å¯è‡ªè¡Œè°ƒæ•´åˆ—å‘½åè§„åˆ™ã€‚**

```cs showLineNumbers {1,56}
public class JobDetail
{
    [Key]
    [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
    public int Id { get; set; }

    /// <summary>
    /// ä½œä¸š Id
    /// </summary>
    public string JobId { get; set; }

    /// <summary>
    /// ä½œä¸šç»„åç§°
    /// </summary>
    public string? GroupName { get; set; }

    /// <summary>
    /// ä½œä¸šå¤„ç†ç¨‹åºç±»å‹
    /// </summary>
    /// <remarks>å­˜å‚¨çš„æ˜¯ç±»å‹çš„ FullName</remarks>
    public string? JobType { get; set; }

    /// <summary>
    /// ä½œä¸šå¤„ç†ç¨‹åºç±»å‹æ‰€åœ¨ç¨‹åºé›†
    /// </summary>
    /// <remarks>å­˜å‚¨çš„æ˜¯ç¨‹åºé›† Name</remarks>
    public string? AssemblyName { get; set; }

    /// <summary>
    /// æè¿°ä¿¡æ¯
    /// </summary>
    public string? Description { get; set; }

    /// <summary>
    /// æ˜¯å¦é‡‡ç”¨å¹¶è¡Œæ‰§è¡Œ
    /// </summary>
    /// <remarks>å¦‚æœè®¾ç½®ä¸º falseï¼Œé‚£ä¹ˆä½¿ç”¨ä¸²è¡Œæ‰§è¡Œ</remarks>
    public bool Concurrent { get; set; } = true;

    /// <summary>
    /// æ˜¯å¦æ‰«æ IJob å®ç°ç±» [Trigger] ç‰¹æ€§è§¦å‘å™¨
    /// </summary>
    public bool IncludeAnnotations { get; set; } = false;

    /// <summary>
    /// ä½œä¸šä¿¡æ¯é¢å¤–æ•°æ®
    /// </summary>
    public string? Properties { get; set; } = "{}";

    /// <summary>
    /// ä½œä¸šæ›´æ–°æ—¶é—´
    /// </summary>
    public DateTime? UpdatedTime { get; set; }
}

public class JobTrigger
{
    [Key]
    [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
    public int Id { get; set; }

    /// <summary>
    /// ä½œä¸šè§¦å‘å™¨ Id
    /// </summary>
    public string TriggerId { get; set; }

    /// <summary>
    /// ä½œä¸š Id
    /// </summary>
    public string JobId { get; set; }

    /// <summary>
    /// ä½œä¸šè§¦å‘å™¨ç±»å‹
    /// </summary>
    /// <remarks>å­˜å‚¨çš„æ˜¯ç±»å‹çš„ FullName</remarks>
    public string? TriggerType { get; set; }

    /// <summary>
    /// ä½œä¸šè§¦å‘å™¨ç±»å‹æ‰€åœ¨ç¨‹åºé›†
    /// </summary>
    /// <remarks>å­˜å‚¨çš„æ˜¯ç¨‹åºé›† Name</remarks>
    public string? AssemblyName { get; set; }

    /// <summary>
    /// ä½œä¸šè§¦å‘å™¨å‚æ•°
    /// </summary>
    /// <remarks>è¿è¡Œæ—¶å°†ååºåˆ—åŒ–ä¸º object[] ç±»å‹å¹¶ä½œä¸ºæ„é€ å‡½æ•°å‚æ•°</remarks>
    public string? Args { get; set; }

    /// <summary>
    /// æè¿°ä¿¡æ¯
    /// </summary>
    public string? Description { get; set; }

    /// <summary>
    /// ä½œä¸šè§¦å‘å™¨çŠ¶æ€
    /// </summary>
    public TriggerStatus Status { get; set; } = TriggerStatus.Ready;

    /// <summary>
    /// èµ·å§‹æ—¶é—´
    /// </summary>
    public DateTime? StartTime { get; set; }

    /// <summary>
    /// ç»“æŸæ—¶é—´
    /// </summary>
    public DateTime? EndTime { get; set; }

    /// <summary>
    /// æœ€è¿‘è¿è¡Œæ—¶é—´
    /// </summary>
    public DateTime? LastRunTime { get; set; }

    /// <summary>
    /// ä¸‹ä¸€æ¬¡è¿è¡Œæ—¶é—´
    /// </summary>
    public DateTime? NextRunTime { get; set; }

    /// <summary>
    /// è§¦å‘æ¬¡æ•°
    /// </summary>
    public long NumberOfRuns { get; set; }

    /// <summary>
    /// æœ€å¤§è§¦å‘æ¬¡æ•°
    /// </summary>
    /// <remarks>
    /// <para>0ï¼šä¸é™åˆ¶</para>
    /// <para>nï¼šN æ¬¡</para>
    /// </remarks>
    public long MaxNumberOfRuns { get; set; }

    /// <summary>
    /// å‡ºé”™æ¬¡æ•°
    /// </summary>
    public long NumberOfErrors { get; set; }

    /// <summary>
    /// æœ€å¤§å‡ºé”™æ¬¡æ•°
    /// </summary>
    /// <remarks>
    /// <para>0ï¼šä¸é™åˆ¶</para>
    /// <para>nï¼šN æ¬¡</para>
    /// </remarks>
    public long MaxNumberOfErrors { get; set; }

    /// <summary>
    /// é‡è¯•æ¬¡æ•°
    /// </summary>
    public int NumRetries { get; set; } = 0;

    /// <summary>
    /// é‡è¯•é—´éš”æ—¶é—´
    /// </summary>
    /// <remarks>é»˜è®¤1000æ¯«ç§’</remarks>
    public int RetryTimeout { get; set; } = 1000;

    /// <summary>
    /// æ˜¯å¦ç«‹å³å¯åŠ¨
    /// </summary>
    public bool StartNow { get; set; } = true;

    /// <summary>
    /// æ˜¯å¦å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡
    /// </summary>
    public bool RunOnStart { get; set; } = false;

    /// <summary>
    /// æ˜¯å¦åœ¨å¯åŠ¨æ—¶é‡ç½®æœ€å¤§è§¦å‘æ¬¡æ•°ç­‰äºä¸€æ¬¡çš„ä½œä¸š
    /// </summary>
    /// <remarks>è§£å†³å› æŒä¹…åŒ–æ•°æ®å·²å®Œæˆä¸€æ¬¡è§¦å‘ä½†å¯åŠ¨æ—¶ä¸å†æ‰§è¡Œçš„é—®é¢˜</remarks>
    public bool ResetOnlyOnce { get; set; } = true;

    /// <summary>
    /// ä½œä¸šè§¦å‘å™¨æ›´æ–°æ—¶é—´
    /// </summary>
    public DateTime? UpdatedTime { get; set; }
}
```

  </TabItem>
  <TabItem value="SqlSugar">

**å¯è‡ªè¡Œè°ƒæ•´åˆ—å‘½åè§„åˆ™ã€‚**

```cs showLineNumbers {2,66}
[SugarTable("JobDetail", "ä½œä¸šä¿¡æ¯è¡¨")]
public class JobDetail
{
    /// <summary>
    /// Id
    /// </summary>
    [SugarColumn(ColumnDescription = "Id", IsPrimaryKey = true, IsIdentity = true)]
    public virtual long Id { get; set; }

    /// <summary>
    /// ä½œä¸š Id
    /// </summary>
    [SugarColumn(ColumnDescription = "ä½œä¸šId")]
    public virtual string JobId { get; set; }

    /// <summary>
    /// ç»„åç§°
    /// </summary>
    [SugarColumn(ColumnDescription = "ç»„åç§°")]
    public string? GroupName { get; set; }

    /// <summary>
    /// ä½œä¸šç±»å‹ FullName
    /// </summary>
    [SugarColumn(ColumnDescription = "ä½œä¸šç±»å‹")]
    public string? JobType { get; set; }

    /// <summary>
    /// ç¨‹åºé›† Name
    /// </summary>
    [SugarColumn(ColumnDescription = "ç¨‹åºé›†")]
    public string? AssemblyName { get; set; }

    /// <summary>
    /// æè¿°ä¿¡æ¯
    /// </summary>
    [SugarColumn(ColumnDescription = "æè¿°ä¿¡æ¯")]
    public string? Description { get; set; }

    /// <summary>
    /// æ˜¯å¦å¹¶è¡Œæ‰§è¡Œ
    /// </summary>
    [SugarColumn(ColumnDescription = "æ˜¯å¦å¹¶è¡Œæ‰§è¡Œ")]
    public bool Concurrent { get; set; } = true;

    /// <summary>
    /// æ˜¯å¦æ‰«æç‰¹æ€§è§¦å‘å™¨
    /// </summary>
    [SugarColumn(ColumnDescription = "æ˜¯å¦æ‰«æç‰¹æ€§è§¦å‘å™¨")]
    public bool IncludeAnnotations { get; set; } = false;

    /// <summary>
    /// é¢å¤–æ•°æ®
    /// </summary>
    [SugarColumn(ColumnDescription = "é¢å¤–æ•°æ®", ColumnDataType = "longtext,text,clob")]
    public string? Properties { get; set; } = "{}";

    /// <summary>
    /// æ›´æ–°æ—¶é—´
    /// </summary>
    [SugarColumn(ColumnDescription = "æ›´æ–°æ—¶é—´")]
    public DateTime? UpdatedTime { get; set; }
}

[SugarTable("JobTrigger", "ä½œä¸šè§¦å‘å™¨è¡¨")]
public class JobTrigger
{
    /// <summary>
    /// Id
    /// </summary>
    [SugarColumn(ColumnDescription = "Id", IsPrimaryKey = true, IsIdentity = true)]
    public virtual long Id { get; set; }

    /// <summary>
    /// è§¦å‘å™¨ Id
    /// </summary>
    [SugarColumn(ColumnDescription = "è§¦å‘å™¨Id")]
    public virtual string TriggerId { get; set; }

    /// <summary>
    /// ä½œä¸š Id
    /// </summary>
    [SugarColumn(ColumnDescription = "ä½œä¸šId")]
    public virtual string JobId { get; set; }

    /// <summary>
    /// è§¦å‘å™¨ç±»å‹ FullName
    /// </summary>
    [SugarColumn(ColumnDescription = "è§¦å‘å™¨ç±»å‹")]
    public string? TriggerType { get; set; }

    /// <summary>
    /// ç¨‹åºé›† Name
    /// </summary>
    [SugarColumn(ColumnDescription = "ç¨‹åºé›†")]
    public string? AssemblyName { get; set; }

    /// <summary>
    /// å‚æ•°
    /// </summary>
    [SugarColumn(ColumnDescription = "å‚æ•°")]
    public string? Args { get; set; }

    /// <summary>
    /// æè¿°ä¿¡æ¯
    /// </summary>
    [SugarColumn(ColumnDescription = "æè¿°ä¿¡æ¯")]
    public string? Description { get; set; }

    /// <summary>
    /// çŠ¶æ€
    /// </summary>
    [SugarColumn(ColumnDescription = "çŠ¶æ€")]
    public TriggerStatus Status { get; set; } = TriggerStatus.Ready;

    /// <summary>
    /// èµ·å§‹æ—¶é—´
    /// </summary>
    [SugarColumn(ColumnDescription = "èµ·å§‹æ—¶é—´")]
    public DateTime? StartTime { get; set; }

    /// <summary>
    /// ç»“æŸæ—¶é—´
    /// </summary>
    [SugarColumn(ColumnDescription = "ç»“æŸæ—¶é—´")]
    public DateTime? EndTime { get; set; }

    /// <summary>
    /// æœ€è¿‘è¿è¡Œæ—¶é—´
    /// </summary>
    [SugarColumn(ColumnDescription = "æœ€è¿‘è¿è¡Œæ—¶é—´")]
    public DateTime? LastRunTime { get; set; }

    /// <summary>
    /// ä¸‹ä¸€æ¬¡è¿è¡Œæ—¶é—´
    /// </summary>
    [SugarColumn(ColumnDescription = "ä¸‹ä¸€æ¬¡è¿è¡Œæ—¶é—´")]
    public DateTime? NextRunTime { get; set; }

    /// <summary>
    /// è§¦å‘æ¬¡æ•°
    /// </summary>
    [SugarColumn(ColumnDescription = "è§¦å‘æ¬¡æ•°")]
    public long NumberOfRuns { get; set; }

    /// <summary>
    /// æœ€å¤§è§¦å‘æ¬¡æ•°ï¼ˆ0:ä¸é™åˆ¶ï¼Œn:Næ¬¡ï¼‰
    /// </summary>
    [SugarColumn(ColumnDescription = "æœ€å¤§è§¦å‘æ¬¡æ•°")]
    public long MaxNumberOfRuns { get; set; }

    /// <summary>
    /// å‡ºé”™æ¬¡æ•°
    /// </summary>
    [SugarColumn(ColumnDescription = "å‡ºé”™æ¬¡æ•°")]
    public long NumberOfErrors { get; set; }

    /// <summary>
    /// æœ€å¤§å‡ºé”™æ¬¡æ•°ï¼ˆ0:ä¸é™åˆ¶ï¼Œn:Næ¬¡ï¼‰
    /// </summary>
    [SugarColumn(ColumnDescription = "æœ€å¤§å‡ºé”™æ¬¡æ•°")]
    public long MaxNumberOfErrors { get; set; }

    /// <summary>
    /// é‡è¯•æ¬¡æ•°
    /// </summary>
    [SugarColumn(ColumnDescription = "é‡è¯•æ¬¡æ•°")]
    public int NumRetries { get; set; }

    /// <summary>
    /// é‡è¯•é—´éš”æ—¶é—´ï¼ˆmsï¼‰
    /// </summary>
    [SugarColumn(ColumnDescription = "é‡è¯•é—´éš”æ—¶é—´(ms)")]
    public int RetryTimeout { get; set; } = 1000;

    /// <summary>
    /// æ˜¯å¦ç«‹å³å¯åŠ¨
    /// </summary>
    [SugarColumn(ColumnDescription = "æ˜¯å¦ç«‹å³å¯åŠ¨")]
    public bool StartNow { get; set; } = true;

    /// <summary>
    /// æ˜¯å¦å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡
    /// </summary>
    [SugarColumn(ColumnDescription = "æ˜¯å¦å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡")]
    public bool RunOnStart { get; set; } = false;

    /// <summary>
    /// æ˜¯å¦åœ¨å¯åŠ¨æ—¶é‡ç½®æœ€å¤§è§¦å‘æ¬¡æ•°ç­‰äºä¸€æ¬¡çš„ä½œä¸š
    /// </summary>
    /// <remarks>è§£å†³å› æŒä¹…åŒ–æ•°æ®å·²å®Œæˆä¸€æ¬¡è§¦å‘ä½†å¯åŠ¨æ—¶ä¸å†æ‰§è¡Œçš„é—®é¢˜</remarks>
    [SugarColumn(ColumnDescription = "æ˜¯å¦åœ¨å¯åŠ¨æ—¶é‡ç½®æœ€å¤§è§¦å‘æ¬¡æ•°ç­‰äºä¸€æ¬¡çš„ä½œä¸š")]
    public bool ResetOnlyOnce { get; set; } = true;

    /// <summary>
    /// æ›´æ–°æ—¶é—´
    /// </summary>
    [SugarColumn(ColumnDescription = "æ›´æ–°æ—¶é—´")]
    public DateTime? UpdatedTime { get; set; }
}
```

  </TabItem>
</Tabs>

## 26.1.13 ä½œä¸šé›†ç¾¤æ§åˆ¶

æ¡†æ¶æä¾›ç®€å•çš„é›†ç¾¤åŠŸèƒ½ï¼Œä½†å¹¶ä¸èƒ½è¾¾åˆ°è´Ÿè½½å‡è¡¡çš„æ•ˆæœï¼Œè€Œä»…ä»…æä¾›äº†æ•…éšœè½¬ç§»çš„åŠŸèƒ½ï¼Œå½“ä¸€ä¸ªæœåŠ¡çš„ä½œä¸šè°ƒåº¦å™¨å®•æœºæ—¶ï¼Œå¦ä¸€ä¸ªæœåŠ¡çš„ä½œä¸šè°ƒåº¦å™¨ä¼šå¯åŠ¨ã€‚

### 26.1.13.1 å®ç°é›†ç¾¤æ•…éšœè½¬ç§»

1. **åˆ›å»º `JobClusterServer` ç±»å¹¶å®ç° `IJobClusterServer`**

```cs showLineNumbers {1,9,21-37,46,55,65}
public class JobClusterServer : IJobClusterServer
{
    /// <summary>
    /// å½“å‰ä½œä¸šè°ƒåº¦å™¨å¯åŠ¨é€šçŸ¥
    /// </summary>
    /// <param name="context">ä½œä¸šé›†ç¾¤æœåŠ¡ä¸Šä¸‹æ–‡</param>
    public void Start(JobClusterContext context)
    {
        // åœ¨ä½œä¸šé›†ç¾¤è¡¨ä¸­ï¼Œå¦‚æœ clusterId ä¸å­˜åœ¨ï¼Œåˆ™æ–°å¢ä¸€æ¡ï¼ˆå¦åˆ™æ›´æ–°ä¸€æ¡ï¼‰ï¼Œå¹¶è®¾ç½® status ä¸º ClusterStatus.Waiting
    }

    /// <summary>
    /// ç­‰å¾…è¢«å”¤é†’
    /// </summary>
    /// <param name="context">ä½œä¸šé›†ç¾¤æœåŠ¡ä¸Šä¸‹æ–‡</param>
    /// <returns><see cref="Task"/></returns>
    public async Task WaitingForAsync(JobClusterContext context)
    {
        var clusterId = context.ClusterId;

        while (true)
        {
            try
            {
                // åœ¨è¿™é‡ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œæ ¹æ®ä»¥ä¸‹ä¸¤ç§æƒ…å†µå¤„ç†
                // 1) å¦‚æœä½œä¸šé›†ç¾¤è¡¨å·²æœ‰ status ä¸º ClusterStatus.Working åˆ™ç»§ç»­å¾ªç¯
                // 2) å¦‚æœä½œä¸šé›†ç¾¤è¡¨ä¸­è¿˜æ²¡æœ‰å…¶ä»–æœåŠ¡æˆ–åªæœ‰è‡ªå·±ï¼Œåˆ™æ’å…¥ä¸€æ¡é›†ç¾¤æœåŠ¡æˆ–è°ƒç”¨ await WorkNowAsync(clusterId); ä¹‹å return;
                // 3) å¦‚æœä½œä¸šé›†ç¾¤è¡¨ä¸­æ²¡æœ‰ status ä¸º ClusterStatus.Working çš„ï¼Œè°ƒç”¨ await WorkNowAsync(clusterId); ä¹‹å return;

                await WorkNowAsync(clusterId);
                return;
            }
            catch { }

            // æ§åˆ¶é›†ç¾¤å¿ƒè·³é¢‘ç‡
            await Task.Delay(3000);
        }
    }

    /// <summary>
    /// å½“å‰ä½œä¸šè°ƒåº¦å™¨åœæ­¢é€šçŸ¥
    /// </summary>
    /// <param name="context">ä½œä¸šé›†ç¾¤æœåŠ¡ä¸Šä¸‹æ–‡</param>
    public void Stop(JobClusterContext context)
    {
        // åœ¨ä½œä¸šé›†ç¾¤è¡¨ä¸­ï¼Œæ›´æ–° clusterId çš„ status ä¸º ClusterStatus.Crashed
    }

    /// <summary>
    /// å½“å‰ä½œä¸šè°ƒåº¦å™¨å®•æœº
    /// </summary>
    /// <param name="context">ä½œä¸šé›†ç¾¤æœåŠ¡ä¸Šä¸‹æ–‡</param>
    public void Crash(JobClusterContext context)
    {
        // åœ¨ä½œä¸šé›†ç¾¤è¡¨ä¸­ï¼Œæ›´æ–° clusterId çš„ status ä¸º ClusterStatus.Crashed
    }

    /// <summary>
    /// æŒ‡ç¤ºé›†ç¾¤å¯ä»¥å·¥ä½œ
    /// </summary>
    /// <param name="clusterId">é›†ç¾¤ Id</param>
    /// <returns></returns>
    private Task WorkNowAsync(string clusterId)
    {
        // åœ¨ä½œä¸šé›†ç¾¤è¡¨ä¸­ï¼Œæ›´æ–° clusterId çš„ status ä¸º ClusterStatus.Working

        // æ¨¡æ‹Ÿæ•°æ®åº“æ›´æ–°æ“ä½œï¼ˆè€—æ—¶ï¼‰
        await Task.Delay(3000);
    }
}
```

2. **æ³¨å†Œé›†ç¾¤æœåŠ¡**

```cs showLineNumbers {3-4}
services.AddSchedule(options =>
{
      options.ClusterId = "cluster1";
      options.AddClusterServer<JobClusterServer>();
});
```

3. **ä½œä¸šé›†ç¾¤è¾“å‡ºæ—¥å¿—**

```bash showLineNumbers {4,6,8,16}
info: 2022-12-05 18:26:11.4045753 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      Schedule hosted service is running.
info: 2022-12-05 18:26:11.4126431 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #1
      The job cluster of <cluster1> service has been enabled, and waiting for instructions.
warn: 2022-12-05 18:26:14.4333100 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #6
      The job cluster of <cluster1> service worked now, and the current schedule hosted service will be preloading.
info: 2022-12-05 18:26:14.4411758 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #6
      Schedule hosted service is preloading...
info: 2022-12-05 18:26:14.4684974 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #6
      The <job1_trigger1> trigger for scheduler of <job1> successfully appended to the schedule.
info: 2022-12-05 18:26:14.4701128 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #6
      The scheduler of <job1> successfully appended to the schedule.
warn: 2022-12-05 18:26:14.4765709 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #6
      Schedule hosted service preload completed, and a total of <1> schedulers are appended.
info: 2022-12-05 18:26:19.5089541 +08:00 æ˜ŸæœŸä¸€ L MyJob[0] #16
      <job1> [C] <job1 job1_trigger1> 5s 1ts 2022-12-05 18:26:19.434 -> 2022-12-05 18:26:24.441
```

### 26.1.13.2 ä½œä¸šé›†ç¾¤æ•°æ®åº“è¡¨è®¾è®¡

åªéœ€åŒ…å« `Id`ï¼Œ`ClusterId`ï¼Œ`Description`ï¼Œ`Status`ï¼Œ`UpdatedTime` å­—æ®µå³å¯ï¼Œå…¶ä¸­ `Status` æ˜¯ `ClusterStatus` æšä¸¾ç±»å‹ã€‚

- **`ClusterStatus`** åŒ…å«ä»¥ä¸‹æšä¸¾æˆå‘˜
  - `Crashed`ï¼šå®•æœº
  - `Working`ï¼šæ­£å¸¸å·¥ä½œ
  - `Waiting`ï¼šç­‰å¾…è¢«å”¤é†’ï¼Œé»˜è®¤å€¼

### 26.1.13.3 å¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡

æ¡†æ¶åªæä¾›äº†ç®€å•çš„æ•…éšœè½¬ç§»çš„é›†ç¾¤åŠŸèƒ½ï¼Œå¦‚éœ€å®ç°è´Ÿè½½å‡è¡¡ï¼Œå¯é€šè¿‡ `TCP/IP` å¥—æ¥å­—å®ç°ã€‚

## 26.1.14 `ScheduleServe` é™æ€ç±»

è¯¥åŠŸèƒ½ **å»ºè®®** ä»…é™ä¸èƒ½é€šè¿‡ `services.AddXXX` æ–¹å¼ä½¿ç”¨ï¼Œæ¯”å¦‚æ§åˆ¶å°ï¼Œ`Winfrom/WPF` ç­‰ã€‚

```cs showLineNumbers {1,3}
IDisposable dispose =  ScheduleServe.Run(options =>
{
    options.AddJob<MyJob>(Triggers.Secondly());
});
```

è¿™ç§æ–¹å¼æœ‰ä¸€ä¸ªéšè—çš„å·¨å¤§éšè— â€œéªšæ“ä½œâ€ï¼š**å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹åˆ›å»ºä½œä¸šè°ƒåº¦æœåŠ¡ï¼Œå¤šæ¬¡è°ƒç”¨å¯ä»¥åˆ›å»ºå¤šä¸ªä½œä¸šè°ƒåº¦å™¨ã€‚**

:::tip æ¨èä½¿ç”¨ `Serve.Run()` æˆ– `Serve.RunGeneric()` æ–¹å¼æ›¿ä»£

`Furion` æ¡†æ¶æä¾›äº† `Serve.Run()` æ–¹å¼æ”¯æŒè·¨å¹³å°ä½¿ç”¨ï¼Œè¿˜èƒ½æ”¯æŒæ³¨å†Œæ›´å¤šæœåŠ¡ï¼Œå¦‚ï¼š

```cs showLineNumbers {1,3,5}
Serve.Run(services =>
{
    services.AddSchedule(options =>
    {
        options.Add<MyJob>(Triggers.Secondly());
    });
})
```

å¦‚æ— éœ€ `Web` åŠŸèƒ½ï¼Œå¯é€šè¿‡ `Serve.RunGeneric` æ›¿ä»£ `Serve.Run`ã€‚

:::

## 26.1.15 å¦‚ä½•éƒ¨ç½²

å¦‚æœåœ¨é¡¹ç›®ä¸­ä½¿ç”¨äº†å®šæ—¶ä»»åŠ¡ä¸”éƒ¨ç½²åˆ° `IIS` ä¸­ï¼Œé‚£ä¹ˆéœ€è¦è®¾ç½® `IIS` ç¦æ­¢å›æ”¶ï¼Œ[ç‚¹å‡»æŸ¥çœ‹ `IIS` å›æ”¶é—®é¢˜è§£å†³æ–¹æ¡ˆ](/docs/deploy-iis#3415-iis-%E5%9B%9E%E6%94%B6%E9%97%AE%E9%A2%98%E5%92%8C%E9%85%8D%E7%BD%AE)

:::warning éƒ¨ç½²å»ºè®®

å»ºè®®å®šæ—¶ä»»åŠ¡é‡‡ç”¨ `Worker Service` ç‹¬ç«‹éƒ¨ç½²æ–¹å¼ï¼Œä¸åº”ä¾æ‰˜ `Web` é¡¹ç›®è¿›ç¨‹ä¸­ã€‚[æŸ¥çœ‹ã€ Worker Serviceã€‘ç« èŠ‚](/docs/process-service.mdx)

:::

### 26.1.15.1 `Worker Service` ä»£ç é›†æˆä¾‹å­

**1. å®‰è£… `Furion` æˆ– `Sundial` åŒ…**

```bash showLineNumbers
# å®Œæ•´çš„å¼€å‘æ¡†æ¶
dotnet add package Furion;

# åªéœ€è¦å®šæ—¶ä»»åŠ¡æœåŠ¡åŠŸèƒ½
dotnet add package Sundial
```

**2. æ³¨å†Œ `Schedule` æœåŠ¡**

```cs showLineNumbers {3-4,19-22}
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Furion.Schedule;
// using Sundial;

namespace FurionWorkers;

public class Program
{
      public static void Main(string[] args)
      {
            CreateHostBuilder(args).Build().Run();
      }

      public static IHostBuilder CreateHostBuilder(string[] args) =>
            Host.CreateDefaultBuilder(args)
                .ConfigureServices((hostContext, services) =>
                {
                      services.AddSchedule(options =>
                      {
                          options.AddJob<MyJob>(Triggers.PeriodSeconds(5));
                      });
                });
}
```

:::tip å°çŸ¥è¯†

å¦‚æœä½¿ç”¨ `Serve` æ¨¡å¼ï¼Œé‚£ä¹ˆä»£ç å°†éå¸¸ç²¾ç®€ï¼Œæ— éœ€ä¸Šé¢ç¬¬äºŒä¸ªæ­¥éª¤çš„ä»£ç ~ï¼Œå¦‚ï¼š

```cs showLineNumbers {1,3-6}
Serve.RunGeneric(services =>
{
      services.AddSchedule(options =>
      {
            options.AddJob<MyJob>(Triggers.PeriodSeconds(5));
      });
})
```

:::

## 26.1.16 `Dashboard` çœ‹æ¿åŠŸèƒ½

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.4 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

åœ¨ `Furion 4.8.4+` ç‰ˆæœ¬å†…ç½®äº†ä¸€ä¸ªåµŒå…¥çš„å®šæ—¶ä»»åŠ¡çœ‹æ¿ `UI`ï¼Œåªéœ€è¦åœ¨ `Startup.cs` ä¸­å¯ç”¨å³å¯ï¼Œå¦‚ï¼š

:::tip åœ¨ `Sundial` ä¸­ä½¿ç”¨

å¦‚æœä½¿ç”¨çš„æ˜¯ `Sundial` ç‹¬ç«‹å¼€æºé¡¹ç›®ï¼Œåªéœ€è¦å®‰è£… `Sundial.Dashboard` åŒ…å³å¯ï¼Œæ— éœ€å®‰è£… `Sundial`ï¼Œå‰è€…å·²æ·»åŠ äº†åè€…çš„å¼•ç”¨ã€‚

:::

```cs showLineNumbers {2,5}
app.UseStaticFiles();
app.UseScheduleUI();

// è¿˜å¯ä»¥é…ç½®ç”Ÿäº§ç¯å¢ƒå…³é—­
app.UseScheduleUI(options =>
{
    options.DisableOnProduction = true;
});
```

:::caution ä¸­é—´ä»¶è¯´æ˜

`app.UseScheduleUI()` å¿…é¡»åœ¨ `app.UseStaticFiles()` ä¹‹åæ³¨å†Œï¼Œ**ä¸”å½“å‰ç‰ˆæœ¬æš‚æœªæä¾›ä»»ä½•è‡ªå®šä¹‰åŠŸèƒ½ã€‚**

:::

æ¥ç€æ‰“å¼€æµè§ˆå™¨å¹¶è®¿é—® `/schedule` åœ°å€å³å¯ï¼š

<img src={useBaseUrl("img/job_dash.png")} />

**æ³¨æ„ï¼šå½“å‰ `Furion 4.8.4+` ç‰ˆæœ¬æš‚æœªæä¾›ä»»ä½•è‡ªå®šä¹‰åŠŸèƒ½ï¼ŒåŒ…æ‹¬ `/schedule` åœ°å€é…ç½®ã€‚**

å‰ç«¯æºç åœ°å€ï¼š[https://gitee.com/dotnetchina/Furion/tree/v4/clients/schedule-dashboard](https://gitee.com/dotnetchina/Furion/tree/v4/clients/schedule-dashboard)

## 26.1.17 å¸¸è§é—®é¢˜

### 26.1.17.1 ä½œä¸šå¤„ç†ç¨‹åºä¸­è·å–å½“å‰æ—¶é—´å­˜åœ¨åå·®

é€šå¸¸æˆ‘ä»¬ä¼šåœ¨ `IJob` å®ç°ç±»å‹ä¸­è·å–å½“å‰æ—¶é—´ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶é—´å¯èƒ½å­˜åœ¨ç€æå°çš„è¯¯å·®ï¼Œå¦‚ï¼š

```cs showLineNumbers {5,8}
public class MyJob : IJob
{
    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        var nowTime = DateTime.Now; // æ­¤æ—¶çš„æ—¶é—´æœªå¿…æ˜¯çœŸå®è§¦å‘æ—¶é—´ï¼Œå› ä¸ºè¿˜åŒ…å«åˆ›å»ºçº¿ç¨‹ï¼Œåˆå§‹åŒ–ç­‰ç­‰æ—¶é—´

        // æ­£ç¡®çš„åšæ³•æ˜¯
        var nowTime = context.OccurrenceTime;
    }
}
```

### 26.1.17.2 ä½œä¸šè§¦å‘å™¨å‚æ•°åºåˆ—åŒ–/ååºåˆ—åŒ–

æ¡†æ¶æä¾›äº† `Schedular` é™æ€ç±»æ–¹æ³•ï¼š`Serialize/Deserialize` å¯å¯¹ä½œä¸šè§¦å‘å™¨å‚æ•° `object[]` ç±»å‹è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œï¼Œé€šå¸¸åœ¨å¼€å‘å®šæ—¶ä»»åŠ¡ç®¡ç†åå°æ—¶éå¸¸æœ‰ç”¨ã€‚å¦‚ï¼š

```cs showLineNumbers {1,5}
// åºåˆ—åŒ–ï¼Œæ–¹ä¾¿ç»„åˆ `UI` ä¸åŒè¾“å…¥æ¡†ä½œä¸šè§¦å‘å™¨å‚æ•°
var args = new object[] { "* * * * * *", CronStringFormat.WithSeconds };
var stringArgs = Schedular.Serialize(args);

// ååºåˆ—åŒ–ï¼Œæ–¹ä¾¿æ‹†å¼€ä½œä¸šè§¦å‘å™¨å‚æ•°åœ¨ `UI` ä¸åŒåˆ—å±•ç¤º
var stringArgs = "[\"* * * * *\",0]";
var args = Schedular.Deserialize<object[]>(stringArgs);
```

### 26.1.17.3 ä½œä¸šä¿¡æ¯é¢å¤–æ•°æ®åºåˆ—åŒ–/ååºåˆ—åŒ–

æ¡†æ¶æä¾›äº† `Schedular` é™æ€ç±»æ–¹æ³•ï¼š`Serialize/Deserialize` å¯å¯¹ä½œä¸šä¿¡æ¯é¢å¤–æ˜¯æ•°æ® `Dictionary<string, object>` ç±»å‹è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œï¼Œé€šå¸¸åœ¨å¼€å‘å®šæ—¶ä»»åŠ¡ç®¡ç†åå°æ—¶éå¸¸æœ‰ç”¨ã€‚å¦‚ï¼š

```cs showLineNumbers {1,5}
// åºåˆ—åŒ–ï¼Œæ–¹ä¾¿ç»„åˆ `UI` ä¸åŒè¾“å…¥æ¡†ä½œä¸šä¿¡æ¯é¢å¤–æ•°æ®
var jobData = new Dictionary<string, object> { { "name", "Furion" } };
var stringJobData = Schedular.Serialize(jobData);

// ååºåˆ—åŒ–ï¼Œæ–¹ä¾¿æ‹†å¼€ä½œä¸šä½œä¸šä¿¡æ¯é¢å¤–æ•°æ®åœ¨ `UI` ä¸åŒåˆ—å±•ç¤º
var stringJobData = "{\"name\":\"Furion\"}";
var args = Schedular.Deserialize<Dictionary<string, object>>(stringJobData);
```

### 26.1.17.4 ä½œä¸šå¤„ç†ç¨‹åºå»¶è¿Ÿå¤„ç†

åœ¨ä½œä¸šå¤„ç†ç¨‹åºä¸­å¦‚éœ€ä½¿ç”¨åˆ°å»¶è¿Ÿçº¿ç¨‹æ“ä½œï¼Œæ¨èä½¿ç”¨ `Task.Delay` è€Œä¸æ˜¯ `Thread.Sleep`ï¼ŒåŸå› æ˜¯åè€…æ˜¯åŒæ­¥å»¶è¿Ÿä¼šé˜»å¡çº¿ç¨‹ï¼Œè€Œä¸”ä¸èƒ½å–æ¶ˆã€‚

## 26.1.18 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::
