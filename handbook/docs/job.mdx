---
id: job
title: 26.1 è°ƒåº¦ä½œä¸š
sidebar_label: 26.1 è°ƒåº¦ä½œä¸š
---

import Tag from "@site/src/components/Tag.js";

<details>
  <summary>ğŸ“ æ¨¡å—æ›´æ–°æ—¥å¿—</summary>
  <div>
<div>

- **æ–°ç‰¹æ€§**

  - &nbsp;<Tag>æ–°å¢</Tag> **ä½œä¸šè§¦å‘å™¨ `ResetOnlyOnce` å±æ€§ï¼Œæ”¯æŒåªè¿è¡Œä¸€æ¬¡çš„ä½œä¸šé‡æ–°å¯åŠ¨æœåŠ¡é‡å¤æ‰§è¡Œ** <sup>4.8.1.5</sup> <sup style={{color:"gray"}}>â±ï¸2022.11.25</sup> [a8be728](https://gitee.com/dotnetchina/Furion/commit/a8be728eac986ebc5f44718b08c67aaee8b89dc6)

- **é—®é¢˜ä¿®å¤**

  - &nbsp;<Tag>ä¿®å¤</Tag> ä½œä¸šè§¦å‘å™¨ä¸ç¬¦åˆä¸‹ä¸€æ¬¡æ‰§è¡Œè§„å¾‹ä½† `NextRunTime` ä¸ä¸º `null` æƒ…å†µ <sup>4.8.1.5</sup> <sup style={{color:"gray"}}>â±ï¸2022.11.25</sup> [a8be728](https://gitee.com/dotnetchina/Furion/commit/a8be728eac986ebc5f44718b08c67aaee8b89dc6)

- **æ–‡æ¡£**

  - &nbsp;<Tag>æ–°å¢</Tag> ä½œä¸šè§¦å‘å™¨ `ResetOnlyOnce` æ–‡æ¡£ <sup>4.8.1.5</sup> <sup style={{color:"gray"}}>â±ï¸2022.11.25</sup> [a8be728](https://gitee.com/dotnetchina/Furion/commit/a8be728eac986ebc5f44718b08c67aaee8b89dc6)

</div>
  </div>
</details>

:::warning 4.8.0 ä»¥ä¸‹ç‰ˆæœ¬è¯´æ˜

**åœ¨ `Furion 4.8.0+` ç‰ˆæœ¬é‡‡ç”¨ [Sundial](https://gitee.com/dotnetchina/Sundial) å®šæ—¶ä»»åŠ¡æ›¿æ¢åŸæœ‰çš„ `TaskScheduler`**ï¼Œ[æŸ¥çœ‹æ—§æ–‡æ¡£](/docs/job-old)

:::

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.0 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

import useBaseUrl from "@docusaurus/useBaseUrl";
import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

## 26.1.1 å…³äºè°ƒåº¦ä½œä¸š

è°ƒåº¦ä½œä¸šåˆç§°å®šæ—¶ä»»åŠ¡ï¼Œé¡¾åæ€ä¹‰ï¼Œå®šæ—¶ä»»åŠ¡å°±æ˜¯åœ¨ç‰¹å®šçš„æ—¶é—´æˆ–ç¬¦åˆæŸç§æ—¶é—´è§„å¾‹è‡ªåŠ¨è§¦å‘å¹¶æ‰§è¡Œä»»åŠ¡ã€‚

<img src={useBaseUrl("img/scdr.png")} />

## 26.1.2 å¿«é€Ÿå…¥é—¨

1. å®šä¹‰ä½œä¸šå¤„ç†ç¨‹åº `MyJob`ï¼š

```cs showLineNumbers {1,9}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation($"{context.JobId} {context.TriggerId} {context.OccurrenceTime} {context.Trigger}");
        await Task.CompletedTask;
    }
}
```

2. åœ¨ `Startup.cs` æ³¨å†Œ `Schedule` æœåŠ¡ï¼š

```cs showLineNumbers {1,3-4}
services.AddSchedule(options =>
{
    // æ³¨å†Œä½œä¸šï¼Œå¹¶é…ç½®ä½œä¸šè§¦å‘å™¨
    options.AddJob<MyJob>(Triggers.Secondly()); // è¡¨ç¤ºæ¯ç§’æ‰§è¡Œ
});
```

3. æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœ

```bash showLineNumbers {2,4,6,8,10,12}
info: 2022-11-17 16:23:56.0166669 +08:00 æ˜ŸæœŸå›› L MyJob[0] #16
      job1 job1_trigger1 2022/11/17 16:23:56  * * * * * *
info: 2022-11-17 16:23:57.0125960 +08:00 æ˜ŸæœŸå›› L MyJob[0] #17
      job1 job1_trigger1 2022/11/17 16:23:57  * * * * * *
info: 2022-11-17 16:23:58.0120379 +08:00 æ˜ŸæœŸå›› L MyJob[0] #16
      job1 job1_trigger1 2022/11/17 16:23:58  * * * * * *
info: 2022-11-17 16:23:59.0071986 +08:00 æ˜ŸæœŸå›› L MyJob[0] #5
      job1 job1_trigger1 2022/11/17 16:23:59  * * * * * *
info: 2022-11-17 16:24:00.0196813 +08:00 æ˜ŸæœŸå›› L MyJob[0] #16
      job1 job1_trigger1 2022/11/17 16:24:00  * * * * * *
info: 2022-11-17 16:24:01.0305799 +08:00 æ˜ŸæœŸå›› L MyJob[0] #17
      job1 job1_trigger1 2022/11/17 16:24:01  * * * * * *
```

### 26.1.2.1 æŒ‡å®šä½œä¸š `Id`

é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸æŒ‡å®šä½œä¸š `Id` ä¼šè‡ªåŠ¨ç”Ÿæˆ `job[ç¼–å·]`ã€‚

```cs showLineNumbers {3}
services.AddSchedule(options =>
{
    options.AddJob<MyJob>("myjob", Triggers.Secondly());
});
```

æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœï¼š

```bash showLineNumbers  {2,4,6,8,10,12}
info: 2022-11-17 16:25:44.0339177 +08:00 æ˜ŸæœŸå›› L MyJob[0] #3
      myjob myjob_trigger1 2022/11/17 16:25:44  * * * * * *
info: 2022-11-17 16:25:45.0064838 +08:00 æ˜ŸæœŸå›› L MyJob[0] #14
      myjob myjob_trigger1 2022/11/17 16:25:45  * * * * * *
info: 2022-11-17 16:25:46.0186243 +08:00 æ˜ŸæœŸå›› L MyJob[0] #15
      myjob myjob_trigger1 2022/11/17 16:25:46  * * * * * *
info: 2022-11-17 16:25:47.0175115 +08:00 æ˜ŸæœŸå›› L MyJob[0] #16
      myjob myjob_trigger1 2022/11/17 16:25:47  * * * * * *
info: 2022-11-17 16:25:48.0304982 +08:00 æ˜ŸæœŸå›› L MyJob[0] #15
      myjob myjob_trigger1 2022/11/17 16:25:48  * * * * * *
info: 2022-11-17 16:25:49.0070855 +08:00 æ˜ŸæœŸå›› L MyJob[0] #16
      myjob myjob_trigger1 2022/11/17 16:25:49  * * * * * *
```

### 26.1.2.2 å¤šä¸ªä½œä¸šè§¦å‘å™¨

æœ‰æ—¶å€™ï¼Œä¸€ä¸ªä½œä¸šæ”¯æŒå¤šç§è§¦å‘æ—¶é—´ï¼Œæ¯”å¦‚ `æ¯åˆ†é’Ÿ` æ‰§è¡Œä¸€æ¬¡ï¼Œæ¯ `5ç§’` æ‰§è¡Œä¸€æ¬¡ï¼Œæ¯åˆ†é’Ÿç¬¬ `3/7/8ç§’` æ‰§è¡Œä¸€æ¬¡ã€‚

```cs showLineNumbers {3-5}
services.AddSchedule(options =>
{
    options.AddJob<MyJob>(Triggers.Minutely()   // æ¯åˆ†é’Ÿå¼€å§‹
     , Triggers.Period(5000)   // æ¯ 5 ç§’ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Triggers.PeriodSeconds(5)
     , Triggers.Cron("3,7,8 * * * * ?", CronStringFormat.WithSeconds));  // æ¯åˆ†é’Ÿç¬¬ 3/7/8 ç§’
});
```

æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœï¼š

```cs showLineNumbers {2,10,14,18,20}
info: 2022-11-17 16:45:40.5258191 +08:00 æ˜ŸæœŸå›› L MyJob[0] #14
      job1 job1_trigger2 2022/11/17 16:45:40  5000ms
info: 2022-11-17 16:45:45.5281473 +08:00 æ˜ŸæœŸå›› L MyJob[0] #3
      job1 job1_trigger2 2022/11/17 16:45:45  5000ms
info: 2022-11-17 16:45:50.5378417 +08:00 æ˜ŸæœŸå›› L MyJob[0] #8
      job1 job1_trigger2 2022/11/17 16:45:50  5000ms
info: 2022-11-17 16:45:55.5436499 +08:00 æ˜ŸæœŸå›› L MyJob[0] #3
      job1 job1_trigger2 2022/11/17 16:45:55  5000ms
info: 2022-11-17 16:46:00.0253985 +08:00 æ˜ŸæœŸå›› L MyJob[0] #14
      job1 job1_trigger1 2022/11/17 16:46:00  * * * * *
info: 2022-11-17 16:46:00.5494676 +08:00 æ˜ŸæœŸå›› L MyJob[0] #16
      job1 job1_trigger2 2022/11/17 16:46:00  5000ms
info: 2022-11-17 16:46:03.0238143 +08:00 æ˜ŸæœŸå›› L MyJob[0] #15
      job1 job1_trigger3 2022/11/17 16:46:03  3,7,8 * * * * ?
info: 2022-11-17 16:46:05.5629293 +08:00 æ˜ŸæœŸå›› L MyJob[0] #14
      job1 job1_trigger2 2022/11/17 16:46:05  5000ms
info: 2022-11-17 16:46:07.0169836 +08:00 æ˜ŸæœŸå›› L MyJob[0] #15
      job1 job1_trigger3 2022/11/17 16:46:07  3,7,8 * * * * ?
info: 2022-11-17 16:46:08.0128756 +08:00 æ˜ŸæœŸå›› L MyJob[0] #14
      job1 job1_trigger3 2022/11/17 16:46:08  3,7,8 * * * * ?
info: 2022-11-17 16:46:10.5731138 +08:00 æ˜ŸæœŸå›› L MyJob[0] #8
      job1 job1_trigger2 2022/11/17 16:46:10  5000ms
info: 2022-11-17 16:46:15.5841547 +08:00 æ˜ŸæœŸå›› L MyJob[0] #15
      job1 job1_trigger2 2022/11/17 16:46:15  5000ms
info: 2022-11-17 16:46:20.5866898 +08:00 æ˜ŸæœŸå›› L MyJob[0] #8
      job1 job1_trigger2 2022/11/17 16:46:20  5000ms
```

### 26.1.2.3 `ä¸²è¡Œ` æ‰§è¡Œ

é»˜è®¤æƒ…å†µä¸‹ï¼Œä½œä¸šé‡‡ç”¨ `å¹¶è¡Œ` æ‰§è¡Œæ–¹å¼ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šç­‰å¾…ä¸Šä¸€æ¬¡ä½œä¸šæ‰§è¡Œå®Œæˆï¼Œåªè¦è§¦å‘æ—¶é—´åˆ°äº†å°±è‡ªåŠ¨æ‰§è¡Œï¼Œä½†ä¸€äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½å¸Œæœ›ç­‰å¾…ä¸Šä¸€æ¬¡ä½œä¸šå®Œæˆå†æ‰§è¡Œï¼Œå¦‚ï¼š

```cs showLineNumbers {3}
services.AddSchedule(options =>
{
    options.AddJob<MyJob>(concurrent: false, Triggers.Secondly()); // ä¸²è¡Œï¼Œæ¯ç§’æ‰§è¡Œ
});
```

```cs showLineNumbers {12}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation($"{context.JobId} {context.TriggerId} {context.OccurrenceTime} {context.Trigger}");
        await Task.Delay(2000, stoppingToken); // è¿™é‡Œæ¨¡æ‹Ÿè€—æ—¶æ“ä½œï¼Œæ¯”å¦‚è€—æ—¶2ç§’
    }
}
```

æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœï¼š

```cs showLineNumbers {2,8,14,20}
info: 2022-11-17 16:57:49.0898900 +08:00 æ˜ŸæœŸå›› L MyJob[0] #8
      job1 job1_trigger1 2022/11/17 16:57:49  * * * * * *
warn: 2022-11-17 16:57:50.0322409 +08:00 æ˜ŸæœŸå›› L System.Logging.ScheduleService[0] #8
      11/17/2022 16:57:50: The <job1_trigger1> trigger of job <job1> failed to execute as scheduled due to blocking.
warn: 2022-11-17 16:57:51.0099629 +08:00 æ˜ŸæœŸå›› L System.Logging.ScheduleService[0] #8
      11/17/2022 16:57:51: The <job1_trigger1> trigger of job <job1> failed to execute as scheduled due to blocking.
info: 2022-11-17 16:57:52.0192847 +08:00 æ˜ŸæœŸå›› L MyJob[0] #8
      job1 job1_trigger1 2022/11/17 16:57:52  * * * * * *
warn: 2022-11-17 16:57:53.0159256 +08:00 æ˜ŸæœŸå›› L System.Logging.ScheduleService[0] #8
      11/17/2022 16:57:53: The <job1_trigger1> trigger of job <job1> failed to execute as scheduled due to blocking.
warn: 2022-11-17 16:57:54.0101172 +08:00 æ˜ŸæœŸå›› L System.Logging.ScheduleService[0] #8
      11/17/2022 16:57:54: The <job1_trigger1> trigger of job <job1> failed to execute as scheduled due to blocking.
info: 2022-11-17 16:57:55.0038536 +08:00 æ˜ŸæœŸå›› L MyJob[0] #13
      job1 job1_trigger1 2022/11/17 16:57:55  * * * * * *
warn: 2022-11-17 16:57:56.0158085 +08:00 æ˜ŸæœŸå›› L System.Logging.ScheduleService[0] #16
      11/17/2022 16:57:56: The <job1_trigger1> trigger of job <job1> failed to execute as scheduled due to blocking.
warn: 2022-11-17 16:57:57.0276842 +08:00 æ˜ŸæœŸå›› L System.Logging.ScheduleService[0] #16
      11/17/2022 16:57:57: The <job1_trigger1> trigger of job <job1> failed to execute as scheduled due to blocking.
info: 2022-11-17 16:57:58.0100972 +08:00 æ˜ŸæœŸå›› L MyJob[0] #13
      job1 job1_trigger1 2022/11/17 16:57:58  * * * * * *
warn: 2022-11-17 16:57:59.0149137 +08:00 æ˜ŸæœŸå›› L System.Logging.ScheduleService[0] #13
      11/17/2022 16:57:59: The <job1_trigger1> trigger of job <job1> failed to execute as scheduled due to blocking.
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ `ä¸²è¡Œ` æ‰§è¡Œä½†å› ä¸ºè€—æ—¶å¯¼è‡´**è§¦å‘æ—¶é—´åˆ°äº†ä½†å®é™…æœªèƒ½æ‰§è¡Œ**ä¼šé»˜è®¤è¾“å‡º `warn` è­¦å‘Šæ—¥å¿—ï¼Œå¦‚éœ€å…³é—­åªéœ€è¦ï¼š

```cs showLineNumbers {3}
services.AddSchedule(options =>
{
    options.LogEnabled = false;
    options.AddJob<MyJob>(concurrent: false, Triggers.Secondly()); // æ¯ç§’æ‰§è¡Œ
});
```

æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœï¼š

```bash showLineNumbers {2,4,6,8,10}
info: 2022-11-17 17:02:28.0559602 +08:00 æ˜ŸæœŸå›› L MyJob[0] #5
      job1 job1_trigger1 2022/11/17 17:02:28  * * * * * *
info: 2022-11-17 17:02:31.0183238 +08:00 æ˜ŸæœŸå›› L MyJob[0] #8
      job1 job1_trigger1 2022/11/17 17:02:31  * * * * * *
info: 2022-11-17 17:02:34.0130555 +08:00 æ˜ŸæœŸå›› L MyJob[0] #13
      job1 job1_trigger1 2022/11/17 17:02:34  * * * * * *
info: 2022-11-17 17:02:37.0040306 +08:00 æ˜ŸæœŸå›› L MyJob[0] #15
      job1 job1_trigger1 2022/11/17 17:02:37  * * * * * *
info: 2022-11-17 17:02:39.0142346 +08:00 æ˜ŸæœŸå›› L MyJob[0] #15
      job1 job1_trigger1 2022/11/17 17:02:39  * * * * * *
```

### 26.1.2.4 æ‰“å°ä½œä¸šå®Œæ•´ä¿¡æ¯

æ¡†æ¶æä¾›äº†å››ç§æ–¹å¼æ‰“å°ä½œä¸šå®Œæ•´ä¿¡æ¯ã€‚

- **ç¬¬ä¸€ç§ï¼šè¾“å‡ºå®Œæ•´çš„ä½œä¸š `JSON` ä¿¡æ¯ï¼š`context.ConvertToJSON()`**

```cs showLineNumbers {11}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation(context.ConvertToJSON());
        await Task.CompletedTask;
    }
}
```

æŸ¥çœ‹ä½œä¸šæ‰“å°ç»“æœï¼š

```json showLineNumbers {3,14}
info: 2022-11-17 17:13:41.0480946 +08:00 æ˜ŸæœŸå›› L MyJob[0] #5
      {
        "jobDetail": {
        "jobId": "job1",
        "groupName": null,
        "jobType": "MyJob",
        "assemblyName": "ConsoleApp32",
        "description": null,
        "concurrent": false,
        "includeAnnotations": false,
        "properties": "{}",
        "updatedTime": "2022-11-17T17:13:41.0247430+08:00"
      },
        "trigger": {
        "triggerId": "job1_trigger1",
        "jobId": "job1",
        "triggerType": "Furion.Schedule.CronTrigger",
        "assemblyName": "Furion",
        "args": "[\"@secondly\",0]",
        "description": null,
        "status": 2,
        "startTime": null,
        "endTime": null,
        "lastRunTime": "2022-11-17T17:13:41.0000000",
        "nextRunTime": "2022-11-17T17:13:42.0000000",
        "numberOfRuns": 1,
        "maxNumberOfRuns": 0,
        "numberOfErrors": 0,
        "maxNumberOfErrors": 0,
        "numRetries": 0,
        "retryTimeout": 1000,
        "startNow": true,
        "runOnStart": false,
        "resetOnlyOnce": true,
        "updatedTime": "2022-11-17T17:13:41.0250214+08:00"
      }
      }
```

- **ç¬¬äºŒç§ï¼šè¾“å‡ºå•ç‹¬çš„ä½œä¸š `JSON` ä¿¡æ¯ï¼š`jobDetail.ConvertToJSON()` æˆ– `trigger.ConvertToJSON()`**

```cs showLineNumbers {11-12,14-15}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        var jobDetail = context.JobDetail;
        var trigger = context.Trigger;

        _logger.LogInformation(jobDetail.ConvertToJSON());
        _logger.LogInformation(trigger.ConvertToJSON(NamingConventions.UnderScoreCase));    // æ”¯æŒä¸‰ç§å±æ€§åè¾“å‡ºè§„åˆ™

        await Task.CompletedTask;
    }
}
```

æŸ¥çœ‹ä½œä¸šæ‰“å°ç»“æœï¼š

```json showLineNumbers {2-12,14-35}
info: 2022-11-17 17:17:15.0441407 +08:00 æ˜ŸæœŸå›› L MyJob[0] #3
      {
        "jobId": "job1",
        "groupName": null,
        "jobType": "MyJob",
        "assemblyName": "ConsoleApp32",
        "description": null,
        "concurrent": false,
        "includeAnnotations": false,
        "properties": "{}",
        "updatedTime": "2022-11-17T17:17:15.0103913+08:00"
      }
info: 2022-11-17 17:17:15.0503546 +08:00 æ˜ŸæœŸå›› L MyJob[0] #3
      {
        "trigger_id": "job1_trigger1",
        "job_id": "job1",
        "trigger_type": "Furion.Schedule.CronTrigger",
        "assembly_name": "Furion",
        "args": "[\"@secondly\",0]",
        "description": null,
        "status": 2,
        "start_time": null,
        "end_time": null,
        "last_run_time": "2022-11-17T17:17:15.0000000",
        "next_run_time": "2022-11-17T17:17:16.0000000",
        "number_of_runs": 1,
        "max_number_of_runs": 0,
        "number_of_errors": 0,
        "max_number_of_errors": 0,
        "num_retries": 0,
        "retry_timeout": 1000,
        "start_now": true,
        "run_on_start": false,
        "reset_only_once": true,
        "updated_time": "2022-11-17T17:17:15.0109612+08:00"
      }
```

- **ç¬¬ä¸‰ç§ï¼šè¾“å‡ºå•ç‹¬çš„ä½œä¸š `SQL` ä¿¡æ¯ï¼š`jobDetail.ConvertToSQL()` æˆ– `trigger.ConvertToSQL()`**

```cs showLineNumbers {11-12,14-16}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        var jobDetail = context.JobDetail;
        var trigger = context.Trigger;

        _logger.LogInformation(jobDetail.ConvertToSQL("ä½œä¸šä¿¡æ¯è¡¨å", PersistenceBehavior.Appended));  // è¾“å‡ºæ–°å¢è¯­å¥
        _logger.LogInformation(trigger.ConvertToSQL("ä½œä¸šè§¦å‘å™¨è¡¨å", PersistenceBehavior.Removed, NamingConventions.Pascal));    // è¾“å‡ºåˆ é™¤è¯­å¥
        _logger.LogInformation(trigger.ConvertToSQL("ä½œä¸šè§¦å‘å™¨è¡¨å", PersistenceBehavior.Updated, NamingConventions.UnderScoreCase));    // è¾“å‡ºæ›´æ–°è¯­å¥

        await Task.CompletedTask;
    }
}
```

æŸ¥çœ‹ä½œä¸šæ‰“å°ç»“æœï¼š

```sql showLineNumbers {2,25,28}
info: 2022-11-17 17:35:11.1085426 +08:00 æ˜ŸæœŸå›› L MyJob[0] #9
      INSERT INTO ä½œä¸šä¿¡æ¯è¡¨å(
            [jobId],
            [groupName],
            [jobType],
            [assemblyName],
            [description],
            [concurrent],
            [includeAnnotations],
            [properties],
            [updatedTime]
      )
      VALUES(
            'job1',
            NULL,
            'MyJob',
            'ConsoleApp32',
            NULL,
            0,
            0,
            '{}',
            '2022/11/17 17:35:11'
      );
info: 2022-11-17 17:35:11.1150444 +08:00 æ˜ŸæœŸå›› L MyJob[0] #9
      DELETE FROM ä½œä¸šè§¦å‘å™¨è¡¨å
      WHERE [TriggerId] = 'job1_trigger1' AND [JobId] = 'job1';
info: 2022-11-17 17:35:11.1190961 +08:00 æ˜ŸæœŸå›› L MyJob[0] #9
      UPDATE ä½œä¸šè§¦å‘å™¨è¡¨å
      SET
            [trigger_id] = 'job1_trigger1',
            [job_id] = 'job1',
            [trigger_type] = 'Furion.Schedule.CronTrigger',
            [assembly_name] = 'Furion',
            [args] = '["@secondly",0]',
            [description] = NULL,
            [status] = 2,
            [start_time] = NULL,
            [end_time] = NULL,
            [last_run_time] = '2022/11/17 17:35:11',
            [next_run_time] = '2022/11/17 17:35:12',
            [number_of_runs] = 1,
            [max_number_of_runs] = 0,
            [number_of_errors] = 0,
            [max_number_of_errors] = 0,
            [num_retries] = 0,
            [retry_timeout] = 1000,
            [start_now] = 1,
            [run_on_start] = 0,
            [reset_only_once] = 1,
            [updated_time] = '2022/11/17 17:35:11'
      WHERE [trigger_id] = 'job1_trigger1' AND [job_id] = 'job1';
```

- **ç¬¬å››ç§ï¼šè¾“å‡ºå•ç‹¬çš„ä½œä¸š `Monitor` ä¿¡æ¯ï¼š`jobDetail.ConvertToMonitor()` æˆ– `trigger.ConvertToMonitor()`**

```cs showLineNumbers {11-12,14-15}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        var jobDetail = context.JobDetail;
        var trigger = context.Trigger;

        _logger.LogInformation(jobDetail.ConvertToMonitor());
        _logger.LogInformation(trigger.ConvertToMonitor());

        await Task.CompletedTask;
    }
}
```

æŸ¥çœ‹ä½œä¸šæ‰“å°ç»“æœï¼š

```bash showLineNumbers {2,16}
info: 2022-11-17 17:39:09.1086517 +08:00 æ˜ŸæœŸå›› L MyJob[0] #3
      â”â”â”â”â”â”â”â”â”â”â”â”  JobDetail â”â”â”â”â”â”â”â”â”â”â”
      â”£ MyJob
      â”£
      â”£ JobIdï¼š                     job1
      â”£ GroupNameï¼š
      â”£ JobTypeï¼š                   MyJob
      â”£ AssemblyNameï¼š              ConsoleApp32
      â”£ Descriptionï¼š
      â”£ Concurrentï¼š                False
      â”£ IncludeAnnotationsï¼š        False
      â”£ Propertiesï¼š                {}
      â”£ UpdatedTimeï¼š               2022/11/17 17:39:09
      â”—â”â”â”â”â”â”â”â”â”â”â”  JobDetail â”â”â”â”â”â”â”â”â”â”â”
info: 2022-11-17 17:39:09.1133162 +08:00 æ˜ŸæœŸå›› L MyJob[0] #3
      â”â”â”â”â”â”â”â”â”â”â”â”  Trigger â”â”â”â”â”â”â”â”â”â”â”
      â”£ Furion.Schedule.CronTrigger
      â”£
      â”£ TriggerIdï¼š                job1_trigger1
      â”£ JobIdï¼š                    job1
      â”£ TriggerTypeï¼š              Furion.Schedule.CronTrigger
      â”£ AssemblyNameï¼š             Furion
      â”£ Argsï¼š                     ["@secondly",0]
      â”£ Descriptionï¼š
      â”£ Statusï¼š                   Running
      â”£ StartTimeï¼š
      â”£ EndTimeï¼š
      â”£ LastRunTimeï¼š              2022/11/17 17:39:09
      â”£ NextRunTimeï¼š              2022/11/17 17:39:10
      â”£ NumberOfRunsï¼š             1
      â”£ MaxNumberOfRunsï¼š          0
      â”£ NumberOfErrorsï¼š           0
      â”£ MaxNumberOfErrorsï¼š        0
      â”£ NumRetriesï¼š               0
      â”£ RetryTimeoutï¼š             1000
      â”£ StartNowï¼š                 True
      â”£ RunOnStartï¼š               False
      â”£ ResetOnlyOnceï¼š            True
      â”£ UpdatedTimeï¼š              2022/11/17 17:39:09
      â”—â”â”â”â”â”â”â”â”â”â”â”  Trigger â”â”â”â”â”â”â”â”â”â”â”
```

### 26.1.2.5 è¿è¡Œæ—¶ï¼ˆåŠ¨æ€ï¼‰æ“ä½œä½œä¸š

æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¿è¡Œæ—¶å¯¹ä½œä¸šåŠ¨æ€çš„å¢åŠ ï¼Œæ›´æ–°ï¼Œåˆ é™¤ç­‰æ“ä½œï¼Œå¦‚åŠ¨æ€æ·»åŠ ä½œä¸šï¼š

1. æ³¨å†Œ `services.AddSchedule()` æœåŠ¡

```cs showLineNumbers {2,5}
// å¯ä»¥å®Œå…¨åŠ¨æ€æ“ä½œï¼Œåªéœ€è¦æ³¨å†ŒæœåŠ¡å³å¯
services.AddSchedule();

// ä¹Ÿå¯ä»¥éƒ¨åˆ†é™æ€ï¼Œéƒ¨åˆ†åŠ¨æ€æ³¨å†Œ
services.AddSchedule(options =>
{
    options.AddJob<MyJob>(concurrent: false, Triggers.PeriodSeconds(5));
});
```

2. æ³¨å…¥ `ISchedulerFactory` æœåŠ¡

```cs showLineNumbers {4,11}
public class YourService: IYourService
{
    private readonly ISchedulerFactory _schedulerFactory;
    public YourService(ISchedulerFactory schedulerFactory)
    {
        _schedulerFactory = schedulerFactory;
    }

    public void AddJob()
    {
        _schedulerFactory.AddJob<MyJob>("åŠ¨æ€ä½œä¸š Id", Triggers.Secondly());
    }
}
```

3. æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœ

```bash showLineNumbers {2,4,6,8,10,20}
warn: 2022-11-17 17:54:35.2654513 +08:00 æ˜ŸæœŸå›› L System.Logging.ScheduleService[0] #5
      Schedule Hosted Service cancels hibernation.
info: 2022-11-17 17:54:35.2670018 +08:00 æ˜ŸæœŸå›› L System.Logging.ScheduleService[0] #5
      The Scheduler of <åŠ¨æ€ä½œä¸š Id> successfully added to the schedule.
info: 2022-11-17 17:54:36.0834925 +08:00 æ˜ŸæœŸå›› L MyJob[0] #5
      job1 job1_trigger1 2022/11/17 17:54:36  5000ms
info: 2022-11-17 17:54:36.0911692 +08:00 æ˜ŸæœŸå›› L MyJob[0] #3
      åŠ¨æ€ä½œä¸š Id åŠ¨æ€ä½œä¸š Id_trigger1 2022/11/17 17:54:36  * * * * * *
info: 2022-11-17 17:54:37.0146251 +08:00 æ˜ŸæœŸå›› L MyJob[0] #18
      åŠ¨æ€ä½œä¸š Id åŠ¨æ€ä½œä¸š Id_trigger1 2022/11/17 17:54:37  * * * * * *
info: 2022-11-17 17:54:38.0071504 +08:00 æ˜ŸæœŸå›› L MyJob[0] #16
      åŠ¨æ€ä½œä¸š Id åŠ¨æ€ä½œä¸š Id_trigger1 2022/11/17 17:54:38  * * * * * *
info: 2022-11-17 17:54:39.0140840 +08:00 æ˜ŸæœŸå›› L MyJob[0] #17
      åŠ¨æ€ä½œä¸š Id åŠ¨æ€ä½œä¸š Id_trigger1 2022/11/17 17:54:39  * * * * * *
info: 2022-11-17 17:54:40.0173240 +08:00 æ˜ŸæœŸå›› L MyJob[0] #16
      åŠ¨æ€ä½œä¸š Id åŠ¨æ€ä½œä¸š Id_trigger1 2022/11/17 17:54:40  * * * * * *
info: 2022-11-17 17:54:41.0249043 +08:00 æ˜ŸæœŸå›› L MyJob[0] #16
      åŠ¨æ€ä½œä¸š Id åŠ¨æ€ä½œä¸š Id_trigger1 2022/11/17 17:54:41  * * * * * *
info: 2022-11-17 17:54:41.0550205 +08:00 æ˜ŸæœŸå›› L MyJob[0] #15
      job1 job1_trigger1 2022/11/17 17:54:41  5000ms
info: 2022-11-17 17:54:42.0171271 +08:00 æ˜ŸæœŸå›› L MyJob[0] #15
      åŠ¨æ€ä½œä¸š Id åŠ¨æ€ä½œä¸š Id_trigger1 2022/11/17 17:54:42  * * * * * *
info: 2022-11-17 17:54:43.0288486 +08:00 æ˜ŸæœŸå›› L MyJob[0] #18
      åŠ¨æ€ä½œä¸š Id åŠ¨æ€ä½œä¸š Id_trigger1 2022/11/17 17:54:43  * * * * * *
info: 2022-11-17 17:54:44.0092455 +08:00 æ˜ŸæœŸå›› L MyJob[0] #15
      åŠ¨æ€ä½œä¸š Id åŠ¨æ€ä½œä¸š Id_trigger1 2022/11/17 17:54:44  * * * * * *
```

### 26.1.2.6 ä½œä¸šè§¦å‘å™¨ç‰¹æ€§

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¡†æ¶ä¸ä¼šæ‰«æ `IJob` å®ç°ç±»çš„ä½œä¸šè§¦å‘å™¨ç‰¹æ€§ï¼Œä½†å¯ä»¥è®¾ç½®ä½œä¸šçš„ `IncludeAnnotations` è¿›è¡Œå¯ç”¨ã€‚

1. å¯ç”¨ `IncludeAnnotations` æ‰«æ

```cs showLineNumbers {3}
services.AddSchedule(options =>
{
    options.AddJob(JobBuilder.Create<MyJob>().SetIncludeAnnotations(true)
        , Triggers.PeriodSeconds(5));     // è¿™é‡Œå¯ä¼ å¯ä¸ä¼ ï¼Œä¼ äº†åˆ™ä¼šè‡ªåŠ¨è½½å…¥ç‰¹æ€§å’Œè¿™é‡Œé…ç½®çš„ä½œä¸šè§¦å‘å™¨
});
```

2. åœ¨ `MyJob` ä¸­æ·»åŠ å¤šä¸ªä½œä¸šè§¦å‘å™¨ç‰¹æ€§

```cs showLineNumbers {1-2}
[Minutely]
[Cron("3,7,8 * * * * ?", CronStringFormat.WithSeconds)]
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation($"{context.JobId} {context.TriggerId} {context.OccurrenceTime} {context.Trigger}");

        await Task.CompletedTask;
    }
}
```

3. æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœ

```bash showLineNumbers {2,4,6,8,10,12,14,16,18}
info: 2022-11-18 10:28:56.3382585 +08:00 æ˜ŸæœŸäº” L MyJob[0] #14
      job1 job1_trigger1 2022/11/18 10:28:56  5000ms
info: 2022-11-18 10:29:00.0219493 +08:00 æ˜ŸæœŸäº” L MyJob[0] #5
      job1 job1_trigger2 2022/11/18 10:29:00  * * * * *
info: 2022-11-18 10:29:01.3318716 +08:00 æ˜ŸæœŸäº” L MyJob[0] #14
      job1 job1_trigger1 2022/11/18 10:29:01  5000ms
info: 2022-11-18 10:29:03.0127992 +08:00 æ˜ŸæœŸäº” L MyJob[0] #16
      job1 job1_trigger3 2022/11/18 10:29:03  3,7,8 * * * * ?
info: 2022-11-18 10:29:06.3457728 +08:00 æ˜ŸæœŸäº” L MyJob[0] #16
      job1 job1_trigger1 2022/11/18 10:29:06  5000ms
info: 2022-11-18 10:29:07.0318919 +08:00 æ˜ŸæœŸäº” L MyJob[0] #14
      job1 job1_trigger3 2022/11/18 10:29:07  3,7,8 * * * * ?
info: 2022-11-18 10:29:08.0141479 +08:00 æ˜ŸæœŸäº” L MyJob[0] #8
      job1 job1_trigger3 2022/11/18 10:29:08  3,7,8 * * * * ?
info: 2022-11-18 10:29:11.3468100 +08:00 æ˜ŸæœŸäº” L MyJob[0] #16
      job1 job1_trigger1 2022/11/18 10:29:11  5000ms
info: 2022-11-18 10:29:16.3504029 +08:00 æ˜ŸæœŸäº” L MyJob[0] #14
      job1 job1_trigger1 2022/11/18 10:29:16  5000ms
```

## 26.1.3 ä½œä¸šä¿¡æ¯ `JobDetail` åŠæ„å»ºå™¨

### 26.1.3.1 å…³äºä½œä¸šä¿¡æ¯

æ¡†æ¶æä¾›äº† `JobDetail` ç±»å‹æ¥æè¿°ä½œä¸šä¿¡æ¯ï¼Œ`JobDetail` ç±»å‹æä¾›ä»¥ä¸‹**åªè¯»å±æ€§**ï¼š

| å±æ€§å               | å±æ€§ç±»å‹    | é»˜è®¤å€¼  | è¯´æ˜                                                                     |
| -------------------- | ----------- | ------- | ------------------------------------------------------------------------ |
| `JobId`              | `string`    |         | ä½œä¸š `Id`                                                                |
| `GroupName`          | `string`    |         | ä½œä¸šç»„åç§°                                                               |
| `JobType`            | `string`    |         | ä½œä¸šå¤„ç†ç¨‹åºç±»å‹ï¼Œå­˜å‚¨çš„æ˜¯ç±»å‹çš„ `FullName`                              |
| `AssemblyName`       | `string`    |         | ä½œä¸šå¤„ç†ç¨‹åºç±»å‹æ‰€åœ¨ç¨‹åºé›†ï¼Œå­˜å‚¨çš„æ˜¯ç¨‹åºé›† `Name`                        |
| `Description`        | `string`    |         | æè¿°ä¿¡æ¯                                                                 |
| `Concurrent`         | `bool`      | `true`  | ä½œä¸šæ‰§è¡Œæ–¹å¼ï¼Œå¦‚æœè®¾ç½®ä¸º `false`ï¼Œé‚£ä¹ˆä½¿ç”¨ `ä¸²è¡Œ` æ‰§è¡Œï¼Œå¦åˆ™ `å¹¶è¡Œ` æ‰§è¡Œ |
| `IncludeAnnotations` | `bool`      | `false` | æ˜¯å¦æ‰«æ `IJob` å®ç°ç±» `[Trigger]` ç‰¹æ€§è§¦å‘å™¨                            |
| `Properties`         | `string`    | `"{}"`  | ä½œä¸šä¿¡æ¯é¢å¤–æ•°æ®ï¼Œç”± `Dictionary<string, object>` åºåˆ—åŒ–æˆå­—ç¬¦ä¸²å­˜å‚¨     |
| `UpdatedTime`        | `DateTime?` |         | ä½œä¸šæ›´æ–°æ—¶é—´                                                             |

### 26.1.3.2 å…³äºä½œä¸šä¿¡æ¯æ„å»ºå™¨

ä½œä¸šä¿¡æ¯ `JobDetail` æ˜¯ä½œä¸šè°ƒåº¦æ¨¡å—æä¾›è¿è¡Œæ—¶çš„**åªè¯»ç±»å‹**ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•åˆ›å»ºæˆ–å˜æ›´ `JobDetail` å¯¹è±¡å‘¢ï¼Ÿ

`JobBuilder` æ˜¯ä½œä¸šè°ƒåº¦æ¨¡å—æä¾›å¯ç”¨æ¥ç”Ÿæˆè¿è¡Œæ—¶ `JobDetail` çš„ç±»å‹ï¼Œè¿™æ ·åšçš„å¥½å¤„å¯é¿å…å¤–éƒ¨ç›´æ¥ä¿®æ”¹è¿è¡Œæ—¶ `JobDetail` æ•°æ®ï¼Œè¿˜èƒ½å®ç°ä»»ä½•ä¿®æ”¹åŠ¨ä½œç›‘å¬ï¼Œä¹Ÿèƒ½é¿å…å¤šçº¿ç¨‹æŠ¢å æƒ…å†µã€‚

ä½œä¸šè°ƒåº¦æ¨¡å—æä¾›äº†å¤šç§æ–¹å¼ç”¨æ¥åˆ›å»º `JobBuilder` å¯¹è±¡ã€‚

1. **é€šè¿‡ `Create` é™æ€æ–¹æ³•åˆ›å»º**

```cs showLineNumbers {2,5,8}
// æ ¹æ® IJob å®ç°ç±»ç±»å‹åˆ›å»º
var jobBuilder = JobBuilder.Create<MyJob>();

// æ ¹æ® Type ç±»å‹åˆ›å»º
var jobBuilder = JobBuilder.Create(typeof(MyJob));

// æ ¹æ®ç¨‹åºé›†åç§°å’Œç±»å‹å®Œå…¨é™å®šåï¼ˆFullNameï¼‰åˆ›å»º
var jobBuilder = JobBuilder.Create("YourProject", "YourProject.MyJob");
```

2. **é€šè¿‡ `JobDetail` ç±»å‹åˆ›å»º**

è¿™ç§æ–¹å¼å¸¸ç”¨äºåœ¨è¿è¡Œæ—¶æ›´æ–°ä½œä¸šä¿¡æ¯ã€‚

```cs showLineNumbers
var jobBuilder = JobBuilder.From(jobDetail);

//ä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼
var jobBuilder = jobDetail.GetBuilder();
```

3. **é€šè¿‡ `JSON` å­—ç¬¦ä¸²åˆ›å»º**

è¯¥æ–¹å¼éå¸¸çµæ´»ï¼Œå¯ä»é…ç½®æ–‡ä»¶ï¼Œ`JSON` å­—ç¬¦ä¸²ï¼Œæˆ–å…¶ä»–èƒ½å¤Ÿè¿”å› `JSON` å­—ç¬¦ä¸²çš„åœ°æ–¹åˆ›å»ºã€‚

```cs showLineNumbers {2-12}
var jobBuilder = JobBuilder.From(@"
{
    ""jobId"": ""job1"",
    ""groupName"": null,
    ""jobType"": ""Furion.Application.MyJob"",
    ""assemblyName"": ""Furion.Application"",
    ""description"": null,
    ""concurrent"": true,
    ""includeAnnotations"": false,
    ""properties"": ""{}"",
    ""updatedTime"": ""2022-11-17T09:25:47.0471107+08:00""
}");
```

å¦‚æœä½¿ç”¨çš„æ˜¯ `.NET7`ï¼Œå¯ä½¿ç”¨ `"""` é¿å…è½¬ä¹‰ï¼Œå¦‚ï¼š

```cs showLineNumbers {2-12}
var jobBuilder = JobBuilder.From("""
{
    "jobId": "job1",
    "groupName": null,
    "jobType": "Furion.Application.MyJob",
    "assemblyName": "Furion.Application",
    "description": null,
    "concurrent": true,
    "includeAnnotations": false,
    "properties": "{}",
    "updatedTime": "2022-11-17T09:25:47.0471107+08:00"
}
""");
```

:::important å…³äºå±æ€§ååŒ¹é…è§„åˆ™

æ”¯æŒ `CamelCaseï¼ˆé©¼å³°å‘½åæ³•ï¼‰`ï¼Œ`Pascalï¼ˆå¸•æ–¯å¡å‘½åæ³•ï¼‰` å‘½åæ–¹å¼ã€‚

**ä¸æ”¯æŒ `UnderScoreCaseï¼ˆä¸‹åˆ’çº¿å‘½åæ³•ï¼‰`** ï¼Œå¦‚ `"include_annotations": true`

:::

4. **è¿˜å¯ä»¥é€šè¿‡ `Clone` é™æ€æ–¹æ³•ä»ä¸€ä¸ª `JobBuilder` åˆ›å»º**

```cs showLineNumbers
var jobBuilder = JobBuilder.Clone(fromJobBuilder);
```

:::important å…‹éš†è¯´æ˜

å…‹éš†æ“ä½œåªä¼šå…‹éš† `AssemblyName`ï¼Œ`JobType`ï¼Œ`GroupName`ï¼Œ`Description`ï¼Œ`Concurrent`ï¼Œ`IncludeAnnotations`ï¼Œ`Properties`ã€‚

**ä¸ä¼šå…‹éš† `JobId`ï¼Œ`UpdatedTime`ã€‚**

:::

5. **è¿˜å¯ä»¥é€šè¿‡ `LoadFrom` å®ä¾‹æ–¹æ³•å¡«å……å½“å‰çš„ `JobBuilder`**

æ¯”å¦‚å¯ä»¥ä¼ é€’åŒ¿åç±»å‹ï¼Œç±»ç±»å‹ï¼š

```cs showLineNumbers {2,9,14}
// ä¼šè¦†ç›–æ‰€æœ‰ç›¸åŒçš„å€¼
jobBuilder.LoadFrom(new
{
      Description = "æˆ‘æ˜¯æè¿°",
      Concurrent = false
});

// æ”¯æŒå¤šä¸ªå¡«å……ï¼Œè¿˜å¯ä»¥é…ç½®è·³è¿‡ null å€¼è¦†ç›–
jobBuilder.LoadFrom(new
{
      Description = "æˆ‘æ˜¯å¦å¤–ä¸€ä¸ªæè¿°",
      Concurrent = false,
      IncludeAnnotations = default(object)      // ä¼šè·³è¿‡èµ‹å€¼
}, ignoreNullValue: true);
```

:::important å…³äºå±æ€§ååŒ¹é…è§„åˆ™

æ”¯æŒ `CamelCaseï¼ˆé©¼å³°å‘½åæ³•ï¼‰`ï¼Œ`Pascalï¼ˆå¸•æ–¯å¡å‘½åæ³•ï¼‰` å’Œ `UnderScoreCaseï¼ˆä¸‹åˆ’çº¿å‘½åæ³•ï¼‰` å‘½åæ–¹å¼ã€‚

:::

### 26.1.3.3 è®¾ç½®ä½œä¸šä¿¡æ¯æ„å»ºå™¨

`JobBuilder` æä¾›äº†å’Œ `JobDetail` å®Œå…¨åŒ¹é…çš„ `Set[å±æ€§å]` æ–¹æ³•æ¥é…ç½®ä½œä¸šä¿¡æ¯å„ä¸ªå±æ€§ï¼Œå¦‚ï¼š

```cs showLineNumbers {3,16}
services.AddSchedule(options =>
{
    var jobBuilder = JobBuilder.Create<MyJob>()
        .SetJobId("job1")   // ä½œä¸š Id
        .SetGroupName("group1") // ä½œä¸šç»„åç§°
        .SetJobType("Furion.Application", "Furion.Application.MyJob") // ä½œä¸šç±»å‹ï¼Œæ”¯æŒå¤šä¸ªé‡è½½
        .SetJobType<MyJob>()    // ä½œä¸šç±»å‹ï¼Œæ”¯æŒå¤šä¸ªé‡è½½
        .SetJobType(typeof(MyJob))  // ä½œä¸šç±»å‹ï¼Œæ”¯æŒå¤šä¸ªé‡è½½
        .SetDescription("è¿™æ˜¯ä¸€æ®µæè¿°")   // ä½œä¸šæè¿°
        .SetConcurrent(false)   // å¹¶è¡Œè¿˜æ˜¯ä¸²è¡Œæ–¹å¼ï¼Œfalse ä¸º ä¸²è¡Œ
        .SetIncludeAnnotations(true)    // æ˜¯å¦æ‰«æ IJob ç±»å‹çš„è§¦å‘å™¨ç‰¹æ€§ï¼Œtrue ä¸º æ‰«æ
        .SetProperties("{}")    // ä½œä¸šé¢å¤–æ•°æ® Dictionary<string, object> ç±»å‹åºåˆ—åŒ–ï¼Œæ”¯æŒå¤šä¸ªé‡è½½
        .SetProperties(new Dictionary<string, object> { { "name", "Furion" } })  // ä½œä¸šç±»å‹é¢å¤–æ•°æ®ï¼Œæ”¯æŒå¤šä¸ªé‡è½½ï¼Œæ¨èï¼ï¼ï¼
        ;

    options.AddJob(jobBuilder, Triggers.PeriodSeconds(5));
});
```

### 26.1.3.4 ä½œä¸šä¿¡æ¯/æ„å»ºå™¨é¢å¤–æ•°æ®

æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦åœ¨ä½œä¸šè¿è¡Œçš„æ—¶å€™æ·»åŠ ä¸€äº›é¢å¤–æ•°æ®ï¼Œæˆ–è€…å®ç°å¤šä¸ªè§¦å‘å™¨å…±äº«æ•°æ®ï¼Œç»å¸¸ç”¨äº `ä¸²è¡Œ` æ‰§è¡Œä¸­ï¼Œåé¢ä¸€ä¸ªè§¦å‘å™¨éœ€ç­‰å¾…å‰ä¸€ä¸ªè§¦å‘å™¨å®Œæˆã€‚

```cs showLineNumbers {13-14,16}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        var jobDetail = context.JobDetail;

        var count = jobDetail.GetProperty<int>("count");
        jobDetail.AddOrUpdateProperty("count", count + 1);  // é€’å¢ count

        _logger.LogInformation($"{context.JobId} {context.TriggerId} {context.OccurrenceTime} {context.Trigger} {count}");

        await Task.CompletedTask;
    }
}
```

æŸ¥çœ‹ä½œä¸šè¿è¡Œæ—¥å¿—ï¼š

```bash showLineNumbers {2,4,6,8,10}
info: 2022-11-18 16:48:35.8308170 +08:00 æ˜ŸæœŸäº” L ConsoleApp32.MyJob[0] #5
      job1 job1_trigger1 2022/11/18 16:48:35  5000ms 0
info: 2022-11-18 16:48:40.8437231 +08:00 æ˜ŸæœŸäº” L ConsoleApp32.MyJob[0] #8
      job1 job1_trigger1 2022/11/18 16:48:40  5000ms 1
info: 2022-11-18 16:48:45.8471287 +08:00 æ˜ŸæœŸäº” L ConsoleApp32.MyJob[0] #15
      job1 job1_trigger1 2022/11/18 16:48:45  5000ms 2
info: 2022-11-18 16:48:50.8607141 +08:00 æ˜ŸæœŸäº” L ConsoleApp32.MyJob[0] #15
      job1 job1_trigger1 2022/11/18 16:48:50  5000ms 3
info: 2022-11-18 16:48:55.8645520 +08:00 æ˜ŸæœŸäº” L ConsoleApp32.MyJob[0] #14
      job1 job1_trigger1 2022/11/18 16:48:55  5000ms 4
```

ä½œä¸šè°ƒåº¦æ¨¡å—ä¸º `JobDetail` å’Œ `JobBuilder` æä¾›äº†å¤šä¸ªæ–¹æ³•æ“ä½œé¢å¤–æ•°æ®ï¼š

```cs showLineNumbers {2,5,8,11,14,17,20}
// æŸ¥çœ‹æ‰€æœ‰é¢å¤–æ•°æ®
var properties = jobDetail.GetProperties();

// æŸ¥çœ‹å•ä¸ªé¢å¤–æ•°æ®ï¼Œè¿”å› object
var value = jobBuilder.GetProperty("key");

// æŸ¥çœ‹å•ä¸ªé¢å¤–æ•°æ®æ³›å‹
var value = jobDetail.GetProperty<int>("key");

// æ·»åŠ æ–°çš„é¢å¤–æ•°æ®ï¼Œæ”¯æŒé“¾å¼æ“ä½œï¼Œå¦‚æœé”®å·²å­˜åœ¨ï¼Œåˆ™è·³è¿‡
jobDetail.AddProperty("key", "Furion").AddProperty("key1", 2);

// æ·»åŠ æˆ–æ›´æ–°é¢å¤–æ•°æ®ï¼Œæ”¯æŒé“¾å¼æ“ä½œï¼Œä¸å­˜åœ¨åˆ™æ–°å¢ï¼Œå­˜åœ¨åˆ™æ›¿æ¢ï¼Œæ¨è
jobDetail.AddOrUpdateProperty("key", "Furion").AddOrUpdateProperty("key1", 2);

// åˆ é™¤æŸä¸ªé¢å¤–æ•°æ®ï¼Œæ”¯æŒé“¾å¼æ“ä½œï¼Œå¦‚æœ key ä¸å­˜åœ¨åˆ™è·³è¿‡
jobDetail.RemoveProperty("key").RemoveProperty("key1");

// æ¸…ç©ºæ‰€æœ‰é¢å¤–æ•°æ®
jobDetail.ClearProperties();
```

:::important ä½œä¸šé¢å¤–æ•°æ®ç±»å‹æ”¯æŒ

ä½œä¸šé¢å¤–æ•°æ®æ¯ä¸€é¡¹çš„å€¼åªæ”¯æŒ `int32`ï¼Œ`string`ï¼Œ`bool`ï¼Œ`null` æˆ–å®ƒä»¬ç»„æˆçš„æ•°ç»„ç±»å‹ã€‚

:::

### 26.1.3.5 ä½œä¸šä¿¡æ¯ç‰¹æ€§

ä½œä¸šä¿¡æ¯ç‰¹æ€§ `[JobDetail]` æ˜¯ä¸ºäº†æ–¹ä¾¿è¿è¡Œæ—¶æˆ–å¯åŠ¨æ—¶å¿«é€Ÿåˆ›å»ºä½œä¸šè®¡åˆ’æ„å»ºå™¨è€Œæä¾›çš„ï¼Œå¯åœ¨å¯åŠ¨æ—¶æˆ–è¿è¡Œæ—¶é€šè¿‡ä»¥ä¸‹æ–¹å¼åˆ›å»ºï¼Œå¦‚ï¼š

```cs showLineNumbers {1}
[JobDetail("job1")]
[PeriodSeconds(5, TriggerId = "trigger1")]
public class MyJob : IJob
{
}
```

- **æ‰‹åŠ¨æ‰«æå¹¶åˆ›å»ºä½œä¸šè®¡åˆ’æ„å»ºå™¨**

```cs showLineNumbers
var schedulerBuilder = typeof(MyJob).ScanToBuilder();
```

- **é€šè¿‡ç¨‹åºé›†ç±»å‹æ‰«ææ‰¹é‡åˆ›å»ºä½œä¸šè®¡åˆ’æ„å»ºå™¨**

ä¹Ÿå¯ä»¥ç”¨äºä½œä¸šæŒä¹…åŒ– `Preload` åˆå§‹åŒ–æ—¶ä½¿ç”¨ï¼š

```cs showLineNumbers {1,4-5,8}
public IEnumerable<SchedulerBuilder> Preload()
{
      // æ‰«ææ‰€æœ‰ç±»å‹å¹¶åˆ›å»º
      return App.EffectiveTypes.Where(t => t.IsJobType())
                              .Select(t => t.ScanToBuilder());

      // è¿˜å¯ä»¥æ›´ç®€å•~~
      return App.EffectiveTypes.ScanToBuilders();
}
```

---

**ä½œä¸šä¿¡æ¯ç‰¹æ€§è¿˜æä¾›äº†å¤šä¸ªå±æ€§é…ç½®**ï¼Œå¦‚ï¼š

- `JobId`ï¼šä½œä¸šä¿¡æ¯ Idï¼Œ`string` ç±»å‹
- `GroupName`ï¼šä½œä¸šç»„åç§°ï¼Œ`string` ç±»å‹
- `Description`ï¼šæè¿°ä¿¡æ¯ï¼Œ`string` ç±»å‹
- `Concurrent`ï¼šæ˜¯å¦é‡‡ç”¨å¹¶è¡Œæ‰§è¡Œï¼Œ`bool` ç±»å‹ï¼Œå¦‚æœè®¾ç½®ä¸º `false`ï¼Œé‚£ä¹ˆä½¿ç”¨ `ä¸²è¡Œ` æ‰§è¡Œ

ä½¿ç”¨å¦‚ä¸‹ï¼š

```cs showLineNumbers {1}
[JobDetail("jobId", Concurrent = false, Description = "è¿™æ˜¯ä¸€æ®µæè¿°")]
public class MyJob : IJob
{
```

### 26.1.3.6 å¤šç§æ ¼å¼å­—ç¬¦ä¸²è¾“å‡º

`JobDetail` å’Œ `JobBuilder` éƒ½æä¾›äº†å¤šç§å°†è‡ªèº«è½¬æ¢æˆç‰¹å®šæ ¼å¼çš„å­—ç¬¦ä¸²ã€‚

1. **è½¬æ¢æˆ `JSON` å­—ç¬¦ä¸²**

```cs showLineNumbers
var json = jobDetail.ConvertToJSON();
```

å­—ç¬¦ä¸²æ‰“å°å¦‚ä¸‹ï¼š

```json showLineNumbers
{
  "jobId": "job1",
  "groupName": null,
  "jobType": "Furion.Application.MyJob",
  "assemblyName": "Furion.Application",
  "description": null,
  "concurrent": true,
  "includeAnnotations": false,
  "properties": "{}",
  "updatedTime": "2022-11-18T22:56:47.4149299+08:00"
}
```

2. **è½¬æ¢æˆ `SQL` å­—ç¬¦ä¸²**

```cs showLineNumbers {2,6,9,13,16,20}
// è¾“å‡ºæ–°å¢ SQLï¼Œä½¿ç”¨ CamelCase å±æ€§å‘½å
var insertSql = jobDetail.ConvertToSQL("tbName"
      , PersistenceBehavior.Appended
      , NamingConventions.CamelCase);
// æ›´ä¾¿æ·æ‹“å±•
var insertSql = jobDetail.ConvertToInsertSQL("tbName", NamingConventions.CamelCase);

// è¾“å‡ºåˆ é™¤ SQLï¼Œä½¿ç”¨ Pascal å±æ€§å‘½å
var deleteSql = jobDetail.ConvertToSQL("tbName"
      , PersistenceBehavior.Removed
      , NamingConventions.Pascal);
// æ›´ä¾¿æ·æ‹“å±•
var deleteSql = jobDetail.ConvertToDeleteSQL("tbName", NamingConventions.Pascal);

// è¾“å‡ºæ›´æ–° SQLï¼Œä½¿ç”¨ UnderScoreCase å±æ€§å‘½å
var updateSql = jobDetail.ConvertToSQL("tbName"
      , PersistenceBehavior.Updated
      , NamingConventions.UnderScoreCase);
// æ›´ä¾¿æ·æ‹“å±•
var updateSql = jobDetail.ConvertToUpdateSQL("tbName", NamingConventions.UnderScoreCase);
```

å­—ç¬¦ä¸²æ‰“å°å¦‚ä¸‹ï¼š

```sql showLineNumbers {2,26,30}
-- æ–°å¢è¯­å¥
INSERT INTO tbName(
      [jobId],
      [groupName],
      [jobType],
      [assemblyName],
      [description],
      [concurrent],
      [includeAnnotations],
      [properties],
      [updatedTime]
)
VALUES(
      'job1',
      NULL,
      'ConsoleApp13.MyJob',
      'ConsoleApp13',
      NULL,
      1,
      0,
      '{}',
      '2022/11/18 23:16:18'
);

-- åˆ é™¤è¯­å¥
DELETE FROM tbName
WHERE [JobId] = 'job1';

-- æ›´æ–°è¯­å¥
UPDATE tbName
SET
      [job_id] = 'job1',
      [group_name] = NULL,
      [job_type] = 'ConsoleApp13.MyJob',
      [assembly_name] = 'ConsoleApp13',
      [description] = NULL,
      [concurrent] = 1,
      [include_annotations] = 0,
      [properties] = '{}',
      [updated_time] = '2022/11/18 23:16:18'
WHERE [job_id] = 'job1';
```

3. **è½¬æ¢æˆ `Monitor` å­—ç¬¦ä¸²**

```cs showLineNumbers
var monitor = jobDetail.ConvertToMonitor();
```

å­—ç¬¦ä¸²æ‰“å°å¦‚ä¸‹ï¼š

```bash showLineNumbers
â”â”â”â”â”â”â”â”â”â”â”â”  JobDetail â”â”â”â”â”â”â”â”â”â”â”
â”£ ConsoleApp13.MyJob
â”£
â”£ jobIdï¼š                     job1
â”£ groupNameï¼š
â”£ jobTypeï¼š                   Furion.Application.MyJob
â”£ assemblyNameï¼š              Furion.Application
â”£ descriptionï¼š
â”£ concurrentï¼š                True
â”£ includeAnnotationsï¼š        False
â”£ propertiesï¼š                {}
â”£ updatedTimeï¼š               2022/11/18 23:26:47
â”—â”â”â”â”â”â”â”â”â”â”â”  JobDetail â”â”â”â”â”â”â”â”â”â”â”
```

4. **ç®€è¦å­—ç¬¦ä¸²è¾“å‡º**

```cs showLineNumbers
var str = jobDetail.ToString();
```

```bash showLineNumbers
<job1> è¿™æ˜¯ä¸€æ®µæè¿°
```

## 26.1.4 ä½œä¸šå¤„ç†ç¨‹åº `IJob`

ä½œä¸šå¤„ç†ç¨‹åºæ˜¯ä½œä¸šå…·ä½“æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘ä»£ç ï¼Œé€šå¸¸ç”±ç¨‹åºå‘˜ç¼–å†™ï¼Œä½œä¸šå¤„ç†ç¨‹åºå¿…é¡»å®ç° `IJob` æ¥å£ã€‚

### 26.1.4.1 å¦‚ä½•å®šä¹‰

```cs showLineNumbers {1,3,5}
public class MyJob : IJob
{
    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        // your code...
    }
}
```

### 26.1.4.2 ä¾èµ–æ³¨å…¥

å®ç° `IJob` çš„ä½œä¸šå¤„ç†ç¨‹åºç±»å‹é»˜è®¤æ³¨å†Œä¸º `å•ä¾‹`ï¼Œ**é‚£ä¹ˆåªè¦æ˜¯å•ä¾‹çš„æœåŠ¡ï¼Œçš†å¯ä»¥é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥**ï¼Œå¦‚ï¼š`ILogger<>`ï¼Œ`IConfiguration`ã€‚

```cs showLineNumbers {3-4,6-7}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    private readonly IConfiguration _configuration;

    public MyJob(ILogger<MyJob> logger
        , IConfiguration configuration)
    {
        _logger = logger;
        _configuration = configuration;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation($"{context.JobId} {context.TriggerId} {context.OccurrenceTime} {context.Trigger} {count}");

        await Task.CompletedTask;
    }
}
```

- **å¦‚æœæ˜¯éå•ä¾‹çš„æ¥å£ï¼Œå¦‚ç¬æ—¶æˆ–èŒƒå›´æœåŠ¡ï¼Œå¯é€šè¿‡ `IServiceProvder` åˆ›å»º**

```cs showLineNumbers {5,9,18-19}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    private readonly IConfiguration _configuration;
    private readonly IServiceProvider _serviceProvider;

    public MyJob(ILogger<MyJob> logger
        , IConfiguration configuration
        , IServiceProvider serviceProvider)
    {
        _logger = logger;
        _configuration = configuration;
        _serviceProvider = serviceProvider;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        using var serviceScope = _serviceProvider.CreateScope();
        var repository = serviceScope.ServiceProvider.GetService<IRepository<User>>();

        _logger.LogInformation($"{context.JobId} {context.TriggerId} {context.OccurrenceTime} {context.Trigger}");

        await Task.CompletedTask;
    }
}
```

- **é’ˆå¯¹é«˜é¢‘å®šæ—¶ä»»åŠ¡ï¼Œæ¯”å¦‚æ¯ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œæˆ–è€…æ›´é¢‘ç¹çš„ä»»åŠ¡**

ä¸ºäº†é¿å…é¢‘ç¹åˆ›å»ºä½œç”¨åŸŸå’Œé”€æ¯ä½œç”¨åŸŸï¼Œå¯åˆ›å»ºé•¿èŒƒå›´çš„ä½œç”¨åŸŸã€‚

```cs showLineNumbers {1,5,13,18,25,27}
public class MyJob : IJob, IDisposable
{
    private readonly ILogger<MyJob> _logger;
    private readonly IConfiguration _configuration;
    private readonly IServiceScope _serviceScope;

    public MyJob(ILogger<MyJob> logger
        , IConfiguration configuration
        , IServiceProvider serviceProvider)
    {
        _logger = logger;
        _configuration = configuration;
        _serviceScope = serviceProvider.CreateScope();
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        var repository = _serviceScope.ServiceProvider.GetService<IRepository<User>>();

        _logger.LogInformation($"{context.JobId} {context.TriggerId} {context.OccurrenceTime} {context.Trigger}");

        await Task.CompletedTask;
    }

    public void Dispose()
    {
        _serviceScope?.Dispose();
    }
}
```

### 26.1.4.3 `JobExecutingContext` ä¸Šä¸‹æ–‡

`JobExecutingContext` ä¸Šä¸‹æ–‡ä½œä¸º `ExecuteAsync` æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæä¾›äº†ä»¥ä¸‹å‡ ä¸ªè¿è¡Œæ—¶ä¿¡æ¯ï¼š

- **`JobExecutingContext` å±æ€§åˆ—è¡¨**
  - `JobId`ï¼šä½œä¸š `Id`
  - `TriggerId`ï¼šå½“å‰è§¦å‘å™¨ `Id`
  - `JobDetail`ï¼šä½œä¸šä¿¡æ¯
  - `Trigger`ï¼šä½œä¸šè§¦å‘å™¨
  - `OccurrenceTime`ï¼šè°ƒåº¦å™¨æ£€æŸ¥æ—¶é—´ï¼Œæœ€å‡†ç¡®çš„è®°å½•æ—¶é—´
  - `ExecutingTime`ï¼šå®é™…æ‰§è¡Œæ—¶é—´ï¼ˆå¯èƒ½å­˜åœ¨è¯¯å·®ï¼‰
- **`JobExecutingContext` æ–¹æ³•åˆ—è¡¨**
  - `.ConvertToJSON(naming)`ï¼šå°†ä½œä¸šè®¡åˆ’è½¬æ¢æˆ `JSON` å­—ç¬¦ä¸²

### 26.1.4.4 ä½œä¸šè¢«å–æ¶ˆå¤„ç†

ä¸€ä¸‹æƒ…å†µä¸‹ï¼Œä½œä¸šè¢«ä¸´æ—¶æš‚åœæˆ–å–æ¶ˆï¼Œä½†ä½œä¸šå¤„ç†ç¨‹åºè¿˜æœªå¤„ç†å®Œæˆï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥é€‰æ‹©å–æ¶ˆè¿˜æ˜¯ç»§ç»­æ‰§è¡Œï¼Œå¦‚æœé€‰æ‹©åŒæ­¥å–æ¶ˆï¼š

```cs showLineNumbers {1,13,18}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;

    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
       // åˆ›å»ºä»»åŠ¡å…³è”å–æ¶ˆ Token
        using var cancellationTokenSource = CancellationTokenSource.CreateLinkedTokenSource(stoppingToken);

        try
        {
            // ä¼ é€’ç»™å¼‚æ­¥æœåŠ¡
            await todo.SomeMethodAsync(cancellationTokenSource.Token);
        }
        catch (Exception ex)
        {
            // ...
        }

        _logger.LogInformation($"{context.JobId} {context.TriggerId} {context.OccurrenceTime} {context.Trigger}");
    }
}
```

è¿™æ ·å½“ä½œä¸šè¢«å–æ¶ˆæ—¶ï¼Œ`SomeMethodAsync` ä¹Ÿä¼šåŒæ­¥å–æ¶ˆã€‚

## 26.1.5 ä½œä¸šè§¦å‘å™¨ `Trigger` åŠæ„å»ºå™¨

### 26.1.5.1 å…³äºä½œä¸šè§¦å‘å™¨

æ¡†æ¶æä¾›äº† `Trigger` ç±»å‹æ¥æè¿°ä½œä¸šå…·ä½“çš„è§¦å‘æ—¶é—´ï¼Œ`Trigger` ç±»å‹æä¾›ä»¥ä¸‹**åªè¯»å±æ€§**ï¼š

| å±æ€§å              | å±æ€§ç±»å‹        | é»˜è®¤å€¼  | è¯´æ˜                                                                 |
| ------------------- | --------------- | ------- | -------------------------------------------------------------------- |
| `TriggerId`         | `string`        |         | ä½œä¸šè§¦å‘å™¨ `Id`                                                      |
| `JobId`             | `string`        |         | ä½œä¸š `Id`                                                            |
| `TriggerType`       | `string`        |         | ä½œä¸šè§¦å‘å™¨ç±»å‹ï¼Œå­˜å‚¨çš„æ˜¯ç±»å‹çš„ `FullName`                            |
| `AssemblyName`      | `string`        |         | ä½œä¸šè§¦å‘å™¨ç±»å‹æ‰€åœ¨ç¨‹åºé›†ï¼Œå­˜å‚¨çš„æ˜¯ç¨‹åºé›† `Name`                      |
| `Args`              | `string`        |         | ä½œä¸šè§¦å‘å™¨å‚æ•°ï¼Œè¿è¡Œæ—¶å°†ååºåˆ—åŒ–ä¸º `object[]` ç±»å‹å¹¶ä½œä¸ºæ„é€ å‡½æ•°å‚æ•° |
| `Description`       | `string`        |         | æè¿°ä¿¡æ¯                                                             |
| `Status`            | `TriggerStatus` | `Ready` | ä½œä¸šè§¦å‘å™¨çŠ¶æ€                                                       |
| `StartTime`         | `DateTime?`     |         | èµ·å§‹æ—¶é—´                                                             |
| `EndTime`           | `DateTime?`     |         | ç»“æŸæ—¶é—´                                                             |
| `LastRunTime`       | `DateTime?`     |         | æœ€è¿‘è¿è¡Œæ—¶é—´                                                         |
| `NextRunTime`       | `DateTime?`     |         | ä¸‹ä¸€æ¬¡è¿è¡Œæ—¶é—´                                                       |
| `NumberOfRuns`      | `long`          | `0`     | è§¦å‘æ¬¡æ•°                                                             |
| `MaxNumberOfRuns`   | `long`          | `0`     | æœ€å¤§è§¦å‘æ¬¡æ•°ï¼Œ`0`ï¼šä¸é™åˆ¶ï¼Œ`n`ï¼šN æ¬¡                                 |
| `NumberOfErrors`    | `long`          | `0`     | å‡ºé”™æ¬¡æ•°                                                             |
| `MaxNumberOfErrors` | `long`          | `0`     | æœ€å¤§å‡ºé”™æ¬¡æ•°ï¼Œ`0`ï¼šä¸é™åˆ¶ï¼Œ`n`ï¼šN æ¬¡                                 |
| `NumRetries`        | `int`           | `0`     | é‡è¯•æ¬¡æ•°                                                             |
| `RetryTimeout`      | `int`           | `1000`  | é‡è¯•é—´éš”æ—¶é—´ï¼Œæ¯«ç§’å•ä½                                               |
| `StartNow`          | `bool`          | `true`  | æ˜¯å¦ç«‹å³å¯åŠ¨                                                         |
| `RunOnStart`        | `bool`          | `false` | æ˜¯å¦å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡                                                   |
| `ResetOnlyOnce`     | `bool`          | `true`  | æ˜¯å¦åœ¨å¯åŠ¨æ—¶é‡ç½®æœ€å¤§è§¦å‘æ¬¡æ•°ç­‰äºä¸€æ¬¡çš„ä½œä¸š                           |
| `UpdatedTime`       | `DateTime?`     |         | ä½œä¸šè§¦å‘å™¨æ›´æ–°æ—¶é—´                                                   |

### 26.1.5.2 ä½œä¸šè§¦å‘å™¨çŠ¶æ€

ä½œä¸šè§¦å‘å™¨çŠ¶æ€æŒ‡ç¤ºäº†å½“å‰ä½œä¸šè§¦å‘å™¨çš„çŠ¶æ€ï¼Œä½¿ç”¨ `TriggerStatus` æšä¸¾ç±»å‹ï¼ˆ`uint`ï¼‰ï¼Œè¯¥ç±»å‹åŒ…å«ä»¥ä¸‹æšä¸¾æˆå‘˜ã€‚

| æšä¸¾å         | æšä¸¾å€¼ | è¯´æ˜                                                         |
| -------------- | ------ | ------------------------------------------------------------ |
| `Backlog`      | `0`    | ç§¯å‹ï¼Œèµ·å§‹æ—¶é—´å¤§äºå½“å‰æ—¶é—´                                   |
| `Ready`        | `1`    | å°±ç»ª                                                         |
| `Running`      | `2`    | æ­£åœ¨è¿è¡Œ                                                     |
| `Pause`        | `3`    | æš‚åœ                                                         |
| `Blocked`      | `4`    | é˜»å¡ï¼Œæœ¬è¯¥æ‰§è¡Œä½†æ˜¯æ²¡æœ‰æ‰§è¡Œ                                   |
| `ErrorToReady` | `5`    | ç”±å¤±è´¥è¿›å…¥å°±ç»ªï¼Œè¿è¡Œé”™è¯¯å½“å¹¶æœªè¶…å‡ºæœ€å¤§é”™è¯¯æ•°ï¼Œè¿›å…¥ä¸‹ä¸€è½®å°±ç»ª |
| `Archived`     | `6`    | å½’æ¡£ï¼Œç»“æŸæ—¶é—´å°äºå½“å‰æ—¶é—´                                   |
| `Panic`        | `7`    | å´©æºƒï¼Œé”™è¯¯æ¬¡æ•°è¶…å‡ºäº†æœ€å¤§é”™è¯¯æ•°                               |
| `Overrun`      | `8`    | è¶…é™ï¼Œè¿è¡Œæ¬¡æ•°è¶…å‡ºäº†æœ€å¤§é™åˆ¶                                 |
| `Unoccupied`   | `9`    | æ— è§¦å‘æ—¶é—´ï¼Œä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´ä¸º `null`                          |
| `NotStart`     | `10`   | æœªå¯åŠ¨                                                       |
| `Unknown`      | `11`   | æœªçŸ¥ä½œä¸šè§¦å‘å™¨ï¼Œä½œä¸šè§¦å‘å™¨è¿è¡Œæ—¶ç±»å‹ä¸º `null`                |
| `Unhandled`    | `12`   | æœªçŸ¥ä½œä¸šå¤„ç†ç¨‹åºï¼Œä½œä¸šå¤„ç†ç¨‹åºç±»å‹è¿è¡Œæ—¶ç±»å‹ä¸º `null`        |

### 26.1.5.3 å…³äºä½œä¸šè§¦å‘å™¨æ„å»ºå™¨

ä½œä¸šè§¦å‘å™¨ `Trigger` æ˜¯ä½œä¸šè°ƒåº¦æ¨¡å—æä¾›è¿è¡Œæ—¶çš„**åªè¯»ç±»å‹**ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•åˆ›å»ºæˆ–å˜æ›´ `Trigger` å¯¹è±¡å‘¢ï¼Ÿ

`TriggerBuilder` æ˜¯ä½œä¸šè°ƒåº¦æ¨¡å—æä¾›å¯ç”¨æ¥ç”Ÿæˆè¿è¡Œæ—¶ `Trigger` çš„ç±»å‹ï¼Œè¿™æ ·åšçš„å¥½å¤„å¯é¿å…å¤–éƒ¨ç›´æ¥ä¿®æ”¹è¿è¡Œæ—¶ `Trigger` æ•°æ®ï¼Œè¿˜èƒ½å®ç°ä»»ä½•ä¿®æ”¹åŠ¨ä½œç›‘å¬ï¼Œä¹Ÿèƒ½é¿å…å¤šçº¿ç¨‹æŠ¢å æƒ…å†µã€‚

ä½œä¸šè°ƒåº¦æ¨¡å—æä¾›äº†å¤šç§æ–¹å¼ç”¨æ¥åˆ›å»º `TriggerBuilder` å¯¹è±¡ã€‚

1. **é€šè¿‡ `Create` é™æ€æ–¹æ³•åˆ›å»º**

```cs showLineNumbers {2,5,8}
// æ ¹æ® Trigger æ´¾ç”Ÿç±»ç±»å‹åˆ›å»º
var triggerBuilder = TriggerBuilder.Create<PeriodTrigger>();

// æ ¹æ® Type ç±»å‹åˆ›å»º
var triggerBuilder = TriggerBuilder.Create(typeof(PeriodTrigger));

// æ ¹æ®ç¨‹åºé›†åç§°å’Œç±»å‹å®Œå…¨é™å®šåï¼ˆFullNameï¼‰åˆ›å»º
var triggerBuilder = TriggerBuilder.Create("Furion", "Furion.Schedule.PeriodTrigger");
```

2. **é€šè¿‡ `Trigger` ç±»å‹åˆ›å»º**

è¿™ç§æ–¹å¼å¸¸ç”¨äºåœ¨è¿è¡Œæ—¶æ›´æ–°ä½œä¸šè§¦å‘å™¨ã€‚

```cs showLineNumbers
var triggerBuilder = TriggerBuilder.From(trigger);

//ä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼
var triggerBuilder = trigger.GetBuilder();
```

3. **é€šè¿‡ `JSON` å­—ç¬¦ä¸²åˆ›å»º**

è¯¥æ–¹å¼éå¸¸çµæ´»ï¼Œå¯ä»é…ç½®æ–‡ä»¶ï¼Œ`JSON` å­—ç¬¦ä¸²ï¼Œæˆ–å…¶ä»–èƒ½å¤Ÿè¿”å› `JSON` å­—ç¬¦ä¸²çš„åœ°æ–¹åˆ›å»ºã€‚

```cs showLineNumbers {2-24}
var triggerBuilder = TriggerBuilder.From(@"
{
    ""triggerId"": ""job1_trigger1"",
    ""triggerType"": ""Furion.Schedule.PeriodSecondsTrigger"",
    ""assemblyName"": ""Furion"",
    ""args"": ""[5]"",
    ""description"": null,
    ""status"": 2,
    ""startTime"": null,
    ""endTime"": null,
    ""lastRunTime"": ""2022-11-20T18:31:56.6859410+08:00"",
    ""nextRunTime"": ""2022-11-20T18:32:01.7233546+08:00"",
    ""numberOfRuns"": 1,
    ""maxNumberOfRuns"": 0,
    ""numberOfErrors"": 0,
    ""maxNumberOfErrors"": 0,
    ""numRetries"": 0,
    ""retryTimeout"": 1000,
    ""startNow"": true,
    ""runOnStart"": false,
    ""resetOnlyOnce"": true,
    ""updatedTime"": ""2022-11-20T18:31:56.7233630+08:00""
}");
```

å¦‚æœä½¿ç”¨çš„æ˜¯ `.NET7`ï¼Œå¯ä½¿ç”¨ `"""` é¿å…è½¬ä¹‰ï¼Œå¦‚ï¼š

```cs showLineNumbers {2-24}
var triggerBuilder = TriggerBuilder.From("""
{
    "triggerId": "job1_trigger1",
    "triggerType": "Furion.Schedule.PeriodSecondsTrigger",
    "assemblyName": "Furion",
    "args": "[5]",
    "description": null,
    "status": 2,
    "startTime": null,
    "endTime": null,
    "lastRunTime": "2022-11-20T18:31:56.6859410+08:00",
    "nextRunTime": "2022-11-20T18:32:01.7233546+08:00",
    "numberOfRuns": 1,
    "maxNumberOfRuns": 0,
    "numberOfErrors": 0,
    "maxNumberOfErrors": 0,
    "numRetries": 0,
    "retryTimeout": 1000,
    "startNow": true,
    "runOnStart": false,
    "resetOnlyOnce": true,
    "updatedTime": "2022-11-20T18:31:56.7233630+08:00"
}
""");
```

:::important å…³äºå±æ€§ååŒ¹é…è§„åˆ™

æ”¯æŒ `CamelCaseï¼ˆé©¼å³°å‘½åæ³•ï¼‰`ï¼Œ`Pascalï¼ˆå¸•æ–¯å¡å‘½åæ³•ï¼‰` å‘½åæ–¹å¼ã€‚

**ä¸æ”¯æŒ `UnderScoreCaseï¼ˆä¸‹åˆ’çº¿å‘½åæ³•ï¼‰`** ï¼Œå¦‚ `"include_annotations": true`

:::

4. **è¿˜å¯ä»¥é€šè¿‡ `Clone` é™æ€æ–¹æ³•ä»ä¸€ä¸ª `TriggerBuilder` åˆ›å»º**

```cs showLineNumbers
var triggerBuilder = TriggerBuilder.Clone(fromTriggerBuilder);
```

:::important å…‹éš†è¯´æ˜

å…‹éš†æ“ä½œåªä¼šå…‹éš† `AssemblyName`ï¼Œ`TriggerType`ï¼Œ`Args`ï¼Œ`Description`ï¼Œ`StartTime`ï¼Œ`EndTime`ï¼Œ`MaxNumberOfRuns`ï¼Œ`MaxNumberOfErrors`ï¼Œ`NumRetries`ï¼Œ`RetryTimeout`ï¼Œ`StartNow`ï¼Œ`RunOnStart`ï¼Œ`ResetOnlyOnce`ã€‚

**ä¸ä¼šå…‹éš† `TriggerId`ï¼Œ`JobId`ï¼Œ`Status`ï¼Œ`LastRunTime`ï¼Œ`NextRunTime`ï¼Œ`NumberOfRuns`ï¼Œ`NumberOfErrors`ï¼Œ`UpdatedTime`ã€‚**

:::

5. **è¿˜å¯ä»¥é€šè¿‡ `LoadFrom` å®ä¾‹æ–¹æ³•å¡«å……å½“å‰çš„ `TriggerBuilder`**

æ¯”å¦‚å¯ä»¥ä¼ é€’åŒ¿åç±»å‹ï¼Œç±»ç±»å‹ï¼š

```cs showLineNumbers {2,9,14}
// ä¼šè¦†ç›–æ‰€æœ‰ç›¸åŒçš„å€¼
triggerBuilder.LoadFrom(new
{
      Description = "æˆ‘æ˜¯æè¿°",
      StartTime = DateTime.Now
});

// æ”¯æŒå¤šä¸ªå¡«å……ï¼Œè¿˜å¯ä»¥é…ç½®è·³è¿‡ null å€¼è¦†ç›–
triggerBuilder.LoadFrom(new
{
      Description = "æˆ‘æ˜¯å¦å¤–ä¸€ä¸ªæè¿°",
      StartTime = DateTime.Now,
      LastRunTime = default(DateTime?)      // ä¼šè·³è¿‡èµ‹å€¼
}, ignoreNullValue: true);
```

:::important å…³äºå±æ€§ååŒ¹é…è§„åˆ™

æ”¯æŒ `CamelCaseï¼ˆé©¼å³°å‘½åæ³•ï¼‰`ï¼Œ`Pascalï¼ˆå¸•æ–¯å¡å‘½åæ³•ï¼‰` å’Œ `UnderScoreCaseï¼ˆä¸‹åˆ’çº¿å‘½åæ³•ï¼‰` å‘½åæ–¹å¼ã€‚

:::

### 26.1.5.4 å†…ç½®ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨

ä¸ºäº†æ–¹ä¾¿å¿«é€Ÿå®ç°ä½œä¸šè§¦å‘å™¨ï¼Œä½œä¸šè°ƒåº¦æ¨¡å—å†…ç½®äº† `Periodï¼ˆé—´éš”ï¼‰` å’Œ `Cronï¼ˆè¡¨è¾¾å¼ï¼‰` ä½œä¸šè§¦å‘å™¨ï¼Œå¯é€šè¿‡ `TriggerBuilder` ç±»å‹æˆ– `Triggers` é™æ€ç±»åˆ›å»ºã€‚

- **`TriggerBuilder` æ–¹å¼**

```c showLineNumbers {2,5,8}
// åˆ›å»ºæ¯«ç§’å‘¨æœŸï¼ˆé—´éš”ï¼‰ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = TriggerBuilder.Period(5000);

// åˆ›å»ºç§’å‘¨æœŸï¼ˆé—´éš”ï¼‰ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = TriggerBuilder.PeriodSeconds(5);

// åˆ›å»º Cron è¡¨è¾¾å¼ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = TriggerBuilder.Cron("* * * * *", CronStringFormat.Default);
```

- **`Triggers` æ–¹å¼ï¼Œæ¨è**

`Triggers` å…·å¤‡ `TriggerBuilder` æ‰€æœ‰çš„é™æ€æ–¹æ³•ï¼Œå¦å¤–è¿˜æ·»åŠ äº†ä¸å°‘æ›´åŠ ä¾¿æ·çš„é™æ€æ–¹æ³•ã€‚

```cs showLineNumbers {2,5,8,11,14,17,20,23,26,29}
// åˆ›å»ºæ¯«ç§’å‘¨æœŸï¼ˆé—´éš”ï¼‰ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.Period(5000);

// åˆ›å»ºç§’å‘¨æœŸï¼ˆé—´éš”ï¼‰ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.PeriodSeconds(5);

// åˆ›å»º Cron è¡¨è¾¾å¼ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.Cron("* * * * *", CronStringFormat.Default);

// åˆ›å»ºæ¯ç§’å¼€å§‹ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.Secondly();

// åˆ›å»ºæ¯åˆ†é’Ÿå¼€å§‹ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.Minutely();

// åˆ›å»ºæ¯å°æ—¶å¼€å§‹ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.Hourly();

// åˆ›å»ºæ¯å¤©ï¼ˆåˆå¤œï¼‰å¼€å§‹ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.Daily();

// åˆ›å»ºæ¯æœˆ1å·ï¼ˆåˆå¤œï¼‰å¼€å§‹ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.Monthly();

// åˆ›å»ºæ¯å‘¨æ—¥ï¼ˆåˆå¤œï¼‰å¼€å§‹ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.Weekly();

// åˆ›å»ºæ¯å¹´1æœˆ1å·ï¼ˆåˆå¤œï¼‰å¼€å§‹ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = Triggers.Yearly();
```

### 26.1.5.5 è‡ªå®šä¹‰ä½œä¸šè§¦å‘å™¨

é™¤äº†ä½¿ç”¨ä½œä¸šè°ƒåº¦æ¨¡å—æä¾›äº† `PeriodTrigger` å’Œ `CronTrigger` ä»¥å¤–ï¼Œå¯è‡ªå®šä¹‰ä½œä¸šè§¦å‘å™¨ï¼Œåªéœ€è¦ç»§æ‰¿ `Trigger` å¹¶é‡å†™ `GetNextOccurrence` æ–¹æ³•å³å¯ï¼Œå¦‚å®ç°ä¸€ä¸ªé—´éš”ä¸¤ç§’çš„ä½œä¸šè§¦å‘å™¨ã€‚

```cs showLineNumbers {1,3,5}
public class TwiceSecondTrigger : Trigger
{
    public override DateTime GetNextOccurrence(DateTime startAt)
    {
        return startAt.AddSeconds(2);
    }
}
```

ä¹‹åå¯é€šè¿‡ `Triggers.Create` æˆ– `Triggers.Create` åˆ›å»ºå³å¯ï¼š

```cs showLineNumbers {3}
services.AddSchedule(options =>
{
    options.AddJob<MyJob>(Triggers.Create<TwiceSecondTrigger>());
});
```

æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœï¼š

```bash showLineNumbers {2,4,6,8,10,12}
info: 2022-11-20 21:13:02.4726416 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #9
      job1 job1_trigger1 2022/11/20 21:13:02 ConsoleApp13.TwiceSecondTrigger
info: 2022-11-20 21:13:04.4591328 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #6
      job1 job1_trigger1 2022/11/20 21:13:04 ConsoleApp13.TwiceSecondTrigger
info: 2022-11-20 21:13:06.4677716 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #4
      job1 job1_trigger1 2022/11/20 21:13:06 ConsoleApp13.TwiceSecondTrigger
info: 2022-11-20 21:13:08.4726987 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #14
      job1 job1_trigger1 2022/11/20 21:13:08 ConsoleApp13.TwiceSecondTrigger
info: 2022-11-20 21:13:10.4827028 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #9
      job1 job1_trigger1 2022/11/20 21:13:10 ConsoleApp13.TwiceSecondTrigger
info: 2022-11-20 21:13:12.4936247 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #14
      job1 job1_trigger1 2022/11/20 21:13:12 ConsoleApp13.TwiceSecondTrigger
```

å¦å¤–ï¼Œè‡ªå®šä¹‰ä½œä¸šè§¦å‘å™¨è¿˜æ”¯æŒä¼ é€’å‚æ•°ï¼š

:::important å‚æ•°ç‰¹åˆ«è¯´æ˜

å¦‚æœè‡ªå®šä¹‰ä½œä¸šè§¦å‘å™¨åŒ…å«å‚æ•°ï¼Œé‚£ä¹ˆ**å¿…é¡»æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶**ï¼š

- **å‚æ•°å¿…é¡»é€šè¿‡å”¯ä¸€çš„æ„é€ å‡½æ•°ä¼ å…¥ï¼Œæœ‰ä¸”æœ€å¤šåªèƒ½æ‹¥æœ‰ä¸€ä¸ªæ„é€ å‡½æ•°**
- **å‚æ•°çš„ç±»å‹åªèƒ½æ˜¯ `int`ï¼Œ`string`ï¼Œ`bool`ï¼Œ`null` æˆ–ç”±å®ƒä»¬ç»„æˆçš„æ•°ç»„ç±»å‹**

:::

```cs showLineNumbers {1,3,5,8,12}
public class SomeSecondTrigger : Trigger
{
    public SomeSecondTrigger(int seconds) // æ”¯æŒå¤šä¸ªå‚æ•°
    {
        Seconds = seconds;
    }

    private int Seconds { get; }

    public override DateTime GetNextOccurrence(DateTime startAt)
    {
        return startAt.AddSeconds(Seconds);
    }
}
```

ä¹‹åå¯é€šè¿‡ `Triggers.Create` æˆ– `Triggers.Create` åˆ›å»ºå¹¶ä¼ å…¥å‚æ•°ã€‚

```cs showLineNumbers {3}
services.AddSchedule(options =>
{
    options.AddJob<MyJob>(Triggers.Create<SomeSecondTrigger>(3)); // 3 ç§’æ‰§è¡Œä¸€æ¬¡
});
```

æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœï¼š

```bash showLineNumbers {2,4,6,8,10,12}
info: 2022-11-20 21:33:46.3074692 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #4
      job1 job1_trigger1 2022/11/20 21:33:46 ConsoleApp13.SomeSecondTrigger
info: 2022-11-20 21:33:49.3101667 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #6
      job1 job1_trigger1 2022/11/20 21:33:49 ConsoleApp13.SomeSecondTrigger
info: 2022-11-20 21:33:52.3222046 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #8
      job1 job1_trigger1 2022/11/20 21:33:52 ConsoleApp13.SomeSecondTrigger
info: 2022-11-20 21:33:55.3270737 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #4
      job1 job1_trigger1 2022/11/20 21:33:55 ConsoleApp13.SomeSecondTrigger
info: 2022-11-20 21:33:58.3293727 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #6
      job1 job1_trigger1 2022/11/20 21:33:58 ConsoleApp13.SomeSecondTrigger
info: 2022-11-20 21:34:01.3472296 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #4
      job1 job1_trigger1 2022/11/20 21:34:01 ConsoleApp13.SomeSecondTrigger
```

è‡ªå®šä¹‰ä½œä¸šè§¦å‘å™¨é™¤äº†å¯é‡å†™ `GetNextOccurrence` æ–¹æ³•ä¹‹åï¼Œè¿˜æä¾›äº† `ShouldRun` å’Œ `ToString` æ–¹æ³•å¯é‡å†™ï¼Œå¦‚ï¼š

```cs showLineNumbers {15,22,24}
public class SomeSecondTrigger : Trigger
{
    public SomeSecondTrigger(int seconds)
    {
        Seconds = seconds;
    }

    private int Seconds { get; }

    public override DateTime GetNextOccurrence(DateTime startAt)
    {
        return startAt.AddSeconds(Seconds);
    }

    public override bool ShouldRun(JobDetail jobDetail, DateTime startAt)
    {
        // åœ¨è¿™é‡Œè¿›ä¸€æ­¥æ§åˆ¶ï¼Œå¦‚æœè¿”å› falseï¼Œåˆ™ä½œä¸šè§¦å‘å™¨è·³è¿‡æ‰§è¡Œ

        return base.ShouldRun(jobDetail, startAt);
    }

    public override string ToString()
    {
        return $"è‡ªå®šä¹‰é€’å¢ {Seconds}s è§¦å‘å™¨";
    }
}
```

æ¨èé‡å†™ `GetNextRunTime` å’Œ `ToString` æ–¹æ³•å³å¯ï¼Œå¦‚æœé‡å†™äº† `ToString` æ–¹æ³•ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ $`{trigger}` è¾“å‡ºï¼Œå¦‚ï¼š

```cs showLineNumbers {11}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation($"{context.JobId} {context.TriggerId} {context.OccurrenceTime} {context.Trigger}");
        await Task.CompletedTask;
    }
}
```

æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœï¼š

```bash showLineNumbers {2,4}
info: 2022-11-20 21:43:07.4570694 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #4
      job1 job1_trigger1 2022/11/20 21:43:07 è‡ªå®šä¹‰é€’å¢ 3s è§¦å‘å™¨
info: 2022-11-20 21:43:10.4629078 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #9
      job1 job1_trigger1 2022/11/20 21:43:10 è‡ªå®šä¹‰é€’å¢ 3s è§¦å‘å™¨
```

### 26.1.5.6 ä½œä¸šè§¦å‘å™¨ç‰¹æ€§

å¦‚æœ `JobBuilder` é…ç½®äº† `IncludeAnnotations` å‚æ•°ä¸”ä¸º `true`ï¼Œé‚£ä¹ˆå°†ä¼šè‡ªåŠ¨è§£æ `IJob` çš„å®ç°ç±»å‹çš„æ‰€æœ‰ç»§æ‰¿ `TriggerAttribute` çš„ç‰¹æ€§ï¼Œç›®å‰ä½œä¸šè°ƒåº¦æ¨¡å—å†…ç½®äº†ä»¥ä¸‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§ï¼š

- `[Period(5000)]`ï¼šæ¯«ç§’å‘¨æœŸï¼ˆé—´éš”ï¼‰ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[PeriodSeconds(5)]`ï¼šç§’å‘¨æœŸï¼ˆé—´éš”ï¼‰ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[Cron("* * * * *", CronStringFormat.Default)]`ï¼šCron è¡¨è¾¾å¼ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[Secondly]`ï¼šæ¯ç§’å¼€å§‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[Minutely]`ï¼šæ¯åˆ†é’Ÿå¼€å§‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[Hourly]`ï¼šæ¯å°æ—¶å¼€å§‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[Daily]`ï¼šæ¯å¤©ï¼ˆåˆå¤œï¼‰å¼€å§‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[Monthly]`ï¼šæ¯æœˆ 1 å·ï¼ˆåˆå¤œï¼‰å¼€å§‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[Weekly]`ï¼šæ¯å‘¨æ—¥ï¼ˆåˆå¤œï¼‰å¼€å§‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§
- `[Yearly]`ï¼šæ¯å¹´ 1 æœˆ 1 å·ï¼ˆåˆå¤œï¼‰å¼€å§‹ä½œä¸šè§¦å‘å™¨ç‰¹æ€§

ä½¿ç”¨å¦‚ä¸‹ï¼š

```cs showLineNumbers {3,6}
services.AddSchedule(options =>
{
    options.AddJob(JobBuilder.Create<MyJob>().SetIncludeAnnotations(true));

    // ä¹Ÿæ”¯æŒè‡ªå®šä¹‰é…ç½® + ç‰¹æ€§æ‰«æ
    options.AddJob(JobBuilder.Create<MyJob>().SetIncludeAnnotations(true)
                  , Triggers.PeriodSeconds(5));
});
```

```cs showLineNumbers {1-3}
[Minutely]
[PeriodSeconds(5)]
[Cron("* * * * *")]
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation($"{context.JobId} {context.TriggerId} {context.OccurrenceTime} {context.Trigger}");
        await Task.CompletedTask;
    }
}
```

æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœï¼š

```bash showLineNumbers {2,4,6,8,10}
info: 2022-11-20 22:10:54.5027217 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #9
      job1 job1_trigger2 2022/11/20 22:10:54  5000ms
info: 2022-11-20 22:10:59.4948832 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #9
      job1 job1_trigger2 2022/11/20 22:10:59  5000ms
info: 2022-11-20 22:11:00.0353681 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #6
      job1 job1_trigger3 2022/11/20 22:11:00  * * * * *
info: 2022-11-20 22:11:00.0372492 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #8
      job1 job1_trigger1 2022/11/20 22:11:00  * * * * *
info: 2022-11-20 22:11:04.5094807 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #8
      job1 job1_trigger2 2022/11/20 22:11:04  5000ms
```

---

**é™¤äº†ä½¿ç”¨å†…ç½®ç‰¹æ€§ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰ä½œä¸šè§¦å‘å™¨ç‰¹æ€§**ï¼Œå¦‚ï¼š

```cs showLineNumbers {1,2,5}
[AttributeUsage(AttributeTargets.Class, AllowMultiple = true)]
public class SomeSecondAttribute : TriggerAttribute
{
    public SomeSecondAttribute(int seconds)
        : base(typeof(SomeSecondTrigger), seconds)
    {
    }
}
```

ä½¿ç”¨å¦‚ä¸‹ï¼š

```cs showLineNumbers {1}
[SomeSecond(3)]
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;
    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation($"{context.JobId} {context.TriggerId} {context.OccurrenceTime} {context.Trigger}");
        await Task.CompletedTask;
    }
}
```

æŸ¥çœ‹ä½œä¸šæ‰§è¡Œç»“æœï¼š

```bash showLineNumbers {2,4,6,8,10}
info: 2022-11-20 22:16:22.0933295 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #9
      job1 job1_trigger1 2022/11/20 22:16:22 è‡ªå®šä¹‰é€’å¢ 3s è§¦å‘å™¨
info: 2022-11-20 22:16:25.0823563 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #8
      job1 job1_trigger1 2022/11/20 22:16:25 è‡ªå®šä¹‰é€’å¢ 3s è§¦å‘å™¨
info: 2022-11-20 22:16:28.0910993 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #6
      job1 job1_trigger1 2022/11/20 22:16:28 è‡ªå®šä¹‰é€’å¢ 3s è§¦å‘å™¨
info: 2022-11-20 22:16:31.0937955 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #9
      job1 job1_trigger1 2022/11/20 22:16:31 è‡ªå®šä¹‰é€’å¢ 3s è§¦å‘å™¨
info: 2022-11-20 22:16:34.1034905 +08:00 æ˜ŸæœŸæ—¥ L ConsoleApp13.MyJob[0] #6
      job1 job1_trigger1 2022/11/20 22:16:34 è‡ªå®šä¹‰é€’å¢ 3s è§¦å‘å™¨
```

---

**ä½œä¸šè§¦å‘å™¨ç‰¹æ€§è¿˜æä¾›äº†å¤šä¸ªå±æ€§é…ç½®**ï¼Œå¦‚ï¼š

- `TriggerId`ï¼šä½œä¸šè§¦å‘å™¨ Idï¼Œ`string` ç±»å‹
- `Description`ï¼šæè¿°ä¿¡æ¯ï¼Œ`string` ç±»å‹
- `StartTime`ï¼šèµ·å§‹æ—¶é—´ï¼Œ`string` ç±»å‹
- `EndTime`ï¼šç»“æŸæ—¶é—´ï¼Œ`string` ç±»å‹
- `MaxNumberOfRuns`ï¼šæœ€å¤§è§¦å‘æ¬¡æ•°ï¼Œ`long` ç±»å‹ï¼Œ`0`ï¼šä¸é™åˆ¶ï¼›`n`ï¼šN æ¬¡
- `MaxNumberOfErrors`ï¼šæœ€å¤§å‡ºé”™æ¬¡æ•°ï¼Œ`long` ç±»å‹ï¼Œ`0`ï¼šä¸é™åˆ¶ï¼›`n`ï¼šN æ¬¡
- `NumRetries`ï¼šé‡è¯•æ¬¡æ•°ï¼Œ`int` ç±»å‹ï¼Œé»˜è®¤å€¼ `0`
- `RetryTimeout`ï¼šé‡è¯•é—´éš”æ—¶é—´ï¼Œ`int` ç±»å‹ï¼Œé»˜è®¤å€¼ `1000`
- `StartNow`ï¼šæ˜¯å¦ç«‹å³å¯åŠ¨ï¼Œ`bool` ç±»å‹ï¼Œé»˜è®¤å€¼ `true`
- `RunOnStart`ï¼šæ˜¯å¦å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œ`bool` ç±»å‹ï¼Œé»˜è®¤å€¼ `false`
- `ResetOnlyOnce`ï¼šæ˜¯å¦åœ¨å¯åŠ¨æ—¶é‡ç½®æœ€å¤§è§¦å‘æ¬¡æ•°ç­‰äºä¸€æ¬¡çš„ä½œä¸šï¼Œ`bool` ç±»å‹ï¼Œé»˜è®¤å€¼ `true`

ä½¿ç”¨å¦‚ä¸‹ï¼š

```cs showLineNumbers {1}
[PeriodSeconds(5, TriggerId = "trigger1", Description = "è¿™æ˜¯ä¸€æ®µæè¿°")]
public class MyJob : IJob
{
```

### 26.1.5.7 è®¾ç½®ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨

`TriggerBuilder` æä¾›äº†å’Œ `Trigger` å®Œå…¨åŒ¹é…çš„ `Set[å±æ€§å]` æ–¹æ³•æ¥é…ç½®ä½œä¸šè§¦å‘å™¨å„ä¸ªå±æ€§ï¼Œå¦‚ï¼š

```cs showLineNumbers {3,27}
 services.AddSchedule(options =>
 {
     var triggerBuilder = Triggers.Period(5000)
         .SetTriggerId("trigger1")   // ä½œä¸šè§¦å‘å™¨ Id
         .SetTriggerType("Furion", "Furion.Schedule.PeriodTrigger")  // ä½œä¸šè§¦å‘å™¨ç±»å‹ï¼Œæ”¯æŒå¤šä¸ªé‡è½½
         .SetTriggerType<PeriodTrigger>()    // ä½œä¸šè§¦å‘å™¨ç±»å‹ï¼Œæ”¯æŒå¤šä¸ªé‡è½½
         .SetTriggerType(typeof(PeriodTrigger))  // ä½œä¸šè§¦å‘å™¨ç±»å‹ï¼Œæ”¯æŒå¤šä¸ªé‡è½½
         .SetArgs("[5000]")  // ä½œä¸šè§¦å‘å™¨å‚æ•°ï¼Œæ”¯æŒå¤šä¸ªé‡è½½
         .SetArgs(5000)   // ä½œä¸šè§¦å‘å™¨å‚æ•°ï¼Œæ”¯æŒå¤šä¸ªé‡è½½
         .SetDescription("ä½œä¸šè§¦å‘å™¨æè¿°")  // ä½œä¸šè§¦å‘å™¨æè¿°
         .SetStatus(TriggerStatus.Ready) // ä½œä¸šè§¦å‘å™¨çŠ¶æ€
         .SetStartTime(DateTime.Now) // ä½œä¸šè§¦å‘å™¨èµ·å§‹æ—¶é—´
         .SetEndTime(DateTime.Now.AddMonths(1)) // ä½œä¸šè§¦å‘å™¨ç»“æŸæ—¶é—´
         .SetLastRunTime(DateTime.Now.AddSeconds(-5))    // ä½œä¸šè§¦å‘å™¨æœ€è¿‘è¿è¡Œæ—¶é—´
         .SetNextRunTime(DateTime.Now.AddSeconds(5)) // ä½œä¸šè§¦å‘å™¨ä¸‹ä¸€æ¬¡è¿è¡Œæ—¶é—´
         .SetNumberOfRuns(1) // ä½œä¸šè§¦å‘å™¨è§¦å‘æ¬¡æ•°
         .SetMaxNumberOfRuns(100)    // ä½œä¸šè§¦å‘å™¨æœ€å¤§è§¦å‘å™¨æ¬¡æ•°
         .SetNumberOfErrors(1)   // ä½œä¸šè§¦å‘å™¨å‡ºé”™æ¬¡æ•°
         .SetMaxNumberOfErrors(100)  // ä½œä¸šè§¦å‘å™¨æœ€å¤§å‡ºé”™æ¬¡æ•°
         .SetNumRetries(3)   // ä½œä¸šè§¦å‘å™¨å‡ºé”™é‡è¯•æ¬¡æ•°
         .SetRetryTimeout(1000)  // ä½œä¸šè§¦å‘å™¨é‡è¯•é—´éš”æ—¶é—´
         .SetStartNow(true)  // ä½œä¸šè§¦å‘å™¨æ˜¯å¦ç«‹å³å¯åŠ¨
         .SetRunOnStart(false)    // ä½œä¸šè§¦å‘å™¨æ˜¯å¦å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡
         .SetResetOnlyOnce(true)    // ä½œä¸šè§¦å‘å™¨æ˜¯å¦åœ¨å¯åŠ¨æ—¶é‡ç½®æœ€å¤§è§¦å‘æ¬¡æ•°ç­‰äºä¸€æ¬¡çš„ä½œä¸š
         ;

     options.AddJob<MyJob>(triggerBuilder);
 });
```

### 26.1.5.8 å¤šç§æ ¼å¼å­—ç¬¦ä¸²è¾“å‡º

`Trigger` å’Œ `TriggerBuilder` éƒ½æä¾›äº†å¤šç§å°†è‡ªèº«è½¬æ¢æˆç‰¹å®šæ ¼å¼çš„å­—ç¬¦ä¸²ã€‚

1. **è½¬æ¢æˆ `JSON` å­—ç¬¦ä¸²**

```cs showLineNumbers
var json = trigger.ConvertToJSON();
```

å­—ç¬¦ä¸²æ‰“å°å¦‚ä¸‹ï¼š

```json showLineNumbers
{
  "triggerId": "job1_trigger1",
  "jobId": "job1",
  "triggerType": "Furion.Schedule.PeriodSecondsTrigger",
  "assemblyName": "Furion",
  "args": "[5]",
  "description": null,
  "status": 2,
  "startTime": null,
  "endTime": null,
  "lastRunTime": "2022-11-20T22:25:03.8176033+08:00",
  "nextRunTime": "2022-11-20T22:25:08.8385903+08:00",
  "numberOfRuns": 1,
  "maxNumberOfRuns": 0,
  "numberOfErrors": 0,
  "maxNumberOfErrors": 0,
  "numRetries": 0,
  "retryTimeout": 1000,
  "startNow": true,
  "runOnStart": false,
  "resetOnlyOnce": true,
  "updatedTime": "2022-11-20T22:25:03.8386511+08:00"
}
```

2. **è½¬æ¢æˆ `SQL` å­—ç¬¦ä¸²**

```cs showLineNumbers {2,6,9,13,16,20}
// è¾“å‡ºæ–°å¢ SQLï¼Œä½¿ç”¨ CamelCase å±æ€§å‘½å
var insertSql = trigger.ConvertToSQL("tbName"
      , PersistenceBehavior.Appended
      , NamingConventions.CamelCase);
// æ›´ä¾¿æ·æ‹“å±•
var insertSql = trigger.ConvertToInsertSQL("tbName", NamingConventions.CamelCase);

// è¾“å‡ºåˆ é™¤ SQLï¼Œä½¿ç”¨ Pascal å±æ€§å‘½å
var deleteSql = trigger.ConvertToSQL("tbName"
      , PersistenceBehavior.Removed
      , NamingConventions.Pascal);
// æ›´ä¾¿æ·æ‹“å±•
var deleteSql = trigger.ConvertToDeleteSQL("tbName", NamingConventions.Pascal);

// è¾“å‡ºæ›´æ–° SQLï¼Œä½¿ç”¨ UnderScoreCase å±æ€§å‘½å
var updateSql = trigger.ConvertToSQL("tbName"
      , PersistenceBehavior.Updated
      , NamingConventions.UnderScoreCase);
// æ›´ä¾¿æ·æ‹“å±•
var updateSql = trigger.ConvertToUpdateSQL("tbName", NamingConventions.UnderScoreCase);
```

å­—ç¬¦ä¸²æ‰“å°å¦‚ä¸‹ï¼š

```sql showLineNumbers {2,50,54}
-- æ–°å¢è¯­å¥
INSERT INTO tbName(
      [triggerId],
      [jobId],
      [triggerType],
      [assemblyName],
      [args],
      [description],
      [status],
      [startTime],
      [endTime],
      [lastRunTime],
      [nextRunTime],
      [numberOfRuns],
      [maxNumberOfRuns],
      [numberOfErrors],
      [maxNumberOfErrors],
      [numRetries],
      [retryTimeout],
      [startNow],
      [runOnStart],
      [resetOnlyOnce],
      [updatedTime]
)
VALUES(
      'job1_trigger1',
      'job1',
      'Furion.Schedule.PeriodSecondsTrigger',
      'Furion',
      '[5]',
      NULL,
      2,
      NULL,
      NULL,
      '2022/11/20 22:27:47',
      '2022/11/20 22:27:52',
      1,
      0,
      0,
      0,
      0,
      1000,
      1,
      0,
      1,
      '2022/11/20 22:27:47'
);

-- åˆ é™¤è¯­å¥
DELETE FROM tbName
WHERE [TriggerId] = 'job1_trigger1' AND [JobId] = 'job1';

-- æ›´æ–°è¯­å¥
UPDATE tbName
SET
      [trigger_id] = 'job1_trigger1',
      [job_id] = 'job1',
      [trigger_type] = 'Furion.Schedule.PeriodSecondsTrigger',
      [assembly_name] = 'Furion',
      [args] = '[5]',
      [description] = NULL,
      [status] = 2,
      [start_time] = NULL,
      [end_time] = NULL,
      [last_run_time] = '2022/11/20 22:27:47',
      [next_run_time] = '2022/11/20 22:27:52',
      [number_of_runs] = 1,
      [max_number_of_runs] = 0,
      [number_of_errors] = 0,
      [max_number_of_errors] = 0,
      [num_retries] = 0,
      [retry_timeout] = 1000,
      [start_now] = 1,
      [run_on_start] = 0,
      [reset_only_once] = 1,
      [updated_time] = '2022/11/20 22:27:47'
WHERE [trigger_id] = 'job1_trigger1' AND [job_id] = 'job1';
```

3. **è½¬æ¢æˆ `Monitor` å­—ç¬¦ä¸²**

```cs showLineNumbers
var monitor = trigger.ConvertToMonitor();
```

å­—ç¬¦ä¸²æ‰“å°å¦‚ä¸‹ï¼š

```bash showLineNumbers
â”â”â”â”â”â”â”â”â”â”â”â”  Trigger â”â”â”â”â”â”â”â”â”â”â”
â”£ Furion.Schedule.PeriodSecondsTrigger
â”£
â”£ triggerIdï¼š                job1_trigger1
â”£ jobIdï¼š                    job1
â”£ triggerTypeï¼š              Furion.Schedule.PeriodSecondsTrigger
â”£ assemblyNameï¼š             Furion
â”£ argsï¼š                     [5]
â”£ descriptionï¼š
â”£ statusï¼š                   Running
â”£ startTimeï¼š
â”£ endTimeï¼š
â”£ lastRunTimeï¼š              2022/11/20 22:30:41
â”£ nextRunTimeï¼š              2022/11/20 22:30:46
â”£ numberOfRunsï¼š             1
â”£ maxNumberOfRunsï¼š          0
â”£ numberOfErrorsï¼š           0
â”£ maxNumberOfErrorsï¼š        0
â”£ numRetriesï¼š               0
â”£ retryTimeoutï¼š             1000
â”£ startNowï¼š                 True
â”£ runOnStartï¼š               False
â”£ resetOnlyOnceï¼š            True
â”£ updatedTimeï¼š              2022/11/20 22:30:41
â”—â”â”â”â”â”â”â”â”â”â”â”  Trigger â”â”â”â”â”â”â”â”â”â”â”
```

4. **ç®€è¦å­—ç¬¦ä¸²è¾“å‡º**

```cs showLineNumbers
var str = trigger.ToString();
```

```bash showLineNumbers
<job3 job3_trigger1> è¿™æ˜¯ä¸€æ®µæè¿°
<job2 job2_trigger1> è¿™æ˜¯ä¸€æ®µæè¿° * * * * * *
<job1 job1_trigger1> è¿™æ˜¯ä¸€æ®µæè¿° 5000ms
```

## 26.1.6 ä½œä¸šè®¡åˆ’ `Scheduler` åŠæ„å»ºå™¨

### 26.1.6.1 å…³äºä½œä¸šè®¡åˆ’

æ‰€è°“çš„ä½œä¸šè®¡åˆ’ï¼ˆ`Scheduler`ï¼‰æ˜¯å°†ä½œä¸šä¿¡æ¯(`JobDetail`ï¼‰ï¼Œä½œä¸šè§¦å‘å™¨ï¼ˆ`Trigger`ï¼‰å’Œä½œä¸šå¤„ç†ç¨‹åºï¼ˆ`IJob`ï¼‰å…³è”èµ·æ¥ï¼Œå¹¶æ·»åŠ åˆ°ä½œä¸šè°ƒåº¦å™¨ä¸­ç­‰å¾…è°ƒåº¦æ‰§è¡Œã€‚

ä½œä¸ºè®¡åˆ’ï¼ˆ`Scheduler`ï¼‰ç±»å‹å¯¹å¤–æ˜¯ä¸å…¬å¼€çš„ï¼Œä½†æä¾›äº†å¯¹åº”çš„ `IScheduler` æ¥å£è¿›è¡Œæ“ä½œã€‚

### 26.1.6.2 å…³äºä½œä¸šè®¡åˆ’æ„å»ºå™¨

ä½œä¸šè®¡åˆ’ `Scheduler` æ˜¯ä½œä¸šè°ƒåº¦æ¨¡å—æä¾›è¿è¡Œæ—¶çš„**åªè¯»ç±»å‹**ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•åˆ›å»ºæˆ–å˜æ›´ `Scheduler` å¯¹è±¡å‘¢ï¼Ÿ

`SchedulerBuilder` æ˜¯ä½œä¸šè°ƒåº¦æ¨¡å—æä¾›å¯ç”¨æ¥ç”Ÿæˆè¿è¡Œæ—¶ `Scheduler` çš„ç±»å‹ï¼Œè¿™æ ·åšçš„å¥½å¤„å¯é¿å…å¤–éƒ¨ç›´æ¥ä¿®æ”¹è¿è¡Œæ—¶ `Scheduler` æ•°æ®ï¼Œè¿˜èƒ½å®ç°ä»»ä½•ä¿®æ”¹åŠ¨ä½œç›‘å¬ï¼Œä¹Ÿèƒ½é¿å…å¤šçº¿ç¨‹æŠ¢å æƒ…å†µã€‚

ä½œä¸šè°ƒåº¦æ¨¡å—æä¾›äº†å¤šç§æ–¹å¼ç”¨æ¥åˆ›å»º `SchedulerBuilder` å¯¹è±¡ã€‚

1. **é€šè¿‡ `Create` é™æ€æ–¹æ³•åˆ›å»º**

```cs showLineNumbers {2,9}
// åˆ›å»ºä½œä¸šè®¡åˆ’å¿…é¡»ä¼ å…¥ JoBuilder å’Œ 0æˆ–1ä¸ªä»¥ä¸Šçš„ TiggerBuilder
var schedulerBuilder = SchedulerBuilder.Create(
            JobBuilder.Create<MyJob>()
            , Triggers.PeriodSeconds(5), Triggers.Minutely());

// æ·»åŠ åˆ°ä½œä¸šè°ƒåº¦å™¨ä¸­
services.AddSchedule(options =>
{
      options.AddJob(schedulerBuilder);
});
```

2. **é€šè¿‡ `JSON` å­—ç¬¦ä¸²åˆ›å»º**

è¯¥æ–¹å¼éå¸¸çµæ´»ï¼Œå¯ä»é…ç½®æ–‡ä»¶ï¼Œ`JSON` å­—ç¬¦ä¸²ï¼Œæˆ–å…¶ä»–èƒ½å¤Ÿè¿”å› `JSON` å­—ç¬¦ä¸²çš„åœ°æ–¹åˆ›å»ºã€‚

```cs showLineNumbers {1,3,14,42}
var schedulerBuilder = SchedulerBuilder.From(@"
{
    ""jobDetail"": {
        ""jobId"": ""job1"",
        ""groupName"": null,
        ""jobType"": ""ConsoleApp32.MyJob"",
        ""assemblyName"": ""ConsoleApp32"",
        ""description"": null,
        ""concurrent"": true,
        ""includeAnnotations"": false,
        ""properties"": ""{}"",
        ""updatedTime"": ""2022-11-17T09:25:47.0471107+08:00""
    },
    ""triggers"": [
        {
            ""triggerId"": ""job1_trigger1"",
            ""triggerType"": ""Furion.Schedule.PeriodSecondsTrigger"",
            ""assemblyName"": ""Furion"",
            ""args"": ""[5]"",
            ""description"": null,
            ""status"": 2,
            ""startTime"": null,
            ""endTime"": null,
            ""lastRunTime"": ""2022-11-20T18:31:56.6859410+08:00"",
            ""nextRunTime"": ""2022-11-20T18:32:01.7233546+08:00"",
            ""numberOfRuns"": 1,
            ""maxNumberOfRuns"": 0,
            ""numberOfErrors"": 0,
            ""maxNumberOfErrors"": 0,
            ""numRetries"": 0,
            ""retryTimeout"": 1000,
            ""startNow"": true,
            ""runOnStart"": false,
            ""resetOnlyOnce"": true,
            ""updatedTime"": ""2022-11-20T18:31:56.7233630+08:00""
        }
    ]
}");

// æ·»åŠ åˆ°ä½œä¸šè°ƒåº¦å™¨ä¸­
services.AddSchedule(options =>
{
      options.AddJob(schedulerBuilder);
});
```

å¦‚æœä½¿ç”¨çš„æ˜¯ `.NET7`ï¼Œå¯ä½¿ç”¨ `"""` é¿å…è½¬ä¹‰ï¼Œå¦‚ï¼š

```cs showLineNumbers {1,3,14}
var schedulerBuilder = SchedulerBuilder.From("""
{
    "jobDetail": {
        "jobId": "job1",
        "groupName": null,
        "jobType": "Furion.Application.MyJob",
        "assemblyName": "Furion.Application",
        "description": null,
        "concurrent": true,
        "includeAnnotations": false,
        "properties": "{}",
        "updatedTime": "2022-11-17T09:25:47.0471107+08:00"
    },
    "triggers": [
        {
            "triggerId": "job1_trigger1",
            "triggerType": "Furion.Schedule.PeriodSecondsTrigger",
            "assemblyName": "Furion",
            "args": "[5]",
            "description": null,
            "status": 2,
            "startTime": null,
            "endTime": null,
            "lastRunTime": "2022-11-20T18:31:56.6859410+08:00",
            "nextRunTime": "2022-11-20T18:32:01.7233546+08:00",
            "numberOfRuns": 1,
            "maxNumberOfRuns": 0,
            "numberOfErrors": 0,
            "maxNumberOfErrors": 0,
            "numRetries": 0,
            "retryTimeout": 1000,
            "startNow": true,
            "runOnStart": false,
            "resetOnlyOnce": true,
            "updatedTime": "2022-11-20T18:31:56.7233630+08:00"
        }
    ]
}
""");
```

:::important å…³äºå±æ€§ååŒ¹é…è§„åˆ™

æ”¯æŒ `CamelCaseï¼ˆé©¼å³°å‘½åæ³•ï¼‰`ï¼Œ`Pascalï¼ˆå¸•æ–¯å¡å‘½åæ³•ï¼‰` å‘½åæ–¹å¼ã€‚

**ä¸æ”¯æŒ `UnderScoreCaseï¼ˆä¸‹åˆ’çº¿å‘½åæ³•ï¼‰`** ï¼Œå¦‚ `"include_annotations": true`

:::

3. **è¿˜å¯ä»¥é€šè¿‡ `Clone` é™æ€æ–¹æ³•ä»ä¸€ä¸ª `SchedulerBuilder` åˆ›å»º**

```cs showLineNumbers
var schedulerBuilder = SchedulerBuilder.Clone(fromSchedulerBuilder);
```

:::important å…‹éš†è¯´æ˜

å…‹éš†æ“ä½œå°†å…‹éš† `JobBuilder` å’Œ `TriggerBuilders`ï¼ŒåŒæ—¶ `Behavior` ä¼šè¢«æ ‡è®°ä¸º `PersistenceBehavior.Appended`ã€‚

:::

### 26.1.6.3 è®¾ç½®ä½œä¸šè®¡åˆ’æ„å»ºå™¨

`Scheduler` æä¾›äº†å¤šä¸ªæ–¹æ³•æ“ä½œ `JobBuilder` å’Œ `TriggerBuilder`ï¼Œå¦‚ï¼š

```cs showLineNumbers {2,5,8,11,14,16-17,20,22-23,26,28,30-33,36}
// è·å–å½“å‰çš„ä½œä¸šä¿¡æ¯æ„å»ºå™¨
var jobBuilder = schedulerBuilder.GetJobBuilder();

// æ›´æ–°å½“å‰ä½œä¸šä¿¡æ¯æ„å»ºå™¨
schedulerBuilder.UpdateJobBuilder(jobBuilder.SetDescription("æ–°çš„æè¿°"));

// è·å–æ‰€æœ‰çš„ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨é›†åˆ
var triggerBuilders = schedulerBuilder.GetTriggerBuilders();

// è·å–å•ä¸ªä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
var triggerBuilder = schedulerBuilder.GetTriggerBuilder("job1_trigger1");

// æ–°å¢ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
schedulerBuilder.AddTriggerBuilder(Triggers.Minutely());
// ä¹Ÿæ”¯æŒé“¾å¼æ·»åŠ æˆ–æ·»åŠ å¤šä¸ª
schedulerBuilder.AddTriggerBuilder(Triggers.Minutely()).AddTriggerBuilder(Trigger.Hourly());
schedulerBuilder.AddTriggerBuilders(Trigger.Minutely(), Trigger.Hourly());

// æ›´æ–°ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
schedulerBuilder.UpdateTriggerBuilder(triggerBuilder.SetDescription("æ–°çš„è§¦å‘å™¨æè¿°"));
// ä¹Ÿæ”¯æŒé“¾å¼æ›´æ–°æˆ–æ›´æ–°å¤šä¸ª
schedulerBuilder.UpdateTriggerBuilder(triggerBuilder1).UpdateTriggerBuilder(triggerBuilder2);
schedulerBuilder.UpdateTriggerBuilders(triggerBuilder1, triggerBuilder2);

// åˆ é™¤ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
schedulerBuilder.RemoveTriggerBuilder(triggerBuilder);
// å¯ä»¥æ ¹æ®ä½œä¸šè§¦å‘å™¨ Id åˆ é™¤
schedulerBuilder.RemoveTriggerBuilder("job1_trigger1", out var builder);
// ä¹Ÿæ”¯æŒé“¾å¼åˆ é™¤æˆ–åˆ é™¤å¤šä¸ª
schedulerBuilder.RemoveTriggerBuilder(triggerBuilder1).RemoveTriggerBuilder(triggerBuilder2);
schedulerBuilder.RemoveTriggerBuilders(triggerBuilder1, triggerBuilder2);
schedulerBuilder.RemoveTriggerBuilder("job1_trigger1", out var triggerBuilder).RemoveTriggerBuilder("job1_trigger2", out _);
schedulerBuilder.RemoveTriggerBuilder("job1_trigger1", "job1_trigger2");

// æ¸…ç©ºæ‰€æœ‰ä½œä¸šè§¦å‘å™¨æ„å»ºå™¨
schedulerBuilder.ClearTriggerBuilders();
```

é™¤äº†æä¾›ä¸Šé¢çš„ `CURD` æ“ä½œä»¥å¤–ï¼Œè¿˜æä¾›äº†å¯ä»¥æ›´æ”¹ `SchedulerBuilder` çš„**æŒä¹…åŒ–è¡Œä¸º**çš„æ–¹æ³•ï¼Œå¦‚ï¼š

```cs showLineNumbers
// æ ‡è®°å½“å‰ä½œä¸šè®¡åˆ’æ„å»ºå™¨ä¸ºæ–°å¢çŠ¶æ€
schedulerBuilder.Appended();  // é»˜è®¤å€¼
// æ ‡è®°å½“å‰ä½œä¸šè®¡åˆ’æ„å»ºå™¨ä¸ºæ›´æ–°çŠ¶æ€
schedulerBuilder.Updated();
// æ ‡è®°å½“å‰ä½œä¸šè®¡åˆ’æ„å»ºå™¨ä¸ºåˆ é™¤çŠ¶æ€
schedulerBuilder.Removed();
```

### 26.1.6.4 å¤šç§æ ¼å¼å­—ç¬¦ä¸²è¾“å‡º

`Scheduler` å’Œ `SchedulerBuilder` éƒ½æä¾›äº†å¤šç§å°†è‡ªèº«è½¬æ¢æˆç‰¹å®šæ ¼å¼çš„å­—ç¬¦ä¸²ã€‚

1. **è½¬æ¢æˆ `JSON` å­—ç¬¦ä¸²**

```cs showLineNumbers
var json = schedulerBuilder.ConvertToJSON();
```

å­—ç¬¦ä¸²æ‰“å°å¦‚ä¸‹ï¼š

```json showLineNumbers {2,13}
{
  "jobDetail": {
    "jobId": "job1",
    "groupName": null,
    "jobType": "Furion.Application.MyJob",
    "assemblyName": "Furion.Application",
    "description": null,
    "concurrent": true,
    "includeAnnotations": false,
    "properties": "{}",
    "updatedTime": "2022-11-17T09:25:47.0471107+08:00"
  },
  "triggers": [
    {
      "triggerId": "job1_trigger1",
      "jobId": null,
      "triggerType": "Furion.Schedule.PeriodSecondsTrigger",
      "assemblyName": "Furion",
      "args": "[5]",
      "description": null,
      "status": 2,
      "startTime": null,
      "endTime": null,
      "lastRunTime": "2022-11-20T18:31:56.6859410+08:00",
      "nextRunTime": "2022-11-20T18:32:01.7233546+08:00",
      "numberOfRuns": 1,
      "maxNumberOfRuns": 0,
      "numberOfErrors": 0,
      "maxNumberOfErrors": 0,
      "numRetries": 0,
      "retryTimeout": 1000,
      "startNow": true,
      "runOnStart": false,
      "resetOnlyOnce": true,
      "updatedTime": "2022-11-20T18:31:56.7233630+08:00"
    }
  ]
}
```

## 26.1.7 ä½œä¸šè°ƒåº¦å™¨ `ScheduleOptionsBuilder` é…ç½®é€‰é¡¹

### 26.1.7.1 å…³äº `ScheduleOptionsBuilder`

`ScheduleOptionsBuilder` é…ç½®é€‰é¡¹ä¸»è¦æ˜¯ç”¨æ¥åˆå§‹åŒ–è°ƒåº¦ä½œä¸šæœåŠ¡å’Œä½œä¸šè°ƒåº¦å™¨ç›¸å…³é…ç½®çš„ã€‚åªä½œä¸º `services.AddSchedule` æœåŠ¡æ³¨å†Œçš„é…ç½®å‚æ•°ï¼Œå¦‚ï¼š

```cs showLineNumbers {2,8-9}
// é€šè¿‡å§”æ‰˜çš„æ–¹å¼é…ç½®
services.AddSchedule(options =>
{
      // options ç±»å‹ä¸º ScheduleOptionsBuilder
});

// è‡ªè¡Œåˆ›å»ºå¯¹è±¡å®ä¾‹æ–¹å¼é…ç½®
var scheduleOptionsBuilder = new ScheduleOptionsBuilder();
services.AddSchedule(scheduleOptionsBuilder);
```

### 26.1.7.2 `ScheduleOptionsBuilder` å†…ç½®å±æ€§å’Œæ–¹æ³•

- **å†…ç½®å±æ€§é…ç½®**

```cs showLineNumbers {4,7,10}
services.AddSchedule(options =>
{
      // æ˜¯å¦ä½¿ç”¨ UTC æ—¶é—´ï¼Œè¯¥é…ç½®ä¸»è¦ç”¨æ¥ä½œä¸ºä½œä¸šè°ƒåº¦å™¨æ£€æŸ¥æ—¶é—´æ ¼å¼çš„ä¾æ®
      options.UseUtcTimestamp = false;

      // æ˜¯å¦è¾“å‡ºä½œä¸šè°ƒåº¦å™¨æ—¥å¿—
      options.LogEnabled = true;

      // å®šä¹‰æœªæ•è·çš„å¼‚å¸¸ï¼Œé€šå¸¸æ˜¯ Task å¼‚å¸¸
      options.UnobservedTaskExceptionHandler = (obj, args) =>
      {
      };
});
```

- **å†…ç½®æ–¹æ³•é…ç½®**

```cs showLineNumbers {4-9,12,15,18}
services.AddSchedule(options =>
{
      // æ·»åŠ ä½œä¸š
      options.AddJob(schedulerBuilder);
      options.AddJob(jobBuilder, triggerBuilder, ...);
      options.AddJob<MyJob>(triggerBuilder, ...);
      options.AddJob<MyJob>("ä½œä¸š Id", triggerBuilder, ...);
      options.AddJob<MyJob>("ä½œä¸š Id", concurrent: true, triggerBuilder, ...);
      options.AddJob<MyJob>(concurrent: true, triggerBuilder, ...);

      // æ·»åŠ ä½œä¸šæ‰§è¡Œç›‘è§†å™¨
      options.AddMonitor<YourJobMonitor>();

      // æ·»åŠ ä½œä¸šæ‰§è¡Œå™¨
      options.AddExecutor<YourJobMonitor>();

      // æ·»åŠ ä½œä¸šæŒä¹…åŒ–å™¨
      options.AddPersistence<YourJobPersistence>();
});
```

## 26.1.8 ä½œä¸šç›‘è§†å™¨ `IJobMonitor`

è°ƒåº¦ä½œä¸šæœåŠ¡æä¾›äº† `IJobMonitor` ç›‘è§†å™¨æ¥å£ï¼Œå®ç°è¯¥æ¥å£å¯ä»¥ç›‘è§†æ‰€æœ‰ä½œä¸šå¤„ç†ç¨‹åºæ‰§è¡Œäº‹ä»¶ï¼ŒåŒ…æ‹¬ `æ‰§è¡Œä¹‹å‰ã€æ‰§è¡Œä¹‹åï¼Œæ‰§è¡Œå¼‚å¸¸`ã€‚

å¦‚æ·»åŠ  `YourJobMonitor`ï¼š

```cs showLineNumbers  {1,9,15}
public class YourJobMonitor : IJobMonitor
{
    private readonly ILogger<YourJobMonitor> _logger;
    public YourJobMonitor(ILogger<YourJobMonitor> logger)
    {
        _logger = logger;
    }

    public Task OnExecutingAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation("æ‰§è¡Œä¹‹å‰ï¼š{JobId} {TriggerId}", context.JobId, context.TriggerId);
        return Task.CompletedTask;
    }

    public Task OnExecutedAsync(JobExecutedContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation("æ‰§è¡Œä¹‹åï¼š{JobId} {TriggerId}", context.JobId, context.TriggerId);

        if (context.Exception != null)
        {
            _logger.LogError(context.Exception, "æ‰§è¡Œå‡ºé”™å•¦ï¼š{JobId} {TriggerId}", context.JobId, context.TriggerId);
        }

        return Task.CompletedTask;
    }
}
```

æœ€åï¼Œåœ¨æ³¨å†Œ `Schedule` æœåŠ¡ä¸­æ³¨å†Œ `YourJobMonitor`ï¼š

```cs showLineNumbers  {4}
services.AddSchedule(options =>
{
    // æ·»åŠ ä½œä¸šæ‰§è¡Œç›‘è§†å™¨
    options.AddMonitor<YourJobMonitor>();
});
```

æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š

```bash showLineNumbers {2,6}
info: 2022-11-21 13:41:49.2144716 +08:00 æ˜ŸæœŸä¸€ L ConsoleApp32.YourJobMonitor[0] #9
      æ‰§è¡Œä¹‹å‰ï¼šjob1 job1_trigger1
info: 2022-11-21 13:41:49.2216598 +08:00 æ˜ŸæœŸä¸€ L ConsoleApp32.MyJob[0] #9
      job1 job1_trigger1 2022/11/21 13:41:49  5000ms
info: 2022-11-21 13:41:49.2249096 +08:00 æ˜ŸæœŸä¸€ L ConsoleApp32.YourJobMonitor[0] #9
      æ‰§è¡Œä¹‹åï¼šjob1 job1_trigger1
```

### 26.1.8.1 å…³äºå‚æ•° `JobExecutionContext`

`IJobMonitor` æä¾›çš„ `OnExecutingAsync` å’Œ `OnExecutedAsync` æ¥å£æ–¹æ³•éƒ½åŒ…å«ä¸€ä¸ª `context` å‚æ•°ï¼Œå‰è€…æ˜¯ `JobExecutingContext`ï¼Œåè€…æ˜¯ `JobExecutedContext`ï¼Œå®ƒä»¬éƒ½æœ‰ä¸€ä¸ªå…±åŒçš„åŸºç±» `JobExecutionContext`ã€‚

`JobExecutionContext` æä¾›äº†ä»¥ä¸‹å…¬å…±å±æ€§å’Œå…¬å…±æ–¹æ³•:

- **`JobExecutionContext` å±æ€§åˆ—è¡¨**
  - `JobId`ï¼šä½œä¸š `Id`
  - `TriggerId`ï¼šå½“å‰è§¦å‘å™¨ `Id`
  - `JobDetail`ï¼šä½œä¸šä¿¡æ¯
  - `Trigger`ï¼šä½œä¸šè§¦å‘å™¨
  - `OccurrenceTime`ï¼šè°ƒåº¦å™¨æ£€æŸ¥æ—¶é—´ï¼Œæœ€å‡†ç¡®çš„è®°å½•æ—¶é—´
- **`JobExecutionContext` æ–¹æ³•åˆ—è¡¨**
  - `.ConvertToJSON(naming)`ï¼šå°†ä½œä¸šè®¡åˆ’è½¬æ¢æˆ `JSON` å­—ç¬¦ä¸²

<p></p>

- **`JobExecutingContext`** åœ¨åŸºç±»åŸºç¡€ä¸Šæ‹“å±•äº† `ExecutingTime` å±æ€§ï¼š
  - `ExecutingTime`ï¼šæ‰§è¡Œå‰æ—¶é—´
- **`JobExecutedContext`** åˆ™åœ¨åŸºç±»åŸºç¡€ä¸Šæ‹“å±•äº† `ExecutedTime` å’Œ `Exception` å±æ€§ï¼š
  - `ExecutedTime`ï¼šæ‰§è¡Œåæ—¶é—´
  - `Exception`ï¼šæ‰§è¡Œå¼‚å¸¸

## 26.1.9 ä½œä¸šæ‰§è¡Œå™¨ `IJobExecutor`

è°ƒåº¦ä½œä¸šæœåŠ¡æä¾›äº† `IJobExecutor` æ‰§è¡Œå™¨æ¥å£ï¼Œå¯ä»¥è®©å¼€å‘è€…è‡ªå®šä¹‰ä½œä¸šå¤„ç†å‡½æ•°æ‰§è¡Œç­–ç•¥ï¼Œå¦‚ `è¶…æ—¶æ§åˆ¶ï¼Œå¤±è´¥é‡è¯•ã€ç†”æ–­ç­‰ç­‰`ã€‚

å¦‚æ·»åŠ  `YourJobExecutor`ï¼š

```cs showLineNumbers  {1,3,6-9}
public class YourJobExecutor : IJobExecutor
{
    public async Task ExecuteAsync(JobExecutingContext context, IJob jobHandler, CancellationToken stoppingToken)
    {
        // å®ç°å¤±è´¥é‡è¯•ç­–ç•¥ï¼Œå¦‚å¤±è´¥é‡è¯• 3 æ¬¡
        await Retry.InvokeAsync(async () =>
        {
            await jobHandler.ExecuteAsync(context, stoppingToken);
        }, 3, 1000);
    }
}
```

æ¥ç€æ¨¡æ‹Ÿ `MyJob` æ‰§è¡Œå‡ºé”™ï¼š

```cs showLineNumbers {1,14}
public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;

    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation($"{context.JobId} {context.TriggerId} {context.OccurrenceTime} {context.Trigger}");

        throw new Exception("æ¨¡æ‹Ÿå‡ºé”™");

        await Task.CompletedTask;
    }
}
```

æœ€åï¼Œåœ¨æ³¨å†Œ `Schedule` æœåŠ¡ä¸­æ³¨å†Œ `YourJobExecutor`ï¼š

```cs showLineNumbers  {5}
services.AddSchedule(options =>
{
      options.AddMonitor<YourJobMonitor>();
      // æ·»åŠ ä½œä¸šæ‰§è¡Œå™¨
      options.AddExecutor<YourJobExecutor>();
      options.AddJob<MyJob>(Triggers.PeriodSeconds(10));
});
```

æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š

```bash showLineNumbers {2,5-10,24,26}
info: 2022-11-21 14:10:33.3382344 +08:00 æ˜ŸæœŸä¸€ L ConsoleApp32.YourJobMonitor[0] #14
      æ‰§è¡Œä¹‹å‰ï¼šjob1 job1_trigger1
info: 2022-11-21 14:10:33.3447855 +08:00 æ˜ŸæœŸä¸€ L ConsoleApp32.MyJob[0] #14
      job1 job1_trigger1 2022/11/21 14:10:33  10000ms
info: 2022-11-21 14:10:34.4217342 +08:00 æ˜ŸæœŸä¸€ L ConsoleApp32.MyJob[0] #14
      job1 job1_trigger1 2022/11/21 14:10:33  10000ms
info: 2022-11-21 14:10:35.4952165 +08:00 æ˜ŸæœŸä¸€ L ConsoleApp32.MyJob[0] #14
      job1 job1_trigger1 2022/11/21 14:10:33  10000ms
info: 2022-11-21 14:10:36.5719440 +08:00 æ˜ŸæœŸä¸€ L ConsoleApp32.MyJob[0] #14
      job1 job1_trigger1 2022/11/21 14:10:33  10000ms
fail: 2022-11-21 14:10:36.7388113 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #14
      Error occurred executing job1 job1_trigger1< 10000ms>.
      ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
      System.Exception: æ¨¡æ‹Ÿå‡ºé”™
         at ConsoleApp32.MyJob.ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken) in D:\Workplaces\Study\CSharp\ConsoleApp32\ConsoleApp32\MyJob.cs:line 19
         at ConsoleApp32.YourJobExecutor.<>c__DisplayClass0_0.<<ExecuteAsync>b__0>d.MoveNext() in D:\Workplaces\Study\CSharp\ConsoleApp32\ConsoleApp32\YourJobExecutor.cs:line 18
      --- End of stack trace from previous location ---
         at Furion.FriendlyException.Retry.InvokeAsync(Func`1 action, Int32 numRetries, Int32 retryTimeout, Boolean finalThrow, Type[] exceptionTypes, Func`2 fallbackPolicy) in D:\Workplaces\OpenSources\Furion\framework\Furion\FriendlyException\Retry.cs:line 84
         at Furion.FriendlyException.Retry.InvokeAsync(Func`1 action, Int32 numRetries, Int32 retryTimeout, Boolean finalThrow, Type[] exceptionTypes, Func`2 fallbackPolicy) in D:\Workplaces\OpenSources\Furion\framework\Furion\FriendlyException\Retry.cs:line 95
         at ConsoleApp32.YourJobExecutor.ExecuteAsync(JobExecutingContext context, IJob jobHandler, CancellationToken stoppingToken) in D:\Workplaces\Study\CSharp\ConsoleApp32\ConsoleApp32\YourJobExecutor.cs:line 16
         at Furion.Schedule.ScheduleHostedService.<>c__DisplayClass16_2.<<BackgroundProcessing>b__1>d.MoveNext() in D:\Workplaces\OpenSources\Furion\framework\Furion\Schedule\HostedServices\ScheduleHostedService.cs:line 188
      ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
info: 2022-11-21 14:10:36.7413303 +08:00 æ˜ŸæœŸä¸€ L ConsoleApp32.YourJobMonitor[0] #14
      æ‰§è¡Œä¹‹åï¼šjob1 job1_trigger1
fail: 2022-11-21 14:10:36.7446968 +08:00 æ˜ŸæœŸä¸€ L ConsoleApp32.YourJobMonitor[0] #14
      æ‰§è¡Œå‡ºé”™å•¦ï¼šjob1 job1_trigger1
      ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
      System.InvalidOperationException: Error occurred executing job1 job1_trigger1< 10000ms>.
       ---> System.Exception: æ¨¡æ‹Ÿå‡ºé”™
         at ConsoleApp32.MyJob.ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken) in D:\Workplaces\Study\CSharp\ConsoleApp32\ConsoleApp32\MyJob.cs:line 19
         at ConsoleApp32.YourJobExecutor.<>c__DisplayClass0_0.<<ExecuteAsync>b__0>d.MoveNext() in D:\Workplaces\Study\CSharp\ConsoleApp32\ConsoleApp32\YourJobExecutor.cs:line 18
      --- End of stack trace from previous location ---
         at Furion.FriendlyException.Retry.InvokeAsync(Func`1 action, Int32 numRetries, Int32 retryTimeout, Boolean finalThrow, Type[] exceptionTypes, Func`2 fallbackPolicy) in D:\Workplaces\OpenSources\Furion\framework\Furion\FriendlyException\Retry.cs:line 84
         at Furion.FriendlyException.Retry.InvokeAsync(Func`1 action, Int32 numRetries, Int32 retryTimeout, Boolean finalThrow, Type[] exceptionTypes, Func`2 fallbackPolicy) in D:\Workplaces\OpenSources\Furion\framework\Furion\FriendlyException\Retry.cs:line 95
         at ConsoleApp32.YourJobExecutor.ExecuteAsync(JobExecutingContext context, IJob jobHandler, CancellationToken stoppingToken) in D:\Workplaces\Study\CSharp\ConsoleApp32\ConsoleApp32\YourJobExecutor.cs:line 16
         at Furion.Schedule.ScheduleHostedService.<>c__DisplayClass16_2.<<BackgroundProcessing>b__1>d.MoveNext() in D:\Workplaces\OpenSources\Furion\framework\Furion\Schedule\HostedServices\ScheduleHostedService.cs:line 188
         --- End of inner exception stack trace ---
      ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
```

## 26.1.10 ä½œä¸šè®¡åˆ’å·¥å‚ `ISchedulerFactory`

ä½œä¸šè®¡åˆ’å·¥å‚æä¾›äº†ç¨‹åºè¿è¡Œæ—¶æ“ä½œä½œä¸šè°ƒåº¦å™¨ï¼Œä½œä¸šè®¡åˆ’ç­‰è¯¸å¤šæ–¹æ³•ã€‚

`ISchedulerFactory` è¢«æ³¨å†Œä¸ºå•ä¾‹æœåŠ¡ï¼Œå…è®¸åœ¨ä»»ä½•å¯ä¾èµ–æ³¨å…¥çš„æœåŠ¡è·å–ï¼Œå¦‚ï¼š

```cs showLineNumbers {4,9}
public class YourService: IYourService
{
    private readonly ISchedulerFactory _schedulerFactory;
    public YourService(ISchedulerFactory schedulerFactory)
    {
        _schedulerFactory = schedulerFactory;
    }

    public void SomeMethod([FromServices]ISchedulerFactory schedulerFactory)
    {
    }
}
```

### 26.1.10.1 æŸ¥æ‰¾æ‰€æœ‰ä½œä¸š

```cs showLineNumbers {2,5,8-9}
// è¿”å›çš„æ˜¯ IScheduler é›†åˆï¼Œä¸èƒ½è®¿é—® JobDetail å’Œ Triggers å±æ€§
var jobs = _schedulerFactory.GetJobs();

// è¿”å›çš„æ˜¯ SchedulerModel é›†åˆï¼Œå¯ä»¥è®¿é—® JobDetail å’Œ Triggers å±æ€§
var jobsOfModels = _schedulerFactory.GetJobsOfModels();

// è¿˜å¯ä»¥é€šè¿‡ group æŸ¥æ‰¾
var jobs = _schedulerFactory.GetJobs("group1");
var jobsOfModels = _schedulerFactory.GetJobsOfModels("group1");
```

### 26.1.10.2 æŸ¥æ‰¾ä¸‹ä¸€ä¸ªè§¦å‘çš„ä½œä¸š

```cs showLineNumbers {2,5,8,9}
// è¿”å›çš„æ˜¯ IScheduler é›†åˆï¼Œä¸èƒ½è®¿é—® JobDetail å’Œ Triggers å±æ€§
var nextRunJobs = _schedulerFactory.GetNextRunJobs(DateTime.Now);

// è¿”å›çš„æ˜¯ SchedulerModel é›†åˆï¼Œå¯ä»¥è®¿é—® JobDetail å’Œ Triggers å±æ€§
var nextRunJobsOfModels = _schedulerFactory.GetNextRunJobsOfModels(DateTime.Now);

// è¿˜å¯ä»¥é€šè¿‡ group æŸ¥æ‰¾
var nextRunJobs = _schedulerFactory.GetNextRunJobs("group1");
var nextRunJobsOfModels = _schedulerFactory.GetNextRunJobsOfModels("group1");
```

### 26.1.10.3 è·å–å•ä¸ªä½œä¸š

```cs showLineNumbers {2,5}
// è¿”å› ScheduleResult ç±»å‹ï¼Œå¦‚æœå­˜åœ¨è¿”å› ScheduleResult.Succeedï¼Œå¦åˆ™è¿”å› ScheduleResult.NotFound
var scheduleResult = _schedulerFactory.TryGetJob("job1", out var scheduler);

// è¿”å› IScheduler ç±»å‹
var scheduler = _schedulerFactory.GetJob("job1");
```

### 26.1.10.4 æ·»åŠ ä½œä¸š

- **é€šè¿‡ `SchedulerBuilder` æ–¹å¼**

```cs showLineNumbers {2,5}
// è¿”å› ScheduleResult ç±»å‹ï¼Œå¦‚æœæ·»åŠ æˆåŠŸè¿”å› ScheduleResult.Succeedï¼Œå¦åˆ™è¿”å› ScheduleResult.Faild
var scheduleResult = _schedulerFactory.TryAddJob(schedulerBuilder, out var scheduler);

// æ— è¿”å›å€¼ï¼Œæ— é”™è¯¯
_schedulerFactory.AddJob(schedulerBuilder);
```

ä½œä¸šæ·»åŠ æˆåŠŸæˆ–å¤±è´¥åˆ†åˆ«è¾“å‡ºæ—¥å¿—ï¼š

```bash showLineNumbers {2,4}
info: 2022-11-21 16:24:03.5834532 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #8
      The Scheduler of <job1> successfully added to the schedule.
warn: 2022-11-21 16:24:03.5876747 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #8
      The JobId of <job1> already exists.
```

- **é€šè¿‡ `JobBuilder` + `TriggerBuilder` æ–¹å¼**

```cs showLineNumbers {2,7}
// è¿”å› ScheduleResult ç±»å‹ï¼Œå¦‚æœæ·»åŠ æˆåŠŸè¿”å› ScheduleResult.Succeedï¼Œå¦åˆ™è¿”å› ScheduleResult.Faild
var schedulerResult = _schedulerFactory.TryAddJob(JobBuilder.Create<MyJob>()
            , new[] { Triggers.PeriodSeconds(10) }
            , out var scheduler);

// æ— è¿”å›å€¼ï¼Œæ— é”™è¯¯
_schedulerFactory.AddJob(JobBuilder.Create<MyJob>()
            , Triggers.PeriodSeconds(10));
```

ä½œä¸šæ·»åŠ æˆåŠŸæˆ–å¤±è´¥åˆ†åˆ«è¾“å‡ºæ—¥å¿—ï¼š

```bash showLineNumbers {2,4}
info: 2022-11-21 16:24:03.5834532 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #8
      The Scheduler of <job1> successfully added to the schedule.
warn: 2022-11-21 16:24:03.5876747 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #8
      The JobId of <job1> already exists.
```

- **é€šè¿‡ `IJob` æ³›å‹æ–¹å¼**

```cs showLineNumbers {2,6}
// è¿”å› ScheduleResult ç±»å‹ï¼Œå¦‚æœæ·»åŠ æˆåŠŸè¿”å› ScheduleResult.Succeedï¼Œå¦åˆ™è¿”å› ScheduleResult.Faild
var schedulerResult = _schedulerFactory.TryAddJob<MyJob>(new[] { Triggers.PeriodSeconds(10) }
        , out var scheduler);

// æ— è¿”å›å€¼ï¼Œæ— é”™è¯¯
_schedulerFactory.AddJob<MyJob>(Triggers.PeriodSeconds(10));
```

ä½œä¸šæ·»åŠ æˆåŠŸæˆ–å¤±è´¥åˆ†åˆ«è¾“å‡ºæ—¥å¿—ï¼š

```bash showLineNumbers {2,4}
info: 2022-11-21 16:24:03.5834532 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #8
      The Scheduler of <job1> successfully added to the schedule.
warn: 2022-11-21 16:24:03.5876747 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #8
      The JobId of <job1> already exists.
```

- **é€šè¿‡ `IJob` æ³›å‹ + `JobId` æ–¹å¼**

```cs showLineNumbers {2,6}
// è¿”å› ScheduleResult ç±»å‹ï¼Œå¦‚æœæ·»åŠ æˆåŠŸè¿”å› ScheduleResult.Succeedï¼Œå¦åˆ™è¿”å› ScheduleResult.Faild
var schedulerResult = _schedulerFactory.TryAddJob<MyJob>("job1", new[] { Triggers.PeriodSeconds(10) }
        , out var scheduler);

// æ— è¿”å›å€¼ï¼Œæ— é”™è¯¯
_schedulerFactory.AddJob<MyJob>("job1", Triggers.PeriodSeconds(10));
```

ä½œä¸šæ·»åŠ æˆåŠŸæˆ–å¤±è´¥åˆ†åˆ«è¾“å‡ºæ—¥å¿—ï¼š

```bash showLineNumbers {2,4}
info: 2022-11-21 16:24:03.5834532 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #8
      The Scheduler of <job1> successfully added to the schedule.
warn: 2022-11-21 16:24:03.5876747 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #8
      The JobId of <job1> already exists.
```

- **é€šè¿‡ `IJob` æ³›å‹ + `JobId` + `Concurrent` æ–¹å¼**

```cs showLineNumbers {2,7}
// è¿”å› ScheduleResult ç±»å‹ï¼Œå¦‚æœæ·»åŠ æˆåŠŸè¿”å› ScheduleResult.Succeedï¼Œå¦åˆ™è¿”å› ScheduleResult.Faild
var schedulerResult = _schedulerFactory.TryAddJob<MyJob>("job1", concurrent: true
        , new[] { Triggers.PeriodSeconds(10) }
        , out var scheduler);

// æ— è¿”å›å€¼ï¼Œæ— é”™è¯¯
_schedulerFactory.AddJob<MyJob>("job1", concurrent: true
        , Triggers.PeriodSeconds(10));
```

ä½œä¸šæ·»åŠ æˆåŠŸæˆ–å¤±è´¥åˆ†åˆ«è¾“å‡ºæ—¥å¿—ï¼š

```bash showLineNumbers {2,4}
info: 2022-11-21 16:24:03.5834532 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #8
      The Scheduler of <job1> successfully added to the schedule.
warn: 2022-11-21 16:24:03.5876747 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #8
      The JobId of <job1> already exists.
```

- **é€šè¿‡ `IJob` æ³›å‹ + `Concurrent` æ–¹å¼**

```cs showLineNumbers {2,7}
// è¿”å› ScheduleResult ç±»å‹ï¼Œå¦‚æœæ·»åŠ æˆåŠŸè¿”å› ScheduleResult.Succeedï¼Œå¦åˆ™è¿”å› ScheduleResult.Faild
var schedulerResult = _schedulerFactory.TryAddJob<MyJob>(concurrent: true
        , new[] { Triggers.PeriodSeconds(10) }
        , out var scheduler);

// æ— è¿”å›å€¼ï¼Œæ— é”™è¯¯
_schedulerFactory.AddJob<MyJob>(concurrent: true
        , Triggers.PeriodSeconds(10));
```

ä½œä¸šæ·»åŠ æˆåŠŸæˆ–å¤±è´¥åˆ†åˆ«è¾“å‡ºæ—¥å¿—ï¼š

```bash showLineNumbers {2,4}
info: 2022-11-21 16:24:03.5834532 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #8
      The Scheduler of <job1> successfully added to the schedule.
warn: 2022-11-21 16:24:03.5876747 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #8
      The JobId of <job1> already exists.
```

### 26.1.10.5 æ›´æ–°ä½œä¸š

- **é€šè¿‡ `SchedulerBuilder` æ–¹å¼**

```cs showLineNumbers {2,5}
// è¿”å› ScheduleResult ç±»å‹ï¼Œå¦‚æœæ·»åŠ æˆåŠŸè¿”å› ScheduleResult.Succeedï¼Œå¦åˆ™è¿”å› ScheduleResult.Faild
var scheduleResult = _schedulerFactory.TryUpdateJob(schedulerBuilder, out var scheduler);

// æ— è¿”å›å€¼ï¼Œæ— é”™è¯¯
_schedulerFactory.UpdateJob(schedulerBuilder);
```

ä½œä¸šæ›´æ–°æˆåŠŸæˆ–å¤±è´¥åˆ†åˆ«è¾“å‡ºæ—¥å¿—ï¼š

```bash showLineNumbers {2,4,6}
info: 2022-11-21 18:13:13.0098096 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #14
      The Scheduler of <job1> successfully updated to the schedule.
warn: 2022-11-21 18:13:18.0098096 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #14
      The Scheduler of <job1> is not found.
warn: 2022-11-21 18:13:23.0098096 +08:00 æ˜ŸæœŸä¸€ L System.Logging.ScheduleService[0] #14
      The Scheduler of <job1> update failed.
```

:::tip å…³äºæ›´æ–°ä½œä¸šçš„èƒŒåè¡Œä¸º

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ›´æ–°ä½œä¸šéœ€è¦ä¼ é€’ `SchedulerBuilder` å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å¯é€šè¿‡ `GetJob(jobId)` è·å–ï¼Œå¦‚ï¼š

```cs showLineNumbers
var schedulerBuilder = _schedulerFactory.GetJob("jobId")?.GetBuilder();
```

æ­¤æ—¶å®ƒçš„å†…éƒ¨ `Behavior` å±æ€§è¢«æ ‡è®°ä¸º `PersistenceBehavior.Updated`ï¼Œä¹Ÿå°±æ˜¯æ›´æ–°çŠ¶æ€ï¼Œé‚£ä¹ˆå¯¹äºè¿™ä¸ªæ„å»ºå™¨çš„ä»»ä½•æ“ä½œéƒ½ä¼šæ ‡è®°ä¸º `æ›´æ–°` æ“ä½œã€‚

å¦‚æœé€šè¿‡ `.Appended()` æˆ– `.Removed()` æ–¹æ³•æ ‡è®°ä¹‹åï¼Œé‚£ä¹ˆå®ƒçš„æ“ä½œè¡Œä¸ºå°±å‘ç”Ÿå˜åŒ–äº†ã€‚

- **å¦‚æœè¢«æ ‡è®°ä¸º `.Appended()`**ï¼Œå¦‚ï¼š

```cs showLineNumbers
schedulerBuilder.Appended();
```

é‚£ä¹ˆå®ƒå°†è¿›è¡Œ `æ–°å¢` æ“ä½œï¼Œä¹Ÿå°±æ˜¯å†…éƒ¨ä¼šè°ƒç”¨ `TryAddJob(schedulerBuilder)` æ“ä½œã€‚

- **å¦‚æœè¢«æ ‡è®°ä¸º `.Removed()`**ï¼Œå¦‚ï¼š

```cs showLineNumbers
schedulerBuilder.Removed();
```

é‚£ä¹ˆå®ƒå°†è¿›è¡Œ `åˆ é™¤` æ“ä½œï¼Œä¹Ÿå°±æ˜¯å†…éƒ¨ä¼šè°ƒç”¨ `TryRemoveJob(schedulerBuilder)` æ“ä½œã€‚

æ¯”å¦‚ä»¥ä¸‹çš„ä»£ç å®åˆ™æ˜¯ `æ–°å¢` æˆ– `åˆ é™¤` æ“ä½œï¼š

```cs showLineNumbers {3,7}
// å®é™…åšæ–°å¢æ“ä½œ
var scheduleResult = _schedulerFactory.TryUpdateJob(
      SchedulerBuilder.Create(JobBuilder.Create<MyJob>())); // Create æ–¹æ³•é»˜è®¤æ ‡è®°ä¸º Appended

// å®é™…åšåˆ é™¤æ“ä½œ
var schedulerBuilder = _schedulerFactory.GetJob("jobId")?.GetBuilder();
var scheduleResult = _schedulerFactory.TryUpdateJob(schedulerBuilder.Removed()); // æ ‡è®°ä¸º Removed
```

:::

### 26.1.10.6 åˆ é™¤ä½œä¸š

- **é€šè¿‡ `JobId` æ–¹å¼**

```cs showLineNumbers {2,5}
// è¿”å› ScheduleResult ç±»å‹ï¼Œå¦‚æœæ·»åŠ æˆåŠŸè¿”å› ScheduleResult.Succeedï¼Œå¦åˆ™è¿”å› ScheduleResult.Faild æˆ–è€… ScheduleResult.NotFound
var schedulerResult = _schedulerFactory.TryRemoveJob("job1", out var scheduler);

// æ— è¿”å›å€¼ï¼Œæ— é”™è¯¯
_schedulerFactory.RemoveJob("job1");
```

- **é€šè¿‡ `IScheduler` æ–¹å¼**

```cs showLineNumbers {2,5}
// è¿”å› ScheduleResult ç±»å‹ï¼Œå¦‚æœæ·»åŠ æˆåŠŸè¿”å› ScheduleResult.Succeedï¼Œå¦åˆ™è¿”å› ScheduleResult.Faild æˆ–è€… ScheduleResult.NotFound
var schedulerResult = _schedulerFactory.TryRemoveJob(scheduler);

// æ— è¿”å›å€¼ï¼Œæ— é”™è¯¯
_schedulerFactory.RemoveJob(scheduler);
```

ä½œä¸šåˆ é™¤æˆåŠŸæˆ–å¤±è´¥åˆ†åˆ«è¾“å‡ºæ—¥å¿—ï¼š

```bash showLineNumbers {2,4,6}
info: 2022-11-22 09:25:17.4763941 +08:00 æ˜ŸæœŸäºŒ L System.Logging.ScheduleService[0] #4
      The Scheduler of <job1> successfully removed to the schedule.
warn: 2022-11-22 09:28:56.2241923 +08:00 æ˜ŸæœŸäºŒ L System.Logging.ScheduleService[0] #9
      The Scheduler of <job12> is not found.
warn: 2022-11-22 09:29:01.2241923 +08:00 æ˜ŸæœŸäºŒ L System.Logging.ScheduleService[0] #9
      The Scheduler of <job1> remove failed.
```

### 26.1.10.7 æ£€æŸ¥ä½œä¸šæ˜¯å¦å­˜åœ¨

```cs showLineNumbers {1,4}
var isExist = _schedulerFactory.ContainsJob("job1");

// è¿˜å¯ä»¥é€šè¿‡ group æŸ¥æ‰¾
var isExist = _schedulerFactory.ContainsJob("job1", "group1");
```

### 26.1.10.8 å¯åŠ¨æ‰€æœ‰ä½œä¸š

```cs showLineNumbers {1,4}
_schedulerFactory.StartAll();

// è¿˜å¯ä»¥é€šè¿‡ group å¯åŠ¨
_schedulerFactory.StartAll("group1");
```

ä½œä¸šè°ƒåº¦å™¨è¾“å‡ºæ—¥å¿—ï¼š

```bash showLineNumbers {2,4}
info: 2022-11-22 10:48:55.9619596 +08:00 æ˜ŸæœŸäºŒ L System.Logging.ScheduleService[0] #16
      The <job1_trigger1> trigger for scheduler of <job1> successfully started to the schedule.
warn: 2022-11-22 10:48:56.0131304 +08:00 æ˜ŸæœŸäºŒ L System.Logging.ScheduleService[0] #16
      Schedule Hosted Service cancels hibernation and GC.Collect().
```

### 26.1.10.9 æš‚åœæ‰€æœ‰ä½œä¸š

```cs showLineNumbers {1,4}
 _schedulerFactory.PauseAll();

// è¿˜å¯ä»¥é€šè¿‡ group æš‚åœ
 _schedulerFactory.PauseAll("group1");
```

ä½œä¸šè°ƒåº¦å™¨è¾“å‡ºæ—¥å¿—ï¼š

```bash showLineNumbers {4,6}
info: 2022-11-22 11:01:52.0008851 +08:00 æ˜ŸæœŸäºŒ L ConsoleApp32.MyJob[0] #10
      job1 job1_trigger1 2022/11/22 11:01:51  5000ms
info: 2022-11-22 11:01:54.5265246 +08:00 æ˜ŸæœŸäºŒ L System.Logging.ScheduleService[0] #15
      The <job1_trigger1> trigger for scheduler of <job1> successfully paused to the schedule.
warn: 2022-11-22 11:01:54.5535267 +08:00 æ˜ŸæœŸäºŒ L System.Logging.ScheduleService[0] #15
      Schedule Hosted Service cancels hibernation and GC.Collect().
```

### 26.1.10.10 åˆ é™¤æ‰€æœ‰ä½œä¸š

```cs showLineNumbers {1,4}
 _schedulerFactory.RemoveAll();

// è¿˜å¯ä»¥é€šè¿‡ group åˆ é™¤
 _schedulerFactory.RemoveAll("group1");
```

ä½œä¸šè°ƒåº¦å™¨è¾“å‡ºæ—¥å¿—ï¼š

```bash showLineNumbers {4,6}
info: 2022-11-22 11:04:19.4838792 +08:00 æ˜ŸæœŸäºŒ L ConsoleApp32.MyJob[0] #14
      job1 job1_trigger1 2022/11/22 11:04:19  5000ms
warn: 2022-11-22 11:04:23.0726721 +08:00 æ˜ŸæœŸäºŒ L System.Logging.ScheduleService[0] #9
      Schedule Hosted Service cancels hibernation and GC.Collect().
info: 2022-11-22 11:04:23.0797010 +08:00 æ˜ŸæœŸäºŒ L System.Logging.ScheduleService[0] #9
      The Scheduler of <job1> successfully removed to the schedule.
```

### 26.1.10.11 å¼ºåˆ¶å”¤é†’ä½œä¸šè°ƒåº¦å™¨

æ­£å¸¸æƒ…å†µä¸‹ï¼Œä½œä¸šè°ƒåº¦å™¨ä¼šè‡ªåŠ¨ç®¡ç†ä¼‘çœ å’Œå”¤é†’ï¼Œä½†ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹éœ€è¦å¼ºåˆ¶å”¤é†’ä½œä¸šè°ƒåº¦å™¨ï¼ˆæ¯”å¦‚è°ƒåº¦å™¨å‡æ­»äº†ï¼Œè¢«å›æ”¶äº†ã€‚ã€‚ã€‚ï¼‰ï¼Œå¯é€šè¿‡ä»¥ä¸‹æ–¹å¼ï¼š

```cs showLineNumbers
_schedulerFactory.CancelSleep();
```

ä½œä¸šè°ƒåº¦å™¨è¾“å‡ºæ—¥å¿—ï¼š

```bash showLineNumbers {2}
warn: 2022-11-22 11:04:23.0726721 +08:00 æ˜ŸæœŸäºŒ L System.Logging.ScheduleService[0] #9
      Schedule Hosted Service cancels hibernation and GC.Collect().
```

### 26.1.10.12 å¼ºåˆ¶è§¦å‘æ‰€æœ‰ä½œä¸šæŒä¹…åŒ–

æ­¤æ“ä½œä¼šå¼ºåˆ¶è§¦å‘ä½œä¸šæŒä¹…åŒ–å™¨ `IJobPersistence` çš„ `OnChanged` å’Œ `OnTriggerChanged` æ–¹æ³•ï¼Œå¹¶æ ‡è®°ä½œä¸šæŒä¹…åŒ–è¡Œä¸ºä¸º `PersistenceBehavior.Updated`ã€‚

```cs showLineNumbers {1,4}
_schedulerFactory.PersistAll();

// è¿˜å¯ä»¥é€šè¿‡ group æ§åˆ¶
 _schedulerFactory.PersistAll("group1");
```

## 26.1.11 ä½œä¸šè®¡åˆ’ `IScheduler`

ä½œä¸šè®¡åˆ’ `Scheduler` çš„é»˜è®¤å®ç°æ¥å£æ˜¯ `IScheduler`ï¼Œè¯¥æ¥å£ä¸»è¦ç”¨æ¥æ“ä½œå½“å‰ï¼ˆå•ä¸ªï¼‰ä½œä¸šã€‚

### 26.1.11.1 è·å– `IScheduler` å®ä¾‹

```cs showLineNumbers {2,5}
// è¿”å› ScheduleResult ç±»å‹ï¼Œå¦‚æœå­˜åœ¨è¿”å› ScheduleResult.Succeedï¼Œå¦åˆ™è¿”å› ScheduleResult.NotFound
var scheduleResult = _schedulerFactory.TryGetJob("job1", out var scheduler);

// è¿”å› IScheduler ç±»å‹
var scheduler = _schedulerFactory.GetJob("job1");
```

### 26.1.11.2 è·å– `SchedulerModel` å®ä¾‹

è·å– `SchedulerModel` ä¹‹åå¯ç›´æ¥è®¿é—® `JobDetail` å’Œ `Trigger` å¯¹è±¡ã€‚

```cs showLineNumbers
var schedulerModel = scheduler.GetModel();
```

### 26.1.11.3 è·å– `SchedulerBuilder`

```cs showLineNumbers
var schedulerBuilder = scheduler.GetBuilder();
```

### 26.1.11.4 è·å– `JobBuilder`

```cs showLineNumbers
var jobBuilder = scheduler.GetJobBuilder();
```

### 26.1.11.5 è·å– `TriggerBuilders`

```cs showLineNumbers
var triggerBuilders = scheduler.GetTriggerBuilders();
```

### 26.1.11.6 è·å–å•ä¸ª `TriggerBuilder`

```cs showLineNumbers
var triggerBuilder = scheduler.GetTriggerBuilder("trigger1");
```

### 26.1.11.7 å¯åŠ¨å½“å‰ä½œä¸š

```cs showLineNumbers
scheduler.Start();
```

ä½œä¸šè°ƒåº¦å™¨è¾“å‡ºæ—¥å¿—ï¼š

```bash showLineNumbers {2,4}
info: 2022-11-22 17:38:16.2612604 +08:00 æ˜ŸæœŸäºŒ L System.Logging.ScheduleService[0] #15
      The <job1_trigger1> trigger for scheduler of <job1> successfully started to the schedule.
warn: 2022-11-22 17:38:16.2636849 +08:00 æ˜ŸæœŸäºŒ L System.Logging.ScheduleService[0] #15
      Schedule Hosted Service cancels hibernation and GC.Collect().
```

### 26.1.11.8 æš‚åœå½“å‰ä½œä¸š

```cs showLineNumbers
schedular.Pause();
```

ä½œä¸šè°ƒåº¦å™¨è¾“å‡ºæ—¥å¿—ï¼š

```bash {4,6}
info: 2022-11-22 15:34:39.5609135 +08:00 æ˜ŸæœŸäºŒ L ConsoleApp32.MyJob[0] #8
      job1 job1_trigger1 2022/11/22 15:34:39  5000ms
info: 2022-11-22 15:34:39.5647151 +08:00 æ˜ŸæœŸäºŒ L System.Logging.ScheduleService[0] #14
      The <job1_trigger1> trigger for scheduler of <job1> successfully paused to the schedule.
warn: 2022-11-22 15:34:39.5682460 +08:00 æ˜ŸæœŸäºŒ L System.Logging.ScheduleService[0] #14
      Schedule Hosted Service cancels hibernation and GC.Collect().
```

### 26.1.11.9 å¯åŠ¨ä½œä¸šç‰¹å®šè§¦å‘å™¨

```cs showLineNumbers
scheduler.StartTrigger("triggerId");
```

### 26.1.11.10 æš‚åœä½œä¸šç‰¹å®šè§¦å‘å™¨

```cs showLineNumbers
scheduler.PauseTrigger("triggerId");
```

### 26.1.11.11 æ›´æ–°ä½œä¸šä¿¡æ¯

```cs showLineNumbers {2,5}
// è¿”å› ScheduleResult ç±»å‹ï¼Œå¦‚æœæ·»åŠ æˆåŠŸè¿”å› ScheduleResult.Succeedï¼Œå¦åˆ™è¿”å› ScheduleResult.Faild
var schedulerResult = scheduler.TryUpdateDetail(jobBuilder, out var jobDetail);

// æ— è¿”å›å€¼ï¼Œæ— é”™è¯¯
scheduler.UpdateDetail(jobBuilder);
```

### 26.1.11.12 è·å–ä½œä¸šå•ä¸ªè§¦å‘å™¨

```cs showLineNumbers {2,5}
// è¿”å› ScheduleResult ç±»å‹ï¼Œå¦‚æœå­˜åœ¨è¿”å› ScheduleResult.Succeedï¼Œå¦åˆ™è¿”å› ScheduleResult.NotFound
var scheduleResult = scheduler.TryGetTrigger("trigger1", out var trigger);

// è¿”å› Trigger ç±»å‹
var trigger = scheduler.GetTrigger("trigger1");
```

### 26.1.11.13 æ·»åŠ ä½œä¸šå•ä¸ªè§¦å‘å™¨

```cs showLineNumbers {2,5}
// è¿”å› ScheduleResult ç±»å‹ï¼Œå¦‚æœæ·»åŠ æˆåŠŸè¿”å› ScheduleResult.Succeedï¼Œå¦åˆ™è¿”å› ScheduleResult.Faild
var schedulerResult = scheduler.TryAddTrigger(triggerBuilder, out var trigger);

// æ— è¿”å›å€¼ï¼Œæ— é”™è¯¯
scheduler.AddTrigger(triggerBuilder);
```

### 26.1.11.14 åˆ é™¤ä½œä¸šå•ä¸ªè§¦å‘å™¨

```cs showLineNumbers {2,5}
// è¿”å› ScheduleResult ç±»å‹ï¼Œå¦‚æœæ·»åŠ æˆåŠŸè¿”å› ScheduleResult.Succeedï¼Œå¦åˆ™è¿”å› ScheduleResult.Faild æˆ– ScheduleResult.NotFound
var schedulerResult = scheduler.TryRemoveTrigger("trigger1", out var trigger);

// æ— è¿”å›å€¼ï¼Œæ— é”™è¯¯
scheduler.RemoveTrigger(triggerBuilder);
```

### 26.1.11.15 åˆ¤æ–­ä½œä¸šæ˜¯å¦åŒ…å«ç‰¹å®šè§¦å‘å™¨

```cs showLineNumbers
var isExist = scheduler.ContainsTrigger("trigger1");
```

### 26.1.11.16 åˆ é™¤å½“å‰ä½œä¸š

```cs showLineNumbers {2,5}
// è¿”å› ScheduleResult ç±»å‹ï¼Œå¦‚æœæ·»åŠ æˆåŠŸè¿”å› ScheduleResult.Succeedï¼Œå¦åˆ™è¿”å› ScheduleResult.Faild
var schedulerResult = scheduler.TryRemove();

// æ— è¿”å›å€¼ï¼Œæ— é”™è¯¯
scheduler.Remove();
```

### 26.1.11.17 å¼ºåˆ¶è§¦å‘æ‰€æœ‰ä½œä¸šæŒä¹…åŒ–

æ­¤æ“ä½œä¼šå¼ºåˆ¶è§¦å‘ä½œä¸šæŒä¹…åŒ–å™¨ `IJobPersistence` çš„ `OnChanged` å’Œ `OnTriggerChanged` æ–¹æ³•ï¼Œå¹¶æ ‡è®°ä½œä¸šæŒä¹…åŒ–è¡Œä¸ºä¸º `PersistenceBehavior.Updated`ã€‚

```cs showLineNumbers {1}
scheduler.Persist();
```

### 26.1.11.18 è¾“å‡º `JSON` å­—ç¬¦ä¸²

```cs showLineNumbers
var json scheduler.ConvertToJSON();
```

è¾“å‡ºç»“æœä¸ºï¼š

```json showLineNumbers {2,13}
{
  "jobDetail": {
    "jobId": "job1",
    "groupName": null,
    "jobType": "Furion.Application.MyJob",
    "assemblyName": "Furion.Application",
    "description": null,
    "concurrent": true,
    "includeAnnotations": false,
    "properties": "{}",
    "updatedTime": "2022-11-17T09:25:47.0471107+08:00"
  },
  "triggers": [
    {
      "triggerId": "job1_trigger1",
      "jobId": null,
      "triggerType": "Furion.Schedule.PeriodSecondsTrigger",
      "assemblyName": "Furion",
      "args": "[5]",
      "description": null,
      "status": 2,
      "startTime": null,
      "endTime": null,
      "lastRunTime": "2022-11-20T18:31:56.6859410+08:00",
      "nextRunTime": "2022-11-20T18:32:01.7233546+08:00",
      "numberOfRuns": 1,
      "maxNumberOfRuns": 0,
      "numberOfErrors": 0,
      "maxNumberOfErrors": 0,
      "numRetries": 0,
      "retryTimeout": 1000,
      "startNow": true,
      "runOnStart": false,
      "resetOnlyOnce": true,
      "updatedTime": "2022-11-20T18:31:56.7233630+08:00"
    }
  ]
}
```

## 26.1.12 ä½œä¸šæŒä¹…åŒ–å™¨ `IJobPersistence`

### 26.1.12.1 å…³äºä½œä¸šæŒä¹…åŒ–å™¨

ä½œä¸šæŒä¹…åŒ–å™¨æŒ‡çš„æ˜¯å¯ä»¥é€šè¿‡å­˜å‚¨ä»‹è´¨å¦‚æ•°æ®åº“ä¸­åŠ è½½ä½œä¸šä¿¡æ¯åˆ°å†…å­˜ä¸­ï¼Œåˆå¯ä»¥å°†å†…å­˜ä¸­ä½œä¸šè°ƒåº¦å™¨çš„ä½œä¸šä¿¡æ¯å®æ—¶åŒæ­¥å›å­˜å‚¨ä»‹è´¨ä¸­ã€‚

### 26.1.12.2 å®ç°ä½œä¸šæŒä¹…åŒ–å™¨

è°ƒåº¦ä½œä¸šæœåŠ¡æä¾›äº†éå¸¸ç®€å•çš„ `IJobPersistence` æ¥å£ï¼Œåªéœ€å®ç°è¯¥æ¥å£å³å¯å®ç°æŒä¹…åŒ–ï¼Œå¦‚å®ç°æ•°æ®åº“æŒä¹…åŒ–ï¼š

```cs showLineNumbers {1,3,9,17,23}
public class DbJobPersistence : IJobPersistence
{
    public IEnumerable<SchedulerBuilder> Preload()
    {
        // ä½œä¸šè°ƒåº¦æœåŠ¡å¯åŠ¨æ—¶è¿è¡Œæ—¶åˆå§‹åŒ–
        return Array.Empty<SchedulerBuilder>();
    }

    public SchedulerBuilder OnLoading(SchedulerBuilder builder)
    {
        // å¦‚æœæ˜¯æ›´æ–°æ“ä½œï¼Œåˆ™ return builder.Updated();
        // å¦‚æœæ˜¯æ–°å¢æ“ä½œï¼Œåˆ™ return builder.Appended();
        // å¦‚æœæ˜¯åˆ é™¤æ“ä½œï¼Œåˆ™ return builder.Removed();
        return builder;
    }

    public void OnChanged(PersistenceContext context)
    {
        var sql = context.ConvertToSQL("job_detail");
        // è¿™é‡Œæ‰§è¡Œ sql å³å¯
    }

    public void OnTriggerChanged(PersistenceTriggerContext context)
    {
        var sql = context.ConvertToSQL("job_trigger");
        // è¿™é‡Œæ‰§è¡Œ sql å³å¯
    }
}
```

ä¹‹ååœ¨ `Startup.cs` ä¸­æ³¨å†Œå³å¯ï¼š

```cs showLineNumbers {3}
services.AddSchedule(options =>
{
      options.AddPersistence<DbJobPersistence>();
});
```

å¯èƒ½æœ‰äº›å¼€å‘è€…çœ‹åˆ°è¿™é‡Œä¸€è„¸ä¸è§£ï¼ŒæŒä¹…åŒ–ä¸åº”è¯¥è¿™ä¹ˆç®€å•å•Šï¼å…¶å®å°±æ˜¯è¿™ä¹ˆç®€å•....

### 26.1.12.3 `IJobPersistence` è¯¦ç»†è¯´æ˜

`IJobPersistence` æ¥å£æä¾›äº†ä»¥ä¸‹å››ä¸ªæ–¹æ³•ï¼š

- **`Preload`ï¼šä½œä¸šè°ƒåº¦æœåŠ¡å¯åŠ¨æ—¶è°ƒç”¨ï¼Œå¯åœ¨è¿™é‡ŒåŠ¨æ€åˆ›å»ºä½œä¸šè®¡åˆ’æ„å»ºå™¨å¹¶è¿”å›ã€‚**

```cs showLineNumbers {1,4,8,12,17}
public IEnumerable<SchedulerBuilder> Preload()
{
      // è¿™é‡Œå¯ä»¥æ‰«æç¨‹åºé›†åŠ¨æ€åˆ›å»ºè¿”å›
      return App.EffectiveTypes.Where(t => t.IsJobType())
                               .Select(t => SchedulerBuilder.Create(JobBuilder.Create(t), t.ScanTriggers()));

      // å¦‚æœç±»å‹è´´æœ‰ [JobDetail] ç‰¹æ€§ï¼Œè¿˜å¯ä»¥ä¸€é”®æ‰«æè¿”å›
      return App.EffectiveTypes.Where(t => t.IsJobType())
                               .Select(t => t.ScanToBuilder());

      // è¿˜å¯ä»¥æ›´ç®€å•~~
      return App.EffectiveTypes.ScanToBuilders();

      // ä¹Ÿå¯ä»¥æ‰‹åŠ¨è¿”å›
      return new[]
      {
            SchedulerBuilder.Create(JobBuilder.Create<MyJob>(), Triggers.Minutely())
      }
}
```

- **`OnLoading`ï¼šä½œä¸šè®¡åˆ’åˆå§‹åŒ–é€šçŸ¥ï¼Œé€šå¸¸åœ¨è¿™é‡Œè¿›ä¸€æ­¥ä¿®æ”¹åˆå§‹åŒ–ä½œä¸šè®¡åˆ’æ„å»ºå™¨ã€‚**

åœ¨ä½œä¸šè°ƒåº¦å™¨æœåŠ¡å¯åŠ¨æ—¶ä¼šéå†ç¨‹åºä¸­æ‰€æœ‰ä½œä¸šè®¡åˆ’æ„å»ºå™¨ï¼Œç„¶åé€æ¡è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå¼€å‘è€…å¯ä»¥åœ¨è¿™é‡Œè¿›ä¸€æ­¥ä¿®æ”¹ä½œä¸šè®¡åˆ’æ„å»ºå™¨æ•°æ®ï¼Œä¹‹å**é€‰æ‹©æ€§è¿”å› `SchedulerBuilder` çš„æŒä¹…åŒ–è¡Œä¸º**ã€‚

`SchedulerBuilder` æä¾› `Updated()`ï¼Œ`Appended()` å’Œ `Removed()` æ¥ä½œä¸ºæŒä¹…åŒ–è¡Œä¸ºæ ‡è®°ï¼Œé€šå¸¸æ ‡è®°ä¸º `Appended()`ï¼Œä¹Ÿå°±æ˜¯æ–°å¢æ“ä½œï¼ˆé»˜è®¤å€¼ï¼‰ã€‚

```cs showLineNumbers {4,8,12-13,16}
public SchedulerBuilder OnLoading(SchedulerBuilder builder)
{
      // æ¯”å¦‚è¿™é‡Œä¿®æ”¹ä½œä¸šä¿¡æ¯æè¿°
      builder.GetJobBuilder()
             .SetDescription("è¿™æ˜¯æè¿°~~");

      // è¿˜å¯ä»¥ä¿®æ”¹è§¦å‘å™¨
      builder.GetTriggerBuilder("trigger1")
             .SetDescription("è¿™æ˜¯è§¦å‘å™¨æè¿°~~");

      // è¿˜å¯ä»¥é€šè¿‡æ•°æ®åº“æŸ¥è¯¢è¿”å›å¡«å…… ğŸ˜
      builder.GetJobBuilder()
             .LoadFrom(dbJobDetail); // dbJobDetail è¡¨ç¤ºæ ¹æ® jobId æŸ¥è¯¢æ•°æ®åº“è¿”å›çš„å¯¹è±¡

      // æ ‡è®°ä»å…¶ä»–åœ°æ–¹æ›´æ–°ï¼Œæ¯”å¦‚æ•°æ®åº“
      return builder;
}
```

å¦‚æœå­˜å‚¨ä»‹è´¨ï¼ˆå¦‚æ•°æ®åº“ï¼‰å·²ç»åˆ é™¤è¯¥ä½œä¸šï¼Œå¼€å‘è€…å¯ä»¥æ ‡è®°ä¸º `Removed()`ï¼Œè¿™æ ·è¯¥ä½œä¸šä¼šä»å†…å­˜ä¸­ç§»é™¤ã€‚

```cs showLineNumbers {3,6}
public SchedulerBuilder OnLoading(SchedulerBuilder builder)
{
      // æ¯”å¦‚è¿™é‡Œæ ¹æ® jobId æŸ¥è¯¢æ•°æ®åº“å·²ç»ç¡®è®¤æ•°æ®ä¸å­˜åœ¨äº†

      // æ ‡è®°ä»å…¶ä»–åœ°æ–¹ç§»é™¤
      return builder.Removed();
}
```

å¦‚æœå­˜å‚¨ä»‹è´¨ï¼ˆå¦‚æ•°æ®åº“ï¼‰æ–°å¢äº†æ–°ä½œä¸šä½†å†…å­˜ä¸­ä¸å­˜åœ¨ï¼Œå¼€å‘è€…å¯ä»¥æ ‡è®°ä¸º `Append()`ï¼Œè¿™æ ·è¯¥ä½œä¸šä¼šæ·»åŠ åˆ°å†…å­˜ä¸­ï¼Œ**ä½†åŸæœ‰çš„ `builder` å°±ä¼šè¢«ä¸¢å¼ƒ**ã€‚

```cs showLineNumbers {4,6,8,11}
public SchedulerBuilder OnLoading(SchedulerBuilder builder)
{
      // æ¯”å¦‚åœ¨è¿™é‡ŒåŠ¨æ€åˆ›å»ºä½œä¸šè®¡åˆ’æ„å»ºå™¨
      var newBuilder = SchedulerBuilder.Create<MyJob>(Triggers.Minutely());
      // è¿˜å¯ä»¥å…‹éš†ä¸€ä¸ª
      var newBuilder = SchedulerBuilder.Clone(builder);
      // è¿˜å¯ä»¥è¯»å–é…ç½®æ–‡ä»¶/JSON
      var newBuilder = SchedulerBuilder.From(json);

      // è¿”å›æ–°çš„ä½œä¸šè®¡åˆ’æ„å»ºå™¨å¹¶æ ‡è®°ä¸ºæ–°å¢
      return newBuilder.Appended();
}
```

- **`OnChanged`ï¼šä½œä¸šè®¡åˆ’ `Scheduler` çš„ `JobDetail` å˜åŒ–æ—¶è°ƒç”¨ã€‚**

åªè¦ä½œä¸šè®¡åˆ’æœ‰ä»»ä½•å˜åŒ–éƒ½å°†è§¦å‘è¯¥æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æœ‰ä¸€ä¸ª `PersistenceContext` ç±»å‹çš„å‚æ•° `context`ï¼Œ`PersistenceContext` åŒ…å«ä»¥ä¸‹æˆå‘˜ï¼š

- **`PersistenceContext` å±æ€§åˆ—è¡¨**
  - `JobId`ï¼šä½œä¸š `Id`ï¼Œ`string` ç±»å‹
  - `JobDetail`ï¼šä½œä¸šä¿¡æ¯ï¼Œ`JobDetail` ç±»å‹
  - `Behavior`ï¼šæŒä¹…åŒ–è¡Œä¸ºï¼Œ`PersistenceBehavior` æšä¸¾ç±»å‹ï¼ŒåŒ…å« `Appended`ï¼Œ`Updated` å’Œ `Removed` ä¸‰ä¸ªæšä¸¾æˆå‘˜
- **`PersistenceContext` æ–¹æ³•åˆ—è¡¨**
  - `ConvertToSQL`ï¼šå°† `PersistenceContext` è½¬æ¢æˆ `SQL` å­—ç¬¦ä¸²ï¼Œ`Behavior` å±æ€§å€¼ä¸åŒï¼Œç”Ÿæˆçš„ `SQL` ä¸åŒ
  - `ConvertToJSON`ï¼šå°† `PersistenceContext` è½¬æ¢æˆ `JSON` å­—ç¬¦ä¸²
  - `ConvertToMonitor`ï¼šå°† `PersistenceContext` è½¬æ¢æˆ `Monitor` å­—ç¬¦ä¸²
  - `ToString`ï¼šå°† `PersistenceContext` è½¬æ¢æˆ `ç®€è¦` å­—ç¬¦ä¸²
  - `GetNaming`ï¼šæä¾›å°†ç‰¹å®šå­—ç¬¦ä¸²è¾“å‡ºä¸åŒçš„å‘½åè§„åˆ™å­—ç¬¦ä¸²

```cs showLineNumbers {4,6,8,10}
public void OnChanged(PersistenceContext context)
{
      // è¾“å‡º CamelCaseï¼ˆé©¼å³°å‘½åæ³•ï¼‰SQL è¯­å¥ï¼Œé»˜è®¤å€¼
      var sql = context.ConvertToSQL("job_detail");
      // è¾“å‡º Pascalï¼ˆå¸•æ–¯å¡å‘½åæ³•ï¼‰ SQL è¯­å¥
      var sql = context.ConvertToSQL("job_detail", NamingConventions.Pascal);
      // è¾“å‡º UnderScoreCaseï¼ˆä¸‹åˆ’çº¿å‘½åæ³•ï¼‰ SQL è¯­å¥
      var sql = context.ConvertToSQL("job_detail", NamingConventions.UnderScoreCase);

      // ä½ è¦åšçš„åªæ˜¯æ‰§è¡Œ SQL äº†ï¼ï¼ï¼ ğŸ˜
}
```

- **`OnTriggerChanged`ï¼šä½œä¸šè®¡åˆ’ `Scheduler` çš„è§¦å‘å™¨ `Trigger` å˜åŒ–æ—¶è°ƒç”¨ã€‚**

åªè¦ä½œä¸šè®¡åˆ’**è§¦å‘å™¨**æœ‰ä»»ä½•å˜åŒ–éƒ½å°†è§¦å‘è¯¥æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æœ‰ä¸€ä¸ª `PersistenceTriggerContext` ç±»å‹çš„å‚æ•° `context`ï¼Œ`PersistenceTriggerContext` ç»§æ‰¿è‡ª `PersistenceContext`ï¼š

- **`PersistenceTriggerContext` å±æ€§åˆ—è¡¨**
  - `JobId`ï¼šä½œä¸š `Id`ï¼Œ`string` ç±»å‹
  - `JobDetail`ï¼šä½œä¸šä¿¡æ¯ï¼Œ`JobDetail` ç±»å‹
  - `TriggerId`ï¼šä½œä¸šè§¦å‘å™¨ `Id`ï¼Œ`string` ç±»å‹
  - `Trigger`ï¼šä½œä¸šè§¦å‘å™¨ï¼Œ`Trigger` ç±»å‹
  - `Behavior`ï¼šæŒä¹…åŒ–è¡Œä¸ºï¼Œ`PersistenceBehavior` æšä¸¾ç±»å‹ï¼ŒåŒ…å« `Appended`ï¼Œ`Updated` å’Œ `Removed` ä¸‰ä¸ªæšä¸¾æˆå‘˜
- **`PersistenceTriggerContext` æ–¹æ³•åˆ—è¡¨**
  - `ConvertToSQL`ï¼šå°† `PersistenceTriggerContext` è½¬æ¢æˆ `SQL` å­—ç¬¦ä¸²ï¼Œ`Behavior` å±æ€§å€¼ä¸åŒï¼Œç”Ÿæˆçš„ `SQL` ä¸åŒ
  - `ConvertToJSON`ï¼šå°† `PersistenceTriggerContext` è½¬æ¢æˆ `JSON` å­—ç¬¦ä¸²ï¼ŒåªåŒ…å« `Trigger`
  - `ConvertAllToJSON`ï¼šå°† `PersistenceTriggerContext` è½¬æ¢æˆ `JSON` å­—ç¬¦ä¸²ï¼ŒåŒ…å« `JobDetail` å’Œ `Trigger`
  - `ConvertToMonitor`ï¼šå°† `PersistenceTriggerContext` è½¬æ¢æˆ `Monitor` å­—ç¬¦ä¸²
  - `ToString`ï¼šå°† `PersistenceTriggerContext` è½¬æ¢æˆ `ç®€è¦` å­—ç¬¦ä¸²
  - `GetNaming`ï¼šæä¾›å°†ç‰¹å®šå­—ç¬¦ä¸²è¾“å‡ºä¸åŒçš„å‘½åè§„åˆ™å­—ç¬¦ä¸²

```cs showLineNumbers {4,6,8,10}
public void OnTriggerChanged(PersistenceTriggerContext context)
{
      // è¾“å‡º CamelCaseï¼ˆé©¼å³°å‘½åæ³•ï¼‰SQL è¯­å¥ï¼Œé»˜è®¤å€¼
      var sql = context.ConvertToSQL("job_trigger");
      // è¾“å‡º Pascalï¼ˆå¸•æ–¯å¡å‘½åæ³•ï¼‰ SQL è¯­å¥
      var sql = context.ConvertToSQL("job_trigger", NamingConventions.Pascal);
      // è¾“å‡º UnderScoreCaseï¼ˆä¸‹åˆ’çº¿å‘½åæ³•ï¼‰ SQL è¯­å¥
      var sql = context.ConvertToSQL("job_trigger", NamingConventions.UnderScoreCase);

      // ä½ è¦åšçš„åªæ˜¯æ‰§è¡Œ SQL äº†ï¼ï¼ï¼ ğŸ˜
}
```

### 26.1.12.4 å„ç±»æ•°æ®åº“åˆ›å»ºä½œä¸šæŒä¹…åŒ–è¡¨è¯­å¥

<Tabs
  defaultValue="Sqlite"
  values={[
    {
      label: "Sqlite",
      value: "Sqlite",
    },
    {
      label: "SqlServer",
      value: "SqlServer",
    },
    {
      label: "MySQL",
      value: "MySQL",
    },
    {
      label: "PostgreSQL",
      value: "PostgreSQL",
    },
    {
      label: "Oracle",
      value: "Oracle",
    },
    {
      label: "Firebird",
      value: "Firebird",
    },
    {
      label: "EFCore",
      value: "EFCore",
    },
    {
      label: "SqlSugar",
      value: "SqlSugar",
    }
  ]}
>
  <TabItem value="Sqlite">

**å¯è‡ªè¡Œè°ƒæ•´åˆ—å‘½åè§„åˆ™ã€‚**

```sql showLineNumbers {1,14}
CREATE TABLE "JobDetails" (
    "Id" INTEGER NOT NULL CONSTRAINT "PK_JobDetails" PRIMARY KEY AUTOINCREMENT,
    "JobId" TEXT NOT NULL,
    "GroupName" TEXT NULL,
    "JobType" TEXT NULL,
    "AssemblyName" TEXT NULL,
    "Description" TEXT NULL,
    "Concurrent" INTEGER NOT NULL,
    "IncludeAnnotations" INTEGER NOT NULL,
    "Properties" TEXT NULL,
    "UpdatedTime" TEXT NULL
);

CREATE TABLE "JobTriggers" (
    "Id" INTEGER NOT NULL CONSTRAINT "PK_JobTriggers" PRIMARY KEY AUTOINCREMENT,
    "TriggerId" TEXT NOT NULL,
    "JobId" TEXT NOT NULL,
    "TriggerType" TEXT NULL,
    "AssemblyName" TEXT NULL,
    "Args" TEXT NULL,
    "Description" TEXT NULL,
    "Status" INTEGER NOT NULL,
    "StartTime" TEXT NULL,
    "EndTime" TEXT NULL,
    "LastRunTime" TEXT NULL,
    "NextRunTime" TEXT NULL,
    "NumberOfRuns" INTEGER NOT NULL,
    "MaxNumberOfRuns" INTEGER NOT NULL,
    "NumberOfErrors" INTEGER NOT NULL,
    "MaxNumberOfErrors" INTEGER NOT NULL,
    "NumRetries" INTEGER NOT NULL,
    "RetryTimeout" INTEGER NOT NULL,
    "StartNow" INTEGER NOT NULL,
    "RunOnStart" INTEGER NOT NULL,
    "ResetOnlyOnce" INTEGER NOT NULL,
    "UpdatedTime" TEXT NULL
);
```

  </TabItem>
  <TabItem value="SqlServer">

**å¯è‡ªè¡Œè°ƒæ•´åˆ—å‘½åè§„åˆ™ã€‚**

```sql showLineNumbers {1,16}
CREATE TABLE [JobDetails] (
    [Id] int NOT NULL IDENTITY,
    [JobId] nvarchar(max) NOT NULL,
    [GroupName] nvarchar(max) NULL,
    [JobType] nvarchar(max) NULL,
    [AssemblyName] nvarchar(max) NULL,
    [Description] nvarchar(max) NULL,
    [Concurrent] bit NOT NULL,
    [IncludeAnnotations] bit NOT NULL,
    [Properties] nvarchar(max) NULL,
    [UpdatedTime] datetime2 NULL,
    CONSTRAINT [PK_JobDetails] PRIMARY KEY ([Id])
);
GO

CREATE TABLE [JobTriggers] (
    [Id] int NOT NULL IDENTITY,
    [TriggerId] nvarchar(max) NOT NULL,
    [JobId] nvarchar(max) NOT NULL,
    [TriggerType] nvarchar(max) NULL,
    [AssemblyName] nvarchar(max) NULL,
    [Args] nvarchar(max) NULL,
    [Description] nvarchar(max) NULL,
    [Status] bigint NOT NULL,
    [StartTime] datetime2 NULL,
    [EndTime] datetime2 NULL,
    [LastRunTime] datetime2 NULL,
    [NextRunTime] datetime2 NULL,
    [NumberOfRuns] bigint NOT NULL,
    [MaxNumberOfRuns] bigint NOT NULL,
    [NumberOfErrors] bigint NOT NULL,
    [MaxNumberOfErrors] bigint NOT NULL,
    [NumRetries] int NOT NULL,
    [RetryTimeout] int NOT NULL,
    [StartNow] bit NOT NULL,
    [RunOnStart] bit NOT NULL,
    [ResetOnlyOnce] bit NOT NULL,
    [UpdatedTime] datetime2 NULL,
    CONSTRAINT [PK_JobTriggers] PRIMARY KEY ([Id])
);
```

  </TabItem>
  <TabItem value="MySQL">

**å¯è‡ªè¡Œè°ƒæ•´åˆ—å‘½åè§„åˆ™ã€‚**

```sql showLineNumbers {3,17}
ALTER DATABASE CHARACTER SET utf8mb4;

CREATE TABLE `JobDetails` (
    `Id` int NOT NULL AUTO_INCREMENT,
    `JobId` longtext CHARACTER SET utf8mb4 NOT NULL,
    `GroupName` longtext CHARACTER SET utf8mb4 NULL,
    `JobType` longtext CHARACTER SET utf8mb4 NULL,
    `AssemblyName` longtext CHARACTER SET utf8mb4 NULL,
    `Description` longtext CHARACTER SET utf8mb4 NULL,
    `Concurrent` tinyint(1) NOT NULL,
    `IncludeAnnotations` tinyint(1) NOT NULL,
    `Properties` longtext CHARACTER SET utf8mb4 NULL,
    `UpdatedTime` datetime(6) NULL,
    CONSTRAINT `PK_JobDetails` PRIMARY KEY (`Id`)
) CHARACTER SET=utf8mb4;

CREATE TABLE `JobTriggers` (
    `Id` int NOT NULL AUTO_INCREMENT,
    `TriggerId` longtext CHARACTER SET utf8mb4 NOT NULL,
    `JobId` longtext CHARACTER SET utf8mb4 NOT NULL,
    `TriggerType` longtext CHARACTER SET utf8mb4 NULL,
    `AssemblyName` longtext CHARACTER SET utf8mb4 NULL,
    `Args` longtext CHARACTER SET utf8mb4 NULL,
    `Description` longtext CHARACTER SET utf8mb4 NULL,
    `Status` int unsigned NOT NULL,
    `StartTime` datetime(6) NULL,
    `EndTime` datetime(6) NULL,
    `LastRunTime` datetime(6) NULL,
    `NextRunTime` datetime(6) NULL,
    `NumberOfRuns` bigint NOT NULL,
    `MaxNumberOfRuns` bigint NOT NULL,
    `NumberOfErrors` bigint NOT NULL,
    `MaxNumberOfErrors` bigint NOT NULL,
    `NumRetries` int NOT NULL,
    `RetryTimeout` int NOT NULL,
    `StartNow` tinyint(1) NOT NULL,
    `RunOnStart` tinyint(1) NOT NULL,
    `ResetOnlyOnce` tinyint(1) NOT NULL,
    `UpdatedTime` datetime(6) NULL,
    CONSTRAINT `PK_JobTriggers` PRIMARY KEY (`Id`)
) CHARACTER SET=utf8mb4;
```

  </TabItem>
  <TabItem value="PostgreSQL">

**å¯è‡ªè¡Œè°ƒæ•´åˆ—å‘½åè§„åˆ™ã€‚**

```sql showLineNumbers {1,15}
CREATE TABLE "JobDetails" (
    "Id" integer GENERATED BY DEFAULT AS IDENTITY,
    "JobId" text NOT NULL,
    "GroupName" text NULL,
    "JobType" text NULL,
    "AssemblyName" text NULL,
    "Description" text NULL,
    "Concurrent" boolean NOT NULL,
    "IncludeAnnotations" boolean NOT NULL,
    "Properties" text NULL,
    "UpdatedTime" timestamp with time zone NULL,
    CONSTRAINT "PK_JobDetails" PRIMARY KEY ("Id")
);

CREATE TABLE "JobTriggers" (
    "Id" integer GENERATED BY DEFAULT AS IDENTITY,
    "TriggerId" text NOT NULL,
    "JobId" text NOT NULL,
    "TriggerType" text NULL,
    "AssemblyName" text NULL,
    "Args" text NULL,
    "Description" text NULL,
    "Status" bigint NOT NULL,
    "StartTime" timestamp with time zone NULL,
    "EndTime" timestamp with time zone NULL,
    "LastRunTime" timestamp with time zone NULL,
    "NextRunTime" timestamp with time zone NULL,
    "NumberOfRuns" bigint NOT NULL,
    "MaxNumberOfRuns" bigint NOT NULL,
    "NumberOfErrors" bigint NOT NULL,
    "MaxNumberOfErrors" bigint NOT NULL,
    "NumRetries" integer NOT NULL,
    "RetryTimeout" integer NOT NULL,
    "StartNow" boolean NOT NULL,
    "RunOnStart" boolean NOT NULL,
    "ResetOnlyOnce" boolean NOT NULL,
    "UpdatedTime" timestamp with time zone NULL,
    CONSTRAINT "PK_JobTriggers" PRIMARY KEY ("Id")
);
```

  </TabItem>
  <TabItem value="Oracle">

**å¯è‡ªè¡Œè°ƒæ•´åˆ—å‘½åè§„åˆ™ã€‚**

```sql showLineNumbers {1,15}
CREATE TABLE "JobDetails" (
    "Id" NUMBER(10) GENERATED BY DEFAULT ON NULL AS IDENTITY NOT NULL,
    "JobId" NVARCHAR2(2000) NOT NULL,
    "GroupName" NVARCHAR2(2000),
    "JobType" NVARCHAR2(2000),
    "AssemblyName" NVARCHAR2(2000),
    "Description" NVARCHAR2(2000),
    "Concurrent" NUMBER(1) NOT NULL,
    "IncludeAnnotations" NUMBER(1) NOT NULL,
    "Properties" NVARCHAR2(2000),
    "UpdatedTime" TIMESTAMP(7),
    CONSTRAINT "PK_JobDetails" PRIMARY KEY ("Id")
);

CREATE TABLE "JobTriggers" (
    "Id" NUMBER(10) GENERATED BY DEFAULT ON NULL AS IDENTITY NOT NULL,
    "TriggerId" NVARCHAR2(2000) NOT NULL,
    "JobId" NVARCHAR2(2000) NOT NULL,
    "TriggerType" NVARCHAR2(2000),
    "AssemblyName" NVARCHAR2(2000),
    "Args" NVARCHAR2(2000),
    "Description" NVARCHAR2(2000),
    "Status" NUMBER(10) NOT NULL,
    "StartTime" TIMESTAMP(7),
    "EndTime" TIMESTAMP(7),
    "LastRunTime" TIMESTAMP(7),
    "NextRunTime" TIMESTAMP(7),
    "NumberOfRuns" NUMBER(19) NOT NULL,
    "MaxNumberOfRuns" NUMBER(19) NOT NULL,
    "NumberOfErrors" NUMBER(19) NOT NULL,
    "MaxNumberOfErrors" NUMBER(19) NOT NULL,
    "NumRetries" NUMBER(10) NOT NULL,
    "RetryTimeout" NUMBER(10) NOT NULL,
    "StartNow" NUMBER(1) NOT NULL,
    "RunOnStart" NUMBER(1) NOT NULL,
    "ResetOnlyOnce" NUMBER(1) NOT NULL,
    "UpdatedTime" TIMESTAMP(7),
    CONSTRAINT "PK_JobTriggers" PRIMARY KEY ("Id")
);
```

  </TabItem>
  <TabItem value="Firebird">

**å¯è‡ªè¡Œè°ƒæ•´åˆ—å‘½åè§„åˆ™ã€‚**

```sql showLineNumbers {1,15}
CREATE TABLE "JobDetails" (
    "Id" INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    "JobId" BLOB SUB_TYPE TEXT NOT NULL,
    "GroupName" BLOB SUB_TYPE TEXT,
    "JobType" BLOB SUB_TYPE TEXT,
    "AssemblyName" BLOB SUB_TYPE TEXT,
    "Description" BLOB SUB_TYPE TEXT,
    "Concurrent" BOOLEAN NOT NULL,
    "IncludeAnnotations" BOOLEAN NOT NULL,
    "Properties" BLOB SUB_TYPE TEXT,
    "UpdatedTime" TIMESTAMP,
    CONSTRAINT "PK_JobDetails" PRIMARY KEY ("Id")
);

CREATE TABLE "JobTriggers" (
    "Id" INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    "TriggerId" BLOB SUB_TYPE TEXT NOT NULL,
    "JobId" BLOB SUB_TYPE TEXT NOT NULL,
    "TriggerType" BLOB SUB_TYPE TEXT,
    "AssemblyName" BLOB SUB_TYPE TEXT,
    "Args" BLOB SUB_TYPE TEXT,
    "Description" BLOB SUB_TYPE TEXT,
    "Status" BIGINT NOT NULL,
    "StartTime" TIMESTAMP,
    "EndTime" TIMESTAMP,
    "LastRunTime" TIMESTAMP,
    "NextRunTime" TIMESTAMP,
    "NumberOfRuns" BIGINT NOT NULL,
    "MaxNumberOfRuns" BIGINT NOT NULL,
    "NumberOfErrors" BIGINT NOT NULL,
    "MaxNumberOfErrors" BIGINT NOT NULL,
    "NumRetries" INTEGER NOT NULL,
    "RetryTimeout" INTEGER NOT NULL,
    "StartNow" BOOLEAN NOT NULL,
    "RunOnStart" BOOLEAN NOT NULL,
    "ResetOnlyOnce" BOOLEAN NOT NULL,
    "UpdatedTime" TIMESTAMP,
    CONSTRAINT "PK_JobTriggers" PRIMARY KEY ("Id")
);
```

  </TabItem>
  <TabItem value="EFCore">

**å¯è‡ªè¡Œè°ƒæ•´åˆ—å‘½åè§„åˆ™ã€‚**

```cs showLineNumbers {1,56}
public class JobDetail
{
    [Key]
    [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
    public int Id { get; set; }

    /// <summary>
    /// ä½œä¸š Id
    /// </summary>
    public string JobId { get; set; }

    /// <summary>
    /// ä½œä¸šç»„åç§°
    /// </summary>
    public string? GroupName { get; set; }

    /// <summary>
    /// ä½œä¸šå¤„ç†ç¨‹åºç±»å‹
    /// </summary>
    /// <remarks>å­˜å‚¨çš„æ˜¯ç±»å‹çš„ FullName</remarks>
    public string? JobType { get; set; }

    /// <summary>
    /// ä½œä¸šå¤„ç†ç¨‹åºç±»å‹æ‰€åœ¨ç¨‹åºé›†
    /// </summary>
    /// <remarks>å­˜å‚¨çš„æ˜¯ç¨‹åºé›† Name</remarks>
    public string? AssemblyName { get; set; }

    /// <summary>
    /// æè¿°ä¿¡æ¯
    /// </summary>
    public string? Description { get; set; }

    /// <summary>
    /// æ˜¯å¦é‡‡ç”¨å¹¶è¡Œæ‰§è¡Œ
    /// </summary>
    /// <remarks>å¦‚æœè®¾ç½®ä¸º falseï¼Œé‚£ä¹ˆä½¿ç”¨ä¸²è¡Œæ‰§è¡Œ</remarks>
    public bool Concurrent { get; set; } = true;

    /// <summary>
    /// æ˜¯å¦æ‰«æ IJob å®ç°ç±» [Trigger] ç‰¹æ€§è§¦å‘å™¨
    /// </summary>
    public bool IncludeAnnotations { get; set; } = false;

    /// <summary>
    /// ä½œä¸šä¿¡æ¯é¢å¤–æ•°æ®
    /// </summary>
    public string? Properties { get; set; } = "{}";

    /// <summary>
    /// ä½œä¸šæ›´æ–°æ—¶é—´
    /// </summary>
    public DateTime? UpdatedTime { get; set; }
}

public class JobTrigger
{
    [Key]
    [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
    public int Id { get; set; }

    /// <summary>
    /// ä½œä¸šè§¦å‘å™¨ Id
    /// </summary>
    public string TriggerId { get; set; }

    /// <summary>
    /// ä½œä¸š Id
    /// </summary>
    public string JobId { get; set; }

    /// <summary>
    /// ä½œä¸šè§¦å‘å™¨ç±»å‹
    /// </summary>
    /// <remarks>å­˜å‚¨çš„æ˜¯ç±»å‹çš„ FullName</remarks>
    public string? TriggerType { get; set; }

    /// <summary>
    /// ä½œä¸šè§¦å‘å™¨ç±»å‹æ‰€åœ¨ç¨‹åºé›†
    /// </summary>
    /// <remarks>å­˜å‚¨çš„æ˜¯ç¨‹åºé›† Name</remarks>
    public string? AssemblyName { get; set; }

    /// <summary>
    /// ä½œä¸šè§¦å‘å™¨å‚æ•°
    /// </summary>
    /// <remarks>è¿è¡Œæ—¶å°†ååºåˆ—åŒ–ä¸º object[] ç±»å‹å¹¶ä½œä¸ºæ„é€ å‡½æ•°å‚æ•°</remarks>
    public string? Args { get; set; }

    /// <summary>
    /// æè¿°ä¿¡æ¯
    /// </summary>
    public string? Description { get; set; }

    /// <summary>
    /// ä½œä¸šè§¦å‘å™¨çŠ¶æ€
    /// </summary>
    public TriggerStatus Status { get; set; } = TriggerStatus.Ready;

    /// <summary>
    /// èµ·å§‹æ—¶é—´
    /// </summary>
    public DateTime? StartTime { get; set; }

    /// <summary>
    /// ç»“æŸæ—¶é—´
    /// </summary>
    public DateTime? EndTime { get; set; }

    /// <summary>
    /// æœ€è¿‘è¿è¡Œæ—¶é—´
    /// </summary>
    public DateTime? LastRunTime { get; set; }

    /// <summary>
    /// ä¸‹ä¸€æ¬¡è¿è¡Œæ—¶é—´
    /// </summary>
    public DateTime? NextRunTime { get; set; }

    /// <summary>
    /// è§¦å‘æ¬¡æ•°
    /// </summary>
    public long NumberOfRuns { get; set; }

    /// <summary>
    /// æœ€å¤§è§¦å‘æ¬¡æ•°
    /// </summary>
    /// <remarks>
    /// <para>0ï¼šä¸é™åˆ¶</para>
    /// <para>nï¼šN æ¬¡</para>
    /// </remarks>
    public long MaxNumberOfRuns { get; set; }

    /// <summary>
    /// å‡ºé”™æ¬¡æ•°
    /// </summary>
    public long NumberOfErrors { get; set; }

    /// <summary>
    /// æœ€å¤§å‡ºé”™æ¬¡æ•°
    /// </summary>
    /// <remarks>
    /// <para>0ï¼šä¸é™åˆ¶</para>
    /// <para>nï¼šN æ¬¡</para>
    /// </remarks>
    public long MaxNumberOfErrors { get; set; }

    /// <summary>
    /// é‡è¯•æ¬¡æ•°
    /// </summary>
    public int NumRetries { get; set; } = 0;

    /// <summary>
    /// é‡è¯•é—´éš”æ—¶é—´
    /// </summary>
    /// <remarks>é»˜è®¤1000æ¯«ç§’</remarks>
    public int RetryTimeout { get; set; } = 1000;

    /// <summary>
    /// æ˜¯å¦ç«‹å³å¯åŠ¨
    /// </summary>
    public bool StartNow { get; set; } = true;

    /// <summary>
    /// æ˜¯å¦å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡
    /// </summary>
    public bool RunOnStart { get; set; } = false;

    /// <summary>
    /// æ˜¯å¦åœ¨å¯åŠ¨æ—¶é‡ç½®æœ€å¤§è§¦å‘æ¬¡æ•°ç­‰äºä¸€æ¬¡çš„ä½œä¸š
    /// </summary>
    /// <remarks>è§£å†³å› æŒä¹…åŒ–æ•°æ®å·²å®Œæˆä¸€æ¬¡è§¦å‘ä½†å¯åŠ¨æ—¶ä¸å†æ‰§è¡Œçš„é—®é¢˜</remarks>
    public bool ResetOnlyOnce { get; set; } = true;

    /// <summary>
    /// ä½œä¸šè§¦å‘å™¨æ›´æ–°æ—¶é—´
    /// </summary>
    public DateTime? UpdatedTime { get; set; }
}
```

  </TabItem>
  <TabItem value="SqlSugar">

**å¯è‡ªè¡Œè°ƒæ•´åˆ—å‘½åè§„åˆ™ã€‚**

```cs showLineNumbers {2,66}
[SugarTable("JobDetail", "ä½œä¸šä¿¡æ¯è¡¨")]
public class JobDetail
{
    /// <summary>
    /// Id
    /// </summary>
    [SugarColumn(ColumnDescription = "Id", IsPrimaryKey = true, IsIdentity = true)]
    public virtual long Id { get; set; }

    /// <summary>
    /// ä½œä¸š Id
    /// </summary>
    [SugarColumn(ColumnDescription = "ä½œä¸šId")]
    public virtual string JobId { get; set; }

    /// <summary>
    /// ç»„åç§°
    /// </summary>
    [SugarColumn(ColumnDescription = "ç»„åç§°")]
    public string? GroupName { get; set; }

    /// <summary>
    /// ä½œä¸šç±»å‹ FullName
    /// </summary>
    [SugarColumn(ColumnDescription = "ä½œä¸šç±»å‹")]
    public string? JobType { get; set; }

    /// <summary>
    /// ç¨‹åºé›† Name
    /// </summary>
    [SugarColumn(ColumnDescription = "ç¨‹åºé›†")]
    public string? AssemblyName { get; set; }

    /// <summary>
    /// æè¿°ä¿¡æ¯
    /// </summary>
    [SugarColumn(ColumnDescription = "æè¿°ä¿¡æ¯")]
    public string? Description { get; set; }

    /// <summary>
    /// æ˜¯å¦å¹¶è¡Œæ‰§è¡Œ
    /// </summary>
    [SugarColumn(ColumnDescription = "æ˜¯å¦å¹¶è¡Œæ‰§è¡Œ")]
    public bool Concurrent { get; set; } = true;

    /// <summary>
    /// æ˜¯å¦æ‰«æç‰¹æ€§è§¦å‘å™¨
    /// </summary>
    [SugarColumn(ColumnDescription = "æ˜¯å¦æ‰«æç‰¹æ€§è§¦å‘å™¨")]
    public bool IncludeAnnotations { get; set; } = false;

    /// <summary>
    /// é¢å¤–æ•°æ®
    /// </summary>
    [SugarColumn(ColumnDescription = "é¢å¤–æ•°æ®", ColumnDataType = "longtext,text,clob")]
    public string? Properties { get; set; } = "{}";

    /// <summary>
    /// æ›´æ–°æ—¶é—´
    /// </summary>
    [SugarColumn(ColumnDescription = "æ›´æ–°æ—¶é—´")]
    public DateTime? UpdatedTime { get; set; }
}

[SugarTable("JobTrigger", "ä½œä¸šè§¦å‘å™¨è¡¨")]
public class JobTrigger
{
    /// <summary>
    /// Id
    /// </summary>
    [SugarColumn(ColumnDescription = "Id", IsPrimaryKey = true, IsIdentity = true)]
    public virtual long Id { get; set; }

    /// <summary>
    /// è§¦å‘å™¨ Id
    /// </summary>
    [SugarColumn(ColumnDescription = "è§¦å‘å™¨Id")]
    public virtual string TriggerId { get; set; }

    /// <summary>
    /// ä½œä¸š Id
    /// </summary>
    [SugarColumn(ColumnDescription = "ä½œä¸šId")]
    public virtual string JobId { get; set; }

    /// <summary>
    /// è§¦å‘å™¨ç±»å‹ FullName
    /// </summary>
    [SugarColumn(ColumnDescription = "è§¦å‘å™¨ç±»å‹")]
    public string? TriggerType { get; set; }

    /// <summary>
    /// ç¨‹åºé›† Name
    /// </summary>
    [SugarColumn(ColumnDescription = "ç¨‹åºé›†")]
    public string? AssemblyName { get; set; }

    /// <summary>
    /// å‚æ•°
    /// </summary>
    [SugarColumn(ColumnDescription = "å‚æ•°")]
    public string? Args { get; set; }

    /// <summary>
    /// æè¿°ä¿¡æ¯
    /// </summary>
    [SugarColumn(ColumnDescription = "æè¿°ä¿¡æ¯")]
    public string? Description { get; set; }

    /// <summary>
    /// çŠ¶æ€
    /// </summary>
    [SugarColumn(ColumnDescription = "çŠ¶æ€")]
    public TriggerStatus Status { get; set; } = TriggerStatus.Ready;

    /// <summary>
    /// èµ·å§‹æ—¶é—´
    /// </summary>
    [SugarColumn(ColumnDescription = "èµ·å§‹æ—¶é—´")]
    public DateTime? StartTime { get; set; }

    /// <summary>
    /// ç»“æŸæ—¶é—´
    /// </summary>
    [SugarColumn(ColumnDescription = "ç»“æŸæ—¶é—´")]
    public DateTime? EndTime { get; set; }

    /// <summary>
    /// æœ€è¿‘è¿è¡Œæ—¶é—´
    /// </summary>
    [SugarColumn(ColumnDescription = "æœ€è¿‘è¿è¡Œæ—¶é—´")]
    public DateTime? LastRunTime { get; set; }

    /// <summary>
    /// ä¸‹ä¸€æ¬¡è¿è¡Œæ—¶é—´
    /// </summary>
    [SugarColumn(ColumnDescription = "ä¸‹ä¸€æ¬¡è¿è¡Œæ—¶é—´")]
    public DateTime? NextRunTime { get; set; }

    /// <summary>
    /// è§¦å‘æ¬¡æ•°
    /// </summary>
    [SugarColumn(ColumnDescription = "è§¦å‘æ¬¡æ•°")]
    public long NumberOfRuns { get; set; }

    /// <summary>
    /// æœ€å¤§è§¦å‘æ¬¡æ•°ï¼ˆ0:ä¸é™åˆ¶ï¼Œn:Næ¬¡ï¼‰
    /// </summary>
    [SugarColumn(ColumnDescription = "æœ€å¤§è§¦å‘æ¬¡æ•°")]
    public long MaxNumberOfRuns { get; set; }

    /// <summary>
    /// å‡ºé”™æ¬¡æ•°
    /// </summary>
    [SugarColumn(ColumnDescription = "å‡ºé”™æ¬¡æ•°")]
    public long NumberOfErrors { get; set; }

    /// <summary>
    /// æœ€å¤§å‡ºé”™æ¬¡æ•°ï¼ˆ0:ä¸é™åˆ¶ï¼Œn:Næ¬¡ï¼‰
    /// </summary>
    [SugarColumn(ColumnDescription = "æœ€å¤§å‡ºé”™æ¬¡æ•°")]
    public long MaxNumberOfErrors { get; set; }

    /// <summary>
    /// é‡è¯•æ¬¡æ•°
    /// </summary>
    [SugarColumn(ColumnDescription = "é‡è¯•æ¬¡æ•°")]
    public int NumRetries { get; set; }

    /// <summary>
    /// é‡è¯•é—´éš”æ—¶é—´ï¼ˆmsï¼‰
    /// </summary>
    [SugarColumn(ColumnDescription = "é‡è¯•é—´éš”æ—¶é—´(ms)")]
    public int RetryTimeout { get; set; } = 1000;

    /// <summary>
    /// æ˜¯å¦ç«‹å³å¯åŠ¨
    /// </summary>
    [SugarColumn(ColumnDescription = "æ˜¯å¦ç«‹å³å¯åŠ¨")]
    public bool StartNow { get; set; } = true;

    /// <summary>
    /// æ˜¯å¦å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡
    /// </summary>
    [SugarColumn(ColumnDescription = "æ˜¯å¦å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡")]
    public bool RunOnStart { get; set; } = false;

    /// <summary>
    /// æ˜¯å¦åœ¨å¯åŠ¨æ—¶é‡ç½®æœ€å¤§è§¦å‘æ¬¡æ•°ç­‰äºä¸€æ¬¡çš„ä½œä¸š
    /// </summary>
    /// <remarks>è§£å†³å› æŒä¹…åŒ–æ•°æ®å·²å®Œæˆä¸€æ¬¡è§¦å‘ä½†å¯åŠ¨æ—¶ä¸å†æ‰§è¡Œçš„é—®é¢˜</remarks>
    [SugarColumn(ColumnDescription = "æ˜¯å¦åœ¨å¯åŠ¨æ—¶é‡ç½®æœ€å¤§è§¦å‘æ¬¡æ•°ç­‰äºä¸€æ¬¡çš„ä½œä¸š")]
    public bool ResetOnlyOnce { get; set; } = true;

    /// <summary>
    /// æ›´æ–°æ—¶é—´
    /// </summary>
    [SugarColumn(ColumnDescription = "æ›´æ–°æ—¶é—´")]
    public DateTime? UpdatedTime { get; set; }
}
```

  </TabItem>
</Tabs>

## 26.1.13 ä½œä¸šé›†ç¾¤æ§åˆ¶

æ¡†æ¶æä¾›ç®€å•çš„é›†ç¾¤åŠŸèƒ½ï¼Œä½†å¹¶ä¸èƒ½è¾¾åˆ°è´Ÿè½½å‡è¡¡çš„æ•ˆæœï¼Œè€Œä»…ä»…æä¾›äº†æ•…éšœè½¬ç§»çš„åŠŸèƒ½ï¼Œå½“ä¸€ä¸ªæœåŠ¡çš„ä½œä¸šè°ƒåº¦å™¨å®•æœºæ—¶ï¼Œå¦ä¸€ä¸ªæœåŠ¡çš„ä½œä¸šè°ƒåº¦å™¨ä¼šå¯åŠ¨ã€‚

### 26.1.13.1 å®ç°é›†ç¾¤æ•…éšœè½¬ç§»

1. **åˆ›å»º `JobClusterServer` ç±»å¹¶å®ç° `IJobClusterServer`**

```cs showLineNumbers {1,9,21-37,46,55,65}
public class JobClusterServer : IJobClusterServer
{
    /// <summary>
    /// å½“å‰ä½œä¸šè°ƒåº¦å™¨å¯åŠ¨é€šçŸ¥
    /// </summary>
    /// <param name="context">ä½œä¸šé›†ç¾¤æœåŠ¡ä¸Šä¸‹æ–‡</param>
    public void Start(JobClusterContext context)
    {
        // åœ¨ä½œä¸šé›†ç¾¤è¡¨ä¸­ï¼Œå¦‚æœ clusterId ä¸å­˜åœ¨ï¼Œåˆ™æ–°å¢ä¸€æ¡ï¼ˆå¦åˆ™æ›´æ–°ä¸€æ¡ï¼‰ï¼Œå¹¶è®¾ç½® status ä¸º ClusterStatus.Waiting
    }

    /// <summary>
    /// ç­‰å¾…è¢«å”¤é†’
    /// </summary>
    /// <param name="context">ä½œä¸šé›†ç¾¤æœåŠ¡ä¸Šä¸‹æ–‡</param>
    /// <returns><see cref="Task"/></returns>
    public async Task WaitingForAsync(JobClusterContext context)
    {
        var clusterId = context.ClusterId;

        while (true)
        {
            try
            {
                // åœ¨è¿™é‡ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œæ ¹æ®ä»¥ä¸‹ä¸¤ç§æƒ…å†µå¤„ç†
                // 1) å¦‚æœä½œä¸šé›†ç¾¤è¡¨å·²æœ‰ status ä¸º ClusterStatus.Working åˆ™ç»§ç»­å¾ªç¯
                // 2) å¦‚æœä½œä¸šé›†ç¾¤è¡¨ä¸­è¿˜æ²¡æœ‰å…¶ä»–æœåŠ¡æˆ–åªæœ‰è‡ªå·±ï¼Œåˆ™æ’å…¥ä¸€æ¡é›†ç¾¤æœåŠ¡æˆ–è°ƒç”¨ await WorkNowAsync(clusterId); ä¹‹å return;
                // 3) å¦‚æœä½œä¸šé›†ç¾¤è¡¨ä¸­æ²¡æœ‰ status ä¸º ClusterStatus.Working çš„ï¼Œè°ƒç”¨ await WorkNowAsync(clusterId); ä¹‹å return;

                await WorkNowAsync(clusterId);
                return;
            }
            catch { }

            // æ§åˆ¶é›†ç¾¤å¿ƒè·³é¢‘ç‡
            await Task.Delay(3000);
        }
    }

    /// <summary>
    /// å½“å‰ä½œä¸šè°ƒåº¦å™¨åœæ­¢é€šçŸ¥
    /// </summary>
    /// <param name="context">ä½œä¸šé›†ç¾¤æœåŠ¡ä¸Šä¸‹æ–‡</param>
    public void Stop(JobClusterContext context)
    {
        // åœ¨ä½œä¸šé›†ç¾¤è¡¨ä¸­ï¼Œæ›´æ–° clusterId çš„ status ä¸º ClusterStatus.Crashed
    }

    /// <summary>
    /// å½“å‰ä½œä¸šè°ƒåº¦å™¨å®•æœº
    /// </summary>
    /// <param name="context">ä½œä¸šé›†ç¾¤æœåŠ¡ä¸Šä¸‹æ–‡</param>
    public void Crash(JobClusterContext context)
    {
        // åœ¨ä½œä¸šé›†ç¾¤è¡¨ä¸­ï¼Œæ›´æ–° clusterId çš„ status ä¸º ClusterStatus.Crashed
    }

    /// <summary>
    /// æŒ‡ç¤ºé›†ç¾¤å¯ä»¥å·¥ä½œ
    /// </summary>
    /// <param name="clusterId">é›†ç¾¤ Id</param>
    /// <returns></returns>
    private Task WorkNowAsync(string clusterId)
    {
        // åœ¨ä½œä¸šé›†ç¾¤è¡¨ä¸­ï¼Œæ›´æ–° clusterId çš„ status ä¸º ClusterStatus.Working

        return Task.CompletedTask;
    }
}
```

2. **æ³¨å†Œé›†ç¾¤æœåŠ¡**

```cs showLineNumbers {3-4}
services.AddSchedule(options =>
{
      options.ClusterId = "cluster1";
      options.AddClusterServer<JobClusterServer>();
});
```

3. **ä½œä¸šé›†ç¾¤è¾“å‡ºæ—¥å¿—**

```bash showLineNumbers {4,6,8,12}
info: 2022-11-23 14:08:35.4253321 +08:00 æ˜ŸæœŸä¸‰ L System.Logging.ScheduleService[0] #1
      Schedule Hosted Service is running.
info: 2022-11-23 14:08:35.4391070 +08:00 æ˜ŸæœŸä¸‰ L System.Logging.ScheduleService[0] #1
      The job cluster of <cluster1> service has been enabled, waiting for instructions.
warn: 2022-11-23 14:08:38.4590092 +08:00 æ˜ŸæœŸä¸‰ L System.Logging.ScheduleService[0] #8
      The job cluster of <cluster1> service has been enabled, and the current job scheduler can work normally.
warn: 2022-11-23 14:08:38.4823786 +08:00 æ˜ŸæœŸä¸‰ L System.Logging.ScheduleService[0] #8
      Schedule Hosted Service cancels hibernation and GC.Collect().
info: 2022-11-23 14:08:38.4909379 +08:00 æ˜ŸæœŸä¸‰ L System.Logging.ScheduleService[0] #8
      The Scheduler of <job1> successfully updated to the schedule.
info: 2022-11-23 14:08:43.5211812 +08:00 æ˜ŸæœŸä¸‰ L ConsoleApp32.MyJob[0] #15
      <job1>   <job1 job1_trigger1>  5000ms 2022/11/23 14:08:43
```

### 26.1.13.2 ä½œä¸šé›†ç¾¤æ•°æ®åº“è¡¨è®¾è®¡

åªéœ€åŒ…å« `Id`ï¼Œ`ClusterId`ï¼Œ`Description`ï¼Œ`Status`ï¼Œ`UpdatedTime` å­—æ®µå³å¯ï¼Œå…¶ä¸­ `Status` æ˜¯ `ClusterStatus` æšä¸¾ç±»å‹ã€‚

- **`ClusterStatus`** åŒ…å«ä»¥ä¸‹æšä¸¾æˆå‘˜
  - `Crashed`ï¼šå®•æœº
  - `Working`ï¼šæ­£å¸¸å·¥ä½œ
  - `Waiting`ï¼šç­‰å¾…è¢«å”¤é†’ï¼Œé»˜è®¤å€¼

### 26.1.13.3 å¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡

æ¡†æ¶åªæä¾›äº†ç®€å•çš„æ•…éšœè½¬ç§»çš„é›†ç¾¤åŠŸèƒ½ï¼Œå¦‚éœ€å®ç°è´Ÿè½½å‡è¡¡ï¼Œå¯é€šè¿‡ `TCP/IP` å¥—æ¥å­—å®ç°ï¼Œè¿™é‡Œçœ‹åç»­éœ€æ±‚ï¼Œå¦‚æœéœ€æ±‚å¤§ï¼Œå°±æŠŠå®Œæ•´çš„è´Ÿè½½å‡è¡¡ä¾‹å­è¡¥ä¸Šã€‚

## 26.1.14 `ScheduleServe` é™æ€ç±»

è¯¥åŠŸèƒ½ **å»ºè®®** ä»…é™ä¸èƒ½é€šè¿‡ `services.AddXXX` æ–¹å¼ä½¿ç”¨ï¼Œæ¯”å¦‚æ§åˆ¶å°ï¼Œ`Winfrom/WPF` ç­‰ã€‚

```cs showLineNumbers {1,3}
IDisposable dispose =  ScheduleServe.Run(options =>
{
    options.AddJob<MyJob>(Triggers.Secondly());
});
```

è¿™ç§æ–¹å¼æœ‰ä¸€ä¸ªéšè—çš„å·¨å¤§éšè— â€œéªšæ“ä½œâ€ï¼š**å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹åˆ›å»ºä½œä¸šè°ƒåº¦æœåŠ¡ï¼Œå¤šæ¬¡è°ƒç”¨å¯ä»¥åˆ›å»ºå¤šä¸ªä½œä¸šè°ƒåº¦å™¨ã€‚**

:::tip æ¨èä½¿ç”¨ `Serve.Run()` æˆ– `Serve.RunGeneric()` æ–¹å¼æ›¿ä»£

`Furion` æ¡†æ¶æä¾›äº† `Serve.Run()` æ–¹å¼æ”¯æŒè·¨å¹³å°ä½¿ç”¨ï¼Œè¿˜èƒ½æ”¯æŒæ³¨å†Œæ›´å¤šæœåŠ¡ï¼Œå¦‚ï¼š

```cs showLineNumbers {1,3,5}
Serve.Run(services =>
{
    services.AddSchedule(options =>
    {
        options.Add<MyJob>(Triggers.Secondly());
    });
})
```

å¦‚æ— éœ€ `Web` åŠŸèƒ½ï¼Œå¯é€šè¿‡ `Serve.RunGeneric` æ›¿ä»£ `Serve.Run`ã€‚

:::

## 26.1.15 å¦‚ä½•éƒ¨ç½²

å¦‚æœåœ¨é¡¹ç›®ä¸­ä½¿ç”¨äº†å®šæ—¶ä»»åŠ¡ä¸”éƒ¨ç½²åˆ° `IIS` ä¸­ï¼Œé‚£ä¹ˆéœ€è¦è®¾ç½® `IIS` ç¦æ­¢å›æ”¶ï¼Œ[ç‚¹å‡»æŸ¥çœ‹ `IIS` å›æ”¶é—®é¢˜è§£å†³æ–¹æ¡ˆ](/docs/deploy-iis#3415-iis-%E5%9B%9E%E6%94%B6%E9%97%AE%E9%A2%98%E5%92%8C%E9%85%8D%E7%BD%AE)

:::warning éƒ¨ç½²å»ºè®®

å»ºè®®å®šæ—¶ä»»åŠ¡é‡‡ç”¨ `Worker Service` ç‹¬ç«‹éƒ¨ç½²æ–¹å¼ï¼Œä¸åº”ä¾æ‰˜ `Web` é¡¹ç›®è¿›ç¨‹ä¸­ã€‚[æŸ¥çœ‹ã€ Worker Serviceã€‘ç« èŠ‚](/docs/process-service.mdx)

:::

## 26.1.16 å¸¸è§é—®é¢˜

### 26.1.16.1 ä½œä¸šè§¦å‘æ—¶é—´å­˜åœ¨åå·®

é€šå¸¸æˆ‘ä»¬ä¼šåœ¨ `IJob` å®ç°ç±»å‹ä¸­è·å–å½“å‰æ—¶é—´ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶é—´å¯èƒ½å­˜åœ¨ç€æå°çš„è¯¯å·®ï¼Œå¦‚ï¼š

```cs showLineNumbers {5,8}
public class MyJob : IJob
{
    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        var nowTime = DateTime.Now; // æ­¤æ—¶çš„æ—¶é—´æœªå¿…æ˜¯çœŸå®è§¦å‘æ—¶é—´ï¼Œå› ä¸ºè¿˜åŒ…å«åˆ›å»ºçº¿ç¨‹ï¼Œåˆå§‹åŒ–ç­‰ç­‰æ—¶é—´

        // æ­£ç¡®çš„åšæ³•æ˜¯
        var nowTime = context.OccurrenceTime;
    }
}
```

## 26.1.17 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::
