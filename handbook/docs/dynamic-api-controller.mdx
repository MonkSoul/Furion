---
id: dynamic-api-controller
title: 5.1 åŠ¨æ€ WebAPI
sidebar_label: 5.1 åŠ¨æ€ WebAPI
description: ä¸æƒ³æ‰‹åŠ¨é…ç½®è·¯ç”±äº†ï¼Œè¯•è¯•å®ƒ
---

import Tag from "@site/src/components/Tag.js";
import useBaseUrl from "@docusaurus/useBaseUrl";

<details>
  <summary>ğŸ“ æ¨¡å—æ›´æ–°æ—¥å¿—</summary>
  <div>
<div>

- **æ–°ç‰¹æ€§**

  - &nbsp;<Tag>æ–°å¢</Tag> åŠ¨æ€ `WebAPI` æ”¯æŒ `text/plain` æ ¼å¼çš„ `Body` å‚æ•° <sup>4.8.8.9</sup> <sup>â±ï¸2023.05.04</sup> [b49fe50](https://gitee.com/dotnetchina/Furion/commit/b49fe5087cdf97b04b7c2c9d90231f1b9d5fc6ee)
  - &nbsp;<Tag>æ–°å¢</Tag> **æ’ä»¶åŒ– `IDynamicApiRuntimeChangeProvider` æ¥å£ï¼Œå¯åœ¨è¿è¡Œæ—¶åŠ¨æ€æ·»åŠ  `WebAPI/Controller`** <sup>4.8.8.8</sup> <sup>â±ï¸2023.05.04</sup> [322ea59](https://gitee.com/dotnetchina/Furion/commit/322ea599ed58b1804e9f8ab85d7ed44882b3e5a8)

<details style={{ marginLeft: 50 }}>
  <summary>æŸ¥çœ‹å˜åŒ–</summary>
  <div>

åœ¨ä¸€äº›ç‰¹å®šçš„éœ€æ±‚ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¿è¡Œæ—¶**åŠ¨æ€ç¼–è¯‘ä»£ç ï¼Œå¦‚åŠ¨æ€ç¼–å†™ `WebAPI`**ï¼Œä¹‹åèƒ½å¤Ÿåœ¨ä¸é‡å¯ä¸»æœºæœåŠ¡çš„æƒ…å†µä¸‹å³å¯æœ‰æ•ˆã€‚æ¯”å¦‚è¿™é‡ŒåŠ¨æ€æ·»åŠ  `SomeClass` åŠ¨æ€ `WebAPI`ï¼Œç„¶ååœ¨ `Swagger/è·¯ç”±ç³»ç»Ÿ` ä¸­ç«‹å³æœ‰æ•ˆï¼š

```cs showLineNumbers {10,21-30,36-39}
using Furion;
using Furion.DynamicApiController;
using Microsoft.AspNetCore.Mvc;

namespace YourProject.Application;

public class PluginApiServices : IDynamicApiController
{
    private readonly IDynamicApiRuntimeChangeProvider _provider;
    public PluginApiServices(IDynamicApiRuntimeChangeProvider provider)
    {
        _provider = provider;
    }

    /// <summary>
    /// åŠ¨æ€æ·»åŠ  WebAPI/Controller
    /// </summary>
    /// <param name="csharpCode"></param>
    /// <param name="assemblyName">å¯è‡ªè¡ŒæŒ‡å®šç¨‹åºé›†åç§°</param>
    /// <returns></returns>
    public string Compile([FromBody] string csharpCode, [FromQuery] string assemblyName = default)
    {
        // ç¼–è¯‘ C# ä»£ç å¹¶è¿”å›åŠ¨æ€ç¨‹åºé›†
        var dynamicAssembly = App.CompileCSharpClassCode(csharpCode, assemblyName);

        // å°†ç¨‹åºé›†æ·»åŠ è¿›åŠ¨æ€ WebAPI åº”ç”¨éƒ¨ä»¶
        _provider.AddAssembliesWithNotifyChanges(dynamicAssembly);

        // è¿”å›åŠ¨æ€ç¨‹åºé›†åç§°
        return dynamicAssembly.GetName().Name;
    }

    /// <summary>
    /// ç§»é™¤åŠ¨æ€ç¨‹åºé›† WebAPI/Controller
    /// </summary>
    public void Remove(string assemblyName)
    {
        _provider.RemoveAssembliesWithNotifyChanges(assemblyName);
    }
}
```

è¿™æ—¶åªéœ€è¦è¯·æ±‚ `api/plugin-api/compile` æ¥å£åŒæ—¶è®¾ç½®è¯·æ±‚ `Content-Type` ä¸º `text/plain`ï¼Œæ¥ä¸‹æ¥ä¼ å…¥ `C# ä»£ç å­—ç¬¦ä¸²` å³å¯ï¼Œå¦‚ï¼š

```cs showLineNumbers title="åŠ¨æ€C#ä»£ç å­—ç¬¦ä¸²"
using Furion.DynamicApiController;

namespace YourProject.Application;

public class SomeClass : IDynamicApiController
{
    public string GetName()
    {
        return nameof(Furion);
    }
}
```

<img src={useBaseUrl("img/dr1.png")} />

ä¹‹ååˆ·æ–°æµè§ˆå™¨å³å¯çœ‹åˆ°æœ€æ–°çš„ `API`ï¼š

<img src={useBaseUrl("img/dr2.png")} />

è¿˜å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€å¸è½½ï¼Œä½¿ç”¨ `DELETE` è¯·æ±‚ `api/plugin-api` å³å¯ã€‚

  </div>
</details>

- - &nbsp;<Tag>æ–°å¢</Tag> **åŠ¨æ€ `WebAPI` è‡ªåŠ¨æ£€æŸ¥è·¯ç”±æ˜¯å¦åŒ…å«é‡å¤å‚æ•°ï¼Œå¦‚æœæœ‰è‡ªåŠ¨ä¿®æ­£è€Œä¸æ˜¯æŠ›å¼‚å¸¸** <sup>4.8.6.5</sup> <sup>â±ï¸2023.02.17</sup> [5f15ea1](https://gitee.com/dotnetchina/Furion/commit/5f15ea1edd2e7793d86dd074ffbbecbebf7f683f)

<details style={{ marginLeft: 50 }}>
  <summary>æŸ¥çœ‹å˜åŒ–</summary>
  <div>

åœ¨ `Furion 4.8.6.5` ä¹‹å‰ï¼Œä¸‹åˆ—ä»£ç **ä¼šæŠ›å‡ºå¼‚å¸¸**ï¼š`The route parameter name 'roleid' appears more than one time in the route template.`

**åŸå› æ˜¯ç”Ÿæˆçš„è·¯ç”±åŒ…å«äº†å¤šä¸ª `{roleId}`**ï¼š`/api/with-class/system/role/deptTree/{roleId}/{roleId}`ã€‚

```cs showLineNumbers {3}
public class WithClass : IDynamicApiController
{
    [HttpGet("system/role/deptTree/{roleId}")]  // è¿‡å»ç‰ˆæœ¬æŠ›å¼‚å¸¸ï¼ŒFurion 4.8.6.5+ æ­£å¸¸~
    public string GetResult2(string roleId)
    {
        return nameof(Furion);
    }
}
```

æ–°ç‰ˆæœ¬ `Furion 4.8.6.5+` ä¿®æ­£äº†è¯¥é”™è¯¯ï¼Œ**è‡ªåŠ¨ç§»é™¤åé¢é‡å¤çš„è·¯ç”±å‚æ•°ä¸”ä¸å†æŠ›å¼‚å¸¸**ï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆç”Ÿæˆè·¯ç”±ä¸ºï¼š`/api/with-class/system/role/deptTree/{roleId}`

  </div>
</details>

- - &nbsp;<Tag>æ–°å¢</Tag> åŠ¨æ€ `WebAPI` æ”¯æŒ `[RouteConstraint(":*")]` è·¯ç”±çº¦æŸ <sup>4.8.6.2</sup> <sup>â±ï¸2023.02.10</sup> [#I6E6JA](https://gitee.com/dotnetchina/Furion/issues/I6E6JA)
- - &nbsp;<Tag>æ–°å¢</Tag> **åŠ¨æ€ `WebAPI` æ”¯æŒæ›´åŠ å¼ºå¤§çš„è·¯ç”±ç»„åˆåŠŸèƒ½** <sup>4.8.5.7</sup> <sup>â±ï¸2023.02.03</sup> [#I6CLPT](https://gitee.com/dotnetchina/Furion/issues/I6CLPT)

<details style={{ marginLeft: 50 }}>
  <summary>æŸ¥çœ‹å˜åŒ–</summary>
  <div>

```cs showLineNumbers {8,19,36}
using Furion.DynamicApiController;
using Microsoft.AspNetCore.Mvc;

namespace WebApplication38;

[Route("api/[controller]")]
[Route("api2/[controller]")]
public class Test1Service : IDynamicApiController
{
    [HttpGet("test")]
    [HttpPost]
    [AcceptVerbs("PUT", "PATCH")]
    public async Task GetTestName()
    {
        await Task.CompletedTask;
    }
}

public class Test2Service : IDynamicApiController
{
    [HttpGet("/root/test")]
    [HttpGet("test")]
    [HttpGet(Name = "other-test")]
    [HttpGet("template-test", Name = "other-test")]
    [HttpPost]
    [AcceptVerbs("PUT", "PATCH")]
    public async Task GetTestName()
    {
        await Task.CompletedTask;
    }
}

[Route("api/[controller]")]
[Route("api2/[controller]/second")]
[Route("api3/[controller]/three")]
public class Test3Service : IDynamicApiController
{
    [HttpGet]
    [HttpGet("get/[action]")]
    [HttpPost]
    [HttpPost("post/cus-version")]
    public string GetVersion()
    {
        return "1.0.0";
    }
}
```

<img src={useBaseUrl("img/dy10.png")} />

  </div>
</details>

- - &nbsp;<Tag>æ–°å¢</Tag> åŠ¨æ€ `WebAPI` æ–¹æ³•æ”¯æŒé€šè¿‡ `[ActionName(åç§°)]` å’Œ `[HttpMethod(Name=åç§°)]` æŒ‡å®šè·¯ç”±åç§° <sup>4.8.4.12</sup> <sup>â±ï¸2023.01.10</sup> [#I69AOJ](https://gitee.com/dotnetchina/Furion/issues/I69AOJ) [f699540](https://gitee.com/dotnetchina/Furion/commit/f699540989e688f25597c509249e024ec014dc4e)

- **çªç ´æ€§å˜åŒ–**

  - &nbsp;<Tag>è°ƒæ•´</Tag> **åŠ¨æ€ `WebAPI` ç”Ÿæˆè·¯ç”± `[HttpMethod(template)]` è§„åˆ™** <sup>4.8.5.7</sup> <sup>â±ï¸2023.02.03</sup> [#I6CLPT](https://gitee.com/dotnetchina/Furion/issues/I6CLPT)

<details style={{ marginLeft: 50 }}>
  <summary>æŸ¥çœ‹å˜åŒ–</summary>
  <div>

åœ¨è¿‡å»ï¼Œ`TestMethod` ç”Ÿæˆè·¯ç”±ä¸ºï¼š`/mytest`

```cs showLineNumbers {1,4}
// æ³¨æ„è¿™é‡Œæ²¡æœ‰ [Route] ç‰¹æ€§
public class ClassService: IDynamicApiController
{
    [HttpPost("mytest")]
    public void TestMethod()
    {
    }
}
```

æ–°ç‰ˆæœ¬ï¼š`TestMethod` ç”Ÿæˆè·¯ç”±ä¸ºï¼š`/api/class/mytest`ï¼Œ`TestMethod2` ç”Ÿæˆè·¯ç”±ä¸ºï¼š`/mytest`ã€‚

```cs showLineNumbers {1,4,9}
// æ³¨æ„è¿™é‡Œæ²¡æœ‰ [Route] ç‰¹æ€§
public class ClassService: IDynamicApiController
{
    [HttpPost("mytest")]
    public void TestMethod()
    {
    }

    [HttpPost("/mytest")]
    public void TestMethod2()
    {
    }
}
```

ä¹Ÿå°±æ˜¯æ–°ç‰ˆæœ¬å¦‚æœä¸éœ€è¦è‡ªåŠ¨æ·»åŠ å‰ç¼€ï¼Œéœ€åœ¨å‰é¢æ·»åŠ  `/`ï¼Œæ—§ç‰ˆæœ¬ä¸éœ€è¦ã€‚

  </div>
</details>

- **é—®é¢˜ä¿®å¤**

  - &nbsp;<Tag>ä¿®å¤</Tag> åŠ¨æ€ `WebAPI` ä¸èƒ½æ­£ç¡®ç§»é™¤ `AppService` å‘½åçš„ `Service` é—®é¢˜ <sup>4.8.8.47</sup> <sup>â±ï¸2023.10.10</sup> [#I86NL](https://gitee.com/dotnetchina/Furion/issues/I86NLO)
  - &nbsp;<Tag>ä¿®å¤</Tag> åŠ¨æ€ `WebAPI` è‡ªå®šä¹‰è·¯ç”±æ¨¡æ¿å‚æ•°å’Œè‡ªåŠ¨æ‹¼æ¥å‚æ•°å†²çªé—®é¢˜ <sup>4.8.8.15</sup> <sup>â±ï¸2023.05.15</sup> [#I72ZZ2](https://gitee.com/dotnetchina/Furion/issues/I72ZZ2)
  - &nbsp;<Tag>ä¿®å¤</Tag> åŠ¨æ€ `WebAPI` å»é™¤å è¯ç±»å‹å‘½åå¦‚ `ServiceService` å‰åç¼€å¼‚å¸¸é—®é¢˜ <sup>4.8.7.32</sup> <sup>â±ï¸2023.04.02</sup> [#I6SB3Z](https://gitee.com/dotnetchina/Furion/issues/I6SB3Z)
  - &nbsp;<Tag>ä¿®å¤</Tag> åŠ¨æ€ `WebAPI` ä¸æ”¯æŒåµŒå¥—ç»§æ‰¿ `[Route]` ç‰¹æ€§é—®é¢˜ <sup>4.8.6.8</sup> <sup>â±ï¸2023.02.18</sup> [#I6CLPT](https://gitee.com/dotnetchina/Furion/issues/I6CLPT)

<details style={{ marginLeft: 50 }}>
  <summary>æŸ¥çœ‹å˜åŒ–</summary>
  <div>

è¿‡å»ç‰ˆæœ¬ç”Ÿæˆé”™è¯¯é‡å¤è·¯ç”±ï¼Œå¦‚ï¼š`api/system/SystemDictionary/api/system/SystemDictionary/Add`ï¼Œç°å·²ä¿®æ­£ã€‚

```cs showLineNumbers {1,3,16,17}
public class WithClass : IDynamicApiController
{
    [Route("Add")]
    public void Add()
    {

    }

    [Route("Edit")]
    public void Edit()
    {

    }
}

[Route("api/system/SystemDictionary")]
public class SystemService : WithClass
{
    public void Some()
    {
    }
}
```

  </div>
</details>

- - &nbsp;<Tag>ä¿®å¤</Tag> åŠ¨æ€ `WebAPI` è‡ªå®šä¹‰ `[HttpMethod(template)]` ä¹‹åç”Ÿæˆé”™è¯¯è·¯ç”± <sup>4.8.6.1</sup> <sup>â±ï¸2023.02.08</sup> [59fe53b](https://gitee.com/dotnetchina/Furion/commit/59fe53b5a9715ed139aff9075cb7fcaad01565b7)
- - &nbsp;<Tag>ä¿®å¤</Tag> åŠ¨æ€ `WebAPI` é…ç½® `[Consumes]` ç‰¹æ€§å `Swagger` ä¸æ˜¾ç¤ºé—®é¢˜ <sup>4.8.4.12</sup> <sup>â±ï¸2023.01.10</sup> [daf25f8](https://gitee.com/dotnetchina/Furion/commit/daf25f8c91a24904381d3536c0c8825ef833e9c9)

</div>
  </div>
</details>

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

:::tip å°çŸ¥è¯†

`åŠ¨æ€WebAPI` å®é™…ä¸Šå°±æ˜¯å°†æ™®é€šçš„ç±»å˜ä¸º `Controller`ï¼Œä¹Ÿå°±æ˜¯ `åŠ¨æ€WebAPI` å°±æ˜¯æ§åˆ¶å™¨ï¼Œæ”¯æŒæ§åˆ¶å™¨ä¸€åˆ‡åŠŸèƒ½ã€‚

:::

## 5.1.1 ä»€ä¹ˆæ˜¯æ§åˆ¶å™¨

ç®€å•æ¥è¯´ï¼Œæ§åˆ¶å™¨æ˜¯ä¸€ä¸ªæ‰¿ä¸Šå¯ä¸‹çš„ä½œç”¨ï¼Œæ ¹æ®ç”¨æˆ·è¾“å…¥ï¼Œæ‰§è¡Œå“åº”è¡Œä¸ºï¼ˆåŠ¨ä½œæ–¹æ³•ï¼‰ï¼ŒåŒæ—¶åœ¨è¡Œä¸ºä¸­è°ƒç”¨æ¨¡å‹çš„ä¸šåŠ¡é€»è¾‘ï¼Œè¿”å›ç»™ç”¨æˆ·ç»“æœï¼ˆè§†å›¾ï¼‰ã€‚

<img src={useBaseUrl("img/kzq.png")} />

<p></p>

åœ¨ `ASP.NET Core` ä¸­ï¼Œæ§åˆ¶å™¨æœ‰ä¸¤ç§è¡¨ç°å½¢å¼ï¼š

- `Mvc`ï¼ˆå¸¦è§†å›¾ï¼‰
- `WebAPI`ï¼ˆRESTful APIï¼‰

<Tabs
  defaultValue="mvc"
  values={[
    { label: "Mvc æ§åˆ¶å™¨", value: "mvc" },
    { label: "WebAPI æ§åˆ¶å™¨", value: "webapi" },
  ]}
>
  <TabItem value="mvc">

```cs showLineNumbers  {1,5,7}
using Microsoft.AspNetCore.Mvc;

namespace Furion.Web.Entry.Controllers
{
    public class MvcController : Controller
    {
        public IActionResult Index()
        {
            return View();
        }
    }
}
```

  </TabItem>
  <TabItem value="webapi">

```cs showLineNumbers  {1,5,6,8,9}
using Microsoft.AspNetCore.Mvc;

namespace Furion.Web.Entry.Controllers
{
    [Route("api/[controller]")]
    public class WebApiController : ControllerBase
    {
        [HttpGet]
        public IActionResult Get()
        {
            return Content(nameof(Furion));
        }
    }
}
```

  </TabItem>
</Tabs>

`Mvc` æ§åˆ¶å™¨å’Œ `WebAPI` æ§åˆ¶å™¨æœ€å¤§çš„åŒºåˆ«æ˜¯ `WebAPI` æ§åˆ¶å™¨ä¸å¸¦ **è§†å›¾** å’Œé€šè¿‡ **è¯·æ±‚è°“è¯å’Œè·¯ç”±åœ°å€å“åº”è¡Œä¸º**ã€‚

## 5.1.2 `Mvc æ§åˆ¶å™¨` çº¦å®šå’Œç¼ºç‚¹

åœ¨å­¦ä¹ åŠ¨æ€ `WebAPI` æ§åˆ¶å™¨ä¹‹å‰ï¼Œé¦–å…ˆäº†è§£ `ASP.NET Core` ä¸­ `WebAPI` çš„ä¸€äº›çº¦å®šå’Œæ³¨æ„äº‹é¡¹ã€‚

### 5.1.2.1 `WebAPI` çº¦å®š

åœ¨ `ASP.NET Core` åº”ç”¨ä¸­ï¼Œä¸€ä¸ª `WebAPI` æ§åˆ¶å™¨éœ€éµå¾ªä»¥ä¸‹çº¦å®šï¼š

- æ§åˆ¶å™¨ç±»**å¿…é¡»ç»§æ‰¿ `ControllerBase` æˆ–é—´æ¥ç»§æ‰¿**
- åŠ¨ä½œæ–¹æ³•**å¿…é¡»è´´æœ‰ `[HttpMethod]` ç‰¹æ€§ï¼Œå¦‚ï¼š`[HttpGet]`**
- æ§åˆ¶å™¨æˆ–åŠ¨ä½œæ–¹æ³•**è‡³å°‘æœ‰ä¸€ä¸ªé…ç½® `[Route]` ç‰¹æ€§**
- ç”Ÿæˆ `WebAPI` è·¯ç”±åœ°å€æ—¶ä¼šè‡ªåŠ¨å»æ‰æ§åˆ¶å™¨åç§° `Controller` åç¼€ï¼ŒåŒæ—¶ä¹Ÿä¼šå»æ‰åŠ¨ä½œæ–¹æ³•åŒ¹é…çš„ `HttpVerb` è°“è¯ï¼Œå¦‚ `GETï¼ŒPOSTï¼ŒDELETEï¼ŒPUT` ç­‰
- **ä¸æ”¯æŒè¿”å›é `IEnumerable<T>` æ³›å‹å¯¹è±¡**
- **ä¸æ”¯æŒç±»ç±»å‹å‚æ•°åœ¨ `GETï¼ŒHEAD` è¯·æ±‚ä¸‹ç”Ÿæˆ `Query` å‚æ•°**

é™¤äº†ä¸Šè¿°çº¦å®šå¤–ï¼Œ`WebAPI` è·¯ç”±åœ°å€**åŸºæœ¬é æ‰‹å·¥å®Œæˆ**ï¼Œä¸åˆ©äºä¹¦å†™ï¼Œä¸åˆ©äºç»´æŠ¤ï¼Œå†è€…ï¼Œåœ¨ç§»åŠ¨åº”ç”¨å¯¹æ¥ä¸­éš¾ä»¥è¿›è¡Œå¤šç‰ˆæœ¬æ§åˆ¶ã€‚

### 5.1.2.2 `.NET Core WebAPI` ç¼ºç‚¹

é€šè¿‡ä¸Šä¸€ç« èŠ‚å¯ä»¥çœ‹å‡ºï¼Œ`ASP.NET Core` åº”ç”¨å®ç° `WebAPI` éœ€è¦éµå¾ªç§ç§çº¦å®šï¼Œè€Œä¸”å®¹æ˜“å‡ºé”™ã€‚

é™¤äº†è¿™äº›çº¦å®šï¼Œ`.NET Core WebAPI` æœ‰ä»¥ä¸‹ç¼ºç‚¹ï¼š

- è·¯ç”±åœ°å€åŸºæœ¬é æ‰‹å·¥å®Œæˆ
- åœ¨ç°åœ¨ç§»åŠ¨ä¸ºç‹çš„æ—¶ä»£ï¼Œä¸åˆ©äºè¿›è¡Œå¤šç‰ˆæœ¬æ§åˆ¶
- å¯¹æ¥ `Swagger` æ–‡æ¡£åˆ†ç»„æ¯”è¾ƒå¤æ‚
- å®ç° `Policy` ç­–ç•¥æˆæƒä¹Ÿæ¯”è¾ƒå¤æ‚
- ä¸æ”¯æŒæ§åˆ¶å™¨çƒ­æ’æ‹”æ’ä»¶åŒ–
- éš¾ä»¥å®ç°å¤æ‚è‡ªå®šä¹‰çš„ `RESTful API` é£æ ¼

## 5.1.3 åŠ¨æ€ `WebAPI` æ§åˆ¶å™¨

é’ˆå¯¹ä»¥ä¸Š `ASP.NET Core` æä¾›çš„ `WebAPI` å¿…é¡»éµå¾ªçš„çº¦å®šå’Œä¸å¯é¿å…çš„ç¼ºç‚¹ï¼Œ`Furion` æ¡†æ¶æ¨å‡ºä¸€ç§æ›´åŠ çµæ´»åˆ›å»º `WebAPI` æ§åˆ¶å™¨çš„æ–¹å¼ã€‚

è¿™ä¸ªæ–¹å¼åœ¨ç»§æ‰¿äº† `ASP.NET Core WebAPI` æ‰€æœ‰ä¼˜ç‚¹ï¼ŒåŒæ—¶è¿›è¡Œäº†å¤§é‡æ‹“å±•å’Œä¼˜åŒ–ã€‚ä¼˜åŒ–åçš„ `WebAPI` å…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š

- å…·å¤‡åŸæœ‰çš„ `ControllerBase` æ‰€æœ‰åŠŸèƒ½
- æ”¯æŒ**ä»»æ„å…¬å¼€ éé™æ€ éæŠ½è±¡ éæ³›å‹ç±»**è½¬æ§åˆ¶å™¨
- æä¾›æ›´åŠ çµæ´»æ–¹ä¾¿çš„ `IDynamicApiController` ç©ºæ¥å£æˆ– `[DynamicApiController]` ç‰¹æ€§æ›¿ä»£ `ControllerBase` æŠ½è±¡ç±»
- å¯ç›´æ¥åœ¨**ä»»æ„å…¬å¼€ éé™æ€ éæŠ½è±¡ éæ³›å‹ç±»**è´´ `[Route]` ç‰¹æ€§è‡ªåŠ¨è½¬æ§åˆ¶å™¨
- æ— éœ€æ‰‹åŠ¨é…ç½® `[HttpMethod]` ç‰¹æ€§ï¼ŒåŒæ—¶æ”¯æŒä¸€ä¸ªåŠ¨ä½œæ–¹æ³•å¤šä¸ª `HttpVerb`
- æ— éœ€æ‰‹åŠ¨é…ç½® `[Route]` ç‰¹æ€§ï¼Œæ”¯æŒæ›´åŠ çµæ´»çš„é…ç½®åŠè‡ªåŠ¨è·¯ç”±ç”Ÿæˆ
- æ”¯æŒè¿”å›æ³›å‹æ¥å£ï¼Œæ³›å‹ç±»
- å’Œ `Swagger` æ·±åº¦ç»“åˆï¼Œæä¾›æå…¶æ–¹ä¾¿çš„åˆ›å»º `Swagger` åˆ†ç»„é…ç½®
- æ”¯æŒ `Basic Authï¼ŒJwtï¼ŒApiKey` ç­‰å¤šç§æƒé™çµæ´»é…ç½®
- æ”¯æŒæ§åˆ¶å™¨ã€åŠ¨ä½œæ–¹æ³•**ç‰ˆæœ¬æ§åˆ¶**åŠŸèƒ½
- æ”¯æŒ `GETã€HEAD` è¯·æ±‚è‡ªåŠ¨è½¬æ¢ `ç±»ç±»å‹å‚æ•°`
- æ”¯æŒç”Ÿæˆ `OAS3` æ¥å£è§„èŒƒ

## 5.1.4 æ³¨å†ŒåŠ¨æ€ `WebAPI` æœåŠ¡

:::tip å°æç¤º

`.AddDynamicApiControllers()` é»˜è®¤å·²ç»é›†æˆåœ¨ `AddInject()` ä¸­äº†ï¼Œ**æ— éœ€å†æ¬¡æ³¨å†Œ**ã€‚ä¹Ÿå°±æ˜¯ä¸‹åˆ—ä»£ç å¯ä¸é…ç½®ã€‚

:::

```cs showLineNumbers  {11} title="Furion.Web.Core\FurWebCoreStartup.cs"
using Microsoft.Extensions.DependencyInjection;

namespace Furion.Web.Core
{
    [AppStartup(800)]
    public sealed class FurWebCoreStartup : AppStartup
    {
        public void ConfigureServices(IServiceCollection services)
        {
            services.AddControllers()
                    .AddDynamicApiControllers();
        }
    }
}
```

:::caution ç‰¹åˆ«æ³¨æ„

`.AddDynamicApiControllers()` å¿…é¡»åœ¨ `services.AddControllers()` ä¹‹åæ³¨å†Œã€‚

:::

## 5.1.5 ç¬¬ä¸€ä¸ªä¾‹å­

åˆ›å»ºä¸€ä¸ª `FurionAppService` ç±»ç»§æ‰¿ `IDynamicApiController` æ¥å£ æˆ– è´´ `[DynamicApiController]` ç‰¹æ€§ï¼Œå¹¶åœ¨è¿™ä¸ªç±»ä¸­ç¼–å†™ä¸€ä¸ª `Get` æ–¹æ³•ã€‚

- **`IDynamicApiController` æ–¹å¼**

```cs showLineNumbers  {1,5,7}
using Furion.DynamicApiController;

namespace Furion.Application
{
    public class FurionAppService : IDynamicApiController
    {
        public string Get()
        {
            return $"Hello {nameof(Furion)}";
        }
    }
}
```

- **`[DynamicApiController]` æ–¹å¼**

```cs showLineNumbers  {1,5,8}
using Furion.DynamicApiController;

namespace Furion.Application
{
    [DynamicApiController]
    public class FurionAppService
    {
        public string Get()
        {
            return $"Hello {nameof(Furion)}";
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸€ä¸ª `WebAPI` æ¥å£å°±è¿™ä¹ˆç”Ÿæˆäº†ã€‚

<img src={useBaseUrl("img/dyglz.gif")} />

## 5.1.6 åŠ¨æ€ `WebAPI` åŸç†è§£æ

### 5.1.6.1 æ§åˆ¶å™¨ç‰¹æ€§æä¾›å™¨

`Furion` æ¡†æ¶ä¼šåœ¨åº”ç”¨å¯åŠ¨æ—¶æ³¨å†Œ `DynamicApiControllerFeatureProvider` æ§åˆ¶å™¨ç‰¹æ€§æä¾›å™¨ï¼Œè¯¥æä¾›å™¨ç»§æ‰¿è‡ª `ControllerFeatureProvider` ç±»ã€‚

æ¥ç€é‡å†™ `bool IsController(TypeInfo typeInfo)` æ–¹æ³•ï¼Œç”¨æ¥æ ‡è¯†æ§åˆ¶å™¨ç±»å‹ã€‚åœ¨ `Furion` æ¡†æ¶ä¸­ï¼Œ**ç»§æ‰¿è‡ª `ControllerBase` ç±»æˆ– `IDynamicApiController` æ¥å£æˆ– `[DynamicApiController]` ç‰¹æ€§éƒ½ä¼šè¢«æ ‡è®°ä¸ºæ§åˆ¶å™¨ç±»å‹ã€‚**

### 5.1.6.2 åº”ç”¨æ¨¡å‹è½¬æ¢å™¨

`Furion` æ¡†æ¶åŒæ—¶åœ¨åº”ç”¨å¯åŠ¨æ—¶æ³¨å†Œ `DynamicApiControllerApplicationModelConvention` åº”ç”¨æ¨¡å‹è½¬æ¢å™¨ï¼Œè¯¥è½¬æ¢å™¨ç»§æ‰¿è‡ª `IApplicationModelConvention` æ¥å£ã€‚

æ¥ç€å®ç° `void Apply(ApplicationModel application)` æ¥å£æ–¹æ³•ã€‚åœ¨è¯¥æ–¹æ³•ä¸­é…ç½®æ§åˆ¶å™¨åç§°ã€è·¯ç”±ã€å¯¼å‡ºå¯è§æ€§åŠåŠ¨ä½œæ–¹æ³•åç§°ã€è·¯ç”±ã€å¯¼å‡ºå¯è§æ€§ç­‰ã€‚

å®é™…ä¸Šè¯¥æ–¹æ³•åšçš„å°±æ˜¯æŒ‰ç…§ **[WebAPI çº¦å®š](#521-webapi-çº¦å®š)** æå‰å¸®æˆ‘ä»¬é…ç½®å¥½è·¯ç”±ã€è¯·æ±‚è°“è¯ç­‰ä¿¡æ¯ã€‚é¿å…äº†æ‰‹åŠ¨é…ç½®çš„åŒæ—¶è¿˜å¢åŠ äº†è®¸å¤šæ–°ç‰¹æ€§ï¼Œå¦‚**ç‰ˆæœ¬æ§åˆ¶ã€‚**

## 5.1.7 åŠ¨æ€ `WebAPI` é…ç½®çº¦å®š

### 5.1.7.1 æ§åˆ¶å™¨é»˜è®¤çº¦å®š

- ç”Ÿæˆæ§åˆ¶å™¨åç§°é»˜è®¤å»é™¤ä»¥ `AppServicesï¼ŒAppServiceï¼ŒApiControllerï¼ŒControllerï¼ŒServicesï¼ŒService` ä½œä¸ºå‰åç¼€çš„å­—ç¬¦ä¸²ã€‚è§ç¬¬ä¸€ä¸ªä¾‹å­ä¸­çš„ `FurionAppService -> Furion` **æ”¯æŒè‡ªå®šä¹‰é…ç½®**
- æ§åˆ¶å™¨åç§°å¸¦ `V[0-9_]` ç»“å°¾çš„ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆæ§åˆ¶å™¨ç‰ˆæœ¬å·ï¼Œå¦‚ `FurionAppServiceV2 -> Furion@2`ï¼Œ`FurionAppServiceV1_1_0 -> Furion@1.1.0`ã€‚**æ”¯æŒç‰ˆæœ¬åˆ†éš”ç¬¦é…ç½®**
- æ§åˆ¶åç§°ä»¥ `éª†é©¼å‘½åï¼ˆCamelCaseï¼‰` ä¼šè‡ªåŠ¨åˆ‡å‰²æˆå¤šä¸ªå•è¯ `-` è¿æ¥ã€‚**æ”¯æŒè‡ªå®šä¹‰é…ç½®**

### 5.1.7.2 åŠ¨ä½œæ–¹æ³•é»˜è®¤çº¦å®š

- ç”Ÿæˆçš„åŠ¨ä½œæ–¹æ³•åç§°é»˜è®¤å»é™¤ä»¥ `Post/Add/Create/Insert/Submitï¼ŒGetAll/GetList/Get/Find/Fetch/Query/Searchï¼ŒPut/Updateï¼ŒDelete/Remove/Clearï¼ŒPatch` å¼€å¤´çš„å­—ç¬¦ä¸²ã€‚**æ”¯æŒè‡ªå®šä¹‰é…ç½®**
- ç”Ÿæˆçš„åŠ¨ä½œæ–¹æ³•åç§°é»˜è®¤å»é™¤ä»¥ `Async` ä½œä¸ºå‰åç¼€çš„å­—ç¬¦ä¸²ã€‚**æ”¯æŒè‡ªå®šä¹‰é…ç½®**
- åŠ¨ä½œæ–¹æ³•åç§°å¸¦ `V[0-9_]` ç»“å°¾çš„ï¼Œä¼šè‡ªåŠ¨ç”ŸæˆåŠ¨ä½œæ–¹æ³•ç‰ˆæœ¬å·ï¼Œå¦‚ `ChangePasswordV2 -> ChangePassword@2`ï¼Œ`ChangePasswordV1_1_0 -> ChangePassword@1.1.0`ã€‚**æ”¯æŒç‰ˆæœ¬åˆ†éš”ç¬¦é…ç½®**
- åŠ¨ä½œæ–¹æ³•åç§°ä»¥ `éª†é©¼(é©¼å³°)/å¸•æ–¯å¡å‘½åï¼ˆCamelCase/Pascalï¼‰` ä¼šè‡ªåŠ¨åˆ‡å‰²æˆå¤šä¸ªå•è¯ `-` è¿æ¥ã€‚**æ”¯æŒè‡ªå®šä¹‰é…ç½®**
- åŠ¨ä½œæ–¹æ³•å‚æ•°å°†è‡ªåŠ¨è½¬ä¸ºå°å†™ã€‚**æ”¯æŒè‡ªå®šä¹‰é…ç½®**

### 5.1.7.3 è¯·æ±‚è°“è¯é»˜è®¤çº¦å®š

- åŠ¨ä½œæ–¹æ³•å
  - ä»¥ `Post/Add/Create/Insert/Submit/Change` å¼€å¤´ï¼Œåˆ™æ·»åŠ  `[HttpPost]` ç‰¹æ€§ã€‚
  - ä»¥ `GetAll/GetList/Get/Find/Fetch/Query` å¼€å¤´ï¼Œåˆ™æ·»åŠ  `[HttpGet]` ç‰¹æ€§ã€‚
  - ä»¥ `Put/Update` å¼€å¤´ï¼Œåˆ™æ·»åŠ  `[HttpPut]` ç‰¹æ€§ã€‚
  - ä»¥ `Delete/Remove/Clear` å¼€å¤´ï¼Œåˆ™æ·»åŠ  `[HttpDelete]` ç‰¹æ€§ã€‚
  - ä»¥ `Patch` å¼€å¤´ï¼Œåˆ™æ·»åŠ  `[HttpPatch]` ç‰¹æ€§
  - **æ”¯æŒè‡ªå®šä¹‰é…ç½®**
- å¦‚æœä¸åœ¨ä¸Šé¢çº¦å®šä¸­ï¼Œåˆ™é»˜è®¤æ·»åŠ  `[HttpPost]` ç‰¹æ€§ã€‚**æ”¯æŒè‡ªå®šä¹‰é…ç½®**

### 5.1.7.4 è·¯ç”±åœ°å€é»˜è®¤çº¦å®š

- é»˜è®¤ä»¥ `api` å¼€å¤´ã€‚**æ”¯æŒè‡ªå®šä¹‰é…ç½®**
- é»˜è®¤è½¬æ¢ä¸ºå°å†™è·¯ç”±åœ°å€ã€‚**æ”¯æŒè‡ªå®šä¹‰é…ç½®**
- ç”Ÿæˆæ§åˆ¶å™¨è·¯ç”±æ¨¡æ¿æ ¼å¼ä¸ºï¼š`api/å‰ç½®å‚æ•°åˆ—è¡¨/æ¨¡å—åæˆ–é»˜è®¤åŒºåŸŸå/[controller@ç‰ˆæœ¬å·]/åç½®å‚æ•°åˆ—è¡¨`
- ç”ŸæˆåŠ¨ä½œæ–¹æ³•è·¯ç”±æ¨¡æ¿æ ¼å¼ä¸ºï¼š`å‰ç½®å‚æ•°åˆ—è¡¨/æ¨¡å—å/[action@ç‰ˆæœ¬å·]/åç½®å‚æ•°åˆ—è¡¨`

### 5.1.7.5 å…¶ä»–çº¦å®š

- é»˜è®¤ä¸å¤„ç† `ControllerBase` æ§åˆ¶å™¨ç±»å‹ã€‚**æ”¯æŒè‡ªå®šä¹‰é…ç½®**
- é»˜è®¤ä¸å¤„ç† `GETï¼ŒHEAD` è¯·æ±‚çš„å¼•ç”¨ç±»å‹å‚æ•°ã€‚**æ”¯æŒè‡ªå®šä¹‰é…ç½®**

## 5.1.8 æ›´å¤šä¾‹å­

### 5.1.8.1 å¤šç§è¯·æ±‚è°“è¯æ–¹æ³•

```cs showLineNumbers  {7,12,17,22,27}
using Furion.DynamicApiController;

namespace Furion.Application
{
    public class FurionAppService : IDynamicApiController
    {
        public string Get()
        {
            return $"GET è¯·æ±‚";
        }

        public string Post()
        {
            return $"POST è¯·æ±‚";
        }

        public string Delete()
        {
            return $"DELETE è¯·æ±‚";
        }

        public string Put()
        {
            return $"PUT è¯·æ±‚";
        }

        public string Patch()
        {
            return $"PATCH è¯·æ±‚";
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/dgqqwc.png")} />

### 5.1.8.2 å¤šä¸ªè‡ªå®šä¹‰åŠ¨ä½œæ–¹æ³•

```cs showLineNumbers  {7,12,17}
using Furion.DynamicApiController;

namespace Furion.Application
{
    public class FurionAppService : IDynamicApiController
    {
        public string GetVersion()
        {
            return $"v1.0.0";
        }

        public string ChangeProfile()
        {
            return "ä¿®æ”¹æˆåŠŸ";
        }

        public string DeleteUser()
        {
            return "åˆ é™¤æˆåŠŸ";
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/dzmc.png")} />

### 5.1.8.3 å¸¦å‚æ•°åŠ¨ä½œæ–¹æ³•

```cs showLineNumbers  {7,12,17}
using Furion.DynamicApiController;

namespace Furion.Application
{
    public class FurionAppService : IDynamicApiController
    {
        public string GetUser(int id)
        {
            return $"{id}";
        }

        public string GetUser(int id, string name)
        {
            return $"{id} {name}";
        }

        public TestDto Add(TestDto testDto)
        {
            return testDto;
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/dcsff.gif")} />

### 5.1.8.4 `GET/HEAD` ç±»ç±»å‹å‚æ•°

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`ASP.NET Core` ä¼šå°† `GET/HEAD` è¯·æ±‚ä¸­çš„ `ç±»ç±»å‹å‚æ•°` è®¾ç½®ä¸º `[FromBody]` ç»‘å®šï¼Œå¦‚ï¼š

```cs showLineNumbers  {7}
using Furion.DynamicApiController;

namespace Furion.Application
{
    public class FurionAppService : IDynamicApiController
    {
        public TestDto GetTest(TestDto testDto)
        {
            return testDto;
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/getyycs.png")} />

ä½†æ˜¯ï¼Œ`GETã€HEAD` è¯·æ±‚ä¸æ”¯æŒ `From Body` ç»‘å®šã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦è½¬æ¢ä¸º `Query` æŸ¥è¯¢å‚æ•°ã€‚

`Furion` æ¡†æ¶æ”¯æŒä»¥ä¸‹ä¸¤ç§æ–¹å¼é…ç½®ï¼š

<Tabs
  defaultValue="fromquery"
  values={[
    { label: "[FromQuery] ç‰¹æ€§", value: "fromquery" },
    {
      label: "é…ç½® DynamicApiControllerSettings",
      value: "DynamicApiControllerSettings",
    },
  ]}
>
  <TabItem value="fromquery">

```cs showLineNumbers  {2,8}
using Furion.DynamicApiController;
using Microsoft.AspNetCore.Mvc;

namespace Furion.Application
{
    public class FurionAppService : IDynamicApiController
    {
        public TestDto GetTest([FromQuery] TestDto testDto)
        {
            return testDto;
        }
    }
}
```

  </TabItem>
  <TabItem value="DynamicApiControllerSettings">

```json showLineNumbers  {2-4} title="Furion.Web.Entry/appsettings.json"
{
  "DynamicApiControllerSettings": {
    "ModelToQuery": true
  }
}
```

  </TabItem>
</Tabs>

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/modeltoquery.png")} />

### 5.1.8.5 è‡ªå®šä¹‰å‚æ•°ä½ç½®

`Furion` æ¡†æ¶æä¾›äº†éå¸¸æ–¹ä¾¿çš„è‡ªå®šä¹‰å‚æ•°ä½ç½®çš„ç‰¹æ€§ `[ApiSeat]`ï¼Œé€šè¿‡ `[ApiSeat]` å¯é…ç½®å‚æ•°ä½ç½®ï¼Œæ”¯æŒä»¥ä¸‹å››ç§ä½ç½®ï¼š

- `ApiSeats.ControllerStart`ï¼šæ§åˆ¶å™¨ä¹‹å‰
- `ApiSeats.ControllerEnd`ï¼šæ§åˆ¶å™¨ä¹‹å
- `ApiSeats.ActionStart`ï¼šåŠ¨ä½œæ–¹æ³•ä¹‹å‰
- `ApiSeats.ActionEnd`ï¼šåŠ¨ä½œæ–¹æ³•ä¹‹åã€‚**é»˜è®¤å€¼**

```cs showLineNumbers  {8-9,15-20}
using Furion.DynamicApiController;
using System;

namespace Furion.Application
{
    public class FurionAppService : IDynamicApiController
    {
        // å‚æ•°é»˜è®¤ä¸º ApiSeats.ActionEnd
        public string RouteSeat(int id, string name)
        {
            return "é…ç½®è·¯ç”±å‚æ•°ä½ç½®";
        }

        public string RouteSeat(
            [ApiSeat(ApiSeats.ControllerStart)] int id, // æ§åˆ¶å™¨åç§°ä¹‹å‰
            [ApiSeat(ApiSeats.ControllerEnd)] string name, // æ§åˆ¶å™¨åç§°ä¹‹å
            [ApiSeat(ApiSeats.ControllerEnd)] int age, // æ§åˆ¶å™¨åç§°ä¹‹å
            [ApiSeat(ApiSeats.ActionStart)] decimal weight, // åŠ¨ä½œæ–¹æ³•åç§°ä¹‹å‰
            [ApiSeat(ApiSeats.ActionStart)] float height, // åŠ¨ä½œæ–¹æ³•åç§°ä¹‹å‰
            [ApiSeat(ApiSeats.ActionEnd)] DateTime birthday) // åŠ¨ä½œæ–¹æ³•åç§°ä¹‹åï¼ˆé»˜è®¤å€¼ï¼‰
        {
            return "é…ç½®è·¯ç”±å‚æ•°ä½ç½®";
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/cswz.png")} />

:::note æ¸©é¦¨æç¤º

å¤šä¸ª **`åŒä½ç½®`** é…ç½®çš„å‚æ•°å°†æŒ‰ç…§ **`å®šä¹‰å‚æ•°é¡ºåº`** è¿›è¡Œæ’åºã€‚

:::

:::caution ç‰¹åˆ«æ³¨æ„

`[ApiSeat]` åªèƒ½åº”ç”¨äºè´´äº† `[FromRoute]` ç‰¹æ€§çš„å‚æ•°æˆ– `åŸºå…ƒç±»å‹ã€å€¼ç±»å‹ã€å¯ç©ºåŸºå…ƒç±»å‹å’Œå¯ç©ºå€¼ç±»å‹`ã€‚

:::

### 5.1.8.6 è‡ªå®šä¹‰è¯·æ±‚è°“è¯

```cs showLineNumbers  {2,8}
using Furion.DynamicApiController;
using Microsoft.AspNetCore.Mvc;

namespace Furion.Application
{
    public class FurionAppService : IDynamicApiController
    {
        [HttpPost]
        public string GetVersion()
        {
            return "1.0.0";
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/zdywc.png")} />

### 5.1.8.7 æ”¯æŒå¤šä¸ªè°“è¯

```cs showLineNumbers  {2,8}
using Furion.DynamicApiController;
using Microsoft.AspNetCore.Mvc;

namespace Furion.Application
{
    public class FurionAppService : IDynamicApiController
    {
        [HttpPost, HttpGet, AcceptVerbs("PUT", "DELETE")]
        public string GetVersion()
        {
            return "1.0.0";
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/dgwc.png")} />

:::caution ç‰¹åˆ«æ³¨æ„

å¦‚æœåŠ¨ä½œæ–¹æ³•ä¸­å«æœ‰ `ç±»ç±»å‹å‚æ•°`ï¼Œä¸”å«æœ‰ `POST/PUT/DELETE` ä»»æ„è¯·æ±‚è°“è¯ï¼Œé‚£ä¹ˆè¯¥å‚æ•°ä¼šè‡ªåŠ¨æ·»åŠ  `[FromBody]` å‚æ•°ï¼Œå³ä½¿åœ¨ `GET/HEAD` è¯·æ±‚ä¸­ä¸æ”¯æŒã€‚

:::

### 5.1.8.8 æ”¯æŒè‡ªå®šä¹‰è·¯ç”±

æ”¯æŒæ§åˆ¶å™¨å’ŒåŠ¨ä½œæ–¹æ³•è‡ªå®šä¹‰è·¯ç”±ï¼š

<Tabs
  defaultValue="kzqrl"
  values={[
    { label: "è‡ªå®šä¹‰æ§åˆ¶å™¨è·¯ç”±", value: "kzqrl" },
    { label: "è‡ªå®šä¹‰åŠ¨ä½œæ–¹æ³•è·¯ç”±", value: "dzffrl" },
    { label: "åŒæ—¶è‡ªå®šä¹‰è·¯ç”±", value: "allrl" },
    { label: "è°“è¯è‡ªå®šä¹‰è·¯ç”±", value: "vcrl" },
  ]}
>
  <TabItem value="kzqrl">

```cs showLineNumbers  {2,6}
using Furion.DynamicApiController;
using Microsoft.AspNetCore.Mvc;

namespace Furion.Application
{
    [Route("customapi/mobile/[controller]")]
    public class FurionAppService : IDynamicApiController
    {
        public string GetVersion()
        {
            return "1.0.0";
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/kzqrl.png")} />

  </TabItem>
  <TabItem value="dzffrl">

```cs showLineNumbers  {2,8}
using Furion.DynamicApiController;
using Microsoft.AspNetCore.Mvc;

namespace Furion.Application
{
    public class FurionAppService : IDynamicApiController
    {
        [Route("customapi/[action]")]
        public string GetVersion()
        {
            return "1.0.0";
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/dzffrl.png")} />

  </TabItem>
  <TabItem value="allrl">

```cs showLineNumbers  {2,6,9}
using Furion.DynamicApiController;
using Microsoft.AspNetCore.Mvc;

namespace Furion.Application
{
    [Route("customapi/mobile/[controller]")]
    public class FurionAppService : IDynamicApiController
    {
        [Route("get/[action]")]
        public string GetVersion()
        {
            return "1.0.0";
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/allrl.png")} />

  </TabItem>
  <TabItem value="vcrl">

```cs showLineNumbers  {9}
using Furion.DynamicApiController;
using Microsoft.AspNetCore.Mvc;

namespace Furion.Application
{
    [Route("api/[controller]")]
    public class FurionAppService : IDynamicApiController
    {
        [HttpGet("get/[action]")]
        public string GetVersion()
        {
            return "1.0.0";
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/wcrl.png")} />

  </TabItem>
</Tabs>

:::important å°æç¤º

åŠ¨ä½œæ–¹æ³•è‡ªå®šä¹‰è·¯ç”±å¦‚æœä»¥ **`/`** å¼€å¤´ï¼Œåˆ™ä¸ä¼šåˆå¹¶æ§åˆ¶å™¨è·¯ç”±ã€‚

:::

:::tip æ¨èé…ç½®

è‡ªå®šä¹‰è·¯ç”±å¦‚æœéœ€è¦ç”¨åˆ° **æ§åˆ¶å™¨/åŠ¨ä½œæ–¹æ³•åç§°**ï¼Œæ¨èä½¿ç”¨ `[controller]` æˆ– `[action]` å ä½ç¬¦ï¼Œå› ä¸ºè¯¥å ä½ç¬¦å·²ç»è‡ªåŠ¨å¤„ç†äº† **å‰åç¼€ã€ç‰ˆæœ¬å·ã€æ¨¡å—åç§°**ç­‰ã€‚

:::

### 5.1.8.9 å¤šè·¯ç”±éšæ„ç»„åˆ

`Furion` æ¡†æ¶æä¾›äº†éå¸¸çµæ´»çš„å„ç§è·¯ç”±ç»„åˆæ–¹å¼ï¼Œæ”¯æŒä¸€å¯¹å¤šï¼Œå¤šå¯¹å¤šè·¯ç”±ç»„åˆï¼š

```cs showLineNumbers  {6-8,11-14}
using Furion.DynamicApiController;
using Microsoft.AspNetCore.Mvc;

namespace Furion.Application
{
    [Route("api/[controller]")]
    [Route("api/[controller]/second")]
    [Route("api/[controller]/three")]
    public class FurionAppService : IDynamicApiController
    {
        [HttpGet]
        [HttpGet("get/[action]")]
        [HttpPost]
        [HttpPost("post/cus-version")]
        public string GetVersion()
        {
            return "1.0.0";
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/dlrzh.gif")} />

:::caution ç‰¹åˆ«æ³¨æ„

åŠ¨ä½œæ–¹æ³•ä¸èƒ½åŒæ—¶è´´ `[Route]` å’Œ `[HttpMethod]` ç‰¹æ€§ï¼Œåªèƒ½äºŒå–ä¸€ã€‚

:::

---

åœ¨ `Furion 4.8.5.7+` ç‰ˆæœ¬æä¾›æ›´åŠ å¼ºå¤§çš„è·¯ç”±ç»„åˆæ–¹å¼ï¼š

```cs showLineNumbers {8,19,36}
using Furion.DynamicApiController;
using Microsoft.AspNetCore.Mvc;

namespace WebApplication38;

[Route("api/[controller]")]
[Route("api2/[controller]")]
public class Test1Service : IDynamicApiController
{
    [HttpGet("test")]
    [HttpPost]
    [AcceptVerbs("PUT", "PATCH")]
    public async Task GetTestName()
    {
        await Task.CompletedTask;
    }
}

public class Test2Service : IDynamicApiController
{
    [HttpGet("/root/test")]
    [HttpGet("test")]
    [HttpGet(Name = "other-test")]
    [HttpGet("template-test", Name = "other-test")]
    [HttpPost]
    [AcceptVerbs("PUT", "PATCH")]
    public async Task GetTestName()
    {
        await Task.CompletedTask;
    }
}

[Route("api/[controller]")]
[Route("api2/[controller]/second")]
[Route("api3/[controller]/three")]
public class Test3Service : IDynamicApiController
{
    [HttpGet]
    [HttpGet("get/[action]")]
    [HttpPost]
    [HttpPost("post/cus-version")]
    public string GetVersion()
    {
        return "1.0.0";
    }
}
```

<img src={useBaseUrl("img/dy10.png")} />

### 5.1.8.10 æ”¯æŒç‰ˆæœ¬æ§åˆ¶

<Tabs
  defaultValue="kzqbb"
  values={[
    { label: "æ§åˆ¶å™¨ç‰ˆæœ¬", value: "kzqbb" },
    { label: "åŠ¨ä½œæ–¹æ³•ç‰ˆæœ¬", value: "dzffbb" },
  ]}
>
  <TabItem value="kzqbb">

```cs showLineNumbers  {5,13,21}
using Furion.DynamicApiController;

namespace Furion.Application
{
    public class FurionAppServiceV1 : IDynamicApiController
    {
        public string Get()
        {
            return nameof(Furion);
        }
    }

    public class FurionAppServiceV1_2 : IDynamicApiController
    {
        public string Get()
        {
            return nameof(Furion);
        }
    }

    public class FurionAppServiceV1_2_1 : IDynamicApiController
    {
        public string Get()
        {
            return nameof(Furion);
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/kzqbb.png")} />

  </TabItem>
  <TabItem value="dzffbb">

```cs showLineNumbers  {7,12,16}
using Furion.DynamicApiController;

namespace Furion.Application
{
    public class FurionAppService : IDynamicApiController
    {
        public string Get()
        {
            return nameof(Furion);
        }

        public string GetV1()
        {
            return nameof(Furion);
        }
        public string GetV2_1()
        {
            return nameof(Furion);
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/dzffbb.png")} />

  </TabItem>
</Tabs>

:::note ç‰ˆæœ¬ç”ŸæˆåŸç†

**`V[0-9_]`** ç»“å°¾çš„å‘½åè‡ªåŠ¨è§£ææˆç‰ˆæœ¬å·ï¼Œå¦‚ **`FurionAppServiceV2 -> Furion@2`**ã€‚

:::

:::tip ç‰ˆæœ¬å¤å†™

é™¤äº†é€šè¿‡ç‰¹å®šåç¼€æ–¹å¼ä»¥å¤–ï¼Œç‰ˆæœ¬è¿˜ç›´æ¥é€šè¿‡ `[ApiDescriptionSettings]` è¿›è¡Œå¤å†™ã€‚å¦‚ï¼š

```cs showLineNumbers  {1,2}
[ApiDescriptionSettings(Version = "4.0")]
public string GetV1()
{
    return nameof(Furion);
}
```

è¿™æ—¶ï¼Œç”Ÿæˆç‰ˆæœ¬å°†é‡‡ç”¨ `4.0` æ›¿ä»£ `1`

:::

### 5.1.8.11 ä¸å…¬å¼€æ§åˆ¶å™¨æˆ–åŠ¨ä½œæ–¹æ³•

æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬æ— éœ€å¯¼å‡ºæŸä¸ªåŠ¨ä½œæ–¹æ³•æˆ–æ§åˆ¶å™¨ï¼ˆ**ä¸æ˜¾ç¤ºåˆ° Swagger**ï¼‰ï¼Œåªéœ€è¦æ·»åŠ  `[ApiDescriptionSettings(false)]` æˆ– `[ApiDescriptionSettings(IgnoreApi = true)]`å³å¯ã€‚

å¦å¤–åŠ¨ä½œæ–¹æ³•è¿˜æ”¯æŒ `[NonAction]` æ ‡è®°ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ§åˆ¶å™¨æˆ– Actionã€‚

```cs showLineNumbers {8,14,20,27}
public class FurionAppService: IDynamicApiController
{
    public string Export()
    {
        // ....
    }

    [ApiDescriptionSettings(false)] // ä¸åœ¨ Swagger ä¸Šæ˜¾ç¤º
    public string NoExport()
    {
        // ...
    }

    [ApiDescriptionSettings(IgnoreApi = true)]  // ä¸åœ¨ Swagger ä¸Šæ˜¾ç¤º
    public string NoExport2()
    {
        // ...
    }

    [NonAction]     // ä¸æ˜¯ä¸€ä¸ª API
    public string IsNotAPI()
    {
        // ...
    }
}

[ApiDescriptionSettings(false)] // ä¸å¯¼å‡º
public class NoExportServices: IDynamicApiController
{
    // ....
}
```

### 5.1.8.12 ä¿æŒæ§åˆ¶å™¨å’Œæ–¹æ³•å‘½å

é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŠ¨æ€ API ä¼šå°†æ§åˆ¶å™¨å’Œæ–¹æ³•åè¾“å‡ºä¸º `RESTFul` é£æ ¼çš„è·¯ç”±ï¼Œå¦‚éœ€ä¿ç•™åŸæœ‰è®¾è®¡ï¼Œåªéœ€é…ç½®ï¼š

```json showLineNumbers {2-5}
{
  "DynamicApiControllerSettings": {
    "KeepName": true,
    "KeepVerb": true,
    "LowercaseRoute": false
  }
}
```

### 5.1.8.13 æ–¹æ³•å‚æ•° `[FromQuery]` åŒ–/å‚æ•°éå¿…å¡«/å‚æ•°å¯é€‰

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„åŸºå…ƒç±»å‹å‚æ•°éƒ½ä¼šè´´ä¸Š `[FromRoute]` ç‰¹æ€§ï¼Œå¦‚æœéœ€è¦å°†å‚æ•°è°ƒæ•´ä¸º `[FromQuery]` ä¿®é¥°ï¼Œåªéœ€è¦åœ¨æ–¹æ³•ä¸Šé¢è´´ `[QueryParameters]` ç‰¹æ€§å³å¯ï¼Œå¦‚ï¼š

```cs showLineNumbers {1}
[QueryParameters]
public string Get(int id, string name)
{
    return nameof($"{id} {name}");
}
```

ç”Ÿæˆçš„è·¯ç”±ä¸ºï¼š`https://xxx.com?id=1&name=Furion`

å¦‚æœä¸å–œæ¬¢æ¯ä¸ªéƒ½é…ç½®ï¼Œä¹Ÿå¯ä»¥å…¨å±€é…ç½®ï¼ˆ**åªä¼šå½±å“åŸºå…ƒç±»å‹çš„å‚æ•°**ï¼‰ï¼š

```json showLineNumbers {2-3}
{
  "DynamicApiControllerSettings": {
    "UrlParameterization": true
  }
}
```

:::important ç‰¹åˆ«æ³¨æ„

è´´äº† `[QueryParameters]` ä¹‹åï¼Œä¼šå¯¹æ‰€æœ‰å‚æ•°å½±å“ï¼ŒåŒ…æ‹¬ç±»ç±»å‹å‚æ•°ï¼Œå¦‚æœä¸éœ€è¦å¤„ç†æŸä¸ªå‚æ•°ï¼Œåªéœ€è¦è´´ `[FromXXX]` ç‰¹æ€§å³å¯ã€‚

:::

### 5.1.8.14 å‚æ•°ç»‘å®šé…ç½®

`Furion` æ¡†æ¶æä¾›äº†å¤šç§å‚æ•°ç‰¹æ€§é…ç½®å‚æ•°ç»‘å®šè§„åˆ™ï¼š

- `[FromRoute]`ï¼šé€šè¿‡è·¯ç”±å‚æ•°ç»‘å®šå€¼
- `[FromQuery]`ï¼šé€šè¿‡ `Url` åœ°å€å‚æ•°ç»‘å®šå€¼
- `[FromBody]`ï¼šé€šè¿‡ `Request Body` å‚æ•°ç»‘å®šå€¼
- `[FromForm]`ï¼šé€šè¿‡è¡¨å•æäº¤ç»‘å®šå€¼
- `[FromHeader]`ï¼šé€šè¿‡ `Request Header` å‚æ•°ç»‘å®šå€¼

### 5.1.8.15 è‡ªå®šä¹‰æ ¹æ®æ–¹æ³•åç”Ÿæˆ `[HttpMethod]` è§„åˆ™

åœ¨ `Furion` æ¡†æ¶ä¸­ï¼Œåœ¨æ²¡æœ‰é…ç½® `[HttpMethod]` ç‰¹æ€§çš„æƒ…å†µä¸‹ï¼Œä¼šè‡ªåŠ¨æ ¹æ®æ–¹æ³•åç¬¬ä¸€ä¸ªå‚æ•°è¿›è¡Œåˆ†æï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„ `[HttpMethod]` ç‰¹æ€§ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š

- åŠ¨ä½œæ–¹æ³•å
  - ä»¥ `Post/Add/Create/Insert/Submit` å¼€å¤´ï¼Œåˆ™æ·»åŠ  `[HttpPost]` ç‰¹æ€§ã€‚
  - ä»¥ `GetAll/GetList/Get/Find/Fetch/Query` å¼€å¤´ï¼Œåˆ™æ·»åŠ  `[HttpGet]` ç‰¹æ€§ã€‚
  - ä»¥ `Put/Update` å¼€å¤´ï¼Œåˆ™æ·»åŠ  `[HttpPut]` ç‰¹æ€§ã€‚
  - ä»¥ `Delete/Remove/Clear` å¼€å¤´ï¼Œåˆ™æ·»åŠ  `[HttpDelete]` ç‰¹æ€§ã€‚
  - ä»¥ `Patch` å¼€å¤´ï¼Œåˆ™æ·»åŠ  `[HttpPatch]` ç‰¹æ€§
  - ä»¥ `Head` å¼€å¤´ï¼Œåˆ™æ·»åŠ  `[HttpHead]` ç‰¹æ€§
  - **æ”¯æŒè‡ªå®šä¹‰é…ç½®**
- å¦‚æœä¸åœ¨ä¸Šé¢çº¦å®šä¸­ï¼Œåˆ™é»˜è®¤æ·»åŠ  `[HttpPost]` ç‰¹æ€§ã€‚**æ”¯æŒè‡ªå®šä¹‰é…ç½®**

**ä½†æ˜¯ï¼Œæœ‰äº›æ—¶å€™è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„è§„åˆ™**ï¼Œè¿™æ—¶æˆ‘ä»¬åªéœ€è¦åœ¨ `appsettings.json` ä¸­é…ç½®å³å¯ï¼š

```json showLineNumbers  {2,3}
{
  "DynamicApiControllerSettings": {
    "VerbToHttpMethods": [
      ["getall", "HEAD"], // => getall ä¼šè¢«å¤å†™ä¸º `[HttpHead]`
      ["other", "PUT"] // => æ–°å¢ä¸€æ¡æ–°è§„åˆ™ï¼Œæ¯”å¦‚ï¼Œä¸€ `[other]` å¼€å¤´ä¼šè½¬æ¢ä¸º `[HttpPut]` è¯·æ±‚
    ]
  }
}
```

:::important ç‰¹åˆ«æ³¨æ„

äºŒç»´æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ çš„ç¬¬ä¸€ä¸ªå…ƒç´ **å¿…é¡»æ˜¯å…¨å°å†™**ï¼Œç¬¬äºŒä¸ªå…ƒç´ **å¿…é¡»æ˜¯å…¨å¤§å†™å¤§å†™**ï¼Œç¬¬äºŒä¸ªå…ƒç´ å–å€¼æœ‰ï¼š`HEAD, GET, PUT, POST, PATCH, DELETE`

:::

### 5.1.8.16 è·¯ç”±å‚æ•°éå¿…å¡«/é€‰å¡«

åœ¨ `Furion v2.8.6` ç‰ˆæœ¬ä¸­å®ç°äº† `[FromRoute]` å‚æ•°éå¿…å¡«åŠŸèƒ½ï¼Œæ”¯æŒä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š

```cs showLineNumbers  {2,6,11,16}
// æ–¹å¼ä¸€ï¼Œé€šè¿‡å¯ç©º ?
public object Method1(int id, Datetime? dateTime)
{
}

// æ–¹å¼äºŒï¼Œé€šè¿‡é»˜è®¤å€¼
public object Method1(int id, int age = 10)
{
}

// æ–¹å¼ä¸‰ï¼Œé»˜è®¤å€¼ + å¯ç©º ?
public object Method1(int id, int? age = 10)
{
}

// æ–¹å¼å››ï¼Œ[FromQuery] ä¿®é¥°
public object Method1(int id, [FromQuery]string keyword)
{
}
```

### 5.1.8.17 `[FormRoute]` è·¯ç”±çº¦æŸ

åœ¨ `Furion v2.8.6` ç‰ˆæœ¬ä¸­ï¼Œæ·»åŠ äº† `[RouteConstraint]` ç‰¹æ€§ï¼Œå¯é…ç½®è·¯ç”±çº¦æŸï¼Œå¦‚ï¼š`[RouteConstraint(":min(10)")]`

```cs showLineNumbers  {2}
// æœ€å°å€¼ 10
public object Method1([RouteConstraint(":min(10)")] int id)
{
}
```

`[RouteConstraint]` æ”¯æŒè·¯ç”±çº¦æŸç¬¦å·å¦‚ä¸‹ï¼š

| ç¬¦å·        | æè¿°                                    | ä¾‹å­                            |
| ----------- | --------------------------------------- | ------------------------------- |
| `*`         | åŒ¹é…è·¯ç”± 0-n é•¿åº¦ï¼ŒFurion 4.8.6.2+ æ”¯æŒ | `:*`                            |
| `alpha`     | åŒ¹é…å¤§å†™æˆ–å°å†™æ‹‰ä¸å­—æ¯å­—ç¬¦ï¼ˆa-zã€A-Zï¼‰  | `:alpha`                        |
| `bool`      | bool ç±»å‹                               | `:bool`                         |
| `datetime`  | DateTime ç±»å‹                           | `:datetime`                     |
| `decimal`   | decimal ç±»å‹                            | `:decimal`                      |
| `double`    | double ç±»å‹                             | `:double`                       |
| `float`     | float ç±»å‹                              | `:float`                        |
| `guid`      | guid ç±»å‹                               | `:guid`                         |
| `int`       | int ç±»å‹                                | `:int`                          |
| `long`      | long ç±»å‹                               | `:long`                         |
| `length`    | åŒ¹é…é•¿åº¦ï¼ˆå­—ç¬¦ä¸²ï¼‰                      | `:length(6)` æˆ– `:length(1,20)` |
| `max`       | æœ€å¤§å€¼                                  | `:max(10)`                      |
| `maxlength` | æœ€å¤§é•¿åº¦ï¼ˆå­—ç¬¦ä¸²ï¼‰                      | `:maxlength(10)`                |
| `min`       | æœ€å°å€¼                                  | `:min(10)`                      |
| `minlength` | æœ€å°é•¿åº¦ï¼ˆå­—ç¬¦ä¸²ï¼‰                      | `:minlength(10)`                |
| `range`     | å–å€¼èŒƒå›´                                | `:range(10,50)`                 |
| `regex`     | æ­£åˆ™è¡¨è¾¾å¼                              | `:regex(^\d{3}-\d{3}-\d{4}$)`   |

### 5.1.8.18 `å°é©¼å³°` è·¯ç”±è·¯å¾„

```json showLineNumbers {2-5}
{
  "DynamicApiControllerSettings": {
    "LowercaseRoute": false,
    "KeepName": true,
    "AsLowerCamelCase": true
  }
}
```

### 5.1.8.19 `application/xml` æŠ¥æ–‡å‚æ•°æ”¯æŒ

1. åœ¨ `Startup.cs` ä¸­å¯ç”¨ `XML` è¯·æ±‚æŠ¥æ–‡æ ¼å¼æ”¯æŒ

```cs showLineNumbers {2-3}
services.AddControllers()   // .AddControllersWithViews()
        .AddXmlSerializerFormatters()
        .AddXmlDataContractSerializerFormatters()
```

:::warning å¼‚å¸¸å¤„ç†

å¦‚æœå‡ºç° `XmlSerializer` å¼‚å¸¸ï¼Œé‚£ä¹ˆåªéœ€è¦ç§»é™¤ `.AddXmlSerializerFormatters()` å³å¯ï¼Œå¦‚ï¼š

```cs showLineNumbers {2}
services.AddControllers()   // .AddControllersWithViews()
        .AddXmlDataContractSerializerFormatters()
```

:::

2. å®šä¹‰å®ä½“ç±»å‹

```cs showLineNumbers
// å®ä½“ç±»å‹
public class People
{
    // åŸºç¡€ç±»å‹
    public int Age { get; set; }
    public string Name { get; set; }
    public bool IsDeleted { get; set; }

    // æ•°ç»„ç±»å‹
    public string[] Address { get; set; }

    // é›†åˆç±»å‹
    public List<string> Emails { get; set; }

    // ç±»ç±»å‹
    public Child Child { get; set; }
}

public class Child
{
    public string Name { get; set; }
}
```

3. åœ¨åŠ¨æ€ `WebAPI` ä¸­ä½¿ç”¨

```cs showLineNumbers {3-4}
public class XmlDemo : IDynamicApiController
{
    //[Consumes("application/xml")] // å¦‚æœè®¾ç½®äº† [Consumes] é‚£ä¹ˆå°±è¡¨ç¤ºåªèƒ½ä¼ é€’ `accept= application/xml` æ ¼å¼ï¼Œä¸è®¾ç½®åˆ™æ”¯æŒå¤šç§ï¼ˆXML/JSON)
    public People Test(People people)
    {
        return people;
    }
}
```

:::important `[Consumes]` å’Œ `[Produces]` è¯´æ˜

`[Consumes]` ç‰¹æ€§æ˜¯ç”¨æ¥å®šä¹‰è¾“å…¥å‚æ•°æ ¼å¼ï¼Œå¯¹åº”è¯·æ±‚æŠ¥æ–‡çš„ `accept`ï¼Œ`[Produces]` ç‰¹æ€§æ˜¯ç”¨æ¥å®šä¹‰è¿”å›å€¼æ ¼å¼ï¼Œå¯¹åº”å“åº”æŠ¥æ–‡çš„ `content-type`ã€‚

:::

4. `XML` æ ¼å¼è¯´æ˜åŠæ³¨æ„äº‹é¡¹

æ”¯æŒä¸¤ç§ `XML` æ ¼å¼æŠ¥æ–‡ï¼Œå¦‚ï¼š

:::caution æ³¨æ„äº‹é¡¹

`XML` æ ‡ç­¾åŒºåˆ†å¤§å°å†™ï¼Œå¿…é¡»ä¸¥æ ¼å¯¹ç…§ `C#` ç±»å‹å®šä¹‰å£°æ˜ã€‚å¯¹äºé›†åˆ/æ•°ç»„ç±»å‹ï¼Œå¿…é¡»éµå¾ªä¸‹åˆ—æ ¼å¼ï¼š

```xml showLineNumbers
<å±æ€§å>
    <C#ç±»å‹></C#ç±»å‹>
</å±æ€§å>
```

å¦‚ï¼š

```xml showLineNumbers {1,5,9,13,17,21}
<Strings>
    <string>monksoul@outlook.com</string>
    <string>rustln@outlook.com</string>
</Strings>
<Ints>
    <int>1</int>
    <int>2</int>
</Ints>
<Bools>
    <boolean>true</boolean>
    <boolean>false</boolean>
</Bools>
<Decimals>
    <decimal>1.0</decimal>
    <decimal>2.0</decimal>
</Decimals>
<Floats>
    <float>1.0</float>
    <float>2.0</float>
</Floats>
<Childs>
    <Child>
      <Name>Furion</Name>
    </Child>
</Childs>
```

:::

- ç¬¬ä¸€ç§ï¼ˆå¸¸ç”¨æ ¼å¼ï¼‰

```xml showLineNumbers {1-2}
<?xml version="1.0" encoding="UTF-8"?>
<People>
  <Age>30</Age>
  <Name>ç™¾å°åƒ§</Name>
  <IsDeleted>true</IsDeleted>
  <Address>
    <string>å¹¿ä¸œçœä¸­å±±å¸‚</string>
    <string>å¹¿ä¸œçœç æµ·å¸‚</string>
  </Address>
  <Emails>
    <string>monksoul@outlook.com</string>
    <string>rustln@outlook.com</string>
  </Emails>
  <Child>
    <Name>Furion</Name>
  </Child>
</People>
```

- ç¬¬äºŒç§ï¼ˆæ ‡å‡†æ ¼å¼ï¼‰

```xml showLineNumbers {1}
<People xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
  <Age>30</Age>
  <Name>ç™¾å°åƒ§</Name>
  <IsDeleted>true</IsDeleted>
  <Address>
    <string>å¹¿ä¸œçœä¸­å±±å¸‚</string>
    <string>å¹¿ä¸œçœç æµ·å¸‚</string>
  </Address>
  <Emails>
    <string>monksoul@outlook.com</string>
    <string>rustln@outlook.com</string>
  </Emails>
  <Child>
    <Name>Furion</Name>
  </Child>
</People>
```

## 5.1.9 `[ApiDescriptionSettings]`

é™¤äº†ä¸Šè¿° `ASP.NET Core` æä¾›çš„é…ç½®å¤–ï¼Œ`Furion` æ¡†æ¶è¿˜æä¾›äº†éå¸¸å¼ºå¤§ä¸”çµæ´»çš„ `[ApiDescriptionSettings]` ç‰¹æ€§ã€‚

### 5.1.9.1 å†…ç½®é…ç½®

- `Name`ï¼šè‡ªå®šä¹‰æ§åˆ¶å™¨/åŠ¨ä½œæ–¹æ³•åç§°ï¼Œ`string`ï¼Œé»˜è®¤ `null`
- `KeepName`ï¼šæ˜¯å¦ä¿æŒåŸæœ‰åç§°ä¸å¤„ç†ï¼Œ`bool`ï¼Œé»˜è®¤ `false`
- `SplitCamelCase`ï¼šåˆ‡å‰²éª†é©¼(é©¼å³°)/å¸•æ–¯å¡å‘½åï¼Œ`bool`ï¼Œé»˜è®¤ `true`
- `KeepVerb`ï¼šæ˜¯å¦ä¿ç•™åŠ¨ä½œæ–¹æ³•è¯·æ±‚è°“è¯ï¼Œ`bool`ï¼Œé»˜è®¤ `false`
- `Enabled`ï¼šæ˜¯å¦å¯¼å‡ºæ¥å£ï¼Œ`bool`ï¼Œé»˜è®¤ `true`
- `Module`ï¼šæ¨¡å—åï¼Œ`string`ï¼Œé»˜è®¤ `null`
- `Version`ï¼šç‰ˆæœ¬å·ï¼Œ`string`ï¼Œé»˜è®¤ `null`
- `Groups`ï¼šæ¥å£åˆ†ç»„ï¼Œå¯ç»“åˆ `Swagger` ä¸€èµ·ä½¿ç”¨ï¼Œ`string[]`ï¼Œé»˜è®¤ `null`
- `Tags`ï¼šæ¥å£æ ‡ç­¾ï¼Œå¯ç»“åˆ `Swagger` ä¸€èµ·ä½¿ç”¨ï¼Œ`string[]`ï¼Œé»˜è®¤ `null`
- `Order`ï¼šé…ç½®æ§åˆ¶å™¨/åŠ¨ä½œæ–¹æ³•æ’åºï¼Œæ•°å€¼è¶Šå¤§è¶Šé å‰
- `LowercaseRoute`ï¼šæ˜¯å¦é‡‡ç”¨å°å†™è·¯ç”±ï¼Œ`bool` ç±»å‹ï¼Œé»˜è®¤ `true`
- `AsLowerCamelCase`ï¼šå¯ç”¨å°é©¼å³°å‘½åï¼ˆé¦–å­—æ¯å°å†™ï¼‰ï¼Œé»˜è®¤ `false`
- `Area`ï¼šé…ç½®åŒºåŸŸåç§°ï¼Œé»˜è®¤ç©ºï¼Œ**åªä½œç”¨äºç±»ä¸­è´´**
- `Description`ï¼šé…ç½®å•ä¸€æ¥å£æ›´å¤šæè¿°åŠŸèƒ½ï¼Œåªåœ¨ `æ–¹æ³•` ä¸­æœ‰æ•ˆï¼Œ**ä»…é™ v3.3.5+ç‰ˆæœ¬æœ‰æ•ˆ**
- `ForceWithRoutePrefix`ï¼šé…ç½®æ˜¯å¦å¼ºåˆ¶æ·»åŠ  `DefaultRoutePrefix`ï¼Œå½“æ§åˆ¶å™¨è‡ªå®šä¹‰äº† `[Route]` æœ‰æ•ˆï¼Œé»˜è®¤ `false`ï¼Œ**ä»…é™ v3.4.1+ç‰ˆæœ¬æœ‰æ•ˆ**

### 5.1.9.2 `Name` é…ç½®

`Name` å‚æ•°å¯ä»¥è¦†ç›–åŠ¨æ€ `WebAPI` è‡ªåŠ¨ç”Ÿæˆçš„æ§åˆ¶å™¨æˆ–åŠ¨ä½œæ–¹æ³•åç§°ã€‚å¦‚ï¼š

```cs showLineNumbers  {5,8,14,20}
using Furion.DynamicApiController;

namespace Furion.Application
{
    [ApiDescriptionSettings(Name = "MyFur")]
    public class FurionAppService : IDynamicApiController
    {
        [ApiDescriptionSettings(Name = "MyGet")]
        public string Get()
        {
            return nameof(Furion);
        }

        [ActionName("MyTest")]  // Furion 4.8.4.12+ æ”¯æŒ
        public string Test()
        {
            return nameof(Furion);
        }

        [HttpGet(Name = "MyTest")]  // Furion 4.8.4.12+ æ”¯æŒï¼Œæ­¤é…ç½®æœ‰æ•ˆçš„å‰ææ˜¯æ§åˆ¶å™¨è´´æœ‰ [Route] ç‰¹æ€§
        public string Test2()
        {
            return nameof(Furion);
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/namepz.png")} />

### 5.1.9.3 `KeepName` é…ç½®

`KeepName` å‚æ•°å¯ä»¥ä¿ç•™åŸæœ‰çš„æ§åˆ¶å™¨æˆ–åŠ¨ä½œæ–¹æ³•åç§°ã€‚å¦‚ï¼š

```cs showLineNumbers  {5,8}
using Furion.DynamicApiController;

namespace Furion.Application
{
    [ApiDescriptionSettings(KeepName = true)]
    public class FurionAppService : IDynamicApiController
    {
        [ApiDescriptionSettings(KeepName = true)]
        public string Get()
        {
            return nameof(Furion);
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/keepnamepz.png")} />

### 5.1.9.4 `SplitCamelCase` é…ç½®

`SplitCamelCase` å‚æ•°é»˜è®¤å°†éª†é©¼(é©¼å³°)å‘½ååˆ‡å‰²æˆå¤šä¸ªå•è¯å¹¶é€šè¿‡æŒ‡å®š `å ä½ç¬¦` è¿æ¥èµ·æ¥ã€‚é»˜è®¤ `å ä½ç¬¦` ä¸º `-`ã€‚é»˜è®¤ä¸º `true`ã€‚å¦‚ï¼š

```cs showLineNumbers  {5,8}
using Furion.DynamicApiController;

namespace Furion.Application
{
    [ApiDescriptionSettings(SplitCamelCase = false)]
    public class MyFurionAppService : IDynamicApiController
    {
        [ApiDescriptionSettings(SplitCamelCase = true)]
        public string ChangeUserName()
        {
            return nameof(Furion);
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/splitnamepz.png")} />

:::important ç‰¹åˆ«æ³¨æ„

`KeepName` ä¼˜å…ˆçº§é«˜äº `SplitCamelCase`ï¼Œä¹Ÿå°±æ˜¯ `KeepName` è®¾ç½®ä¸º `true`ï¼Œåˆ™ä¸ä¼šå¤„ç† `SplitCamelCase` å‚æ•°ã€‚

:::

### 5.1.9.5 `KeepVerb` é…ç½®

`KeepVerb` å‚æ•°ä½œç”¨äºåŠ¨ä½œæ–¹æ³•ï¼Œæ ‡è¯†æ˜¯å¦ä¿ç•™åŠ¨ä½œè°“è¯ã€‚å¦‚ï¼š

```cs showLineNumbers  {7}
using Furion.DynamicApiController;

namespace Furion.Application
{
    public class FurionAppService : IDynamicApiController
    {
        [ApiDescriptionSettings(KeepVerb = true)]
        public string GetVersion()
        {
            return nameof(Furion);
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/keepverbpz.png")} />

### 5.1.9.6 `Enabled` é…ç½®

`Enabled` å‚æ•°é…ç½®æ¥å£æ˜¯å¦å¯¼å‡ºã€‚é€šå¸¸ç”¨äºåŠ¨ä½œæ–¹æ³•ï¼Œå¦‚æœç”¨äºæ§åˆ¶å™¨å®é™…ä½œç”¨ä¸å¤§ã€‚

```cs showLineNumbers  {12}
using Furion.DynamicApiController;

namespace Furion.Application
{
    public class FurionAppService : IDynamicApiController
    {
        public string GetVersion()
        {
            return nameof(Furion);
        }

        [ApiDescriptionSettings(false)]
        public string NoExport()
        {
            return nameof(Furion);
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/enablepz.png")} />

### 5.1.9.7 `Module` é…ç½®

`Module` å‚æ•°å¯ä»¥é…ç½®è·¯ç”±åˆ†ç¦»ï¼Œç±»ä¼¼äº `Mvc åŒºåŸŸ` çš„ä½œç”¨ã€‚

```cs showLineNumbers  {5,8}
using Furion.DynamicApiController;

namespace Furion.Application
{
    [ApiDescriptionSettings(Module = "mobile")]
    public class FurionAppService : IDynamicApiController
    {
        [ApiDescriptionSettings(Module = "user")]
        public string GetVersion()
        {
            return nameof(Furion);
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/modulepz.png")} />

### 5.1.9.8 `Version` é…ç½®

`Version` å‚æ•°å¯ä»¥é…ç½®æ¥å£ç‰ˆæœ¬ï¼ŒåŒæ—¶åˆå¯ä»¥å¤å†™ç‰¹æ®Šç‰ˆæœ¬å‘½åé…ç½®ã€‚é»˜è®¤ç‰ˆæœ¬åˆ†éš”ç¬¦ä¸º `@`ã€‚å¦‚ï¼š

```cs showLineNumbers  {5,9-10}
using Furion.DynamicApiController;

namespace Furion.Application
{
    [ApiDescriptionSettings(Version = "1.0")]
    public class FurionAppService : IDynamicApiController
    {
        // V2.0.0 è¢«å¤å†™æˆ V2.1.1
        [ApiDescriptionSettings(Version = "2.1.1")]
        public string GetVersionV2_0_0()
        {
            return nameof(Furion);
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/versionpz.png")} />

### 5.1.9.9 `Groups` é…ç½®

`Groups` é…ç½®ä¸»è¦ç”¨äºé…ç½® `Swagger` åˆ†ç»„ä¿¡æ¯ã€‚

é€šè¿‡é…ç½® `Groups` å‚æ•°å¯ä»¥å°†`æ§åˆ¶å™¨å’ŒåŠ¨ä½œæ–¹æ³•` è¿›è¡Œå½’ç±»å’Œå¤šä¸ªåˆ†ç»„ç›´æ¥å…±äº«ã€‚å¯é€šè¿‡ `[ApiDescriptionSettings(params Groups)]` æ„é€ å‡½æ•°ä¼ å…¥æˆ–æŒ‡å®š `Groups` å‚æ•°é…ç½®æ¥å£æ˜¯å¦å¯¼å‡ºã€‚é€šå¸¸ç”¨äºåŠ¨ä½œæ–¹æ³•ï¼Œå¦‚æœç”¨äºæ§åˆ¶å™¨å®é™…ä½œç”¨ä¸å¤§ã€‚

```cs showLineNumbers  {5,13}
using Furion.DynamicApiController;

namespace Furion.Application
{
    [ApiDescriptionSettings("Default", "Common")]
    public class FurionAppService : IDynamicApiController
    {
        public string Get()
        {
            return nameof(Furion);
        }

        [ApiDescriptionSettings("Custom")]
        public int Get(int id)
        {
            return id;
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/dfz.gif")} />

### 5.1.9.10 `Tag` é…ç½®

`Tag` é…ç½®ä¸»è¦ç”¨äºé…ç½® `Swagger` æ ‡ç­¾åˆ†ç»„ä¿¡æ¯åŠåˆå¹¶æ ‡ç­¾ã€‚ä¹Ÿå°±æ˜¯ `ç»„ä¸­ç»„`:

<Tabs
  defaultValue="tag1"
  values={[
    { label: "æ ‡ç­¾å‘½å", value: "tag1" },
    { label: "åˆå¹¶æ ‡ç­¾", value: "tag2" },
  ]}
>
  <TabItem value="tag1">

#### æœªè´´æ ‡ç­¾ä¹‹å‰

```cs showLineNumbers
using Furion.DynamicApiController;

namespace Furion.Application
{
    public class FurionAppService : IDynamicApiController
    {
        public string Get()
        {
            return nameof(Furion);
        }

        public int Get(int id)
        {
            return id;
        }
    }

    public class TestAppService : IDynamicApiController
    {
        public string Get()
        {
            return nameof(Furion);
        }

        public int Get(int id)
        {
            return id;
        }
    }
}
```

#### è´´æ ‡ç­¾ä¹‹å

```cs showLineNumbers  {5,19}
using Furion.DynamicApiController;

namespace Furion.Application
{
    [ApiDescriptionSettings(Tag = "åˆ†ç»„ä¸€")]
    public class FurionAppService : IDynamicApiController
    {
        public string Get()
        {
            return nameof(Furion);
        }

        public int Get(int id)
        {
            return id;
        }
    }

    [ApiDescriptionSettings(Tag = "åˆ†ç»„äºŒ")]
    public class TestAppService : IDynamicApiController
    {
        public string Get()
        {
            return nameof(Furion);
        }

        public int Get(int id)
        {
            return id;
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/tag1.png")} />

  </TabItem>
  <TabItem value="tag2">

```cs showLineNumbers  {5,19}
using Furion.DynamicApiController;

namespace Furion.Application
{
    [ApiDescriptionSettings(Tag = "åˆå¹¶æ‰€æœ‰æ ‡ç­¾")]
    public class FurionAppService : IDynamicApiController
    {
        public string Get()
        {
            return nameof(Furion);
        }

        public int Get(int id)
        {
            return id;
        }
    }

    [ApiDescriptionSettings(Tag = "åˆå¹¶æ‰€æœ‰æ ‡ç­¾")]
    public class TestAppService : IDynamicApiController
    {
        public string Get()
        {
            return nameof(Furion);
        }

        public int Get(int id)
        {
            return id;
        }
    }
}
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src={useBaseUrl("img/tag2.png")} />

  </TabItem>
</Tabs>

:::tip å°çŸ¥è¯†

å¦‚æœ `Tag` åå­—ä¸€æ ·ï¼Œåˆ™ä¼šè‡ªåŠ¨åˆå¹¶ï¼Œå¦åˆ™åªæ˜¯å‘½åã€‚

:::

## 5.1.10 `DynamicApiControllerSettings` é…ç½®

`Furion` è¿˜æä¾›åŠ¨æ€ `WebAPI` æ¥å£ä¸€äº›å…¨å±€é…ç½®é€‰é¡¹ï¼Œå¦‚ï¼š

- `DefaultRoutePrefix`ï¼šé»˜è®¤è·¯ç”±å‰ç¼€ï¼Œ`string`ï¼Œé»˜è®¤ `api`
- `DefaultHttpMethod`ï¼šé»˜è®¤è¯·æ±‚è°“è¯ï¼Œ`string`ï¼Œé»˜è®¤ï¼š`POST`
- `DefaultModule`ï¼šé»˜è®¤æ¨¡å—åç§°ï¼ˆåŒºåŸŸï¼‰ï¼Œå¯ç”¨ä½œæ¥å£ç‰ˆæœ¬ï¼Œ`string`ï¼Œé»˜è®¤ï¼š`v1`
- `LowercaseRoute`ï¼šå°å†™è·¯ç”±æ ¼å¼ï¼Œ`bool`ï¼Œé»˜è®¤ï¼š`true`
- `AsLowerCamelCase`ï¼šå¯ç”¨å°é©¼å³°å‘½åï¼ˆé¦–å­—æ¯å°å†™ï¼‰ï¼Œé»˜è®¤ `false`
- `KeepVerb`ï¼šæ˜¯å¦ä¿ç•™åŠ¨ä½œè°“è¯ï¼Œ`bool`ï¼Œé»˜è®¤ï¼š`false`
- `KeepName`ï¼šæ˜¯å¦ä¿ç•™é»˜è®¤åç§°ï¼Œ`bool`ï¼Œé»˜è®¤ï¼š`fasle`
- `CamelCaseSeparator`ï¼šéª†é©¼(é©¼å³°)/å¸•æ–¯å¡å‘½ååˆ†éš”ç¬¦ï¼Œ`string`ï¼Œé»˜è®¤ï¼š`-`
- `VersionSeparator`ï¼šç‰ˆæœ¬åˆ†éš”ç¬¦ï¼Œ`string`ï¼Œé»˜è®¤ï¼š`@`
- `ModelToQuery`ï¼š`GET/HEAD` è¯·æ±‚å°† `ç±»ç±»å‹å‚æ•°è½¬æŸ¥è¯¢å‚æ•°`ï¼Œ`bool`ï¼Œé»˜è®¤ `false`
- `SupportedMvcController`ï¼šæ˜¯å¦æ”¯æŒ `Mvc Controller` åŠ¨æ€é…ç½®ï¼Œ`bool`ï¼Œé»˜è®¤ `false`
- `UrlParameterization`ï¼šè·¯ç”±å‚æ•°é‡‡ç”¨ `[FromQuery]` åŒ–ï¼Œé»˜è®¤ `false`ï¼ˆ`[FromRoute]` æ–¹å¼ï¼‰
- `DefaultArea`ï¼šé…ç½®é»˜è®¤åŒºåŸŸï¼Œé»˜è®¤ `null`
- `ForceWithRoutePrefix`ï¼šé…ç½®æ˜¯å¦å¼ºåˆ¶æ·»åŠ  `DefaultRoutePrefix`ï¼Œå½“æ§åˆ¶å™¨è‡ªå®šä¹‰äº† `[Route]` æœ‰æ•ˆï¼Œ**ä»…é™ v3.4.1+ç‰ˆæœ¬æœ‰æ•ˆ**
- `AbandonControllerAffixes`ï¼šé»˜è®¤å»é™¤æ§åˆ¶å™¨åç§°å‰åç¼€åˆ—è¡¨åï¼Œ`string[]`ï¼Œé»˜è®¤ï¼š
  - `AppServices`
  - `AppService`
  - `ApiController`
  - `Controller`
  - `Services`
  - `Service`
- `AbandonActionAffixes`ï¼šé»˜è®¤å»é™¤åŠ¨ä½œæ–¹æ³•åç§°å‰åç¼€åˆ—è¡¨åï¼Œ`string[]`ï¼Œé»˜è®¤ï¼š
  - `Async`
- `VerbToHttpMethods`ï¼šå¤å†™é»˜è®¤æ–¹æ³•åè½¬ `[HttpMethod]` è§„åˆ™ï¼Œ`string[][]` äºŒç»´æ•°ç»„ç±»å‹ï¼Œå†…ç½®åŒ¹é…è§„åˆ™ä¸ºï¼š
  ```cs showLineNumbers
  ["post"] = "POST",
  ["add"] = "POST",
  ["create"] = "POST",
  ["insert"] = "POST",
  ["submit"] = "POST",
  ["get"] = "GET",
  ["find"] = "GET",
  ["fetch"] = "GET",
  ["query"] = "GET",
  ["put"] = "PUT",
  ["update"] = "PUT",
  ["delete"] = "DELETE",
  ["remove"] = "DELETE",
  ["clear"] = "DELETE",
  ["patch"] = "PATCH"
  ```
  - å¤å†™ç¤ºä¾‹
  ```json showLineNumbers
  "DynamicApiControllerSettings": {
      "VerbToHttpMethods": [
        [ "getall", "HEAD" ],  // => getall ä¼šè¢«å¤å†™ä¸º `[HttpHead]`
        [ "other", "PUT" ]  // => æ–°å¢ä¸€æ¡æ–°è§„åˆ™ï¼Œæ¯”å¦‚ï¼Œä¸€ `[other]` å¼€å¤´ä¼šè½¬æ¢ä¸º `[HttpPut]` è¯·æ±‚
      ]
    }
  ```

### 5.1.10.1 æ”¯æŒ `Mvc æ§åˆ¶å™¨` åŠ¨æ€é…ç½®

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`Furion` åŠ¨æ€ `WebAPI` æ¥å£ä¸å¯¹ `ControllerBase` ç±»å‹è¿›è¡Œä»»ä½•å¤„ç†ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨å¯ç”¨ `ControllerBase` æ”¯æŒã€‚

```json showLineNumbers  {2-4} title="Furion.Web.Entry/appsettings.json"
{
  "DynamicApiControllerSettings": {
    "SupportedMvcController": true
  }
}
```

è®¾ç½® `SupportedMvcController: true` åï¼Œ`Mvc ControllerBase` ç±»å‹ä¹Ÿèƒ½å’ŒåŠ¨æ€ `WebAPI` ä¸€æ ·çš„çµæ´»äº†ã€‚ä»£ç å¦‚ä¸‹ï¼š

```cs showLineNumbers  {5}
using Microsoft.AspNetCore.Mvc;

namespace Furion.Web.Entry.Controllers
{
    public class MvcController : ControllerBase
    {
        public string Get()
        {
            return nameof(Furion);
        }
    }
}

```

:::warning æ³¨æ„äº‹é¡¹

å¯ç”¨è¯¥é…ç½®åï¼Œå¦‚æœ `Mvc æ§åˆ¶å™¨` æ²¡æœ‰ä»»ä½• `[Route]` ç‰¹æ€§ï¼Œä½†æ˜¯è´´äº† `[ApiController]` ç‰¹æ€§å°†ä¼šæŠ¥é”™ã€‚åŸå› æ˜¯ `[ApiController]` ç‰¹æ€§å†…éƒ¨åšäº†è·¯ç”±ç‰¹æ€§æ£€æµ‹ã€‚æ‰€ä»¥å»ºè®®ä½¿ç”¨ `[ApiDataValidation]` ä»£æ›¿ã€‚

æŸ¥çœ‹ [ASP.NET Core - ApiBehaviorApplicationModelProvider æºç ](https://github.com/dotnet/aspnetcore/blob/c565386a3ed135560bc2e9017aa54a950b4e35dd/src/Mvc/Mvc.Core/src/ApplicationModels/ApiBehaviorApplicationModelProvider.cs#L90)

:::

## 5.1.11 å…³äº AOP æ‹¦æˆª

`åŠ¨æ€WebAPI` æ”¯æŒ `Controller` çš„æ‰€æœ‰è¿‡æ»¤å™¨/ç­›é€‰å™¨æ‹¦æˆªï¼Œä¹Ÿå°±æ˜¯å¯ä»¥é€šè¿‡ `ActionFilter`ï¼Œ`ResultFilter` è¿›è¡Œæ‹¦æˆªæ“ä½œã€‚å¦‚ï¼š

```cs showLineNumbers  {1,3}
public class SampleAsyncActionFilter : IAsyncActionFilter
{
    public async Task OnActionExecutionAsync(ActionExecutingContext context,ActionExecutionDelegate next)
    {
        // æ‹¦æˆªä¹‹å‰

        var resultContext = await next();

        // æ‹¦æˆªä¹‹å

        // å¼‚å¸¸æ‹¦æˆª
        if(resultContext.Exception != null)
        {

        }
    }
}
```

è¯¦ç»†ç”¨æ³•å¯å‚è§ [ASP.NET Core 5.0 - ç­›é€‰å™¨](https://docs.microsoft.com/zh-cn/aspnet/core/mvc/controllers/filters?view=aspnetcore-5.0)

## 5.1.12 è®¾ç½® `api` è¶…æ—¶è¯·æ±‚æ—¶é—´

åœ¨ `Program.cs` ä¸­æ·»åŠ  `.UseKestrel` é…ç½®å³å¯ï¼Œå¦‚ï¼š

- `.NET5 ç‰ˆæœ¬`

```cs showLineNumbers  {8-12}
public static IHostBuilder CreateHostBuilder(string[] args)
{
    return Host.CreateDefaultBuilder(args)
        .ConfigureWebHostDefaults(webBuilder =>
        {
            webBuilder.Inject()
                      .UseStartup<Startup>()
                      .UseKestrel(option =>
                      {
                          option.Limits.KeepAliveTimeout = TimeSpan.FromMinutes(20);
                          option.Limits.RequestHeadersTimeout = TimeSpan.FromMinutes(20);
                      });
        });
}
```

- `.NET6 ç‰ˆæœ¬`

```cs showLineNumbers  {3-7}
var app = builder.Build();

app.Configuration.Get<WebHostBuilder>().ConfigureKestrel(x =>
{
    x.Limits.KeepAliveTimeout = TimeSpan.FromMinutes(20);
    x.Limits.RequestHeadersTimeout = TimeSpan.FromMinutes(20);
});
```

## 5.1.13 è·å–è·¯ç”±/æ§åˆ¶å™¨/`Action` åˆ—è¡¨

æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦è·å–å½“å‰è·¯ç”±ä¿¡æ¯ï¼Œæˆ–æ‰€æœ‰æ§åˆ¶å™¨ã€`Action` åˆ—è¡¨ï¼Œè€Œå·²é€šè¿‡ä»¥ä¸‹ä»£ç è·å–ï¼š

- **è·å–å½“å‰è·¯ç”±è¡¨ä¿¡æ¯ï¼ˆç®€æ˜“ï¼‰**

```cs showLineNumbers {4,11,14}
public class MetadataService : IDynamicApiController
{
    private readonly IHttpContextAccessor _httpContextAccessor;
    public MetadataService(IHttpContextAccessor httpContextAccessor)
    {
        _httpContextAccessor = httpContextAccessor;
    }

    public RouteValueDictionary Print()
    {
        var routeValuesFeature = _httpContextAccessor.HttpContext.Features.Get<IRouteValuesFeature>();

        // è·å–è·¯ç”±ä¿¡æ¯
        var routeValues = routeValuesFeature.RouteValues;

        return routeValues;
    }
}
```

è¾“å‡ºï¼š

```json showLineNumbers
{
  "action": "print",
  "controller": "metadata"
}
```

- **è·å–å½“å‰ç»ˆç‚¹è·¯ç”±ä¿¡æ¯ï¼ˆç®€æ˜“ï¼‰**

```cs showLineNumbers {4,9,12,14-17,19-21}
public class MetadataService : IDynamicApiController
{
    private readonly IHttpContextAccessor _httpContextAccessor;
    public MetadataService(IHttpContextAccessor httpContextAccessor)
    {
        _httpContextAccessor = httpContextAccessor;
    }

    [Description("è¿™æ˜¯ä¸€æ®µæè¿°")]
    public void Print()
    {
        var endpointFeature = _httpContextAccessor.HttpContext.Features.Get<IEndpointFeature>();

        // è·å–è·¯ç”±ç»ˆç‚¹ä¿¡æ¯
        var routeEndpoint = endpointFeature.Endpoint as RouteEndpoint;
        var displayName = routeEndpoint.DisplayName;    // è·¯ç”±æ˜ å°„æ–¹æ³• FullName
        var routePattern = routeEndpoint.RoutePattern; // è·¯ç”±è¡¨è¾¾å¼ï¼ˆè·¯å¾„ï¼‰

        // è·å–è·¯ç”±å…ƒæ•°æ®ï¼ˆç‰¹æ€§ï¼‰
        var metadata = routeEndpoint.Metadata;
        var attribute = metadata.GetMetadata<DescriptionAttribute>();   // è·å– [Description] ç‰¹æ€§
    }
}
```

- **è·å–æ‰€æœ‰æ§åˆ¶å™¨åˆ—è¡¨**

```cs showLineNumbers {4,11-12,15}
public class MetadataService : IDynamicApiController
{
    private readonly ApplicationPartManager _applicationPartManager;
    public MetadataService(ApplicationPartManager applicationPartManager)
    {
        _applicationPartManager = applicationPartManager;
    }

    public void Print()
    {
        var controllerFeature = new ControllerFeature();
        _applicationPartManager.PopulateFeature(controllerFeature);

        // è·å–æ‰€æœ‰æ§åˆ¶å™¨åˆ—è¡¨
        IList<TypeInfo> controllers = controllerFeature.Controllers;
    }
}
```

- **è·å–æ‰€æœ‰ `Action` åˆ—è¡¨ï¼ˆå¼ºå¤§ï¼‰**

```cs showLineNumbers {4,12,16-25}
public class MetadataService : IDynamicApiController
{
    private readonly IActionDescriptorCollectionProvider _actionDescriptorCollectionProvider;
    public MetadataService(IActionDescriptorCollectionProvider actionDescriptorCollectionProvider)
    {
        _actionDescriptorCollectionProvider = actionDescriptorCollectionProvider;
    }

    public void Print()
    {
        // è·å–æ‰€æœ‰ Action åˆ—è¡¨
        var actionDescriptors = _actionDescriptorCollectionProvider.ActionDescriptors.Items;

        foreach (ActionDescriptor actionDescriptor in actionDescriptors)
        {
            // è·å–è¯·æ±‚çš„æ–¹æ³•
            var method = (actionDescriptor as ControllerActionDescriptor).MethodInfo;

            // è·å–è·¯ç”±åœ°å€
            var route = actionDescriptor.AttributeRouteInfo.Template;

            // è·å– HttpMethod
            var httpMethod = actionDescriptor.ActionConstraints?.OfType<HttpMethodActionConstraint>().FirstOrDefault()?.HttpMethods.First();

            // ä»»ä½•å…³äºè¿™ä¸ªè·¯ç”±/æ–¹æ³•/æ§åˆ¶å™¨/ç‰¹æ€§çš„ä¿¡æ¯éƒ½æœ‰
        }
    }
}
```

- **è·å–æ‰€æœ‰ `Action` åˆ—è¡¨å¸¦åˆ†ç»„ä¿¡æ¯ï¼ˆå¼ºå¤§ï¼‰**

```cs showLineNumbers {4,12,17,21-36}
public class MetadataService : IDynamicApiController
{
    private readonly IApiDescriptionGroupCollectionProvider _apiDescriptionGroupCollectionProvider;
    public MetadataService(IApiDescriptionGroupCollectionProvider apiDescriptionGroupCollectionProvider)
    {
        _apiDescriptionGroupCollectionProvider = apiDescriptionGroupCollectionProvider;
    }

    public void Print()
    {
        // è·å–æ‰€æœ‰æ§åˆ¶å™¨åˆ—è¡¨
        var apiDescriptionGroups = _apiDescriptionGroupCollectionProvider.ApiDescriptionGroups.Items;

        foreach (ApiDescriptionGroup group in apiDescriptionGroups)
        {
            // è·å–å½“å‰åˆ†ç»„çš„æ‰€æœ‰ Actions
            var actions = group.Items;

            foreach (ApiDescription action in actions)
            {
                // è·¯ç”±åœ°å€
                var route = action.RelativePath;

                // HttpMethod
                var httpMethod = action.HttpMethod;

                // åˆ†ç»„å
                var groupName = action.GroupName;

                // Action æè¿°å™¨
                var actionDescriptor = action.ActionDescriptor;

                // è·å–è¯·æ±‚çš„æ–¹æ³•
                var method = (actionDescriptor as ControllerActionDescriptor).MethodInfo;

                // ä»»ä½•å…³äºè¿™ä¸ªè·¯ç”±/æ–¹æ³•/æ§åˆ¶å™¨/ç‰¹æ€§çš„ä¿¡æ¯éƒ½æœ‰
            }
        }
    }
}
```

## 5.1.14 æ’ä»¶åŒ– `IDynamicApiRuntimeChangeProvider`

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.8.8 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

åœ¨ä¸€äº›ç‰¹å®šçš„éœ€æ±‚ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¿è¡Œæ—¶**åŠ¨æ€ç¼–è¯‘ä»£ç ï¼Œå¦‚åŠ¨æ€ç¼–å†™ `WebAPI`**ï¼Œä¹‹åèƒ½å¤Ÿåœ¨ä¸é‡å¯ä¸»æœºæœåŠ¡çš„æƒ…å†µä¸‹å³å¯æœ‰æ•ˆã€‚æ¯”å¦‚è¿™é‡ŒåŠ¨æ€æ·»åŠ  `SomeClass` åŠ¨æ€ `WebAPI`ï¼Œç„¶ååœ¨ `Swagger/è·¯ç”±ç³»ç»Ÿ` ä¸­ç«‹å³æœ‰æ•ˆï¼š

```cs showLineNumbers {10,21-30,36-39}
using Furion;
using Furion.DynamicApiController;
using Microsoft.AspNetCore.Mvc;

namespace YourProject.Application;

public class PluginApiServices : IDynamicApiController
{
    private readonly IDynamicApiRuntimeChangeProvider _provider;
    public PluginApiServices(IDynamicApiRuntimeChangeProvider provider)
    {
        _provider = provider;
    }

    /// <summary>
    /// åŠ¨æ€æ·»åŠ  WebAPI/Controller
    /// </summary>
    /// <param name="csharpCode"></param>
    /// <param name="assemblyName">å¯è‡ªè¡ŒæŒ‡å®šç¨‹åºé›†åç§°</param>
    /// <returns></returns>
    public string Compile([FromBody] string csharpCode, [FromQuery] string assemblyName = default)
    {
        // ç¼–è¯‘ C# ä»£ç å¹¶è¿”å›åŠ¨æ€ç¨‹åºé›†
        var dynamicAssembly = App.CompileCSharpClassCode(csharpCode, assemblyName);

        // å°†ç¨‹åºé›†æ·»åŠ è¿›åŠ¨æ€ WebAPI åº”ç”¨éƒ¨ä»¶
        _provider.AddAssembliesWithNotifyChanges(dynamicAssembly);

        // è¿”å›åŠ¨æ€ç¨‹åºé›†åç§°
        return dynamicAssembly.GetName().Name;
    }

    /// <summary>
    /// ç§»é™¤åŠ¨æ€ç¨‹åºé›† WebAPI/Controller
    /// </summary>
    public void Remove(string assemblyName)
    {
        _provider.RemoveAssembliesWithNotifyChanges(assemblyName);
    }
}
```

è¿™æ—¶åªéœ€è¦è¯·æ±‚ `api/plugin-api/compile` æ¥å£åŒæ—¶è®¾ç½®è¯·æ±‚ `Content-Type` ä¸º `text/plain`ï¼Œæ¥ä¸‹æ¥ä¼ å…¥ `C# ä»£ç å­—ç¬¦ä¸²` å³å¯ï¼Œå¦‚ï¼š

```cs showLineNumbers title="åŠ¨æ€C#ä»£ç å­—ç¬¦ä¸²"
using Furion.DynamicApiController;

namespace YourProject.Application;

public class SomeClass : IDynamicApiController
{
    public string GetName()
    {
        return nameof(Furion);
    }
}
```

<img src={useBaseUrl("img/dr1.png")} />

ä¹‹ååˆ·æ–°æµè§ˆå™¨å³å¯çœ‹åˆ°æœ€æ–°çš„ `API`ï¼š

<img src={useBaseUrl("img/dr2.png")} />

è¿˜å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€å¸è½½ï¼Œä½¿ç”¨ `DELETE` è¯·æ±‚ `api/plugin-api` å³å¯ã€‚

## 5.1.15 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::
