---
id: ipc
title: 33. IPC è¿›ç¨‹é€šä¿¡
sidebar_label: 33. IPC è¿›ç¨‹é€šä¿¡
---

## 33.1 ä»€ä¹ˆæ˜¯ `IPC`

> å¼•ç”¨ç™¾åº¦ç™¾ç§‘
>
> IPCï¼ˆInter-Process Communicationï¼Œè¿›ç¨‹é—´é€šä¿¡ï¼‰ã€‚è¿›ç¨‹é—´é€šä¿¡æ˜¯æŒ‡ä¸¤ä¸ªè¿›ç¨‹çš„æ•°æ®ä¹‹é—´äº§ç”Ÿäº¤äº’ã€‚

é€šä¿—ç‚¹è¯´ï¼Œ`IPC` å¯ä»¥å®ç°ä¸åŒåº”ç”¨ç¨‹åºé—´é€šä¿¡ï¼ˆäº¤äº’æ•°æ®ï¼‰ã€‚

## 33.2 å®ç° `IPC` é€šä¿¡æ–¹å¼

- åŠåŒå·¥ Unix ç®¡é“
- FIFOs(å‘½åç®¡é“)
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼ˆå¸¸ç”¨æ¨¡å¼ï¼‰
- ä¿¡å·é‡
- **å…±äº«å†…å­˜**ï¼ˆå¸¸ç”¨æ¨¡å¼ï¼Œ`Furion` æ¡†æ¶é»˜è®¤å®ç°æ–¹å¼ï¼‰
- **ç½‘ç»œ Socket**ï¼ˆå¸¸ç”¨æ¨¡å¼ï¼‰

## 33.3 `IPC` é€šä¿¡æ¨¡å¼

`IPC` æœ¬èº«æŒ‡çš„æ˜¯ `è¿›ç¨‹é—´` é€šä¿¡ï¼Œä½† `Furion` æ¡†æ¶å°†å†…ç½® `è¿›ç¨‹é—´/å†…` ä¸¤ç§è¿›ç¨‹é€šä¿¡æ¨¡å¼ã€‚

- `è¿›ç¨‹å†…é€šä¿¡`ï¼š`Furion` é‡‡ç”¨ `Channel` ç®¡é“æä¾›è¿›ç¨‹å†…é€šä¿¡
- `è¿›ç¨‹å¤–é€šä¿¡`ï¼š`Furion` é‡‡ç”¨ `MemoryMapperFile` å…±äº«å†…å­˜æ–¹å¼å®ç°è¿›ç¨‹å¤–é€šä¿¡ï¼ˆåç»­ç‰ˆæœ¬å®Œå–„ï¼‰

## 33.4 è¿›ç¨‹å†…é€šä¿¡ï¼ˆçº¿ç¨‹é—´ï¼‰

è¿›ç¨‹å†…é€šä¿¡ä¿—ç§°çº¿ç¨‹é—´é€šä¿¡ï¼Œ`Furion` æ¡†æ¶é‡‡ç”¨ `C#` æä¾›çš„ `Channelï¼ˆç®¡é“ï¼‰` + `Lazy` + `Task.Factory` å®ç°é•¿æ—¶é—´é«˜æ€§èƒ½çš„çº¿ç¨‹é—´é€šä¿¡æœºåˆ¶ã€‚`Channel` ç®¡é“ä¹Ÿæ˜¯ç›®å‰ `.NET/C#` å®ç° `ç”Ÿäº§è€…-è®¢é˜…è€…` æ¨¡å¼æœ€ç®€æ˜“ä¸”æœ€ä¸ºå¼ºå¤§çš„å®ç°ã€‚

### 33.4.1 äº†è§£ `Channel`

`Channel` æ˜¯åœ¨ `.NET Core 2.1+` ç‰ˆæœ¬ä¹‹ååŠ å…¥ã€‚`Channel` åº•å±‚å®ç°æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„ã€çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—ï¼Œå¯ä»¥åœ¨çº¿ç¨‹ä¹‹é—´ä¼ é€’æ•°æ®ã€‚

`Channel` çš„ä¸»è¦åº”ç”¨åœºæ™¯æ˜¯ `å‘å¸ƒ/è®¢é˜…ã€è§‚å¯Ÿè€…æ¨¡å¼` ä¸­ä½¿ç”¨ï¼Œå¦‚ï¼š`äº‹ä»¶æ€»çº¿` å°±æ˜¯æœ€å¥½çš„å®ç°æ–¹å¼ã€‚é€šè¿‡ `Channel` å®ç° `ç”Ÿäº§-æ¶ˆè´¹` æœºåˆ¶å¯ä»¥å‡å°‘é¡¹ç›®é—´çš„è€¦åˆï¼Œæé«˜åº”ç”¨ååé‡ã€‚

`Furion` æ¡†æ¶æä¾›äº† `ChannelContext<TMessage, THandler>` å¯†å°ç±»ï¼Œæä¾› `UnBoundedChannel` å’Œ `BoundedChannel` ä¸¤ç§ç®¡é“é€šä¿¡æ¨¡å¼ã€‚

- `UnBoundedChannel`ï¼šå…·æœ‰æ— é™å®¹é‡çš„ `Channel`, ç”Ÿäº§è€…å¯ä»¥å…¨é€Ÿè¿›è¡Œç”Ÿäº§æ•°æ®ï¼Œä½†å¦‚æœæ¶ˆè´¹è€…çš„æ¶ˆè´¹é€Ÿåº¦ä½äºç”Ÿäº§è€…ï¼Œ`Channel` çš„èµ„æºä½¿ç”¨ä¼šæ— é™å¢åŠ ï¼Œä¼šæœ‰æœåŠ¡å™¨èµ„æºè€—å°½çš„å¯èƒ½ã€‚
- `BoundedChannel`ï¼šå…·æœ‰æœ‰é™å®¹é‡çš„ `Channel`ï¼Œ`Furion` æ¡†æ¶é»˜è®¤ä¸º `1000`ï¼Œåˆ°è¾¾ä¸Šé™åï¼Œç”Ÿäº§è€…è¿›å…¥ç­‰å¾…å†™å…¥ç›´åˆ°æœ‰ç©ºé—²ï¼Œå¥½å¤„æ˜¯å¯ä»¥æ§åˆ¶ç”Ÿäº§çš„é€Ÿåº¦ï¼Œæ§åˆ¶ç³»ç»Ÿèµ„æºçš„ä½¿ç”¨ã€‚**ï¼ˆæ¨èï¼‰**

### 33.4.2 å¸¸è§„ä½¿ç”¨

#### åˆ›å»º `ChannelHandler<TMessage>` ç®¡é“å¤„ç†ç¨‹åº

```cs showLineNumbers  {1,10,17}
using Furion.IPCChannel;
using System;
using System.Threading.Tasks;

namespace Furion.Core
{
    /// <summary>
    /// åˆ›å»ºç®¡é“å¤„ç†ç¨‹åºï¼ˆå¤„ç† String ç±»å‹æ¶ˆæ¯ï¼‰
    /// </summary>
    public class MyChannelHandler : ChannelHandler<string>
    {
        /// <summary>
        /// æ¥å—åˆ°ç®¡é“æ¶ˆæ¯åå¤„ç†ç¨‹åº
        /// </summary>
        /// <param name="message"></param>
        /// <returns></returns>
        public override Task InvokeAsync(string message)
        {
            Console.WriteLine(message);

            return Task.CompletedTask;
        }
    }
}
```

:::note

` ChannelHandler<TMessage>` æ³›å‹ç±»å‹å†³å®šäº†ä½ è¦æ¥å—é‚£ç§ç±»å‹çš„æ¶ˆæ¯ï¼Œä¸åŒç±»å‹æ¶ˆæ¯å°†ä¼šè‡ªåŠ¨è¿‡æ»¤ç­›é€‰ã€‚

:::

#### ä½¿ç”¨ `ChannelContext<TMessage, THandler>` å‘é€æ¶ˆæ¯

```cs showLineNumbers  {5-6}
public async Task SendAsync()
{
    for (int i = 0; i < 100; i++)
    {
        // ä½¿ç”¨æœ‰é™å®¹é‡ç”Ÿäº§æ•°æ®
        await ChannelContext<string, MyChannelHandler>.BoundedChannel.Writer.WriteAsync($"Loop {i} times.");
    }
}
```

ä»¥ä¸Šä»£ç ä¹Ÿå¯ä»¥é€šè¿‡ `ChannelContext<string, MyChannelHandler>.BoundedChannel.Writer.TryWrite()` åŒæ­¥å†™å…¥ã€‚

### 33.4.3 å®ç°å¤šè®¢é˜…

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`Furion` åˆå§‹åŒ–äº†ä¸€ä¸ªé•¿æ—¶é—´çš„ `Task` ä»»åŠ¡è¿›è¡Œæ•°æ®æ£€æŸ¥åŠè®¢é˜…ï¼Œå¦‚éœ€å®ç°å¤šè®¢é˜…æ¨¡å¼ï¼Œå¯åˆ›å»ºæ–°çš„è®¢é˜…ä»»åŠ¡å³å¯ï¼š

```cs showLineNumbers 
var reader = ChannelContext<string, MyChannelHandler>.BoundedChannel.Reader;

// åˆ›å»ºé•¿æ—¶é—´çº¿ç¨‹ç®¡é“è¯»å–å™¨
_ = Task.Factory.StartNew(async () =>
  {
      while (await reader.WaitToReadAsync())
      {
          if (!reader.TryRead(out var message)) continue;
          // é»˜è®¤é‡è¯• 3 æ¬¡ï¼ˆæ¯æ¬¡é—´éš” 1sï¼‰
          await Retry.Invoke(async () => await Activator.CreateInstance<MyChannelHandler>().InvokeAsync(message), 3, 1000, finalThrow: false);
      }
  }, TaskCreationOptions.LongRunning);
```

### 33.4.4 æ›´å¤š `Channel` çŸ¥è¯†

å¯æŸ¥é˜… [Dotnet Core ä¸‹çš„ Channel, ä½ ç”¨äº†å—ï¼Ÿ](https://www.cnblogs.com/tiger-wang/p/14068973.html) åšå®¢æ•™ç¨‹ï¼ˆğŸ˜ƒ å†™çš„ä¸é”™ï¼‰

### 33.4.5 `CallContext` æ–¹å¼

åœ¨ `Furion v2.18+` ç‰ˆæœ¬æä¾›äº† `CallContext` é™æ€ç±»ï¼Œå†…éƒ¨ä½¿ç”¨ `AsyncLocal<T>` å®ç°ï¼Œä¹Ÿå¯ä»¥å®ç°çº¿ç¨‹é—´é€šä¿¡ï¼Œå¦‚ï¼š

```cs showLineNumbers 
CallContext.SetLocalValue("name", "Furion");
CallContext.GetLocalValue("name");

CallContext<int>.SetLocalValue("count", 1);
CallContext<int>.GetLocalValue("count");
```

## 34.5 è¿›ç¨‹å¤–é€šä¿¡ï¼ˆå…±äº«å†…å­˜ï¼‰

`Furion` ç›®å‰æš‚æœªæä¾›çš„è¿›ç¨‹å¤–é€šä¿¡åŠŸèƒ½ï¼Œå°†åœ¨åç»­ç‰ˆæœ¬å®ç°ï¼ˆä¸»è¦æ˜¯æ¨¡å—è®¾è®¡è¿˜æœªæƒ³å¥½ï¼ŒæŠ€æœ¯å·²å®ç°ï¼‰ã€‚

ä¸»è¦æ˜¯é€šè¿‡ `MemoryMapperFile` å®ç°å…±äº«å†…å­˜è¾¾åˆ°è¿›ç¨‹å¤–é€šä¿¡åŠŸèƒ½ï¼Œ[äº†è§£æ›´å¤š MemoryMapperFile](https://docs.microsoft.com/zh-cn/dotnet/api/system.io.memorymappedfiles.memorymappedfile?view=net-5.0)

## 33.6 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::
