---
id: dbcontext-sql
title: 9.16 Sql æ“ä½œ
sidebar_label: 9.16 Sql æ“ä½œ
---

import Tag from "@site/src/components/Tag.js";

<details>
  <summary>ğŸ“ æ¨¡å—æ›´æ–°æ—¥å¿—</summary>
  <div>
<div>

- **é—®é¢˜ä¿®å¤**

  - &nbsp;<Tag>ä¿®å¤</Tag> ä½¿ç”¨è¾¾æ¢¦æ•°æ®åº“æ‰§è¡Œ `sql` ä¸èƒ½è‡ªåŠ¨ä¿®å¤å‘½ä»¤å‚æ•°å‰ç¼€ <sup>4.8.7.18</sup> <sup>â±ï¸2023.03.21</sup> [#I6OK4T](https://gitee.com/dotnetchina/Furion/issues/I6OK4T)

</div>
  </div>
</details>

:::important æ¸©é¦¨æç¤º

æ¨èä½¿ç”¨ ã€Š[9.18 Sql é«˜çº§ä»£ç†](dbcontext-sql-proxy.mdx)ã€‹ä»£æ›¿æœ¬ç« èŠ‚åŠŸèƒ½ã€‚`Sql é«˜çº§ä»£ç†` èƒ½å¤Ÿæä¾›æ›´å®¹æ˜“ä¸”æ›´æ˜“ç»´æŠ¤çš„æ–¹å¼ã€‚

:::

:::note ä¾‹å­è¯´æ˜

æœ¬ç« èŠ‚ä¾‹å­å‡ä»¥ `SqlServer` æ•°æ®åº“å†™çš„ä¾‹å­ï¼Œå‘½ä»¤å‚æ•°ç»Ÿä¸€ç”¨ `@` ç¬¦å·ï¼Œä½†ä¸åŒæ•°æ®åº“çš„å‚æ•°å‰ç¼€æœ‰æ‰€ä¸åŒï¼Œå¦‚ï¼š`sql server` é‡‡ç”¨ `@`ï¼Œ`Oracle/DM` é‡‡ç”¨ `:`ï¼Œmy sql é‡‡ç”¨ `?`ã€‚

:::

## 9.16.1 å…³äº `Sql`

`Furion` æ¡†æ¶æä¾›éå¸¸å¤šä¸”çµæ´»çš„ `sql` æ“ä½œæ–¹æ³•ï¼Œä¸”æ€§èƒ½ä¸è¾“äº `dapper`ï¼ŒåŒæ—¶æ¥è¿‘ `ADO.NET` åŸç”Ÿæ“ä½œã€‚

## 9.16.2 æ‡’äººæ— æ•Œ `Sql` ğŸ®

### 9.16.2.1 è¿”å› `DataTable`

```cs showLineNumbers
// ==== åŒæ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var dataTable = "select * from person".SqlQuery();

// ç¤ºä¾‹äºŒ
var dataTable = "select top 10 * from person where id > @id".SqlQuery(new {id = 10});

// ç¤ºä¾‹ä¸‰
var dataTable = "select Id, Name, Age from person where name like @name".SqlQuery(new Dictionary<string,object>{ {"name", "%Furion%"} });

// ç¤ºä¾‹å››
var dataTable = "select * from person where name=@name limit 1,10".SqlQuery(new []{ new MySqlParameter("name","Furion") });

// ç¤ºä¾‹äº”
var dataTable = "select * from person where id>@id and name like @name".SqlQuery(new YourModel { Id = 1, Name = "%Furion%" });

// ç¤ºä¾‹å…­
var dataTable = "exec PROC_GetPerson @id".SqlQuery(new {id = 10});

// ç¤ºä¾‹ä¸ƒ
var dataTable = "select * from FN_GetPersons(@id)".SqlQuery(new {id = 10});

// ç¤ºä¾‹å…«
var dataTable = @"
select * from person p
left join personDetail pd on p.Id == pd.pid
where p.Id > @id;".SqlQuery(new {id = 10});

// ==== å¼‚æ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var dataTable = await "select * from person".SqlQueryAsync();

// ç¤ºä¾‹äºŒ
var dataTable = await "select top 10 * from person where id > @id".SqlQueryAsync(new {id = 10});

// ç¤ºä¾‹ä¸‰
var dataTable = await "select Id, Name, Age from person where name like @name".SqlQueryAsync(new Dictionary<string,object>{ {"name", "%Furion%"} });

// ç¤ºä¾‹å››
var dataTable = await "select * from person where name=@name limit 1,10".SqlQueryAsync(new []{ new MySqlParameter("name","Furion") });

// ç¤ºä¾‹äº”
var dataTable = await "select * from person where id>@id and name like @name".SqlQueryAsync(new YourModel { Id = 1, Name = "%Furion%" });

// ç¤ºä¾‹å…­
var dataTable = await "exec PROC_GetPerson @id".SqlQueryAsync(new {id = 10});

// ç¤ºä¾‹ä¸ƒ
var dataTable = await "select * from FN_GetPersons(@id)".SqlQueryAsync(new {id = 10});

// ç¤ºä¾‹å…«
var dataTable = await @"
select * from person p
left join personDetail pd on p.Id == pd.pid
where p.Id > @id;".SqlQueryAsync(new {id = 10});
```

### 9.16.2.2 è¿”å› `List<T>`

```cs showLineNumbers
// ==== åŒæ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var persons = "select * from person".SqlQuery<Person>();

// ç¤ºä¾‹äºŒ
var persons = "select top 10 * from person where id > @id".SqlQuery<Person>(new {id = 10});

// ç¤ºä¾‹ä¸‰
var persons = "select Id, Name, Age from person where name like @name".SqlQuery<Person>(new Dictionary<string,object>{ {"name", "%Furion%"} });

// ç¤ºä¾‹å››
var persons = "select * from person where name=@name limit 1,10".SqlQuery<Person>(new []{ new MySqlParameter("name","Furion") });

// ç¤ºä¾‹äº”
var persons = "select * from person where id>@id and name like @name".SqlQuery<Person>(new YourModel { Id = 1, Name = "%Furion%" });

// ç¤ºä¾‹å…­
var persons = "exec PROC_GetPerson @id".SqlQuery<Person>(new {id = 10});

// ç¤ºä¾‹ä¸ƒ
var persons = "select * from FN_GetPersons(@id)".SqlQuery<Person>(new {id = 10});

// ç¤ºä¾‹å…«
var persons = @"
select * from person p
left join personDetail pd on p.Id == pd.pid
where p.Id > @id;".SqlQuery<Person>(new {id = 10});

// ==== å¼‚æ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var persons = await "select * from person".SqlQueryAsync<Person>();

// ç¤ºä¾‹äºŒ
var persons = await "select top 10 * from person where id > @id".SqlQueryAsync<Person>(new {id = 10});

// ç¤ºä¾‹ä¸‰
var persons = await "select Id, Name, Age from person where name like @name".SqlQueryAsync<Person>(new Dictionary<string,object>{ {"name", "%Furion%"} });

// ç¤ºä¾‹å››
var persons = await "select * from person where name=@name limit 1,10".SqlQueryAsync<Person>(new []{ new MySqlParameter("name","Furion") });

// ç¤ºä¾‹äº”
var persons = await "select * from person where id>@id and name like @name".SqlQueryAsync<Person>(new YourModel { Id = 1, Name = "%Furion%" });

// ç¤ºä¾‹å…­
var persons = await "exec PROC_GetPerson @id".SqlQueryAsync<Person>(new {id = 10});

// ç¤ºä¾‹ä¸ƒ
var persons = await "select * from FN_GetPersons(@id)".SqlQueryAsync<Person>(new {id = 10});

// ç¤ºä¾‹å…«
var persons = await @"
select * from person p
left join personDetail pd on p.Id == pd.pid
where p.Id > @id;".SqlQueryAsync<Person>(new {id = 10});
```

### 9.16.2.3 è¿”å› `DataSet`

```cs showLineNumbers
// ==== åŒæ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var dataSet = @"
select * from person;
select * from student;".SqlQueries();

// ç¤ºä¾‹äºŒ
var dataSet = @"
select * from person where Id > @id;
select * from student where Name like @name;".SqlQueries(new {id = 1, name = "%furion%"});

// ç¤ºä¾‹ä¸‰
var dataSet = @"
select * from person;
exec PROC_GetStudents(@id);
select 'Furion';
select * from FN_GetPerson(@id);".SqlQueries(new {id = 1});

// ==== å¼‚æ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var dataSet = await @"
select * from person;
select * from student;".SqlQueriesAsync();

// ç¤ºä¾‹äºŒ
var dataSet = await @"
select * from person where Id > @id;
select * from student where Name like @name;".SqlQueriesAsync(new {id = 1, name = "%furion%"});

// ç¤ºä¾‹ä¸‰
var dataSet = await @"
select * from person;
exec PROC_GetStudents(@id);
select 'Furion';
select * from FN_GetPerson(@id);".SqlQueriesAsync(new {id = 1});
```

### 9.16.2.4 è¿”å› `Tuple<T1,...T8>`

```cs showLineNumbers
// ==== åŒæ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var (persons, students) = @"
select * from person;
select * from student;".SqlQueries<Person,Student>();

// ç¤ºä¾‹äºŒ
var (persons, students) = @"
select * from person where Id > @id;
select * from student where Name like @name;".SqlQueries<Person,Student>(new {id = 1, name = "%furion%"});

// ç¤ºä¾‹ä¸‰
var (persons, students, string, PersonDto) = @"
select * from person;
exec PROC_GetStudents(@id);
select 'Furion';
select * from FN_GetPerson(@id);".SqlQueries<Person, Student, string, PersonDto>(new {id = 1});

// ==== å¼‚æ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var (persons, students) = await @"
select * from person;
select * from student;".SqlQueriesAsync<Person,Student>();

// ç¤ºä¾‹äºŒ
var (persons, students) = await @"
select * from person where Id > @id;
select * from student where Name like @name;".SqlQueriesAsync<Person,Student>(new {id = 1, name = "%furion%"});

// ç¤ºä¾‹ä¸‰
var (persons, students, string, PersonDto) = await @"
select * from person;
exec PROC_GetStudents(@id);
select 'Furion';
select * from FN_GetPerson(@id);".SqlQueriesAsync<Person, Student, string, PersonDto>(new {id = 1});
```

### 9.16.2.5 è¿”å› å•è¡Œå•åˆ—

```cs showLineNumbers
// ==== åŒæ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var value = "select Name from person where id = @id".SqlScalar(new {id = 1});

// ç¤ºä¾‹äºŒ
var value = "select Name from person where id = @id".SqlScalar<string>(new {id = 1});

// ç¤ºä¾‹ä¸‰
var value = "select Age from person where id = @id".SqlScalar<int>(new {id = 1});

// ==== å¼‚æ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var value = await "select Name from person where id = @id".SqlScalarAsync(new {id = 1});

// ç¤ºä¾‹äºŒ
var value = await "select Name from person where id = @id".SqlScalarAsync<string>(new {id = 1});

// ç¤ºä¾‹ä¸‰
var value = await "select Age from person where id = @id".SqlScalarAsync<int>(new {id = 1});
```

### 9.16.2.6 è¿”å› å—å½±å“è¡Œæ•°

```cs showLineNumbers
// ==== åŒæ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var rowEffects = "insert into person(Name,Age,Address) values(@name,@age,@address)".SqlNonQuery(person);

// ç¤ºä¾‹äºŒ
var rowEffects = @"
insert into person(Name,Age,Address) values(@name,@age,@address);
insert into person(Name,Age,Address) values(@name,@age,@address);".SqlNonQuery(persons);

// ç¤ºä¾‹ä¸‰
var rowEffects = "update person set name=@name where id=@id".SqlNonQuery(new {id=1, name="ç™¾å°åƒ§"});

// ç¤ºä¾‹å››
var rowEffects = "delete from person where @id > 10".SqlNonQuery(new {id=1});

// ==== å¼‚æ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var rowEffects = await "insert into person(Name,Age,Address) values(@name,@age,@address)".SqlNonQueryAsync(person);

// ç¤ºä¾‹äºŒ
var rowEffects = @"
insert into person(Name,Age,Address) values(@name,@age,@address);
insert into person(Name,Age,Address) values(@name,@age,@address);".SqlNonQueryAsync(persons);

// ç¤ºä¾‹ä¸‰
var rowEffects = await "update person set name=@name where id=@id".SqlNonQueryAsync(new {id=1, name="ç™¾å°åƒ§"});

// ç¤ºä¾‹å››
var rowEffects = await "delete from person where @id > 10".SqlNonQueryAsync(new {id=1});
```

## 9.16.3 æ‡’äººæ— æ•Œ `å­˜å‚¨è¿‡ç¨‹` ğŸ®

### 9.16.3.1 è¿”å› `DataTable`

```cs showLineNumbers
// ==== åŒæ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var dataTable = "PROC_Name".SqlProcedureQuery();

// ç¤ºä¾‹äºŒ
var dataTable = "PROC_Name".SqlProcedureQuery(new {id = 1});

// ç¤ºä¾‹ä¸‰
var dataTable = "PROC_Name".SqlProcedureQuery(new {id = 1, age = 27});

// ==== å¼‚æ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var dataTable = await "PROC_Name".SqlProcedureQueryAsync();

// ç¤ºä¾‹äºŒ
var dataTable = await "PROC_Name".SqlProcedureQueryAsync(new {id = 1});

// ç¤ºä¾‹ä¸‰
var dataTable = await "PROC_Name".SqlProcedureQueryAsync(new {id = 1, age = 27});
```

### 9.16.3.2 è¿”å› `List<T>`

```cs showLineNumbers
// ==== åŒæ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var persons = "PROC_Name".SqlProcedureQuery<Person>();

// ç¤ºä¾‹äºŒ
var persons = "PROC_Name".SqlProcedureQuery<Person>(new {id = 1});

// ç¤ºä¾‹ä¸‰
var persons = "PROC_Name".SqlProcedureQuery<Person>(new {id = 1, age = 27});

// ==== å¼‚æ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var persons = await "PROC_Name".SqlProcedureQueryAsync<Person>();

// ç¤ºä¾‹äºŒ
var persons = await "PROC_Name".SqlProcedureQueryAsync<Person>(new {id = 1});

// ç¤ºä¾‹ä¸‰
var persons = await "PROC_Name".SqlProcedureQueryAsync<Person>(new {id = 1, age = 27});
```

### 9.16.3.3 è¿”å› `DataSet`

```cs showLineNumbers
// ==== åŒæ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var dataSet = "PROC_Name".SqlProcedureQueries();

// ç¤ºä¾‹äºŒ
var dataSet = "PROC_Name".SqlProcedureQueries(new {id = 1});

// ç¤ºä¾‹ä¸‰
var dataSet = "PROC_Name".SqlProcedureQueries(new {id = 1, age = 27});

// ==== å¼‚æ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var dataSet = await "PROC_Name".SqlProcedureQueriesAsync();

// ç¤ºä¾‹äºŒ
var dataSet = await "PROC_Name".SqlProcedureQueriesAsync(new {id = 1});

// ç¤ºä¾‹ä¸‰
var dataSet = await "PROC_Name".SqlProcedureQueriesAsync(new {id = 1, age = 27});
```

### 9.16.3.4 è¿”å› `Tuple<T1,...T8>`

```cs showLineNumbers
// ==== åŒæ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var persons = "PROC_Name".SqlProcedureQueries<Person>();

// ç¤ºä¾‹äºŒ
var (persons,students) = "PROC_Name".SqlProcedureQueries<Person,Student>(new {id = 1});

// ç¤ºä¾‹ä¸‰
var (persons,students,string) = "PROC_Name".SqlProcedureQueries<Person,Student,string>(new {id = 1, age = 27});

// ç¤ºä¾‹å››
var (persons,students,personDetail,string) = "PROC_Name".SqlProcedureQueries<Person,Student,PersonDetail,string>(new {id = 1, age = 27});

// ==== å¼‚æ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var persons = await "PROC_Name".SqlProcedureQueriesAsync<Person>();

// ç¤ºä¾‹äºŒ
var (persons,students) = await "PROC_Name".SqlProcedureQueriesAsync<Person,Student>(new {id = 1});

// ç¤ºä¾‹ä¸‰
var (persons,students,string) = await "PROC_Name".SqlProcedureQueriesAsync<Person,Student,string>(new {id = 1, age = 27});

// ç¤ºä¾‹å››
var (persons,students,personDetail,string) = await "PROC_Name".SqlProcedureQueriesAsync<Person,Student,PersonDetail,string>(new {id = 1, age = 27});
```

### 9.16.3.5 è¿”å› å•è¡Œå•åˆ—

```cs showLineNumbers
// ==== åŒæ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var value = "PROC_Name".SqlProcedureScalar(new {id = 1});

// ç¤ºä¾‹äºŒ
var value = "PROC_Name".SqlProcedureScalar<string>(new {id = 1, name = "æ–°ç”Ÿå¸", address ="å¹¿ä¸œçœä¸­å±±å¸‚"});

// ç¤ºä¾‹ä¸‰
var value = "PROC_Name".SqlProcedureScalar<int>(new {id = 1,  address ="å¹¿ä¸œçœä¸­å±±å¸‚"});

// ==== å¼‚æ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var value = await "PROC_Name".SqlProcedureScalarAsync(new {id = 1});

// ç¤ºä¾‹äºŒ
var value = await "PROC_Name".SqlProcedureScalarAsync<string>(new {id = 1, name = "æ–°ç”Ÿå¸", address ="å¹¿ä¸œçœä¸­å±±å¸‚"});

// ç¤ºä¾‹ä¸‰
var value = await "PROC_Name".SqlProcedureScalarAsync<int>(new {id = 1,  address ="å¹¿ä¸œçœä¸­å±±å¸‚"});
```

### 9.16.3.6 è¿”å› å—å½±å“è¡Œæ•°

```cs showLineNumbers
// ==== åŒæ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var rowEffects = "PROC_Name".SqlProcedureNonQuery(person);

// ç¤ºä¾‹äºŒ
var rowEffects = "PROC_Name".SqlProcedureNonQuery(new {id = 1, name = "æ–°ç”Ÿå¸", address ="å¹¿ä¸œçœä¸­å±±å¸‚"});

// ç¤ºä¾‹ä¸‰
var rowEffects = "PROC_Name".SqlProcedureNonQuery(new {id=1, name="ç™¾å°åƒ§"});

// ç¤ºä¾‹å››
var rowEffects = "PROC_Name".SqlProcedureNonQuery(new {id=1});

// ==== å¼‚æ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var rowEffects = await "PROC_Name".SqlProcedureNonQueryAsync(person);

// ç¤ºä¾‹äºŒ
var rowEffects = await "PROC_Name".SqlProcedureNonQueryAsync(new {id = 1, name = "æ–°ç”Ÿå¸", address ="å¹¿ä¸œçœä¸­å±±å¸‚"});

// ç¤ºä¾‹ä¸‰
var rowEffects = await "PROC_Name".SqlProcedureNonQueryAsync(new {id=1, name="ç™¾å°åƒ§"});

// ç¤ºä¾‹å››
var rowEffects = await "PROC_Name".SqlProcedureNonQueryAsync(new {id=1});
```

### 9.16.3.7 å¸¦ `OUTPUT/RETURN` è¿”å›

```sql showLineNumbers  {3,4,10-12,15-17,22}
CREATE PROC PROC_Output
    @Id INT,    // è¾“å…¥å‚æ•°
    @Name NVARCHAR(32) OUTPUT,  // è¾“å‡ºå‚æ•°ï¼Œè¿˜å¸¦é•¿åº¦
    @Age INT OUTPUT // è¾“å‡ºå‚æ•°
AS
BEGIN
    SET @Name = 'Furion Output';

    // è¾“å‡ºç»“æœé›†
    SELECT *
    FROM dbo.Test
    WHERE Id > @Id;

    // è¾“å‡ºç»“æœé›†
    SELECT TOP 10
           *
    FROM dbo.Test;

    SET @Age = 27;

    // å¸¦ RETURN è¿”å›
    RETURN 10;
END;
```

```cs showLineNumbers  {1,10,13,16}
using Furion.DatabaseAccessor;
using System.Data;

namespace Furion.Application
{
    public class ProcOutputModel
    {
        public int Id { get; set; } // è¾“å…¥å‚æ•°

        [DbParameter(ParameterDirection.Output, Size = 32)]
        public string Name { get; set; }    // è¾“å‡ºå‚æ•°

        [DbParameter(ParameterDirection.Output)]
        public int Age { get; set; }    // è¾“å‡ºå‚æ•°

        [DbParameter(ParameterDirection.ReturnValue)]
        public int ReturnValue { get; set; }    // è¿”å›å€¼
    }
}
```

```cs showLineNumbers
// ==== åŒæ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
ProcedureOutputResult result = "PROC_Name".SqlProcedureOutput(new ProcOutputModel{ Id=1});

// ç¤ºä¾‹äºŒ
ProcedureOutputResult result = "PROC_Name".SqlProcedureOutput(new ProcOutputModel{ Id=1});

// ç¤ºä¾‹ä¸‰
ProcedureOutputResult<(List<Person>, List<Student>)> result = "PROC_Name".SqlProcedureOutput<(List<Person>, List<Student>)>(new ProcOutputModel{ Id=1});

// ==== å¼‚æ­¥æ“ä½œ ====
// ç¤ºä¾‹ä¸€
ProcedureOutputResult result = await "PROC_Name".SqlProcedureOutputAsync(new ProcOutputModel{ Id=1});

// ç¤ºä¾‹äºŒ
ProcedureOutputResult result = await "PROC_Name".SqlProcedureOutputAsync(new ProcOutputModel{ Id=1});

// ç¤ºä¾‹ä¸‰
ProcedureOutputResult<(List<Person>, List<Student>)> result = await "PROC_Name".SqlProcedureOutputAsync<(List<Person>, List<Student>)>(new ProcOutputModel{ Id=1});
```

## 9.16.4 æ‡’äººæ— æ•Œ `å‡½æ•°` ğŸ®

### 9.16.4.1 `æ ‡é‡å‡½æ•°`

```cs showLineNumbers
// ==== åŒæ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var value = "FN_Name".SqlFunctionScalar();

// ç¤ºä¾‹äºŒ
var value = "FN_Name".SqlFunctionScalar(new {id = 1});

// ç¤ºä¾‹ä¸‰
var value = "FN_Name".SqlFunctionScalar<string>();

// ç¤ºä¾‹å››
var value = "FN_Name".SqlFunctionScalar<int>(new {id = 1});

// ==== å¼‚æ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var value = await "FN_Name".SqlFunctionScalarAsync();

// ç¤ºä¾‹äºŒ
var value = await "FN_Name".SqlFunctionScalarAsync(new {id = 1});

// ç¤ºä¾‹ä¸‰
var value = await "FN_Name".SqlFunctionScalarAsync<string>();

// ç¤ºä¾‹å››
var value = await "FN_Name".SqlFunctionScalarAsync<int>(new {id = 1});
```

### 9.16.4.2 `è¡¨å€¼å‡½æ•°`

```cs showLineNumbers
// ==== åŒæ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var dataTable = "FN_Name".SqlFunctionQuery();

// ç¤ºä¾‹äºŒ
var dataTable = "FN_Name".SqlFunctionQuery(new {id = 1});

// ç¤ºä¾‹ä¸‰
var persons = "FN_Name".SqlFunctionQuery<Person>();

// ç¤ºä¾‹å››
var persons = "FN_Name".SqlFunctionQuery<Person>(new {id = 1});

// ==== å¼‚æ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var dataTable = await "FN_Name".SqlFunctionQueryAsync();

// ç¤ºä¾‹äºŒ
var dataTable = await "FN_Name".SqlFunctionQueryAsync(new {id = 1});

// ç¤ºä¾‹ä¸‰
var persons = await "FN_Name".SqlFunctionQueryAsync<Person>();

// ç¤ºä¾‹å››
var persons = await "FN_Name".SqlFunctionQueryAsync<Person>(new {id = 1});
```

## 9.16.5 è®¾ç½®è¶…æ—¶æ—¶é—´

```cs showLineNumbers
var data = "select * from table".SetCommandTimeout(100).SqlQuery(); // å•ä½ç§’
```

## 9.16.6 `ISqlRepository` æ“ä½œ

`ISqlRepository` ä»“å‚¨æ˜¯ä¸“é—¨å¤„ç† `Sql` æ“ä½œçš„ï¼Œæ— éœ€å®ä½“æ–¹å¼ï¼Œæ‰€æœ‰æ¥å£å’Œ `æ‡’äººæ— æ•Œ` æ–¹å¼ä¸€æ ·ï¼š

```cs showLineNumbers
// ç¤ºä¾‹ä¸€
var dataTable = sqlRepository.SqlQuery("select * from person");

// ç¤ºä¾‹äºŒ
var dataTable = sqlRepository.SqlQuery("select * from person where id > @id", new { id = 10});

// ç¤ºä¾‹å››
var persons = sqlRepository.SqlQuery<Person>("select * from person");

// ç¤ºä¾‹äº”
var persons = sqlRepository.SqlQuery<Person>("select * from person where id > @id", new { id = 10});

// ä¸å†ä¸¾ä¾‹å­ã€‚ã€‚ã€‚
```

:::note è¡¥å……è¯´æ˜

ä¸ç®¡æ˜¯å“ªç§æ–¹å¼æ“ä½œ `Sql` ï¼Œæ–¹æ³•åå‚æ•°éƒ½æ˜¯ä¸€è‡´çš„ï¼Œå¦‚ï¼š

- `SqlQuery`
- `SqlQueryAsync`
- `SqlQueries`
- `SqlQueriesAsync`
- `SqlNonQuery`
- `SqlNonQueryAsync`
- `SqlScalar`
- `SqlScalarAsync`
- `SqlProcedureQuery`
- `SqlProcedureQueryAsync`
- `SqlProcedureQueries`
- `SqlProcedureQueriesAsync`
- `SqlProcedureScalar`
- `SqlProcedureScalarAsync`
- `SqlProcedureNonQuery`
- `SqlProcedureNonQueryAsync`
- `SqlProcedureOutput`
- `SqlProcedureOutputAsync`
- `SqlFunctionScalar`
- `SqlFunctionScalarAsync`
- `SqlFunctionQuery`
- `SqlFunctionQuery`

:::

## 9.16.7 `IRepository` æ“ä½œ

`IRepository` ä¹Ÿèƒ½æ“ä½œ `sql`ï¼Œè°ƒç”¨æ–¹æ³•ä¹Ÿæ˜¯å’Œä¸Šé¢ä¸€è‡´çš„ï¼Œå¦‚ï¼š

```cs showLineNumbers
var dataTable = repository.Sql().SqlQuery("select * from person");
```

:::note ç‰¹åˆ«è¯´æ˜

ç”±äºç¯‡å¹…æœ‰é™ï¼Œä¸å†åˆ—ä¸¾æ‰€æœ‰ä¾‹å­ã€‚

:::

## 9.16.8 `IRepository<TEntity>` æ“ä½œ

`IRepository<TEntity>` ä¹Ÿèƒ½æ“ä½œ `sql`ï¼Œè°ƒç”¨æ–¹æ³•ä¹Ÿæ˜¯å’Œä¸Šé¢ä¸€è‡´çš„ï¼Œå¦‚ï¼š

```cs showLineNumbers
var dataTable = personRepository.SqlQuery("select * from person");
```

:::note ç‰¹åˆ«è¯´æ˜

ç”±äºç¯‡å¹…æœ‰é™ï¼Œä¸å†åˆ—ä¸¾æ‰€æœ‰ä¾‹å­ã€‚

:::

## 9.16.9 å…³äº `Sql` å‚æ•°

æ‰€æœ‰ `sql`ã€`å­˜å‚¨è¿‡ç¨‹`ï¼Œ`å‡½æ•°` å‚æ•°éƒ½æ”¯æŒå››ç§æ–¹å¼ï¼š

- `DbParameter[]`ï¼šæ•°ç»„ç±»å‹
- `new {}`ï¼šåŒ¿åç±»å‹
- `new Class{}`ï¼šå¼ºç±»å‹ç±»å‹ï¼ˆæ”¯æŒå¤æ‚å­˜å‚¨è¿‡ç¨‹å‚æ•°ï¼‰
- `Dictionary<string,object>` ç±»å‹

:::tip å°çŸ¥è¯†

å»ºè®®é™¤äº†å¤æ‚çš„å­˜å‚¨è¿‡ç¨‹ï¼ˆå¸¦ `OUTPUT/RETURN`ï¼‰çš„ä»¥å¤–ï¼Œæ‰€æœ‰å‚æ•°å»ºè®®ä½¿ç”¨ `new {}` åŒ¿åç±»å‹ï¼Œå¦‚æœéœ€è¦åŠ¨æ€å‚æ•°ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ `Dictionary<string,object>` ç±»å‹ã€‚

:::

:::important å‚æ•°å¤§å°å†™é—®é¢˜

ç”±äºä¸åŒæ•°æ®åº“å¯¹æŸ¥è¯¢å‚æ•°å¤§å°å†™é—®é¢˜å¤„ç†ä¸ä¸€è‡´ï¼Œæ‰€ä»¥**å»ºè®®æ‰€æœ‰æŸ¥è¯¢å‚æ•°å’Œå‚æ•°åæˆ–å±æ€§åå®Œå…¨ä¸€è‡´**ã€‚

:::

## 9.16.10 å¤šæ•°æ®åº“ `Sql` æ“ä½œ ğŸ’¯ ğŸ’›

`Furion` æ¡†æ¶æ‹¥æœ‰éå¸¸çµæ´»çš„å¤šæ•°æ®åº“æ“ä½œæ–¹å¼ï¼Œåªéœ€é€šè¿‡å¤š**æ•°æ®åº“ä¸Šä¸‹æ–‡å®šä½å™¨**å³å¯åŠ¨æ€åˆ‡æ¢æ•°æ®åº“ã€‚

### 9.16.10.1 æ‡’äººæ— æ•Œ ğŸ® æ–¹å¼

```cs showLineNumbers
var dataTable = "select * from person".Change<MySqlDbContextLocator>().SqlQuery();

var persons = "select * from person whre id > @id".Change<SqliteDbContextLocator>().SqlQuery<Person>();
```

:::important è¡¥å……è¯´æ˜

æ‡’äººæ–¹å¼ åªéœ€è¦é€šè¿‡ `Change<TDbContextLocator>` æ–¹å¼å³å¯åŠ¨æ€åˆ‡æ¢æ•°æ®åº“ã€‚

:::

### 9.16.10.2 `ISqlRepository` æ–¹å¼

åªéœ€è¦é€šè¿‡ `ISqlRepository<TDbContextLocator>` æ³¨å…¥æˆ–é€šè¿‡ `sqlRepository.Change<TDbContextLocator>()` åˆ‡æ¢ã€‚

### 9.16.10.3 `IRepository` æ–¹å¼

åªéœ€è¦é€šè¿‡ `repository.Change<TDbContextLocator>()` è·å–å³å¯ã€‚

### 9.16.10.4 `IRepository<TEntity>` æ–¹å¼

åªéœ€è¦é€šè¿‡ `IRepository<TEntity, TDbContextLocator>` æ³¨å…¥æˆ–é€šè¿‡ `personRepository.Change<TEntity, TDbContextLocator>()` åˆ‡æ¢ã€‚

## 9.16.11 åˆ‡æ¢æ•°æ®åº“

åœ¨ `Furion` æ¡†æ¶ä¸­ï¼Œä¸ç®¡æ˜¯æ‡’äººæ¨¡å¼è¿˜æ˜¯ä»“å‚¨æ¨¡å¼éƒ½æ˜¯é€šè¿‡ `.Change<TDbContextLocator>` æ–¹å¼åˆ‡æ¢æ•°æ®åº“ï¼Œå¦‚ï¼š

```cs showLineNumbers
// æ‡’äººæ¨¡å¼
var data = "select * from table".Change<MySqlDbContextLocator>().SqlQuery<Data>();

// ä»“å‚¨æ–¹å¼
var data = req.Change<MySqlDbContextLocator>().SqlQuery<Data>("select * from table");
```

## 9.16.12 å¤šçº¿ç¨‹å…±äº«ä½œç”¨åŸŸ

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„ `å­—ç¬¦ä¸²` å’Œ `å®ä½“` æ‹“å±•éƒ½æœ‰è‡ªå·±ç‹¬ç«‹ç»´æŠ¤çš„ `ServiceProvider` ä½œç”¨åŸŸã€‚

åœ¨ `Web` è¯·æ±‚ä¸­ï¼Œé»˜è®¤æ˜¯ `HttpContext.RequestServices`ï¼Œä½†åœ¨ `é Web`ï¼Œå¦‚å¤šçº¿ç¨‹æ“ä½œï¼Œåå°ä»»åŠ¡ï¼Œäº‹ä»¶æ€»çº¿ç­‰åœºæ™¯ä¸‹ä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„ä½œç”¨åŸŸï¼Œå®é™…ä¸Šè¿™æ˜¯éå¸¸ä¸å¿…è¦çš„å†…å­˜å¼€é”€ã€‚

è¿™æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦é€šè¿‡ `.SetXXXScoped(service)` å…±äº«å½“å‰æœåŠ¡æä¾›å™¨ä½œç”¨åŸŸå³å¯ï¼Œå¦‚ï¼š

```cs showLineNumbers
Scoped.Create((fac, scope) => {
    "select * from table".SetContextScoped(scope.ServiceProvider).SqlQuery();
});
```

## 9.16.13 é™æ€ `Default` æ–¹å¼æ„å»º

```cs showLineNumbers
SqlExecutePart.Default.SetSqlString("select * from person").SqlQuery();
```

## 9.16.14 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::
