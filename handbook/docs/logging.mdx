---
id: logging
title: 18. æ—¥å¿—è®°å½•
sidebar_label: 18. æ—¥å¿—è®°å½•
---

import Tag from "@site/src/components/Tag.js";

<details>
  <summary>ğŸ“ æ¨¡å—æ›´æ–°æ—¥å¿—</summary>
  <div>
<div>

- **æ–°ç‰¹æ€§**

  - &nbsp;<Tag>æ–°å¢</Tag> æ§åˆ¶å°æ—¥å¿— `AddConsoleFormatter` æœåŠ¡æ”¯æŒ `WriteFilter` å±æ€§è¿‡æ»¤ <sup>4.8.8.52</sup> <sup>â±ï¸2023.11.07</sup> [516acb4](https://gitee.com/dotnetchina/Furion/commit/516acb455e9eae477cfce1052442fc30c9c4dfb9)
  - &nbsp;<Tag>æ–°å¢</Tag> ç›‘å¬æ—¥å¿— `LoggingMonitor` æ”¯æŒæ‰“å°è¾“å‡º `requestHeaders` è¯·æ±‚å¤´ä¿¡æ¯ <sup>4.8.8.50</sup> <sup>â±ï¸2023.10.27</sup> [#I8BHM3](https://gitee.com/dotnetchina/Furion/issues/I8BHM3)
  - &nbsp;<Tag>æ–°å¢</Tag> ç›‘å¬æ—¥å¿— `LoggingMonitor` æ”¯æŒé…ç½®æ—¥å¿—è¾“å‡ºçº§åˆ« <sup>4.8.8.41</sup> <sup>â±ï¸2023.08.25</sup> [#I7SRTP](https://gitee.com/dotnetchina/Furion/issues/I7SRTP)
  - &nbsp;<Tag>æ–°å¢</Tag> **ç›‘å¬æ—¥å¿— `LoggingMonitor` æ”¯æŒ `Razor Pages`** <sup>4.8.8.16</sup> <sup>â±ï¸2023.05.15</sup> [#I7332C](https://gitee.com/dotnetchina/Furion/issues/I7332C)
  - &nbsp;<Tag>æ–°å¢</Tag> **æ—¥å¿—é…ç½® `WithStackFrame`ï¼Œå¯æ§åˆ¶æ˜¯å¦è¾“å‡ºäº§ç”Ÿæ—¥å¿—çš„ç¨‹åºé›†ï¼Œç±»å‹å’Œå…·ä½“æ–¹æ³•** <sup>4.8.7.16</sup> <sup>â±ï¸2023.03.19</sup> [5ad6ae2](https://gitee.com/dotnetchina/Furion/commit/5ad6ae241d1798ad788e42569a15d68686db4fa1)

<details style={{ marginLeft: 50 }}>
  <summary>æŸ¥çœ‹å˜åŒ–</summary>
  <div>

å¯ç”¨ `WithStackFrame` æ—¥å¿—é…ç½®åï¼Œå¯è¾“å‡ºç¨‹åºé›†ï¼Œç±»å‹ï¼Œæ–¹æ³•ç­¾åä¿¡æ¯ã€‚

```cs showLineNumbers {4,10,16}
// æ§åˆ¶å°æ—¥å¿—
services.AddConsoleFormatter(options =>
{
    options.WithStackFrame = true;
});

// æ–‡ä»¶æ—¥å¿—
services.AddFileLogging(options =>
{
    options.WithStackFrame = true;
});

// æ•°æ®åº“æ—¥å¿—
services.AddDatabaseLogging(options =>
{
    options.WithStackFrame = true;
});
```

æ—¥å¿—è¾“å‡ºå¦‚ä¸‹ï¼š

```bash showLineNumbers {2,5,8,11,14,17,20}
info: 2023-03-17 18:25:06.7988349 +08:00 æ˜ŸæœŸäº” L System.Logging.EventBusService[0] #1
      [Furion.dll] async Task Furion.EventBus.EventBusHostedService.ExecuteAsync(CancellationToken stoppingToken)
      EventBus hosted service is running.
info: 2023-03-17 18:25:08.1393952 +08:00 æ˜ŸæœŸäº” L Microsoft.Hosting.Lifetime[14] #1
      [System.Private.CoreLib.dll] void System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start<TStateMachine>(ref TStateMachine stateMachine)
      Now listening on: https://localhost:5001
info: 2023-03-17 18:25:08.1620391 +08:00 æ˜ŸæœŸäº” L Microsoft.Hosting.Lifetime[14] #1
      [System.Private.CoreLib.dll] void System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start<TStateMachine>(ref TStateMachine stateMachine)
      Now listening on: http://localhost:5000
info: 2023-03-17 18:25:08.1972456 +08:00 æ˜ŸæœŸäº” L Microsoft.Hosting.Lifetime[0] #1
      [Microsoft.Extensions.Hosting.dll] void Microsoft.Extensions.Hosting.Internal.ConsoleLifetime.OnApplicationStarted()
      Application started. Press Ctrl+C to shut down.
info: 2023-03-17 18:25:08.2456579 +08:00 æ˜ŸæœŸäº” L Microsoft.Hosting.Lifetime[0] #1
      [Microsoft.Extensions.Hosting.dll] void Microsoft.Extensions.Hosting.Internal.ConsoleLifetime.OnApplicationStarted()
      Hosting environment: Development
info: 2023-03-17 18:25:08.2746134 +08:00 æ˜ŸæœŸäº” L Microsoft.Hosting.Lifetime[0] #1
      [System.Private.CoreLib.dll] void System.Threading.CancellationTokenSource.ExecuteCallbackHandlers(bool throwOnFirstException)
      Content root path: D:\Workplaces\OpenSources\Furion\samples\Furion.Web.Entry
info: 2023-03-17 18:25:18.1917784 +08:00 æ˜ŸæœŸäº” L Furion.Application.TestLoggerServices[0] #16
      [Furion.Application.dll] void Furion.Application.TestLoggerServices.æµ‹è¯•æ—¥å¿—()
      æˆ‘æ˜¯ä¸€ä¸ªæ—¥å¿— 20
```

è¿™æ ·å°±æ¸…æ¥šåœ°çŸ¥é“æ—¥å¿—æ˜¯å“ªä¸ªç¨‹åºé›†ã€å“ªä¸ªç±»å‹ã€å“ªä¸ªæ–¹æ³•è¾“å‡ºçš„äº†ã€‚

  </div>
</details>

- - &nbsp;<Tag>æ–°å¢</Tag> å®¡è®¡æ—¥å¿— `LoggingMonitor` æ”¯æŒå¯¹å‚æ•°è´´ `[SuppressMonitor]` ç‰¹æ€§è·³è¿‡è®°å½• <sup>4.8.7.3</sup> <sup>â±ï¸2023.03.01</sup> [#I6IVGW](https://gitee.com/dotnetchina/Furion/issues/I6IVGW)
- - &nbsp;<Tag>æ–°å¢</Tag> å®¡è®¡æ—¥å¿— `LoggingMonitor` ç›‘å¬ `TraceId`ã€`ThreadId`ã€`Accept-Language` <sup>4.8.7.1</sup> <sup>â±ï¸2023.02.27</sup> [df35201](https://gitee.com/dotnetchina/Furion/commit/df35201622f4d908ab423baff27caef856a23527)
- - &nbsp;<Tag>æ–°å¢</Tag> å®¡è®¡æ—¥å¿— `LoggingMonitor` æ”¯æŒé…ç½®åºåˆ—åŒ–å±æ€§å‘½åè§„åˆ™ <sup>4.8.6.12</sup> <sup>â±ï¸2023.02.21</sup> [#I6GPUP](https://gitee.com/dotnetchina/Furion/issues/I6GPUP)
- - &nbsp;<Tag>æ–°å¢</Tag> å®¡è®¡æ—¥å¿— `LoggingMonitor` æ”¯æŒ `[DisplayName]` ç‰¹æ€§è§£æå’Œ `Title` å±æ€§è®°å½• <sup>4.8.5.10</sup> <sup>â±ï¸2023.02.07</sup> [#I6DHMF](https://gitee.com/dotnetchina/Furion/issues/I6DHMF)
- - &nbsp;<Tag>æ–°å¢</Tag> å®¡è®¡æ—¥å¿— `LoggingMonitor` è®°å½• `HTTP` å“åº”çŠ¶æ€ç  <sup>4.8.5.2</sup> <sup>â±ï¸2023.01.30</sup> [abb4cbd](https://gitee.com/dotnetchina/Furion/commit/abb4cbdab9f45f53cad8468352d1c14ac8c54b42)

- **çªç ´æ€§å˜åŒ–**

  - &nbsp;<Tag>è°ƒæ•´</Tag> **ç›‘å¬æ—¥å¿— `WriteFilter` å’Œ `ConfigureLogger` çš„ `ActionExecutingContext` å’Œ `ActionExecutedContext` ç±»å‹ä¸º `FilterContext`** <sup>4.8.8.16</sup> <sup>â±ï¸2023.05.15</sup> [#I7332C](https://gitee.com/dotnetchina/Furion/issues/I7332C)

- **é—®é¢˜ä¿®å¤**

  - &nbsp;<Tag>ä¿®å¤</Tag> å®¡è®¡æ—¥å¿—ä¸æ”¯æŒ `dynamic/JsonElement` åºåˆ—åŒ–é—®é¢˜ <sup>4.8.8.45</sup> <sup>â±ï¸2023.09.29</sup> [#I84SD5](https://gitee.com/dotnetchina/Furion/issues/I84SD5)
  - &nbsp;<Tag>ä¿®å¤</Tag> å®¡è®¡æ—¥å¿—è§£æ `DateTime` ç±»å‹å‚æ•°ä¸æ˜¯æœ¬åœ°æ—¶é—´é—®é¢˜ <sup>4.8.8.33</sup> <sup>â±ï¸2023.06.29</sup> [#I7GW32](https://gitee.com/dotnetchina/Furion/issues/I7GW32)
  - &nbsp;<Tag>ä¿®å¤</Tag> `LoggingMonitor` æ‰“å°æ³›å‹ç±»å‹å¦‚æœå­˜åœ¨å¤šä¸ªæ³›å‹å‚æ•°é—®é¢˜ <sup>4.8.8.8</sup> <sup>â±ï¸2023.05.04</sup> [8d9cb74](https://gitee.com/dotnetchina/Furion/commit/8d9cb7457c736a91bc428ce61da553df40107960)
  - &nbsp;<Tag>ä¿®å¤</Tag> æ—¥å¿—è¾“å‡º `JSON` æ ¼å¼æ¼æ‰äº† `UseUtcTimestamp` å’Œ `TraceId` é”®å€¼ <sup>4.8.7.21</sup> <sup>â±ï¸2023.03.27</sup> [5c90e65](https://gitee.com/dotnetchina/Furion/commit/5c90e652b20dc36450ea0322fe6d22cd2a39d5e6)
  - &nbsp;<Tag>ä¿®å¤</Tag> æ—¥å¿—æ¶ˆæ¯æ²¡æœ‰å¤„ç† `\n` æ¢è¡Œç¬¦å¯¹é½é—®é¢˜ <sup>4.8.7.6</sup> <sup>â±ï¸2023.03.10</sup> [759bcc5](https://gitee.com/dotnetchina/Furion/commit/759bcc5dca09017f37a5be6ad2beefad33214fae)
  - &nbsp;<Tag>ä¿®å¤</Tag> å®¡è®¡æ—¥å¿— `LoggingMonitor` å¯¹ç‰¹å®šå‚æ•°è´´æœ‰ `[FromServices]` ç‰¹æ€§ä¾æ—§è®°å½•é—®é¢˜ <sup>4.8.7.3</sup> <sup>â±ï¸2023.03.01</sup> [17b134e](https://gitee.com/dotnetchina/Furion/commit/17b134efd82baa31bff6a0e763f93839c767c364)
  - &nbsp;<Tag>ä¿®å¤</Tag> åœ¨æ•°æ®åº“æ—¥å¿—çš„ `IDatabaseLoggingWriter` å®ç°ç±»ä¸­ä¾èµ–æ³¨å…¥ `ILogger<>` å¯¼è‡´æ­»å¾ªç¯ <sup>4.8.5.4</sup> <sup>â±ï¸2023.02.01</sup> [#I6C6QU](https://gitee.com/dotnetchina/Furion/issues/I6C6QU)
  - &nbsp;<Tag>ä¿®å¤</Tag> æ•°æ®åº“æ—¥å¿—æä¾›ç¨‹åºåœ¨åº”ç”¨ç¨‹åºç»ˆæ­¢æ—¶å‡ºç°ç©ºå¼‚å¸¸é—®é¢˜ <sup>4.8.5</sup> <sup>â±ï¸2023.01.28</sup> [#I6AZ8Y](https://gitee.com/dotnetchina/Furion/issues/I6AZ8Y)
  - &nbsp;<Tag>ä¿®å¤</Tag> æ•°æ®åº“æ—¥å¿—æ³¨å†Œåœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ä¸¢å¤±æ—¥å¿—ä¸Šä¸‹æ–‡é—®é¢˜ <sup>4.8.4.6</sup> <sup>â±ï¸2023.01.04</sup> [#I68PDF](https://gitee.com/dotnetchina/Furion/issues/I68PDF)
  - &nbsp;<Tag>ä¿®å¤</Tag> åœ¨ç±»ä¸­è´´ `[SuppressMonitor]` ç‰¹æ€§ä½† `LoggingMonitor` ä¾ç„¶è¾“å‡ºé—®é¢˜ <sup>4.8.4</sup> <sup>â±ï¸2022.12.30</sup> [#I6882I](https://gitee.com/dotnetchina/Furion/issues/I6882I)
  - &nbsp;<Tag>ä¿®å¤</Tag> `LoggingMonitor` åºåˆ—åŒ– `IQueryable<>` æˆ– `OData` è¿”å›å€¼ç±»å‹å‡ºç°æ­»å¾ªç¯é—®é¢˜ <sup>4.8.3.4</sup> <sup>â±ï¸2022.12.10</sup> [7e8c9d0](https://gitee.com/dotnetchina/Furion/commit/7e8c9d0e3910c4d0cfa18a7a15cbe8415d34dd66)
  - &nbsp;<Tag>ä¿®å¤</Tag> **é€šè¿‡ `Ctrl + C` ç»ˆæ­¢åº”ç”¨ç¨‹åºåè·å– `TraceId` å‡ºç°å¯¹è±¡å·²é‡Šæ”¾å¼‚å¸¸** <sup>4.8.1.12</sup> <sup>â±ï¸2022.12.07</sup> [55c3e49](https://gitee.com/dotnetchina/Furion/commit/55c3e4942b1f89e0548d4cf90453937ba4ea512c)
  - &nbsp;<Tag>ä¿®å¤</Tag> æ—¥å¿—æ¨¡å—å›  `v4.8.0+` ç‰ˆæœ¬å¯¼è‡´å†™å…¥æ•°æ®åº“æ—¥å¿—ç©ºå¼‚å¸¸é—®é¢˜ <sup>4.8.2.1</sup> <sup>â±ï¸2022.11.28</sup> [8d9d72b](https://gitee.com/dotnetchina/Furion/commit/8d9d72b5bfcb8dfc730462c9313266ec0661d561)

- **å…¶ä»–æ›´æ”¹**

  - &nbsp;<Tag>è°ƒæ•´</Tag> å®¡è®¡æ—¥å¿—æ—¥å¿— `LoggingMonitor` è¿”å›å€¼æ³›å‹å­—ç¬¦ä¸²æ˜¾ç¤ºæ ¼å¼ <sup>4.8.7.1</sup> <sup>â±ï¸2023.02.27</sup> [df35201](https://gitee.com/dotnetchina/Furion/commit/df35201622f4d908ab423baff27caef856a23527)
  - &nbsp;<Tag>è°ƒæ•´</Tag> `LoggingMonitor` è§£ææˆæƒé€»è¾‘ï¼Œå¦‚æœæ¥å£æœªæˆæƒåˆ™ä¸æ‰“å°æˆæƒä¿¡æ¯ <sup>4.8.2.1</sup> <sup>â±ï¸2022.11.28</sup> [#I63D2E](https://gitee.com/dotnetchina/Furion/issues/I63D2E)

</div>
  </div>
</details>

import useBaseUrl from "@docusaurus/useBaseUrl";

## 18.1 å…³äºæ—¥å¿—

é€šå¸¸æ—¥å¿—æŒ‡çš„æ˜¯**ç³»ç»Ÿæ—¥å¿—**å’Œ**ç¨‹åºæ—¥å¿—**ã€‚

**ç³»ç»Ÿæ—¥å¿—** æ˜¯è®°å½•ç³»ç»Ÿä¸­ç¡¬ä»¶ã€è½¯ä»¶å’Œç³»ç»Ÿé—®é¢˜çš„ä¿¡æ¯ï¼ŒåŒæ—¶è¿˜å¯ä»¥ç›‘è§†ç³»ç»Ÿä¸­å‘ç”Ÿçš„äº‹ä»¶ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡å®ƒæ¥æ£€æŸ¥é”™è¯¯å‘ç”Ÿçš„åŸå› ï¼Œæˆ–è€…å¯»æ‰¾å—åˆ°æ”»å‡»æ—¶æ”»å‡»è€…ç•™ä¸‹çš„ç—•è¿¹ã€‚ç³»ç»Ÿæ—¥å¿—åŒ…æ‹¬ç³»ç»Ÿæ—¥å¿—ã€åº”ç”¨ç¨‹åºæ—¥å¿—å’Œå®‰å…¨æ—¥å¿—ã€‚

**ç¨‹åºæ—¥å¿—** æ˜¯ç¨‹åºè¿è¡Œä¸­äº§ç”Ÿçš„æ—¥å¿—ï¼Œé€šå¸¸ç”±æ¡†æ¶è¿è¡Œæ—¶æˆ–å¼€å‘è€…æä¾›çš„æ—¥å¿—ã€‚åŒ…æ‹¬è¯·æ±‚æ—¥å¿—ï¼Œå¼‚å¸¸æ—¥å¿—ã€å®¡è®¡æ—¥å¿—ã€è¡Œä¸ºæ—¥å¿—ç­‰ã€‚

## 18.2 æ—¥å¿—ä½œç”¨

åœ¨é¡¹ç›®å¼€å‘ä¸­ï¼Œéƒ½ä¸å¯é¿å…çš„ä½¿ç”¨åˆ°æ—¥å¿—ã€‚æ²¡æœ‰æ—¥å¿—è™½ç„¶ä¸ä¼šå½±å“é¡¹ç›®çš„æ­£ç¡®è¿è¡Œï¼Œä½†æ˜¯æ²¡æœ‰æ—¥å¿—çš„é¡¹ç›®å¯ä»¥è¯´æ˜¯ä¸å®Œæ•´çš„ã€‚æ—¥å¿—åœ¨è°ƒè¯•ï¼Œé”™è¯¯æˆ–è€…å¼‚å¸¸å®šä½ï¼Œæ•°æ®åˆ†æä¸­çš„ä½œç”¨æ˜¯ä¸è¨€è€Œå–»çš„ã€‚

- è°ƒè¯•

åœ¨é¡¹ç›®è°ƒè¯•æ—¶ï¼ŒæŸ¥çœ‹æ ˆä¿¡æ¯å¯ä»¥æ–¹ä¾¿åœ°çŸ¥é“å½“å‰ç¨‹åºçš„è¿è¡ŒçŠ¶æ€ï¼Œè¾“å‡ºçš„æ—¥å¿—ä¾¿äºè®°å½•ç¨‹åºåœ¨ä¹‹å‰çš„è¿è¡Œç»“æœã€‚

- é”™è¯¯å®šä½

ä¸è¦ä»¥ä¸ºé¡¹ç›®èƒ½æ­£ç¡®è·‘èµ·æ¥å°±å¯ä»¥é«˜æ•æ— å¿§ï¼Œé¡¹ç›®åœ¨è¿è¡Œä¸€æ®µæ—¶å€™åï¼Œå¯èƒ½ç”±äºæ•°æ®é—®é¢˜ï¼Œç½‘ç»œé—®é¢˜ï¼Œå†…å­˜é—®é¢˜ç­‰å‡ºç°å¼‚å¸¸ã€‚è¿™æ—¶æ—¥å¿—å¯ä»¥å¸®åŠ©å¼€å‘æˆ–è€…è¿ç»´äººå‘˜å¿«é€Ÿå®šä½é”™è¯¯ä½ç½®ï¼Œæå‡ºè§£å†³æ–¹æ¡ˆã€‚

- æ•°æ®åˆ†æ

å¤§æ•°æ®çš„å…´èµ·ï¼Œä½¿å¾—å¤§é‡çš„æ—¥å¿—åˆ†ææˆä¸ºå¯èƒ½ï¼ŒELK ä¹Ÿè®©æ—¥å¿—åˆ†æé—¨æ§›é™ä½äº†å¾ˆå¤šã€‚æ—¥å¿—ä¸­è•´å«äº†å¤§é‡çš„ç”¨æˆ·æ•°æ®ï¼ŒåŒ…æ‹¬ç‚¹å‡»è¡Œä¸ºï¼Œå…´è¶£åå¥½ç­‰ï¼Œç”¨æˆ·ç”»åƒå¯¹äºå…¬å¸ä¸‹ä¸€æ­¥çš„æˆ˜ç•¥æ–¹å‘æœ‰ä¸€å®šæŒ‡å¼•ä½œç”¨ã€‚

## 18.3 æ—¥å¿—çº§åˆ«

æ—¥å¿—çº§åˆ«å¯ä»¥æœ‰æ•ˆçš„å¯¹æ—¥å¿—ä¿¡æ¯è¿›è¡Œå½’ç±»ï¼Œæ–¹ä¾¿å‡†ç¡®çš„æŸ¥çœ‹ç‰¹å®šæ—¥å¿—å†…å®¹ã€‚é€šå¸¸æ—¥å¿—ç±»åˆ«æœ‰ä»¥ä¸‹çº§åˆ«ï¼š

|        çº§åˆ«         | å€¼  |      æ–¹æ³•      | æè¿°                                                                                                       |
| :-----------------: | --- | :------------: | ---------------------------------------------------------------------------------------------------------- |
|    Traceï¼ˆè·Ÿè¸ªï¼‰    | 0   |    LogTrace    | åŒ…å«æœ€è¯¦ç»†çš„æ¶ˆæ¯ã€‚ è¿™äº›æ¶ˆæ¯å¯èƒ½åŒ…å«æ•æ„Ÿçš„åº”ç”¨æ•°æ®ã€‚ è¿™äº›æ¶ˆæ¯é»˜è®¤æƒ…å†µä¸‹å¤„äºç¦ç”¨çŠ¶æ€ï¼Œå¹¶ä¸”ä¸åº”åœ¨ç”Ÿäº§ä¸­å¯ç”¨ã€‚ |
|    Debugï¼ˆè°ƒè¯•ï¼‰    | 1   |    LogDebug    | ç”¨äºè°ƒè¯•å’Œå¼€å‘ã€‚ ç”±äºé‡å¤§ï¼Œè¯·åœ¨ç”Ÿäº§ä¸­å°å¿ƒä½¿ç”¨ã€‚                                                            |
| Informationï¼ˆä¿¡æ¯ï¼‰ | 2   | LogInformation | è·Ÿè¸ªåº”ç”¨çš„å¸¸è§„æµã€‚ å¯èƒ½å…·æœ‰é•¿æœŸå€¼ã€‚                                                                        |
|   Warningï¼ˆè­¦å‘Šï¼‰   | 3   |   LogWarning   | å¯¹äºå¼‚å¸¸äº‹ä»¶æˆ–æ„å¤–äº‹ä»¶ã€‚ é€šå¸¸åŒ…æ‹¬ä¸ä¼šå¯¼è‡´åº”ç”¨å¤±è´¥çš„é”™è¯¯æˆ–æƒ…å†µã€‚                                            |
|    Errorï¼ˆé”™è¯¯ï¼‰    | 4   |    LogError    | è¡¨ç¤ºæ— æ³•å¤„ç†çš„é”™è¯¯å’Œå¼‚å¸¸ã€‚ è¿™äº›æ¶ˆæ¯è¡¨ç¤ºå½“å‰æ“ä½œæˆ–è¯·æ±‚å¤±è´¥ï¼Œè€Œä¸æ˜¯æ•´ä¸ªåº”ç”¨å¤±è´¥ã€‚                            |
|  Criticalï¼ˆä¸¥é‡ï¼‰   | 5   |  LogCritical   | éœ€è¦ç«‹å³å…³æ³¨çš„å¤±è´¥ã€‚ ä¾‹å¦‚æ•°æ®ä¸¢å¤±ã€ç£ç›˜ç©ºé—´ä¸è¶³ã€‚                                                          |

## 18.4 å¦‚ä½•ä½¿ç”¨

åœ¨ `.NET 5` æ¡†æ¶ä¸­ï¼Œå¾®è½¯å·²ç»ä¸ºæˆ‘ä»¬å†…ç½®äº† `æ—¥å¿—ç»„ä»¶`ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œæ— éœ€æˆ‘ä»¬å¼•ç”¨ç¬¬ä¸‰æ–¹åŒ…è¿›è¡Œæ—¥å¿—è®°å½•ã€‚`.NET 5` æ¡†æ¶ä¸ºæˆ‘ä»¬æä¾›äº†ä¸¤ç§æ—¥å¿—å¯¹è±¡åˆ›å»ºæ–¹å¼ã€‚

### 18.4.1 `ILogger<T>` æ³›å‹æ–¹å¼

ä½¿ç”¨éå¸¸ç®€å•ï¼Œå¯ä»¥é€šè¿‡ `ILogger<T>` å¯¹è±¡è¿›è¡Œæ³¨å…¥ï¼Œå¦‚ï¼š

```cs showLineNumbers  {5}
public class PrivacyModel : PageModel
{
    private readonly ILogger<PrivacyModel> _logger;

    public PrivacyModel(ILogger<PrivacyModel> logger)
    {
        _logger = logger;
    }

    public void OnGet()
    {
        _logger.LogInformation("GET Pages.PrivacyModel called.");
    }
}
```

:::tip å°çŸ¥è¯†

é€šè¿‡æ³›å‹ `ILogger<T>` æ–¹å¼å†™å…¥æ—¥å¿—ï¼Œé‚£ä¹ˆé»˜è®¤å°† `T` ç±»å‹å®Œæ•´ç±»å‹åç§°ä½œä¸º `æ—¥å¿—ç±»åˆ«`ã€‚

:::

### 18.4.2 `ILoggerFactory` å·¥å‚æ–¹å¼

ä½¿ç”¨å·¥å‚æ–¹å¼ï¼Œéœ€æ‰‹åŠ¨ä¼ å…¥ `æ—¥å¿—ç±»åˆ«`ï¼Œå¦‚ï¼š

```cs showLineNumbers  {5,7}
public class ContactModel : PageModel
{
    private readonly ILogger _logger;

    public ContactModel(ILoggerFactory logger)
    {
        _logger = logger.CreateLogger("MyCategory");
    }

    public void OnGet()
    {
        _logger.LogInformation("GET Pages.ContactModel called.");
    }
}
```

### 18.4.3 `Log` é™æ€ç±»æ–¹å¼

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.2.1 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

```cs showLineNumbers {2,5,10-15}
// åˆ›å»ºæ—¥å¿—å¯¹è±¡
var logger = Log.CreateLogger("æ—¥å¿—åç§°");

// åˆ›å»ºæ—¥å¿—å·¥å‚
using var loggerFactory = Log.CreateLoggerFactory(builder => {
    // ....
});

// æ—¥å¿—è®°å½•
Log.Information("Information");
Log.Warning("Warning");
Log.Error("Error");
Log.Debug("Debug");
Log.Trace("Trace");
Log.Critical("Critical");
```

### 18.4.4 `æ‡’äººæ¨¡å¼` ğŸ˜

åœ¨ `Furion` æ¡†æ¶ä¸­ï¼Œæä¾›äº†æ›´æ‡’çš„æ–¹å¼å†™å…¥æ—¥å¿—ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡å­—ç¬¦ä¸²æ‹“å±•çš„æ–¹å¼å†™å…¥ï¼Œå¦‚ï¼š

```cs showLineNumbers
"ç®€å•æ—¥å¿—".LogInformation();

"ç™¾å°åƒ§ æ–°å¢äº†ä¸€æ¡è®°å½•".LogInformation<HomeController>();

"ç¨‹åºå‡ºç°å¼‚å¸¸å•¦".LogError<HomeController>();

"è¿™æ˜¯è‡ªå®šä¹‰ç±»åˆ«æ—¥å¿—".SetCategory<HomeController>().LogInformation();
```

é€šè¿‡å­—ç¬¦ä¸²æ‹“å±•æ–¹å¼å¯ä»¥åœ¨ä»»ä½•æ—¶å€™æ–¹ä¾¿è®°å½•æ—¥å¿—ï¼Œä¸“é—¨ä¸ºæ‡’äººæä¾›çš„ã€‚

## 18.5 è¾“å‡ºåˆ°æ§åˆ¶å°

åœ¨ `ASP.NET Core` åº”ç”¨ç¨‹åºä¸­ï¼Œä¸»æœºå¯åŠ¨æ—¶é»˜è®¤æ³¨å†Œäº† `ConsoleLoggerProvider` æä¾›å™¨ï¼Œä¹Ÿå°±æ˜¯æ§åˆ¶å°æ—¥å¿—è¾“å‡ºæä¾›å™¨ï¼Œæ‰€ä»¥æ— éœ€ä»»ä½•æ³¨å†ŒæœåŠ¡å³å¯åœ¨æ§åˆ¶å°è¾“å‡ºã€‚

```bash showLineNumbers
info: Furion.EventBus.EventBusHostedService[0]
      EventBus Hosted Service is running.
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: https://localhost:5001
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://localhost:5000
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
info: Microsoft.Hosting.Lifetime[0]
      Content root path: C:\Workplaces\Furion\samples\Furion.Web.Entry\
```

### 18.5.1 æ—¥å¿—è¿‡æ»¤/ç­›é€‰

é€šè¿‡æ—¥å¿—ç­›é€‰å™¨å¯ä»¥å¯¹æ—¥å¿—è¿›è¡Œå½’ç±»å†™å…¥ã€‚

```cs showLineNumbers {2,4,11,13}
// ä¾‹å­ä¸€ï¼šæ ¹æ®æ—¥å¿—çº§åˆ«è¾“å‡º
services.AddConsoleFormatter(options =>
{
    options.WriteFilter = (logMsg) =>   // Furion 4.8.8.52+ ç‰ˆæœ¬æ”¯æŒ
    {
        return logMsg.LogLevel == LogLevel.Information;
    };
});

// ä¾‹å­äºŒï¼Œæ ¹æ®ä»»ä½•è§„åˆ™ï¼Œæ¯”å¦‚ç‰¹å®šçš„ç±»å
services.AddConsoleFormatter(options => // Furion 4.8.8.52+ ç‰ˆæœ¬æ”¯æŒ
{
    options.WriteFilter = (logMsg) =>
    {
        return logMsg.LogName == "System.Logging.LoggingMonitor";
    };
});
```

### 18.5.2 æ—¥å¿—æ ‡å‡†åŒ–ï¼ˆç¾åŒ–ï¼‰æ¨¡æ¿

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.5.0 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

åœ¨ `ASP.NET Core` é»˜è®¤æ§åˆ¶å°æ—¥å¿—ç›¸å¯¹ç®€æ´ï¼Œå¹¶æœªåŒ…å«å¸¸è§çš„æ—¥å¿—æ—¶é—´ã€çº¿ç¨‹ `Id` ç­‰ï¼Œè€Œä¸”è‡ªå®šä¹‰æ¨¡æ¿ä¹Ÿç›¸å¯¹å¤æ‚ï¼Œæ‰€ä»¥ `Furion 4.5.0+` ç‰ˆæœ¬æä¾›äº†ç®€åŒ–é…ç½®ï¼Œå¦‚ï¼š

1. `Startup.cs` æ–¹å¼

```cs showLineNumbers
services.AddConsoleFormatter();
```

2. `.NET5` æ–¹å¼

```cs showLineNumbers {2,4}
Host.CreateDefaultBuilder(args)
    .ConfigureLogging(logging =>
    {
        logging.AddConsoleFormatter();
    });
```

3. `.NET6` æ–¹å¼

```cs showLineNumbers {3}
var builder = WebApplication.CreateBuilder(args);

builder.Logging.AddConsoleFormatter();
```

4. `Serve.Run()` æ–¹å¼

```cs showLineNumbers {1,3,7}
Serve.Run(RunOptions.Default.AddWebComponent<WebComponent>());

public class WebComponent : IWebComponent
{
    public void Load(WebApplicationBuilder builder, ComponentContext componentContext)
    {
        builder.Logging.AddConsoleFormatter();
    }
}
```

è¾“å‡ºç»“æœï¼š

```bash showLineNumbers
info: 2023-03-23 11:51:02.3757469 +08:00 æ˜ŸæœŸå›› L Microsoft.Hosting.Lifetime[14] #1
      Now listening on: https://localhost:7025
info: 2023-03-23 11:51:02.4993301 +08:00 æ˜ŸæœŸå›› L Microsoft.Hosting.Lifetime[14] #1
      Now listening on: http://localhost:5217
info: 2023-03-23 11:51:02.5058785 +08:00 æ˜ŸæœŸå›› L Microsoft.Hosting.Lifetime[0] #1
      Application started. Press Ctrl+C to shut down.
info: 2023-03-23 11:51:02.5100496 +08:00 æ˜ŸæœŸå›› L Microsoft.Hosting.Lifetime[0] #1
      Hosting environment: Development
info: 2023-03-23 11:51:02.5127095 +08:00 æ˜ŸæœŸå›› L Microsoft.Hosting.Lifetime[0] #1
      Content root path: C:\Users\snrcsoft\source\repos\WebApplication1\WebApplication1
```

### 18.5.3 è‡ªå®šä¹‰æ—¥å¿—æ¨¡æ¿

```cs showLineNumbers {1,3,13,15}
services.AddConsoleFormatter(options =>
{
    options.MessageFormat = (logMsg) =>
    {
        var stringBuilder = new StringBuilder();
        stringBuilder.Append(DateTime.Now.ToString("o"));
        // å…¶ä»–çš„ã€‚ã€‚ã€‚è‡ªå·±ç»„è£…
        return stringBuilder.ToString();
    };
});

// è¾“å‡ºä¸º JSON æ ¼å¼ï¼ŒFurion 4.5.2+
services.AddConsoleFormatter(options =>
{
    options.MessageFormat = LoggerFormatter.Json;
    // Furion 4.8.0+ æ–°å¢ JSON ç¾åŒ–è¾“å‡º
    options.MessageFormat = LoggerFormatter.JsonIndented;
});
```

### 18.5.4 è‡ªå®šä¹‰æ—¥å¿—è¾“å‡ºæ—¶é—´æ ¼å¼

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.5.1 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

```cs showLineNumbers {1,3}
services.AddConsoleFormatter(options =>
{
    options.DateFormat = "yyyy-MM-dd HH:mm:ss.fffffff zzz dddd";
});
```

```bash showLineNumbers {1}
info: 2022-09-28 02:02:20(+08:00) æ˜ŸæœŸä¸‰ System.Logging.EventBusService[0] #1
      EventBus Hosted Service is running.
info: 2022-09-28 02:02:22(+08:00) æ˜ŸæœŸä¸‰ Microsoft.Hosting.Lifetime[14] #1
      Now listening on: https://localhost:5001
info: 2022-09-28 02:02:22(+08:00) æ˜ŸæœŸä¸‰ Microsoft.Hosting.Lifetime[14] #1
      Now listening on: http://localhost:5000
info: 2022-09-28 02:02:22(+08:00) æ˜ŸæœŸä¸‰ Microsoft.Hosting.Lifetime[0] #1
      Application started. Press Ctrl+C to shut down.
info: 2022-09-28 02:02:22(+08:00) æ˜ŸæœŸä¸‰ Microsoft.Hosting.Lifetime[0] #1
      Hosting environment: Development
info: 2022-09-28 02:02:22(+08:00) æ˜ŸæœŸä¸‰ Microsoft.Hosting.Lifetime[0] #1
      Content root path: D:\Workplaces\OpenSources\Furion\samples\Furion.Web.Entry\
```

### 18.5.5 è‡ªå®šä¹‰æ—¥å¿—è¾“å‡ºç¨‹åº

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.5.2 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

`ASP.NET Core` å’Œ `Furion` æ¡†æ¶éƒ½æä¾›äº†æ ‡å‡†åŒ–æ—¥å¿—è¾“å‡ºï¼Œå¦‚æœå¯¹é¢œè‰²ï¼Œæ ¼å¼æœ‰è¦æ±‚ï¼Œå¯ä½¿ç”¨ä¸‹åˆ—ä»£ç è¿›è¡Œè‡ªå®šä¹‰ã€‚

```cs showLineNumbers {1,3,5}
services.AddConsoleFormatter(options =>
{
    options.WriteHandler = (logMsg, scopeProvider, writer, fmtMsg, opt) =>
    {
        writer.WriteLine(fmtMsg);
    };
});
```

### 18.5.6 è¾“å‡ºæ—¥å¿— `TraceId/HttpContextId`

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.1.3 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ—¥å¿—çš„è¾“å‡ºæ˜¯éå¸¸é¢‘ç¹çš„ï¼Œä½†æ˜¯å¾ˆéš¾ä»æ—¥å¿—æ–‡ä»¶ä¸­åˆ¤æ–­å“ªäº›æ—¥å¿—æ˜¯å±äºåŒä¸€ä¸ªè¯·æ±‚è¾“å‡ºçš„ï¼Œè¿™æ—¶å¯ç”¨ `WithTraceId` é…ç½®å³å¯ã€‚

```cs showLineNumbers {3}
services.AddConsoleFormatter(options =>
{
    options.WithTraceId = true;
});
```

è¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š

```bash showLineNumbers {15,17}
info: 2022-11-24 14:34:55.1717549 +08:00 æ˜ŸæœŸå›› L System.Logging.EventBusService[0] #1
      EventBus Hosted Service is running.
info: 2022-11-24 14:34:55.2504015 +08:00 æ˜ŸæœŸå›› L System.Logging.ScheduleService[0] #1
      Schedule Hosted Service is running.
info: 2022-11-24 14:34:56.4280796 +08:00 æ˜ŸæœŸå›› L Microsoft.Hosting.Lifetime[14] #1
      Now listening on: https://localhost:5001
info: 2022-11-24 14:34:56.4331170 +08:00 æ˜ŸæœŸå›› L Microsoft.Hosting.Lifetime[14] #1
      Now listening on: http://localhost:5000
info: 2022-11-24 14:34:56.4384567 +08:00 æ˜ŸæœŸå›› L Microsoft.Hosting.Lifetime[0] #1
      Application started. Press Ctrl+C to shut down.
info: 2022-11-24 14:34:56.4408766 +08:00 æ˜ŸæœŸå›› L Microsoft.Hosting.Lifetime[0] #1
      Hosting environment: Development
info: 2022-11-24 14:34:56.4427659 +08:00 æ˜ŸæœŸå›› L Microsoft.Hosting.Lifetime[0] #1
      Content root path: D:\Workplaces\OpenSources\Furion\samples\Furion.Web.Entry
info: 2022-11-24 14:35:06.8507338 +08:00 Thursday L Furion.Application.TestLoggerServices[0] #17 '00-48df9ac5c8280de2f301faa44a23a10c-b75678d9f3883b0b-00'
      æˆ‘æ˜¯ä¸€ä¸ªæ—¥å¿— 20
info: 2022-11-24 14:35:16.0373384 +08:00 æ˜ŸæœŸå›› L Furion.Application.TestLoggerServices[0] #17 '00-ff4fb15d6ff41a0411784e66400f0dfd-962bc25eff788b25-00'
      æˆ‘æ˜¯ä¸€ä¸ªæ—¥å¿— 20
```

### 18.5.7 è¾“å‡ºæ—¥å¿— `ç¨‹åºé›†/ç±»å‹/æ–¹æ³•`

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.7.16 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬å¸Œæœ›çŸ¥é“è¿™ä¸ªæ—¥å¿—æ˜¯åœ¨å“ªä¸ªç¨‹åºé›†ï¼Œå“ªä¸ªç±»ä¸­å“ªä¸ªæ–¹æ³•è¾“å‡ºï¼Œè¿™æ—¶å¯ç”¨ `WithStackFrame` é…ç½®å³å¯ã€‚

```cs showLineNumbers {3}
services.AddConsoleFormatter(options =>
{
    options.WithStackFrame = true;
});
```

è¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š

```bash showLineNumbers {2,5,8,11,14,17,20}
info: 2023-03-17 18:25:06.7988349 +08:00 æ˜ŸæœŸäº” L System.Logging.EventBusService[0] #1
      [Furion.dll] async Task Furion.EventBus.EventBusHostedService.ExecuteAsync(CancellationToken stoppingToken)
      EventBus hosted service is running.
info: 2023-03-17 18:25:08.1393952 +08:00 æ˜ŸæœŸäº” L Microsoft.Hosting.Lifetime[14] #1
      [System.Private.CoreLib.dll] void System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start<TStateMachine>(ref TStateMachine stateMachine)
      Now listening on: https://localhost:5001
info: 2023-03-17 18:25:08.1620391 +08:00 æ˜ŸæœŸäº” L Microsoft.Hosting.Lifetime[14] #1
      [System.Private.CoreLib.dll] void System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start<TStateMachine>(ref TStateMachine stateMachine)
      Now listening on: http://localhost:5000
info: 2023-03-17 18:25:08.1972456 +08:00 æ˜ŸæœŸäº” L Microsoft.Hosting.Lifetime[0] #1
      [Microsoft.Extensions.Hosting.dll] void Microsoft.Extensions.Hosting.Internal.ConsoleLifetime.OnApplicationStarted()
      Application started. Press Ctrl+C to shut down.
info: 2023-03-17 18:25:08.2456579 +08:00 æ˜ŸæœŸäº” L Microsoft.Hosting.Lifetime[0] #1
      [Microsoft.Extensions.Hosting.dll] void Microsoft.Extensions.Hosting.Internal.ConsoleLifetime.OnApplicationStarted()
      Hosting environment: Development
info: 2023-03-17 18:25:08.2746134 +08:00 æ˜ŸæœŸäº” L Microsoft.Hosting.Lifetime[0] #1
      [System.Private.CoreLib.dll] void System.Threading.CancellationTokenSource.ExecuteCallbackHandlers(bool throwOnFirstException)
      Content root path: D:\Workplaces\OpenSources\Furion\samples\Furion.Web.Entry
info: 2023-03-17 18:25:18.1917784 +08:00 æ˜ŸæœŸäº” L Furion.Application.TestLoggerServices[0] #16
      [Furion.Application.dll] void Furion.Application.TestLoggerServices.æµ‹è¯•æ—¥å¿—()
      æˆ‘æ˜¯ä¸€ä¸ªæ—¥å¿— 20
```

## 18.6 è¾“å‡ºåˆ°æ–‡ä»¶

### 18.6.1 åŸºç¡€ä½¿ç”¨

```cs showLineNumbers {2,5,8}
// ä¾‹å­ä¸€ï¼šå¯åŠ¨å±‚æ ¹ç›®å½•è¾“å‡º
services.AddFileLogging("application.log");

// ä¾‹å­äºŒï¼šæ”¯æŒè·¯å¾„
services.AddFileLogging("logs/application.log");

// ä¾‹å­ä¸‰ï¼šæ”¯æŒæ—¥å¿—è¿½åŠ è¿˜æ˜¯è¦†ç›–ï¼Œè®¾ç½® true ä¸ºè¿½åŠ ï¼Œfalse ä¸ºè¦†ç›–
services.AddFileLogging("application.log", true);
```

### 18.6.2 ä»é…ç½®æ–‡ä»¶è¯»å–é…ç½®

:::important ç‰¹åˆ«æ³¨æ„

**åªæœ‰ä¸åœ¨ `.AddFile` ç¬¬ä¸€ä¸ªå‚æ•°é…ç½®æ–‡ä»¶åæ‰ä¼šè‡ªåŠ¨åŠ è½½é…ç½®ï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶ååº”è¯¥é…ç½®åœ¨é…ç½®æ–‡ä»¶ä¸­ã€‚**

:::

æ–‡ä»¶æ—¥å¿—é…ç½®è¯´æ˜ï¼š

```json showLineNumbers {2,7-13,16-22}
{
  "Logging": {
    "LogLevel": {
      "Default": "Information"
      // .... appsettings é»˜è®¤é…ç½®
    },
    "File": {
      "FileName": "application.log", // æ—¥å¿—æ–‡ä»¶å®Œæ•´è·¯å¾„æˆ–æ–‡ä»¶åï¼Œæ¨è .log ä½œä¸ºæ‹“å±•å
      "Append": true, // è¿½åŠ åˆ°å·²å­˜åœ¨æ—¥å¿—æ–‡ä»¶æˆ–è¦†ç›–å®ƒä»¬
      "MinimumLevel": "Information", // æœ€ä½æ—¥å¿—è®°å½•çº§åˆ«
      "FileSizeLimitBytes": 0, // æ§åˆ¶æ¯ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§å­˜å‚¨å¤§å°ï¼Œå•ä½æ˜¯ Bï¼Œä¹Ÿå°±æ˜¯ 1024 æ‰ç­‰äº 1KBï¼Œé»˜è®¤æ— é™åˆ¶ï¼Œå¦‚æœæŒ‡å®šäº†è¯¥å€¼ï¼Œé‚£ä¹ˆæ—¥å¿—æ–‡ä»¶å¤§å°è¶…å‡ºäº†è¯¥é…ç½®å°±ä¼šåˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶ï¼Œæ–°åˆ›å»ºçš„æ—¥å¿—æ–‡ä»¶å‘½åè§„åˆ™ï¼šæ–‡ä»¶å+[é€’å¢åºå·].log
      "MaxRollingFiles": 0 // æ§åˆ¶æœ€å¤§åˆ›å»ºçš„æ—¥å¿—æ–‡ä»¶æ•°é‡ï¼Œé»˜è®¤æ— é™åˆ¶ï¼Œé…åˆ FileSizeLimitBytes ä½¿ç”¨ï¼Œå¦‚æœæŒ‡å®šäº†è¯¥å€¼ï¼Œé‚£ä¹ˆè¶…å‡ºè¯¥å€¼å°†ä»æœ€åˆæ—¥å¿—æ–‡ä»¶ä¸­ä»å¤´å†™å…¥è¦†ç›–
    }
  },
  // è‡ªå®šä¹‰é…ç½®èŠ‚ç‚¹
  "MyLogger": {
    "FileName": "application.log",
    "Append": true,
    "MinimumLevel": "Information",
    "FileSizeLimitBytes": 0,
    "MaxRollingFiles": 0
  }
}
```

```cs showLineNumbers {2,5,13,16}
// ä¾‹å­ä¸€ï¼šé»˜è®¤è¯»å– Logging:File èŠ‚ç‚¹
services.AddFileLogging();

// ä¾‹å­äºŒï¼šé»˜è®¤è¯»å– Logging:File èŠ‚ç‚¹ï¼Œæ”¯æŒæ›´å¤šé…ç½®
services.AddFileLogging(options =>
{
    options.MinimumLevel = LogLevel.Warning;

    // å…¶ä»–é…ç½®...
});

// ä¾‹å­ä¸‰ï¼šè‡ªå®šä¹‰é…ç½®èŠ‚ç‚¹
services.AddFileLogging(() => "MyLogger");

// ä¾‹å­å››ï¼šè‡ªå®šä¹‰é…ç½®èŠ‚ç‚¹ï¼Œæ”¯æŒæ›´å¤šé…ç½®
services.AddFileLogging(() => "MyLogger", options =>
{
    options.MinimumLevel = LogLevel.Warning;

    // å…¶ä»–é…ç½®...
});
```

### 18.6.3 è‡ªå®šä¹‰æ—¥å¿—æ–‡ä»¶åè§„åˆ™

```cs showLineNumbers {2,5,14,23}
// ä¾‹å­ä¸€ï¼šæ”¯æŒç³»ç»Ÿç¯å¢ƒå˜é‡ï¼Œå¦‚%SystemDrive%ï¼Œ%SystemRoot%
services.AddFileLogging("application%SystemDrive%-%SystemRoot%.log");

// ä¾‹å­äºŒï¼šæ¯å¤©åˆ›å»ºä¸€ä¸ªæ—¥å¿—æ–‡ä»¶
services.AddFileLogging("application-{0:yyyy}-{0:MM}-{0:dd}.log", options =>
{
    options.FileNameRule = fileName =>
    {
        return string.Format(fileName, DateTime.UtcNow);
    };
});

// ä¾‹å­ä¸‰ï¼Œä»»ä½•è‡ªå·±å–œæ¬¢çš„å‘½åè§„åˆ™
services.AddFileLogging("application-{0:yyyy}-{0:MM}-{0:dd}.log", options =>
{
    options.FileNameRule = fileName =>
    {
        // your rule...
    };
});

// ä¾‹å­å››ï¼Œæ‰¹é‡è®¾ç½®å¤šä¸ª
Array.ForEach(new[] { LogLevel.Information, LogLevel.Warning, LogLevel.Error }, logLevel =>
{
    services.AddFileLogging("application-{1}-{0:yyyy}-{0:MM}-{0:dd}.log", options =>
    {
        options.FileNameRule = fileName => string.Format(fileName, DateTime.UtcNow, logLevel.ToString());
        options.WriteFilter = logMsg => logMsg.LogLevel == logLevel;
    });
});
```

### 18.6.4 æ—¥å¿—è¿‡æ»¤å™¨/ç­›é€‰å™¨

é€šè¿‡æ—¥å¿—ç­›é€‰å™¨å¯ä»¥å¯¹æ—¥å¿—è¿›è¡Œå½’ç±»å†™å…¥

```cs showLineNumbers {2,10,19}
// ä¾‹å­ä¸€ï¼šæ ¹æ®æ—¥å¿—çº§åˆ«è¾“å‡º
services.AddFileLogging("infomation.log", options =>
{
    options.WriteFilter = (logMsg) =>
    {
        return logMsg.LogLevel == LogLevel.Information;
    };
});

services.AddFileLogging("error.log", options =>
{
    options.WriteFilter = (logMsg) =>
    {
        return logMsg.LogLevel == LogLevel.Error;
    };
});

// ä¾‹å­äºŒï¼Œæ ¹æ®ä»»ä½•è§„åˆ™ï¼Œæ¯”å¦‚ç‰¹å®šçš„ç±»å
services.AddFileLogging("someclass.log", options =>
{
    options.WriteFilter = (logMsg) =>
    {
        return logMsg.LogName.Contains("SomeClassName");
    };
});
```

### 18.6.5 è‡ªå®šä¹‰æ—¥å¿—æ¨¡æ¿

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`Furion` æä¾›äº†æ ‡å‡†çš„æ—¥å¿—è¾“å‡ºæ¨¡æ¿ï¼Œå¦‚ï¼š

```bash showLineNumbers
2022-07-23T20:16:29.3459053+08:00	[INF]	[Furion.EventBus.EventBusHostedService]	[0]	EventBus Hosted Service is running.
2022-07-23T20:16:29.5827366+08:00	[INF]	[Microsoft.Hosting.Lifetime]	[0]	Application started. Press Ctrl+C to shut down.
2022-07-23T20:16:29.5828798+08:00	[INF]	[Microsoft.Hosting.Lifetime]	[0]	Hosting environment: Development
2022-07-23T20:16:29.5829377+08:00	[INF]	[Microsoft.Hosting.Lifetime]	[0]	Content root path: C:\Workplaces\Furion\samples\Furion.Web.Entry\
```

å¦‚éœ€è‡ªå®šä¹‰ï¼š

```cs showLineNumbers {2,16,34,47,49}
// ä¾‹å­ä¸€ï¼Œè‡ªå®šä¹‰æ—¥å¿—æ¨¡æ¿ï¼ˆå¸¸ç”¨ï¼‰
services.AddFileLogging("mytemplate.log", options =>
{
    options.MessageFormat = (logMsg) =>
    {
        var stringBuilder = new StringBuilder();

        stringBuilder.Append(DateTime.Now.ToString("o"));
        // å…¶ä»–çš„ã€‚ã€‚ã€‚è‡ªå·±ç»„è£…

        return stringBuilder.ToString();
    };
});

// ä¾‹å­äºŒï¼Œéœ€è¦è¾“å‡º json æ ¼å¼ï¼Œæ¯”å¦‚å¯¹æ¥é˜¿é‡Œäº‘æ—¥å¿—ï¼Œkibanaç¬¬ä¸‰æ–¹æ—¥å¿—ä½¿ç”¨è¿™ä¸ª
services.AddFileLogging("mytemplate.log", options =>
{
    options.MessageFormat = (logMsg) =>
    {
        // é«˜æ€§èƒ½å†™å…¥
        return logMsg.WriteArray(writer =>
        {
            writer.WriteStringValue(DateTime.Now.ToString("o"));
            writer.WriteStringValue(logMsg.LogLevel.ToString());
            writer.WriteStringValue(logMsg.LogName);
            writer.WriteNumberValue(logMsg.EventId.Id);
            writer.WriteStringValue(logMsg.Message);
            writer.WriteStringValue(logMsg.Exception?.ToString());
        });
    };
});

// ä¾‹å­äºŒï¼Œéœ€è¦è¾“å‡º json ï¼ˆè‡ªå®šä¹‰ï¼‰æ ¼å¼ï¼Œæ¯”å¦‚å¯¹æ¥é˜¿é‡Œäº‘æ—¥å¿—ï¼Œkibanaç¬¬ä¸‰æ–¹æ—¥å¿—ä½¿ç”¨è¿™ä¸ª
services.AddFileLogging("mytemplate.log", options =>
{
    options.MessageFormat = (logMsg) =>
    {
        // é«˜æ€§èƒ½å†™å…¥
        return logMsg.Write(writer =>
        {
            // write å¯¹è±¡ä¸º Utf8JsonWriterï¼Œå¯é€šè¿‡æµå†™å…¥ï¼Œæ€§èƒ½æé«˜
        });
    };
});

// è¾“å‡ºä¸º JSON æ ¼å¼ï¼ŒFurion 4.5.2+
services.AddFileLogging("mytemplate.log", options =>
{
    options.MessageFormat = LoggerFormatter.Json;
    // Furion 4.8.0+ æ–°å¢ JSON ç¾åŒ–è¾“å‡º
    options.MessageFormat = LoggerFormatter.JsonIndented;
});
```

### 18.6.6 æ—¥å¿—å†™å…¥å¤±è´¥å¤„ç†

æœ‰æ—¶å€™å¯èƒ½å› ä¸ºæ—¥å¿—æ–‡ä»¶è¢«æ‰“å¼€æˆ–è€…å…¶ä»–åº”ç”¨ç¨‹åºå ç”¨äº†ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´æ—¥å¿—å†™å…¥å¤±è´¥ï¼Œè¿™æ—¶å€™å¯ä»¥è¿›è¡Œå…¶ä»–ç›¸å…³å¤„ç†ï¼š

```cs showLineNumbers {2,11,15}
// ä¾‹å­ä¸€ï¼šå…¶ä»–å¤„ç†
services.AddFileLogging("template-obj.log", options =>
{
    options.HandleWriteError = (writeError) =>
    {
        // ~~
    };
});

// ä¾‹å­äºŒï¼Œå¯ç”¨å¤‡ç”¨æ—¥å¿—æ–‡ä»¶åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯å¦‚æœæ–‡ä»¶è¢«å ç”¨äº†ï¼Œå¯ä»¥åˆ›å»ºæ–°çš„å¤‡ç”¨æ—¥å¿—ç»§ç»­å†™å…¥ï¼Œæ¨èï¼ï¼ï¼
services.AddFileLogging("template-obj.log", options =>
{
    options.HandleWriteError = (writeError) =>
    {
        writeError.UseRollbackFileName(Path.GetFileNameWithoutExtension(writeError.CurrentFileName) + "-oops" + Path.GetExtension(writeError.CurrentFileName));
    };
});
```

### 18.6.7 è‡ªå®šä¹‰æ—¥å¿—è¾“å‡ºæ—¶é—´æ ¼å¼

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.5.1 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

```cs showLineNumbers {1,3}
services.AddFileLogging("application.log", options =>
{
    options.DateFormat = "yyyy-MM-dd HH:mm:ss.fffffff zzz dddd";
});
```

```bash showLineNumbers {1}
info: 2022-09-28 02:02:20(+08:00) æ˜ŸæœŸä¸‰ System.Logging.EventBusService[0] #1
      EventBus Hosted Service is running.
info: 2022-09-28 02:02:22(+08:00) æ˜ŸæœŸä¸‰ Microsoft.Hosting.Lifetime[14] #1
      Now listening on: https://localhost:5001
info: 2022-09-28 02:02:22(+08:00) æ˜ŸæœŸä¸‰ Microsoft.Hosting.Lifetime[14] #1
      Now listening on: http://localhost:5000
info: 2022-09-28 02:02:22(+08:00) æ˜ŸæœŸä¸‰ Microsoft.Hosting.Lifetime[0] #1
      Application started. Press Ctrl+C to shut down.
info: 2022-09-28 02:02:22(+08:00) æ˜ŸæœŸä¸‰ Microsoft.Hosting.Lifetime[0] #1
      Hosting environment: Development
info: 2022-09-28 02:02:22(+08:00) æ˜ŸæœŸä¸‰ Microsoft.Hosting.Lifetime[0] #1
      Content root path: D:\Workplaces\OpenSources\Furion\samples\Furion.Web.Entry\
```

### 18.6.8 è¾“å‡ºæ—¥å¿— `TraceId/HttpContextId`

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.1.3 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ—¥å¿—çš„è¾“å‡ºæ˜¯éå¸¸é¢‘ç¹çš„ï¼Œä½†æ˜¯å¾ˆéš¾ä»æ—¥å¿—æ–‡ä»¶ä¸­åˆ¤æ–­å“ªäº›æ—¥å¿—æ˜¯å±äºåŒä¸€ä¸ªè¯·æ±‚è¾“å‡ºçš„ï¼Œè¿™æ—¶å¯ç”¨ `WithTraceId` é…ç½®å³å¯ã€‚

```cs showLineNumbers {3}
services.AddFileLogging(options =>
{
    options.WithTraceId = true;
});
```

è¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š

```bash showLineNumbers {15,17}
info: 2022-11-24 14:34:55.1717549 +08:00 æ˜ŸæœŸå›› L System.Logging.EventBusService[0] #1
      EventBus Hosted Service is running.
info: 2022-11-24 14:34:55.2504015 +08:00 æ˜ŸæœŸå›› L System.Logging.ScheduleService[0] #1
      Schedule Hosted Service is running.
info: 2022-11-24 14:34:56.4280796 +08:00 æ˜ŸæœŸå›› L Microsoft.Hosting.Lifetime[14] #1
      Now listening on: https://localhost:5001
info: 2022-11-24 14:34:56.4331170 +08:00 æ˜ŸæœŸå›› L Microsoft.Hosting.Lifetime[14] #1
      Now listening on: http://localhost:5000
info: 2022-11-24 14:34:56.4384567 +08:00 æ˜ŸæœŸå›› L Microsoft.Hosting.Lifetime[0] #1
      Application started. Press Ctrl+C to shut down.
info: 2022-11-24 14:34:56.4408766 +08:00 æ˜ŸæœŸå›› L Microsoft.Hosting.Lifetime[0] #1
      Hosting environment: Development
info: 2022-11-24 14:34:56.4427659 +08:00 æ˜ŸæœŸå›› L Microsoft.Hosting.Lifetime[0] #1
      Content root path: D:\Workplaces\OpenSources\Furion\samples\Furion.Web.Entry
info: 2022-11-24 14:35:06.8507338 +08:00 Thursday L Furion.Application.TestLoggerServices[0] #17 '00-48df9ac5c8280de2f301faa44a23a10c-b75678d9f3883b0b-00'
      æˆ‘æ˜¯ä¸€ä¸ªæ—¥å¿— 20
info: 2022-11-24 14:35:16.0373384 +08:00 æ˜ŸæœŸå›› L Furion.Application.TestLoggerServices[0] #17 '00-ff4fb15d6ff41a0411784e66400f0dfd-962bc25eff788b25-00'
      æˆ‘æ˜¯ä¸€ä¸ªæ—¥å¿— 20
```

### 18.6.9 è¾“å‡ºæ—¥å¿— `ç¨‹åºé›†/ç±»å‹/æ–¹æ³•`

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.7.16 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬å¸Œæœ›çŸ¥é“è¿™ä¸ªæ—¥å¿—æ˜¯åœ¨å“ªä¸ªç¨‹åºé›†ï¼Œå“ªä¸ªç±»ä¸­å“ªä¸ªæ–¹æ³•è¾“å‡ºï¼Œè¿™æ—¶å¯ç”¨ `WithStackFrame` é…ç½®å³å¯ã€‚

```cs showLineNumbers {3}
services.AddFileLogging(options =>
{
    options.WithStackFrame = true;
});
```

è¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š

```bash showLineNumbers {2,5,8,11,14,17,20}
info: 2023-03-17 18:25:06.7988349 +08:00 æ˜ŸæœŸäº” L System.Logging.EventBusService[0] #1
      [Furion.dll] async Task Furion.EventBus.EventBusHostedService.ExecuteAsync(CancellationToken stoppingToken)
      EventBus hosted service is running.
info: 2023-03-17 18:25:08.1393952 +08:00 æ˜ŸæœŸäº” L Microsoft.Hosting.Lifetime[14] #1
      [System.Private.CoreLib.dll] void System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start<TStateMachine>(ref TStateMachine stateMachine)
      Now listening on: https://localhost:5001
info: 2023-03-17 18:25:08.1620391 +08:00 æ˜ŸæœŸäº” L Microsoft.Hosting.Lifetime[14] #1
      [System.Private.CoreLib.dll] void System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start<TStateMachine>(ref TStateMachine stateMachine)
      Now listening on: http://localhost:5000
info: 2023-03-17 18:25:08.1972456 +08:00 æ˜ŸæœŸäº” L Microsoft.Hosting.Lifetime[0] #1
      [Microsoft.Extensions.Hosting.dll] void Microsoft.Extensions.Hosting.Internal.ConsoleLifetime.OnApplicationStarted()
      Application started. Press Ctrl+C to shut down.
info: 2023-03-17 18:25:08.2456579 +08:00 æ˜ŸæœŸäº” L Microsoft.Hosting.Lifetime[0] #1
      [Microsoft.Extensions.Hosting.dll] void Microsoft.Extensions.Hosting.Internal.ConsoleLifetime.OnApplicationStarted()
      Hosting environment: Development
info: 2023-03-17 18:25:08.2746134 +08:00 æ˜ŸæœŸäº” L Microsoft.Hosting.Lifetime[0] #1
      [System.Private.CoreLib.dll] void System.Threading.CancellationTokenSource.ExecuteCallbackHandlers(bool throwOnFirstException)
      Content root path: D:\Workplaces\OpenSources\Furion\samples\Furion.Web.Entry
info: 2023-03-17 18:25:18.1917784 +08:00 æ˜ŸæœŸäº” L Furion.Application.TestLoggerServices[0] #16
      [Furion.Application.dll] void Furion.Application.TestLoggerServices.æµ‹è¯•æ—¥å¿—()
      æˆ‘æ˜¯ä¸€ä¸ªæ—¥å¿— 20
```

## 18.7 è¾“å‡ºåˆ°æ•°æ®åº“/å…¶ä»–å­˜å‚¨ä»‹è´¨

å°†æ—¥å¿—è¾“å‡ºåˆ°æ•°æ®åº“ä¸­ä¹Ÿæ˜¯éå¸¸å¸¸è§çš„éœ€æ±‚ï¼Œ`Furion` æŠŠè¯¥åŠŸèƒ½åšåˆ°äº†éå¸¸ç®€å•ï¼Œæ”¯æŒä»»ä½•å­˜å‚¨ä»‹è´¨ã€‚

åœ¨å†™å…¥æ•°æ®åº“/å…¶ä»–å­˜å‚¨ä»‹è´¨ä¹‹å‰éœ€åˆ›å»ºæ•°æ®åº“æ—¥å¿—å†™å…¥å™¨å¹¶å®ç° `IDatabaseLoggingWriter` æ¥å£ï¼Œ**æ”¯æŒå¤šä¸ª**ï¼Œå¦‚ï¼š

```cs showLineNumbers {1,5,8,12}
using Furion.Logging;

namespace YourProject.Core;

public class DatabaseLoggingWriter : IDatabaseLoggingWriter
{
    // æ”¯æŒæ„é€ å‡½æ•°æ³¨å…¥ä»»ä½•å®ä¾‹ï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾ä»»ä½•æœåŠ¡ï¼Œæ¯”å¦‚æ³¨å…¥ IRepositoryï¼Œæˆ–è€… SqlSugarClient
    public DatabaseLoggingWriter()
    {
    }

    public void Write(LogMessage logMsg, bool flush)
    {
        // è¿™é‡Œå†™ä½ ä»»ä½•æ’å…¥æ•°æ®åº“çš„æ“ä½œï¼Œæ— éœ€ try catch
    }
}
```

:::caution æ³¨æ„äº‹é¡¹

åœ¨ `Furion 4.8.5.4` ç‰ˆæœ¬ä¹‹å‰ï¼Œå¦‚æœåœ¨ `DatabaseLoggingWriter` ä¸­æ³¨å…¥ `ILogger<>` å¯¹è±¡å°†ä¼šå¯¼è‡´æ­»å¾ªç¯ï¼ŒåŸå› æ˜¯ `IDatabaseLoggingWriter` æœ¬èº«å°±æ˜¯æ—¥å¿—è¾“å‡ºçš„æœ€ç»ˆä»‹è´¨ï¼Œå¦‚æœè¿™é‡Œè¿˜è¾“å‡ºæ—¥å¿—ï¼Œå°†å¯¼è‡´é€’å½’åˆå§‹åŒ–æ—¥å¿—å®ä¾‹ã€‚

ä½†åœ¨ `Furion 4.8.5.4+` ç‰ˆæœ¬ä¹‹åï¼Œå¦‚æœæ³¨å…¥äº† `ILogger<>` å®ä¾‹ï¼Œé‚£ä¹ˆå°†å¼ºåˆ¶æ€§å°†å®ä¾‹åŒ–å¯¹è±¡ä¸º `EmptyLogger` å¯¹è±¡ï¼Œä½†è°ƒç”¨å…¶è¾“å‡ºæ—¥å¿—æ–¹æ³•å°†ä¸ä¼šæœ‰ä»»ä½•æ•ˆæœï¼Œå¦‚ï¼š`logger.LogInformation("...")`;

:::

ä½ æ²¡çœ‹é”™ï¼Œå°±è¿™ä¹ˆç®€å•ï¼ï¼

### 18.7.1 åŸºç¡€ä½¿ç”¨

```cs showLineNumbers {2,5}
// ä¾‹å­ä¸€ï¼Œé»˜è®¤é…ç½®
services.AddDatabaseLogging<DatabaseLoggingWriter>(options => {});

// ä¾‹å­äºŒï¼šè‡ªå®šä¹‰é…ç½®
services.AddDatabaseLogging<DatabaseLoggingWriter>(options =>
{
    options.MinimumLevel = LogLevel.Warning;

    // å…¶ä»–é…ç½®...
});
```

### 18.7.2 ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–

:::important ç‰¹åˆ«æ³¨æ„

**åªæœ‰ `.AddDatabase` ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç©ºæ‰ä¼šè‡ªåŠ¨åŠ è½½é…ç½®ã€‚**

:::

æ•°æ®åº“æ—¥å¿—é…ç½®è¯´æ˜ï¼š

```json showLineNumbers {2,7-9,12-14}
{
  "Logging": {
    "LogLevel": {
      "Default": "Information"
      // .... appsettings é»˜è®¤é…ç½®
    },
    "Database": {
      "MinimumLevel": "Information" // æœ€ä½æ—¥å¿—è®°å½•çº§åˆ«
    }
  },
  // è‡ªå®šä¹‰é…ç½®èŠ‚ç‚¹
  "MyLogger": {
    "MinimumLevel": "Information"
  }
}
```

```cs showLineNumbers {2,5,5,18,25}
// ä¾‹å­ä¸€ï¼šé»˜è®¤è¯»å– Logging:Database èŠ‚ç‚¹
services.AddDatabaseLogging<DatabaseLoggingWriter>();

// ä¾‹å­äºŒï¼šé»˜è®¤è¯»å– Logging:Database èŠ‚ç‚¹ï¼Œæ”¯æŒæ›´å¤šé…ç½®
services.AddDatabaseLogging<DatabaseLoggingWriter>(default(string), options =>
{
    options.MinimumLevel = LogLevel.Warning;

    // å…¶ä»–é…ç½®...
});

// ä¾‹å­ä¸‰ï¼šè‡ªå®šä¹‰é…ç½®èŠ‚ç‚¹
services.AddDatabaseLogging<DatabaseLoggingWriter>("MyLogger");
// æˆ–
services.AddDatabaseLogging<DatabaseLoggingWriter>(() => "MyLogger");

// ä¾‹å­å››ï¼šè‡ªå®šä¹‰é…ç½®èŠ‚ç‚¹ï¼Œæ”¯æŒæ›´å¤šé…ç½®
services.AddDatabaseLogging<DatabaseLoggingWriter>("MyLogger", options =>
{
    options.MinimumLevel = LogLevel.Warning;

    // å…¶ä»–é…ç½®...
});
// æˆ–
services.AddDatabaseLogging<DatabaseLoggingWriter>(() => "MyLogger", options =>
{
    options.MinimumLevel = LogLevel.Warning;

    // å…¶ä»–é…ç½®...
});
```

### 18.7.3 æ—¥å¿—è¿‡æ»¤å™¨/ç­›é€‰å™¨

é€šè¿‡æ—¥å¿—ç­›é€‰å™¨å¯ä»¥å¯¹æ—¥å¿—è¿›è¡Œå½’ç±»å†™å…¥

```cs showLineNumbers {2,10,19}
// ä¾‹å­ä¸€ï¼šæ ¹æ®æ—¥å¿—çº§åˆ«è¾“å‡ºï¼Œå¯ä»¥åˆ†åˆ«å®šä¹‰ IDatabaseLoggingWriterï¼Œä¹Ÿå¯ä»¥ç”¨åŒä¸€ä¸ªåº•å±‚è¿›è¡Œåˆ¤æ–­
services.AddDatabaseLogging<InfomationLoggingWriter>(options =>
{
    options.WriteFilter = (logMsg) =>
    {
        return logMsg.LogLevel == LogLevel.Information;
    };
});
// å¯ä»¥åˆ†åˆ«å®šä¹‰ IDatabaseLoggingWriterï¼Œä¹Ÿå¯ä»¥ç”¨åŒä¸€ä¸ªåº•å±‚è¿›è¡Œåˆ¤æ–­
services.AddDatabaseLogging<ErrorLoggingWriter>(options =>
{
    options.WriteFilter = (logMsg) =>
    {
        return logMsg.LogLevel == LogLevel.Error;
    };
});

// ä¾‹å­äºŒï¼Œæ ¹æ®ä»»ä½•è§„åˆ™ï¼Œæ¯”å¦‚ç‰¹å®šçš„ç±»å
services.AddDatabaseLogging<DatabaseLoggingWriter>(options =>
{
    options.WriteFilter = (logMsg) =>
    {
        return logMsg.LogName.Contains("SomeClassName");
    };
});
```

### 18.7.4 è‡ªå®šä¹‰æ—¥å¿—æ¨¡æ¿

```cs showLineNumbers {1,3,15,17}
services.AddDatabaseLogging<DatabaseLoggingWriter>(options =>
{
    options.MessageFormat = (logMsg) =>
    {
        var stringBuilder = new StringBuilder();

        stringBuilder.Append(DateTime.Now.ToString("o"));
        // å…¶ä»–çš„ã€‚ã€‚ã€‚è‡ªå·±ç»„è£…

        return stringBuilder.ToString();
    };
});

// è¾“å‡ºä¸º JSON æ ¼å¼ï¼ŒFurion 4.5.2+
services.AddDatabaseLogging<DatabaseLoggingWriter>(options =>
{
    options.MessageFormat = LoggerFormatter.Json;
    // Furion 4.8.0+ æ–°å¢ JSON ç¾åŒ–è¾“å‡º
    options.MessageFormat = LoggerFormatter.JsonIndented;
});
```

### 18.7.5 æ—¥å¿—å†™å…¥å¤±è´¥å¤„ç†

æœ‰æ—¶å€™å¯èƒ½å› ä¸ºæ•°æ®åº“è¿æ¥å¼‚å¸¸æˆ–å…¶ä»–åŸå› è¿æ¥æ± æ»¡ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´æ—¥å¿—å†™å…¥å¤±è´¥ï¼Œè¿™æ—¶å€™å¯ä»¥è¿›è¡Œå…¶ä»–ç›¸å…³å¤„ç†ï¼š

```cs showLineNumbers {2}
// ä¾‹å­ä¸€ï¼šå…¶ä»–å¤„ç†
services.AddDatabaseLogging<DatabaseLoggingWriter>(options =>
{
    options.HandleWriteError = (writeError) =>
    {
        // ~~
    };
});
```

### 18.7.6 è¾“å‡ºæ—¥å¿— `TraceId/HttpContextId`

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.1.3 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ—¥å¿—çš„è¾“å‡ºæ˜¯éå¸¸é¢‘ç¹çš„ï¼Œä½†æ˜¯å¾ˆéš¾ä»æ—¥å¿—æ–‡ä»¶ä¸­åˆ¤æ–­å“ªäº›æ—¥å¿—æ˜¯å±äºåŒä¸€ä¸ªè¯·æ±‚è¾“å‡ºçš„ï¼Œè¿™æ—¶å¯ç”¨ `WithTraceId` é…ç½®å³å¯ã€‚

```cs showLineNumbers {3}
services.AddDatabaseLogging<DatabaseLoggingWriter>(options =>
{
    options.WithTraceId = true;
});
```

è¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š

```bash showLineNumbers {15,17}
info: 2022-11-24 14:34:55.1717549 +08:00 æ˜ŸæœŸå›› L System.Logging.EventBusService[0] #1
      EventBus Hosted Service is running.
info: 2022-11-24 14:34:55.2504015 +08:00 æ˜ŸæœŸå›› L System.Logging.ScheduleService[0] #1
      Schedule Hosted Service is running.
info: 2022-11-24 14:34:56.4280796 +08:00 æ˜ŸæœŸå›› L Microsoft.Hosting.Lifetime[14] #1
      Now listening on: https://localhost:5001
info: 2022-11-24 14:34:56.4331170 +08:00 æ˜ŸæœŸå›› L Microsoft.Hosting.Lifetime[14] #1
      Now listening on: http://localhost:5000
info: 2022-11-24 14:34:56.4384567 +08:00 æ˜ŸæœŸå›› L Microsoft.Hosting.Lifetime[0] #1
      Application started. Press Ctrl+C to shut down.
info: 2022-11-24 14:34:56.4408766 +08:00 æ˜ŸæœŸå›› L Microsoft.Hosting.Lifetime[0] #1
      Hosting environment: Development
info: 2022-11-24 14:34:56.4427659 +08:00 æ˜ŸæœŸå›› L Microsoft.Hosting.Lifetime[0] #1
      Content root path: D:\Workplaces\OpenSources\Furion\samples\Furion.Web.Entry
info: 2022-11-24 14:35:06.8507338 +08:00 Thursday L Furion.Application.TestLoggerServices[0] #17 '00-48df9ac5c8280de2f301faa44a23a10c-b75678d9f3883b0b-00'
      æˆ‘æ˜¯ä¸€ä¸ªæ—¥å¿— 20
info: 2022-11-24 14:35:16.0373384 +08:00 æ˜ŸæœŸå›› L Furion.Application.TestLoggerServices[0] #17 '00-ff4fb15d6ff41a0411784e66400f0dfd-962bc25eff788b25-00'
      æˆ‘æ˜¯ä¸€ä¸ªæ—¥å¿— 20
```

### 18.7.7 è¾“å‡ºæ—¥å¿— `ç¨‹åºé›†/ç±»å‹/æ–¹æ³•`

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.7.16 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬å¸Œæœ›çŸ¥é“è¿™ä¸ªæ—¥å¿—æ˜¯åœ¨å“ªä¸ªç¨‹åºé›†ï¼Œå“ªä¸ªç±»ä¸­å“ªä¸ªæ–¹æ³•è¾“å‡ºï¼Œè¿™æ—¶å¯ç”¨ `WithStackFrame` é…ç½®å³å¯ã€‚

```cs showLineNumbers {3}
services.AddDatabaseLogging(options =>
{
    options.WithStackFrame = true;
});
```

è¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š

```bash showLineNumbers {2,5,8,11,14,17,20}
info: 2023-03-17 18:25:06.7988349 +08:00 æ˜ŸæœŸäº” L System.Logging.EventBusService[0] #1
      [Furion.dll] async Task Furion.EventBus.EventBusHostedService.ExecuteAsync(CancellationToken stoppingToken)
      EventBus hosted service is running.
info: 2023-03-17 18:25:08.1393952 +08:00 æ˜ŸæœŸäº” L Microsoft.Hosting.Lifetime[14] #1
      [System.Private.CoreLib.dll] void System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start<TStateMachine>(ref TStateMachine stateMachine)
      Now listening on: https://localhost:5001
info: 2023-03-17 18:25:08.1620391 +08:00 æ˜ŸæœŸäº” L Microsoft.Hosting.Lifetime[14] #1
      [System.Private.CoreLib.dll] void System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start<TStateMachine>(ref TStateMachine stateMachine)
      Now listening on: http://localhost:5000
info: 2023-03-17 18:25:08.1972456 +08:00 æ˜ŸæœŸäº” L Microsoft.Hosting.Lifetime[0] #1
      [Microsoft.Extensions.Hosting.dll] void Microsoft.Extensions.Hosting.Internal.ConsoleLifetime.OnApplicationStarted()
      Application started. Press Ctrl+C to shut down.
info: 2023-03-17 18:25:08.2456579 +08:00 æ˜ŸæœŸäº” L Microsoft.Hosting.Lifetime[0] #1
      [Microsoft.Extensions.Hosting.dll] void Microsoft.Extensions.Hosting.Internal.ConsoleLifetime.OnApplicationStarted()
      Hosting environment: Development
info: 2023-03-17 18:25:08.2746134 +08:00 æ˜ŸæœŸäº” L Microsoft.Hosting.Lifetime[0] #1
      [System.Private.CoreLib.dll] void System.Threading.CancellationTokenSource.ExecuteCallbackHandlers(bool throwOnFirstException)
      Content root path: D:\Workplaces\OpenSources\Furion\samples\Furion.Web.Entry
info: 2023-03-17 18:25:18.1917784 +08:00 æ˜ŸæœŸäº” L Furion.Application.TestLoggerServices[0] #16
      [Furion.Application.dll] void Furion.Application.TestLoggerServices.æµ‹è¯•æ—¥å¿—()
      æˆ‘æ˜¯ä¸€ä¸ªæ—¥å¿— 20
```

### 18.7.8 å…³äºé«˜é¢‘å†™å…¥å­˜å‚¨ä»‹è´¨

åœ¨ä¸€äº›é«˜é¢‘å†™å…¥å­˜å‚¨ä»‹è´¨ï¼ˆå¦‚æ•°æ®åº“ï¼‰æ—¥å¿—çš„åœºæ™¯ï¼Œä¸ºé¿å…é¢‘ç¹è§£ææœåŠ¡ï¼ˆåˆ›å»ºå’Œé”€æ¯é“¾æ¥ï¼‰å’Œåˆ›å»ºä½œç”¨åŸŸå¯¼è‡´å†…å­˜åŠ `CPU` é£™é«˜ï¼Œå¯ä½¿ç”¨ **ç±»å…¨å±€ä½œç”¨åŸŸ** å’Œæ‰€æœ‰æœåŠ¡éƒ½é‡‡å–å•ä¾‹çš„æ–¹å¼ï¼š

```cs showLineNumbers {1,3,8-9,14,20-23}
public class DatabaseLoggingWriter : IDatabaseLoggingWriter, IDisposable
{
    private readonly IServiceScope _serviceScope;
    private readonly IRepository<LogTable> _logRepository;  // å¯æ›¿æ¢æˆä»»ä½•æ•°æ®åº“æ“ä½œåº“

    public DatabaseLoggingWriter(IServiceScopeFactory scopeFactory)
    {
        _serviceScope = scopeFactory.CreateScope();
        _logRepository = _serviceScope.ServiceProvider.GetRequiredService<IRepository<LogTable>>();
    }

    public void Write(LogMessage logMsg, bool flush)
    {
        _logRepository.Insert(.....);
    }

    /// <summary>
    /// é‡Šæ”¾æœåŠ¡ä½œç”¨åŸŸ
    /// </summary>
    public void Dispose()
    {
        _serviceScope.Dispose();
    }
}
```

### 18.7.9 å…³äºæ•°æ®åº“æ—¥å¿—å¾ªç¯è¾“å‡ºæ—¥å¿—

å¾®è½¯æä¾›çš„ `EFCore` æˆ–è€…ç¬¬ä¸‰æ–¹ `ORM` æœ¬èº«æ“ä½œæ•°æ®åº“æ—¶è‡ªå¸¦æ—¥å¿—è¾“å‡ºï¼Œè¿™å°±ä¼šå¯¼è‡´ `IDatabaseLoggingWriter` çš„ `Write` æ­»å¾ªç¯ï¼Œè§£å†³è¿™ä¸ªé—®é¢˜æœ‰ä»¥ä¸‹æ–¹æ³•ï¼š

1. åˆ›å»ºæ–°çš„æ•°æ®åº“æ“ä½œå®ä¾‹å¹¶å…³é—­æ—¥å¿—
2. æ›´æ–°åˆ° `Furion 4.7.0+` ç‰ˆæœ¬ **ï¼ˆæ¨èï¼‰**
3. è‡ªè¡Œæ ¹æ®ä¸šåŠ¡é€»è¾‘è¿‡æ»¤

**å¦‚ä¸å­˜åœ¨è¯¥é—®é¢˜å¯å…³é—­æ¡†æ¶è‡ªå¸¦æ­»å¾ªç¯æ£€æµ‹åŠŸèƒ½ï¼ˆå¯¹æ€§èƒ½æœ‰æå‡ä½œç”¨ï¼‰**ï¼š

```cs showLineNumbers {3}
services.AddDatabaseLogging<DatabaseLoggingWriter>(options =>
{
    options.IgnoreReferenceLoop = false;
});
```

## 18.8 æ·»åŠ æ—¥å¿—æä¾›å™¨æ–¹å¼

æ¡†æ¶æä¾›äº†å¤šç§æ·»åŠ æ—¥å¿—æä¾›å™¨æ–¹å¼ï¼Œå¯åœ¨åº”ç”¨å¯åŠ¨æˆ–è¿è¡Œæ—¶ã€‚

### 18.8.1 `LoggerFactory` æ–¹å¼

`Furion` ä¹Ÿæä¾›äº†è¿è¡Œæ—¶åŠ¨æ€æ·»åŠ æ—¥å¿—æä¾›å™¨å¹¶å†™å…¥ï¼š

```cs showLineNumbers  {1,3-4,8-12,23-26}
public class SomeController : IDynamicApiController, IDisposable
{
    private readonly ILoggerFactory _loggerFactory;
    private readonly ILogger _logger;

    public SomeController()
    {
        _loggerFactory = LoggerFactory.Create(builder =>
        {
            builder.AddFile("application.log");
        });
        _logger = _loggerFactory.CreateLogger("MyCategory");

        // å¯ä»¥å¤šä¸ªé‡å¤ä¸Šé¢ä»£ç 
    }

    [HttpGet]
    public void SomeAction()
    {
        _logger.LogInformation("some log...");
    }

    public void Dispose()
    {
        _loggerFactory.Dispose();
    }
}
```

:::warning ç‰¹åˆ«æ³¨æ„

é€šè¿‡è¿è¡Œæ—¶çš„æ–¹å¼éœ€è¦è‡ªè¡Œé‡Šæ”¾ `ILoggerFactory` å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯éœ€è¦å®ç° `IDisposable` æ¥å£ï¼Œç„¶åè¿›è¡Œ `_loggerFactory` é‡Šæ”¾ã€‚

å¯æŸ¥çœ‹ç›¸å…³ `Issue`ï¼š[https://gitee.com/dotnetchina/Furion/issues/I7KJ5H](https://gitee.com/dotnetchina/Furion/issues/I7KJ5H)

:::

### 18.8.2 `ILoggingBuilder` æ–¹å¼

`Furion` ä¹Ÿæä¾›äº†åŸç”Ÿ `services.AddLogging(builder => {})` æ–¹å¼é…ç½®ï¼Œå¦‚

```cs showLineNumbers {1,3,5}
services.AddLogging(builder =>
{
	builder.AddFile("applicaion.log");

    builder.AddDatabase<DatabaseLoggingWriter>();

    //....
});
```

## 18.9 è®°å½•è¯·æ±‚æ—¥å¿—

åœ¨ `ASP.NET 6` ä¸­ï¼Œæ¡†æ¶é»˜è®¤æä¾›äº† `app.UseHttpLogging()` è®°å½• `HTTP` è¯·æ±‚æ—¥å¿—åŠŸèƒ½ï¼Œè¯¦ç»†äº†è§£å¯æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ [ASP.NET Core - HTTP æ—¥å¿—è®°å½•](https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/http-logging/?view=aspnetcore-6.0)

å½“ç„¶ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ä¸­é—´ä»¶çš„æ–¹å¼å†™ï¼Œåªéœ€è¦æ³¨å…¥ `ILogger<>` æ¥å£å³å¯ã€‚

## 18.10 `Debug` å’Œ `Trace` é»˜è®¤ä¸è¾“å‡ºé—®é¢˜

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¾®è½¯åœ¨ `appsettings.json` å’Œ `appsettings.Development.json` ä¸­é…ç½®äº† `Default` æ—¥å¿—çº§åˆ«ï¼Œå¦‚éœ€è‡ªå®šä¹‰ï¼š

```json showLineNumbers {4}
{
  "Logging": {
    "LogLevel": {
      "Default": "Information"
    }
  }
}
```

è¿™æ—¶å€™åªéœ€è¦ä¿®æ”¹ `Default` ä¸º `Debug` æˆ– `Trace` å³å¯ï¼Œ**æ³¨æ„ä¸åŒç¯å¢ƒåŠ è½½ä¸åŒçš„é…ç½®æ–‡ä»¶ã€‚å¼€å‘ç¯å¢ƒåº”ä¿®æ”¹ `appsettings.Development.json` ä¸‹çš„é…ç½®ã€‚**

## 18.11 `[LoggingMonitor]` ç›‘å¬æ—¥å¿—

åœ¨ `Furion 3.9.1` ç‰ˆæœ¬æ–°å¢äº† `[LoggingMonitor]` ç‰¹æ€§ï¼Œæ”¯æŒåœ¨æ§åˆ¶å™¨æˆ–æ“ä½œä¸­è´´è¯¥ç‰¹æ€§ï¼Œå¯ä»¥å®ç°å¼ºå¤§çš„è¯·æ±‚æ—¥å¿—ç›‘å¬ï¼Œæ–¹ä¾¿æµ‹è¯•ï¼Œå¦‚ï¼š

### 18.11.1 ç‰¹æ€§é…ç½®

```cs showLineNumbers {1,7}
using Furion.Logging;

namespace Furion.Application;

public class TestLoggerServices : IDynamicApiController
{
    [LoggingMonitor]
    public PersonDto GetPerson(int id)
    {
        return new PersonDto
        {
            Id = id
        };
    }
}
```

- `[LoggingMonitor]` æ”¯æŒä»¥ä¸‹é…ç½®ï¼š
  - `Title`ï¼šé…ç½®æ ‡é¢˜ï¼Œ`string` ç±»å‹ï¼Œé»˜è®¤ `Logging Monitor`
  - `WithReturnValue`ï¼šæ˜¯å¦åŒ…å«è¿”å›å€¼æ‰“å°ï¼Œ`bool` ç±»å‹ï¼Œé»˜è®¤ `true`ï¼Œ`Furion 4.3.9+ æœ‰æ•ˆ`
  - `ReturnValueThreshold`ï¼šé…ç½®è¿”å›å€¼å­—ç¬¦ä¸²é˜ˆå€¼ï¼Œ`int` ç±»å‹ï¼Œé»˜è®¤ `0` å…¨é‡è¾“å‡ºï¼Œ`Furion 4.3.9+ æœ‰æ•ˆ`
  - `JsonBehavior`ï¼šé…ç½® `LoggingMonitor` `Json` è¾“å‡ºè¡Œä¸ºï¼Œé»˜è®¤ `None`ï¼Œ`Furion 4.5.2+` æœ‰æ•ˆ
  - `JsonIndented`ï¼šé…ç½® `LoggingMonitor` `Json` æ ¼å¼åŒ–è¡Œä¸ºï¼Œ`bool` ç±»å‹ï¼Œé»˜è®¤ `false`ï¼Œ`Furion 4.8.0+` æœ‰æ•ˆ

è¾“å‡ºæ—¥å¿—ä¸ºï¼š

```bash showLineNumbers
â”â”â”â”â”â”â”â”â”â”â”â”  Logging Monitor â”â”â”â”â”â”â”â”â”â”â”
â”£ Furion.Application.TestLoggerServices.GetPerson (Furion.Application)
â”£
â”£ æ§åˆ¶å™¨åç§°ï¼š              TestLoggerServices
â”£ æ“ä½œåç§°ï¼š                GetPerson
â”£ è·¯ç”±ä¿¡æ¯ï¼š                [area]: ; [controller]: test-logger; [action]: person
â”£ è¯·æ±‚æ–¹å¼ï¼š                POST
â”£ è¯·æ±‚åœ°å€ï¼š                https://localhost:44316/api/test-logger/person/11
â”£ æ¥æºåœ°å€ï¼š                https://localhost:44316/api/index.html
â”£ æµè§ˆå™¨æ ‡è¯†ï¼š              Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.114 Safari/537.36 Edg/103.0.1264.62
â”£ å®¢æˆ·ç«¯ IP åœ°å€ï¼š          0.0.0.1
â”£ æœåŠ¡ç«¯ IP åœ°å€ï¼š          0.0.0.1
â”£ æœåŠ¡ç«¯è¿è¡Œç¯å¢ƒï¼š          Development
â”£ æ‰§è¡Œè€—æ—¶ï¼š                31ms
â”£ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  æˆæƒä¿¡æ¯ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â”£ JWT Tokenï¼š               Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJVc2VySWQiOjEsIkFjY291bnQiOiJhZG1pbiIsImlhdCI6MTY1ODcxNjc5NywibmJmIjoxNjU4NzE2Nzk3LCJleHAiOjE2NTg3MTc5OTcsImlzcyI6ImRvdG5ldGNoaW5hIiwiYXVkIjoicG93ZXJieSBGdXJpb24ifQ.VYZkwwqCwlUy3aJjuL-og62I0rkxNQ96kSjEm3VgXtg
â”£
â”£ UserId (integer)ï¼š        1
â”£ Account (string)ï¼š        admin
â”£ iat (integer)ï¼š           1658716797
â”£ nbf (integer)ï¼š           1658716797
â”£ exp (integer)ï¼š           1658717997
â”£ iss (string)ï¼š            dotnetchina
â”£ aud (string)ï¼š            powerby Furion
â”£ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  å‚æ•°åˆ—è¡¨ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â”£ Content-Typeï¼š
â”£
â”£ id (Int32)ï¼š              11
â”£ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  è¿”å›ä¿¡æ¯ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â”£ ç±»å‹ï¼š                    Furion.Application.Persons.PersonDto
â”£ è¿”å›å€¼ï¼š                  {"Id":11,"Name":null,"Age":0,"Address":null,"PhoneNumber":null,"QQ":null,"CreatedTime":"0001-01-01T00:00:00+00:00","Childrens":null,"Posts":null}
â”—â”â”â”â”â”â”â”â”â”â”â”  Logging Monitor â”â”â”â”â”â”â”â”â”â”â”
```

### 18.11.2 å…¨å±€é…ç½®

å¦‚éœ€å…¨å±€å¯ç”¨ `LoggingMonitor` åŠŸèƒ½ï¼Œæ— éœ€åœ¨æ¯ä¸ªæ§åˆ¶å™¨æˆ–è€…æ–¹æ³•ä¸­è´´ï¼Œå…¨å±€æ³¨å†Œå¦‚ä¸‹ï¼š

```cs showLineNumbers
// è¯·ä½¿ç”¨ services.AddMonitorLogging(); æ›¿ä»£ï¼Œå¹¶å¯ç”¨ GlobalEnabled: true
services.AddMvcFilter<LoggingMonitorAttribute>();
```

:::tip `Furion 4.0.2` æ–°æ¨èé…ç½®

åœ¨ `Furion 4.0.2` ç‰ˆæœ¬ä¸­æ–°å¢äº†éå¸¸çµæ´»æ–¹ä¾¿çš„ `services.AddMonitorLogging()` æœåŠ¡é…ç½®ï¼Œå¯åœ¨é…ç½®ä¸­éšæ„æ§åˆ¶å“ªä¸ªç±»å“ªä¸ªæ–¹æ³•å¯ç”¨æˆ–ä¸å¯ç”¨ã€‚

- æ³¨å†ŒæœåŠ¡

```cs showLineNumbers
services.AddMonitorLogging();   // é»˜è®¤è¯»å– Logging:Monitor ä¸‹é…ç½®ï¼Œæ”¯æŒä¼ å…¥å‚æ•°è‡ªå®šä¹‰
```

- æ·»åŠ é…ç½®

```json showLineNumbers {2,3,4-6}
{
  "Logging": {
    "Monitor": {
      "GlobalEnabled": false, // æ˜¯å¦å¯ç”¨å…¨å±€æ‹¦æˆªï¼Œé»˜è®¤ `false`
      "IncludeOfMethods": [], // æ˜¯å¦æŒ‡å®šæ‹¦æˆªç‰¹å®šæ–¹æ³•ï¼Œå½“ GlobalEnabled: false æœ‰æ•ˆ
      "ExcludeOfMethods": [], // æ˜¯å¦æŒ‡å®šæ’é™¤ç‰¹å®šæ–¹æ³•ï¼Œå½“ GlobalEnabled: true æœ‰æ•ˆ
      "LogLevel": "Information", // é…ç½®ç›‘å¬æ—¥å¿—è¾“å‡ºçº§åˆ«ï¼Œé»˜è®¤ Information
      "BahLogLevel": "Information", // é…ç½® Oops.Oh å’Œ Oops.Bah ä¸šåŠ¡æ—¥å¿—è¾“å‡ºçº§åˆ«ï¼Œé»˜è®¤ Information
      "WithReturnValue": true, // é…ç½®æ˜¯å¦åŒ…å«è¿”å›å€¼ï¼Œé»˜è®¤ `true`ï¼ŒFurion 4.3.9+ æœ‰æ•ˆ
      "ReturnValueThreshold": 0, // é…ç½®è¿”å›å€¼å­—ç¬¦ä¸²é˜ˆå€¼ï¼Œé»˜è®¤ 0ï¼Œå…¨é‡è¾“å‡ºï¼ŒFurion 4.3.9+ æœ‰æ•ˆ
      "JsonBehavior": "None", // é…ç½® LoggingMonitor Json è¾“å‡ºè¡Œä¸ºï¼Œé»˜è®¤ Noneï¼ŒFurion 4.5.2+ æœ‰æ•ˆ
      "JsonIndented": false, // é…ç½® LoggingMonitor Json æ ¼å¼åŒ–è¡Œä¸ºï¼Œé»˜è®¤ falseï¼ŒFurion 4.8.2+ æœ‰æ•ˆ
      "ContractResolver": "CamelCase", // é…ç½® LoggingMonitor åºåˆ—åŒ–å±æ€§å‘½åè§„åˆ™ï¼Œé»˜è®¤ CamelCaseï¼ŒFurion 4.8.6.12+ æœ‰æ•ˆ
      "MethodsSettings": [
        // é…ç½®è¢«ç›‘è§†æ–¹æ³•æ›´å¤šä¿¡æ¯ï¼ŒFurion 4.3.9+ æœ‰æ•ˆ
        {
          "FullName": "Furion.Application.TestLoggerServices.MethodName", // æ–¹æ³•å®Œå…¨é™å®šå
          "WithReturnValue": true, // é…ç½®æ˜¯å¦åŒ…å«è¿”å›å€¼ï¼Œé»˜è®¤ `true`ï¼ŒFurion 4.3.9+ æœ‰æ•ˆ
          "ReturnValueThreshold": 0, // é…ç½®è¿”å›å€¼å­—ç¬¦ä¸²é˜ˆå€¼ï¼Œé»˜è®¤ 0ï¼Œå…¨é‡è¾“å‡ºï¼ŒFurion 4.3.9+ æœ‰æ•ˆ
          "JsonIndented": false, // é…ç½® LoggingMonitor Json æ ¼å¼åŒ–è¡Œä¸ºï¼Œé»˜è®¤ falseï¼ŒFurion 4.8.2+ æœ‰æ•ˆ
          "JsonBehavior": "None", // é…ç½® LoggingMonitor Json è¾“å‡ºè¡Œä¸ºï¼Œé»˜è®¤ Noneï¼ŒFurion 4.5.2+ æœ‰æ•ˆ
          "ContractResolver": "CamelCase" // é…ç½® LoggingMonitor åºåˆ—åŒ–å±æ€§å‘½åè§„åˆ™ï¼Œé»˜è®¤ CamelCaseï¼ŒFurion 4.8.6.12+ æœ‰æ•ˆ
        }
      ]
    }
  }
}
```

`IncludeOfMethods` å’Œ `ExcludeOfMethods` æ–¹æ³•ç­¾åæ ¼å¼ä¸ºï¼š`ç±»å®Œå…¨é™å®šå.æ–¹æ³•å`ï¼Œå¦‚ï¼š`Furion.Application.TestNamedServices.GetName`ï¼Œ`Furion.Application.TestNamedServices` æ˜¯ç±»åï¼Œ`GetName` æ˜¯æ–¹æ³•åã€‚

:::

å¦‚æœé…ç½®äº†å…¨å±€è¯·æ±‚ç›‘è§†æ—¥å¿—ï¼Œå¯¹ä¸ªåˆ«ä¸éœ€è¦ç›‘è§†çš„æ¥å£æ–¹æ³•åªéœ€è¦è´´ `[SuppressMonitor]` ç‰¹æ€§å³å¯ã€‚

### 18.11.3 æ›´å¤šé…ç½®

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.3.9 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

æ”¯æŒ `LoggingMonitor` å†™å…¥æ—¥å¿—æ‹¦æˆªï¼Œå¦‚æ·»åŠ é¢å¤–æ•°æ®ï¼š

```cs showLineNumbers {1,3,6}
services.AddMonitorLogging(options =>
{
    options.ConfigureLogger((logger, logContext, context) =>
    {
        var httpContext = context.HttpContext;
        logContext.Set("extra", "å…¶ä»–æ•°æ®");
    });
});
```

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æ”¯æŒé…ç½® `json` è·¯å¾„ï¼š

```cs showLineNumbers
services.AddMonitorLogging(jsonKey: "YourKey:Monitor");
```

### 18.11.4 `JSON` æ ¼å¼

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.5.2 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

1. å…¨å±€/å±€éƒ¨å¯ç”¨ `Json` è¾“å‡ºé…ç½®

```cs showLineNumbers {4,9}
// å…¨å±€
services.AddMonitorLogging(options =>
{
    options.JsonBehavior = Furion.Logging.JsonBehavior.OnlyJson;
    options.JsonIndented = true;    // æ˜¯å¦ç¾åŒ– JSONï¼ŒFurion 4.8.0+ ç‰ˆæœ¬æœ‰æ•ˆ
});

// å±€éƒ¨
[LoggingMonitor(JsonBehavior = Furion.Logging.JsonBehavior.OnlyJson)]
// æ˜¯å¦ç¾åŒ– JSONï¼ŒFurion 4.8.0+ ç‰ˆæœ¬æœ‰æ•ˆ
[LoggingMonitor(JsonBehavior = Furion.Logging.JsonBehavior.OnlyJson, JsonIndented = true)]
```

:::note å…³äº `JsonBehavior`

åªæœ‰è®¾ç½®ä¸º `JsonBehavior.OnlyJson` æ—¶æ‰ä¸ä¼šè¾“å‡º**ç¾è§‚çš„**æ—¥å¿—ã€‚

:::

2. å†™å…¥å­˜å‚¨ä»‹è´¨

```cs showLineNumbers {14-18}
using Furion.Logging;

namespace YourProject.Core;

public class DatabaseLoggingWriter : IDatabaseLoggingWriter
{
    // æ”¯æŒæ„é€ å‡½æ•°æ³¨å…¥ä»»ä½•å®ä¾‹ï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾ä»»ä½•æœåŠ¡ï¼Œæ¯”å¦‚æ³¨å…¥ IRepositoryï¼Œæˆ–è€… SqlSugarClient
    public DatabaseLoggingWriter()
    {
    }

    public void Write(LogMessage logMsg, bool flush)
    {
        // å¦‚æœ JsonBehavior é…ç½®ä¸º OnlyJson æˆ–è€… Allï¼Œé‚£ä¹ˆ Context å°±åŒ…å« loggingMonitor çš„å€¼
        // å¦‚æœ JsonBehavior é…ç½®ä¸º OnlyJsonï¼Œé‚£ä¹ˆå¯ç›´æ¥é€šè¿‡ logMsg.Message è·å–ç»“æœå°±æ˜¯ json æ ¼å¼
        if (logMsg.LogName == "System.Logging.LoggingMonitor")
        {
            var jsonString = logMsg.Context.Get("loggingMonitor");
        }

        // è¿™é‡Œå†™ä½ ä»»ä½•æ’å…¥æ•°æ®åº“çš„æ“ä½œï¼Œæ— éœ€ try catch
    }
}
```

`Json` è¾“å‡ºæ ¼å¼å¦‚ä¸‹ï¼š

```json showLineNumbers
{
  "controllerName": "test-logger",
  "controllerTypeName": "TestLoggerServices",
  "actionName": "person",
  "actionTypeName": "GetPerson",
  "areaName": null,
  "displayName": "Furion.Application.TestLoggerServices.GetPerson (Furion.Application)",
  "localIPv4": "0.0.0.1",
  "remoteIPv4": "0.0.0.1",
  "httpMethod": "GET",
  "requestUrl": "https://localhost:5001/api/test-logger/person/2",
  "refererUrl": "https://localhost:5001/api/index.html?urls.primaryName=æ•°æ®åº“æ“ä½œæ¼”ç¤º",
  "environment": "Development",
  "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.0.0 Safari/537.36 Edg/105.0.1343.53",
  "requestHeaderAuthorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJVc2VySWQiOjEsIkFjY291bnQiOiJhZG1pbiIsImlhdCI6MTY2NDQ1MDUwNSwibmJmIjoxNjY0NDUwNTA1LCJleHAiOjE2NjQ0NTE3MDUsImlzcyI6ImRvdG5ldGNoaW5hIiwiYXVkIjoicG93ZXJieSBGdXJpb24ifQ.-xocNcDQGoXClceoVU5QAHIkTcOZ7ZXo0hEbzghDfFI",
  "timeOperationElapsedMilliseconds": 55,
  "authorizationClaims": [
    {
      "type": "UserId",
      "valueType": "integer",
      "value": "1"
    },
    {
      "type": "Account",
      "valueType": "string",
      "value": "admin"
    },
    {
      "type": "iat",
      "valueType": "integer",
      "value": "1664450505"
    },
    {
      "type": "nbf",
      "valueType": "integer",
      "value": "1664450505"
    },
    {
      "type": "exp",
      "valueType": "integer",
      "value": "1664451705"
    },
    {
      "type": "iss",
      "valueType": "string",
      "value": "dotnetchina"
    },
    {
      "type": "aud",
      "valueType": "string",
      "value": "powerby Furion"
    }
  ],
  "parameters": [
    {
      "name": "id",
      "type": "System.Int32",
      "value": 2
    }
  ],
  "returnInformation": {
    "type": "Furion.UnifyResult.RESTfulResult`1[[System.Object, System.Private.CoreLib, Version=6.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]",
    "actType": "Furion.Application.Persons.PersonDto",
    "value": {
      "StatusCode": 200,
      "Data": {
        "Id": 2,
        "Name": null,
        "Age": 0,
        "Address": null,
        "PhoneNumber": null,
        "QQ": null,
        "CreatedTime": "0001-01-01T00:00:00+00:00",
        "Childrens": null,
        "Posts": null
      },
      "Succeeded": true,
      "Errors": null,
      "Extras": null,
      "Timestamp": 1664450517341
    }
  },
  "exception": {
    "type": "System.DivideByZeroException",
    "message": "Attempted to divide by zero.",
    "stackTrace": "   at Furion.Application.TestLoggerServices.æµ‹è¯•æ—¥å¿—ç›‘å¬8(Int32 id) in D:\\Workplaces\\OpenSources\\Furion\\samples\\Furion.Application\\TestLoggerServices.cs:line 78\r\n   at lambda_method103(Closure , Object , Object[] )\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ActionMethodExecutor.SyncObjectResultExecutor.Execute(IActionResultTypeMapper mapper, ObjectMethodExecutor executor, Object controller, Object[] arguments)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.<InvokeActionMethodAsync>g__Logged|12_1(ControllerActionInvoker invoker)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.<InvokeNextActionFilterAsync>g__Awaited|10_0(ControllerActionInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)"
  },
  "validation": {
    "errorCode": null,
    "originErrorCode": null,
    "message": "å‡ºé”™äº†å•Šã€‚ã€‚ã€‚ã€‚"
  }
}
```

### 18.11.5 å…¨å±€è¿‡æ»¤ `WriteFilter`

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.5.9 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

åœ¨ `Furion 4.5.9+` ç‰ˆæœ¬æ–°å¢äº† `WriteFilter` è¿‡æ»¤åŠŸèƒ½ï¼Œå¯æ ¹æ®è‡ªå®šä¹‰é€»è¾‘è‡ªå®šä¹‰è¿‡æ»¤æ‹¦æˆªï¼š

```cs showLineNumbers showLineNumbers {1,3,10}
services.AddMonitorLogging(options =>
{
    options.WriteFilter = (context) =>
    {
        // è·å–æ§åˆ¶å™¨/æ“ä½œæè¿°å™¨
        var controllerActionDescriptor = context.ActionDescriptor as ControllerActionDescriptor;

        // ä½ çš„é€»è¾‘....ï¼Œéœ€è¦æ‹¦æˆªè¿”å› falseï¼Œå¦åˆ™ true

        return true;
    };
});
```

### 18.11.6 è¾“å‡º `JSON` æ”¯æŒå¿½ç•¥å±æ€§åæˆ–å±æ€§ç±»å‹

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.6.1 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

æœ‰æ—¶æ¥å£çš„è¿”å›å€¼åŒ…å«ä¸èƒ½è¢«åºåˆ—åŒ–çš„ç±»å‹æˆ–è€…æƒ³å¿½ç•¥æŸäº›å±æ€§åä¸è¢«åºåˆ—åŒ–ï¼Œè¿™æ—¶å€™å°±éœ€è¦ç”¨åˆ°è¿™ä¸ªã€‚

- **å±€éƒ¨é…ç½®**

```cs showLineNumbers {3,4,10}
// å¿½ç•¥åç§°å’Œå±æ€§ï¼Œæ”¯æŒå•ä¸€é…ç½®æˆ–å±€éƒ¨é…ç½®
[LoggingMonitor(JsonBehavior = JsonBehavior.OnlyJson
    , IgnorePropertyNames = new[] { "Bytes" }
    , IgnorePropertyTypes = new[] { typeof(byte[]) })]
public object MethodName(int id)
{
    return new
    {
        Id = 10,
        Bytes = File.ReadAllBytes("image.png")
    };
}
```

- **å…¨å±€é…ç½®**

```cs showLineNumbers {4-5}
// å¿½ç•¥åç§°å’Œå±æ€§ï¼Œæ”¯æŒå•ä¸€é…ç½®æˆ–å±€éƒ¨é…ç½®
services.AddMonitorLogging(options =>
{
    options.IgnorePropertyNames = new[] { "Byte" };
    options.IgnorePropertyTypes = new[] { typeof(byte[]) };
});
```

<img src={useBaseUrl("img/hl1.png")} />

### 18.11.7 å°† `LoggingMonitor` å†™å…¥æ•°æ®åº“

1. æ³¨å†Œ `.AddDatabaseLogging<>` æœåŠ¡ï¼š

```cs showLineNumbers {1,3,5}
services.AddDatabaseLogging<DatabaseLoggingWriter>(options =>
{
    options.WriteFilter = (logMsg) =>
    {
        return logMsg.LogName == "System.Logging.LoggingMonitor";
    };
});
```

2. å†™å…¥æ•°æ®åº“

```cs showLineNumbers {1,5,8,12}
using Furion.Logging;

namespace YourProject.Core;

public class DatabaseLoggingWriter : IDatabaseLoggingWriter
{
    // ä»»ä½•æ•°æ®åº“ ORM æ³¨å…¥ã€‚ã€‚ã€‚
    public DatabaseLoggingWriter()
    {
    }

    public void Write(LogMessage logMsg, bool flush)
    {
        // å°† logMsg çš„å±æ€§ä¸€ä¸€æ’å…¥åˆ°æ•°æ®åº“ä¸­~
    }
}
```

:::tip å•ä¸ª `DatabaseLoggingWriter` æƒ…å†µ

å¦‚æœå·²ç»å…¨å±€æ³¨å†Œäº†ï¼š

```cs showLineNumbers
services.AddDatabaseLogging<DatabaseLoggingWriter>();   // æ³¨æ„è¿™é‡Œæ²¡æœ‰è¿‡æ»¤ logName
```

ä¸”ä¸æƒ³å¤šæ³¨å†Œä¸€ä¸ªæ•°æ®åº“æ—¥å¿—æœåŠ¡ï¼Œé‚£ä¹ˆåªéœ€è¦åœ¨ä»£ç ä¸­è¿‡æ»¤å³å¯ï¼š

```cs showLineNumbers {1,5,8,12,15}
using Furion.Logging;

namespace YourProject.Core;

public class DatabaseLoggingWriter : IDatabaseLoggingWriter
{
    // ä»»ä½•æ•°æ®åº“ ORM æ³¨å…¥ã€‚ã€‚ã€‚
    public DatabaseLoggingWriter()
    {
    }

    public void Write(LogMessage logMsg, bool flush)
    {
        // å°† logMsg çš„å±æ€§ä¸€ä¸€æ’å…¥åˆ°æ•°æ®åº“ä¸­~
        if(logMsg.LogName == "System.Logging.LoggingMonitor")
        {
            // å†™å…¥å®¡è®¡è¡¨æ•°æ®åº“
        }
        else
        {
            // å†™å…¥å…¶ä»–è¡¨æ•°æ®åº“
        }
    }
}
```

:::

### 18.11.8 æ”¯æŒ `[DisplayName]` ç‰¹æ€§

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.5.10 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

é€šå¸¸æˆ‘ä»¬ä¼šä¸ºæ¯ä¸€ä¸ªæ¥å£æ·»åŠ ä¸€ä¸ªå”¯ä¸€åç§°ï¼Œæ¯”å¦‚ä½¿ç”¨ `[DisplayName]` ç‰¹æ€§ï¼Œæ–¹ä¾¿åç»­å†™å…¥æ—¥å¿—è¿›è¡Œå½’ç±»ã€‚

```cs showLineNumbers {4}
public class TestService: IDynamicApiController
{
    [LoggingMonitor]
    [DisplayName("æµ‹è¯•æ–¹æ³•")]
    public void TestMethod()
    {
    }
}
```

é‚£ä¹ˆå¦‚æœè¾“å‡ºä¸º `JSON` æ ¼å¼æ—¥å¿—å°†ä¼šè‡ªåŠ¨æ·»åŠ  `displayTitle` é”®ï¼Œå€¼ä¸º `æµ‹è¯•æ–¹æ³•`ã€‚

### 18.11.9 è¾“å‡ºåºåˆ—åŒ–é”®æ ¼å¼é…ç½®ï¼ˆå±æ€§å¤§å°å†™ï¼‰

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.6.12 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

è¯¥åŠŸèƒ½ä¸»è¦é…ç½®åºåˆ—åŒ–æ—¶å±æ€§åè¾“å‡ºè§„åˆ™ï¼Œ**æ³¨æ„æ­¤é¡¹å¹¶ä¸é…ç½® `JSON` è¾“å‡ºè§„åˆ™ã€‚**

- **å±€éƒ¨é…ç½®**

```cs showLineNumbers {1}
[LoggingMonitor(ContractResolver = ContractResolverTypes.Default)]    // CamelCase æˆ–è€… Defaultï¼Œé»˜è®¤æ˜¯ CamelCase
public DataTable MethodName()
{
    var d = "select * from person".SqlQuery();
    return d;
}
```

- **å…¨å±€é…ç½®**

```cs showLineNumbers {3}
services.AddMonitorLogging(options =>
{
    options.ContractResolver = ContractResolverTypes.Default;   // CamelCase æˆ–è€… Defaultï¼Œé»˜è®¤æ˜¯ CamelCase
});
```

### 18.11.10 è·³è¿‡ç‰¹å®šå‚æ•°è®°å½•

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.7.3 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

åœ¨ `Furion 4.8.7.3+` ç‰ˆæœ¬æ–°å¢ `[SuppressMonitor]` ç‰¹æ€§æ”¯æŒæ ‡è®°å‚æ•°ï¼ˆæ”¯æŒç±»å‹ï¼Œæ–¹æ³•ï¼‰ä¸è¢«è®°å½•ï¼Œå¦‚ï¼š

```cs showLineNumbers {2}
[LoggingMonitor]
public string GetName([SuppressMonitor]SomeType type, int id)   // type å‚æ•°å°†è·³è¿‡è®°å½•
{
    return nameof(Furion);
}
```

## 18.12 æ‰“å°æ—¥å¿—åˆ° `Swagger` ä¸­

åœ¨ `Furion` æ¡†æ¶ä¸­é»˜è®¤é›†æˆäº† `MiniProfiler` ç»„ä»¶å¹¶ä¸ `Swagger` è¿›è¡Œäº†ç»“åˆï¼Œå¦‚éœ€æ‰“å°æ—¥å¿—æˆ–è°ƒè¯•ä»£ç ï¼Œåªéœ€è°ƒç”¨ä»¥ä¸‹æ–¹æ³•å³å¯ï¼š

```cs showLineNumbers
App.PrintToMiniProfiler("åˆ†ç±»", "çŠ¶æ€", "è¦æ‰“å°çš„æ¶ˆæ¯");
```

## 18.13 é™æ€ `Default()` æ–¹å¼æ„å»º

```cs showLineNumbers
StringLoggingPart.Default().SetMessage("è¿™æ˜¯ä¸€ä¸ªæ—¥å¿—").LogInformation();
```

## 18.14 è§„èŒƒæ—¥å¿—æ¨¡æ¿

åœ¨ `Furion v3.5.3+` æ–°å¢äº† `TP.Wrapper(...)` è§„èŒƒæ¨¡æ¿ï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š

```cs showLineNumbers {2}
// ç”Ÿæˆæ¨¡æ¿å­—ç¬¦ä¸²
var template = TP.Wrapper("Furion æ¡†æ¶", "è®© .NET å¼€å‘æ›´ç®€å•ï¼Œæ›´é€šç”¨ï¼Œæ›´æµè¡Œã€‚",
    "##ä½œè€…## ç™¾å°åƒ§",
    "##å½“å‰ç‰ˆæœ¬## v3.5.3",
    "##æ–‡æ¡£åœ°å€## http://furion.baiqian.ltd",
    "##Copyright## ç™¾å°åƒ§, ç™¾ç­¾ç§‘æŠ€ï¼ˆå¹¿ä¸œï¼‰æœ‰é™å…¬å¸");

Console.WriteLine(template);
```

æ—¥å¿—æ‰“å°æ¨¡æ¿å¦‚ä¸‹ï¼š

```bash showLineNumbers
â”â”â”â”â”â”â”â”â”â”â”â”  Furion æ¡†æ¶ â”â”â”â”â”â”â”â”â”â”â”
â”£ è®© .NET å¼€å‘æ›´ç®€å•ï¼Œæ›´é€šç”¨ï¼Œæ›´æµè¡Œã€‚
â”£
â”£ ä½œè€…ï¼š        ç™¾å°åƒ§
â”£ å½“å‰ç‰ˆæœ¬ï¼š     v3.5.3
â”£ æ–‡æ¡£åœ°å€ï¼š     http://furion.baiqian.ltd
â”£ Copyrightï¼š   ç™¾å°åƒ§, ç™¾ç­¾ç§‘æŠ€ï¼ˆå¹¿ä¸œï¼‰æœ‰é™å…¬å¸
â”—â”â”â”â”â”â”â”â”â”â”â”  Furion æ¡†æ¶ â”â”â”â”â”â”â”â”â”â”â”
```

:::tip å…³äºå±æ€§ç”Ÿæˆ

å¦‚æœåˆ—è¡¨é¡¹ä»¥ `##å±æ€§å##` å¼€å¤´ï¼Œè‡ªåŠ¨ç”Ÿæˆ `å±æ€§åï¼š` ä½œä¸ºè¡Œé¦–ä¸”è‡ªåŠ¨ç­‰å®½å¯¹é½ã€‚

`Furion 3.9.1` ä¹‹å‰ç‰ˆæœ¬ä½¿ç”¨ `[å±æ€§å]` å¼€å¤´ã€‚

:::

## 18.15 æ—¥å¿—ä¸Šä¸‹æ–‡

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.6.0 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

### 18.15.1 æ·»åŠ ä¸Šä¸‹æ–‡æ•°æ®

æœ‰æ—¶å€™æˆ‘ä»¬å¸Œæœ›ä¸ºæ—¥å¿—æä¾›é¢å¤–æ•°æ®ï¼Œè¿™æ—¶å€™å¯é€šè¿‡ `.ScopeContext()` é…ç½®ï¼Œå¦‚ï¼š

```cs showLineNumbers {2,8,15,21,25,28}
// å†™æ³•ä¸€
using (var scope = _logger.ScopeContext(ctx => ctx.Set("Name", "Furion").Set("UserId", 10)))
{
  _logger.LogInformation("æˆ‘æ˜¯ä¸€ä¸ªæ—¥å¿— {id}", 20);
}

// å†™æ³•äºŒ
using var scope = _logger.ScopeContext(new Dictionary<object, object> {
    { "Name", "Furion" },
    { "UserId", 10 }
});
_logger.LogInformation("æˆ‘æ˜¯ä¸€ä¸ªæ—¥å¿— {id}", 20);

// å†™æ³•ä¸‰
using var scope = _logger.ScopeContext(new LogContext {
    // ....
});
_logger.LogInformation("æˆ‘æ˜¯ä¸€ä¸ªæ—¥å¿— {id}", 20);

// å†™æ³•å››
var (logger, scoped) = Log.ScopeContext(new LogContext {
    // ...
});
logger.LogInformation("æˆ‘æ˜¯ä¸€ä¸ªæ—¥å¿— {id}", 20);
scoped?.Dispose();

// å†™æ³•äº”
"æˆ‘æ˜¯ä¸€ä¸ªæ—¥å¿— {id}".ScopeContext(new LogContext {
    // ...
}).LogInformation();
```

### 18.15.2 è¯»å–ä¸Šä¸‹æ–‡æ•°æ®

åœ¨ `LogMessage` å¯¹è±¡ä¸­ä½¿ç”¨ï¼š

```cs showLineNumbers {1,9,14,16}
var value = logMsg.Context.Get("Key");

// æ¯”å¦‚åœ¨è¿‡æ»¤ä¸­ä½¿ç”¨
services.AddFileLogging("infomation.log", options =>
{
    options.WriteFilter = (logMsg) =>
    {
        // è¿˜å¯ä»¥è®¾ç½®ç»™è¿è¡Œæ—¶ä½¿ç”¨ï¼šlogMsg.Context.Set(...);
        return logMsg.Context.Get("Name") == "Furion";
    };
});

// åœ¨  IDatabaseLoggingWriter ä¸­ä½¿ç”¨
public void Write(LogMessage logMsg, bool flush)
{
    var name = logMsg.Context.Get("Name");
}
```

### 18.15.3 æ—¥å¿—ä¸Šä¸‹æ–‡æ•°æ®å…±äº«

```cs showLineNumbers{1,4,11,25,33}
public TestAppService: ITestAppService, IDisposable
{
    private readonly ILogger<TestAppService> _logger;
    private IDisposable _scopeProvider;

    public TestAppService(ILogger<TestAppService> logger)
    {
        _logger = logger;

        // æ·»åŠ å…¨å±€ç”¨æˆ·ä¿¡æ¯ä¸Šä¸‹æ–‡æ•°æ®
        _scopeProvider = _logger.ScopeContext(ctx => ctx.Set("uid", "100").Set("uname", "ç™¾å°åƒ§"));
    }

    public string GetName(int id)
    {
        // å…±äº«å…¨å±€ä¸Šä¸‹æ–‡æ•°æ®
        _logger.LogInformation("å†™å…¥æ–°çš„æ—¥å¿—");

        return "Furion";
    }

    public string GetTags(int id)
    {
        // é¢å¤–æ–°å¢ä¸Šä¸‹æ–‡æ•°æ®
        using var scope = _logger.ScopeContext(ctx => ctx.Set("key", "value"));
        _logger.LogInformation("è®¾ç½®é¢å¤–çš„ä¸Šä¸Šä¸‹æ–‡æ—¥å¿—");

        return "ç™¾å°åƒ§";
    }

    public void Dispose()
    {
        _scopeProvider.Dispose();
    }
}
```

## 18.16 å…³é—­ `.NET Core` åº•å±‚æ—¥å¿—

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`.NET Core` åº•å±‚é»˜è®¤è¾“å‡ºäº†å¾ˆå¤šæ—¥å¿—ï¼Œå¦‚éœ€å…³é—­åªéœ€åœ¨ `appsettings.json` å’Œ `appsettings.Development.json` ä¸­æ·»åŠ  `"å‘½åç©ºé—´/æ—¥å¿—ç±»åˆ«":"æœ€ä½æ—¥å¿—çº§åˆ«"` æ—¥å¿—ç±»åˆ«è¿‡æ»¤å³å¯ï¼Œå¦‚ï¼š

```json showLineNumbers {2,7-8}
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Information",
      "System.Net.Http.HttpClient": "Warning",
      "å‘½åç©ºé—´/æ—¥å¿—ç±»åˆ«": "Warning"
    }
  }
}
```

å°æé†’ï¼šè¿‡æ»¤ `.NET Core` åº•å±‚æ—¥å¿—æœ€ä½æ—¥å¿—çº§åˆ«é€šå¸¸è®¾ç½®ä¸º `Warning`ã€‚

## 18.17 å…¨å±€æ—¥å¿—è¿‡æ»¤/ç­›é€‰

åœ¨ä¸€äº›ç‰¹å®šçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿå¯¹æ‰€æœ‰æ—¥å¿—è¾“å‡ºä»‹è´¨ä¸­çš„æ—¥å¿—è¿›è¡Œè¿‡æ»¤ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›è¡Œå…¨å±€é…ç½®ã€‚

:::caution ç‰¹åˆ«æ³¨æ„

æ­¤æ–¹å¼ä¼šå½±å“æ‰€æœ‰çš„æ—¥å¿—ä»‹è´¨è¾“å‡ºï¼Œå¦‚æ§åˆ¶å°ã€æ–‡ä»¶ã€æ•°æ®åº“ç­‰å…¶ä»–è¾“å‡ºä»‹è´¨ã€‚

:::

`.NET5` ç‰ˆæœ¬ï¼š

```cs showLineNumbers {1,2,4}
Host.CreateDefaultBuilder(args)
    .ConfigureLogging(logging =>
    {
        logging.AddFilter((provider, category, logLevel) =>
        {
            return !new[] { "Microsoft.Hosting", "Microsoft.AspNetCore" }.Any(u => category.StartsWith(u))
                && logLevel >= LogLevel.Information;
        });
    })
```

`.NET6+` ç‰ˆæœ¬ï¼š

```cs showLineNumbers {1,3}
var builder = WebApplication.CreateBuilder(args);

builder.Logging.AddFilter((provider, category, logLevel) =>
{
    return !new[] { "Microsoft.Hosting", "Microsoft.AspNetCore" }.Any(u => category.StartsWith(u))
        && logLevel >= LogLevel.Information;
});
```

æˆ–è€… `Serve.Run` æ–¹å¼

```cs showLineNumbers {1,3,7-10}
Serve.Run(RunOptions.Default.AddWebComponent<WebComponent>());

public class WebComponent : IWebComponent
{
    public void Load(WebApplicationBuilder builder, ComponentContext componentContext)
    {
        builder.Logging.AddFilter((provider, category, logLevel) =>
        {
            return !new[] { "Microsoft.Hosting", "Microsoft.AspNetCore" }.Any(u => category.StartsWith(u))
                && logLevel >= LogLevel.Information;
        });
    }
}
```

:::warning æ—¥å¿—è¿‡æ»¤æ— æ•ˆæƒ…å†µ

å‡å¦‚ä½¿ç”¨ä¸Šè¿°ä»£ç è¿‡æ»¤æ— æ•ˆï¼ˆä¸èƒ½è¿‡æ»¤é»˜è®¤çš„ä¸»æœºæ—¥å¿—ï¼‰ï¼Œé‚£ä¹ˆè¯·ç¡®è®¤ `appsettings.json` å’Œ `appsettings.Development.json` çš„ `Logging:Level` æ˜¯å¦å¦‚ä¸‹ï¼š

```json showLineNumbers {4-5}
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Information"
    }
  }
}
```

å¦‚æœé…ç½®äº†ä»¥ä¸‹é…ç½®ï¼Œ**è¯·åˆ é™¤**ï¼š

```json
"Microsoft": "Warning",
"Microsoft.Hosting.Lifetime": "Information",
```

:::

## 18.18 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::

---

:::note äº†è§£æ›´å¤š

æƒ³äº†è§£æ›´å¤š `æ—¥å¿—` çŸ¥è¯†å¯æŸ¥é˜… [ASP.NET Core - æ—¥å¿—](https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/logging/?view=aspnetcore-5.0) ç« èŠ‚ã€‚

:::
