---
id: logging
title: 18. æ—¥å¿—è®°å½•
sidebar_label: 18. æ—¥å¿—è®°å½•
---

## 18.1 å…³äºæ—¥å¿—

é€šå¸¸æ—¥å¿—æŒ‡çš„æ˜¯**ç³»ç»Ÿæ—¥å¿—**å’Œ**ç¨‹åºæ—¥å¿—**ã€‚

**ç³»ç»Ÿæ—¥å¿—** æ˜¯è®°å½•ç³»ç»Ÿä¸­ç¡¬ä»¶ã€è½¯ä»¶å’Œç³»ç»Ÿé—®é¢˜çš„ä¿¡æ¯ï¼ŒåŒæ—¶è¿˜å¯ä»¥ç›‘è§†ç³»ç»Ÿä¸­å‘ç”Ÿçš„äº‹ä»¶ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡å®ƒæ¥æ£€æŸ¥é”™è¯¯å‘ç”Ÿçš„åŸå› ï¼Œæˆ–è€…å¯»æ‰¾å—åˆ°æ”»å‡»æ—¶æ”»å‡»è€…ç•™ä¸‹çš„ç—•è¿¹ã€‚ç³»ç»Ÿæ—¥å¿—åŒ…æ‹¬ç³»ç»Ÿæ—¥å¿—ã€åº”ç”¨ç¨‹åºæ—¥å¿—å’Œå®‰å…¨æ—¥å¿—ã€‚

**ç¨‹åºæ—¥å¿—** æ˜¯ç¨‹åºè¿è¡Œä¸­äº§ç”Ÿçš„æ—¥å¿—ï¼Œé€šå¸¸ç”±æ¡†æ¶è¿è¡Œæ—¶æˆ–å¼€å‘è€…æä¾›çš„æ—¥å¿—ã€‚åŒ…æ‹¬è¯·æ±‚æ—¥å¿—ï¼Œå¼‚å¸¸æ—¥å¿—ã€å®¡è®¡æ—¥å¿—ã€è¡Œä¸ºæ—¥å¿—ç­‰ã€‚

## 18.2 æ—¥å¿—ä½œç”¨

åœ¨é¡¹ç›®å¼€å‘ä¸­ï¼Œéƒ½ä¸å¯é¿å…çš„ä½¿ç”¨åˆ°æ—¥å¿—ã€‚æ²¡æœ‰æ—¥å¿—è™½ç„¶ä¸ä¼šå½±å“é¡¹ç›®çš„æ­£ç¡®è¿è¡Œï¼Œä½†æ˜¯æ²¡æœ‰æ—¥å¿—çš„é¡¹ç›®å¯ä»¥è¯´æ˜¯ä¸å®Œæ•´çš„ã€‚æ—¥å¿—åœ¨è°ƒè¯•ï¼Œé”™è¯¯æˆ–è€…å¼‚å¸¸å®šä½ï¼Œæ•°æ®åˆ†æä¸­çš„ä½œç”¨æ˜¯ä¸è¨€è€Œå–»çš„ã€‚

- è°ƒè¯•

åœ¨é¡¹ç›®è°ƒè¯•æ—¶ï¼ŒæŸ¥çœ‹æ ˆä¿¡æ¯å¯ä»¥æ–¹ä¾¿åœ°çŸ¥é“å½“å‰ç¨‹åºçš„è¿è¡ŒçŠ¶æ€ï¼Œè¾“å‡ºçš„æ—¥å¿—ä¾¿äºè®°å½•ç¨‹åºåœ¨ä¹‹å‰çš„è¿è¡Œç»“æœã€‚

- é”™è¯¯å®šä½

ä¸è¦ä»¥ä¸ºé¡¹ç›®èƒ½æ­£ç¡®è·‘èµ·æ¥å°±å¯ä»¥é«˜æ•æ— å¿§ï¼Œé¡¹ç›®åœ¨è¿è¡Œä¸€æ®µæ—¶å€™åï¼Œå¯èƒ½ç”±äºæ•°æ®é—®é¢˜ï¼Œç½‘ç»œé—®é¢˜ï¼Œå†…å­˜é—®é¢˜ç­‰å‡ºç°å¼‚å¸¸ã€‚è¿™æ—¶æ—¥å¿—å¯ä»¥å¸®åŠ©å¼€å‘æˆ–è€…è¿ç»´äººå‘˜å¿«é€Ÿå®šä½é”™è¯¯ä½ç½®ï¼Œæå‡ºè§£å†³æ–¹æ¡ˆã€‚

- æ•°æ®åˆ†æ

å¤§æ•°æ®çš„å…´èµ·ï¼Œä½¿å¾—å¤§é‡çš„æ—¥å¿—åˆ†ææˆä¸ºå¯èƒ½ï¼ŒELK ä¹Ÿè®©æ—¥å¿—åˆ†æé—¨æ§›é™ä½äº†å¾ˆå¤šã€‚æ—¥å¿—ä¸­è•´å«äº†å¤§é‡çš„ç”¨æˆ·æ•°æ®ï¼ŒåŒ…æ‹¬ç‚¹å‡»è¡Œä¸ºï¼Œå…´è¶£åå¥½ç­‰ï¼Œç”¨æˆ·ç”»åƒå¯¹äºå…¬å¸ä¸‹ä¸€æ­¥çš„æˆ˜ç•¥æ–¹å‘æœ‰ä¸€å®šæŒ‡å¼•ä½œç”¨ã€‚

## 18.3 æ—¥å¿—çº§åˆ«

æ—¥å¿—çº§åˆ«å¯ä»¥æœ‰æ•ˆçš„å¯¹æ—¥å¿—ä¿¡æ¯è¿›è¡Œå½’ç±»ï¼Œæ–¹ä¾¿å‡†ç¡®çš„æŸ¥çœ‹ç‰¹å®šæ—¥å¿—å†…å®¹ã€‚é€šå¸¸æ—¥å¿—ç±»åˆ«æœ‰ä»¥ä¸‹çº§åˆ«ï¼š

|        çº§åˆ«         | å€¼  |      æ–¹æ³•      | æè¿°                                                                                                       |
| :-----------------: | --- | :------------: | ---------------------------------------------------------------------------------------------------------- |
|    Traceï¼ˆè·Ÿè¸ªï¼‰    | 0   |    LogTrace    | åŒ…å«æœ€è¯¦ç»†çš„æ¶ˆæ¯ã€‚ è¿™äº›æ¶ˆæ¯å¯èƒ½åŒ…å«æ•æ„Ÿçš„åº”ç”¨æ•°æ®ã€‚ è¿™äº›æ¶ˆæ¯é»˜è®¤æƒ…å†µä¸‹å¤„äºç¦ç”¨çŠ¶æ€ï¼Œå¹¶ä¸”ä¸åº”åœ¨ç”Ÿäº§ä¸­å¯ç”¨ã€‚ |
|    Debugï¼ˆè°ƒè¯•ï¼‰    | 1   |    LogDebug    | ç”¨äºè°ƒè¯•å’Œå¼€å‘ã€‚ ç”±äºé‡å¤§ï¼Œè¯·åœ¨ç”Ÿäº§ä¸­å°å¿ƒä½¿ç”¨ã€‚                                                            |
| Informationï¼ˆä¿¡æ¯ï¼‰ | 2   | LogInformation | è·Ÿè¸ªåº”ç”¨çš„å¸¸è§„æµã€‚ å¯èƒ½å…·æœ‰é•¿æœŸå€¼ã€‚                                                                        |
|   Warningï¼ˆè­¦å‘Šï¼‰   | 3   |   LogWarning   | å¯¹äºå¼‚å¸¸äº‹ä»¶æˆ–æ„å¤–äº‹ä»¶ã€‚ é€šå¸¸åŒ…æ‹¬ä¸ä¼šå¯¼è‡´åº”ç”¨å¤±è´¥çš„é”™è¯¯æˆ–æƒ…å†µã€‚                                            |
|    Errorï¼ˆé”™è¯¯ï¼‰    | 4   |    LogError    | è¡¨ç¤ºæ— æ³•å¤„ç†çš„é”™è¯¯å’Œå¼‚å¸¸ã€‚ è¿™äº›æ¶ˆæ¯è¡¨ç¤ºå½“å‰æ“ä½œæˆ–è¯·æ±‚å¤±è´¥ï¼Œè€Œä¸æ˜¯æ•´ä¸ªåº”ç”¨å¤±è´¥ã€‚                            |
|  Criticalï¼ˆä¸¥é‡ï¼‰   | 5   |  LogCritical   | éœ€è¦ç«‹å³å…³æ³¨çš„å¤±è´¥ã€‚ ä¾‹å¦‚æ•°æ®ä¸¢å¤±ã€ç£ç›˜ç©ºé—´ä¸è¶³ã€‚                                                          |

## 18.4 å¦‚ä½•ä½¿ç”¨

åœ¨ `.NET 5` æ¡†æ¶ä¸­ï¼Œå¾®è½¯å·²ç»ä¸ºæˆ‘ä»¬å†…ç½®äº† `æ—¥å¿—ç»„ä»¶`ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œæ— éœ€æˆ‘ä»¬å¼•ç”¨ç¬¬ä¸‰æ–¹åŒ…è¿›è¡Œæ—¥å¿—è®°å½•ã€‚`.NET 5` æ¡†æ¶ä¸ºæˆ‘ä»¬æä¾›äº†ä¸¤ç§æ—¥å¿—å¯¹è±¡åˆ›å»ºæ–¹å¼ã€‚

### 18.4.1 `ILogger<T>` æ³›å‹æ–¹å¼

ä½¿ç”¨éå¸¸ç®€å•ï¼Œå¯ä»¥é€šè¿‡ `ILogger<T>` å¯¹è±¡è¿›è¡Œæ³¨å…¥ï¼Œå¦‚ï¼š

```cs showLineNumbers  {5}
public class PrivacyModel : PageModel
{
    private readonly ILogger<PrivacyModel> _logger;

    public PrivacyModel(ILogger<PrivacyModel> logger)
    {
        _logger = logger;
    }

    public void OnGet()
    {
        _logger.LogInformation("GET Pages.PrivacyModel called.");
    }
}
```

:::tip å°çŸ¥è¯†

é€šè¿‡æ³›å‹ `ILogger<T>` æ–¹å¼å†™å…¥æ—¥å¿—ï¼Œé‚£ä¹ˆé»˜è®¤å°† `T` ç±»å‹å®Œæ•´ç±»å‹åç§°ä½œä¸º `æ—¥å¿—ç±»åˆ«`ã€‚

:::

### 18.4.2 `ILoggerFactory` å·¥å‚æ–¹å¼

ä½¿ç”¨å·¥å‚æ–¹å¼ï¼Œéœ€æ‰‹åŠ¨ä¼ å…¥ `æ—¥å¿—ç±»åˆ«`ï¼Œå¦‚ï¼š

```cs showLineNumbers  {5,7}
public class ContactModel : PageModel
{
    private readonly ILogger _logger;

    public ContactModel(ILoggerFactory logger)
    {
        _logger = logger.CreateLogger("MyCategory");
    }

    public void OnGet()
    {
        _logger.LogInformation("GET Pages.ContactModel called.");
    }
}
```

### 18.4.3 `Log` é™æ€ç±»æ–¹å¼

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.2.1 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

```cs showLineNumbers
Log.Information("Information");

Log.Warning("Warning");

Log.Error("Error");

Log.Debug("Debug");

Log.Trace("Trace");

Log.Critical("Critical");
```

### 18.4.4 `æ‡’äººæ¨¡å¼` ğŸ˜

åœ¨ `Furion` æ¡†æ¶ä¸­ï¼Œæä¾›äº†æ›´æ‡’çš„æ–¹å¼å†™å…¥æ—¥å¿—ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡å­—ç¬¦ä¸²æ‹“å±•çš„æ–¹å¼å†™å…¥ï¼Œå¦‚ï¼š

```cs showLineNumbers
"ç®€å•æ—¥å¿—".LogInformation();

"ç™¾å°åƒ§ æ–°å¢äº†ä¸€æ¡è®°å½•".LogInformation<HomeController>();

"ç¨‹åºå‡ºç°å¼‚å¸¸å•¦".LogError<HomeController>();

"è¿™æ˜¯è‡ªå®šä¹‰ç±»åˆ«æ—¥å¿—".SetCategory("ç±»åˆ«").LogInformation();
```

é€šè¿‡å­—ç¬¦ä¸²æ‹“å±•æ–¹å¼å¯ä»¥åœ¨ä»»ä½•æ—¶å€™æ–¹ä¾¿è®°å½•æ—¥å¿—ï¼Œä¸“é—¨ä¸ºæ‡’äººæä¾›çš„ã€‚

## 18.5 é…ç½®æ—¥å¿—è¾“å‡ºä»‹è´¨

:::tip ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å°èŠ‚ä»…åœ¨ `Furion 3.9.0+` ç‰ˆæœ¬æä¾›ã€‚

:::

åœ¨ `ASP.NET Core` åº”ç”¨ç¨‹åºä¸­ï¼Œä¸»æœºå¯åŠ¨æ—¶é»˜è®¤æ³¨å†Œäº† `ConsoleLoggerProvider` æä¾›å™¨ï¼Œä¹Ÿå°±æ˜¯æ§åˆ¶å°æ—¥å¿—è¾“å‡ºæä¾›å™¨ï¼Œæ‰€ä»¥æ— éœ€ä»»ä½•æ³¨å†ŒæœåŠ¡å³å¯åœ¨æ§åˆ¶å°è¾“å‡ºã€‚

### 18.5.1 è¾“å‡ºåˆ°æ§åˆ¶å°

```bash showLineNumbers
info: Furion.EventBus.EventBusHostedService[0]
      EventBus Hosted Service is running.
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: https://localhost:5001
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://localhost:5000
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
info: Microsoft.Hosting.Lifetime[0]
      Content root path: C:\Workplaces\Furion\samples\Furion.Web.Entry\
```

å¦‚éœ€å…¶ä»–é…ç½®å¯åœ¨ `appsettings.json` é…ç½®å³å¯ï¼š

```json showLineNumbers {2-12}
{
  "Logging": {
    "Console": {
      "IncludeScopes": true,
      "LogLevel": {
        "Microsoft.AspNetCore.Mvc.Razor.Internal": "Warning",
        "Microsoft.AspNetCore.Mvc.Razor.Razor": "Debug",
        "Microsoft.AspNetCore.Mvc.Razor": "Error",
        "Default": "Information"
      }
    }
  }
}
```

å¦‚éœ€è‡ªå®šä¹‰æ§åˆ¶å°æ—¥å¿—æ¨¡æ¿å¯æŸ¥çœ‹å¾®è½¯å®˜æ–¹æ–‡æ¡£ [https://docs.microsoft.com/zh-cn/dotnet/core/extensions/console-log-formatter#implement-a-custom-formatter](https://docs.microsoft.com/zh-cn/dotnet/core/extensions/console-log-formatter#implement-a-custom-formatter)

è¿™é‡Œä¹Ÿæä¾›ç›¸å…³ `Issue` å‚è€ƒï¼š**[#I5JJJH](https://gitee.com/dotnetchina/Furion/issues/I5JJJH)**

### 18.5.2 è¾“å‡ºåˆ°æ–‡ä»¶

- **åŸºç¡€ä½¿ç”¨**

```cs showLineNumbers {2,5,8}
// ä¾‹å­ä¸€ï¼šå¯åŠ¨å±‚æ ¹ç›®å½•è¾“å‡º
services.AddFileLogging("application.log");

// ä¾‹å­äºŒï¼šæ”¯æŒè·¯å¾„
services.AddFileLogging("logs/application.log");

// ä¾‹å­ä¸‰ï¼šæ”¯æŒæ—¥å¿—è¿½åŠ è¿˜æ˜¯è¦†ç›–ï¼Œè®¾ç½® true ä¸ºè¿½åŠ ï¼Œfalse ä¸ºè¦†ç›–
services.AddFileLogging("application.log", true);
```

- **ä»é…ç½®æ–‡ä»¶è¯»å–é…ç½®**

:::important ç‰¹åˆ«æ³¨æ„

**åªæœ‰ä¸åœ¨ `.AddFile` ç¬¬ä¸€ä¸ªå‚æ•°é…ç½®æ–‡ä»¶åæ‰ä¼šè‡ªåŠ¨åŠ è½½é…ç½®ï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶ååº”è¯¥é…ç½®åœ¨é…ç½®æ–‡ä»¶ä¸­ã€‚**

:::

æ–‡ä»¶æ—¥å¿—é…ç½®è¯´æ˜ï¼š

```json showLineNumbers {2,7-13,16-22}
{
  "Logging": {
    "LogLevel": {
      "Default": "Information"
      // .... appsettings é»˜è®¤é…ç½®
    },
    "File": {
      "FileName": "application.log", // æ—¥å¿—æ–‡ä»¶å®Œæ•´è·¯å¾„æˆ–æ–‡ä»¶åï¼Œæ¨è .log ä½œä¸ºæ‹“å±•å
      "Append": true, // è¿½åŠ åˆ°å·²å­˜åœ¨æ—¥å¿—æ–‡ä»¶æˆ–è¦†ç›–å®ƒä»¬
      "MinimumLevel": "Information", // æœ€ä½æ—¥å¿—è®°å½•çº§åˆ«
      "FileSizeLimitBytes": 0, // æ§åˆ¶æ¯ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§å­˜å‚¨å¤§å°ï¼Œé»˜è®¤æ— é™åˆ¶ï¼Œå¦‚æœæŒ‡å®šäº†è¯¥å€¼ï¼Œé‚£ä¹ˆæ—¥å¿—æ–‡ä»¶å¤§å°è¶…å‡ºäº†è¯¥é…ç½®å°±ä¼šåˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶ï¼Œæ–°åˆ›å»ºçš„æ—¥å¿—æ–‡ä»¶å‘½åè§„åˆ™ï¼šæ–‡ä»¶å+[é€’å¢åºå·].log
      "MaxRollingFiles": 0 // æ§åˆ¶æœ€å¤§åˆ›å»ºçš„æ—¥å¿—æ–‡ä»¶æ•°é‡ï¼Œé»˜è®¤æ— é™åˆ¶ï¼Œé…åˆ FileSizeLimitBytes ä½¿ç”¨ï¼Œå¦‚æœæŒ‡å®šäº†è¯¥å€¼ï¼Œé‚£ä¹ˆè¶…å‡ºè¯¥å€¼å°†ä»æœ€åˆæ—¥å¿—æ–‡ä»¶ä¸­ä»å¤´å†™å…¥è¦†ç›–
    }
  },
  // è‡ªå®šä¹‰é…ç½®èŠ‚ç‚¹
  "MyLogger": {
    "FileName": "application.log",
    "Append": true,
    "MinimumLevel": "Information",
    "FileSizeLimitBytes": 0,
    "MaxRollingFiles": 0
  }
}
```

```cs showLineNumbers {2,5,13,16}
// ä¾‹å­ä¸€ï¼šé»˜è®¤è¯»å– Logging:File èŠ‚ç‚¹
services.AddFileLogging();

// ä¾‹å­äºŒï¼šé»˜è®¤è¯»å– Logging:File èŠ‚ç‚¹ï¼Œæ”¯æŒæ›´å¤šé…ç½®
services.AddFileLogging(options =>
{
    options.MinimumLevel = LogLevel.Warning;

    // å…¶ä»–é…ç½®...
});

// ä¾‹å­ä¸‰ï¼šè‡ªå®šä¹‰é…ç½®èŠ‚ç‚¹
services.AddFileLogging(() => "MyLogger");

// ä¾‹å­å››ï¼šè‡ªå®šä¹‰é…ç½®èŠ‚ç‚¹ï¼Œæ”¯æŒæ›´å¤šé…ç½®
services.AddFileLogging(() => "MyLogger", options =>
{
    options.MinimumLevel = LogLevel.Warning;

    // å…¶ä»–é…ç½®...
});
```

- **è‡ªå®šä¹‰æ—¥å¿—æ–‡ä»¶åè§„åˆ™**

```cs showLineNumbers {2,5,14,23}
// ä¾‹å­ä¸€ï¼šæ”¯æŒç³»ç»Ÿç¯å¢ƒå˜é‡ï¼Œå¦‚%SystemDrive%ï¼Œ%SystemRoot%
services.AddFileLogging("application%SystemDrive%-%SystemRoot%.log");

// ä¾‹å­äºŒï¼šæ¯å¤©åˆ›å»ºä¸€ä¸ªæ—¥å¿—æ–‡ä»¶
services.AddFileLogging("application-{0:yyyy}-{0:MM}-{0:dd}.log", options =>
{
    options.FileNameRule = fileName =>
    {
        return string.Format(fileName, DateTime.UtcNow);
    };
});

// ä¾‹å­ä¸‰ï¼Œä»»ä½•è‡ªå·±å–œæ¬¢çš„å‘½åè§„åˆ™
services.AddFileLogging("application-{0:yyyy}-{0:MM}-{0:dd}.log", options =>
{
    options.FileNameRule = fileName =>
    {
        // your rule...
    };
});

// ä¾‹å­å››ï¼Œæ‰¹é‡è®¾ç½®å¤šä¸ª
Array.ForEach(new[] { LogLevel.Information, LogLevel.Warning, LogLevel.Error }, logLevel =>
{
    services.AddFileLogging($"application-{logLevel}-{0:yyyy}-{0:MM}-{0:dd}.log", options =>
    {
        options.FileNameRule = fileName => string.Format(fileName, DateTime.UtcNow);
        options.WriteFilter = logMsg => logMsg.LogLevel == logLevel;
    });
});
```

- **æ—¥å¿—è¿‡æ»¤å™¨/ç­›é€‰å™¨**

é€šè¿‡æ—¥å¿—ç­›é€‰å™¨å¯ä»¥å¯¹æ—¥å¿—è¿›è¡Œå½’ç±»å†™å…¥

```cs showLineNumbers {2,10,19}
// ä¾‹å­ä¸€ï¼šæ ¹æ®æ—¥å¿—çº§åˆ«è¾“å‡º
services.AddFileLogging("infomation.log", options =>
{
    options.WriteFilter = (logMsg) =>
    {
        return logMsg.LogLevel == LogLevel.Information;
    };
});

services.AddFileLogging("error.log", options =>
{
    options.WriteFilter = (logMsg) =>
    {
        return logMsg.LogLevel == LogLevel.Error;
    };
});

// ä¾‹å­äºŒï¼Œæ ¹æ®ä»»ä½•è§„åˆ™ï¼Œæ¯”å¦‚ç‰¹å®šçš„ç±»å
services.AddFileLogging("someclass.log", options =>
{
    options.WriteFilter = (logMsg) =>
    {
        return logMsg.LogName.Contains("SomeClassName");
    };
});
```

- **è‡ªå®šä¹‰æ—¥å¿—æ¨¡æ¿**

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`Furion` æä¾›äº†æ ‡å‡†çš„æ—¥å¿—è¾“å‡ºæ¨¡æ¿ï¼Œå¦‚ï¼š

```bash showLineNumbers
2022-07-23T20:16:29.3459053+08:00	[INF]	[Furion.EventBus.EventBusHostedService]	[0]	EventBus Hosted Service is running.
2022-07-23T20:16:29.5827366+08:00	[INF]	[Microsoft.Hosting.Lifetime]	[0]	Application started. Press Ctrl+C to shut down.
2022-07-23T20:16:29.5828798+08:00	[INF]	[Microsoft.Hosting.Lifetime]	[0]	Hosting environment: Development
2022-07-23T20:16:29.5829377+08:00	[INF]	[Microsoft.Hosting.Lifetime]	[0]	Content root path: C:\Workplaces\Furion\samples\Furion.Web.Entry\
```

å¦‚éœ€è‡ªå®šä¹‰ï¼š

```cs showLineNumbers {2,16,34}
// ä¾‹å­ä¸€ï¼Œè‡ªå®šä¹‰æ—¥å¿—æ¨¡æ¿ï¼ˆå¸¸ç”¨ï¼‰
services.AddFileLogging("mytemplate.log", options =>
{
    options.MessageFormat = (logMsg) =>
    {
        var stringBuilder = new StringBuilder();

        stringBuilder.Append(DateTime.Now.ToString("o"));
        // å…¶ä»–çš„ã€‚ã€‚ã€‚è‡ªå·±ç»„è£…

        return stringBuilder.ToString();
    };
});

// ä¾‹å­äºŒï¼Œéœ€è¦è¾“å‡º json æ ¼å¼ï¼Œæ¯”å¦‚å¯¹æ¥é˜¿é‡Œäº‘æ—¥å¿—ï¼Œkibanaç¬¬ä¸‰æ–¹æ—¥å¿—ä½¿ç”¨è¿™ä¸ª
services.AddFileLogging("mytemplate.log", options =>
{
    options.MessageFormat = (logMsg) =>
    {
        // é«˜æ€§èƒ½å†™å…¥
        return logMsg.WriteArray(writer =>
        {
            writer.WriteStringValue(DateTime.Now.ToString("o"));
            writer.WriteStringValue(logMsg.LogLevel.ToString());
            writer.WriteStringValue(logMsg.LogName);
            writer.WriteNumberValue(logMsg.EventId.Id);
            writer.WriteStringValue(logMsg.Message);
            writer.WriteStringValue(logMsg.Exception?.ToString());
        });
    };
});

// ä¾‹å­äºŒï¼Œéœ€è¦è¾“å‡º json ï¼ˆè‡ªå®šä¹‰ï¼‰æ ¼å¼ï¼Œæ¯”å¦‚å¯¹æ¥é˜¿é‡Œäº‘æ—¥å¿—ï¼Œkibanaç¬¬ä¸‰æ–¹æ—¥å¿—ä½¿ç”¨è¿™ä¸ª
services.AddFileLogging("mytemplate.log", options =>
{
    options.MessageFormat = (logMsg) =>
    {
        // é«˜æ€§èƒ½å†™å…¥
        return logMsg.Write(writer =>
        {
            // write å¯¹è±¡ä¸º Utf8JsonWriterï¼Œå¯é€šè¿‡æµå†™å…¥ï¼Œæ€§èƒ½æé«˜
        });
    };
});
```

- **æ—¥å¿—å†™å…¥å¤±è´¥å¤„ç†**

æœ‰æ—¶å€™å¯èƒ½å› ä¸ºæ—¥å¿—æ–‡ä»¶è¢«æ‰“å¼€æˆ–è€…å…¶ä»–åº”ç”¨ç¨‹åºå ç”¨äº†ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´æ—¥å¿—å†™å…¥å¤±è´¥ï¼Œè¿™æ—¶å€™å¯ä»¥è¿›è¡Œå…¶ä»–ç›¸å…³å¤„ç†ï¼š

```cs showLineNumbers {2,11,15}
// ä¾‹å­ä¸€ï¼šå…¶ä»–å¤„ç†
services.AddFileLogging("template-obj.log", options =>
{
    options.HandleWriteError = (writeError) =>
    {
        // ~~
    };
});

// ä¾‹å­äºŒï¼Œå¯ç”¨å¤‡ç”¨æ—¥å¿—æ–‡ä»¶åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯å¦‚æœæ–‡ä»¶è¢«å ç”¨äº†ï¼Œå¯ä»¥åˆ›å»ºæ–°çš„å¤‡ç”¨æ—¥å¿—ç»§ç»­å†™å…¥ï¼Œæ¨èï¼ï¼ï¼
services.AddFileLogging("template-obj.log", options =>
{
    options.HandleWriteError = (writeError) =>
    {
        writeError.UseRollbackFileName(Path.GetFileNameWithoutExtension(writeError.CurrentFileName) + "-oops" + Path.GetExtension(writeError.CurrentFileName));
    };
});
```

### 18.5.3 è¾“å‡ºåˆ°æ•°æ®åº“/å…¶ä»–å­˜å‚¨ä»‹è´¨

å°†æ—¥å¿—è¾“å‡ºåˆ°æ•°æ®åº“ä¸­ä¹Ÿæ˜¯éå¸¸å¸¸è§çš„éœ€æ±‚ï¼Œ`Furion` æŠŠè¯¥åŠŸèƒ½åšåˆ°äº†éå¸¸ç®€å•ï¼Œæ”¯æŒä»»ä½•å­˜å‚¨ä»‹è´¨ã€‚

åœ¨å†™å…¥æ•°æ®åº“/å…¶ä»–å­˜å‚¨ä»‹è´¨ä¹‹å‰éœ€åˆ›å»ºæ•°æ®åº“æ—¥å¿—å†™å…¥å™¨å¹¶å®ç° `IDatabaseLoggingWriter` æ¥å£ï¼Œ**æ”¯æŒå¤šä¸ª**ï¼Œå¦‚ï¼š

```cs showLineNumbers {1,5,8,12}
using Furion.Logging;

namespace Your.Core;

public class DatabaseLoggingWriter : IDatabaseLoggingWriter
{
    // æ”¯æŒæ„é€ å‡½æ•°æ³¨å…¥ä»»ä½•å®ä¾‹ï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾ä»»ä½•æœåŠ¡ï¼Œæ¯”å¦‚æ³¨å…¥ IRepositoryï¼Œæˆ–è€… SqlSugarClient
    public DatabaseLoggingWriter()
    {
    }

    public void Write(LogMessage logMsg, bool flush)
    {
        // è¿™é‡Œå†™ä½ ä»»ä½•æ’å…¥æ•°æ®åº“çš„æ“ä½œï¼Œæ— éœ€ try catch
    }
}
```

ä½ æ²¡çœ‹é”™ï¼Œå°±è¿™ä¹ˆç®€å•ï¼ï¼

- **åŸºç¡€ä½¿ç”¨**

```cs showLineNumbers {2,5}
// ä¾‹å­ä¸€ï¼Œé»˜è®¤é…ç½®
services.AddDatabaseLogging<DatabaseLoggingWriter>(options => {});

// ä¾‹å­äºŒï¼šè‡ªå®šä¹‰é…ç½®
services.AddDatabaseLogging<DatabaseLoggingWriter>(options =>
{
    options.MinimumLevel = LogLevel.Warning;

    // å…¶ä»–é…ç½®...
});
```

- **ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–**

:::important ç‰¹åˆ«æ³¨æ„

**åªæœ‰ä¸åœ¨ `.AddDatabase` ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç©ºæ‰ä¼šè‡ªåŠ¨åŠ è½½é…ç½®ã€‚**

:::

æ•°æ®åº“æ—¥å¿—é…ç½®è¯´æ˜ï¼š

```json showLineNumbers {2,7-9,12-14}
{
  "Logging": {
    "LogLevel": {
      "Default": "Information"
      // .... appsettings é»˜è®¤é…ç½®
    },
    "Database": {
      "MinimumLevel": "Information" // æœ€ä½æ—¥å¿—è®°å½•çº§åˆ«
    }
  },
  // è‡ªå®šä¹‰é…ç½®èŠ‚ç‚¹
  "MyLogger": {
    "MinimumLevel": "Information"
  }
}
```

```cs showLineNumbers {2,5,5,18,25}
// ä¾‹å­ä¸€ï¼šé»˜è®¤è¯»å– Logging:Database èŠ‚ç‚¹
services.AddDatabaseLogging<DatabaseLoggingWriter>();

// ä¾‹å­äºŒï¼šé»˜è®¤è¯»å– Logging:Database èŠ‚ç‚¹ï¼Œæ”¯æŒæ›´å¤šé…ç½®
services.AddDatabaseLogging<DatabaseLoggingWriter>(default(string), options =>
{
    options.MinimumLevel = LogLevel.Warning;

    // å…¶ä»–é…ç½®...
});

// ä¾‹å­ä¸‰ï¼šè‡ªå®šä¹‰é…ç½®èŠ‚ç‚¹
services.AddDatabaseLogging<DatabaseLoggingWriter>("MyLogger");
// æˆ–
services.AddDatabaseLogging<DatabaseLoggingWriter>(() => "MyLogger");

// ä¾‹å­å››ï¼šè‡ªå®šä¹‰é…ç½®èŠ‚ç‚¹ï¼Œæ”¯æŒæ›´å¤šé…ç½®
services.AddDatabaseLogging<DatabaseLoggingWriter>("MyLogger", options =>
{
    options.MinimumLevel = LogLevel.Warning;

    // å…¶ä»–é…ç½®...
});
// æˆ–
services.AddDatabaseLogging<DatabaseLoggingWriter>(() => "MyLogger", options =>
{
    options.MinimumLevel = LogLevel.Warning;

    // å…¶ä»–é…ç½®...
});
```

- **æ—¥å¿—è¿‡æ»¤å™¨/ç­›é€‰å™¨**

é€šè¿‡æ—¥å¿—ç­›é€‰å™¨å¯ä»¥å¯¹æ—¥å¿—è¿›è¡Œå½’ç±»å†™å…¥

```cs showLineNumbers {2,10,19}
// ä¾‹å­ä¸€ï¼šæ ¹æ®æ—¥å¿—çº§åˆ«è¾“å‡ºï¼Œå¯ä»¥åˆ†åˆ«å®šä¹‰ IDatabaseLoggingWriterï¼Œä¹Ÿå¯ä»¥ç”¨åŒä¸€ä¸ªåº•å±‚è¿›è¡Œåˆ¤æ–­
services.AddDatabaseLogging<InfomationLoggingWriter>(options =>
{
    options.WriteFilter = (logMsg) =>
    {
        return logMsg.LogLevel == LogLevel.Information;
    };
});
// å¯ä»¥åˆ†åˆ«å®šä¹‰ IDatabaseLoggingWriterï¼Œä¹Ÿå¯ä»¥ç”¨åŒä¸€ä¸ªåº•å±‚è¿›è¡Œåˆ¤æ–­
services.AddDatabaseLogging<ErrorLoggingWriter>(options =>
{
    options.WriteFilter = (logMsg) =>
    {
        return logMsg.LogLevel == LogLevel.Error;
    };
});

// ä¾‹å­äºŒï¼Œæ ¹æ®ä»»ä½•è§„åˆ™ï¼Œæ¯”å¦‚ç‰¹å®šçš„ç±»å
services.AddDatabaseLogging<DatabaseLoggingWriter>(options =>
{
    options.WriteFilter = (logMsg) =>
    {
        return logMsg.LogName.Contains("SomeClassName");
    };
});
```

- **æ—¥å¿—å†™å…¥å¤±è´¥å¤„ç†**

æœ‰æ—¶å€™å¯èƒ½å› ä¸ºæ•°æ®åº“è¿æ¥å¼‚å¸¸æˆ–å…¶ä»–åŸå› è¿æ¥æ± æ»¡ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´æ—¥å¿—å†™å…¥å¤±è´¥ï¼Œè¿™æ—¶å€™å¯ä»¥è¿›è¡Œå…¶ä»–ç›¸å…³å¤„ç†ï¼š

```cs showLineNumbers {2}
// ä¾‹å­ä¸€ï¼šå…¶ä»–å¤„ç†
services.AddDatabaseLogging<DatabaseLoggingWriter>(options =>
{
    options.HandleWriteError = (writeError) =>
    {
        // ~~
    };
});
```

### 18.5.4 `ILoggerFactory` æ–¹å¼

`Furion` ä¹Ÿæä¾›äº†è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºæ—¥å¿—æä¾›å™¨å¹¶å†™å…¥ï¼š

```cs showLineNumbers  {5,7-8}
public class ContactModel : PageModel
{
    private readonly ILogger _logger;

    public ContactModel(ILoggerFactory logger)
    {
        // æ”¯æŒæ‰€æœ‰ AddLoggingFile å’Œ AddDatabaseFile é…ç½®
        _logger = logger.AddFile(....).CreateLogger("MyCategory");
    }

    public void OnGet()
    {
        _logger.LogInformation("GET Pages.ContactModel called.");
    }
}
```

### 18.5.5 `ILoggingBuilder` æ–¹å¼

`Furion` ä¹Ÿæä¾›äº†åŸç”Ÿ `services.AddLogging(builder => {})` æ–¹å¼é…ç½®ï¼Œå¦‚

```cs showLineNumbers {1,3,5}
services.AddLogging(builder =>
{
	builder.AddFile("applicaion.log");

    builder.AddDatabase<DatabaseLoggingWriter>();

    //....
});
```

### 18.5.6 è®°å½•è¯·æ±‚æ—¥å¿—

åœ¨ `ASP.NET 6` ä¸­ï¼Œæ¡†æ¶é»˜è®¤æä¾›äº† `app.UseHttpLogging()` è®°å½• `HTTP` è¯·æ±‚æ—¥å¿—åŠŸèƒ½ï¼Œè¯¦ç»†äº†è§£å¯æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ [ASP.NET Core - HTTP æ—¥å¿—è®°å½•](https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/http-logging/?view=aspnetcore-6.0)

å½“ç„¶ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ä¸­é—´ä»¶çš„æ–¹å¼å†™ï¼Œåªéœ€è¦æ³¨å…¥ `ILogger<>` æ¥å£å³å¯ã€‚

### 18.5.7 `Debug` å’Œ `Trace` é»˜è®¤ä¸è¾“å‡ºé—®é¢˜

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¾®è½¯åœ¨ `appsettings.json` å’Œ `appsettings.Development.json` ä¸­é…ç½®äº† `Default` æ—¥å¿—çº§åˆ«ï¼Œå¦‚éœ€è‡ªå®šä¹‰ï¼š

```json showLineNumbers {4}
{
  "Logging": {
    "LogLevel": {
      "Default": "Information"
    }
  }
}
```

è¿™æ—¶å€™åªéœ€è¦ä¿®æ”¹ `Default` ä¸º `Debug` æˆ– `Trace` å³å¯ï¼Œ**æ³¨æ„ä¸åŒç¯å¢ƒåŠ è½½ä¸åŒçš„é…ç½®æ–‡ä»¶ã€‚å¼€å‘ç¯å¢ƒåº”ä¿®æ”¹ `appsettings.Development.json` ä¸‹çš„é…ç½®ã€‚**

## 18.6 `[LoggingMonitor]` ç›‘å¬æ—¥å¿—

åœ¨ `Furion 3.9.1` ç‰ˆæœ¬æ–°å¢äº† `[LoggingMonitor]` ç‰¹æ€§ï¼Œæ”¯æŒåœ¨æ§åˆ¶å™¨æˆ–æ“ä½œä¸­è´´è¯¥ç‰¹æ€§ï¼Œå¯ä»¥å®ç°å¼ºå¤§çš„è¯·æ±‚æ—¥å¿—ç›‘å¬ï¼Œæ–¹ä¾¿æµ‹è¯•ï¼Œå¦‚ï¼š

### 18.6.1 ç‰¹æ€§é…ç½®

```cs showLineNumbers {1,7}
using Furion.Logging;

namespace Furion.Application;

public class TestLoggerServices : IDynamicApiController
{
    [LoggingMonitor]
    public PersonDto GetPerson(int id)
    {
        return new PersonDto
        {
            Id = id
        };
    }
}
```

è¾“å‡ºæ—¥å¿—ä¸ºï¼š

```bash showLineNumbers
â”â”â”â”â”â”â”â”â”â”â”â”  Logging Monitor â”â”â”â”â”â”â”â”â”â”â”
â”£ Furion.Application.TestLoggerServices.GetPerson (Furion.Application)
â”£
â”£ æ§åˆ¶å™¨åç§°ï¼š              TestLoggerServices
â”£ æ“ä½œåç§°ï¼š                GetPerson
â”£ è·¯ç”±ä¿¡æ¯ï¼š                [area]: ; [controller]: test-logger; [action]: person
â”£ è¯·æ±‚åœ°å€ï¼š                https://localhost:44316/api/test-logger/person/11
â”£ æ¥æºåœ°å€ï¼š                https://localhost:44316/api/index.html
â”£ æµè§ˆå™¨æ ‡è¯†ï¼š              Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.114 Safari/537.36 Edg/103.0.1264.62
â”£ å®¢æˆ·ç«¯ IP åœ°å€ï¼š          0.0.0.1
â”£ æœåŠ¡ç«¯ IP åœ°å€ï¼š          0.0.0.1
â”£ æœåŠ¡ç«¯è¿è¡Œç¯å¢ƒï¼š          Development
â”£ æ‰§è¡Œè€—æ—¶ï¼š                31ms
â”£ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  æˆæƒä¿¡æ¯ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â”£ JWT Tokenï¼š               Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJVc2VySWQiOjEsIkFjY291bnQiOiJhZG1pbiIsImlhdCI6MTY1ODcxNjc5NywibmJmIjoxNjU4NzE2Nzk3LCJleHAiOjE2NTg3MTc5OTcsImlzcyI6ImRvdG5ldGNoaW5hIiwiYXVkIjoicG93ZXJieSBGdXJpb24ifQ.VYZkwwqCwlUy3aJjuL-og62I0rkxNQ96kSjEm3VgXtg
â”£
â”£ UserId (integer)ï¼š        1
â”£ Account (string)ï¼š        admin
â”£ iat (integer)ï¼š           1658716797
â”£ nbf (integer)ï¼š           1658716797
â”£ exp (integer)ï¼š           1658717997
â”£ iss (string)ï¼š            dotnetchina
â”£ aud (string)ï¼š            powerby Furion
â”£ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  å‚æ•°åˆ—è¡¨ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â”£ Content-Typeï¼š
â”£
â”£ id (Int32)ï¼š              11
â”£ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  è¿”å›ä¿¡æ¯ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â”£ ç±»å‹ï¼š                    Furion.Application.Persons.PersonDto
â”£ è¿”å›å€¼ï¼š                  {"Id":11,"Name":null,"Age":0,"Address":null,"PhoneNumber":null,"QQ":null,"CreatedTime":"0001-01-01T00:00:00+00:00","Childrens":null,"Posts":null}
â”—â”â”â”â”â”â”â”â”â”â”â”  Logging Monitor â”â”â”â”â”â”â”â”â”â”â”
```

### 18.6.2 å…¨å±€é…ç½®

å¦‚éœ€å…¨å±€å¯ç”¨ `LoggingMonitor` åŠŸèƒ½ï¼Œæ— éœ€åœ¨æ¯ä¸ªæ§åˆ¶å™¨æˆ–è€…æ–¹æ³•ä¸­è´´ï¼Œå…¨å±€æ³¨å†Œå¦‚ä¸‹ï¼š

```cs showLineNumbers
services.AddMvcFilter<LoggingMonitorAttribute>();
```

:::tip `Furion 4.0.2` æ–°æ¨èé…ç½®

åœ¨ `Furion 4.0.2` ç‰ˆæœ¬ä¸­æ–°å¢äº†éå¸¸çµæ´»æ–¹ä¾¿çš„ `services.AddMonitorLogging()` æœåŠ¡é…ç½®ï¼Œå¯åœ¨é…ç½®ä¸­éšæ„æ§åˆ¶å“ªä¸ªç±»å“ªä¸ªæ–¹æ³•å¯ç”¨æˆ–ä¸å¯ç”¨ã€‚

- æ³¨å†ŒæœåŠ¡

```cs showLineNumbers
services.AddMonitorLogging();   // é»˜è®¤è¯»å– Logging:Monitor ä¸‹é…ç½®ï¼Œæ”¯æŒä¼ å…¥å‚æ•°è‡ªå®šä¹‰
```

- æ·»åŠ é…ç½®

```json showLineNumbers {2,3,4-6}
{
  "Logging": {
    "Monitor": {
      "GlobalEnabled": false, // æ˜¯å¦å¯ç”¨å…¨å±€æ‹¦æˆªï¼Œé»˜è®¤ `false`
      "IncludeOfMethods": [], // æ˜¯å¦æŒ‡å®šæ‹¦æˆªç‰¹å®šæ–¹æ³•ï¼Œå½“ GlobalEnabled: false æœ‰æ•ˆ
      "ExcludeOfMethods": [], // æ˜¯å¦æŒ‡å®šæ’é™¤ç‰¹å®šæ–¹æ³•ï¼Œå½“ GlobalEnabled: true æœ‰æ•ˆ
      "BahLogLevel": "Information" // é…ç½® Oops.Oh å’Œ Oops.Bah ä¸šåŠ¡æ—¥å¿—è¾“å‡ºçº§åˆ«ï¼Œé»˜è®¤ Information
    }
  }
}
```

`IncludeOfMethods` å’Œ `ExcludeOfMethods` æ–¹æ³•ç­¾åæ ¼å¼ä¸ºï¼š`ç±»å®Œå…¨é™å®šå.æ–¹æ³•å`ï¼Œå¦‚ï¼š`Furion.Application.TestNamedServices.GetName`ï¼Œ`Furion.Application.TestNamedServices` æ˜¯ç±»åï¼Œ`GetName` æ˜¯æ–¹æ³•åã€‚

:::

å¦‚æœé…ç½®äº†å…¨å±€è¯·æ±‚ç›‘è§†æ—¥å¿—ï¼Œå¯¹ä¸ªåˆ«ä¸éœ€è¦ç›‘è§†çš„æ¥å£æ–¹æ³•åªéœ€è¦è´´ `[SuppressMonitor]` ç‰¹æ€§å³å¯ã€‚

## 18.7 æ‰“å°æ—¥å¿—åˆ° `Swagger` ä¸­

åœ¨ `Furion` æ¡†æ¶ä¸­é»˜è®¤é›†æˆäº† `MiniProfiler` ç»„ä»¶å¹¶ä¸ `Swagger` è¿›è¡Œäº†ç»“åˆï¼Œå¦‚éœ€æ‰“å°æ—¥å¿—æˆ–è°ƒè¯•ä»£ç ï¼Œåªéœ€è°ƒç”¨ä»¥ä¸‹æ–¹æ³•å³å¯ï¼š

```cs showLineNumbers
App.PrintToMiniProfiler("åˆ†ç±»", "çŠ¶æ€", "è¦æ‰“å°çš„æ¶ˆæ¯");
```

## 18.8 åœ¨åå°ä»»åŠ¡ä¸­ä½¿ç”¨

ç”±äº `DbContext` é»˜è®¤æ³¨å†Œä¸º `Scoped` ç”Ÿå­˜å‘¨æœŸï¼Œæ‰€ä»¥åœ¨åå°ä»»åŠ¡ä¸­ä½¿ç”¨ `IServiceScopeFactory` è·å–æ‰€æœ‰æœåŠ¡ï¼Œå¦‚ï¼š

```cs showLineNumbers
public class JobService : BackgroundService
{
    // æ—¥å¿—å¯¹è±¡
    private readonly ILogger<JobService> _logger;

    // æœåŠ¡å·¥å‚
    private readonly IServiceScopeFactory _scopeFactory;
    public JobService(ILogger<JobService> logger
        , IServiceScopeFactory scopeFactory)
    {
        _logger = logger;
        _scopeFactory = scopeFactory;
    }

    protected override Task ExecuteAsync(CancellationToken stoppingToken)
    {
        _logger.LogInformation("å†™æ—¥å¿—~~");

        using (var scope = _scopeFactory.CreateScope())
        {
            var services = scope.ServiceProvider;

            // è·å–æ•°æ®åº“ä¸Šä¸‹æ–‡
            var dbContext = Db.GetDbContext(services);

            // è·å–ä»“å‚¨
            var respository = Db.GetRepository<Person>(services);

            // è§£æå…¶ä»–æœåŠ¡
            var otherService = services.GetService<XXX>();
        }

        return Task.CompletedTask;
    }
}
```

## 18.9 å¤šçº¿ç¨‹å…±äº«ä½œç”¨åŸŸ

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„ `å­—ç¬¦ä¸²` å’Œ `å®ä½“` æ‹“å±•éƒ½æœ‰è‡ªå·±ç‹¬ç«‹ç»´æŠ¤çš„ `ServiceProvider` ä½œç”¨åŸŸã€‚

åœ¨ `Web` è¯·æ±‚ä¸­ï¼Œé»˜è®¤æ˜¯ `HttpContext.RequestServices`ï¼Œä½†åœ¨ `é Web`ï¼Œå¦‚å¤šçº¿ç¨‹æ“ä½œï¼Œåå°ä»»åŠ¡ï¼Œäº‹ä»¶æ€»çº¿ç­‰åœºæ™¯ä¸‹ä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„ä½œç”¨åŸŸï¼Œå®é™…ä¸Šè¿™æ˜¯éå¸¸ä¸å¿…è¦çš„å†…å­˜å¼€é”€ã€‚

è¿™æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦é€šè¿‡ `.SetXXXScoped(service)` å…±äº«å½“å‰æœåŠ¡æä¾›å™¨ä½œç”¨åŸŸå³å¯ï¼Œå¦‚ï¼š

```cs showLineNumbers
Scoped.Create(async (fac, scope) => {
   "å†™æ—¥å¿—".SetLoggerScoped(scope.ServiceProvider).LogInformation();
});
```

## 18.10 é™æ€ `Default` æ–¹å¼æ„å»º

```cs showLineNumbers
StringLoggingPart.Default.SetMessage("è¿™æ˜¯ä¸€ä¸ªæ—¥å¿—").LogInformation();
```

## 18.11 è§„èŒƒæ—¥å¿—æ¨¡æ¿

åœ¨ `Furion v3.5.3+` æ–°å¢äº† `TP.Wrapper(...)` è§„èŒƒæ¨¡æ¿ï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š

```cs showLineNumbers {2}
// ç”Ÿæˆæ¨¡æ¿å­—ç¬¦ä¸²
var template = TP.Wrapper("Furion æ¡†æ¶", "è®© .NET å¼€å‘æ›´ç®€å•ï¼Œæ›´é€šç”¨ï¼Œæ›´æµè¡Œã€‚",
    "##ä½œè€…## ç™¾å°åƒ§",
    "##å½“å‰ç‰ˆæœ¬## v3.5.3",
    "##æ–‡æ¡£åœ°å€## https://furion.icu",
    "##Copyright## ç™¾å°åƒ§, Baiqian Co.,Ltd.");

Console.WriteLine(template);
```

æ—¥å¿—æ‰“å°æ¨¡æ¿å¦‚ä¸‹ï¼š

```bash showLineNumbers
â”â”â”â”â”â”â”â”â”â”â”â”  Furion æ¡†æ¶ â”â”â”â”â”â”â”â”â”â”â”
â”£ è®© .NET å¼€å‘æ›´ç®€å•ï¼Œæ›´é€šç”¨ï¼Œæ›´æµè¡Œã€‚
â”£
â”£ ä½œè€…ï¼š        ç™¾å°åƒ§
â”£ å½“å‰ç‰ˆæœ¬ï¼š     v3.5.3
â”£ æ–‡æ¡£åœ°å€ï¼š     https://furion.icu
â”£ Copyrightï¼š   ç™¾å°åƒ§, Baiqian Co.,Ltd.
â”—â”â”â”â”â”â”â”â”â”â”â”  Furion æ¡†æ¶ â”â”â”â”â”â”â”â”â”â”â”

```

:::tip å…³äºå±æ€§ç”Ÿæˆ

å¦‚æœåˆ—è¡¨é¡¹ä»¥ `##å±æ€§å##` å¼€å¤´ï¼Œè‡ªåŠ¨ç”Ÿæˆ `å±æ€§åï¼š` ä½œä¸ºè¡Œé¦–ä¸”è‡ªåŠ¨ç­‰å®½å¯¹é½ã€‚

`Furion 3.9.1` ä¹‹å‰ç‰ˆæœ¬ä½¿ç”¨ `[å±æ€§å]` å¼€å¤´ã€‚

:::

## 18.12 æ—¥å¿—ä¸Šä¸‹æ–‡

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.1.3 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

æœ‰æ—¶å€™æˆ‘ä»¬å¸Œæœ›ä¸ºæ—¥å¿—æä¾›é¢å¤–æ•°æ®ï¼Œè¿™æ—¶å€™å¯é€šè¿‡ `.ScopeContext()` é…ç½®ï¼Œå¦‚ï¼š

```cs showLineNumbers {2,6,12}
// å†™æ³•ä¸€
_logger.ScopeContext(ctx => ctx.Set("Name", "Furion").Set("UserId", 10))
       .LogInformation("æˆ‘æ˜¯ä¸€ä¸ªæ—¥å¿— {id}", 20);

// å†™æ³•äºŒ
_logger.ScopeContext(new Dictionary<object, object> {
    { "Name", "Furion" },
    { "UserId", 10 }
}).LogInformation("æˆ‘æ˜¯ä¸€ä¸ªæ—¥å¿— {id}", 20);

// å†™æ³•ä¸‰
_logger.ScopeContext(new LogContext {
    // ....
}).LogInformation("æˆ‘æ˜¯ä¸€ä¸ªæ—¥å¿— {id}", 20)
```

åœ¨ `LogMessage` å¯¹è±¡ä¸­ä½¿ç”¨ï¼š

```cs showLineNumbers {1,9}
var value = logMsg.Context.Get("Key");

// æ¯”å¦‚åœ¨è¿‡æ»¤ä¸­ä½¿ç”¨
services.AddFileLogging("infomation.log", options =>
{
    options.WriteFilter = (logMsg) =>
    {
        // è¿˜å¯ä»¥è®¾ç½®ç»™è¿è¡Œæ—¶ä½¿ç”¨ï¼šlogMsg.Context.Set(...);
        return logMsg.Context.Get("Name") == "Furion";
    };
});
```

## 18.13 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::

---

:::note äº†è§£æ›´å¤š

æƒ³äº†è§£æ›´å¤š `æ—¥å¿—` çŸ¥è¯†å¯æŸ¥é˜… [ASP.NET Core - æ—¥å¿—](https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/logging/?view=aspnetcore-5.0) ç« èŠ‚ å’Œ [Serilog](https://serilog.net/) æ–‡æ¡£ã€‚

:::
