---
id: logging
title: 18. æ—¥å¿—è®°å½•
sidebar_label: 18. æ—¥å¿—è®°å½•
---

## 18.1 å…³äºæ—¥å¿—

é€šå¸¸æ—¥å¿—æŒ‡çš„æ˜¯**ç³»ç»Ÿæ—¥å¿—**å’Œ**ç¨‹åºæ—¥å¿—**ã€‚

**ç³»ç»Ÿæ—¥å¿—** æ˜¯è®°å½•ç³»ç»Ÿä¸­ç¡¬ä»¶ã€è½¯ä»¶å’Œç³»ç»Ÿé—®é¢˜çš„ä¿¡æ¯ï¼ŒåŒæ—¶è¿˜å¯ä»¥ç›‘è§†ç³»ç»Ÿä¸­å‘ç”Ÿçš„äº‹ä»¶ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡å®ƒæ¥æ£€æŸ¥é”™è¯¯å‘ç”Ÿçš„åŸå› ï¼Œæˆ–è€…å¯»æ‰¾å—åˆ°æ”»å‡»æ—¶æ”»å‡»è€…ç•™ä¸‹çš„ç—•è¿¹ã€‚ç³»ç»Ÿæ—¥å¿—åŒ…æ‹¬ç³»ç»Ÿæ—¥å¿—ã€åº”ç”¨ç¨‹åºæ—¥å¿—å’Œå®‰å…¨æ—¥å¿—ã€‚

**ç¨‹åºæ—¥å¿—** æ˜¯ç¨‹åºè¿è¡Œä¸­äº§ç”Ÿçš„æ—¥å¿—ï¼Œé€šå¸¸ç”±æ¡†æ¶è¿è¡Œæ—¶æˆ–å¼€å‘è€…æä¾›çš„æ—¥å¿—ã€‚åŒ…æ‹¬è¯·æ±‚æ—¥å¿—ï¼Œå¼‚å¸¸æ—¥å¿—ã€å®¡è®¡æ—¥å¿—ã€è¡Œä¸ºæ—¥å¿—ç­‰ã€‚

## 18.2 æ—¥å¿—ä½œç”¨

åœ¨é¡¹ç›®å¼€å‘ä¸­ï¼Œéƒ½ä¸å¯é¿å…çš„ä½¿ç”¨åˆ°æ—¥å¿—ã€‚æ²¡æœ‰æ—¥å¿—è™½ç„¶ä¸ä¼šå½±å“é¡¹ç›®çš„æ­£ç¡®è¿è¡Œï¼Œä½†æ˜¯æ²¡æœ‰æ—¥å¿—çš„é¡¹ç›®å¯ä»¥è¯´æ˜¯ä¸å®Œæ•´çš„ã€‚æ—¥å¿—åœ¨è°ƒè¯•ï¼Œé”™è¯¯æˆ–è€…å¼‚å¸¸å®šä½ï¼Œæ•°æ®åˆ†æä¸­çš„ä½œç”¨æ˜¯ä¸è¨€è€Œå–»çš„ã€‚

- è°ƒè¯•

åœ¨é¡¹ç›®è°ƒè¯•æ—¶ï¼ŒæŸ¥çœ‹æ ˆä¿¡æ¯å¯ä»¥æ–¹ä¾¿åœ°çŸ¥é“å½“å‰ç¨‹åºçš„è¿è¡ŒçŠ¶æ€ï¼Œè¾“å‡ºçš„æ—¥å¿—ä¾¿äºè®°å½•ç¨‹åºåœ¨ä¹‹å‰çš„è¿è¡Œç»“æœã€‚

- é”™è¯¯å®šä½

ä¸è¦ä»¥ä¸ºé¡¹ç›®èƒ½æ­£ç¡®è·‘èµ·æ¥å°±å¯ä»¥é«˜æ•æ— å¿§ï¼Œé¡¹ç›®åœ¨è¿è¡Œä¸€æ®µæ—¶å€™åï¼Œå¯èƒ½ç”±äºæ•°æ®é—®é¢˜ï¼Œç½‘ç»œé—®é¢˜ï¼Œå†…å­˜é—®é¢˜ç­‰å‡ºç°å¼‚å¸¸ã€‚è¿™æ—¶æ—¥å¿—å¯ä»¥å¸®åŠ©å¼€å‘æˆ–è€…è¿ç»´äººå‘˜å¿«é€Ÿå®šä½é”™è¯¯ä½ç½®ï¼Œæå‡ºè§£å†³æ–¹æ¡ˆã€‚

- æ•°æ®åˆ†æ

å¤§æ•°æ®çš„å…´èµ·ï¼Œä½¿å¾—å¤§é‡çš„æ—¥å¿—åˆ†ææˆä¸ºå¯èƒ½ï¼ŒELK ä¹Ÿè®©æ—¥å¿—åˆ†æé—¨æ§›é™ä½äº†å¾ˆå¤šã€‚æ—¥å¿—ä¸­è•´å«äº†å¤§é‡çš„ç”¨æˆ·æ•°æ®ï¼ŒåŒ…æ‹¬ç‚¹å‡»è¡Œä¸ºï¼Œå…´è¶£åå¥½ç­‰ï¼Œç”¨æˆ·ç”»åƒå¯¹äºå…¬å¸ä¸‹ä¸€æ­¥çš„æˆ˜ç•¥æ–¹å‘æœ‰ä¸€å®šæŒ‡å¼•ä½œç”¨ã€‚

## 18.3 æ—¥å¿—çº§åˆ«

æ—¥å¿—çº§åˆ«å¯ä»¥æœ‰æ•ˆçš„å¯¹æ—¥å¿—ä¿¡æ¯è¿›è¡Œå½’ç±»ï¼Œæ–¹ä¾¿å‡†ç¡®çš„æŸ¥çœ‹ç‰¹å®šæ—¥å¿—å†…å®¹ã€‚é€šå¸¸æ—¥å¿—ç±»åˆ«æœ‰ä»¥ä¸‹çº§åˆ«ï¼š

|        çº§åˆ«         | å€¼  |      æ–¹æ³•      | æè¿°                                                                                                       |
| :-----------------: | --- | :------------: | ---------------------------------------------------------------------------------------------------------- |
|    Traceï¼ˆè·Ÿè¸ªï¼‰    | 0   |    LogTrace    | åŒ…å«æœ€è¯¦ç»†çš„æ¶ˆæ¯ã€‚ è¿™äº›æ¶ˆæ¯å¯èƒ½åŒ…å«æ•æ„Ÿçš„åº”ç”¨æ•°æ®ã€‚ è¿™äº›æ¶ˆæ¯é»˜è®¤æƒ…å†µä¸‹å¤„äºç¦ç”¨çŠ¶æ€ï¼Œå¹¶ä¸”ä¸åº”åœ¨ç”Ÿäº§ä¸­å¯ç”¨ã€‚ |
|    Debugï¼ˆè°ƒè¯•ï¼‰    | 1   |    LogDebug    | ç”¨äºè°ƒè¯•å’Œå¼€å‘ã€‚ ç”±äºé‡å¤§ï¼Œè¯·åœ¨ç”Ÿäº§ä¸­å°å¿ƒä½¿ç”¨ã€‚                                                            |
| Informationï¼ˆä¿¡æ¯ï¼‰ | 2   | LogInformation | è·Ÿè¸ªåº”ç”¨çš„å¸¸è§„æµã€‚ å¯èƒ½å…·æœ‰é•¿æœŸå€¼ã€‚                                                                        |
|   Warningï¼ˆè­¦å‘Šï¼‰   | 3   |   LogWarning   | å¯¹äºå¼‚å¸¸äº‹ä»¶æˆ–æ„å¤–äº‹ä»¶ã€‚ é€šå¸¸åŒ…æ‹¬ä¸ä¼šå¯¼è‡´åº”ç”¨å¤±è´¥çš„é”™è¯¯æˆ–æƒ…å†µã€‚                                            |
|    Errorï¼ˆé”™è¯¯ï¼‰    | 4   |    LogError    | è¡¨ç¤ºæ— æ³•å¤„ç†çš„é”™è¯¯å’Œå¼‚å¸¸ã€‚ è¿™äº›æ¶ˆæ¯è¡¨ç¤ºå½“å‰æ“ä½œæˆ–è¯·æ±‚å¤±è´¥ï¼Œè€Œä¸æ˜¯æ•´ä¸ªåº”ç”¨å¤±è´¥ã€‚                            |
|  Criticalï¼ˆä¸¥é‡ï¼‰   | 5   |  LogCritical   | éœ€è¦ç«‹å³å…³æ³¨çš„å¤±è´¥ã€‚ ä¾‹å¦‚æ•°æ®ä¸¢å¤±ã€ç£ç›˜ç©ºé—´ä¸è¶³ã€‚                                                          |

## 18.4 å¦‚ä½•ä½¿ç”¨

åœ¨ `.NET 5` æ¡†æ¶ä¸­ï¼Œå¾®è½¯å·²ç»ä¸ºæˆ‘ä»¬å†…ç½®äº† `æ—¥å¿—ç»„ä»¶`ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œæ— éœ€æˆ‘ä»¬å¼•ç”¨ç¬¬ä¸‰æ–¹åŒ…è¿›è¡Œæ—¥å¿—è®°å½•ã€‚`.NET 5` æ¡†æ¶ä¸ºæˆ‘ä»¬æä¾›äº†ä¸¤ç§æ—¥å¿—å¯¹è±¡åˆ›å»ºæ–¹å¼ã€‚

### 18.4.1 `ILogger<T>` æ³›å‹æ–¹å¼

ä½¿ç”¨éå¸¸ç®€å•ï¼Œå¯ä»¥é€šè¿‡ `ILogger<T>` å¯¹è±¡è¿›è¡Œæ³¨å…¥ï¼Œå¦‚ï¼š

```cs showLineNumbers  {5}
public class PrivacyModel : PageModel
{
    private readonly ILogger<PrivacyModel> _logger;

    public PrivacyModel(ILogger<PrivacyModel> logger)
    {
        _logger = logger;
    }

    public void OnGet()
    {
        _logger.LogInformation("GET Pages.PrivacyModel called.");
    }
}
```

:::tip å°çŸ¥è¯†

é€šè¿‡æ³›å‹ `ILogger<T>` æ–¹å¼å†™å…¥æ—¥å¿—ï¼Œé‚£ä¹ˆé»˜è®¤å°† `T` ç±»å‹å®Œæ•´ç±»å‹åç§°ä½œä¸º `æ—¥å¿—ç±»åˆ«`ã€‚

:::

### 18.4.2 `ILoggerFactory` å·¥å‚æ–¹å¼

ä½¿ç”¨å·¥å‚æ–¹å¼ï¼Œéœ€æ‰‹åŠ¨ä¼ å…¥ `æ—¥å¿—ç±»åˆ«`ï¼Œå¦‚ï¼š

```cs showLineNumbers  {5,7}
public class ContactModel : PageModel
{
    private readonly ILogger _logger;

    public ContactModel(ILoggerFactory logger)
    {
        _logger = logger.CreateLogger("MyCategory");
    }

    public void OnGet()
    {
        _logger.LogInformation("GET Pages.ContactModel called.");
    }
}
```

### 18.4.3 `æ‡’äººæ¨¡å¼` ğŸ˜

åœ¨ `Furion` æ¡†æ¶ä¸­ï¼Œæä¾›äº†æ›´æ‡’çš„æ–¹å¼å†™å…¥æ—¥å¿—ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡å­—ç¬¦ä¸²æ‹“å±•çš„æ–¹å¼å†™å…¥ï¼Œå¦‚ï¼š

```cs showLineNumbers
"ç®€å•æ—¥å¿—".LogInformation();

"ç™¾å°åƒ§ æ–°å¢äº†ä¸€æ¡è®°å½•".LogInformation<HomeController>();

"ç¨‹åºå‡ºç°å¼‚å¸¸å•¦".LogError<HomeController>();

"è¿™æ˜¯è‡ªå®šä¹‰ç±»åˆ«æ—¥å¿—".SetCategory("ç±»åˆ«").LogInformation();
```

é€šè¿‡å­—ç¬¦ä¸²æ‹“å±•æ–¹å¼å¯ä»¥åœ¨ä»»ä½•æ—¶å€™æ–¹ä¾¿è®°å½•æ—¥å¿—ï¼Œä¸“é—¨ä¸ºæ‡’äººæä¾›çš„ã€‚

## 18.5 å†™å…¥å…¶ä»–ä»‹è´¨

`.NET 5` æ¡†æ¶ä¸­å¹¶æœªæä¾›å†™å…¥`æ–‡ä»¶ã€æ•°æ®åº“` æˆ–å…¶ä»–ä»‹è´¨çš„æä¾›å™¨ï¼Œé»˜è®¤åªæä¾›äº† `Debugã€Console` ä¸¤ç§æ–¹å¼ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦å¼•ç”¨ç¬¬ä¸‰æ–¹æ—¥å¿—ç»„ä»¶ï¼Œæ–¹ä¾¿æˆ‘ä»¬å†™å…¥åˆ°å¤šä¸ªä»‹è´¨ä¸­ã€‚

åœ¨è¿™é‡Œï¼Œ`Furion` å®˜æ–¹æ¨èä½¿ç”¨ `Serilog` æ—¥å¿—ç»„ä»¶ï¼Œä¸ºæ­¤ï¼Œ`Furion` æä¾›äº† `Furion.Extras.Logging.Serilog` æ‹“å±•åŒ…ï¼Œæ–¹ä¾¿å¿«é€Ÿå’Œ `Furion` æ¡†æ¶ç»“åˆã€‚

### 18.5.1 `Serilog` æ‹“å±•åŒ…ä½¿ç”¨

- å®‰è£… `Furion.Extras.Logging.Serilog` æ‹“å±•åŒ…

åœ¨ `Furion.Core` å±‚å®‰è£… `Furion.Extras.Logging.Serilog` æ‹“å±•åŒ…

- åœ¨ `Program.cs` ä¸­è°ƒç”¨ `UseSerilogDefault()`

`.NET5` ç‰ˆæœ¬ï¼š

```cs showLineNumbers  {21}
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Hosting;

namespace Furion.Web.Entry
{
    public class Program
    {
        public static void Main(string[] args)
        {
            CreateHostBuilder(args).Build().Run();
        }

        public static IHostBuilder CreateHostBuilder(string[] args)
        {
            return Host.CreateDefaultBuilder(args)
                .ConfigureWebHostDefaults(webBuilder =>
                {
                    webBuilder.Inject()
                        .UseStartup<Startup>();
                })
                .UseSerilogDefault();
        }
    }
}
```

`.NET6 ç‰ˆæœ¬`ï¼š

```cs showLineNumbers  {2}
var builder = WebApplication.CreateBuilder(args).Inject();
builder.Host.UseSerilogDefault();
//....
```

:::important ç‰¹åˆ«æ³¨æ„

`.UseSerilogDefault()` é»˜è®¤é›†æˆäº† `æ§åˆ¶å°` å’Œ `æ–‡ä»¶` æ–¹å¼ã€‚å¦‚éœ€è‡ªå®šä¹‰å†™å…¥ï¼Œåˆ™ä¼ å…¥éœ€è¦å†™å…¥çš„ä»‹è´¨å³å¯ï¼š

```cs showLineNumbers
.UseSerilogDefault(config =>
{
    config.WriteTo.Console(outputTemplate: "[{Timestamp:HH:mm:ss} {Level:u3}] {Message:lj} {Properties:j}{NewLine}{Exception}")
          .WriteTo.File("log.log", rollingInterval: RollingInterval.Day, rollOnFileSizeLimit: true);
});
```

:::

:::important æ‹“å±•ï¼šå¯æŒ‰æ—¥å¿—çº§åˆ« å•ç‹¬è¾“å‡º

```cs showLineNumbers
.UseSerilogDefault(config =>//é»˜è®¤é›†æˆäº† æ§åˆ¶å° å’Œ æ–‡ä»¶ æ–¹å¼ã€‚å¦‚éœ€è‡ªå®šä¹‰å†™å…¥ï¼Œåˆ™ä¼ å…¥éœ€è¦å†™å…¥çš„ä»‹è´¨å³å¯ï¼š
 {
     string date = DateTime.Now.ToString("yyyy-MM-dd");//æŒ‰æ—¶é—´åˆ›å»ºæ–‡ä»¶å¤¹
     string outputTemplate = "{NewLine}ã€{Level:u3}ã€‘{Timestamp:yyyy-MM-dd HH:mm:ss.fff}" +
     "{NewLine}#Msg#{Message:lj}" +
     "{NewLine}#Pro #{Properties:j}" +
     "{NewLine}#Exc#{Exception}" +
     new string('-', 50);//è¾“å‡ºæ¨¡æ¿

     ///1.è¾“å‡ºæ‰€æœ‰restrictedToMinimumLevelï¼šLogEventLevelç±»å‹
     config
         //.MinimumLevel.Debug() // æ‰€æœ‰Sinkçš„æœ€å°è®°å½•çº§åˆ«
         //.MinimumLevel.Override("Microsoft", LogEventLevel.Fatal)
         //.Enrich.FromLogContext()
         .WriteTo.Console(outputTemplate: outputTemplate)
         .WriteTo.File($"_log/{date}/application.log",
                outputTemplate: outputTemplate,
                 restrictedToMinimumLevel: LogEventLevel.Information,
                 rollingInterval: RollingInterval.Day,//æ—¥å¿—æŒ‰æ—¥ä¿å­˜ï¼Œè¿™æ ·ä¼šåœ¨æ–‡ä»¶åç§°åè‡ªåŠ¨åŠ ä¸Šæ—¥æœŸåç¼€
                 //rollOnFileSizeLimit: true,          // é™åˆ¶å•ä¸ªæ–‡ä»¶çš„æœ€å¤§é•¿åº¦
                 //retainedFileCountLimit: 10,         // æœ€å¤§ä¿å­˜æ–‡ä»¶æ•°,ç­‰äºnullæ—¶æ°¸è¿œä¿ç•™æ–‡ä»¶ã€‚
                 //fileSizeLimitBytes: 10 * 1024,      // æœ€å¤§å•ä¸ªæ–‡ä»¶å¤§å°
                 encoding: Encoding.UTF8            // æ–‡ä»¶å­—ç¬¦ç¼–ç 
             )

     #region 2.æŒ‰LogEventLevel.è¾“å‡ºç‹¬ç«‹å‘å¸ƒ/å•æ–‡ä»¶

        ///2.1ä»…è¾“å‡º LogEventLevel.Debug ç±»å‹
        .WriteTo.Logger(lg => lg.Filter.ByIncludingOnly(evt => evt.Level == LogEventLevel.Debug)//ç­›é€‰è¿‡æ»¤
            .WriteTo.File($"_log/{date}/{LogEventLevel.Debug}.log",
                outputTemplate: outputTemplate,
                rollingInterval: RollingInterval.Day,//æ—¥å¿—æŒ‰æ—¥ä¿å­˜ï¼Œè¿™æ ·ä¼šåœ¨æ–‡ä»¶åç§°åè‡ªåŠ¨åŠ ä¸Šæ—¥æœŸåç¼€
                encoding: Encoding.UTF8            // æ–‡ä»¶å­—ç¬¦ç¼–ç 
             )
         )

        ///2.2ä»…è¾“å‡º LogEventLevel.Error ç±»å‹
        .WriteTo.Logger(lg => lg.Filter.ByIncludingOnly(evt => evt.Level == LogEventLevel.Error)//ç­›é€‰è¿‡æ»¤
            .WriteTo.File($"_log/{date}/{LogEventLevel.Error}.log",
                outputTemplate: outputTemplate,
                rollingInterval: RollingInterval.Day,//æ—¥å¿—æŒ‰æ—¥ä¿å­˜ï¼Œè¿™æ ·ä¼šåœ¨æ–‡ä»¶åç§°åè‡ªåŠ¨åŠ ä¸Šæ—¥æœŸåç¼€
                encoding: Encoding.UTF8            // æ–‡ä»¶å­—ç¬¦ç¼–ç 
             )
         )

     #endregion æŒ‰LogEventLevel ç‹¬ç«‹å‘å¸ƒ/å•æ–‡ä»¶

         ;
 });
```

:::

- æ›¿æ¢ `appsetting.json` é»˜è®¤æ—¥å¿—å†…å®¹

```json showLineNumbers
"Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft": "Warning",
      "Microsoft.Hosting.Lifetime": "Information",
      "Microsoft.EntityFrameworkCore": "Information"
    }
  }
```

æ›¿æ¢ä¸ºï¼š

```json showLineNumbers
"Serilog": {
    "MinimumLevel": {
      "Default": "Information",
      "Override": {
        "System": "Warning",
        "Microsoft": "Warning",
        "Microsoft.Hosting.Lifetime": "Information",
        "Microsoft.EntityFrameworkCore": "Information"
      }
    }
  }
```

### 18.5.2 è®°å½•è¯·æ±‚æ—¥å¿—

`Serilog` æ—¥å¿—ç»„ä»¶ä¹Ÿæä¾›äº†éå¸¸æ–¹ä¾¿å¿«æ·çš„è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶ï¼Œåªéœ€è¦åœ¨ `Startup.cs` ä¸­å¯ç”¨å³å¯ã€‚å¦‚ï¼š

```cs showLineNumbers
public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
 {
     app.UseStaticFiles();
     app.UseSerilogRequestLogging();    // å¿…é¡»åœ¨ UseStaticFiles å’Œ UseRouting ä¹‹é—´
     app.UseRouting();
 }
```

## 18.6 æ—¥å¿—ç¤ºä¾‹

:::warning é»˜è®¤æ—¥å¿—æ–‡ä»¶è¾“å‡ºè·¯å¾„

å¦‚æœæ˜¯åœ¨å¼€å‘ç¯å¢ƒï¼Œåˆ™é»˜è®¤è¾“å‡ºåœ¨ `Debug` ç›®å½•ä¸‹ï¼Œå¦‚æœæ˜¯ç”Ÿæˆç¯å¢ƒï¼ˆå‘å¸ƒåä»£ç ï¼‰ï¼Œåˆ™åœ¨æ ¹ç›®å½•ä¸‹ã€‚

:::

ä¸‹é¢ä¾¿æ˜¯æ—¥å¿—è¾“å‡ºæ—¥å¿—çš„æ¨¡æ¿ï¼Œæ”¯æŒå„ç§è‡ªå®šä¹‰æ–¹å¼

```bash showLineNumbers
2020-12-21 15:54:43.775 +08:00 [INF] Application started. Press Ctrl+C to shut down.
2020-12-21 15:54:43.897 +08:00 [INF] Hosting environment: Development
2020-12-21 15:54:43.899 +08:00 [INF] Content root path: D:\MONK\Furion\samples\Furion.Web.Entry
2020-12-21 15:55:00.651 +08:00 [WRN] Sensitive data logging is enabled. Log entries and exception messages may include sensitive application data; this mode should only be enabled during development.
2020-12-21 15:55:00.817 +08:00 [INF] Entity Framework Core 5.0.1 initialized 'DefaultDbContext' using provider 'Microsoft.EntityFrameworkCore.Sqlite' with options: SensitiveDataLoggingEnabled DetailedErrorsEnabled MaxPoolSize=100 MigrationsAssembly=Furion.Database.Migrations
2020-12-21 15:55:01.711 +08:00 [WRN] Compiling a query which loads related collections for more than one collection navigation either via 'Include' or through projection but no 'QuerySplittingBehavior' has been configured. By default Entity Framework will use 'QuerySplittingBehavior.SingleQuery' which can potentially result in slow query performance. See https://go.microsoft.com/fwlink/?linkid=2134277 for more information. To identify the query that's triggering this warning call 'ConfigureWarnings(w => w.Throw(RelationalEventId.MultipleCollectionIncludeWarning))'
2020-12-21 15:55:01.919 +08:00 [INF] Executed DbCommand (31ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT "p"."Id", "p"."Name", "p"."Age", "p"."Address", "p0"."PhoneNumber", "p0"."QQ", "p"."CreatedTime", "p0"."Id", "c"."Id", "c"."Name", "c"."Gender", "t"."Id", "t"."Name", "t"."PersonsId", "t"."PostsId"
FROM "Person" AS "p"
LEFT JOIN "PersonDetail" AS "p0" ON "p"."Id" = "p0"."PersonId"
LEFT JOIN "Children" AS "c" ON "p"."Id" = "c"."PersonId"
LEFT JOIN (
    SELECT "p2"."Id", "p2"."Name", "p1"."PersonsId", "p1"."PostsId"
    FROM "PersonPost" AS "p1"
    INNER JOIN "Post" AS "p2" ON "p1"."PostsId" = "p2"."Id"
) AS "t" ON "p"."Id" = "t"."PersonsId"
ORDER BY "p"."Id", "p0"."Id", "c"."Id", "t"."PersonsId", "t"."PostsId", "t"."Id"
2020-12-21 15:55:25.354 +08:00 [INF] Executed DbCommand (3ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT "p"."Id", "p"."Name", "p"."Age", "p"."Address", "p0"."PhoneNumber", "p0"."QQ", "p"."CreatedTime", "p0"."Id", "c"."Id", "c"."Name", "c"."Gender", "t"."Id", "t"."Name", "t"."PersonsId", "t"."PostsId"
FROM "Person" AS "p"
LEFT JOIN "PersonDetail" AS "p0" ON "p"."Id" = "p0"."PersonId"
LEFT JOIN "Children" AS "c" ON "p"."Id" = "c"."PersonId"
LEFT JOIN (
    SELECT "p2"."Id", "p2"."Name", "p1"."PersonsId", "p1"."PostsId"
    FROM "PersonPost" AS "p1"
    INNER JOIN "Post" AS "p2" ON "p1"."PostsId" = "p2"."Id"
) AS "t" ON "p"."Id" = "t"."PersonsId"
ORDER BY "p"."Id", "p0"."Id", "c"."Id", "t"."PersonsId", "t"."PostsId", "t"."Id"
2020-12-21 15:58:27.328 +08:00 [INF] Application started. Press Ctrl+C to shut down.
2020-12-21 15:58:27.442 +08:00 [INF] Hosting environment: Development
2020-12-21 15:58:27.444 +08:00 [INF] Content root path: D:\MONK\Furion\samples\Furion.Web.Entry
2020-12-21 15:58:27.909 +08:00 [INF] HTTP GET / responded 200 in 457.0657 ms
2020-12-21 15:58:33.336 +08:00 [INF] HTTP GET /api/index.html responded 200 in 95.9277 ms
2020-12-21 15:58:34.187 +08:00 [INF] HTTP GET /swagger/Default/swagger.json responded 200 in 674.9800 ms
```

## 18.7 æ‰“å°æ—¥å¿—åˆ° `Swagger` ä¸­

åœ¨ `Furion` æ¡†æ¶ä¸­é»˜è®¤é›†æˆäº† `MiniProfiler` ç»„ä»¶å¹¶ä¸ `Swagger` è¿›è¡Œäº†ç»“åˆï¼Œå¦‚éœ€æ‰“å°æ—¥å¿—æˆ–è°ƒè¯•ä»£ç ï¼Œåªéœ€è°ƒç”¨ä»¥ä¸‹æ–¹æ³•å³å¯ï¼š

```cs showLineNumbers
App.PrintToMiniProfiler("åˆ†ç±»", "çŠ¶æ€", "è¦æ‰“å°çš„æ¶ˆæ¯");
```

## 18.8 åœ¨åå°ä»»åŠ¡ä¸­ä½¿ç”¨

ç”±äº `DbContext` é»˜è®¤æ³¨å†Œä¸º `Scoped` ç”Ÿå­˜å‘¨æœŸï¼Œæ‰€ä»¥åœ¨åå°ä»»åŠ¡ä¸­ä½¿ç”¨ `IServiceScopeFactory` è·å–æ‰€æœ‰æœåŠ¡ï¼Œå¦‚ï¼š

```cs showLineNumbers
public class JobService : BackgroundService
{
    // æ—¥å¿—å¯¹è±¡
    private readonly ILogger<JobService> _logger;

    // æœåŠ¡å·¥å‚
    private readonly IServiceScopeFactory _scopeFactory;
    public JobService(ILogger<JobService> logger
        , IServiceScopeFactory scopeFactory)
    {
        _logger = logger;
        _scopeFactory = scopeFactory;
    }

    protected override Task ExecuteAsync(CancellationToken stoppingToken)
    {
        _logger.LogInformation("å†™æ—¥å¿—~~");

        using (var scope = _scopeFactory.CreateScope())
        {
            var services = scope.ServiceProvider;

            // è·å–æ•°æ®åº“ä¸Šä¸‹æ–‡
            var dbContext = Db.GetDbContext(services);

            // è·å–ä»“å‚¨
            var respository = Db.GetRepository<Person>(services);

            // è§£æå…¶ä»–æœåŠ¡
            var otherService = services.GetService<XXX>();
        }

        return Task.CompletedTask;
    }
}
```

## 18.9 å…³äºæ—¥å¿—æ–‡ä»¶é‡å¤ç”Ÿæˆé—®é¢˜

æ—¥å¿—é‡å¤ç”Ÿæˆçš„åŸå› æ˜¯åˆ›å»ºäº†å¤šä¸ª `ILogger` å¯¹è±¡å¯¼è‡´çš„ï¼Œé€šå¸¸æœ‰ä¸¤ç§è§£å†³æ–¹æ³•ï¼š

1. è®¾ç½® `å­—ç¬¦ä¸²` æ‹“å±•æ—¥å¿—ä½œç”¨åŸŸ

```cs showLineNumbers
"æ—¥å¿—å†…å®¹".SetLoggerScoped(serviceProvider).LogInformation();
```

2. ä¿®æ”¹ `Program.cs` æ³¨å†Œæ–¹å¼

```cs showLineNumbers  {19}
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Hosting;

namespace FurStart
{
    public class Program
    {
        public static void Main(string[] args)
        {
            CreateHostBuilder(args).Build().Run();
        }

        public static IHostBuilder CreateHostBuilder(string[] args) =>
            Host.CreateDefaultBuilder(args)
                .ConfigureWebHostDefaults(webBuilder =>
                {
                    webBuilder
                    .UseStartup<Startup>()
                    .UseSerilogDefault();   // å†™åˆ°è¿™é‡Œ
                })
             //   .UseSerilogDefault(); // æ³¨é‡Š
    }
}
```

## 18.10 å¤šçº¿ç¨‹å…±äº«ä½œç”¨åŸŸ

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„ `å­—ç¬¦ä¸²` å’Œ `å®ä½“` æ‹“å±•éƒ½æœ‰è‡ªå·±ç‹¬ç«‹ç»´æŠ¤çš„ `ServiceProvider` ä½œç”¨åŸŸã€‚

åœ¨ `Web` è¯·æ±‚ä¸­ï¼Œé»˜è®¤æ˜¯ `HttpContext.RequestServices`ï¼Œä½†åœ¨ `é Web`ï¼Œå¦‚å¤šçº¿ç¨‹æ“ä½œï¼Œåå°ä»»åŠ¡ï¼Œäº‹ä»¶æ€»çº¿ç­‰åœºæ™¯ä¸‹ä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„ä½œç”¨åŸŸï¼Œå®é™…ä¸Šè¿™æ˜¯éå¸¸ä¸å¿…è¦çš„å†…å­˜å¼€é”€ã€‚

è¿™æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦é€šè¿‡ `.SetXXXScoped(service)` å…±äº«å½“å‰æœåŠ¡æä¾›å™¨ä½œç”¨åŸŸå³å¯ï¼Œå¦‚ï¼š

```cs showLineNumbers
Scoped.Create(async (fac, scope) => {
   "å†™æ—¥å¿—".SetLoggerScoped(scope.ServiceProvider).LogInformation();
});
```

## 18.11 é™æ€ `Default` æ–¹å¼æ„å»º

```cs showLineNumbers
StringLoggingPart.Default.SetMessage("è¿™æ˜¯ä¸€ä¸ªæ—¥å¿—").LogInformation();
```

## 18.12 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::

---

:::note äº†è§£æ›´å¤š

æƒ³äº†è§£æ›´å¤š `æ—¥å¿—` çŸ¥è¯†å¯æŸ¥é˜… [ASP.NET Core - æ—¥å¿—](https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/logging/?view=aspnetcore-5.0) ç« èŠ‚ å’Œ [Serilog](https://serilog.net/) æ–‡æ¡£ã€‚

:::
