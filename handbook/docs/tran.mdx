---
id: tran
title: 9.27 äº‹åŠ¡å’Œå·¥ä½œå•å…ƒ
sidebar_label: 9.27 äº‹åŠ¡å’Œå·¥ä½œå•å…ƒ (UnitOfWork)
---

import Tag from "@site/src/components/Tag.js";
import useBaseUrl from "@docusaurus/useBaseUrl";
import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

<details>
  <summary>ğŸ“ æ¨¡å—æ›´æ–°æ—¥å¿—</summary>
  <div>
<div>

- **é—®é¢˜ä¿®å¤**

  - &nbsp;<Tag>ä¿®å¤</Tag> `Scoped.CreateUowAsync` ä½œç”¨åŸŸå·¥ä½œå•å…ƒå¼‚å¸¸æ— æ³•å›æ»šé—®é¢˜ <sup>4.8.8.44</sup> <sup>â±ï¸2023.09.23</sup> [#I833I9](https://gitee.com/dotnetchina/Furion/issues/I833I9)

</div>
  </div>
</details>

## 9.27.1 äº‹åŠ¡

äº‹åŠ¡æŒ‡ä½œä¸ºå•ä¸ªé€»è¾‘å·¥ä½œå•å…ƒæ‰§è¡Œçš„ä¸€ç³»åˆ—æ“ä½œï¼Œè¦ä¹ˆ**å®Œå…¨åœ°æ‰§è¡Œï¼Œè¦ä¹ˆå®Œå…¨åœ°ä¸æ‰§è¡Œ**ã€‚

ç®€å•çš„è¯´ï¼Œäº‹åŠ¡å°±æ˜¯å¹¶å‘æ§åˆ¶çš„å•ä½ï¼Œæ˜¯ç”¨æˆ·å®šä¹‰çš„ä¸€ä¸ªæ“ä½œåºåˆ—ã€‚ è€Œä¸€ä¸ªé€»è¾‘å·¥ä½œå•å…ƒè¦æˆä¸ºäº‹åŠ¡ï¼Œå°±å¿…é¡»æ»¡è¶³ `ACID` å±æ€§ã€‚

- `A`ï¼šåŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šäº‹åŠ¡ä¸­çš„æ“ä½œè¦ä¹ˆéƒ½ä¸åšï¼Œè¦ä¹ˆå°±å…¨åš
- `C`ï¼šä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šäº‹åŠ¡æ‰§è¡Œçš„ç»“æœå¿…é¡»æ˜¯ä»æ•°æ®åº“ä»ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€è½¬æ¢åˆ°å¦ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€
- `I`ï¼šéš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸èƒ½è¢«å…¶ä»–äº‹åŠ¡å¹²æ‰°
- `D`ï¼šæŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šä¸€ä¸ªäº‹åŠ¡ä¸€æ—¦æäº¤ï¼Œå®ƒå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜å°±åº”è¯¥æ˜¯æ°¸ä¹…æ€§çš„

## 9.27.2 å·¥ä½œå•å…ƒ

ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¸ºäº†ä¿è¯ä¸€æ¬¡å®Œæ•´çš„åŠŸèƒ½æ“ä½œæ‰€äº§ç”Ÿçš„ä¸€ç³»åˆ—æäº¤æ•°æ®çš„å®Œæ•´æ€§ï¼Œèµ·ç€äº‹åŠ¡çš„ä½œç”¨ã€‚åœ¨è®¡ç®—æœºé¢†åŸŸä¸­ï¼Œå·¥ä½œå•å…ƒé€šå¸¸ç”¨ `UnitOfWork` åç§°è¡¨ç¤ºã€‚

é€šå¸¸æˆ‘ä»¬ä¿è¯ç”¨æˆ·çš„æ¯ä¸€æ¬¡è¯·æ±‚éƒ½æ˜¯å¤„äºåœ¨ä¸€ä¸ªåŠŸèƒ½å•å…ƒä¸­ï¼Œä¹Ÿå°±æ˜¯å·¥ä½œå•å…ƒã€‚

## 9.27.3 å¦‚ä½•ä½¿ç”¨

### 9.27.3.1 `[UnitOfWork]` è‡ªåŠ¨ç®¡ç†

åœ¨ `Furion` æ¡†æ¶ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨æ§åˆ¶å™¨ Action ä¸­è´´ `[UnitOfWork]` ç‰¹æ€§å³å¯å¼€å¯å·¥ä½œå•å…ƒæ¨¡å¼ï¼Œä¿è¯äº†æ¯ä¸€æ¬¡è¯·æ±‚éƒ½æ˜¯ä¸€ä¸ª `å·¥ä½œå•å…ƒ`ï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ã€‚

- **å•åº“æ“ä½œ**

ä¸‹é¢æ–¹å¼æ”¯æŒæ‰€æœ‰å…³ç³»å‹æ•°æ®åº“ç±»å‹

```cs showLineNumbers {1}
[UnitOfWork]    // ç”±äºå‡ºç°é”™è¯¯ï¼Œæ‰€ä»¥æ‰€æœ‰æ•°æ®åº“å˜æ›´éƒ½ä¼šè‡ªåŠ¨å›æ»š
public async Task æµ‹è¯•ç¯å¢ƒäº‹åŠ¡(int id)
{
    // å„ç§å¥‡è‘©æ•°æ®åº“æ“ä½œ
    await _personRepository.DeleteNowAsync(id);

    // å…¶ä»–æ•°æ®åº“æ“ä½œã€‚ã€‚

    // æ•…æ„å‡ºé”™
    var d = await _personRepository.SqlQueriesAsync("select * from persion2 d");
}
```

- **å¤šåº“æ“ä½œ**

æ”¯æŒå„ç§å¥‡è‘©çš„ `ORM`ï¼ŒåŒ…æ‹¬ `ADO.NET`ï¼Œ`EFCore` ç­‰ç¬¬ä¸‰æ–¹ï¼Œ**æ”¯æŒæ‰€æœ‰å…³ç³»å‹æ•°æ®åº“ç±»å‹ä½†ä¸æ”¯æŒ `Sqlite`**

```cs showLineNumbers
[UnitOfWork(UseAmbientTransaction = true)]    // ç”±äºå‡ºç°é”™è¯¯ï¼Œæ‰€ä»¥æ‰€æœ‰æ•°æ®åº“å˜æ›´éƒ½ä¼šè‡ªåŠ¨å›æ»š
public async Task æµ‹è¯•ç¯å¢ƒäº‹åŠ¡(int id)
{
    // å„ç§å¥‡è‘©æ•°æ®åº“æ“ä½œ
    await _personRepository.DeleteNowAsync(id);

    // å…¶ä»–æ•°æ®åº“æ“ä½œã€‚ã€‚

    // æ•…æ„å‡ºé”™
    var d = await _personRepository.SqlQueriesAsync("select * from persion2 d");
}
```

- `UnitOfWork` å†…ç½®é…ç½®ï¼š
  - `UseAmbientTransaction`ï¼šæ˜¯å¦å¼€å¯åˆ†å¸ƒå¼ç¯å¢ƒäº‹åŠ¡ï¼Œ`bool` ç±»å‹ï¼Œé»˜è®¤ `false`ï¼Œ**ä¸æ”¯æŒ `Sqlite`**
  - `TransactionScope`ï¼šé…ç½®åˆ†å¸ƒå¼ç¯å¢ƒäº‹åŠ¡èŒƒå›´ï¼Œ`TransactionScopeOption` ç±»å‹ï¼Œå½“ `UseAmbientTransaction` ä¸º `true` æœ‰æ•ˆ
  - `TransactionIsolationLevel`ï¼šé…ç½®åˆ†å¸ƒå¼ç¯å¢ƒäº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œ`IsolationLevel` ç±»å‹ï¼Œå½“ `UseAmbientTransaction` ä¸º `true` æœ‰æ•ˆ
  - `TransactionTimeout`ï¼šé…ç½®åˆ†å¸ƒå¼ç¯å¢ƒäº‹åŠ¡æ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼Œ`int` ç±»å‹ï¼Œå½“ `UseAmbientTransaction` ä¸º `true` æœ‰æ•ˆ
  - `TransactionScopeAsyncFlow`ï¼šé…ç½®åˆ†å¸ƒå¼ç¯å¢ƒäº‹åŠ¡å¼‚æ­¥æµæ”¯æŒï¼Œ`TransactionScopeAsyncFlowOption` ç±»å‹ï¼Œå½“ `UseAmbientTransaction` ä¸º `true` æœ‰æ•ˆ
  - `EnsureTransaction`ï¼šå¼ºåˆ¶ä½¿å­—ç¬¦ä¸² `sql` æ‹“å±•äº‹åŠ¡æœ‰æ•ˆï¼Œ`bool` ç±»å‹ï¼Œé»˜è®¤ `false`

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 3.7.3 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

å¦‚ä½¿ç”¨é `EFCore` ORM æ¡†æ¶ï¼Œå¯å®ç° `IUnitOfWork` æ¥å£ä¹‹åè°ƒç”¨ `services.AddUnitOfWork<TUnitOfWork>()` æ³¨å†Œå³å¯ï¼Œå¦‚ç¤ºä¾‹ä»£ç ï¼š

```cs showLineNumbers {8,30,41,52,63}
using Microsoft.AspNetCore.Mvc.Filters;

namespace Furion.DatabaseAccessor;

/// <summary>
/// SqlSugar å·¥ä½œå•å…ƒå®ç°
/// </summary>
public sealed class SqlSugarUnitOfWork : IUnitOfWork
{
    /// <summary>
    /// SqlSugar å¯¹è±¡
    /// </summary>
    private readonly ISqlSugarClient _sqlSugarClient;

    /// <summary>
    /// æ„é€ å‡½æ•°
    /// </summary>
    /// <param name="sqlSugarClient"></param>
    public SqlSugarUnitOfWork(ISqlSugarClient sqlSugarClient)
    {
        _sqlSugarClient = sqlSugarClient;
    }

    /// <summary>
    /// å¼€å¯å·¥ä½œå•å…ƒå¤„ç†
    /// </summary>
    /// <param name="context"></param>
    /// <param name="unitOfWork"></param>
    /// <exception cref="NotImplementedException"></exception>
    public void BeginTransaction(FilterContext context, UnitOfWorkAttribute unitOfWork)
    {
        _sqlSugarClient.AsTenant().BeginTran();
    }

    /// <summary>
    /// æäº¤å·¥ä½œå•å…ƒå¤„ç†
    /// </summary>
    /// <param name="resultContext"></param>
    /// <param name="unitOfWork"></param>
    /// <exception cref="NotImplementedException"></exception>
    public void CommitTransaction(FilterContext resultContext, UnitOfWorkAttribute unitOfWork)
    {
        _sqlSugarClient.AsTenant().CommitTran();
    }

    /// <summary>
    /// å›æ»šå·¥ä½œå•å…ƒå¤„ç†
    /// </summary>
    /// <param name="resultContext"></param>
    /// <param name="unitOfWork"></param>
    /// <exception cref="NotImplementedException"></exception>
    public void RollbackTransaction(FilterContext resultContext, UnitOfWorkAttribute unitOfWork)
    {
        _sqlSugarClient.AsTenant().RollbackTran();
    }

    /// <summary>
    /// æ‰§è¡Œå®Œæ¯•ï¼ˆæ— è®ºæˆåŠŸå¤±è´¥ï¼‰
    /// </summary>
    /// <param name="context"></param>
    /// <param name="resultContext"></param>
    /// <exception cref="NotImplementedException"></exception>
    public void OnCompleted(FilterContext context, FilterContext resultContext)
    {
        _sqlSugarClient.Dispose();
    }
}
```

ä¹‹åæ³¨å†Œå³å¯ï¼š

```cs showLineNumbers
services.AddUnitOfWork<SqlSugarUnitOfWork>();
```

:::tip å°çŸ¥è¯†-å¦‚ä½•åˆ¤æ–­æ˜¯å¦å¼€å¯äº†åˆ†å¸ƒå¼ç¯å¢ƒäº‹åŠ¡

æœ‰æ—¶å€™æˆ‘ä»¬è‡ªå®šä¹‰äº†å·¥ä½œå•å…ƒä¹‹åï¼Œä¸ªåˆ« `ORM` ä¸æ”¯æŒåˆ†å¸ƒå¼ç¯å¢ƒäº‹åŠ¡ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°æ‰§è¡Œé”™è¯¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `System.Transactions.Transaction.Current != null` æ¥åˆ¤æ–­æ˜¯å¦å¯ç”¨äº†åˆ†å¸ƒå¼ç¯å¢ƒäº‹åŠ¡ï¼Œä¸ç­‰äº `null` åˆ™ä¸ºå¯ç”¨ï¼Œå¦åˆ™æœªå¯ç”¨ã€‚

:::

### 9.27.3.2 `EnsureTransaction()` æ–¹æ³• âœ¨

æœ‰äº›æ—¶å€™æˆ‘ä»¬é€šè¿‡é™æ€ç±»æˆ–è€…å…¶ä»–æ–¹å¼ä¸å°å¿ƒåˆ›å»ºäº†æ–°çš„ `DbContext` å®ä¾‹ï¼Œè¿™æ—¶å€™è´´äº† `[UnitOfWork]` ä¹Ÿä¸è§èµ·æ•ˆï¼Œè¿™æ—¶å€™å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•æ¥ç¡®è®¤äº‹åŠ¡æ˜¯å¦æœ‰æ•ˆï¼š

```cs showLineNumbers
repository.EnsureTransaction();
```

**å¦‚æœä¸å–œæ¬¢æ‰‹åŠ¨æ–¹å¼ä¹Ÿå¯ä»¥é€šè¿‡ `[UnitOfWork(true)]` å¼€å¯æ­¤åŠŸèƒ½ã€‚**

è¯¥æ–¹æ³•ä¼šå°†å½“å‰ä»“å‚¨æ·»åŠ åˆ°æ•°æ®åº“ä¸Šä¸‹æ–‡æ± ä¸­ï¼Œå¹¶ç¡®ä¿äº‹åŠ¡å¯ç”¨ã€‚

### 9.27.3.2 æ‰‹åŠ¨ç®¡ç†

<Tabs
  defaultValue="one"
  values={[
    { label: "ç¤ºä¾‹ä¸€", value: "one" },
    { label: "ç¤ºä¾‹äºŒ", value: "two" },
    { label: "ç¤ºä¾‹ä¸‰ï¼ˆåˆ†å¸ƒå¼ï¼‰", value: "three" },
  ]}
>
  <TabItem value="one">

```cs showLineNumbers
// å¼€å¯äº‹åŠ¡
using (var transaction = _testRepository.Database.BeginTransaction())
{
    try
    {
        _testRepository.Insert(new Blog { Url = "http://blogs.msdn.com/dotnet" });
        _testRepository.SaveNow();

        _testRepository.Insert(new Blog { Url = "http://blogs.msdn.com/visualstudio" });
        _testRepository.SaveNow();

        var blogs = _testRepository.Entity
                .OrderBy(b => b.Url)
                .ToList();

        // æäº¤äº‹åŠ¡
        transaction.Commit();
     }
     catch (Exception)
     {
        // å›æ»šäº‹åŠ¡
        // transaction.RollBack(); // æ–°ç‰ˆæœ¬è‡ªåŠ¨å›æ»šäº†
     }
}
```

  </TabItem>
  <TabItem value="two">

```cs showLineNumbers
var options = new DbContextOptionsBuilder<DefaultDbContext>()
    .UseSqlServer(new SqlConnection(connectionString))
    .Options;

// åˆ›å»ºè¿æ¥å­—ç¬¦ä¸²
using (var context1 = new DefaultDbContext(options))
{
    // å¼€å¯äº‹åŠ¡
    using (var transaction = context1.Database.BeginTransaction())
    {
        try
        {
            _testRepository.Insert(new Blog { Url = "http://blogs.msdn.com/dotnet" });
            _testRepository.SaveNow();

            context1.Blogs.Add(new Blog { Url = "http://blogs.msdn.com/dotnet" });
            context1.SaveChanges();

            // åˆ›å»ºæ–°çš„è¿æ¥å¯¹è±¡
            using (var context2 = new DefaultDbContext(options))
            {
                // å…±äº«è¿æ¥äº‹åŠ¡
                context2.Database.UseTransaction(transaction.GetDbTransaction());

                var blogs = context2.Blogs
                    .OrderBy(b => b.Url)
                    .ToList();
            }

            // æäº¤äº‹åŠ¡
            transaction.Commit();
        }
        catch (Exception)
        {
            // å›æ»šäº‹åŠ¡
            // transaction.RollBack(); // æ–°ç‰ˆæœ¬è‡ªåŠ¨å›æ»šäº†
        }
    }
}
```

  </TabItem>
  <TabItem value="three">

```cs showLineNumbers  {1-3}
// å¼€å¯åˆ†å¸ƒå¼äº‹åŠ¡
// å¦‚æœäº‹åŠ¡åŒ…è£¹çš„ä»£ç ä¸­åŒ…å«å¼‚æ­¥ async/awaitï¼Œé‚£ä¹ˆéœ€è¦è®¾ç½® TransactionScopeAsyncFlowOption.Enabled = true
using (var scope = new TransactionScope(TransactionScopeOption.Required, new TransactionOptions { IsolationLevel = IsolationLevel.ReadCommitted }))
{
    using (var connection = new SqlConnection(connectionString))
    {
        connection.Open();

        try
        {
            // è¿™é‡Œæ˜¯ Ado.NET æ“ä½œ
            var command = connection.CreateCommand();
            command.CommandText = "DELETE FROM dbo.Blogs";
            command.ExecuteNonQuery();

            // åˆ›å»ºEF Core æ•°æ®åº“ä¸Šä¸‹æ–‡
            var options = new DbContextOptionsBuilder<BloggingContext>()
                .UseSqlServer(connection)
                .Options;
            using (var context = new BloggingContext(options))
            {
                context.Blogs.Add(new Blog { Url = "http://blogs.msdn.com/dotnet" });
                context.SaveChanges();
            }

            // æ¡†æ¶å°è£…çš„ä»“å‚¨
            _testRepository.Insert(new Blog { Url = "http://blogs.msdn.com/dotnet" });
            _testRepository.SaveChanges();

           // æäº¤äº‹åŠ¡
            scope.Complete();
        }
        catch (System.Exception)
        {
            // è‡ªåŠ¨å›æ»š
        }
    }
}
```

  </TabItem>
</Tabs>

### 9.27.3.3 `EnableRetryOnFailure` é”™è¯¯å¤„ç†

:::caution ç‰¹åˆ«æ³¨æ„

å¦‚æœä½¿ç”¨çš„æ˜¯ `EFCore` æ•°æ®åº“ä¸”å¯ç”¨äº† `EnableRetryOnFailure()` åŠŸèƒ½ï¼Œé‚£ä¹ˆ `[UnitOfWork]` å°†æŠ›å‡ºä»¥ä¸‹é”™è¯¯ï¼š

```bash showLineNumbers
InvalidOperationException: The configured execution strategy 'SqlServerRetryingExecutionStrategy' does not support user-initiated transactions.
Use the execution strategy returned by 'DbContext.Database.CreateExecutionStrategy()' to execute all the operations in the transaction as a retriable unit.
```

è¿™æ—¶å€™éœ€æ‰‹åŠ¨äº‹åŠ¡ï¼Œå¹¶åˆ›å»ºæ‰§è¡Œç­–ç•¥ï¼š`CreateExecutionStrategy`ï¼Œè¯¦æƒ…è¯·å‚è€ƒå®˜æ–¹è¯´æ˜ï¼š[https://learn.microsoft.com/zh-cn/ef/core/miscellaneous/connection-resiliency](https://learn.microsoft.com/zh-cn/ef/core/miscellaneous/connection-resiliency)

```cs showLineNumbers {2,4,8,16}
using var db = new BloggingContext();
var strategy = db.Database.CreateExecutionStrategy();

strategy.Execute(
    () =>
    {
        using var context = new BloggingContext();
        using var transaction = context.Database.BeginTransaction();

        context.Blogs.Add(new Blog { Url = "http://blogs.msdn.com/dotnet" });
        context.SaveChanges();

        context.Blogs.Add(new Blog { Url = "http://blogs.msdn.com/visualstudio" });
        context.SaveChanges();

        transaction.Commit();
    });
```

:::

## 9.27.4 å·¥ä½œå•å…ƒç‰¹æ€§è¯´æ˜

### 9.27.4.1 `[UnitOfWork]` ç‰¹æ€§

`[UnitOfWork]` ç‰¹æ€§åªèƒ½ç”¨äºæ§åˆ¶å™¨çš„ `Action` ä¸­ï¼Œä¸€æ—¦è´´äº† `[UnitOfWork]` ç‰¹æ€§åï¼Œé‚£ä¹ˆè¯¥è¯·æ±‚è‡ªåŠ¨å¯ç”¨å·¥ä½œå•å…ƒæ¨¡å¼ï¼Œè¦ä¹ˆæˆåŠŸï¼Œè¦ä¹ˆå¤±è´¥ã€‚

### 9.27.4.2 `[ManualCommit]` ç‰¹æ€§

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`Furion` æ¡†æ¶ä¼šåœ¨ä¸€æ¬¡æˆåŠŸè¯·æ±‚ä¹‹åè‡ªåŠ¨è°ƒç”¨ `SaveChanges()` æ–¹æ³•ï¼Œå¦‚æœé€‰æ‹©æ‰‹åŠ¨è°ƒç”¨ `SaveChanges()` æ–¹æ³•ï¼Œå¯ä»¥åœ¨æ§åˆ¶å™¨ `Action` ä¸­è´´ `[ManualCommit]` ç‰¹æ€§å³å¯ã€‚

## 9.27.5 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::

---

:::note äº†è§£æ›´å¤š

æƒ³äº†è§£æ›´å¤š `äº‹åŠ¡` çŸ¥è¯†å¯æŸ¥é˜… [EF Core - ä½¿ç”¨äº‹åŠ¡](https://docs.microsoft.com/zh-cn/ef/core/saving/transactions) ç« èŠ‚ã€‚

:::
