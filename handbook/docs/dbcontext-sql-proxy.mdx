---
id: dbcontext-sql-proxy
title: 9.18 Sql é«˜çº§ä»£ç†
sidebar_label: 9.18 Sql é«˜çº§ä»£ç†
---

import Tag from "@site/src/components/Tag.js";

<details>
  <summary>ğŸ“ æ¨¡å—æ›´æ–°æ—¥å¿—</summary>
  <div>
<div>

- **æ–°ç‰¹æ€§**

  - &nbsp;<Tag>æ–°å¢</Tag> **`Sql` é«˜çº§æ‹¦æˆªæ”¯æŒè¿”å› `IEnumerable<T>` å’Œ `T[]` ç±»å‹å€¼** <sup>4.8.7.5</sup> <sup>â±ï¸2023.03.07</sup> [f2ca2d3](https://gitee.com/dotnetchina/Furion/commit/f2ca2d303ea06febcc3a50df56ed03895e43c639)

<details style={{ marginLeft: 50 }}>
  <summary>æŸ¥çœ‹å˜åŒ–</summary>
  <div>

è¿‡å»ç‰ˆæœ¬å¦‚æœ**è¿”å›å¯¹è±¡ç±»å‹**åªæ”¯æŒ `List<T>`ï¼Œ`T` å’Œ `Tuple<>`ï¼Œç°å·²æ”¯æŒ `IEnumerable<T>`ã€`T[]` å’Œ `Tuple<>` æ··åˆä½“ã€‚

```cs showLineNumbers {4,7,16}
public interface ISql : ISqlDispatchProxy
{
    [SqlExecute("select * from person")]
    Person[] GetPersons();

    [SqlExecute("select * from person")]
    IEnumerable<Person> GetPersons2();

    // æ›´å¤æ‚çš„ç»„åˆ
    [SqlExecute(@"
select * from person where id = 1;
select * from person;
select * from person where id > 0;
select * from person where id > 0;
")]
    (Person, List<Person>, Person[], IEnumerable<Person>) GetPersons();
}
```

  </div>
</details>

</div>
  </div>
</details>

## 9.18.1 å…³äº `Sql` ä»£ç†

`Sql` ä»£ç†æ˜¯ `Furion` æ¡†æ¶ä¸­å¯¹ `Sql` æ“ä½œä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œé€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥å¤§å¤§æé«˜ `Sql` ä¹¦å†™æ•ˆç‡ï¼Œè€Œä¸”åæœŸææ˜“ç»´æŠ¤ã€‚

`Sql` ä»£ç†å±äº `Furion` æ¡†æ¶ä¸­ä¸€ä¸ªé«˜çº§åŠŸèƒ½ã€‚

## 9.18.2 äº†è§£ `ISqlDispatchProxy`

`ISqlDispatchProxy` æ¥å£æ˜¯ `Furion` å®ç°**è¢«ä»£ç†æ¥å£**çš„å”¯ä¸€ä¾èµ–ï¼Œä»»ä½•å…¬å¼€çš„æ¥å£ä¸€æ—¦é›†æˆäº† `ISqlDispatchProxy` æ¥å£ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¥å£å°±æ˜¯**è¢«æ‰˜ç®¡æ‹¦æˆª**çš„ `Sql` æ“ä½œæ¥å£ã€‚

ç®€å•å®šä¹‰ä¸€ä¸ª **Sql ä»£ç†æ¥å£**

```cs showLineNumbers  {1,5}
using Furion.DatabaseAccessor;

namespace Furion.Application
{
    public interface ISql : ISqlDispatchProxy
    {
    }
}
```

ä¸€æ—¦è¿™ä¸ªæ¥å£ç»§æ‰¿äº† `ISqlDispatchProxy`ï¼Œé‚£ä¹ˆå®ƒå°±ä¼š**åŠ¨æ€åˆ›å»ºæ¥å£å®ä¾‹ï¼Œè€Œä¸”æ”¯æŒä¾èµ–æ³¨å…¥/æ§åˆ¶åè½¬è·å–å®ä¾‹**ã€‚

## 9.18.3 å¼€å§‹é¢†ç•¥ `Sql` ä»£ç†

ä¸‹é¢æˆ‘å°†é€šè¿‡å¤šä¸ªä¾‹å­æ¥æ¼”ç¤º `Sql` ä»£ç†çš„ç”¨æ³•ï¼Œä¸ºä»€ä¹ˆæ¨èè¿™ç§æ–¹å¼æ“ä½œ `Sql`ã€‚

æ”¯æŒå„ç§æ–¹å¼è·å–å®ä¾‹ï¼š

### 9.18.3.1 æ„é€ å‡½æ•°æ–¹å¼

```cs showLineNumbers  {1-2}
private readonly ISql _sql;
public FurionService(ISql sql)
{
    _sql = sql;
}
```

### 9.18.3.2 æ–¹æ³•å‚æ•°æ³¨å…¥

```cs showLineNumbers  {1}
public async Task<List<PersonDto>> GetAll([FromServices] ISql, string keyword)
{
}
```

### 9.18.3.3 `Db.GetSqlDispatchProxy<ISql>()`

```cs showLineNumbers
var sql = Db.GetSqlDispatchProxy<ISql>();
```

## 9.18.4 `Sql` æ“ä½œ

### 9.18.4.1 è¿”å› `DataTable`

```cs showLineNumbers  {8,12,16,20}
using Furion.DatabaseAccessor;

namespace Furion.Application
{
    public interface ISql : ISqlDispatchProxy
    {
        // æ‰§è¡Œsqlå¹¶ä¼ å…¥å‚æ•°ï¼ŒåŸºå…ƒç±»å‹
        [SqlExecute("select * from person where id >@id and name like @name")]
        DataTable GetPerson(int id, string name);

        // æ‰§è¡Œsqlå¹¶ä¼ å…¥å‚æ•°ï¼Œå¯¹è±¡ç±»å‹
        [SqlExecute("select * from person where id >@id and name like @name")]
        DataTable GetPerson(MyParam paras);

        // æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹ sqlï¼Œæ”¯æŒè®¾ç½®å‚æ•°ç±»å‹
        [SqlExecute("exec PROP_NAME @id", CommandType = CommandType.StoredProcedure)]
        DataTable GetPerson(int id);

        // æ”¯æŒå¤šæ•°æ®åº“æ“ä½œ
        [SqlExecute("select * from person"), SqlDbContextLocator(typeof(MySqlDbContextLocator))]
        DataTable GetPerson();

        // å¼‚æ­¥æ–¹å¼
        [SqlExecute("select * from person"), SqlDbContextLocator(typeof(MySqlDbContextLocator))]
        Task<DataTable> GetPersonAsync();
    }
}
```

:::important å…³äºå‚æ•°

`Sql` ä»£ç†å‚æ•°æŸ¥æ‰¾è§„åˆ™ï¼š

å¦‚æœæ–¹æ³•çš„å‚æ•°æ˜¯ `åŸºå…ƒç±»å‹`ï¼ˆæˆ– `string`ã€`å€¼ç±»å‹`ï¼‰ï¼Œåˆ™è‡ªåŠ¨å°†è¿™äº›ç±»å‹ç»„åˆæˆ `Dictionary<string, object>` ä½œä¸º `Sql` å‚æ•°ã€‚å‘½ä»¤å‚æ•°å¯ä½¿ç”¨æ–¹æ³•åŒåå‚æ•°åŠ  `@` ç¬¦å·ã€‚

å¦‚æœæ–¹æ³•çš„å‚æ•°æ˜¯ `ç±»ç±»å‹`ï¼Œé‚£ä¹ˆè‡ªåŠ¨éå†è¯¥ç±»å…¬å¼€å®ä¾‹å±æ€§ç”Ÿæˆ `DbParameter[]` æ•°ç»„ï¼Œæ¯ä¸€ä¸ªå±æ€§åéƒ½å°†æ˜¯å‘½ä»¤å‚æ•°ï¼Œ**å¤§éƒ¨åˆ†æ•°æ®åº“æ˜¯ä¸åŒºåˆ†å¤§å°å†™ï¼Œä¸ªåˆ«æ•°æ®åº“é™¤å¤–**ï¼Œå¦‚ `Sqlite`ï¼Œå¦‚ï¼š

```cs showLineNumbers
public class MyModel
{
    public int Id {get;set;}
    public string Name {get; set;}
}
```

é‚£ä¹ˆ `sql` è¯­å¥å¯ä»¥ç›´æ¥ä½¿ç”¨å±æ€§åä½œä¸ºå‚æ•°ï¼š

```sql showLineNumbers
select * from person where id > @id and name = @name;
```

:::

### 9.18.4.2 è¿”å› `List<T>`

```cs showLineNumbers  {8,12,16,20}
using Furion.DatabaseAccessor;

namespace Furion.Application
{
    public interface ISql : ISqlDispatchProxy
    {
        // æ‰§è¡Œsqlå¹¶ä¼ å…¥å‚æ•°ï¼ŒåŸºå…ƒç±»å‹
        [SqlExecute("select * from person where id >@id and name like @name")]
        List<Person> GetPerson(int id, string name);

        // æ‰§è¡Œsqlå¹¶ä¼ å…¥å‚æ•°ï¼Œå¯¹è±¡ç±»å‹
        [SqlExecute("select * from person where id >@id and name like @name")]
        List<Person> GetPerson(MyParam paras);

        // æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹ sqlï¼Œæ”¯æŒè®¾ç½®å‚æ•°ç±»å‹
        [SqlExecute("exec PROP_NAME @id", CommandType = CommandType.StoredProcedure)]
        List<Person> GetPerson(int id);

        // æ”¯æŒå¤šæ•°æ®åº“æ“ä½œ
        [SqlExecute("select * from person"), SqlDbContextLocator(typeof(MySqlDbContextLocator)]
        List<Person> GetPerson();

        // å¼‚æ­¥æ–¹å¼
        [SqlExecute("select * from person"), SqlDbContextLocator(typeof(MySqlDbContextLocator)]
        Task<List<Person>> GetPersonAsync();
    }
}
```

### 9.18.4.3 è¿”å› `DataSet`

```cs showLineNumbers  {8-10,14-16,20-22,26-28,32-35}
using Furion.DatabaseAccessor;

namespace Furion.Application
{
    public interface ISql : ISqlDispatchProxy
    {
        // æ‰§è¡Œsqlå¹¶ä¼ å…¥å‚æ•°ï¼ŒåŸºå…ƒç±»å‹
        [SqlExecute(@"
            select * from person where id >@id and name like @name;
            select top 10 * from student where Id >@id;")]
        DataSet GetData(int id, string name);

        // æ‰§è¡Œsqlå¹¶ä¼ å…¥å‚æ•°ï¼Œå¯¹è±¡ç±»å‹
        [SqlExecute(@"
            select * from person where id >@id and name like @name;
            select top 10 * from student where Id >@id;")]
        DataSet GetData(MyParam paras);

        // æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹ sqlï¼Œæ”¯æŒè®¾ç½®å‚æ•°ç±»å‹
        [SqlExecute(@"
            exec PROP_NAME @id;
            select * from person;", CommandType = CommandType.StoredProcedure)]
        DataSet GetData(int id);

        // æ”¯æŒå¤šæ•°æ®åº“æ“ä½œ
        [SqlExecute(@"
            select * from person;
            select * from student;"), SqlDbContextLocator(typeof(MySqlDbContextLocator)]
        DataSet GetData();

        // å¼‚æ­¥æ–¹å¼
        [SqlExecute(@"
            select * from person;
            select * from student;
            select 1;"), SqlDbContextLocator(typeof(MySqlDbContextLocator)]
        Task<DataSet> GetDataAsync());
    }
}
```

### 9.18.4.4 è¿”å› `Tuple<T1,...T8>`

```cs showLineNumbers  {8-10,14-16,20-22,26-28,32-35,38-42}
using Furion.DatabaseAccessor;

namespace Furion.Application
{
    public interface ISql : ISqlDispatchProxy
    {
        // æ‰§è¡Œsqlå¹¶ä¼ å…¥å‚æ•°ï¼ŒåŸºå…ƒç±»å‹
        [SqlExecute(@"
            select * from person where id >@id and name like @name;
            select top 10 * from student where Id >@id;")]
        (List<Person>,List<Student>) GetData(int id, string name);

        // æ‰§è¡Œsqlå¹¶ä¼ å…¥å‚æ•°ï¼Œå¯¹è±¡ç±»å‹
        [SqlExecute(@"
            select * from person where id >@id and name like @name;
            select top 10 * from student where Id >@id;")]
        (List<Person>,List<Student>) GetData(MyParam paras);

        // æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹ sqlï¼Œæ”¯æŒè®¾ç½®å‚æ•°ç±»å‹
        [SqlExecute(@"
            exec PROP_NAME @id;
            select * from person;", CommandType = CommandType.StoredProcedure)]
        (List<Person>,List<Student>) GetData(int id);

        // æ”¯æŒå¤šæ•°æ®åº“æ“ä½œ
        [SqlExecute(@"
            select * from person;
            select * from student;"), SqlDbContextLocator(typeof(MySqlDbContextLocator)]
        (List<Person>,List<Student>) GetData();

        // å¼‚æ­¥æ–¹å¼
        [SqlExecute(@"
            select * from person;
            select * from student;
            select 1;"), SqlDbContextLocator(typeof(MySqlDbContextLocator)]
        Task<(List<Person>,List<Student>,List<int>)> GetDataAsync();

        // è‡ª v3.7.3+ ç‰ˆæœ¬æ”¯æŒè¿”å›å•ä¸ªç±»ç±»å‹å‚æ•°
        [SqlExecute(@"
            select * from person where id =@id;
            select * from person")]
        (Person, List<Person>) GetData(int id); // æ³¨æ„è¿”å›å€¼æ˜¯ `(Person, List<Person>)` ç»„åˆ
}
```

### 9.18.4.5 è¿”å› `å•è¡Œå•åˆ—`

```cs showLineNumbers  {7,10,13}
using Furion.DatabaseAccessor;

namespace Furion.Application
{
    public interface ISql : ISqlDispatchProxy
    {
        [SqlExecute("select Name from person where id = @id")]
        string GetValue(int id);

        [SqlExecute("select age from person where id = @id")]
        int GetValue(int id);

        [SqlExecute("select Name from person where id = @id")]
        Task<string> GetValueAsync(int id);
    }
}
```

### 9.18.4.6 æ— è¿”å›å€¼

```cs showLineNumbers  {7,10,13}
using Furion.DatabaseAccessor;

namespace Furion.Application
{
    public interface ISql : ISqlDispatchProxy
    {
        [SqlExecute("insert into person(Name,Age) values(@name,@age)")]
        void Insert(MyParam dto);

        [SqlExecute("delete from person where id = @id")]
        void Delete(int id);

        [SqlExecute("update person set name=@name where id=@id")]
        void Update(int id, string name);
    }
}
```

### 9.18.4.7 è¿”å›å•ä¸ªç±»ç±»å‹å‚æ•°

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 3.7.1 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

```cs showLineNumbers {3-5}
public interface ISql : ISqlDispatchProxy
{
    // è‡ª v3.7.3+ ç‰ˆæœ¬æ”¯æŒè¿”å›å•ä¸ªç±»ç±»å‹å‚æ•°
    [SqlExecute("select * from person where id=@id")]
    Person GetPerson(int id);
}
```

### 9.18.4.8 è¿”å›å—å½±å“è¡Œæ•°

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.4.5 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

éœ€è¦åœ¨ `[SqlExcuete]` ç‰¹æ€§ä¸­æ ‡è®° `RowEffects = true` ä¸”è¿”å›å€¼æ˜¯ `int` æˆ–è€… `Task<int>`ã€‚

```cs showLineNumbers {4,8}
public interface ISql : ISqlDispatchProxy
{
    // åŒæ­¥
    [SqlExecute("update person set age = 30 where id = {id}", RowEffects = true)]
    int Update(int id);

    // å¼‚æ­¥
    [SqlExecute("update person set age = 30 where id = {id}", RowEffects = true)]
    Task<int> UpdateAsync(int id);
}
```

### 9.18.4.9 è¿”å› `IEnumerable` æˆ– `Array` ç±»å‹

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.7.5 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

```cs showLineNumbers {4,7,16}
public interface ISql : ISqlDispatchProxy
{
    [SqlExecute("select * from person")]
    Person[] GetPersons();

    [SqlExecute("select * from person")]
    IEnumerable<Person> GetPersons2();

    // æ›´å¤æ‚çš„ç»„åˆ
    [SqlExecute(@"
select * from person where id = 1;
select * from person;
select * from person where id > 0;
select * from person where id > 0;
")]
    (Person, List<Person>, Person[], IEnumerable<Person>) GetPersons();
}
```

## 9.18.5 `å­˜å‚¨è¿‡ç¨‹` æ“ä½œ

### 9.18.5.1 è¿”å› `DataTable`

```cs showLineNumbers  {7,10,13}
using Furion.DatabaseAccessor;

namespace Furion.Application
{
    public interface ISql : ISqlDispatchProxy
    {
        [SqlProcedure("PROC_Name")]
        DataTable GetPersons(MyParam dto);

        [SqlProcedure("PROC_Name")]
        DataTable GetPersons(int id);

        [SqlProcedure("PROC_Name")]
        DataTable GetPersons(int id, string name);
    }
}
```

### 9.18.5.2 è¿”å› `List<T>`

```cs showLineNumbers  {7,10,13}
using Furion.DatabaseAccessor;

namespace Furion.Application
{
    public interface ISql : ISqlDispatchProxy
    {
        [SqlProcedure("PROC_Name")]
        List<Person> GetPersons(MyParam dto);

        [SqlProcedure("PROC_Name")]
        List<Person> GetPersons(int id);

        [SqlProcedure("PROC_Name")]
        List<Person> GetPersons(int id, string name);
    }
}
```

### 9.18.5.3 è¿”å› `DataSet`

```cs showLineNumbers  {7,10,13}
using Furion.DatabaseAccessor;

namespace Furion.Application
{
    public interface ISql : ISqlDispatchProxy
    {
        [SqlProcedure("PROC_Name")]
        DataSet GetData(MyParam dto);

        [SqlProcedure("PROC_Name")]
        DataSet GetData(int id);

        [SqlProcedure("PROC_Name")]
        DataSet GetData(int id, string name);
    }
}
```

### 9.18.5.4 è¿”å› `Tuple(T1,...T8)`

```cs showLineNumbers  {7,10,13,16-18}
using Furion.DatabaseAccessor;

namespace Furion.Application
{
    public interface ISql : ISqlDispatchProxy
    {
        [SqlProcedure("PROC_Name")]
        (List<Person>, List<Student>) GetData(MyParam dto);

        [SqlProcedure("PROC_Name")]
        (List<Person>, List<Student>) GetData(int id);

        [SqlProcedure("PROC_Name")]
        (List<Person>, List<Student>, Person, int) GetData(int id, string name);

        // è‡ª v3.7.3+ ç‰ˆæœ¬æ”¯æŒè¿”å›å•ä¸ªç±»ç±»å‹å‚æ•°
        [SqlProcedure(@"PROC_Name)]
        (Person, List<Person>) GetData(int id); // æ³¨æ„è¿”å›å€¼æ˜¯ `(Person, List<Person>)` ç»„åˆ
    }
}
```

### 9.18.5.5 è¿”å› `å•è¡Œå•åˆ—`

```cs showLineNumbers  {7,10,13}
using Furion.DatabaseAccessor;

namespace Furion.Application
{
    public interface ISql : ISqlDispatchProxy
    {
        [SqlProcedure("PROC_Name")]
        object GetValue(MyParam dto);

        [SqlProcedure("PROC_Name")]
        string GetValue(int id);

        [SqlProcedure("PROC_Name")]
        int GetValue(int id, string name);
    }
}
```

### 9.18.5.6 æ— è¿”å›å€¼

```cs showLineNumbers  {7,10,13}
using Furion.DatabaseAccessor;

namespace Furion.Application
{
    public interface ISql : ISqlDispatchProxy
    {
        [SqlProcedure("PROC_Name")]
        void GetValue(MyParam dto);

        [SqlProcedure("PROC_Name")]
        void GetValue(int id);

        [SqlProcedure("PROC_Name")]
        void GetValue(int id, string name);
    }
}
```

### 9.18.5.7 å¸¦ `OUTPUT/RETURN` è¿”å›

```cs showLineNumbers  {7,10,13}
using Furion.DatabaseAccessor;

namespace Furion.Application
{
    public interface ISql : ISqlDispatchProxy
    {
        [SqlProcedure("PROC_Name")]
        ProcedureOutputResult GetOutput(ProcOutputModel pams);

        [SqlProcedure("PROC_Name")]
        ProcedureOutputResult GetOutput(ProcOutputModel pams);

        [SqlProcedure("PROC_Name")]
        ProcedureOutputResult<(List<Person>, List<Student>)> GetOutput(ProcOutputModel pams);
    }
}
```

### 9.18.5.8 è¿”å›å•ä¸ªç±»ç±»å‹å‚æ•°

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 3.7.1 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

```cs showLineNumbers {3-5}
public interface ISql : ISqlDispatchProxy
{
    // è‡ª v3.7.3+ ç‰ˆæœ¬æ”¯æŒè¿”å›å•ä¸ªç±»ç±»å‹å‚æ•°
    [SqlProcedure("PROC_Name")]
    Person GetPerson(int id);
}
```

### 9.18.5.9 è¿”å› `IEnumerable` æˆ– `Array` ç±»å‹

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.7.5 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

```cs showLineNumbers {4,7,11}
public interface ISql : ISqlDispatchProxy
{
    [SqlProcedure("PROC_Name")]
    Person[] GetPersons();

    [SqlProcedure("PROC_Name")]
    IEnumerable<Person> GetPersons2();

    // æ›´å¤æ‚çš„ç»„åˆ
    [SqlProcedure("PROC_Name")]
    (Person, List<Person>, Person[], IEnumerable<Person>) GetPersons();
}
```

## 9.18.6 `å‡½æ•°` æ“ä½œ

```cs showLineNumbers  {7,10}
using Furion.DatabaseAccessor;

namespace Furion.Application
{
    public interface ISql : ISqlDispatchProxy
    {
        [SqlFunction("FN_Name")]    // æ ‡é‡å‡½æ•°
        string GetValue(MyParam dto);

        [SqlProcedure("FN_Name")]   // è¡¨å€¼å‡½æ•°
        List<Person> GetPersons(int id);
    }
}
```

:::important è¡¥å……è¯´æ˜

`Sql` ä»£ç†ä¼šè‡ªåŠ¨åˆ¤æ–­è¿”å›å€¼ç„¶åè‡ªåŠ¨æ‰§è¡Œç‰¹å®šå‡½æ•°ç±»å‹ã€‚

:::

## 9.18.7 `Sql` æ¨¡æ¿æ›¿æ¢

åœ¨æœ€æ–°çš„ `1.18.3` ç‰ˆæœ¬ä¸­æä¾›äº†æ¨¡æ¿æ›¿æ¢åŠŸèƒ½ï¼Œå¦‚ï¼š

```cs showLineNumbers
[SqlExecute("select * from person where id > {id} and name like {name} and age > {user.Age}")]
List<Person> GetPerson(int id, string name, User user);
```

:::important ä¸¤è€…åŒºåˆ«

æ¨¡æ¿å­—ç¬¦ä¸²æœ‰åˆ«äºå‘½ä»¤å‚æ•°æ›¿æ¢ï¼Œæ¨¡æ¿å­—ç¬¦ä¸²é‡‡ç”¨ `{ }` æ–¹å¼ï¼Œè¿è¡Œæ—¶ç›´æ¥æ›¿æ¢ä¸ºå®é™…çš„å†…å®¹ï¼Œ `@` è€Œæ˜¯è½¬æ¢æˆ `DbParameter` å‚æ•°ã€‚

:::

## 9.18.8 åˆ‡æ¢æ•°æ®åº“

`Sql` ä»£ç†æ–¹å¼çš„æ”¯æŒä¸‰ç§åˆ‡æ¢æ•°æ®åº“çš„æ–¹å¼ï¼š

### 9.18.8.1 å•ä¸ªæ–¹æ³•æ–¹å¼

ä¸»è¦é€šè¿‡åœ¨æ–¹æ³•ä¸Šè´´ `[SqlDbContextLocator]` ç‰¹æ€§

```cs showLineNumbers  {1}
[SqlExecute("select * from person"), SqlDbContextLocator(typeof(MySqlDbContextLocator)]
List<Person> GetPerson();
```

### 9.18.8.2 æ¥å£æ–¹å¼

åœ¨æ¥å£ä¸­è´´ `[SqlDbContextLocator]` ç‰¹æ€§ï¼Œæ­¤æ–¹å¼ä¸‹ï¼Œæ¥å£æ‰€æœ‰æ–¹æ³•å°†é‡‡ç”¨æŒ‡å®šçš„æ•°æ®åº“æ‰§è¡Œã€‚

```cs showLineNumbers  {1}
[SqlDbContextLocator(typeof(MySqlDbContextLocator)]
public interface ISql : ISqlDispatchProxy
{
    [SqlFunction("FN_Name")]    // æ ‡é‡å‡½æ•°
    string GetValue(MyParam dto);

    [SqlProcedure("FN_Name")]   // è¡¨å€¼å‡½æ•°
    List<Person> GetPersons(int id);
}
```

### 9.18.8.3 è¿è¡Œæ—¶ `.Change` æ–¹æ³•åˆ‡æ¢

é™¤äº†ä»¥ä¸Šä¸¤ç§ `é™æ€` é…ç½®æ–¹å¼ï¼Œ`Furion` æ¡†æ¶è¿˜æä¾› `åŠ¨æ€` æ–¹å¼ï¼Œå¦‚ï¼š

```cs showLineNumbers  {2,6}
// å°† sql ä»£ç†æ•°æ®åº“åˆ‡æ¢æˆç‰¹å®šæ•°æ®åº“
_sql.Change<MySqlDbContextLocator>();
_sql.GetPerson();

// å¤šæ¬¡åˆ‡æ¢
_sql.Change<OracleDbContextLocator>();
_sql.GetPerson();

// è¿˜æ”¯æŒé‡ç½®æ•°æ®åº“ä¸Šä¸‹æ–‡å®šä½å™¨ä¸ºåˆå§‹çŠ¶æ€
_sql.ResetIt();
_sql.GetPerson();
```

:::important å…³äºä¼˜å…ˆçº§é—®é¢˜

`.Change<>` ä¼˜å…ˆçº§å¤§äº `æ–¹æ³•è´´ [SqlDbContextLocator]` å¤§äº `æ¥å£è´´ [SqlDbContextLocator]`ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸æŒ‡å®š `DbContextLocator` å±æ€§ï¼Œåˆ™ä¸º `MasterDbContextLocator`ã€‚

:::

## 9.18.9 `Sql` ä»£ç†æ‹¦æˆª

åœ¨ `Furion v2.13 +` ç‰ˆæœ¬æ–°å¢äº† `Sql` ä»£ç†æ‹¦æˆªåŠŸèƒ½ï¼Œå¯ä»¥ç¯¡æ”¹ç‰¹å®šæ–¹æ³•æˆ–æ‰€æœ‰ä»£ç†æ–¹æ³•å®é™…æ‰§è¡Œçš„å‚æ•°ï¼Œå¦‚ `sqlè¯­å¥ã€å‚æ•°ã€æ‰§è¡Œå¯¹è±¡ç­‰ç­‰`ã€‚

**è‹¥åœ¨ `Sql` ä»£ç†ä¸­å®ç°æ‹¦æˆªåŠŸèƒ½ï¼Œå¿…é¡»æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶**ï¼š

- æ–¹æ³•å¿…é¡»æ˜¯ `static` é™æ€æ–¹æ³•ä¸”è¿”å›å€¼ä¸º `void` ä¸”åªæœ‰ä¸€ä¸ª `SqlProxyMethod` å‚æ•°
- æ–¹æ³•å¿…é¡»è´´ `[Interceptor]` ç‰¹æ€§

å¦‚ï¼š

```cs showLineNumbers  {9,13-17,20-24,26-30,32-36}
public interface ISql : ISqlDispatchProxy
{
    [SqlFunction("FN_Name")]
    string GetValue(MyParam dto);

    [SqlProcedure("FN_Name")]
    List<Person> GetPersons(int id);

    [SqlExecute("select name from person", InterceptorId = "GetPersonsByName")] // é€šè¿‡ InterceptorId è§£å†³æ–¹æ³•åé‡è½½é—®é¢˜
    Task<List<string>> GetPersons();

    // åªæ‹¦æˆª GetValue æ–¹æ³•
    [Interceptor(nameof(GetValue))]
    static void æ‹¦æˆª1(SqlProxyMethod method)
    {
        method.FinalSql += " where id > 1"; // ç¯¡æ”¹æœ€ç»ˆæ‰§è¡Œ sql
    }

    // æ‹¦æˆª GetValue å’Œ GetPersons æ–¹æ³•
    [Interceptor(nameof(GetValue), nameof(GetPersons))]
    static void æ‹¦æˆª2(SqlProxyMethod method)
    {
        method.FinalSql += " where id > 1"; // ç¯¡æ”¹æœ€ç»ˆæ‰§è¡Œ sql
    }

    [Interceptor("GetPersonsByName")]   // å¯¹åº”ä¸Šé¢çš„ InterceptorId é…ç½®
    static void è§£å†³æ–¹æ³•åé‡è½½æ‹¦æˆª(SqlProxyMethod method)
    {
        // ã€‚ã€‚ã€‚
    }

    [Interceptor]
    static void å…¨å±€æ‹¦æˆª(SqlProxyMethod method)
    {
        // è¿™é‡Œä¼šæ‹¦æˆªæ‰€æœ‰çš„æ–¹æ³•
    }
}
```

## 9.18.10 è®¾ç½®è¶…æ—¶æ—¶é—´

```cs showLineNumbers
[Timeout(1000)]
public interface ISql : ISqlDispatchProxy
{
    [SqlFunction("FN_Name"), Timeout(500)]   // å•ä½ç§’
    string GetValue(MyParam dto);
}
```

## 9.18.11 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::
