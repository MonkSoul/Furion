---
id: dbcontext-entitytrigger
title: 9.26 å®ä½“æ•°æ®ç›‘å¬å™¨
sidebar_label: 9.26 å®ä½“æ•°æ®ç›‘å¬å™¨
---

import Tag from "@site/src/components/Tag.js";

<details>
  <summary>ğŸ“ æ¨¡å—æ›´æ–°æ—¥å¿—</summary>
  <div>
<div>

- **é—®é¢˜ä¿®å¤**

  - &nbsp;<Tag>ä¿®å¤</Tag> `EFCore` å®ä½“ç›‘å¬å™¨ `IEntityChangedListener` é—®é¢˜ <sup>4.8.1.7</sup> <sup>â±ï¸2022.11.26</sup> [#I61CTI](https://gitee.com/dotnetchina/Furion/issues/I61CTI)

</div>
  </div>
</details>

## 9.26.1 å®ä½“æ•°æ®ç›‘å¬å™¨

åœ¨æœ€æ–°çš„ `Furion` çš„ `1.1.6+` ç‰ˆæœ¬ä¸­ï¼Œæ–°å¢äº† `IEntityChangedListener` å®ä½“æ•°æ®ç›‘å¬æ¥å£ï¼Œå¯ä»¥ç›‘å¬ `EFCore` ä»»ä½•å®ä½“è¡¨ `å¢åˆ æ”¹` æ“ä½œã€‚

## 9.26.2 æœ‰ä½•ä½œç”¨

- ç±»ä¼¼æ•°æ®åº“ `è§¦å‘å™¨` åŠŸèƒ½ï¼Œå¯å®ç° `å¢åˆ æ”¹` ç›‘å¬
- å¯ä»¥å®ç°ç‰¹æ®Šæ“ä½œï¼Œæ¯”å¦‚åˆ·æ–°ç¼“å­˜ï¼Œè®°å½•æ—¥å¿—ç­‰

## 9.26.3 å¦‚ä½•ä½¿ç”¨

åœ¨ `Furion` æ¡†æ¶ä¸­ï¼Œé»˜è®¤ä¸å¯ç”¨å®ä½“æ•°æ®ç›‘å¬å™¨ï¼Œå¦‚æƒ³å¯ç”¨ï¼Œåªéœ€è¦åœ¨ `æ•°æ®åº“ä¸Šä¸‹æ–‡` æ„é€ å‡½æ•°ä¸­å¯ç”¨å³å¯ï¼š

### 9.26.3.1 å¯ç”¨æ•°æ®ç›‘å¬

```cs showLineNumbers  {11}
using Furion.DatabaseAccessor;
using Microsoft.EntityFrameworkCore;

namespace Furion.EntityFramework.Core
{
    [AppDbContext("Sqlite3ConnectionString")]
    public class DefaultDbContext : AppDbContext<DefaultDbContext>
    {
        public DefaultDbContext(DbContextOptions<DefaultDbContext> options) : base(options)
        {
            EnabledEntityChangedListener = true;
        }
    }
}
```

### 9.26.3.2 ç›‘å¬ç‰¹å®šå®ä½“æ•°æ®

:::caution ç‰¹åˆ«æ³¨æ„

å¦‚æœå®ä½“æ²¡æœ‰ç›´æ¥æˆ–é—´æ¥ç»§æ‰¿ `Entity` æˆ–è€… `EntityBase`ï¼Œé‚£ä¹ˆéœ€è¦åœ¨å®ä½“ä¸­æ·»åŠ  `__State__` éå…¬å¼€å±æ€§ï¼Œå¦‚ï¼š

```cs
internal EntityState __State__ { get; set; }
```

:::

```cs showLineNumbers  {9,30-41}
using Furion.DatabaseAccessor;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Caching.Memory;
using System;
using System.Collections.Generic;

namespace Furion.Core
{
    public class Post : Entity, IEntityChangedListener<Post>
    {
        /// <summary>
        /// æ„é€ å‡½æ•°
        /// </summary>
        public Post()
        {
            CreatedTime = DateTimeOffset.UtcNow;
            IsDeleted = false;
        }

        /// <summary>
        /// åç§°
        /// </summary>
        public string Name { get; set; }

        /// <summary>
        /// Person é›†åˆ
        /// </summary>
        public ICollection<Person> Persons { get; set; }

        /// <summary>
        /// å®ä½“æ›´æ”¹åè§¦å‘
        /// </summary>
        /// <param name="entity">æ–°æ•°æ®</param>
        /// <param name="oldEntity">æ—§æ•°æ®</param>
        /// <param name="dbContext">æ•°æ®åº“ä¸Šä¸‹æ–‡</param>
        /// <param name="dbContextLocator">æ•°æ®åº“ä¸Šä¸‹æ–‡å®šä½å™¨</param>
        /// <param name="state">å®ä½“çŠ¶æ€</param>
        public void OnChanged(Post entity, Post oldEntity, DbContext dbContext, Type dbContextLocator, EntityState state)
        {
            // åˆ·æ–°ç¼“å­˜
            App.GetService<IMemoryCache>().Set("Key", "Value");
        }
    }
}
```

## 9.26.4 `IEntityChangedListener` å®šä¹‰

```cs showLineNumbers  {25}
/// <summary>
/// å®ä½“æ•°æ®æ”¹å˜ç›‘å¬ä¾èµ–æ¥å£
/// </summary>
/// <typeparam name="TEntity"></typeparam>
public interface IEntityChangedListener<TEntity>
    where TEntity : class, IPrivateEntity, new()
{
    /// <summary>
    /// ç›‘å¬æ•°æ®æ”¹å˜ä¹‹å‰ï¼ˆä»…æ”¯æŒEFCoreæ“ä½œï¼‰
    /// </summary>
    /// <param name="entity"></param>
    /// <param name="dbContext"></param>
    /// <param name="dbContextLocator"></param>
    /// <param name="state"></param>
    void OnChanging(TEntity entity, DbContext dbContext, Type dbContextLocator, EntityState state) { }

    /// <summary>
    /// ç›‘å¬æ•°æ®æ”¹å˜ä¹‹åï¼ˆä»…æ”¯æŒEFCoreæ“ä½œï¼‰
    /// </summary>
    /// <param name="newEntity">æ–°å€¼</param>
    /// <param name="oldEntity">æ—§å€¼</param>
    /// <param name="dbContext"></param>
    /// <param name="dbContextLocator"></param>
    /// <param name="state"></param>
    void OnChanged(TEntity newEntity, TEntity oldEntity, DbContext dbContext, Type dbContextLocator, EntityState state);

    /// <summary>
    /// ç›‘å¬æ•°æ®æ”¹å˜å¤±è´¥ï¼ˆä»…æ”¯æŒEFCoreæ“ä½œï¼‰
    /// </summary>
    /// <param name="entity"></param>
    /// <param name="dbContext"></param>
    /// <param name="dbContextLocator"></param>
    /// <param name="state"></param>
    void OnChangeFailed(TEntity entity, DbContext dbContext, Type dbContextLocator, EntityState state) { }
}
```

## 9.26.5 `[SuppressChangedListener]` è·³è¿‡ç›‘å¬

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`Furion` æ¡†æ¶ä¼šå¯¹æ‰€æœ‰æ–°å¢ã€æ›´æ–°ã€ç¼–è¾‘çš„å®ä½“è¿›è¡Œç›‘å¬ï¼Œæœ‰äº›æ—¶å€™æˆ‘ä»¬æ— éœ€ç›‘å¬ç‰¹å®šå®ä½“ï¼Œåªéœ€è¦åœ¨å®ä½“ä¸Šè´´ `[SuppressChangedListener]` ç‰¹æ€§å³å¯ã€‚

## 9.26.6 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::
