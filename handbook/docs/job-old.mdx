---
id: job-old
title: 26. å®šæ—¶ä»»åŠ¡/åå°ä»»åŠ¡
sidebar_label: 26. å®šæ—¶ä»»åŠ¡/åå°ä»»åŠ¡
---

:::warning 4.8.0+ ç‰ˆæœ¬è¯´æ˜

**åœ¨ `Furion 4.8.0+` ç‰ˆæœ¬é‡‡ç”¨ [Sundial](https://gitee.com/dotnetchina/Sundial) å®šæ—¶ä»»åŠ¡æ›¿æ¢åŸæœ‰çš„ `TaskScheduler`**ï¼Œ**ğŸ˜¶[æŸ¥çœ‹æ–°æ–‡æ¡£](/docs/job)**

æ—§ç‰ˆæœ¬å°†æ”¯æŒåˆ° `2022å¹´12æœˆ31æ—¥`ï¼Œä¹‹åæ—§ç‰ˆæœ¬ä»£ç ä»æ¡†æ¶ä¸­ç§»é™¤ï¼Œè¯·å°½å¿«ä½¿ç”¨æ–°ç‰ˆæœ¬æ›¿ä»£ã€‚

:::

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 2.0.0 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

:::tip IIS éƒ¨ç½²è¯´æ˜

ç”±äº IIS æœ‰å›æ”¶çš„æœºåˆ¶ï¼Œæ‰€ä»¥å®šæ—¶ä»»åŠ¡åº”è¯¥é‡‡ç”¨ç‹¬ç«‹éƒ¨ç½²ï¼Œä¸ç„¶ç»å¸¸å‡ºç°ä¸èƒ½è§¦å‘çš„æƒ…å†µã€‚æŸ¥çœ‹ã€[Worker Service ç« èŠ‚](./process-service.mdx)ã€‘

:::

import useBaseUrl from "@docusaurus/useBaseUrl";

## 26.1 å…³äºå®šæ—¶ä»»åŠ¡

é¡¾åæ€ä¹‰ï¼Œå®šæ—¶ä»»åŠ¡å°±æ˜¯åœ¨ç‰¹å®šçš„æ—¶é—´æˆ–ç¬¦åˆæŸç§æ—¶é—´è§„å¾‹æ‰§è¡Œçš„ä»»åŠ¡ã€‚é€šå¸¸å®šæ—¶ä»»åŠ¡æœ‰å››ç§æ—¶é—´è°ƒåº¦æ–¹å¼ï¼š

- `ç¼“éš”æ—¶é—´` æ–¹å¼ï¼šå»¶è¿Ÿå¤šå°‘æ—¶é—´åè°ƒé…ä»»åŠ¡ï¼Œè¿™ç§æ–¹å¼ä»»åŠ¡åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚
- `é—´éš”æ—¶é—´` æ–¹å¼ï¼šæ¯éš”ä¸€æ®µå›ºå®šæ—¶é—´è°ƒé…ä»»åŠ¡ï¼Œæ— é—´æ–­è°ƒç”¨ä»»åŠ¡ã€‚
- `Cron è¡¨è¾¾å¼` æ–¹æ³•ï¼šé€šè¿‡ `Cron` è¡¨è¾¾å¼è®¡ç®—ä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´è¿›è¡Œè°ƒé…ä»»åŠ¡ï¼Œå¯ä»¥é…ç½®ç‰¹å®šæ—¶é—´èŒƒå›´å†…æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥æ— é—´æ–­æ‰§è¡Œã€‚
- `è‡ªå®šä¹‰ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´`ï¼šå¯ä»¥é€šè¿‡å„ç§é€»è¾‘è¿ç®—è¿”å›ä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´

## 26.2 å¦‚ä½•å®ç°

`Furion` æ¡†æ¶æä¾›äº†ä¸¤ç§æ–¹å¼å®ç°å®šæ—¶ä»»åŠ¡ï¼š

- `SpareTime` é™æ€ç±»ï¼š`SpareTime` é™æ€ç±»æä¾› `SpareTime.Do([options])` æ–¹å¼è°ƒç”¨ã€‚
- `ISpareTimeWorker` ä¾èµ–æ–¹å¼ï¼šé€šè¿‡è‡ªå®šä¹‰ç±»å®ç° `ISpareTimeWorker` æ¥å£å¹¶ç¼–å†™ä¸€å®šè§„åˆ™çš„æ–¹æ³•å³å¯ã€‚**éœ€è¦åœ¨ `Startup.cs` ä¸­æ³¨å†Œ `services.AddTaskScheduler()`**

## 26.3 ç¼“éš”æ–¹å¼ä½¿ç”¨

### 26.3.1 ç‰¹å®šæ—¶é—´åæ‰§è¡Œ

è¿™é‡Œæ¼”ç¤º `3s` åæ‰§è¡Œ

```cs showLineNumbers  {5}
Console.WriteLine("å½“å‰æ—¶é—´ï¼š" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));

// timer æ˜¯å®šæ—¶å™¨çš„å¯¹è±¡ï¼ŒåŒ…å«å®šæ—¶å™¨ç›¸å…³ä¿¡æ¯
// count è¡¨ç¤ºæ‰§è¡Œæ¬¡æ•°ï¼Œè¿™é‡Œåªæœ‰ä¸€æ¬¡
SpareTime.DoOnce(3000, (timer, count) => {
    Console.WriteLine("ç°åœ¨æ—¶é—´ï¼š" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
});
```

### 26.3.2 é…ç½®ä»»åŠ¡ä¿¡æ¯

```cs showLineNumbers  {3}
SpareTime.DoOnce(3000, (timer, count) => {
    Console.WriteLine("ç°åœ¨æ—¶é—´ï¼š" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
}, "jobName", "æè¿°ä¸€ä¸‹è¿™ä¸ªä»»åŠ¡æ˜¯å¹²ä»€ä¹ˆçš„");
```

`jobName` æ ‡è¯†ä»»åŠ¡çš„å”¯ä¸€æ ‡è¯†ï¼Œé€šè¿‡è¿™ä¸ªæ ‡è¯†å¯ä»¥å¯åŠ¨ã€æš‚åœã€é”€æ¯ä»»åŠ¡ã€‚

### 26.3.3 æ‰‹åŠ¨å¯åŠ¨æ‰§è¡Œ

é»˜è®¤æƒ…å†µä¸‹ï¼Œä»»åŠ¡åˆå§‹åŒ–åå°±ç«‹å³å¯åŠ¨ï¼Œç­‰å¾…ç¬¦åˆçš„æ—¶é—´å°±æ‰§è¡Œï¼Œæœ‰äº›æ—¶å€™æˆ‘ä»¬ä»…ä»…æƒ³åˆå§‹åŒ–æ—¶é—´ï¼Œä¸å¸Œæœ›ç«‹å³æ‰§è¡Œï¼Œåªéœ€è¦é…ç½® `startNow` å³å¯ï¼š

```cs showLineNumbers  {3,6}
SpareTime.DoOnce(3000, (timer, count) => {
    Console.WriteLine("ç°åœ¨æ—¶é—´ï¼š" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
},"jobName", startNow: false);

// æ‰‹åŠ¨å¯åŠ¨æ‰§è¡Œ
SpareTime.Start("jobName");
```

### 26.3.4 æ¨¡æ‹Ÿåå°æ‰§è¡Œ

æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦å¼€å¯æ–°çº¿ç¨‹å»æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œæ¯”å¦‚å‘çŸ­ä¿¡ï¼Œå‘é‚®ä»¶ï¼Œæ— éœ€é…ç½®ã€‚

```cs showLineNumbers  {2}
// æ­¤æ–¹æ³•æ— éœ€ä¸»çº¿ç¨‹ç­‰å¾…å³å¯è¿”å›ï¼Œå¯å¤§å¤§æé«˜æ€§èƒ½
SpareTime.DoIt(() => {
    // è¿™é‡Œå‘é€çŸ­ä¿¡ï¼Œå‘é€é‚®ä»¶æˆ–è®°å½•è®¿é—®è®°å½•
});
```

è¿˜å¯ä»¥æŒ‡å®šå¤šé•¿æ—¶é—´åè§¦å‘ï¼Œå»ºè®® `10-1000` æ¯«ç§’ä¹‹é—´ï¼š

```cs showLineNumbers  {3}
SpareTime.DoIt(() => {
    // å‘é€çŸ­ä¿¡
}, 100);
```

### 26.3.5 `ISpareTimeWorker` æ–¹å¼

```cs showLineNumbers  {1,8}
public class JobWorker : ISpareTimeWorker
{
    /// <summary>
    /// 3s åæ‰§è¡Œ
    /// </summary>
    /// <param name="timer"></param>
    /// <param name="count"></param>
    [SpareTime(3000, "jobName", DoOnce = true, StartNow = true)]
    public void DoSomething(SpareTimer timer, long count)
    {
        Console.WriteLine(DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
    }

    /// <summary>
    /// 3s åæ‰§è¡Œï¼ˆæ”¯æŒå¼‚æ­¥ï¼‰
    /// </summary>
    /// <param name="timer"></param>
    /// <param name="count"></param>
    [SpareTime(3000, "jobName", DoOnce = true, StartNow = true)]
    public async Task DoSomethingAsync(SpareTimer timer, long count)
    {
        Console.WriteLine(DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
        await Task.CompletedTask;
    }
}
```

**éœ€è¦åœ¨ `Startup.cs` ä¸­æ³¨å†Œ `services.AddTaskScheduler()`**

## 26.4 é—´éš”æ–¹å¼ä½¿ç”¨

### 26.4.1 æ¯éš”ä¸€æ®µæ—¶é—´æ‰§è¡Œ

```cs showLineNumbers  {2}
// æ¯éš” 1s æ‰§è¡Œ
SpareTime.Do(1000, (timer, count) => {
    Console.WriteLine("ç°åœ¨æ—¶é—´ï¼š" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
    Console.WriteLine($"ä¸€å…±æ‰§è¡Œäº†ï¼š{count} æ¬¡");
});
```

### 26.4.2 é…ç½®ä»»åŠ¡ä¿¡æ¯

```cs showLineNumbers  {1,4}
SpareTime.Do(1000, (timer, count) => {
    Console.WriteLine("ç°åœ¨æ—¶é—´ï¼š" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
    Console.WriteLine($"ä¸€å…±æ‰§è¡Œäº†ï¼š{count} æ¬¡");
}, "jobName", "è¿™æ˜¯ä¸€ä¸ªè®¡æ—¶å™¨ä»»åŠ¡");
```

### 26.4.3 æ‰‹åŠ¨å¯åŠ¨æ‰§è¡Œ

```cs showLineNumbers  {1,4,6}
SpareTime.Do(1000, (timer, count) => {
    Console.WriteLine("ç°åœ¨æ—¶é—´ï¼š" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
    Console.WriteLine($"ä¸€å…±æ‰§è¡Œäº†ï¼š{count} æ¬¡");
}, "jobName", startNow:false);

SpareTime.Start("jobName");
```

### 26.4.4 `ISpareTimeWorker` æ–¹å¼

```cs showLineNumbers  {1,8}
public class JobWorker : ISpareTimeWorker
{
    /// <summary>
    /// æ¯éš” 3s æ‰§è¡Œ
    /// </summary>
    /// <param name="timer"></param>
    /// <param name="count"></param>
    [SpareTime(3000, "jobName", StartNow = true)]
    public void DoSomething(SpareTimer timer, long count)
    {
        Console.WriteLine(DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
        Console.WriteLine($"ä¸€å…±æ‰§è¡Œäº†ï¼š{count} æ¬¡");
    }
}
```

**éœ€è¦åœ¨ `Startup.cs` ä¸­æ³¨å†Œ `services.AddTaskScheduler()`**

## 26.5 `Cron` è¡¨è¾¾å¼ä½¿ç”¨

### 26.5.1 ä»€ä¹ˆæ˜¯ `Cron` è¡¨è¾¾å¼

Cron è¡¨è¾¾å¼æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå­—ç¬¦ä¸²ä»¥ `5` æˆ– `6` ä¸ªç©ºæ ¼éš”å¼€ï¼Œåˆ†ä¸º 6 æˆ– 7 ä¸ªåŸŸï¼Œæ¯ä¸€ä¸ªåŸŸä»£è¡¨ä¸€ä¸ªå«ä¹‰ï¼ŒCron æœ‰å¦‚ä¸‹ä¸¤ç§è¯­æ³•æ ¼å¼ï¼š

ï¼ˆ1ï¼‰ Seconds Minutes Hours DayofMonth Month DayofWeek Year

ï¼ˆ2ï¼‰Seconds Minutes Hours DayofMonth Month DayofWeek

Cron ä»å·¦åˆ°å³ï¼ˆç”¨ç©ºæ ¼éš”å¼€ï¼‰ï¼š`ç§’` `åˆ†` `å°æ—¶` `æœˆä»½ä¸­çš„æ—¥æœŸ` `æœˆä»½` `æ˜ŸæœŸä¸­çš„æ—¥æœŸ` `å¹´ä»½`

| å­—æ®µ                   | å…è®¸å€¼                                      | å…è®¸çš„ç‰¹æ®Šå­—ç¬¦              |
| ---------------------- | ------------------------------------------- | --------------------------- |
| ç§’ï¼ˆSecondsï¼‰          | `0~59` çš„æ•´æ•°                               | `, - \* /` å››ä¸ªå­—ç¬¦         |
| åˆ†ï¼ˆMinutesï¼‰          | `0~59` çš„æ•´æ•°                               | `, - \* /` å››ä¸ªå­—ç¬¦         |
| å°æ—¶ï¼ˆHoursï¼‰          | `0~23` çš„æ•´æ•°                               | `, - \* /` å››ä¸ªå­—ç¬¦         |
| æ—¥æœŸï¼ˆDayofMonthï¼‰     | `1~31` çš„æ•´æ•°ï¼ˆä½†æ˜¯ä½ éœ€è¦è€ƒè™‘å¹³é—°æœˆçš„å¤©æ•°ï¼‰ | `,- \* ? / L W C` å…«ä¸ªå­—ç¬¦  |
| æœˆä»½ï¼ˆMonthï¼‰          | `1~12` çš„æ•´æ•°æˆ–è€… `JAN-DEC`                 | `, - \* /` å››ä¸ªå­—ç¬¦         |
| æ˜ŸæœŸï¼ˆDayofWeekï¼‰      | `1~7` çš„æ•´æ•°æˆ–è€… `SUN-SAT ï¼ˆ1=SUNï¼‰`        | `, - \* ? / L C #` å…«ä¸ªå­—ç¬¦ |
| å¹´(å¯é€‰ï¼Œç•™ç©º)ï¼ˆYearï¼‰ | `1970~2099`                                 | `, - \* /` å››ä¸ªå­—ç¬¦         |

æ¯ä¸€ä¸ªåŸŸéƒ½ä½¿ç”¨æ•°å­—ï¼Œä½†è¿˜å¯ä»¥å‡ºç°å¦‚ä¸‹ç‰¹æ®Šå­—ç¬¦ï¼Œå®ƒä»¬çš„å«ä¹‰æ˜¯ï¼š

ï¼ˆ1ï¼‰`_`ï¼šè¡¨ç¤ºåŒ¹é…è¯¥åŸŸçš„ä»»æ„å€¼ã€‚å‡å¦‚åœ¨ `Minutes` åŸŸä½¿ç”¨ `\_`, å³è¡¨ç¤ºæ¯åˆ†é’Ÿéƒ½ä¼šè§¦å‘äº‹ä»¶ã€‚

ï¼ˆ2ï¼‰`?`ï¼šåªèƒ½ç”¨åœ¨ `DayofMonth` å’Œ `DayofWeek` ä¸¤ä¸ªåŸŸã€‚å®ƒä¹ŸåŒ¹é…åŸŸçš„ä»»æ„å€¼ï¼Œä½†å®é™…ä¸ä¼šã€‚å› ä¸º `DayofMonth` å’Œ `DayofWeek` ä¼šç›¸äº’å½±å“ã€‚ä¾‹å¦‚æƒ³åœ¨æ¯æœˆçš„ `20` æ—¥è§¦å‘è°ƒåº¦ï¼Œä¸ç®¡ `20` æ—¥åˆ°åº•æ˜¯æ˜ŸæœŸå‡ ï¼Œåˆ™åªèƒ½ä½¿ç”¨å¦‚ä¸‹å†™æ³•ï¼š `13 13 15 20 _ ?`, å…¶ä¸­æœ€åä¸€ä½åªèƒ½ç”¨`ï¼Ÿ`ï¼Œè€Œä¸èƒ½ä½¿ç”¨\_ï¼Œå¦‚æœä½¿ç”¨\*è¡¨ç¤ºä¸ç®¡æ˜ŸæœŸå‡ éƒ½ä¼šè§¦å‘ï¼Œå®é™…ä¸Šå¹¶ä¸æ˜¯è¿™æ ·ã€‚

ï¼ˆ3ï¼‰`-`ï¼šè¡¨ç¤ºèŒƒå›´ã€‚ä¾‹å¦‚åœ¨ `Minutes` åŸŸä½¿ç”¨ `5-20`ï¼Œè¡¨ç¤ºä» `5` åˆ†åˆ° `20` åˆ†é’Ÿæ¯åˆ†é’Ÿè§¦å‘ä¸€æ¬¡

ï¼ˆ4ï¼‰`/`ï¼šè¡¨ç¤ºèµ·å§‹æ—¶é—´å¼€å§‹è§¦å‘ï¼Œç„¶åæ¯éš”å›ºå®šæ—¶é—´è§¦å‘ä¸€æ¬¡ã€‚ä¾‹å¦‚åœ¨ `Minutes` åŸŸä½¿ç”¨ `5/20`ï¼Œåˆ™æ„å‘³ç€ `5` åˆ†é’Ÿè§¦å‘ä¸€æ¬¡ï¼Œè€Œ `25ï¼Œ45` ç­‰åˆ†åˆ«è§¦å‘ä¸€æ¬¡.

ï¼ˆ5ï¼‰`,`ï¼šè¡¨ç¤ºåˆ—å‡ºæšä¸¾å€¼ã€‚ä¾‹å¦‚ï¼šåœ¨ `Minutes` åŸŸä½¿ç”¨ `5,20`ï¼Œåˆ™æ„å‘³ç€åœ¨ `5` å’Œ `20` åˆ†æ¯åˆ†é’Ÿè§¦å‘ä¸€æ¬¡ã€‚

ï¼ˆ6ï¼‰`L`ï¼šè¡¨ç¤ºæœ€åï¼Œåªèƒ½å‡ºç°åœ¨ `DayofWeek` å’Œ `DayofMonth` åŸŸã€‚å¦‚æœåœ¨ `DayofWeek` åŸŸä½¿ç”¨ `5L`,æ„å‘³ç€åœ¨æœ€åçš„ä¸€ä¸ªæ˜ŸæœŸå››è§¦å‘ã€‚

ï¼ˆ7ï¼‰`W`ï¼šè¡¨ç¤ºæœ‰æ•ˆå·¥ä½œæ—¥(å‘¨ä¸€åˆ°å‘¨äº”) åªèƒ½å‡ºç°åœ¨ `DayofMonth` åŸŸï¼Œç³»ç»Ÿå°†åœ¨ç¦»æŒ‡å®šæ—¥æœŸçš„æœ€è¿‘çš„æœ‰æ•ˆå·¥ä½œæ—¥è§¦å‘äº‹ä»¶ã€‚ä¾‹å¦‚ï¼šåœ¨ `DayofMonth` ä½¿ç”¨ `5W`ï¼Œå¦‚æœ `5` æ—¥æ˜¯æ˜ŸæœŸå…­ï¼Œåˆ™å°†åœ¨æœ€è¿‘çš„å·¥ä½œæ—¥ï¼šæ˜ŸæœŸäº”ï¼Œå³ `4` æ—¥è§¦å‘ã€‚å¦‚æœ `5` æ—¥æ˜¯æ˜ŸæœŸå¤©ï¼Œåˆ™åœ¨ `6` æ—¥(å‘¨ä¸€)è§¦å‘ï¼›å¦‚æœ `5` æ—¥åœ¨æ˜ŸæœŸä¸€åˆ°æ˜ŸæœŸäº”ä¸­çš„ä¸€å¤©ï¼Œåˆ™å°±åœ¨ `5` æ—¥è§¦å‘ã€‚å¦å¤–ä¸€ç‚¹ï¼Œ`W` çš„æœ€è¿‘å¯»æ‰¾ä¸ä¼šè·¨è¿‡æœˆä»½ ã€‚

ï¼ˆ8ï¼‰`LW`ï¼šè¿™ä¸¤ä¸ªå­—ç¬¦å¯ä»¥è¿ç”¨ï¼Œè¡¨ç¤ºåœ¨æŸä¸ªæœˆæœ€åä¸€ä¸ªå·¥ä½œæ—¥ï¼Œå³æœ€åä¸€ä¸ªæ˜ŸæœŸäº”ã€‚

ï¼ˆ9ï¼‰`#`ï¼šç”¨äºç¡®å®šæ¯ä¸ªæœˆç¬¬å‡ ä¸ªæ˜ŸæœŸå‡ ï¼Œåªèƒ½å‡ºç°åœ¨ `DayofMonth` åŸŸã€‚ä¾‹å¦‚åœ¨ `4#2`ï¼Œè¡¨ç¤ºæŸæœˆçš„ç¬¬äºŒä¸ªæ˜ŸæœŸä¸‰ã€‚

### 26.5.2 å¸¸è§ `Cron` è¡¨è¾¾å¼

| è¡¨è¾¾å¼                   | è¡¨è¾¾å¼ä»£è¡¨å«ä¹‰                                             | æ ¼å¼åŒ–                      |
| ------------------------ | ---------------------------------------------------------- | --------------------------- |
| `* * * * *`              | æ¯åˆ†é’Ÿ                                                     | `CronFormat.Standard`       |
| `*/1 * * * *`            | æ¯åˆ†é’Ÿ                                                     | `CronFormat.Standard`       |
| `0 0/1 * * * ?`          | æ¯åˆ†é’Ÿ                                                     | `CronFormat.IncludeSeconds` |
| `0 0 * * * ?`            | æ¯å°æ—¶                                                     | `CronFormat.IncludeSeconds` |
| `0 0 0/1 * * ?`          | æ¯å°æ—¶                                                     | `CronFormat.IncludeSeconds` |
| `0 23 ? * MON-FRI`       | æ™šä¸Š 11:00ï¼Œå‘¨ä¸€è‡³å‘¨äº”                                     | `CronFormat.Standard`       |
| `* * * * * *`            | æ¯ç§’                                                       | `CronFormat.IncludeSeconds` |
| `*/45 * * * * *`         | æ¯ 45 ç§’                                                   | `CronFormat.IncludeSeconds` |
| `*/5 * * * *`            | æ¯ 5 åˆ†é’Ÿ                                                  | `CronFormat.Standard`       |
| `0 0/10 * * * ?`         | æ¯ 10 åˆ†é’Ÿ                                                 | `CronFormat.IncludeSeconds` |
| `0 */5 * * * *`          | æ¯ 5 åˆ†é’Ÿ                                                  | `CronFormat.IncludeSeconds` |
| `30 11 * * 1-5`          | å‘¨ä¸€è‡³å‘¨äº”ä¸Šåˆ 11:30                                       | `CronFormat.Standard`       |
| `30 11 * * *`            | 11:30                                                      | `CronFormat.Standard`       |
| `0-10 11 * * *`          | ä¸Šåˆ 11:00 è‡³ 11:10 ä¹‹é—´çš„æ¯ä¸€åˆ†é’Ÿ                         | `CronFormat.Standard`       |
| `* * * 3 *`              | æ¯åˆ†é’Ÿï¼Œåªåœ¨ 3 æœˆä»½                                        | `CronFormat.Standard`       |
| `* * * 3,6 *`            | æ¯åˆ†é’Ÿï¼Œåªåœ¨ 3 æœˆå’Œ 6 æœˆ                                   | `CronFormat.Standard`       |
| `30 14,16 * * *`         | ä¸‹åˆ 02:30 åˆ†å’Œ 04:30 åˆ†                                   | `CronFormat.Standard`       |
| `30 6,14,16 * * *`       | æ—©ä¸Š 06:30ï¼Œä¸‹åˆ 02:30 å’Œ 04:30                            | `CronFormat.Standard`       |
| `46 9 * * 1`             | æ—©ä¸Š 09:46ï¼Œåªåœ¨æ˜ŸæœŸä¸€                                     | `CronFormat.Standard`       |
| `23 12 15 * *`           | ä¸‹åˆ 12:23ï¼Œåœ¨æœ¬æœˆçš„ç¬¬ 15 å¤©                               | `CronFormat.Standard`       |
| `23 12 * JAN *`          | ä¸‹åˆ 12:23ï¼Œåªåœ¨ 1 æœˆä»½                                    | `CronFormat.Standard`       |
| `23 12 ? JAN *`          | ä¸‹åˆ 12:23ï¼Œåªåœ¨ 1 æœˆä»½                                    | `CronFormat.Standard`       |
| `23 12 * JAN-FEB *`      | ä¸‹åˆ 12:23ï¼Œ1 æœˆè‡³ 2 æœˆ                                    | `CronFormat.Standard`       |
| `23 12 * JAN-MAR *`      | ä¸‹åˆ 12:23ï¼Œ1 æœˆè‡³ 3 æœˆ                                    | `CronFormat.Standard`       |
| `23 12 * * SUN`          | ä¸‹åˆ 12:23ï¼Œä»…åœ¨æ˜ŸæœŸå¤©                                     | `CronFormat.Standard`       |
| `*/5 15 * * MON-FRI`     | æ¯ 5 åˆ†é’Ÿï¼Œä¸‹åˆ 0:00 è‡³ 03:59ï¼Œå‘¨ä¸€è‡³å‘¨äº”                  | `CronFormat.Standard`       |
| `* * * * MON#3`          | æ¯åˆ†é’Ÿï¼Œåœ¨æœˆçš„ç¬¬ä¸‰ä¸ªæ˜ŸæœŸä¸€                                 | `CronFormat.Standard`       |
| `* * * * 4L`             | æ¯ä¸€åˆ†é’Ÿï¼Œåœ¨æœ¬æœˆçš„æœ€åä¸€å¤©                                 | `CronFormat.Standard`       |
| `*/5 * L JAN *`          | æ¯æœˆä¸€æ¬¡æ¯æœˆ 5 åˆ†é’Ÿï¼Œåªåœ¨ 1 æœˆä»½                           | `CronFormat.Standard`       |
| `30 02 14 * * *`         | ä¸‹åˆåœ¨ 02:02:30                                            | `CronFormat.IncludeSeconds` |
| `5-10 * * * * *`         | æ¯åˆ†é’Ÿçš„ 5-10 ç§’                                           | `CronFormat.IncludeSeconds` |
| `5-10 30-35 10-12 * * *` | 10:00 è‡³ 12:00 ä¹‹é—´çš„æ¯åˆ†é’Ÿ 5-10 ç§’ï¼Œæ¯å°æ—¶ 30-35 åˆ†é’Ÿ     | `CronFormat.IncludeSeconds` |
| `30 */5 * * * *`         | æ¯åˆ†é’Ÿçš„ 30 ç§’ï¼Œæ¯äº”åˆ†é’Ÿ                                   | `CronFormat.IncludeSeconds` |
| `0 30 10-13 ? * WED,FRI` | æ¯å°æ—¶çš„ 30 åˆ†é’Ÿï¼Œä¸‹åˆ 10:00 è‡³ 01:00 ä¹‹é—´ï¼Œä»…åœ¨å‘¨ä¸‰å’Œå‘¨äº” | `CronFormat.IncludeSeconds` |
| `10 0/5 * * * ?`         | æ¯åˆ†é’Ÿçš„ 10 ç§’ï¼Œæ¯ 05 åˆ†é’Ÿ                                 | `CronFormat.IncludeSeconds` |
| `0 0 6 1/1 * ?`          | ä¸‹åˆ 06:00                                                 | `CronFormat.IncludeSeconds` |
| `0 5 0/1 * * ?`          | ä¸€ä¸ªå°æ—¶çš„ 05 åˆ†                                           | `CronFormat.IncludeSeconds` |
| `0 0 L * *`              | æ¯æœˆæœ€åä¸€å¤©ä¸Šåˆ 00ï¼š00                                    | `CronFormat.Standard`       |
| `0 0 L-1 * *`            | æ¯æœˆæœ€åä¸€å¤©çš„å‡Œæ™¨ 00ï¼š00                                  | `CronFormat.Standard`       |
| `0 0 3W * *`             | æ¯æœˆç¬¬ 3 ä¸ªå·¥ä½œæ—¥ä¸Šåˆ 00ï¼š00                               | `CronFormat.Standard`       |
| `0 0 LW * *`             | åœ¨æ¯æœˆçš„æœ€åä¸€ä¸ªå·¥ä½œæ—¥ï¼Œä¸Šåˆ 00ï¼š00                        | `CronFormat.Standard`       |
| `0 0 * * 2L`             | æœ¬æœˆæœ€åä¸€ä¸ªæ˜ŸæœŸäºŒä¸Šåˆ 00ï¼š00                              | `CronFormat.Standard`       |
| `0 0 * * 6#3`            | æ¯æœˆç¬¬ä¸‰ä¸ªæ˜ŸæœŸå…­ä¸Šåˆ 00ï¼š00                                | `CronFormat.Standard`       |
| `0 0 ? 1 MON#1`          | 1 æœˆç¬¬ä¸€ä¸ªæ˜ŸæœŸä¸€ä¸Šåˆ 00ï¼š00                                | `CronFormat.Standard`       |
| `0 0 3 * * ?`            | æ¯å¤©å‡ ç‚¹æ‰§è¡Œä¸€æ¬¡                                           | `CronFormat.IncludeSeconds` |

### 26.5.3 åœ¨çº¿ç”Ÿæˆ `Cron` è¡¨è¾¾å¼

[https://cron.qqe2.com/](https://cron.qqe2.com/)

### 26.5.4 `Macro` æ ‡è¯†ç¬¦

ä¸ºäº†æ–¹ä¾¿å®šä¹‰ `Cron` è¡¨è¾¾å¼ï¼Œ`Furion` æ¡†æ¶ä¹Ÿæä¾›äº†éå¸¸æ–¹ä¾¿çš„å ä½ç¬¦å®ç°å¸¸ç”¨çš„æ—¶é—´æ ¼å¼ï¼š

| å ä½ç¬¦          | å¯¹åº”è¡¨è¾¾å¼    | å ä½ç¬¦ä»£è¡¨å«ä¹‰                 |
| --------------- | ------------- | ------------------------------ |
| `@every_second` | `* * * * * *` | ä¸€ç§’é’Ÿè·‘ä¸€æ¬¡                   |
| `@every_minute` | `* * * * *`   | åœ¨åˆ†é’Ÿå¼€å§‹æ—¶æ¯åˆ†é’Ÿè¿è¡Œä¸€æ¬¡     |
| `@hourly`       | `0 * * * *`   | åœ¨å°æ—¶å¼€å§‹æ—¶æ¯å°æ—¶è¿è¡Œä¸€æ¬¡     |
| `@daily`        | `0 0 * * *`   | æ¯å¤©åˆå¤œè¿è¡Œä¸€æ¬¡               |
| `@midnight`     | `0 0 * * *`   | æ¯å¤©åˆå¤œè¿è¡Œä¸€æ¬¡               |
| `@weekly`       | `0 0 * * 0`   | å‘¨æ—¥ä¸Šåˆåˆå¤œæ¯å‘¨è¿è¡Œä¸€æ¬¡       |
| `@monthly`      | `0 0 1 * *`   | æ¯æœˆåœ¨æ¯æœˆç¬¬ä¸€å¤©çš„åˆå¤œè¿è¡Œä¸€æ¬¡ |
| `@yearly`       | `0 0 1 1 *`   | æ¯å¹´ 1 æœˆ 1 æ—¥åˆå¤œè¿è¡Œä¸€æ¬¡     |
| `@annually`     | `0 0 1 1 *`   | æ¯å¹´ 1 æœˆ 1 æ—¥åˆå¤œè¿è¡Œä¸€æ¬¡     |

### 26.5.5 ä½¿ç”¨ `Cron` è¡¨è¾¾å¼

```cs showLineNumbers  {2,5}
// æ¯éš” 1s æ‰§è¡Œ
SpareTime.Do("* * * * * *", (timer, count) => {
    Console.WriteLine("ç°åœ¨æ—¶é—´ï¼š" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
    Console.WriteLine($"ä¸€å…±æ‰§è¡Œäº†ï¼š{count} æ¬¡");
}, cronFormat: CronFormat.IncludeSeconds);
```

:::important å…³äº CronFormat

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`Furion` æ¡†æ¶æœªå¯ç”¨å¯¹ `ç§’` çš„æ”¯æŒï¼Œå¦‚éœ€å¼€å¯ï¼Œåˆ™è®¾ç½® `cronFormat: CronFormat.IncludeSeconds` å³å¯ã€‚é»˜è®¤å€¼æ˜¯ `cronFormat: CronFormat.Standard`

:::

### 26.5.6 ä½¿ç”¨ `Macro` å ä½ç¬¦

```cs showLineNumbers  {2}
// æ¯éš” 1s æ‰§è¡Œ
SpareTime.Do("@every_second", (timer, count) => {
    Console.WriteLine("ç°åœ¨æ—¶é—´ï¼š" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
    Console.WriteLine($"ä¸€å…±æ‰§è¡Œäº†ï¼š{count} æ¬¡");
});
```

### 26.5.7 é…ç½®ä»»åŠ¡ä¿¡æ¯

```cs showLineNumbers  {4}
SpareTime.Do("* * * * *", (timer, count) => {
    Console.WriteLine("ç°åœ¨æ—¶é—´ï¼š" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
    Console.WriteLine($"ä¸€å…±æ‰§è¡Œäº†ï¼š{count} æ¬¡");
}, "cronName", "æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡");
```

### 26.5.8 æ‰‹åŠ¨å¯åŠ¨æ‰§è¡Œ

```cs showLineNumbers  {4,6}
SpareTime.Do("* * * * *", (timer, count) => {
    Console.WriteLine("ç°åœ¨æ—¶é—´ï¼š" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
    Console.WriteLine($"ä¸€å…±æ‰§è¡Œäº†ï¼š{count} æ¬¡");
}, "cronName", "æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡", startNow: false);

SpareTime.Start("cronName");
```

### 26.5.9 `ISpareTimeWorker` æ–¹å¼

```cs showLineNumbers  {1,8}
public class JobWorker : ISpareTimeWorker
{
    /// <summary>
    /// æ¯åˆ†é’Ÿæ‰§è¡Œ
    /// </summary>
    /// <param name="timer"></param>
    /// <param name="count"></param>
    [SpareTime("* * * * *", "jobName", StartNow = true)]
    public void DoSomething(SpareTimer timer, long count)
    {
        Console.WriteLine(DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
        Console.WriteLine($"ä¸€å…±æ‰§è¡Œäº†ï¼š{count} æ¬¡");
    }

    /// <summary>
    /// æ¯åˆ†é’Ÿæ‰§è¡Œï¼ˆæ”¯æŒå¼‚æ­¥ï¼‰
    /// </summary>
    /// <param name="timer"></param>
    /// <param name="count"></param>
    [SpareTime("* * * * *", "jobName", StartNow = true)]
    public async Task DoSomethingAsync(SpareTimer timer, long count)
    {
        Console.WriteLine(DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
        Console.WriteLine($"ä¸€å…±æ‰§è¡Œäº†ï¼š{count} æ¬¡");
        await Task.CompletedTask;
    }
}
```

**éœ€è¦åœ¨ `Startup.cs` ä¸­æ³¨å†Œ `services.AddTaskScheduler()`**

## 26.6 è‡ªå®šä¹‰ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´

æœ‰äº›æ—¶å€™æˆ‘ä»¬éœ€è¦è¿›è¡Œä¸€äº›ä¸šåŠ¡é€»è¾‘ï¼Œæ¯”å¦‚æ•°æ®åº“æŸ¥è¯¢ç­‰æ“ä½œè¿”å›ä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥é€šè¿‡é«˜çº§è‡ªå®šä¹‰æ–¹å¼ã€‚

### 26.6.1 é«˜çº§è‡ªå®šä¹‰é—´éš”æ–¹å¼

```cs showLineNumbers  {2,4-5,7}
SpareTime.Do(()=>{
    // è¿™é‡Œå¯ä»¥æŸ¥è¯¢æ•°æ®åº“æˆ–è¿›è¡Œæˆ–è¿›è¡Œä»»ä½•ä¸šåŠ¡é€»è¾‘

    if(ç¬¦åˆé€»è¾‘){
        return 1000; // æ¯ç§’æ‰§è¡Œ
    }
    else return -1; // ä¸ç¬¦åˆé€»è¾‘å–æ¶ˆä»»åŠ¡
},
(timer,count)=>{
    Console.WriteLine(DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
    Console.WriteLine($"ä¸€å…±æ‰§è¡Œäº†ï¼š{count} æ¬¡");
});
```

:::important é…ç½®æ˜¯å¦æŒç»­æ£€æŸ¥

é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥è‡ªå®šä¹‰ä¼šåœ¨è¿”å› `å°äºæˆ–ç­‰äº0` æ—¶ç»ˆæ­¢ä»»åŠ¡çš„æ‰§è¡Œã€‚ä½†æ˜¯æˆ‘ä»¬å¸Œæœ›è¯¥ä»»åŠ¡ä¸è¦ç»ˆæ­¢ï¼Œåªè¦ç¬¦åˆæ¡ä»¶éƒ½ä¸€ç›´æ‰§è¡Œï¼Œåªéœ€è¦é…ç½® `cancelInNoneNextTime: false` å³å¯

:::

### 26.6.2 é«˜çº§è‡ªå®šä¹‰ `Cron` è¡¨è¾¾å¼

```cs showLineNumbers  {2,4-5,7}
SpareTime.Do(()=>{
    // è¿™é‡Œå¯ä»¥æŸ¥è¯¢æ•°æ®åº“æˆ–è¿›è¡Œæˆ–è¿›è¡Œä»»ä½•ä¸šåŠ¡é€»è¾‘

    if(ç¬¦åˆé€»è¾‘){
        return DateTimeOffset.Now.AddMinutes(10);  // ååˆ†é’Ÿåå†æ‰§è¡Œ
    }
    else return null; // ä¸ç¬¦åˆé€»è¾‘å–æ¶ˆä»»åŠ¡
},
(timer,count) => {
    Console.WriteLine(DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
    Console.WriteLine($"ä¸€å…±æ‰§è¡Œäº†ï¼š{count} æ¬¡");
});
```

:::important é…ç½®æ˜¯å¦æŒç»­æ£€æŸ¥

é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥è‡ªå®šä¹‰ä¼šåœ¨è¿”å› `null` æ—¶ç»ˆæ­¢ä»»åŠ¡çš„æ‰§è¡Œã€‚ä½†æ˜¯æˆ‘ä»¬å¸Œæœ›è¯¥ä»»åŠ¡ä¸è¦ç»ˆæ­¢ï¼Œåªè¦ç¬¦åˆæ¡ä»¶éƒ½ä¸€ç›´æ‰§è¡Œï¼Œåªéœ€è¦é…ç½® `cancelInNoneNextTime: false` å³å¯ï¼Œå¦‚ï¼š

```cs showLineNumbers  {2,4-5,7,12}
SpareTime.Do(()=>{
    // è¿™é‡Œå¯ä»¥æŸ¥è¯¢æ•°æ®åº“æˆ–è¿›è¡Œæˆ–è¿›è¡Œä»»ä½•ä¸šåŠ¡é€»è¾‘

    if(ç¬¦åˆé€»è¾‘){
        return SpareTime.GetCronNextOccurrence("cron è¡¨è¾¾å¼");
    }
    else return null; // ä¸ç¬¦åˆé€»è¾‘ç»§ç»­æ£€æŸ¥
},
(timer,count) => {
    Console.WriteLine(DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
    Console.WriteLine($"ä¸€å…±æ‰§è¡Œäº†ï¼š{count} æ¬¡");
}, cancelInNoneNextTime: false);
```

:::

## 26.7 `ISpareTimeWorker` è¯´æ˜

é™¤äº†ä¸Šé¢çš„ `SpareTime` é™æ€ç±»æ–¹å¼ï¼Œ`Furion` æ¡†æ¶è¿˜æä¾›äº† `ISpareTimeWorker` æ–¹å¼ï¼Œä½¿ç”¨è¯¥æ–¹å¼éå¸¸ç®€å•ï¼Œåªéœ€è¦è‡ªå®šä¹‰ä¸€ä¸ª**å…¬å¼€ä¸”éæŠ½è±¡éé™æ€**ç±»å¹¶å®ç° `ISpareTimeWorker` å³å¯ã€‚

åœ¨è¯¥ç±»ä¸­å®šä¹‰çš„ä»»åŠ¡æ–¹æ³•éœ€æ»¡è¶³ä»¥ä¸‹è§„åˆ™ï¼š

- å¿…é¡»æ˜¯**å…¬å¼€ä¸”å®ä¾‹æ–¹æ³•**
- è¯¥æ–¹æ³•å¿…é¡»è¿”å› `void` ä¸”æä¾› `SpareTimer` å’Œ `long` ä¸¤ä¸ªå‚æ•°
- å¿…é¡»è´´æœ‰ `[SpareTime]` ç‰¹æ€§

å¦‚ï¼š

```cs showLineNumbers  {1,4-5,12-13,20-21,28-30,37-38,45}
public class JobWorker : ISpareTimeWorker
{
    // æ¯éš”ä¸€ç§’æ‰§è¡Œï¼Œä¸”ç«‹å³å¯åŠ¨
    [SpareTime(1000, "jobName1", StartNow = true)]
    public void DoSomething1(SpareTimer timer, long count)
    {
        Console.WriteLine(DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
        Console.WriteLine($"ä¸€å…±æ‰§è¡Œäº†ï¼š{count} æ¬¡");
    }

    // æ¯åˆ†é’Ÿæ‰§è¡Œï¼Œä¸”ç«‹å³å¯åŠ¨
    [SpareTime("* * * * *", "jobName2", StartNow = true)]
    public void DoSomething2(SpareTimer timer, long count)
    {
        Console.WriteLine(DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
        Console.WriteLine($"ä¸€å…±æ‰§è¡Œäº†ï¼š{count} æ¬¡");
    }

    // æ¯ç§’æ‰§è¡Œï¼Œä¸”ç­‰å¾…å¯åŠ¨
    [SpareTime("* * * * * *", "jobName3",CronFormat = CronFormat.IncludeSeconds, StartNow = false)]
    public void DoSomething3(SpareTimer timer, long count)
    {
        Console.WriteLine(DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
        Console.WriteLine($"ä¸€å…±æ‰§è¡Œäº†ï¼š{count} æ¬¡");
    }

    // æ¯ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œæ¯åˆ†é’Ÿä¹Ÿæ‰§è¡Œä¸€æ¬¡
    [SpareTime(1000, "jobName4", StartNow = true)]
    [SpareTime("* * * * *", "jobName5", StartNow = true)]
    public void DoSomething4(SpareTimer timer, long count)
    {
        Console.WriteLine(DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
        Console.WriteLine($"ä¸€å…±æ‰§è¡Œäº†ï¼š{count} æ¬¡");
    }

    // åªæ‰§è¡Œä¸€æ¬¡
    [SpareTime(1000, "jobName5", StartNow = true, DoOnce = true)]
    public void DoSomething5(SpareTimer timer, long count)
    {
        Console.WriteLine(DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
        Console.WriteLine($"ä¸€å…±æ‰§è¡Œäº†ï¼š{count} æ¬¡");
    }

    // è¯»å–é…ç½®æ–‡ä»¶ï¼Œé€šè¿‡ #(é…ç½®è·¯å¾„)
    [SpareTime("#(MyJob:Time)", "jobName6", StartNow = true, DoOnce = true)]
    public void DoSomething5(SpareTimer timer, long count)
    {
        Console.WriteLine(DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
        Console.WriteLine($"ä¸€å…±æ‰§è¡Œäº†ï¼š{count} æ¬¡");
    }

    // æ”¯æŒå¼‚æ­¥
    [SpareTime(1000, "jobName1", StartNow = true)]
    public async Task DoSomethingAsync(SpareTimer timer, long count)
    {
        Console.WriteLine(DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
        Console.WriteLine($"ä¸€å…±æ‰§è¡Œäº†ï¼š{count} æ¬¡");
        await Task.CompletedTask;
    }
}
```

:::warning å…³äºä¾èµ–æ³¨å…¥

`ISpareTimeWorker` æ¥å£ä¸»è¦æ˜¯ç”¨æ¥æŸ¥æ‰¾å®šæ—¶å™¨å¯¹è±¡çš„ï¼Œä¹Ÿå°±æ˜¯å®ƒçš„å®ç°ç±»å¹¶æœªæä¾›ä¾èµ–æ³¨å…¥åŠŸèƒ½ï¼Œæ‰€ä»¥åœ¨å®ç°ç±»å¹¶ä¸æ”¯æŒæ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–é¡¹ã€‚

:::

### 26.7.1 `[SpareTime]` ç‰¹æ€§

`[SpareTime]` æ”¯æŒä»¥ä¸‹é…ç½®å±æ€§

- `Interval`ï¼šé—´éš”æ—¶é—´, `double` ç±»å‹
- `CronExpression`ï¼š`Cron` è¡¨è¾¾å¼ï¼Œ`string` ç±»å‹
- `WorkerName`ï¼šä»»åŠ¡å”¯ä¸€æ ‡è¯†ï¼Œ`string` ç±»å‹ï¼Œ`å¿…å¡«`
- `Description`ï¼šä»»åŠ¡æè¿°ï¼Œ`string` ç±»å‹
- `DoOnce`ï¼šæ˜¯å¦åªæ‰§è¡Œä¸€æ¬¡ï¼Œ`bool` ç±»å‹ï¼Œé»˜è®¤ `false`
- `StartNow`ï¼šæ˜¯å¦ç«‹å³å¯åŠ¨ï¼Œé»˜è®¤ `false`
- `CronFormat`ï¼š`Cron` è¡¨è¾¾å¼æ ¼å¼åŒ–æ–¹å¼ï¼Œ`CronFormat` æšä¸¾ç±»å‹ï¼Œé»˜è®¤ `CronFormat.Standard`
- `ExecuteType`ï¼šé…ç½®ä»»åŠ¡æ‰§è¡Œæ–¹å¼ï¼Œ`SpareTimeExecuteTypes` æšä¸¾ç±»å‹ï¼Œé»˜è®¤ `SpareTimeExecuteTypes.Parallel`

## 26.8 `SpareTime` é™æ€ç±»

`SpareTime` é™æ€ç±»æä¾›äº†ä¸€äº›æ–¹æ³•æ–¹ä¾¿åˆå§‹åŒ–å’Œç®¡ç†ä»»åŠ¡

### 26.8.1 åˆå§‹åŒ–ä»»åŠ¡

```cs showLineNumbers
// å¼€å¯é—´éš”ä»»åŠ¡
SpareTime.Do(interval, [options]);

// å¼€å¯ Cron è¡¨è¾¾å¼ä»»åŠ¡
SpareTime.Do(expression, [options]);

// åªæ‰§è¡Œä¸€æ¬¡ä»»åŠ¡
SpareTime.DoOnce(interval, [options]);

// å®ç°è‡ªå®šä¹‰ä»»åŠ¡
SpareTime.Do(()=>{
    return DateTime.Now.AddMinutes(10);
},[options]);
```

### 26.8.2 å®ç°åå°æ‰§è¡Œ

```cs showLineNumbers
// å®ç°åå°æ‰§è¡Œ
SpareTime.DoIt(()=>{});
```

### 26.8.3 å¼€å§‹ä¸€ä¸ªä»»åŠ¡

```cs showLineNumbers
SpareTime.Start("ä»»åŠ¡æ ‡è¯†");
```

### 26.8.4 æš‚åœä¸€ä¸ªä»»åŠ¡

```cs showLineNumbers
SpareTime.Stop("ä»»åŠ¡æ ‡è¯†");
// è¿˜å¯ä»¥æ ‡è®°ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå¤±è´¥
SpareTime.Stop("ä»»åŠ¡æ ‡è¯†", true);
```

### 26.8.5 å–æ¶ˆä¸€ä¸ªä»»åŠ¡

```cs showLineNumbers
SpareTime.Cancel("ä»»åŠ¡åç§°");
```

### 26.8.6 é”€æ¯æ‰€æœ‰ä»»åŠ¡

```cs showLineNumbers
SpareTime.Dispose();
```

### 26.8.7 è·å–æ‰€æœ‰ä»»åŠ¡

```cs showLineNumbers
var workers = SpareTime.GetWorkers();
```

### 26.8.8 è·å–å•ä¸ªä»»åŠ¡

```cs showLineNumbers
var worker = SpareTime.GetWorker("workerName");
```

### 26.8.9 è§£æ `Cron` è¡¨è¾¾å¼

```cs showLineNumbers
var nextTime = SpareTime.GetCronNextOccurrence("* * * * *");
```

## 26.9 `å¹¶è¡Œ`å’Œ`ä¸²è¡Œ`æ‰§è¡Œæ–¹å¼

`Furion` æ¡†æ¶æä¾›äº†ä»»åŠ¡ä¸¤ç§æ‰§è¡Œæ–¹å¼ `å¹¶è¡Œ` å’Œ `ä¸²è¡Œ`ï¼š

- `å¹¶è¡Œ`ï¼šæ— éœ€ç­‰å¾…ä¸Šä¸€æ¬¡ä»»åŠ¡å®Œæˆï¼Œ**é»˜è®¤å€¼**
- `ä¸²è¡Œ`ï¼šéœ€ç­‰å¾…ä¸Šä¸€æ¬¡ä»»åŠ¡å®Œæˆ

### 26.9.1 `SpareTime` é™æ€æ–¹å¼æŒ‡å®š

```cs showLineNumbers  {3,5}
SpareTime.Do(1000, (t, i) =>
{
    Thread.Sleep(5000); // æ¨¡æ‹Ÿæ‰§è¡Œè€—æ—¶ä»»åŠ¡
    Console.WriteLine($"{t.WorkerName} -{t.Description} - {DateTime.Now:yyyy-MM-dd HH:mm:ss} - {i}");
}, "serialName", "æ¨¡æ‹Ÿä¸²è¡Œä»»åŠ¡", executeType: SpareTimeExecuteTypes.Serial);
```

### 26.9.2 `ISpareTimeWorker` æ–¹å¼

```cs showLineNumbers  {1}
[SpareTime(1000, "jobName1", StartNow = true, ExecuteType = SpareTimeExecuteTypes.Serial)]
public void DoSomething1(SpareTimer timer, long count)
{
    Console.WriteLine(DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
    Console.WriteLine($"ä¸€å…±æ‰§è¡Œäº†ï¼š{count} æ¬¡");
}
```

## 26.10 ä»»åŠ¡å¼‚å¸¸å¤„ç†

æœ‰äº›æ—¶å€™æˆ‘ä»¬å¯èƒ½åœ¨æ‰§è¡Œä»»åŠ¡è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ï¼Œ`Furion` ä¹Ÿæä¾›äº†å±æ€§åˆ¤æ–­æ˜¯å¦æœ‰å¼‚å¸¸å’Œå¼‚å¸¸ä¿¡æ¯ï¼Œæ–¹ä¾¿è®°å½•åˆ°æ—¥å¿—ä¸­ï¼Œå¦‚ï¼š

```cs showLineNumbers  {4-7,11}
SpareTime.Do(1000, (t, c) =>
{
    // åˆ¤æ–­æ˜¯å¦æœ‰å¼‚å¸¸
    if (t.Exception.Any())
    {
        Console.WriteLine(t.Exception.Values.LastOrDefault()?.Message);
    }
    // æ‰§è¡Œç¬¬ä¸‰æ¬¡æŠ›å¼‚å¸¸
    if (c > 2)
    {
        throw Oops.Oh("æŠ›å¼‚å¸¸" + c);
    }
    else
    {
        Console.WriteLine($"{t.WorkerName} -{t.Description} - {DateTime.Now:yyyy-MM-dd HH:mm:ss} - {c}");
    }
}, "exceptionJob");
```

:::warning ç‰¹åˆ«è¯´æ˜

å¦‚æœä¸€ä¸ªä»»åŠ¡è¿ç»­é”™è¯¯æ¬¡æ•°è¾¾ `10æ¬¡` åˆ™ä»»åŠ¡å°†è‡ªåŠ¨åœæ­¢ï¼Œå¹¶æ ‡è®°ä»»åŠ¡çŠ¶æ€ä¸º `Failed`ã€‚

:::

## 26.11 å¦‚ä½•åœ¨ä»»åŠ¡ä¸­è§£æå¯¹è±¡

æœ‰äº›æ—¶å€™æˆ‘ä»¬éœ€è¦åœ¨ä»»åŠ¡ä¸­è¿›è¡Œæ•°æ®åº“æ“ä½œæˆ–è§£ææœåŠ¡ï¼Œè¿™æ—¶å€™æˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ä½œç”¨åŸŸå³å¯

### 26.11.1 `SpareTime` é™æ€ç±»ä¸­

```cs showLineNumbers  {2}
SpareTime.Do(1000, (timer,count) => {
    Scoped.Create((_, scope) =>
    {
        var services = scope.ServiceProvider;

        // è·å–æ•°æ®åº“ä¸Šä¸‹æ–‡
        var dbContext = Db.GetDbContext(services);

        // è·å–ä»“å‚¨
        var respository = Db.GetRepository<Person>(services);

        // è§£æå…¶ä»–æœåŠ¡
        var otherService = services.GetService<XXX>();
        var otherService2 = App.GetService<XXX>(services);
    });
}, "ä»»åŠ¡æ ‡è¯†");
```

### 26.11.2 `ISpareTimeWorker` æ–¹å¼

```cs showLineNumbers  {4}
[SpareTime(1000, "jobName1", StartNow = true, ExecuteType = SpareTimeExecuteTypes.Serial)]
public void DoSomething1(SpareTimer timer, long count)
{
    Scoped.Create((_, scope) =>
    {
        var services = scope.ServiceProvider;

        // è·å–æ•°æ®åº“ä¸Šä¸‹æ–‡
        var dbContext = Db.GetDbContext(services);

        // è·å–ä»“å‚¨
        var respository = Db.GetRepository<Person>(services);

        // è§£æå…¶ä»–æœåŠ¡
        var otherService = services.GetService<XXX>();
        var otherService2 = App.GetService<XXX>(services);
    });
}
```

:::important æ•°æ®åº“æ“ä½œæ³¨æ„

å¦‚æœä½œç”¨åŸŸä¸­å¯¹**æ•°æ®åº“æœ‰ä»»ä½•å˜æ›´æ“ä½œ**ï¼Œéœ€æ‰‹åŠ¨è°ƒç”¨ `SaveChanges` æˆ–å¸¦ `Now` ç»“å°¾çš„æ–¹æ³•ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ `Scoped.CreateUow(handler)` ä»£æ›¿ã€‚

:::

## 26.12 åœ¨ `BackgroundService` ä¸­ä½¿ç”¨

`BackgroundService` æ˜¯ `.NET Core 3` ä¹‹åæä¾›çš„è½»é‡çº§åå°ä»»åŠ¡ï¼ŒåŒæ—¶å¯ä»¥å‘å¸ƒåˆ° `Windows` æœåŠ¡å’Œ `Linux` å®ˆæŠ¤è¿›ç¨‹ä¸­ã€‚

### 26.12.1 é—´éš”æ‰§è¡Œæ–¹å¼

```cs showLineNumbers  {7,18,20,30}
namespace WorkerService;

public class Worker : BackgroundService
{
    private readonly ILogger<Worker> _logger;

    private const int delay = 1000;

    public Worker(ILogger<Worker> logger)
    {
        _logger = logger;
    }

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            var taskFactory = new TaskFactory(System.Threading.Tasks.TaskScheduler.Current);

            await taskFactory.StartNew(async () =>
            {
                // ä½ çš„ä¸šåŠ¡ä»£ç å†™åˆ°è¿™é‡Œé¢

                _logger.LogInformation("Worker running at: {time}", DateTimeOffset.Now);

                await Task.CompletedTask;

            }, stoppingToken);

            await Task.Delay(delay, stoppingToken);
        }
    }
}
```

### 26.12.2 `Cron` è¡¨è¾¾å¼æ‰§è¡Œæ–¹å¼

```cs showLineNumbers  {9,14,21,23,32}
using Furion.TimeCrontab;

namespace WorkerService;

public class Worker : BackgroundService
{
    private readonly ILogger<Worker> _logger;

    private readonly Crontab _crontab;

    public Worker(ILogger<Worker> logger)
    {
        _logger = logger;
        _crontab = Crontab.Parse("* * * * * *", CronStringFormat.WithSeconds);
    }

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            var taskFactory = new TaskFactory(System.Threading.Tasks.TaskScheduler.Current);

            await taskFactory.StartNew(async () =>
            {
                // ä½ çš„ä¸šåŠ¡ä»£ç å†™åˆ°è¿™é‡Œé¢

                _logger.LogInformation("Worker running at: {time}", DateTimeOffset.Now);

                await Task.CompletedTask;
            }, stoppingToken);

            await Task.Delay(_crontab.GetSleepMilliseconds(DateTime.UtcNow), stoppingToken);
        }
    }
}
```

## 26.13 å®šæ—¶ä»»åŠ¡ç›‘å¬å™¨

åœ¨ `Furion v2.18+` ç‰ˆæœ¬ä¹‹åæ–°å¢äº†å®šæ—¶ä»»åŠ¡ç›‘å¬å™¨ `ISpareTimeListener`ï¼Œé€šè¿‡ç›‘å¬å™¨å¯ä»¥å®ç°æ‰€æœ‰å®šæ—¶ä»»åŠ¡çš„çŠ¶æ€ã€‚å¦‚ï¼Œåˆ›å»ºä¸€ä¸ª `å•ä¾‹` çš„ç›‘å¬å™¨ `SpareTimeListener`ï¼š

```cs showLineNumbers  {8,15}
using Furion.DependencyInjection;
using Furion.TaskScheduler;
using System;
using System.Threading.Tasks;

namespace Furion.Core
{
    public class SpareTimeListener : ISpareTimeListener, ISingleton
    {
        /// <summary>
        /// ç›‘å¬æ‰€æœ‰ä»»åŠ¡
        /// </summary>
        /// <param name="executer"></param>
        /// <returns></returns>
        public Task OnListener(SpareTimerExecuter executer)
        {
            switch (executer.Status)
            {
                // æ‰§è¡Œå¼€å§‹é€šçŸ¥
                case 0:
                    Console.WriteLine($"{executer.Timer.WorkerName} ä»»åŠ¡å¼€å§‹é€šçŸ¥");
                    break;
                // ä»»åŠ¡æ‰§è¡Œä¹‹å‰é€šçŸ¥
                case 1:
                    Console.WriteLine($"{executer.Timer.WorkerName} æ‰§è¡Œä¹‹å‰é€šçŸ¥");
                    break;
                // æ‰§è¡ŒæˆåŠŸé€šçŸ¥
                case 2:
                    Console.WriteLine($"{executer.Timer.WorkerName} æ‰§è¡ŒæˆåŠŸé€šçŸ¥");
                    break;
                // ä»»åŠ¡æ‰§è¡Œå¤±è´¥é€šçŸ¥
                case 3:
                    Console.WriteLine($"{executer.Timer.WorkerName} æ‰§è¡Œå¤±è´¥é€šçŸ¥");
                    break;
                // ä»»åŠ¡æ‰§è¡Œåœæ­¢é€šçŸ¥
                case -1:
                    Console.WriteLine($"{executer.Timer.WorkerName} æ‰§è¡Œåœæ­¢é€šçŸ¥");
                    break;
                // ä»»åŠ¡æ‰§è¡Œå–æ¶ˆé€šçŸ¥
                case -2:
                    Console.WriteLine($"{executer.Timer.WorkerName} æ‰§è¡Œå–æ¶ˆé€šçŸ¥");
                    break;
                default:
                    break;
            }

            return Task.CompletedTask;
        }
    }
}
```

### 26.13.1 `SpareTimerExecuter` å±æ€§è¯´æ˜

- `Timer`ï¼š`SpareTimer` å®šæ—¶å™¨å¯¹è±¡
- `Status`ï¼šç›‘å¬çŠ¶æ€
  - `0`ï¼šä»»åŠ¡å¼€å§‹
  - `1`ï¼šæ‰§è¡Œä¹‹å‰
  - `2`ï¼šæ‰§è¡ŒæˆåŠŸ
  - `3`ï¼šæ‰§è¡Œå¤±è´¥
  - `-1`ï¼šä»»åŠ¡åœæ­¢
  - `-2`ï¼šä»»åŠ¡å–æ¶ˆ

## 26.14 IIS éƒ¨ç½²å›æ”¶è®¾ç½®

å¦‚æœåœ¨é¡¹ç›®ä¸­ä½¿ç”¨äº†å®šæ—¶ä»»åŠ¡ä¸”éƒ¨ç½²åˆ° `IIS` ä¸­ï¼Œé‚£ä¹ˆéœ€è¦è®¾ç½® `IIS` ç¦æ­¢å›æ”¶ï¼Œ[ç‚¹å‡»æŸ¥çœ‹ `IIS` å›æ”¶é—®é¢˜è§£å†³æ–¹æ¡ˆ](/docs/deploy-iis#3415-iis-%E5%9B%9E%E6%94%B6%E9%97%AE%E9%A2%98%E5%92%8C%E9%85%8D%E7%BD%AE)

:::warning éƒ¨ç½²å»ºè®®

å»ºè®®å®šæ—¶ä»»åŠ¡é‡‡ç”¨ `Worker Service` ç‹¬ç«‹éƒ¨ç½²æ–¹å¼ï¼Œä¸åº”ä¾æ‰˜ `Web` é¡¹ç›®è¿›ç¨‹ä¸­ã€‚[æŸ¥çœ‹ã€ Worker Serviceã€‘ç« èŠ‚](/docs/process-service.mdx)

:::

## 26.15 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::
