---
id: view-engine
title: 17. è§†å›¾å¼•æ“
sidebar_label: 17. è§†å›¾å¼•æ“
---

## 17.1 å…³äºè§†å›¾å¼•æ“

è§†å›¾å¼•æ“è´Ÿè´£æ ¹æ®è§†å›¾æ¨¡æ¿åˆ›å»º HTMLã€‚è§†å›¾é€šå¸¸æ˜¯ HTML å’Œç¼–ç¨‹è¯­è¨€çš„æŸç§æ··åˆã€‚æ”¯æŒå˜é‡å®šä¹‰ã€æ–¹æ³•è°ƒç”¨åŠé€»è¾‘ç¼–å†™ã€‚

åœ¨ `Furion` æ¡†æ¶ä¸­ï¼Œåº•å±‚é›†æˆäº†å¾®è½¯æä¾›çš„ `Razor` è§†å›¾å¼•æ“ç»„ä»¶å¹¶æä¾›æ›´åŠ çµæ´»æ–¹ä¾¿çš„è¯­æ³•ç³–ã€‚

## 17.2 è§†å›¾å¼•æ“ä½œç”¨

- **æ”¯æŒ `ASP.NET Core` å®Œæ•´çš„ `Razor` è¯­æ³•**
- æ ¹æ®ä¸åŒçš„æ•°æ®ç¼–è¯‘æ¨¡æ¿äº§ç”Ÿä¸åŒçš„è¾“å‡º
- å®ç°å¼ºå¤§çš„æ’ä»¶åŒ–æœºåˆ¶
- å®ç°å…¨ç«™é¡µé¢é™æ€åŒ–
- å¯ä»¥ç”¨ä½œé‚®ä»¶æ¨¡æ¿ã€çŸ­ä¿¡æ¨¡æ¿ã€ä¼˜æƒ åˆ¸ä¿¡æ¯æ¨¡æ¿ç­‰

## 17.3 åŸºç¡€ä½¿ç”¨

### 17.3.1 æ³¨å†ŒæœåŠ¡

ä½¿ç”¨ä¹‹å‰éœ€åœ¨ `Startup.cs` ä¸­æ³¨å†Œ `è§†å›¾å¼•æ“æœåŠ¡`ï¼š

```cs showLineNumbers  {3}
public void ConfigureServices(IServiceCollection services)
{
    services.AddViewEngine();
}
```

### 17.3.2 ä½¿ç”¨æ–¹å¼

- æ„é€ å‡½æ•°æ³¨å…¥ `IViewEngine`

```cs showLineNumbers  {2,9,12}
using Furion.DynamicApiController;
using Furion.ViewEngine;

namespace Furion.Application
{
    public class ViewEngineService : IDynamicApiController
    {
        private readonly IViewEngine _viewEngine;
        public ViewEngineService(IViewEngine viewEngine)
        {
            _viewEngine = viewEngine;
            var result = _viewEngine.RunCompile("Hello @Model.Name", new { Name = "Furion" });
        }
    }
}
```

- å­—ç¬¦ä¸²æ–¹å¼

```cs showLineNumbers 
var result = "Hello @Model.Name".RunCompile(new { Name = "Furion" });
```

### 17.3.3 å¼±ç±»å‹æ¨¡æ¿

```cs showLineNumbers 
var result = _viewEngine.RunCompile("Hello @Model.Name", new { Name = "Furion" });
```

ç»“æœï¼š

```html showLineNumbers 
Hello Furion
```

æ”¯æŒå¼‚æ­¥ `RunCompileAsync`

### 17.3.4 å¼ºç±»å‹æ¨¡æ¿

```cs showLineNumbers 
var result = _viewEngine.RunCompile(@"
Hello @Model.Name
@foreach(var item in Model.Items)
{
    <p>@item</p>
}
", new TestModel
{
    Name = "Furion",
    Items = new[] { 3, 1, 2 }
});
```

ç»“æœï¼š

```html showLineNumbers 
Hello Furion
<p>3</p>
<p>1</p>
<p>2</p>
```

æ”¯æŒå¼‚æ­¥ `RunCompileAsync`

### 17.3.5 é«˜æ€§èƒ½æ¨¡æ¿ç¼“å­˜ ğŸ¥‡

ç”±äºæ¨¡æ¿ç¼–è¯‘éœ€è¦æ¶ˆè€—å¤§é‡çš„æ€§èƒ½ï¼Œæ‰€ä»¥å»ºè®®ä½¿ç”¨å¸¦ `FromCached` ç»“å°¾çš„ `RunCompileFromCached` æ›¿ä»£ã€‚è°ƒç”¨è¯¥æ–¹æ³•åä¼šè‡ªåŠ¨å°†æ¨¡æ¿ç¼–è¯‘æˆ `.dll` ä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨ã€‚å‡å°‘ç¬¬äºŒæ¬¡ä¹‹åä½¿ç”¨æ¨¡æ¿çš„æ€§èƒ½æŸè€—ã€‚

å¦‚ï¼Œå¼ºç±»å‹æ¨¡æ¿ï¼š

```cs showLineNumbers 
var result = _viewEngine.RunCompileFromCached(@"
Hello @Model.Name
@foreach(var item in Model.Items)
{
    <p>@item</p>
}
", new TestModel
{
    Name = "Furion",
    Items = new[] { 3, 1, 2 }
});
```

ç»“æœï¼š

```html showLineNumbers 
Hello Furion
<p>3</p>
<p>1</p>
<p>2</p>
```

**è°ƒç”¨ `RunCompileFromCached` æ–¹æ³•ä¹‹åå°†ä¼šä½¿ç”¨ `MD5` åŠ å¯†æ¨¡æ¿å¹¶ç”Ÿæˆ `MD5`å­—ç¬¦ä¸²çš„ `.dll` å­˜æ”¾åœ¨ç½‘ç«™æ ¹ç›®å½•ä¸‹çš„ `templates` ç›®å½•ä¸­ã€‚åªè¦æ¨¡æ¿å†…å®¹ä¸å˜ï¼Œæ•°æ®å‘ç”Ÿæ”¹å˜ä¹Ÿä¸ä¼šé‡æ–°ç¼–è¯‘æ¨¡æ¿ã€‚è¿™æ ·å¤§å¤§çš„æé«˜äº†é¦–æ¬¡ä¹‹åçš„æ€§èƒ½ã€‚**

å¦‚ï¼Œä¼ å…¥æ–°çš„æ•°æ®ï¼š

```cs showLineNumbers  {10}
var result = _viewEngine.RunCompileFromCached(@"
Hello @Model.Name
@foreach(var item in Model.Items)
{
    <p>@item</p>
}
", new TestModel
{
    Name = "Furion",
    Items = new[] { 5,6,7,8 }
});
```

ç»“æœï¼š

```html showLineNumbers 
Hello Furion
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
```

æ¨¡æ¿ä¸å†é‡æ–°ç¼–è¯‘ï¼Œåªæ˜¯é‡æ–°æ›¿æ¢æ•°æ®ã€‚

## 17.4 é«˜çº§ç”¨æ³•

é«˜çº§ç”¨æ³•æ”¯æŒå°†ç‰¹å®šç¨‹åºé›†ã€ç‰¹å®šå‘½åç©ºé—´ã€ç‰¹å®šç±»å‹å¼•å…¥åˆ°æ¨¡æ¿ä¸­ä½¿ç”¨ã€‚

### 17.4.1 æ·»åŠ ç¨‹åºé›†

æ¯”å¦‚è¿™é‡Œæ·»åŠ  `System.IO` ç¨‹åºé›†ï¼š

```cs showLineNumbers 
var result = _viewEngine.RunCompileFromCached(@"<div>@System.IO.Path.Combine(""Furion"", ""ViewEngine"")</div>", builderAction: builder =>
            {
                builder.AddAssemblyReferenceByName("System.IO");
            });
```

ç»“æœï¼š

```html showLineNumbers 
<div>Furion\\ViewEngine</div>
```

å¦å¤–ï¼Œ`Furion` æä¾›å¤šç§æ–¹å¼åŠ è½½ç¨‹åºé›†ï¼š

```cs showLineNumbers 
builder.AddAssemblyReferenceByName("System.Security"); // é€šè¿‡åç§°
builder.AddAssemblyReference(typeof(System.IO.File)); // é€šè¿‡ç±»å‹
builder.AddAssemblyReference(Assembly.Load("source")); // é€šè¿‡å…ƒæ•°æ®å¼•ç”¨
```

### 17.4.2 æ·»åŠ å‘½åç©ºé—´

```cs showLineNumbers 
var result = _viewEngine.RunCompileFromCached(@"<div>@Path.Combine(""Furion"", ""ViewEngine"")</div>", builderAction: builder =>
            {
                builder.AddUsing("System.IO");
                builder.AddAssemblyReferenceByName("System.IO");
            });
```

ç»“æœï¼š

```html showLineNumbers 
<div>Furion\\ViewEngine</div>
```

ä¹Ÿæ”¯æŒåŠ å…¥å¤šä¸ª `using`ï¼š

```
builder.AddUsing("System.IO");
builder.AddUsing("Furion");
```

### 17.4.3 å®šä¹‰æ¨¡æ¿æ–¹æ³•

```cs showLineNumbers 
var result = _viewEngine.RunCompileFromCached(@"
<area>
    @{ RecursionTest(3); }
</area>

@{
  void RecursionTest(int level)
  {
	if (level <= 0)
	{
		return;
	}

	<div>LEVEL: @level</div>
	@{ RecursionTest(level - 1); }
  }
}
");
```

ç»“æœï¼š

```html showLineNumbers 
<area>
<div>LEVEL: 3</div>
<div>LEVEL: 2</div>
<div>LEVEL: 1</div>
</area>
```

### 17.4.4 è°ƒç”¨ç±»æ–¹æ³•

å®šä¹‰ `CustomModel` ç±»å¹¶ç»§æ‰¿ `ViewEngineModel` åŸºç±»

```cs showLineNumbers  {1}
public class CustomModel : ViewEngineModel
{
    public int A { get; set; }
    public string B { get; set; }
    public string Decorator(object value)
    {
        return "-=" + value + "=-";
    }
}
```

åœ¨æ¨¡æ¿ä¸­è°ƒç”¨ `Decorator(value)` æ–¹æ³•ï¼š

```cs showLineNumbers 
var content = @"Hello @A, @B, @Decorator(123)";

var template = _viewEngine.Compile<CustomModel>(content);

var result = template.Run(instance =>
{
    instance.A = 10;
    instance.B = "Alex";
});
```

ç»“æœï¼š

```html showLineNumbers 
Hello 10, Alex, -=123=-
```

## 17.5 `IViewEngine` æ¥å£

`IViewEngine` æä¾›äº†ç®€å•æ–¹ä¾¿çš„ `RunCompile` æ–¹æ³•ï¼Œä¹Ÿæä¾›äº†æœ€åŸå§‹åŒ–çš„ `Compile` å’Œ `Run` æ–¹æ³•ã€‚

é€šè¿‡åŸå§‹çš„ `Compile` å’Œ `Run` æ–¹æ³•å¯ä»¥å®ç°å¾ˆå¤šå¤æ‚çš„é€»è¾‘å’Œè‡ªå®šä¹‰æŒ‡ä»¤é›†ã€‚

```cs showLineNumbers 
/// <summary>
/// ç¼–è¯‘æ¨¡æ¿
/// </summary>
/// <param name="content"></param>
/// <param name="builderAction"></param>
/// <returns></returns>
IViewEngineTemplate Compile(string content, Action<IViewEngineOptionsBuilder> builderAction = null);
/// <summary>
/// ç¼–è¯‘æ¨¡æ¿
/// </summary>
/// <param name="content"></param>
/// <param name="builderAction"></param>
/// <returns></returns>
Task<IViewEngineTemplate> CompileAsync(string content, Action<IViewEngineOptionsBuilder> builderAction = null);
/// <summary>
/// ç¼–è¯‘æ¨¡æ¿
/// </summary>
/// <typeparam name="T"></typeparam>
/// <param name="content"></param>
/// <param name="builderAction"></param>
/// <returns></returns>
IViewEngineTemplate<T> Compile<T>(string content, Action<IViewEngineOptionsBuilder> builderAction = null)
    where T : IViewEngineModel;
/// <summary>
/// ç¼–è¯‘æ¨¡æ¿
/// </summary>
/// <typeparam name="T"></typeparam>
/// <param name="content"></param>
/// <param name="builderAction"></param>
/// <returns></returns>
Task<IViewEngineTemplate<T>> CompileAsync<T>(string content, Action<IViewEngineOptionsBuilder> builderAction = null)
    where T : IViewEngineModel;
```

## 17.6 å­—ç¬¦ä¸²æ¨¡æ¿æ›¿æ¢å¼•æ“

`Furion` é™¤äº†å†…ç½®è§†å›¾å¼•æ“ä¹‹å¤–ï¼Œè¿˜æ”¯æŒä»¥ä¸‹å‡ ç§æ¨¡æ¿æ›¿æ¢ï¼Œå¦‚ï¼š

```cs showLineNumbers 
// æä¾›æ•°æ®æ¨¡æ¿æ–¹å¼
var str = "æˆ‘å«{name}".Render(new Dictionary{ {"name", "Furion"} });
var str = "æˆ‘å«{Name}".Render(new { Name = "Furion" });
var str = "æˆ‘å«{Detail.Name}".Render(new { Detail = new { Name = "Furoin" } });

// ä»é…ç½®è¯»å–æ–¹å¼
var str = "æˆ‘å«#(Furion:Address)".Render();
```

```json showLineNumbers 
{
  "Furion": {
    "Address": "https://www.furion.icu"
  }
}
```

## 17.7 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::
