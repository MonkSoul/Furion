---
id: view-engine
title: 17. è§†å›¾/æ¨¡æ¿å¼•æ“
sidebar_label: 17. è§†å›¾/æ¨¡æ¿jå¼•æ“
---

import Tag from "@site/src/components/Tag.js";

<details>
  <summary>ğŸ“ æ¨¡å—æ›´æ–°æ—¥å¿—</summary>
  <div>
<div>

- **æ–°ç‰¹æ€§**

  - &nbsp;<Tag>æ–°å¢</Tag> è§†å›¾å¼•æ“æ”¯æŒæ— å‘½åç©ºé—´çš„å¼ºç±»å‹ <sup>4.8.4.16</sup> <sup>â±ï¸2023.01.15</sup> [#I6ABN3](https://gitee.com/dotnetchina/Furion/issues/I6ABN3) [#I6A7SI](https://gitee.com/dotnetchina/Furion/issues/I6A7SI) [076bb17](https://gitee.com/dotnetchina/Furion/commit/076bb1781ab1a31b5b6a42a56910909b3528d25e)
  - &nbsp;<Tag>æ–°å¢</Tag> è§†å›¾å¼•æ“æ”¯æŒåŒ¿åç±»å‹æ¨¡å‹å¸¦é›†åˆç±»å‹å±æ€§ `@foreach` éå† <sup>4.8.4.15</sup> <sup>â±ï¸2023.01.13</sup> [#I6A7SI](https://gitee.com/dotnetchina/Furion/issues/I6A7SI)

- **é—®é¢˜ä¿®å¤**

  - &nbsp;<Tag>ä¿®å¤</Tag> `TP.Wrapper` é™æ€ç±»ä¸èƒ½å‡†ç¡®è¯†åˆ«å¤šè¡Œå†…å®¹é—®é¢˜ <sup>4.8.7.40</sup> <sup>â±ï¸2023.04.10</sup> [#I6UAC8](https://gitee.com/dotnetchina/Furion/issues/I6UAC8)
  - &nbsp;<Tag>ä¿®å¤</Tag> è§†å›¾å¼•æ“æ¨¡å‹ä¸ºåŒ¿åæ³›å‹é›†åˆç±»å‹æ—¶å‡ºç°ç±»å‹è½¬æ¢å¼‚å¸¸ <sup>4.8.7.38</sup> <sup>â±ï¸2023.04.07</sup> [!773](https://gitee.com/dotnetchina/Furion/pulls/773)
  - &nbsp;<Tag>ä¿®å¤</Tag> è§†å›¾å¼•æ“ä¸æ”¯æŒå¼ºåˆ¶è½¬æ¢çš„ `(object)model` ç±»å‹ <sup>4.8.7.16</sup> <sup>â±ï¸2023.03.19</sup> [#I6O3BD](https://gitee.com/dotnetchina/Furion/issues/I6O3BD)

- **å…¶ä»–æ›´æ”¹**

  - &nbsp;<Tag>è°ƒæ•´</Tag> è§†å›¾å¼•æ“é»˜è®¤ç¨‹åºé›†ï¼Œè¿½åŠ  `System.Collections` ç¨‹åºé›† <sup>4.8.7.16</sup> <sup>â±ï¸2023.03.18</sup> [#I6O3BD](https://gitee.com/dotnetchina/Furion/issues/I6O3BD)

</div>
  </div>
</details>

## 17.1 å…³äºè§†å›¾å¼•æ“

è§†å›¾å¼•æ“è´Ÿè´£æ ¹æ®è§†å›¾æ¨¡æ¿åˆ›å»º HTMLã€‚è§†å›¾é€šå¸¸æ˜¯ HTML å’Œç¼–ç¨‹è¯­è¨€çš„æŸç§æ··åˆã€‚æ”¯æŒå˜é‡å®šä¹‰ã€æ–¹æ³•è°ƒç”¨åŠé€»è¾‘ç¼–å†™ã€‚

åœ¨ `Furion` æ¡†æ¶ä¸­ï¼Œåº•å±‚é›†æˆäº†å¾®è½¯æä¾›çš„ `Razor` è§†å›¾å¼•æ“ç»„ä»¶å¹¶æä¾›æ›´åŠ çµæ´»æ–¹ä¾¿çš„è¯­æ³•ç³–ã€‚

## 17.2 è§†å›¾å¼•æ“ä½œç”¨

- **æ”¯æŒ `ASP.NET Core` å®Œæ•´çš„ `Razor` è¯­æ³•**
- æ ¹æ®ä¸åŒçš„æ•°æ®ç¼–è¯‘æ¨¡æ¿äº§ç”Ÿä¸åŒçš„è¾“å‡º
- å®ç°å¼ºå¤§çš„æ’ä»¶åŒ–æœºåˆ¶
- å®ç°å…¨ç«™é¡µé¢é™æ€åŒ–
- å¯ä»¥ç”¨ä½œé‚®ä»¶æ¨¡æ¿ã€çŸ­ä¿¡æ¨¡æ¿ã€ä¼˜æƒ åˆ¸ä¿¡æ¯æ¨¡æ¿ç­‰

## 17.3 åŸºç¡€ä½¿ç”¨

### 17.3.1 æ³¨å†ŒæœåŠ¡

ä½¿ç”¨ä¹‹å‰éœ€åœ¨ `Startup.cs` ä¸­æ³¨å†Œ `è§†å›¾å¼•æ“æœåŠ¡`ï¼š

```cs showLineNumbers  {3}
public void ConfigureServices(IServiceCollection services)
{
    services.AddViewEngine();
}
```

### 17.3.2 ä½¿ç”¨æ–¹å¼

- æ„é€ å‡½æ•°æ³¨å…¥ `IViewEngine`

```cs showLineNumbers  {2,9,12}
using Furion.DynamicApiController;
using Furion.ViewEngine;

namespace Furion.Application
{
    public class ViewEngineService : IDynamicApiController
    {
        private readonly IViewEngine _viewEngine;
        public ViewEngineService(IViewEngine viewEngine)
        {
            _viewEngine = viewEngine;
            var result = _viewEngine.RunCompile("Hello @Model.Name", new { Name = "Furion" });
        }
    }
}
```

- å­—ç¬¦ä¸²æ–¹å¼

```cs showLineNumbers
var result = "Hello @Model.Name".RunCompile(new { Name = "Furion" });
```

### 17.3.3 å¼±ç±»å‹æ¨¡æ¿

```cs showLineNumbers
var result = _viewEngine.RunCompile("Hello @Model.Name", new { Name = "Furion" });
```

ç»“æœï¼š

```html showLineNumbers
Hello Furion
```

æ”¯æŒå¼‚æ­¥ `RunCompileAsync`

### 17.3.4 å¼ºç±»å‹æ¨¡æ¿

- **ç±»å‹å®šä¹‰**

```cs showLineNumbers {1}
namespace YourProject;  // Furion 4.8.4.16+ æ”¯æŒæ— å‘½åç©ºé—´å†™æ³•

public class TestModel
{
    public string Name { get; set; }
    public int[] Items { get; set; }
}
```

- **ä½¿ç”¨å¼ºç±»å‹**

```cs showLineNumbers {1,7}
var result = _viewEngine.RunCompile(@"
Hello @Model.Name
@foreach(var item in Model.Items)
{
    <p>@item</p>
}
", new TestModel    // Furion 4.8.4.16+ æ”¯æŒåŒ¿åç±»å‹
{
    Name = "Furion",
    Items = new[] { 3, 1, 2 }
});
```

ç»“æœï¼š

```html showLineNumbers
Hello Furion
<p>3</p>
<p>1</p>
<p>2</p>
```

æ”¯æŒå¼‚æ­¥ `RunCompileAsync`

### 17.3.5 é«˜æ€§èƒ½æ¨¡æ¿ç¼“å­˜ ğŸ¥‡

ç”±äºæ¨¡æ¿ç¼–è¯‘éœ€è¦æ¶ˆè€—å¤§é‡çš„æ€§èƒ½ï¼Œæ‰€ä»¥å»ºè®®ä½¿ç”¨å¸¦ `FromCached` ç»“å°¾çš„ `RunCompileFromCached` æ›¿ä»£ã€‚è°ƒç”¨è¯¥æ–¹æ³•åä¼šè‡ªåŠ¨å°†æ¨¡æ¿ç¼–è¯‘æˆ `.dll` ä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨ã€‚å‡å°‘ç¬¬äºŒæ¬¡ä¹‹åä½¿ç”¨æ¨¡æ¿çš„æ€§èƒ½æŸè€—ã€‚

å¦‚ï¼Œå¼ºç±»å‹æ¨¡æ¿ï¼š

```cs showLineNumbers {1}
var result = _viewEngine.RunCompileFromCached(@"
Hello @Model.Name
@foreach(var item in Model.Items)
{
    <p>@item</p>
}
", new TestModel    // Furion 4.8.4.16+ æ”¯æŒåŒ¿åç±»å‹
{
    Name = "Furion",
    Items = new[] { 3, 1, 2 }
});
```

ç»“æœï¼š

```html showLineNumbers
Hello Furion
<p>3</p>
<p>1</p>
<p>2</p>
```

**è°ƒç”¨ `RunCompileFromCached` æ–¹æ³•ä¹‹åå°†ä¼šä½¿ç”¨ `MD5` åŠ å¯†æ¨¡æ¿å¹¶ç”Ÿæˆ `MD5`å­—ç¬¦ä¸²çš„ `.dll` å­˜æ”¾åœ¨ç½‘ç«™æ ¹ç›®å½•ä¸‹çš„ `templates` ç›®å½•ä¸­ã€‚åªè¦æ¨¡æ¿å†…å®¹ä¸å˜ï¼Œæ•°æ®å‘ç”Ÿæ”¹å˜ä¹Ÿä¸ä¼šé‡æ–°ç¼–è¯‘æ¨¡æ¿ã€‚è¿™æ ·å¤§å¤§çš„æé«˜äº†é¦–æ¬¡ä¹‹åçš„æ€§èƒ½ã€‚**

å¦‚ï¼Œä¼ å…¥æ–°çš„æ•°æ®ï¼š

```cs showLineNumbers  {1,10}
var result = _viewEngine.RunCompileFromCached(@"
Hello @Model.Name
@foreach(var item in Model.Items)
{
    <p>@item</p>
}
", new TestModel    // Furion 4.8.4.16+ æ”¯æŒåŒ¿åç±»å‹
{
    Name = "Furion",
    Items = new[] { 5,6,7,8 }
});
```

ç»“æœï¼š

```html showLineNumbers
Hello Furion
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
```

æ¨¡æ¿ä¸å†é‡æ–°ç¼–è¯‘ï¼Œåªæ˜¯é‡æ–°æ›¿æ¢æ•°æ®ã€‚

## 17.4 é«˜çº§ç”¨æ³•

é«˜çº§ç”¨æ³•æ”¯æŒå°†ç‰¹å®šç¨‹åºé›†ã€ç‰¹å®šå‘½åç©ºé—´ã€ç‰¹å®šç±»å‹å¼•å…¥åˆ°æ¨¡æ¿ä¸­ä½¿ç”¨ã€‚

### 17.4.1 æ·»åŠ ç¨‹åºé›†

æ¯”å¦‚è¿™é‡Œæ·»åŠ  `System.IO` ç¨‹åºé›†ï¼š

```cs showLineNumbers {3}
var result = _viewEngine.RunCompileFromCached(@"<div>@System.IO.Path.Combine(""Furion"", ""ViewEngine"")</div>", builderAction: builder =>
            {
                builder.AddAssemblyReferenceByName("System.IO");
            });
```

ç»“æœï¼š

```html showLineNumbers
<div>Furion\\ViewEngine</div>
```

å¦å¤–ï¼Œ`Furion` æä¾›å¤šç§æ–¹å¼åŠ è½½ç¨‹åºé›†ï¼š

```cs showLineNumbers
builder.AddAssemblyReferenceByName("System.Security"); // é€šè¿‡åç§°
builder.AddAssemblyReference(typeof(System.IO.File)); // é€šè¿‡ç±»å‹
builder.AddAssemblyReference(Assembly.Load("source")); // é€šè¿‡å…ƒæ•°æ®å¼•ç”¨
```

### 17.4.2 æ·»åŠ å‘½åç©ºé—´

```cs showLineNumbers {3-4}
var result = _viewEngine.RunCompileFromCached(@"<div>@Path.Combine(""Furion"", ""ViewEngine"")</div>", builderAction: builder =>
            {
                builder.AddUsing("System.IO");
                builder.AddAssemblyReferenceByName("System.IO");
            });
```

ç»“æœï¼š

```html showLineNumbers
<div>Furion\\ViewEngine</div>
```

ä¹Ÿæ”¯æŒåŠ å…¥å¤šä¸ª `using`ï¼š

```
builder.AddUsing("System.IO");
builder.AddUsing("Furion");
```

### 17.4.3 å®šä¹‰æ¨¡æ¿æ–¹æ³•

```cs showLineNumbers
var result = _viewEngine.RunCompileFromCached(@"
<area>
    @{ RecursionTest(3); }
</area>

@{
  void RecursionTest(int level)
  {
	if (level <= 0)
	{
		return;
	}

	<div>LEVEL: @level</div>
	@{ RecursionTest(level - 1); }
  }
}
");
```

ç»“æœï¼š

```html showLineNumbers
<area>
<div>LEVEL: 3</div>
<div>LEVEL: 2</div>
<div>LEVEL: 1</div>
</area>
```

### 17.4.4 è°ƒç”¨ç±»æ–¹æ³•

å®šä¹‰ `CustomModel` ç±»å¹¶ç»§æ‰¿ `ViewEngineModel` åŸºç±»

```cs showLineNumbers  {1,6}
public class CustomModel : ViewEngineModel
{
    public int A { get; set; }
    public string B { get; set; }

    public string Decorator(object value)
    {
        return "-=" + value + "=-";
    }
}
```

åœ¨æ¨¡æ¿ä¸­è°ƒç”¨ `Decorator(value)` æ–¹æ³•ï¼š

```cs showLineNumbers {1,3,5}
var content = @"Hello @A, @B, @Decorator(123)";

var template = _viewEngine.Compile<CustomModel>(content);

var result = template.Run(instance =>
{
    instance.A = 10;
    instance.B = "Alex";
});
```

ç»“æœï¼š

```html showLineNumbers
Hello 10, Alex, -=123=-
```

## 17.5 ç‰¹æ®Šå­—ç¬¦å¤„ç†

å¦‚æœ‰ç‰¹æ®Šç¬¦å·å¦‚ï¼š`<`ï¼Œ`<>`ï¼Œ`&` ç­‰ç¬¦å·ï¼Œå¯é€šè¿‡ `@("<")` è¿›è¡ŒåŸæ ·è¾“å‡ºã€‚

## 17.6 å­—ç¬¦ä¸²æ¨¡æ¿æ›¿æ¢å¼•æ“

`Furion` é™¤äº†å†…ç½®è§†å›¾å¼•æ“ä¹‹å¤–ï¼Œè¿˜æ”¯æŒä»¥ä¸‹å‡ ç§æ¨¡æ¿æ›¿æ¢ï¼Œå¦‚ï¼š

```cs showLineNumbers {2-4,7}
// æä¾›æ•°æ®æ¨¡æ¿æ–¹å¼
var str = "æˆ‘å«{name}".Render(new Dictionary{ {"name", "Furion"} });
var str = "æˆ‘å«{Name}".Render(new { Name = "Furion" });
var str = "æˆ‘å«{Detail.Name}".Render(new { Detail = new { Name = "Furoin" } });

// ä»é…ç½®è¯»å–æ–¹å¼
var str = "æˆ‘å«#(Furion:Address)".Render();
```

```json showLineNumbers
{
  "Furion": {
    "Address": "https://furion.baiqian.ltd"
  }
}
```

## 17.7 æ ¼å¼åŒ–è§„èŒƒæ¨¡æ¿

åœ¨ `Furion v3.5.3+` æ–°å¢äº† `TP.Wrapper(...)` è§„èŒƒæ¨¡æ¿ï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š

```cs showLineNumbers {2}
// ç”Ÿæˆæ¨¡æ¿å­—ç¬¦ä¸²
var template = TP.Wrapper("Furion æ¡†æ¶", "è®© .NET å¼€å‘æ›´ç®€å•ï¼Œæ›´é€šç”¨ï¼Œæ›´æµè¡Œã€‚",
    "##ä½œè€…## ç™¾å°åƒ§",
    "##å½“å‰ç‰ˆæœ¬## v3.5.3",
    "##æ–‡æ¡£åœ°å€## https://furion.baiqian.ltd",
    "##Copyright## ç™¾å°åƒ§, ç™¾ç­¾ç§‘æŠ€ï¼ˆå¹¿ä¸œï¼‰æœ‰é™å…¬å¸");

Console.WriteLine(template);
```

æ—¥å¿—æ‰“å°æ¨¡æ¿å¦‚ä¸‹ï¼š

```bash showLineNumbers
â”â”â”â”â”â”â”â”â”â”â”â”  Furion æ¡†æ¶ â”â”â”â”â”â”â”â”â”â”â”
â”£ è®© .NET å¼€å‘æ›´ç®€å•ï¼Œæ›´é€šç”¨ï¼Œæ›´æµè¡Œã€‚
â”£
â”£ ä½œè€…ï¼š        ç™¾å°åƒ§
â”£ å½“å‰ç‰ˆæœ¬ï¼š     v3.5.3
â”£ æ–‡æ¡£åœ°å€ï¼š     https://furion.baiqian.ltd
â”£ Copyrightï¼š   ç™¾å°åƒ§, ç™¾ç­¾ç§‘æŠ€ï¼ˆå¹¿ä¸œï¼‰æœ‰é™å…¬å¸
â”—â”â”â”â”â”â”â”â”â”â”â”  Furion æ¡†æ¶ â”â”â”â”â”â”â”â”â”â”â”
```

:::tip å…³äºå±æ€§ç”Ÿæˆ

å¦‚æœåˆ—è¡¨é¡¹ä»¥ `##å±æ€§å##` å¼€å¤´ï¼Œè‡ªåŠ¨ç”Ÿæˆ `å±æ€§åï¼š` ä½œä¸ºè¡Œé¦–ä¸”è‡ªåŠ¨ç­‰å®½å¯¹é½ã€‚

`Furion 3.9.1` ä¹‹å‰ç‰ˆæœ¬ä½¿ç”¨ `[å±æ€§å]` å¼€å¤´ã€‚

:::

## 17.8 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::
