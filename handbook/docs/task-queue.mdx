---
id: task-queue
title: 26.3 ä»»åŠ¡é˜Ÿåˆ—
sidebar_label: 26.3 ä»»åŠ¡é˜Ÿåˆ—
---

import Tag from "@site/src/components/Tag.js";

<details>
  <summary>ğŸ“ æ¨¡å—æ›´æ–°æ—¥å¿—</summary>
  <div>
<div>

- **æ–°ç‰¹æ€§**

  - &nbsp;<Tag>æ–°å¢</Tag> `Enqueue/EnqueueAsync` æ”¯æŒ `Cron` è¡¨è¾¾å¼ å®ä¾‹é‡è½½æ–¹æ³• <sup>4.8.4.10</sup> <sup>â±ï¸2023.01.09</sup> [#I69HM4](https://gitee.com/dotnetchina/Furion/issues/I69HM4)

</div>
  </div>
</details>

import useBaseUrl from "@docusaurus/useBaseUrl";

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.3 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

:::tip å°çŸ¥è¯†

ä»»åŠ¡é˜Ÿåˆ—å¯å–ä»£æ—§ç‰ˆæœ¬å®šæ—¶ä»»åŠ¡çš„ `SpareTime.DoIt()` å’Œ `SpareTime.DoOnce` åŠŸèƒ½ã€‚

:::

## 26.3.1 å…³äºä»»åŠ¡é˜Ÿåˆ—

ä»»åŠ¡é˜Ÿåˆ—å¸¸ç”¨äºç®¡ç†åå°å·¥ä½œï¼Œ**é€šå¸¸è¿™äº›åå°å·¥ä½œåœ¨ä¸»çº¿ç¨‹å“åº”ä¹‹å¤–ï¼Œä¸ä¼šå¯¹ä¸»çº¿ç¨‹æˆ–å½“å‰çº¿ç¨‹å“åº”é˜»å¡**ã€‚ä»»åŠ¡é˜Ÿåˆ—çš„ä¸€ä¸ªæ˜¾è‘—ç‰¹å®šå°±æ˜¯å®ƒæ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå…¥é˜Ÿçš„é¡ºåºå†³å®šå®ƒå‡ºé˜Ÿæ‰§è¡Œçš„å…ˆåã€‚

ä»»åŠ¡é˜Ÿåˆ—ä½¿ç”¨ `Channel` + `Task` + `ThreadPoolï¼ˆçº¿ç¨‹æ± ï¼‰` å®ç°ï¼Œå…¥é˜Ÿ/å‡ºé˜Ÿé€Ÿåº¦éå¸¸å¿«ï¼Œååé‡æé«˜ï¼Œå†…å­˜å’Œ `CPU` å ç”¨å‡ ä¹å¿½ç•¥ä¸è®¡ã€‚

ä»»åŠ¡é˜Ÿåˆ—åº”ç”¨åœºæ™¯ï¼š**å¯¹äºå¯èƒ½éœ€é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ï¼Œæˆ–ä¸æ˜¯é‚£ä¹ˆåŠæ—¶çš„éœ€è¦ç«‹å³åé¦ˆçš„ä»»åŠ¡ã€‚**æ¯”å¦‚å‘é€é‚®ä»¶ï¼Œå‘é€çŸ­ä¿¡ç­‰ç­‰ã€‚

## 26.3.2 ä¸äº‹ä»¶æ€»çº¿çš„åŒºåˆ«

äº‹ä»¶æ€»çº¿åŸºäºæ¶ˆæ¯é€šè®¯ï¼Œä»»åŠ¡é˜Ÿåˆ—æœ€æ˜¾è‘—çš„ç‰¹ç‚¹å°±æ˜¯å°†æ“ä½œä¾æ¬¡åŠ å…¥é˜Ÿåˆ—ï¼Œç„¶åæŒ‰ç…§å…¥é˜Ÿçš„é¡ºåºå‡ºé˜Ÿå»æ‰§è¡Œã€‚

å‰è€…ï¼ˆäº‹ä»¶æ€»çº¿ï¼‰æ˜¯æ— åºçš„ï¼Œ**åªæœ‰å®Œå…¨åŒ¹é…çš„æ¶ˆæ¯ `Id` æ‰ä¼šè§¦å‘æ‰§è¡Œæ“ä½œï¼Œå¦åˆ™å¤„äº â€œé™å¾…â€ çŠ¶æ€ã€‚**

è€Œåè€…ï¼ˆä»»åŠ¡é˜Ÿåˆ—ï¼‰åˆ™æ˜¯å°†**å¯èƒ½è€—æ—¶ä¸”ä¸€å®šä¼šæ‰§è¡Œçš„æ“ä½œæ”¾åˆ°é˜Ÿåˆ—ä¸­ï¼Œä¹‹åä¾æ¬¡å‡ºé˜Ÿæ‰§è¡Œ**ã€‚

## 26.3.3 å…¥é—¨æŒ‡å—

ä»»åŠ¡é˜Ÿåˆ—ä½¿ç”¨éå¸¸ç®€å•ï¼Œåªéœ€è¦æ³¨å†Œ `services.AddTaskQueue()` æœåŠ¡ï¼Œä¹‹åé€šè¿‡ä¾èµ–æ³¨å…¥ `ITaskQueue` æœåŠ¡æˆ–é€šè¿‡ `TaskQueued` é™æ€ç±»ä½¿ç”¨å³å¯ï¼Œ

**1. æ³¨å†Œ `TaskQueue` æœåŠ¡**

```cs showLineNumbers
services.AddTaskQueue();
```

**2. ä½¿ç”¨ `ITaskQueue` æœåŠ¡**

```cs showLineNumbers {1,8,18,24,34,32,38,46,53,61,68,76,79,90,94}
using Furion.TaskQueue;

namespace Your.Application;

public class YourService : IYourService
{
    private readonly ITaskQueue _taskQueue;
    public YourService(ITaskQueue taskQueue)
    {
        _taskQueue = taskQueue;
    }

    /// <summary>
    /// åŒæ­¥å…¥é˜Ÿ
    /// </summary>
    public void SyncTask()
    {
        _taskQueue.Enqueue(provider =>
        {
            Console.WriteLine("æˆ‘æ˜¯åŒæ­¥çš„");
        });

        // å¦‚æ— éœ€ä½¿ç”¨ provider å‚æ•°ï¼Œå¯ç”¨ _ æ›¿ä»£
        _taskQueue.Enqueue(_ => {});
    }

    /// <summary>
    /// åŒæ­¥å…¥é˜Ÿï¼Œå»¶è¿Ÿ 3 ç§’è§¦å‘
    /// </summary>
    public void SyncTask2()
    {
        _taskQueue.Enqueue(provider =>
        {
            Console.WriteLine("æˆ‘æ˜¯åŒæ­¥çš„ï¼Œä½†æˆ‘å»¶è¿Ÿäº† 3 ç§’");
        }, 3000);

        // å¦‚æ— éœ€ä½¿ç”¨ provider å‚æ•°ï¼Œå¯ç”¨ _ æ›¿ä»£
        _taskQueue.Enqueue(_ => {}, 3000);
    }

    /// <summary>
    /// å¼‚æ­¥å…¥é˜Ÿ
    /// </summary>
    public async Task AsyncTask()
    {
        await _taskQueue.EnqueueAsync(async (provider, token) =>
        {
            Console.WriteLine("æˆ‘æ˜¯å¼‚æ­¥çš„");
            await ValueTask.CompletedTask;
        });

        // å¦‚æ— éœ€ä½¿ç”¨ provider å’Œ token å‚æ•°ï¼Œå¯ç”¨ _ æ›¿ä»£
        await _taskQueue.EnqueueAsync(async (_, _) => {});
    }

    /// <summary>
    /// å¼‚æ­¥å…¥é˜Ÿï¼Œå»¶è¿Ÿ 3 ç§’è§¦å‘
    /// </summary>
    public async Task AsyncTask2()
    {
        await _taskQueue.EnqueueAsync(async (provider, token) =>
        {
            Console.WriteLine("æˆ‘æ˜¯å¼‚æ­¥çš„ï¼Œä½†æˆ‘å»¶è¿Ÿäº† 3 ç§’");
            await ValueTask.CompletedTask;
        }, 3000);

        // å¦‚æ— éœ€ä½¿ç”¨ provider å’Œ token å‚æ•°ï¼Œå¯ç”¨ _ æ›¿ä»£
        await _taskQueue.EnqueueAsync(async (_, _) => {}, 3000);
    }

    /// <summary>
    /// åŒæ­¥å…¥é˜Ÿï¼Œæ”¯æŒ Cron è¡¨è¾¾å¼å»¶è¿Ÿ
    /// </summary>
    public void SyncTask3()
    {
        _taskQueue.Enqueue(provider =>
        {
            Console.WriteLine("Cron ...");
        }, "* * * * *");

        // å¦‚æ— éœ€ä½¿ç”¨ provider å‚æ•°ï¼Œå¯ç”¨ _ æ›¿ä»£
        _taskQueue.Enqueue(_ => {}, "* * * * *", CronStringFormat.Default);
    }

    /// <summary>
    /// å¼‚æ­¥å…¥é˜Ÿï¼Œæ”¯æŒ Cron è¡¨è¾¾å¼å»¶è¿Ÿ
    /// </summary>
    public async Task AsyncTask3()
    {
        await _taskQueue.EnqueueAsync(async (provider, token) =>
        {
            Console.WriteLine("Cron ...");
            await ValueTask.CompletedTask;
        }, "* * * * *");

        // å¦‚æ— éœ€ä½¿ç”¨ provider å’Œ token å‚æ•°ï¼Œå¯ç”¨ _ æ›¿ä»£
        await _taskQueue.EnqueueAsync(async (_, _) => {}, "* * * * *", CronStringFormat.Default);
    }
}
```

:::important æ³¨æ„äº‹é¡¹

æ¡†æ¶å†…ç½®äº†ä¸€å¥—ç®€å•çš„é”™è¯¯ç­–ç•¥æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯å¦‚æœä»»åŠ¡æ‰§è¡Œå¤±è´¥ä¼šé»˜è®¤é‡è¯• `3` æ¬¡ï¼Œæ¯æ¬¡é—´éš” `1ç§’`ï¼Œè¯¥ç­–ç•¥é…ç½®æš‚ä¸å¯¹å¤–å…¬å¼€ã€‚

:::

## 26.3.4 `TaskQueued` é™æ€ç±»

æ¡†æ¶è¿˜æä¾›äº† `TaskQueued` é™æ€ç±»å¯åœ¨ä»»ä½•çº¿ç¨‹ä¸­æ“ä½œï¼Œå¦‚ï¼š

```cs showLineNumbers {2-3,6-7}
// åŒæ­¥å…¥é˜Ÿ
TaskQueued.Enqueue((provider) => {}, [delay]);
TaskQueued.Enqueue((provider) => {}, cronExpression, [format]);

// å¼‚æ­¥å…¥é˜Ÿ
await TaskQueued.EnqueueAsync(async (provider, token) => {}, [delay]);
await TaskQueued.EnqueueAsynce(async (provider, token) => {}, cronExpression, [format]);
```

## 26.3.5 åœ¨å¤„ç†ç¨‹åºä¸­ä½¿ç”¨æœåŠ¡

å¦‚æœåœ¨ä»»åŠ¡é˜Ÿåˆ—å¤„ç†ç¨‹åºä¸­ä½¿ç”¨äº†å¤–éƒ¨çš„æœåŠ¡ï¼Œå¦‚ï¼š

```cs showLineNumbers {4,17}
public class YourService : IYourService
{
    private readonly ITaskQueue _taskQueue;
    private readonly ILogger<YourService> _logger

    public YourService(ITaskQueue taskQueue
    , ILogger<YourService> logger)
    {
        _taskQueue = taskQueue;
        _logger = logger;
    }

    public void SyncTask()
    {
        _taskQueue.Enqueue(provider =>
        {
            _logger.LogInformation("æˆ‘ä½¿ç”¨äº†å¤–éƒ¨çš„ logger");
        });
    }
}
```

é‚£ä¹ˆéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**å¦‚æœä½¿ç”¨çš„å¤–éƒ¨æœåŠ¡æ˜¯ **`å•ä¾‹`**æœåŠ¡ï¼Œé‚£ä¹ˆæ— éœ€ä»»ä½•å¤„ç†ï¼Œä½†å¦‚æœä½¿ç”¨çš„æœåŠ¡å±äº `ç¬æ—¶` æˆ– `èŒƒå›´` ä½œç”¨åŸŸï¼Œé‚£ä¹ˆéœ€è¦åˆ›å»ºä½œç”¨åŸŸ**ï¼Œå¦‚ï¼š

```cs showLineNumbers {3-5,7-8}
_taskQueue.Enqueue(provider =>
{
    // Repository æ³¨å†Œä¸ºèŒƒå›´ï¼Œéœ€åˆ›å»ºä½œç”¨åŸŸ
    using var scoped = provider.CreateScope();
    var repository = scoped.ServiceProvider.GetService<IRepository<User>>();

    // Logger æ³¨å†Œä¸ºå•ä¾‹ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨
    _logger.LogInformation("æˆ‘ä½¿ç”¨äº†å¤–éƒ¨çš„ logger");
});
```

## 26.3.6 è®¢é˜…æ‰§è¡Œä»»åŠ¡æ„å¤–å¼‚å¸¸

ä»»åŠ¡å¤„ç†ç¨‹åºä½¿ç”¨çš„æ˜¯ `Task` å¯¹è±¡è¿›è¡Œåˆ›å»ºå¹¶æ‰§è¡Œï¼Œä½†å¯èƒ½å­˜åœ¨ä¸€äº›æ„å¤–ä¸”éš¾ä»¥æ•è·çš„å¼‚å¸¸ï¼Œè¿™æ—¶å€™å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¢é˜…ï¼š

```cs showLineNumbers  {4}
services.AddTaskQueue(builder =>
{
    // è®¢é˜… TaskQueue æ„å¤–æœªæ•è·å¼‚å¸¸
    builder.UnobservedTaskExceptionHandler = (obj, args) =>
    {
        // ....
    };
});
```

## 26.3.7 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::
