---
id: file-provider
title: 31. è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
sidebar_label: 31. è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆä¸Šä¼ ä¸‹è½½ï¼‰
---

import Tag from "@site/src/components/Tag.js";

<details>
  <summary>ğŸ“ æ¨¡å—æ›´æ–°æ—¥å¿—</summary>
  <div>
<div>

- **æ–°ç‰¹æ€§**

  - &nbsp;<Tag>æ–°å¢</Tag> `.m3u8` å’Œ `.ts` æ–‡ä»¶ç±»å‹ `MIME` æ”¯æŒ <sup>4.8.7.5</sup> <sup>â±ï¸2023.03.07</sup> [#I6KKEM](https://gitee.com/dotnetchina/Furion/issues/I6KKEM)
  - &nbsp;<Tag>æ–°å¢</Tag> `*.bcmap` å’Œ `.properties` æ–‡ä»¶ç±»å‹ `MIME` æ”¯æŒ <sup>4.8.4.9</sup> <sup>â±ï¸2023.01.06</sup> [!694](https://gitee.com/dotnetchina/Furion/pulls/694)

</div>
  </div>
</details>

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 2.5.0 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

import useBaseUrl from "@docusaurus/useBaseUrl";

## 31.1 å…³äºæ–‡ä»¶ç³»ç»Ÿ

æœ¬ç« æ‰€è°“çš„ `æ–‡ä»¶ç³»ç»Ÿ` æœ‰ç‚¹åä¸å‰¯å®ï¼Œå…¶å®æ ¹æœ¬ç®—ä¸ä¸Šä¸€ä¸ªç³»ç»Ÿï¼Œå®ƒä»…ä»…æ˜¯åˆ©ç”¨ä¸€ä¸ªæŠ½è±¡åŒ–çš„ `IFileProvider` ä»¥ç»Ÿä¸€çš„æ–¹å¼æä¾›æ‰€éœ€çš„æ–‡ä»¶è€Œå·²ã€‚é€šè¿‡è¯¥ `æ–‡ä»¶ç³»ç»Ÿ` å¯ä»¥è¯»å–ç‰©ç†æ–‡ä»¶å’ŒåµŒå…¥èµ„æºæ–‡ä»¶ï¼ŒåŒ…æ‹¬ç›®å½•ç»“æœè¯»å–ï¼Œæ–‡ä»¶å†…å®¹è¯»å–ï¼Œæ–‡ä»¶å†…å®¹ç›‘å¬ç­‰ç­‰ã€‚

### 31.1.1 æ–‡ä»¶ç³»ç»Ÿç±»å‹

`Furion` æä¾›äº†ä¸¤ç§æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼š

- `Physical`ï¼šç‰©ç†æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼Œä¹Ÿå°±æ˜¯ç‰©ç†æœºä¸­å®é™…å­˜åœ¨çš„æ–‡ä»¶
- `Embedded`ï¼šåµŒå…¥èµ„æºæ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼Œä¹Ÿå°±æ˜¯èµ„æºæ–‡ä»¶åµŒå…¥åˆ°äº†ç¨‹åºé›†ä¸­ï¼Œå¸¸ç”¨äºæ¨¡å—åŒ–å¼€å‘

## 31.2 æ³¨å†Œè™šæ‹Ÿæ–‡ä»¶ç³»ç»ŸæœåŠ¡

```cs showLineNumbers
services.AddVirtualFileServer();
```

## 31.3 è·å–æ–‡ä»¶ç³»ç»Ÿ `IFileProvider` å®ä¾‹

### 31.3.1 `Func<FileProviderTypes, object, IFileProvider>` æ–¹å¼

`Furion` æ¡†æ¶æä¾›äº† `Func<FileProviderTypes, object, IFileProvider>` å§”æ‰˜ä¾›æ„é€ å‡½æ•°æ³¨å…¥æˆ–è§£ææœåŠ¡ï¼Œå¦‚ï¼š

```cs showLineNumbers  {6,8-9,11-12}
public class PersonServices
{
    private readonly IFileProvider _physicalFileProvider;
    private readonly IFileProvider _embeddedFileProvider;

    public PersonServices(Func<FileProviderTypes, object, IFileProvider> fileProviderResolve)
    {
        // è§£æç‰©ç†æ–‡ä»¶ç³»ç»Ÿ
        _physicalFileProvider = fileProviderResolve(FileProviderTypes.Physical, @"c:/test");

        // è§£æåµŒå…¥èµ„æºæ–‡ä»¶ç³»ç»Ÿ
        _embeddedFileProvider = fileProviderResolve(FileProviderTypes.Embedded, Assembly.GetEntryAssembly());
    }
}
```

### 31.3.2 `FS` é™æ€ç±»æ–¹å¼

`Furion` æ¡†æ¶ä¹Ÿæä¾›äº† `FS` é™æ€ç±»æ–¹å¼åˆ›å»ºï¼Œå¦‚ï¼š

```cs showLineNumbers
// è§£æç‰©ç†æ–‡ä»¶ç³»ç»Ÿ
var physicalFileProvider = FS.GetPhysicalFileProvider(@"c:/test");

// è§£æåµŒå…¥èµ„æºæ–‡ä»¶ç³»ç»Ÿ
var embeddedFileProvider = FS.GetEmbeddedFileProvider(Assembly.GetEntryAssembly());
```

## 31.4 `IFileProvider` å¸¸è§æ“ä½œ

### 31.4.1 è¯»å–æ–‡ä»¶å†…å®¹

```cs showLineNumbers
byte[] buffer;
using (Stream readStream = _fileProvider.GetFileInfo("ä½ çš„æ–‡ä»¶è·¯å¾„").CreateReadStream())
{
    buffer = new byte[readStream.Length];
    await readStream.ReadAsync(buffer.AsMemory(0, buffer.Length));
}

// è¯»å–æ–‡ä»¶å†…å®¹
var content = Encoding.UTF8.GetString(buffer);
```

### 31.4.2 è·å–æ–‡ä»¶ç›®å½•å†…å®¹ï¼ˆéœ€é€’å½’æŸ¥æ‰¾ï¼‰

```cs showLineNumbers
var rootPath = "å½“å‰ç›®å½•è·¯å¾„";
var fileinfos = _fileProvider.GetDirectoryContents(rootPath);
foreach (var fileinfo in fileinfos)
{
    if(fileinfo.IsDirectory)
    {
        // è¿™é‡Œé€’å½’ã€‚ã€‚ã€‚
    }
}
```

### 31.4.3 ç›‘å¬æ–‡ä»¶å˜åŒ–

```cs showLineNumbers
ChangeToken.OnChange(() => _fileProvider.Watch("ç›‘å¬çš„æ–‡ä»¶"), () =>
{
    // è¿™é‡Œå†™ä½ çš„é€»è¾‘
});
```

## 31.5 æ¨¡å—åŒ–é™æ€èµ„æºé…ç½®

é€šå¸¸æˆ‘ä»¬é‡‡ç”¨æ¨¡å—åŒ–å¼€å‘ï¼Œé™æ€èµ„æºéƒ½æ˜¯åµŒå…¥è¿›ç¨‹åºé›†ä¸­ï¼Œè¿™æ—¶å€™æˆ‘ä»¬éœ€è¦é€šè¿‡é…ç½® `UseFileServer` æŒ‡å®šæ¨¡å—é™æ€èµ„æºè·¯å¾„ï¼Œå¦‚ï¼š

```cs showLineNumbers
// é»˜è®¤é™æ€èµ„æºè°ƒç”¨ï¼Œwwwroot
app.UseStaticFiles();

// é…ç½®æ¨¡å—åŒ–é™æ€èµ„æº
app.UseFileServer(new FileServerOptions
{
    FileProvider = new EmbeddedFileProvider(æ¨¡å—ç¨‹åºé›†),
    RequestPath = "/æ¨¡å—åç§°",  // åç»­æ‰€æœ‰èµ„æºéƒ½æ˜¯é€šè¿‡ /æ¨¡å—åç§°/xxx.css è°ƒç”¨
    EnableDirectoryBrowsing = true
});
```

## 31.6 æ–‡ä»¶ä¸Šä¼ ä¸‹è½½

åœ¨åº”ç”¨å¼€å‘ä¸­ï¼Œæ–‡ä»¶ä¸Šä¼ ä¸‹è½½å±äºéå¸¸å¸¸ç”¨çš„åŠŸèƒ½ï¼Œè¿™é‡Œè´´å‡ºå¸¸è§çš„æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ç¤ºä¾‹ã€‚

### 31.6.1 æ–‡ä»¶ä¸‹è½½

- æ–‡ä»¶è·¯å¾„çš„æ–¹å¼

```cs showLineNumbers {1,5}
[HttpGet, NonUnify]
public IActionResult FileDownload()
{
    string filePath = "è¿™é‡Œè·å–å®Œæ•´çš„æ–‡ä»¶ä¸‹è½½è·¯å¾„";
    return new FileStreamResult(new FileStream(filePath, FileMode.Open), "application/octet-stream")
    {
        FileDownloadName = fileName // é…ç½®æ–‡ä»¶ä¸‹è½½æ˜¾ç¤ºå
    };
}
```

- `byte[]` æ–¹å¼

```cs showLineNumbers {1,4}
[HttpGet, NonUnify]
public IActionResult FileDownload()
{
    return new FileContentResult(byteæ•°ç»„, "application/octet-stream")
    {
        FileDownloadName = fileName // é…ç½®æ–‡ä»¶ä¸‹è½½æ˜¾ç¤ºå
    };
}
```

- `stream` æ–¹å¼

```cs showLineNumbers {1,4,7-9,11}
[HttpGet, NonUnify]
public async Task<IActionResult> FileDownload()
{
    var (stream, _) = await "http://furion.baiqian.ltd/img/rm1.png".GetAsStreamAsync();

    // å°† stream è½¬ byte[]
    byte[] bytes = new byte[stream.Length];
    await stream.ReadAsync(bytes);
    stream.Seek(0, SeekOrigin.Begin);

    return new FileContentResult(bytes, "application/octet-stream")
    {
        FileDownloadName = fileName // é…ç½®æ–‡ä»¶ä¸‹è½½æ˜¾ç¤ºå
    };
}
```

:::note å…³äºå‰ç«¯è·å–æ–‡ä»¶å

å¦‚æœå‰ç«¯è·å–ä¸åˆ°æ–‡ä»¶ï¼Œå¯æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```cs showLineNumbers
_httpContextAccessor.HttpContext.Response.Headers.Add("Content-Disposition", $"attachment; filename={æ–‡ä»¶å}");
_httpContextAccessor.HttpContext.Response.Headers.Add("Access-Control-Expose-Headers", "Content-Disposition");
```

å¦‚æœä¾ç„¶ä¸èƒ½è§£å†³é—®é¢˜å¯å°è¯•æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```json showLineNumbers {2,4-5}
{
  "CorsAccessorSettings": {
    "WithExposedHeaders": [
      "Content-Disposition",
      "Access-Control-Expose-Headersx-access-token"
    ]
  }
}
```

:::

### 31.6.2 æ–‡ä»¶ä¸Šä¼ 

:::tip å°æé†’

`IFormFile` ç±»å‹å¯¹åº”å‰ç«¯çš„ `Content-Type` ä¸ºï¼š `multipart/form-data`

:::

- **å•æ–‡ä»¶ `IFormFile` ç±»å‹å‚æ•°ï¼ˆå­˜å‚¨åˆ°ç¡¬ç›˜ï¼‰**

```cs showLineNumbers  {1,2,18}
[HttpPost]
public async Task<string> UploadFileAsync(IFormFile file)
{
    // å¦‚ï¼šä¿å­˜åˆ°ç½‘ç«™æ ¹ç›®å½•ä¸‹çš„ uploads ç›®å½•
    var savePath = Path.Combine(App.HostEnvironment.ContentRootPath, "uploads");
    if (!Directory.Exists(savePath)) Directory.CreateDirectory(savePath);

    //// è¿™é‡Œè¿˜å¯ä»¥è·å–æ–‡ä»¶çš„ä¿¡æ¯
    // var size = file.Length / 1024.0;  // æ–‡ä»¶å¤§å° KB
    // var clientFileName = file.FileName; // å®¢æˆ·ç«¯ä¸Šä¼ çš„æ–‡ä»¶å
    // var contentType = file.ContentType; // è·å–æ–‡ä»¶ ContentType æˆ–è§£æ MIME ç±»å‹

    // é¿å…æ–‡ä»¶åé‡å¤ï¼Œé‡‡ç”¨ GUID ç”Ÿæˆ
    var fileName = Guid.NewGuid().ToString("N") + Path.GetExtension(file.FileName);
    var filePath = Path.Combine(savePath, fileName);

    // ä¿å­˜åˆ°æŒ‡å®šè·¯å¾„
    using (var stream = System.IO.File.Create(filePath))
    {
        await file.CopyToAsync(stream);
    }

    // è¿”å›æ–‡ä»¶åï¼ˆè¿™é‡Œå¯ä»¥è‡ªç”±è¿”å›æ›´å¤šä¿¡æ¯ï¼‰
    return fileName;
}
```

- **å•æ–‡ä»¶ `Base64` ç±»å‹å‚æ•°ï¼ˆå­˜å‚¨åˆ°ç¡¬ç›˜ï¼‰**

```cs showLineNumbers  {1,2,9,19}
[HttpPost]
public async Task<string> UploadFileAsync([FromBody] string fileBase64, string clientFileName)
{
    // å¦‚ï¼šä¿å­˜åˆ°ç½‘ç«™æ ¹ç›®å½•ä¸‹çš„ uploads ç›®å½•
    var savePath = Path.Combine(App.HostEnvironment.ContentRootPath, "uploads");
    if (!Directory.Exists(savePath)) Directory.CreateDirectory(savePath);

    // å°† base64 å­—ç¬¦ä¸²è½¬ byte[]
    var bytes = Convert.FromBase64String(fileBase64);

    // è¿™é‡Œè¿˜å¯ä»¥è·å–æ–‡ä»¶çš„ä¿¡æ¯
    // var size = bytes.Length / 1024.0;  // æ–‡ä»¶å¤§å° KB

    // é¿å…æ–‡ä»¶åé‡å¤ï¼Œé‡‡ç”¨ GUID ç”Ÿæˆ
    var fileName = Guid.NewGuid().ToString("N") + Path.GetExtension(clientFileName);
    var filePath = Path.Combine(savePath, fileName);

    // ä¿å­˜åˆ°æŒ‡å®šè·¯å¾„
    using (var fs = new FileStream(filePath, FileMode.Create))
    {
        await fs.WriteAsync(bytes);
    }

    // è¿”å›æ–‡ä»¶åï¼ˆè¿™é‡Œå¯ä»¥è‡ªç”±è¿”å›æ›´å¤šä¿¡æ¯ï¼‰
    return filename;
}
```

:::warning ç‰¹åˆ«æ³¨æ„

æ–‡ä»¶ `Base64` å­—ç¬¦ä¸²å¦‚æœå¸¦ `data:text/plain;base64,` å¼€å¤´åˆ™ï¼Œéœ€è¦æ‰‹åŠ¨å»æ‰ `,` ä¹‹å‰ï¼ˆå«é€—å·ï¼‰çš„å­—ç¬¦ä¸²ã€‚

:::

- **å¤šæ–‡ä»¶ `List<IFormFile>` ç±»å‹å‚æ•°ï¼ˆå­˜å‚¨åˆ°ç¡¬ç›˜ï¼‰**

:::tip å‚æ•°æç¤º

é€šå¸¸å¤šæ–‡ä»¶ä¸Šä¼ ç”¨çš„æœ€å¤šçš„æ˜¯ `List<IFormFile> files` å‚æ•°ï¼Œä½† `.NET5+` æ›´æ¨èä½¿ç”¨ `IFormFileCollection  files`ã€‚

:::

ä»£ç å’Œ `å•æ–‡ä»¶å¤„ç†ä¸€è‡´`ï¼Œåªéœ€ `foreach` å³å¯ã€‚

```cs showLineNumbers  {1-2,12}
[HttpPost]
public async Task<object> UploadFileAsync(List<IFormFile> files)    // å¯æ”¹ä¸º IFormFileCollection files
{
    // ä¿å­˜åˆ°ç½‘ç«™æ ¹ç›®å½•ä¸‹çš„ uploads ç›®å½•
    var savePath = Path.Combine(App.HostEnvironment.ContentRootPath, "uploads");
    if(!Directory.Exists(savePath)) Directory.CreateDirectory(savePath);

    // æ€»ä¸Šä¼ å¤§å°
    long size = files.Sum(f => f.Length);

    // éå†æ‰€æœ‰æ–‡ä»¶é€ä¸€ä¸Šä¼ 
    foreach (var formFile in files)
    {
        if (formFile.Length > 0)
        {
            // é¿å…æ–‡ä»¶åé‡å¤ï¼Œé‡‡ç”¨ GUID ç”Ÿæˆ
            var fileName = Guid.NewGuid().ToString("N") + Path.GetExtension(formFile.FileName);
            var filePath = Path.Combine(savePath, fileName);

            // ä¿å­˜åˆ°æŒ‡å®šè·¯å¾„
            using (var stream = System.IO.File.Create(filePath))
            {
                await formFile.CopyToAsync(stream);
            }
        }
    }

    // è¿™é‡Œå¯è‡ªè¡Œè¿”å›æ›´å¤šä¿¡æ¯
    return new { count = files.Count, size };
}
```

- **å¤šæ–‡ä»¶ `List<string>` `Base64` ç±»å‹å‚æ•°ï¼ˆå­˜å‚¨åˆ°ç¡¬ç›˜ï¼‰**

ä»£ç å’Œ `å•æ–‡ä»¶å¤„ç†ä¸€è‡´`ï¼Œåªéœ€ `foreach` å³å¯ï¼ˆå‚ä¸Šï¼‰ã€‚

### 31.6.3 å°† `IFormFile` è½¬ `byte[]`

æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦å°†æ–‡ä»¶è½¬æ¢æˆ `byte[]` å­˜å‚¨åˆ°æ•°æ®åº“ï¼Œè€Œä¸æ˜¯å­˜å‚¨åˆ°ç¡¬ç›˜ä¸­ã€‚

```cs showLineNumbers {4-8}
[HttpPost]
public async Task<IActionResult> UploadFileAsync(IFormFile file)
{
    var fileLength = file.Length;
    using var stream = file.OpenReadStream();
    var bytes = new byte[fileLength];

    stream.Read(bytes, 0, (int)fileLength);

    // è¿™é‡Œå°† bytes å­˜å‚¨åˆ°ä½ æƒ³è¦çš„ä»‹è´¨ä¸­å³å¯
}
```

:::tip ä¾¿æ·æ‹“å±•æ–¹æ³•

åœ¨ Furion `v3.2.0` æ–°å¢äº† `IFormFile` çš„ `ToByteArray` æ‹“å±•ï¼Œå¦‚:

```cs showLineNumbers  {4}
[HttpPost]
public async Task<IActionResult> UploadFileAsync(IFormFile file)
{
    var bytes = file.ToByteArray();

    // è¿™é‡Œå°† bytes å­˜å‚¨åˆ°ä½ æƒ³è¦çš„ä»‹è´¨ä¸­å³å¯
}
```

:::tip

### 31.6.4 å°† `byte[]` è¾“å‡ºä¸º `Url` åœ°å€

ç”±äºä¸€äº›é¡¹ç›®ç›´æ¥å°†æ–‡ä»¶äºŒè¿›åˆ¶å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œè¯»å–åˆ°å†…å­˜çš„æ—¶å€™éƒ½æ˜¯ `byte[]` æ•°ç»„ï¼Œæ¯”å¦‚æˆ‘ä»¬å°†å›¾ç‰‡æ–‡ä»¶å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œç„¶åå‰ç«¯é€šè¿‡ `Url` é“¾æ¥è¿›è¡Œè®¿é—®ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦å°† `byte[]` è½¬æ¢ä¸ºæœ‰æ•ˆçš„èµ„æºè·¯å¾„æ ¼å¼ï¼Œå¦‚ï¼š

```cs showLineNumbers {1,7}
[NonUnify, HttpGet, AllowAnonymous]
public async Task<IActionResult> attachment(string resourceId)
{
    // æ ¹æ® resourceId æŸ¥è¯¢ byte[] å­—èŠ‚æ•°ç»„å’Œ content-type

    // è¿”å› FileContentResult ç±»å‹
    return new FileContentResult(å­—èŠ‚æ•°ç»„ï¼Œcontent-type);
}
```

ä¹‹åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ `https://localhost/attachment/èµ„æºid` è®¿é—®æ–‡ä»¶æˆ–å›¾ç‰‡äº†ã€‚

### 31.6.5 é…ç½®ä¸Šä¼ æ–‡ä»¶ç›®å½•

å¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä¼šå°†æ–‡ä»¶å­˜å‚¨åœ¨ç‰¹å®šçš„ç›®å½•ä¸­ï¼Œå¦‚ `uploads` ä¸­ï¼Œè¿™æ—¶å€™åªéœ€è¦æ·»åŠ ä»¥ä¸‹é…ç½®å³å¯ï¼š

- ç¼–è¾‘å¯åŠ¨å±‚ `YourPoject.Web.Entry.csproj` é¡¹ç›®ï¼Œæ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```xml showLineNumbers {2-3}
<ItemGroup>
	<Content Include="uploads\**\*">
		<CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
	</Content>
</ItemGroup>
```

- é…ç½®æ–‡ä»¶æœåŠ¡ä¸­é—´ä»¶

```cs showLineNumbers {3-5,7-11}
app.UseStaticFiles();

// å¦‚æœç›®å½•ä¸å­˜åœ¨åˆ™åˆ›å»º
var staticRoot = Path.Combine(AppContext.BaseDirectory, "uploads"); // æ³¨æ„è¿™é‡Œä¸è¦æ·»åŠ  /
if (!Directory.Exists(staticRoot)) Directory.CreateDirectory(staticRoot);

app.UseFileServer(new FileServerOptions
{
    RequestPath = "/uploads",   // é…ç½®è®¿é—®åœ°å€ï¼Œéœ€ä»¥ / å¼€å¤´ï¼Œé€šå¸¸å’Œç›®å½•åç§°ä¸€è‡´ï¼Œä¹Ÿå¯ä»¥ä¸åŒ
    FileProvider = new PhysicalFileProvider(staticRoot)
});
```

- é€šè¿‡æµè§ˆå™¨è®¿é—®æ–‡ä»¶

ä¹‹åå°±å¯ä»¥é€šè¿‡æµè§ˆå™¨è®¿é—® `http://åœ°å€:ç«¯å£/uploads/xxx.png` äº†ã€‚

## 31.7 è¯·æ±‚å¤§å°æ§åˆ¶ï¼ˆä¸Šä¼ æ–‡ä»¶å¤§å°æ§åˆ¶ï¼‰

åœ¨ `Web` é¡¹ç›®ä¸­ï¼Œ`Kestrel` å’Œ `HttpSys` éƒ½å¼ºåˆ¶å®æ–½ `30M (~28.6MiB)` çš„æœ€å¤§è¯·æ±‚æ­£æ–‡å¤§å°é™åˆ¶ï¼Œå¦‚æœè¯·æ±‚æ­£æ–‡å¤§å°è¶…è¿‡é…ç½®çš„æœ€å¤§è¯·æ±‚æ­£æ–‡å¤§å°é™åˆ¶ï¼Œåˆ™å¼•å‘ `Request body too large. The max request body size is xxxxx` å¼‚å¸¸ï¼ŒçŠ¶æ€ç ä¸º `413` æˆ– `500`ã€‚

### 31.7.1 å¯¹ç‰¹å®šçš„æ¥å£è¿›è¡Œæ§åˆ¶

å¯é€šè¿‡ `[RequestSizeLimit]` ç‰¹æ€§è¿›è¡Œç‰¹å®šé™åˆ¶

```cs showLineNumbers {2,3}
[HttpPost]
[RequestSizeLimit(100_000_000)] // é€šå¸¸è®¾ç½®ä¸º [RequestSizeLimit(long.MaxValue)]
[RequestFormLimits(MultipartBodyLengthLimit = long.MaxValue)]
public IActionResult MyAction([FromBody] MyViewModel data)
{
}
```

ç›¸å…³ `Issue`ï¼š[https://gitee.com/dotnetchina/Furion/issues/I8669C](https://gitee.com/dotnetchina/Furion/issues/I8669C)

### 31.7.2 å¯¹ç‰¹å®šæ¥å£å–æ¶ˆé™åˆ¶

å¦‚æœä¸éœ€è¦å¯¹è¯·æ±‚å¤§å°è¿›è¡Œé™åˆ¶ï¼Œä¹Ÿå°±æ˜¯æ”¯æŒæäº¤æ— é™å¤§å°ï¼Œåˆ™è´´ `[DisableRequestSizeLimit]` ç‰¹æ€§å³å¯ã€‚

### 31.7.3 é€šç”¨ä¸­é—´ä»¶è¿›è¡Œæ§åˆ¶

æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä¸­é—´ä»¶çš„æ–¹å¼åœ¨ `Startup.cs` ä¸­è¿›è¡Œé…ç½®ï¼š

```cs showLineNumbers {1,3}
app.Run(async context =>
{
    context.Features.Get<IHttpMaxRequestBodySizeFeature>().MaxRequestBodySize = 100_000_000; // è®¾ç½® null å°±æ˜¯ä¸é™åˆ¶ï¼Œå…·ä½“å€¼å°±æ˜¯é™åˆ¶æœ€å¤§å¤šå°‘ M
}
```

å¦‚æœè®¾ç½® `MaxRequestBodySize` ä¸º `null` ï¼Œåˆ™ç­‰åŒäºå–æ¶ˆé™åˆ¶ï¼Œä¹Ÿå°±æ˜¯ `[DisableRequestSizeLimit]` çš„æ•ˆæœã€‚

:::tip å°æ³¨æ„

æœ‰æ—¶å€™é…ç½®äº†ä¸­é—´ä»¶æ•ˆæœå‘ç°æ²¡èµ·ä½œç”¨ï¼Œå¾ˆæœ‰å¯èƒ½å’Œä¸­é—´ä»¶é¡ºåºæœ‰å…³ï¼Œå¯ä»¥é€šè¿‡ `.IsReadOnly` å±æ€§åˆ¤æ–­ï¼Œå¦‚æœä¸º `true` ï¼Œè¯´æ˜ä½ çš„é…ç½®æ— æ•ˆï¼Œåªæœ‰ `false` æ‰æœ‰æ•ˆã€‚

:::

### 31.7.4 å…¨å±€é…ç½®

- `IIS` æ–¹å¼ï¼š

1. **å¼€å‘ç¯å¢ƒï¼ˆIISExpressï¼‰**

åœ¨ `Web` å¯åŠ¨å±‚ï¼ˆé€šå¸¸æ˜¯ `XXX.Web.Entry`ï¼‰æ ¹ç›®å½•ä¸‹åˆ›å»º `web.config` æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```xml showLineNumbers {3-9}
<?xml version="1.0" encoding="utf-8"?>
<configuration>
	<system.webServer>
		<security>
			<requestFiltering>
				<requestLimits maxAllowedContentLength="1073741824" />
			</requestFiltering>
		</security>
	</system.webServer>
</configuration>
```

2. **ç”Ÿäº§ç¯å¢ƒ**

é€šå¸¸ç”Ÿäº§ç¯å¢ƒ `IIS` è‡ªåŠ¨é¡¹ç›®æ·»åŠ äº† `web.config` æ–‡ä»¶ï¼Œè¿™æ—¶å€™åªéœ€è¦åœ¨ `<configuration>` èŠ‚ç‚¹ä¸‹æ·»åŠ ä¸‹é¢å†…å®¹å³å¯ï¼š

```xml showLineNumbers {3-5}
<system.webServer>
    <security>
        <requestFiltering>
            <requestLimits maxAllowedContentLength="1073741824" />
        </requestFiltering>
    </security>
</system.webServer>
```

- `Kestrel` æ–¹å¼ï¼š

:::tip å°çŸ¥è¯†

æœªä½¿ç”¨ `IIS` æ‰˜ç®¡æ—¶ï¼Œ`ASP.NET Core` é»˜è®¤ä½¿ç”¨ `Kestrel` æ–¹å¼ã€‚

:::

```cs showLineNumbers {1,8}
// .NET5 æ–¹å¼ï¼Œåœ¨ .ConfigureWebHostDefaults é‡Œé¢é…ç½®
.UseStartup<Startup>()
.UseKestrel(options =>
{
    options.Limits.MaxRequestBodySize = null;   // è®¾ç½® null å°±æ˜¯ä¸é™åˆ¶ï¼Œå…·ä½“å€¼å°±æ˜¯é™åˆ¶æœ€å¤§å¤šå°‘ M
}

// .NET6 æ–¹å¼,åœ¨ progame.cs æ–‡ä»¶ var app = builder.Build(); ä¹‹åé…ç½®
app.Configuration.Get<WebHostBuilder>().ConfigureKestrel(options =>
{
    options.Limits.MaxRequestBodySize = null;   // è®¾ç½® null å°±æ˜¯ä¸é™åˆ¶ï¼Œå…·ä½“å€¼å°±æ˜¯é™åˆ¶æœ€å¤§å¤šå°‘ M
});
```

- `HttpSys` æ–¹å¼ï¼š

:::tip å°çŸ¥è¯†

`HTTP.sys` æ˜¯ä»…åœ¨ `Windows` ä¸Šè¿è¡Œçš„é€‚ç”¨äº `ASP.NET Core` çš„ `Web` æœåŠ¡å™¨ã€‚ `HTTP.sys` æ˜¯ `Kestrel` æœåŠ¡å™¨çš„æ›¿ä»£é€‰æ‹©ï¼Œæä¾›äº†ä¸€äº› `Kestrel` ä¸æä¾›çš„åŠŸèƒ½ã€‚

:::

```cs showLineNumbers
// .NET5 æ–¹å¼åŒä¸Š
.UseHttpSys(options =>
{
    options.MaxRequestBodySize = 100_000_000;   // è®¾ç½® null å°±æ˜¯ä¸é™åˆ¶ï¼Œå…·ä½“å€¼å°±æ˜¯é™åˆ¶æœ€å¤§å¤šå°‘ M
}

// .NET6 æ–¹å¼åŒä¸Š
```

## 31.8 ç‰¹å®šæ–‡ä»¶ç±»å‹ï¼ˆæ–‡ä»¶åç¼€ï¼‰å¤„ç†

æœ‰æ—¶æˆ‘ä»¬åœ¨æœåŠ¡å™¨é™æ€èµ„æºç›®å½•ä¸‹å­˜æ”¾å¦‚ `.apk`ï¼Œ`.m3u8` ç­‰æ–‡ä»¶æ—¶ï¼Œé€šè¿‡ `URL` è¯·æ±‚è¿”å› `404 Not Found`ï¼Œé‚£æ˜¯å› ä¸ºé»˜è®¤æƒ…å†µä¸‹æ¡†æ¶æœªé…ç½®æ­¤ç±»æ–‡ä»¶ç±»å‹ `MIME` ç±»å‹ã€‚

`Furion` æ¡†æ¶æä¾›äº† `400` å¤šä¸ªå¸¸è§çš„æ–‡ä»¶ç±»å‹ `MIME`ï¼Œåªéœ€è¦åœ¨ `Startup.cs` æˆ– `Progame.cs` ä¸­æ³¨å†Œå³å¯ï¼Œå¦‚ï¼š

```cs showLineNumbers {2,3}
// ä¸º UseStaticFiles æ·»åŠ  StaticFileOptions å‚æ•°å¹¶æŒ‡å®š ContentTypeProvider å±æ€§
app.UseStaticFiles(new StaticFileOptions {
  ContentTypeProvider = FS.GetFileExtensionContentTypeProvider()
});
```

å¦‚æœé…ç½®äº†è¿˜æ˜¯å‡ºç° `404`ï¼Œé‚£ä¹ˆå¯èƒ½è®¿é—®çš„æ–‡ä»¶ç±»å‹çš„ `MIME` åœ¨ `Furion` æ¡†æ¶ä¸­æœªè¢«åŒ…å«ï¼Œè¿™æ—¶å¯è‡ªè¡Œæ·»åŠ ï¼Œå¦‚ï¼š

```cs showLineNumbers {1-2,6}
var contentTypeProvider = FS.GetFileExtensionContentTypeProvider();
contentTypeProvider.Mappings[".æ–‡ä»¶åç¼€"] = "MIME ç±»å‹";    // æ³¨æ„æ–‡ä»¶åç¼€ä»¥  . å¼€å¤´
// å¯å¤šä¸ª....

app.UseStaticFiles(new StaticFileOptions {
  ContentTypeProvider = contentTypeProvider;
});
```

## 31.9 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::

---
