---
id: event-bus
title: 22. äº‹ä»¶æ€»çº¿
sidebar_label: 22. äº‹ä»¶æ€»çº¿ (EventBus)
---

import useBaseUrl from "@docusaurus/useBaseUrl";

import Tag from "@site/src/components/Tag.js";

<details>
  <summary>ğŸ“ æ¨¡å—æ›´æ–°æ—¥å¿—</summary>
  <div>
<div>

- **æ–°ç‰¹æ€§**

  - &nbsp;<Tag>æ–°å¢</Tag> äº‹ä»¶æ€»çº¿æ”¯æŒç®€å•çš„ `Order` ç¼–æ’è§„åˆ™ <sup>4.8.0</sup> [833c0d4](https://gitee.com/dotnetchina/Furion/commit/833c0d4d069bca5f5304aa21cb32c7f902c20c69)
  - &nbsp;<Tag>æ–°å¢</Tag> äº‹ä»¶æ€»çº¿ `.ReplaceStorerOrFallback` è‡ªå®šä¹‰äº‹ä»¶æºå­˜å‚¨å™¨æ–¹æ³•ï¼Œå¯åœ¨è‡ªå®šä¹‰åˆå§‹å¤±è´¥æ—¶å›é€€åˆ°é»˜è®¤å€¼ <sup>4.7.6</sup> [#I602NU](https://gitee.com/dotnetchina/Furion/issues/I602NU)
  - &nbsp;<Tag>æ–°å¢</Tag> äº‹ä»¶æ€»çº¿æ¨¡å—é‡è¯•å¤±è´¥åæ”¯æŒå›è°ƒ <sup>4.6.1</sup> [#I5UVMV](https://gitee.com/dotnetchina/Furion/issues/I5UVMV)
  - &nbsp;<Tag>æ–°å¢</Tag> äº‹ä»¶æ€»çº¿ `LogEnabled` é…ç½®ï¼Œå¯æ§åˆ¶æ˜¯å¦è¾“å‡ºæœåŠ¡æ—¥å¿— [#I5QLY5](https://gitee.com/dotnetchina/Furion/issues/I5QLY5)
  - &nbsp;<Tag>æ–°å¢</Tag> **äº‹ä»¶æ€»çº¿ `MessageCenter` é™æ€ç±»ï¼Œè§£å†³ä» `Fur v1.x` ç‰ˆæœ¬å‡çº§é—®é¢˜ [a29fc7c](https://gitee.com/dotnetchina/Furion/commit/a29fc7cf63a3ea41b1617a6ad98a701a243e24f8)**
  - &nbsp;<Tag>æ–°å¢</Tag> **äº‹ä»¶æ€»çº¿å·¥å‚ï¼Œæ”¯æŒè¿è¡Œæ—¶åŠ¨æ€æ·»åŠ è®¢é˜…ç¨‹åºå’Œç§»é™¤è®¢é˜…ç¨‹åº** [#I5NNQX](https://gitee.com/dotnetchina/Furion/issues/I5NNQX)
  - &nbsp;<Tag>æ–°å¢</Tag> **äº‹ä»¶æ€»çº¿ `[EventSubscribe]` äº‹ä»¶ `Id` æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…** [#I5NNQX](https://gitee.com/dotnetchina/Furion/issues/I5NNQX)
  - &nbsp;<Tag>æ–°å¢</Tag> **äº‹ä»¶æ€»çº¿ `[EventSubscribe]` æ”¯æŒå±€éƒ¨å¤±è´¥é‡è¯•é…ç½®** [#I5NNQX](https://gitee.com/dotnetchina/Furion/issues/I5NNQX)
  - &nbsp;<Tag>æ–°å¢</Tag> äº‹ä»¶æ€»çº¿ `options.AddSubscriber(Type)` é‡è½½ [42446078](https://gitee.com/dotnetchina/Furion/blob/424460780b630e1c71de4db84ad8fd14e33a09f5/framework/Furion.Pure/EventBus/Builders/EventBusOptionsBuilder.cs)
  - &nbsp;<Tag>æ–°å¢</Tag> äº‹ä»¶æ€»çº¿ `UseUtcTimestamp` é€‰é¡¹é…ç½®ï¼Œå¯é€‰æ‹©ä½¿ç”¨ `DateTime.UtcNow` è¿˜æ˜¯ `DateTime.Now`ï¼Œé»˜è®¤æ˜¯ `DateTime.Now` [#I5JSEU](https://gitee.com/dotnetchina/Furion/issues/I5JSEU)
  - &nbsp;<Tag>æ–°å¢</Tag> äº‹ä»¶æ€»çº¿æ¨¡å—äº‹ä»¶ `Id` æ”¯æŒæšä¸¾ç±»å‹ [2f328aa](https://gitee.com/dotnetchina/Furion/commit/2f328aa8213c8efe7a8480116985573cc6b7fce6)
  - &nbsp;<Tag>æ–°å¢</Tag> äº‹ä»¶æ€»çº¿æ¨¡å—å‘å¸ƒè€… `PublishAsync` å’Œ `PublishDelayAsync` é‡è½½ [2f328aa](https://gitee.com/dotnetchina/Furion/commit/2f328aa8213c8efe7a8480116985573cc6b7fce6)
  - &nbsp;<Tag>æ–°å¢</Tag> äº‹ä»¶æ€»çº¿æ¨¡å—æ‹“å±•æ–¹æ³•ï¼š`Enum.ParseToString()` å’Œ `String.ParseToEnum()` [2f328aa](https://gitee.com/dotnetchina/Furion/commit/2f328aa8213c8efe7a8480116985573cc6b7fce6)

- **çªç ´æ€§å˜åŒ–**

  - &nbsp;<Tag>è°ƒæ•´</Tag> **äº‹ä»¶æ€»çº¿è§¦å‘å¤„ç†ç¨‹åºçš„é€»è¾‘ï¼Œç”±è¿‡å»çš„ `foreach` æ”¹ä¸º `Parallel.ForEach`ï¼Œååé‡æå‡è¿‘ 4 å€** <sup>4.6.4</sup> [7384c9c](https://gitee.com/dotnetchina/Furion/commit/7384c9c3efb94883421379828565e61870f1640c)
  - &nbsp;<Tag>è°ƒæ•´</Tag> **äº‹ä»¶æ€»çº¿ `IEventBusFactory` äº‹ä»¶å·¥å‚æ–¹æ³• `AddSubscriber -> Subscribe`ï¼Œ`RemoveSubscriber -> Unsubscribe` [a29fc7c](https://gitee.com/dotnetchina/Furion/commit/a29fc7cf63a3ea41b1617a6ad98a701a243e24f8)**

- **é—®é¢˜ä¿®å¤**

  - &nbsp;<Tag>ä¿®å¤</Tag> è¶…é«˜é¢‘ç‡ä¸‹å‘é€äº‹ä»¶æ€»çº¿æ¶ˆæ¯ï¼Œä½†æ˜¯ `GC` æ¥ä¸åŠå›æ”¶å¯¼è‡´å†…å­˜å’Œ `CPU` çˆ†æ‰é—®é¢˜ <sup>4.6.8</sup> [dbc7935](https://gitee.com/dotnetchina/Furion/commit/dbc7935618ff60d7f41d82c0d49042cd189e58b9)
  - &nbsp;<Tag>ä¿®å¤</Tag> åŸºäº `Redis` é‡å†™äº‹ä»¶å­˜å‚¨å™¨åºåˆ—åŒ– `IEventSource` å®ä¾‹å¼‚å¸¸é—®é¢˜ <sup>4.4.7</sup> [3e45020](https://gitee.com/dotnetchina/Furion/commit/3e45020eca5948d18d5cb405a665aae44088fd20)
  - &nbsp;<Tag>ä¿®å¤</Tag> äº‹ä»¶æ€»çº¿é»˜è®¤ `Channel` ç®¡é“åˆå§‹åŒ–æ—¶æœºè¿‡æ™šé—®é¢˜ï¼Œè§£å†³éƒ¨åˆ†ç¬¬ä¸‰æ–¹ä¾èµ–ä½¿ç”¨é—®é¢˜ [#I5MM3O](https://gitee.com/dotnetchina/Furion/issues/I5MM3O)
  - &nbsp;<Tag>ä¿®å¤</Tag> äº‹ä»¶æ€»çº¿é»˜è®¤å¼€å¯æ¨¡ç³ŠåŒ¹é…ï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼‰å¯¼è‡´ä¸å¿…è¦çš„è®¢é˜… [#I5NVOP](https://gitee.com/dotnetchina/Furion/issues/I5NVOP)

- **å…¶ä»–è°ƒæ•´**

  - &nbsp;<Tag>è°ƒæ•´</Tag> äº‹ä»¶æ€»çº¿é»˜è®¤æ—¥å¿—ç±»åä¸º `System.Logging.EventBusService` [#I5QLY5](https://gitee.com/dotnetchina/Furion/issues/I5QLY5)
  - &nbsp;<Tag>è°ƒæ•´</Tag> äº‹ä»¶æ€»çº¿é»˜è®¤ `Channel` ç®¡é“åˆå§‹åŒ–æ—¶æœºï¼Œè§£å†³éƒ¨åˆ†ç¬¬ä¸‰æ–¹ä¾èµ–ä½¿ç”¨é—®é¢˜ [#I5MM3O](https://gitee.com/dotnetchina/Furion/issues/I5MM3O)

</div>
  </div>
</details>

:::warning v2.20 ä»¥ä¸‹ç‰ˆæœ¬è¯´æ˜

**åœ¨ `Furion v2.20+` ç‰ˆæœ¬é‡‡ç”¨ [Jaina](https://gitee.com/dotnetchina/Jaina) äº‹ä»¶æ€»çº¿æ›¿æ¢åŸæœ‰çš„ `EventBus`**ï¼Œ[æŸ¥çœ‹æ—§æ–‡æ¡£](/docs/event-bus-old)

:::

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 2.20.0 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

## 22.1 å…³äºäº‹ä»¶æ€»çº¿

äº‹ä»¶æ€»çº¿æ˜¯å¯¹å‘å¸ƒ-è®¢é˜…æ¨¡å¼çš„ä¸€ç§å®ç°ã€‚å®ƒæ˜¯ä¸€ç§é›†ä¸­å¼äº‹ä»¶å¤„ç†æœºåˆ¶ï¼Œå…è®¸ä¸åŒçš„ç»„ä»¶ä¹‹é—´è¿›è¡Œå½¼æ­¤é€šä¿¡è€Œåˆä¸éœ€è¦ç›¸äº’ä¾èµ–ï¼Œè¾¾åˆ°ä¸€ç§è§£è€¦çš„ç›®çš„ã€‚

<img src={useBaseUrl("img/ebs.png")} />

## 22.2 å¿«é€Ÿå…¥é—¨

### 22.2.1 å®šä¹‰äº‹ä»¶å¤„ç†ç¨‹åº

å®šä¹‰äº‹ä»¶è®¢é˜…è€… `ToDoEventSubscriber`ï¼š

```cs showLineNumbers  {2,10-11,19-21,28-30,32,36-38,44-48,54-56}
// å®ç° IEventSubscriber æ¥å£
public class ToDoEventSubscriber : IEventSubscriber
{
    private readonly ILogger<ToDoEventSubscriber> _logger;
    public ToDoEventSubscriber(ILogger<ToDoEventSubscriber> logger)
    {
        _logger = logger;
    }

    [EventSubscribe("ToDo:Create")]
    public async Task CreateToDo(EventHandlerExecutingContext context)
    {
        var todo = context.Source;
        _logger.LogInformation("åˆ›å»ºä¸€ä¸ª ToDoï¼š{Name}", todo.Payload);
        await Task.CompletedTask;
    }

    // æ”¯æŒå¤šä¸ª
    [EventSubscribe("ToDo:Create")]
    [EventSubscribe("ToDo:Update")]
    public async Task CreateOrUpdateToDo(EventHandlerExecutingContext context)
    {
        var todo = context.Source;
        _logger.LogInformation("åˆ›å»ºæˆ–æ›´æ–°ä¸€ä¸ª ToDoï¼š{Name}", todo.Payload);
        await Task.CompletedTask;
    }

    // æ”¯æŒæšä¸¾ç±»å‹ï¼Œv3.4.3+ ç‰ˆæœ¬æ”¯æŒ
    [EventSubscribe(YourEnum.Some)]
    public async Task EnumHandler(EventHandlerExecutingContext context)
    {
        var eventEnum = context.Source.EventId.ParseToEnum(); // å°†äº‹ä»¶ Id è½¬æ¢æˆæšä¸¾å¯¹è±¡
        await Task.CompletedTask;
    }

    // æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œ4.2.10+ ç‰ˆæœ¬æ”¯æŒ
    [EventSubscribe("(^1[3456789][0-9]{9}$)|((^[0-9]{3,4}\\-[0-9]{3,8}$)|(^[0-9]{3,8}$)|(^\\([0-9]{3,4}\\)[0-9]{3,8}$)|(^0{0,1}13[0-9]{9}$))", FuzzyMatch = true)]
    public async Task RegexHandler(EventHandlerExecutingContext context)
    {
        var eventId = context.Source.EventId;
        await Task.CompletedTask;
    }

    // æ”¯æŒå¤šç§å¼‚å¸¸é‡è¯•é…ç½®ï¼ŒFurion 4.2.10+ ç‰ˆæœ¬æ”¯æŒ
    [EventSubscribe("test:error", NumRetries = 3)]
    [EventSubscribe("test:error", NumRetries = 3, RetryTimeout = 1000)] // é‡è¯•é—´éš”æ—¶é—´
    [EventSubscribe("test:error", NumRetries = 3, ExceptionTypes = new[] { typeof(ArgumentException) })]    // ç‰¹å®šç±»å‹å¼‚å¸¸æ‰é‡è¯•
    public async Task ExceptionHandler(EventHandlerExecutingContext context)
    {
        var eventId = context.Source.EventId;
        await Task.CompletedTask;
    }

    // æ”¯æŒç®€å• Order ç¼–æ’ï¼ŒFurion 4.8.0+ ç‰ˆæœ¬æ”¯æŒ
    [EventSubscribe("test:order", Order = 1)]
    public async Task ExceptionHandler(EventHandlerExecutingContext context)
    {
        var eventId = context.Source.EventId;
        await Task.CompletedTask;
    }
}
```

### 22.2.2 å‘å¸ƒäº‹ä»¶æ¶ˆæ¯

åˆ›å»ºæ§åˆ¶å™¨ `ToDoController`ï¼Œä¾èµ–æ³¨å…¥ `IEventPublisher` æœåŠ¡ï¼š

```cs showLineNumbers  {5,13-15,21-25}
public class ToDoController : ControllerBase
{
    // ä¾èµ–æ³¨å…¥äº‹ä»¶å‘å¸ƒè€… IEventPublisher
    private readonly IEventPublisher _eventPublisher;
    public ToDoController(IEventPublisher eventPublisher)
    {
        _eventPublisher = eventPublisher;
    }

    // å‘å¸ƒ ToDo:Create æ¶ˆæ¯
    public async Task CreateDoTo(string name)
    {
        await _eventPublisher.PublishAsync(new ChannelEventSource("ToDo:Create", name));
        // ä¹Ÿå¯ä»¥å»¶è¿Ÿå‘å¸ƒï¼Œæ¯”å¦‚å»¶è¿Ÿ 3s
        await _eventPublisher.PublishDelayAsync(new ChannelEventSource("ToDo:Create", name), 3000);
    }

    // v3.4.3+ ç‰ˆæœ¬æ”¯æŒå‘é€æ¶ˆæ¯ç®€åŒ–
    public async Task CreateDoTo(string name)
    {
        await _eventPublisher.PublishAsync("ToDo:Create", name);
        // ä¹Ÿå¯ä»¥å»¶è¿Ÿå‘å¸ƒï¼Œæ¯”å¦‚å»¶è¿Ÿ 3s
        await _eventPublisher.PublishDelayAsync("ToDo:Create", 3000, name);
        // ä¹Ÿæ”¯æŒæšä¸¾
        await _eventPublisher.PublishAsync(YourEnum.Some);
    }
}
```

### 22.2.3 æ³¨å†Œäº‹ä»¶æœåŠ¡

åœ¨ `Startup.cs` æ³¨å†Œ `EventBus` æœåŠ¡ï¼š

```cs showLineNumbers  {2,5}
// æ³¨å†Œ EventBus æœåŠ¡
services.AddEventBus(builder =>
{
    // æ³¨å†Œ ToDo äº‹ä»¶è®¢é˜…è€…
    builder.AddSubscriber<ToDoEventSubscriber>();

    // é€šè¿‡ç±»å‹æ³¨å†Œï¼ŒFurion 4.2.1+ ç‰ˆæœ¬
    builder.AddSubscriber(typeof(ToDoEventSubscriber));

    // æ‰¹é‡æ³¨å†Œäº‹ä»¶è®¢é˜…è€…
    builder.AddSubscribers(ass1, ass2, ....);
});
```

:::tip æ‡’äººæé†’

åœ¨ `Furion` ä¸­å¯ä»¥ä¸ç”¨é€šè¿‡ `builder.AddSubscriber<T>()` æ–¹å¼ä¸€ä¸€æ³¨å†Œï¼Œåªéœ€è¦å®ç° `ISingleton` æ¥å£å³å¯ï¼Œå¦‚ï¼š

```cs showLineNumbers  {1}
public class ToDoEventSubscriber : IEventSubscriber, ISingleton
{
}
```

è¿™æ ·å°±æ— éœ€å†™ ~~`builder.AddSubscriber<ToDoEventSubscriber>();`~~ ä»£ç äº†ï¼Œåªéœ€ä¿ç•™ `services.AddEventBus()` æœåŠ¡å³å¯ã€‚

:::

### 22.2.4 è¿è¡Œé¡¹ç›®

è¿è¡Œé¡¹ç›®å¹¶è§¦å‘äº‹ä»¶å‘å¸ƒæ¥å£æˆ–æ–¹æ³•ã€‚

```bash showLineNumbers
info: Jaina.Samples.ToDoEventSubscriber[0]
      åˆ›å»ºä¸€ä¸ª ToDoï¼šJaina
```

## 22.3 è‡ªå®šä¹‰äº‹ä»¶æº

`Furion` ä½¿ç”¨ `IEventSource` ä½œä¸ºæ¶ˆæ¯è½½ä½“ï¼Œä»»ä½•å®ç°è¯¥æ¥å£çš„ç±»éƒ½å¯ä»¥å……å½“æ¶ˆæ¯è½½ä½“ã€‚

å¦‚éœ€è‡ªå®šä¹‰ï¼Œåªéœ€å®ç° `IEventSource` æ¥å£å³å¯ï¼š

```cs showLineNumbers  {1,3,14,19,24,29,35-37}
public class ToDoEventSource : IEventSource
{
    public ToDoEventSource()
    {
    }

    public ToDoEventSource(string eventId, string todoName)
    {
        EventId = eventId;
        ToDoName = todoName;
    }

    // è‡ªå®šä¹‰å±æ€§
    public string ToDoName { get; set; }

    /// <summary>
    /// äº‹ä»¶ Id
    /// </summary>
    public string EventId { get; set; }

    /// <summary>
    /// äº‹ä»¶æ‰¿è½½ï¼ˆæºå¸¦ï¼‰æ•°æ®
    /// </summary>
    public object Payload { get; set; }

    /// <summary>
    /// äº‹ä»¶åˆ›å»ºæ—¶é—´
    /// </summary>
    public DateTime CreatedTime { get; set; } = DateTime.UtcNow;

    /// <summary>
    /// å–æ¶ˆä»»åŠ¡ Token
    /// </summary>
    /// <remarks>ç”¨äºå–æ¶ˆæœ¬æ¬¡æ¶ˆæ¯å¤„ç†</remarks>
    [Newtonsoft.Json.JsonIgnore]
    [System.Text.Json.Serialization.JsonIgnore]
    public CancellationToken CancellationToken { get; set; }
}
```

ä½¿ç”¨ï¼š

```cs showLineNumbers
await _eventPublisher.PublishAsync(new ToDoEventSource ("ToDo:Create", "æˆ‘çš„ ToDo Name"));
```

## 22.4 è‡ªå®šä¹‰äº‹ä»¶æºå­˜å‚¨å™¨

`Furion` é»˜è®¤é‡‡ç”¨ `Channel` ä½œä¸ºäº‹ä»¶æº `IEventSource` å­˜å‚¨å™¨ï¼Œå¼€å‘è€…å¯ä»¥ä½¿ç”¨ä»»ä½•æ¶ˆæ¯é˜Ÿåˆ—ç»„ä»¶è¿›è¡Œæ›¿æ¢ï¼Œå¦‚ `Kafkaã€RabbitMQã€ActiveMQ` ç­‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨éƒ¨åˆ†æ•°æ®åº“ `Redisã€SQL Serverã€MySql` å®ç°ã€‚

å¦‚éœ€è‡ªå®šä¹‰ï¼Œåªéœ€å®ç° `IEventSourceStorer` æ¥å£å³å¯ã€‚

### 22.4.1 `Redis` è‡ªå®šä¹‰æŒ‡å—

:::tip `Windows` ç‰ˆæœ¬ `Redis` å®‰è£…åŒ…ä¸‹è½½

[https://github.com/tporadowski/redis](https://github.com/tporadowski/redis)

:::

**1. å®‰è£… `Redis` æ‹“å±•åŒ…**

```bash showLineNumbers
Install-Package Microsoft.Extensions.Caching.StackExchangeRedis
```

ä¹Ÿå¯ä»¥ç›´æ¥å®‰è£… `StackExchange.Redis` åŒ…ã€‚

**2. åˆ›å»º `RedisEventSourceStorer` è‡ªå®šä¹‰å­˜å‚¨å™¨**

```cs showLineNumbers {11,34,49-59,77-90,101-102,110}
using Furion.EventBus;
using StackExchange.Redis;
using System;
using System.Text.Json;
using System.Threading;
using System.Threading.Channels;
using System.Threading.Tasks;

namespace Furion.Core;

public sealed class RedisEventSourceStorer : IEventSourceStorer, IDisposable
{
    /// <summary>
    /// å†…å­˜é€šé“äº‹ä»¶æºå­˜å‚¨å™¨
    /// </summary>
    private readonly Channel<IEventSource> _channel;

    /// <summary>
    /// Redis è¿æ¥å¯¹è±¡
    /// </summary>
    private readonly ConnectionMultiplexer _connectionMultiplexer;

    /// <summary>
    /// è·¯ç”±é”®
    /// </summary>
    private readonly string _routeKey;

    /// <summary>
    /// æ„é€ å‡½æ•°
    /// </summary>
    /// <param name="connectionMultiplexer">Redis è¿æ¥å¯¹è±¡</param>
    /// <param name="routeKey">è·¯ç”±é”®</param>
    /// <param name="capacity">å­˜å‚¨å™¨æœ€å¤šèƒ½å¤Ÿå¤„ç†å¤šå°‘æ¶ˆæ¯ï¼Œè¶…è¿‡è¯¥å®¹é‡è¿›å…¥ç­‰å¾…å†™å…¥</param>
    public RedisEventSourceStorer(ConnectionMultiplexer connectionMultiplexer, string routeKey, int capacity)
    {
        // é…ç½®é€šé“ï¼Œè®¾ç½®è¶…å‡ºé»˜è®¤å®¹é‡åè¿›å…¥ç­‰å¾…
        var boundedChannelOptions = new BoundedChannelOptions(capacity)
        {
            FullMode = BoundedChannelFullMode.Wait
        };

        // åˆ›å»ºæœ‰é™å®¹é‡é€šé“
        _channel = Channel.CreateBounded<IEventSource>(boundedChannelOptions);

        _connectionMultiplexer = connectionMultiplexer;
        _routeKey = routeKey;

        // è·å–ä¸€ä¸ªè®¢é˜…å¯¹è±¡
        var subscriber = connectionMultiplexer.GetSubscriber();

        // è®¢é˜…æ¶ˆæ¯
        subscriber.Subscribe(routeKey, (channel, data) =>
        {
            // è½¬æ¢ä¸º IEventSourceï¼Œè¿™é‡Œå¯ä»¥é€‰æ‹©è‡ªå·±å–œæ¬¢çš„åºåˆ—åŒ–å·¥å…·ï¼Œå¦‚æœè‡ªå®šä¹‰äº† EventSourceï¼Œæ³¨æ„å±æ€§æ˜¯å¯è¯»å¯å†™
            var eventSource = JsonSerializer.Deserialize<ChannelEventSource>(data.ToString());

            // å†™å…¥å†…å­˜ç®¡é“å­˜å‚¨å™¨
            _channel.Writer.WriteAsync(eventSource);
        });
    }

    /// <summary>
    /// å°†äº‹ä»¶æºå†™å…¥å­˜å‚¨å™¨
    /// </summary>
    /// <param name="eventSource">äº‹ä»¶æºå¯¹è±¡</param>
    /// <param name="cancellationToken">å–æ¶ˆä»»åŠ¡ Token</param>
    /// <returns><see cref="ValueTask"/></returns>
    public async ValueTask WriteAsync(IEventSource eventSource, CancellationToken cancellationToken)
    {
        // ç©ºæ£€æŸ¥
        if (eventSource == default)
        {
            throw new ArgumentNullException(nameof(eventSource));
        }

        // è¿™é‡Œåˆ¤æ–­æ˜¯å¦æ˜¯ ChannelEventSource æˆ–è€… è‡ªå®šä¹‰çš„ EventSource
        if (eventSource is ChannelEventSource source)
        {
            // åºåˆ—åŒ–ï¼Œè¿™é‡Œå¯ä»¥é€‰æ‹©è‡ªå·±å–œæ¬¢çš„åºåˆ—åŒ–å·¥å…·
            var data = JsonSerializer.Serialize(source);

            // è·å–ä¸€ä¸ªè®¢é˜…å¯¹è±¡
            var subscriber = _connectionMultiplexer.GetSubscriber();
            await subscriber.PublishAsync(_routeKey, data);
        }
        else
        {
            // è¿™é‡Œå¤„ç†åŠ¨æ€è®¢é˜…é—®é¢˜
            await _channel.Writer.WriteAsync(eventSource, cancellationToken);
        }
    }

    /// <summary>
    /// ä»å­˜å‚¨å™¨ä¸­è¯»å–ä¸€æ¡äº‹ä»¶æº
    /// </summary>
    /// <param name="cancellationToken">å–æ¶ˆä»»åŠ¡ Token</param>
    /// <returns>äº‹ä»¶æºå¯¹è±¡</returns>
    public async ValueTask<IEventSource> ReadAsync(CancellationToken cancellationToken)
    {
        // è¯»å–ä¸€æ¡äº‹ä»¶æº
        var eventSource = await _channel.Reader.ReadAsync(cancellationToken);
        return eventSource;
    }

    /// <summary>
    /// é‡Šæ”¾éæ‰˜ç®¡èµ„æº
    /// </summary>
    public void Dispose()
    {
        _connectionMultiplexer.Dispose();
    }
}
```

**3. æ›¿æ¢é»˜è®¤äº‹ä»¶å­˜å‚¨å™¨**

```cs showLineNumbers {1,4,7,10-13}
services.AddEventBus(options =>
{
    // åˆ›å»º Redis è¿æ¥å¯¹è±¡
    var connectionMultiplexer = ConnectionMultiplexer.Connect("localhost");

    // åˆ›å»ºé»˜è®¤å†…å­˜é€šé“äº‹ä»¶æºå¯¹è±¡ï¼Œå¯è‡ªå®šä¹‰é˜Ÿåˆ—è·¯ç”±keyï¼Œæ¯”å¦‚è¿™é‡Œæ˜¯ eventbus
    var redisEventSourceStorer = new RedisEventSourceStorer(connectionMultiplexer, "eventbus", 3000);

    // æ›¿æ¢é»˜è®¤äº‹ä»¶æ€»çº¿å­˜å‚¨å™¨
    options.ReplaceStorer(serviceProvider =>
    {
        return redisEventSourceStorer;
    });
});
```

:::tip å…³äº `StackExchange.Redis` è¶…æ—¶é—®é¢˜

å¦‚é‡åˆ° `StackExchange.Redis` è¶…æ—¶ï¼ˆTimeoutï¼‰é—®é¢˜ï¼Œå¯ç¼–è¾‘å¯åŠ¨å±‚çš„ `.csproj` æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```xml showLineNumbers {4}
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <ThreadPoolMinThreads>50</ThreadPoolMinThreads>
  </PropertyGroup>

</Project>
```

å¦‚æœä»¥ä¸Šé…ç½®ä¾ç„¶å­˜åœ¨è¶…æ—¶é—®é¢˜ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨ `Program.cs/Startup.cs` ä¸­æ·»åŠ  `ThreadPool.SetMinThreads(200, 200);`ã€‚

:::

### 22.4.2 `RabbitMQ` è‡ªå®šä¹‰æŒ‡å—

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.3.4 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

ç”±äºä½¿ç”¨ `RabbitMQ` ä½œä¸ºäº‹ä»¶æ€»çº¿å­˜å‚¨å™¨çš„æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥è¿™é‡Œæä¾›äº†å®Œæ•´çš„ä½¿ç”¨ä¾‹å­ã€‚

**1. å®‰è£… `RabbitMQ.Client` æ‹“å±•åŒ…**

```bash showLineNumbers
Install-Package RabbitMQ.Client
```

**2. åˆ›å»º `RabbitMQEventSourceStorer` è‡ªå®šä¹‰å­˜å‚¨å™¨**

```cs showLineNumbers {13,41,60,66-78,99-112,122-124,130-134}
using Furion.EventBus;
using RabbitMQ.Client;
using RabbitMQ.Client.Events;
using System;
using System.Text;
using System.Text.Json;
using System.Threading;
using System.Threading.Channels;
using System.Threading.Tasks;

namespace Furion.Core;

public sealed class RabbitMQEventSourceStorer : IEventSourceStorer, IDisposable
{
    /// <summary>
    /// å†…å­˜é€šé“äº‹ä»¶æºå­˜å‚¨å™¨
    /// </summary>
    private readonly Channel<IEventSource> _channel;

    /// <summary>
    /// é€šé“å¯¹è±¡
    /// </summary>
    private readonly IModel _model;

    /// <summary>
    /// è¿æ¥å¯¹è±¡
    /// </summary>
    private readonly IConnection _connection;

    /// <summary>
    /// è·¯ç”±é”®
    /// </summary>
    private readonly string _routeKey;

    /// <summary>
    /// æ„é€ å‡½æ•°
    /// </summary>
    /// <param name="factory">è¿æ¥å·¥å‚</param>
    /// <param name="routeKey">è·¯ç”±é”®</param>
    /// <param name="capacity">å­˜å‚¨å™¨æœ€å¤šèƒ½å¤Ÿå¤„ç†å¤šå°‘æ¶ˆæ¯ï¼Œè¶…è¿‡è¯¥å®¹é‡è¿›å…¥ç­‰å¾…å†™å…¥</param>
    public RabbitMQEventSourceStorer(ConnectionFactory factory, string routeKey, int capacity)
    {
        // é…ç½®é€šé“ï¼Œè®¾ç½®è¶…å‡ºé»˜è®¤å®¹é‡åè¿›å…¥ç­‰å¾…
        var boundedChannelOptions = new BoundedChannelOptions(capacity)
        {
            FullMode = BoundedChannelFullMode.Wait
        };

        // åˆ›å»ºæœ‰é™å®¹é‡é€šé“
        _channel = Channel.CreateBounded<IEventSource>(boundedChannelOptions);

        // åˆ›å»ºè¿æ¥
        _connection = factory.CreateConnection();
        _routeKey = routeKey;

        // åˆ›å»ºé€šé“
        _model = _connection.CreateModel();

        // å£°æ˜è·¯ç”±é˜Ÿåˆ—
        _model.QueueDeclare(routeKey, false, false, false, null);

        // åˆ›å»ºæ¶ˆæ¯è®¢é˜…è€…
        var consumer = new EventingBasicConsumer(_model);

        // è®¢é˜…æ¶ˆæ¯å¹¶å†™å…¥å†…å­˜ Channel
        consumer.Received += (ch, ea) =>
        {
            // è¯»å–åŸå§‹æ¶ˆæ¯
            var stringEventSource = Encoding.UTF8.GetString(ea.Body.ToArray());

            // è½¬æ¢ä¸º IEventSourceï¼Œè¿™é‡Œå¯ä»¥é€‰æ‹©è‡ªå·±å–œæ¬¢çš„åºåˆ—åŒ–å·¥å…·ï¼Œå¦‚æœè‡ªå®šä¹‰äº† EventSourceï¼Œæ³¨æ„å±æ€§æ˜¯å¯è¯»å¯å†™
            var eventSource = JsonSerializer.Deserialize<ChannelEventSource>(stringEventSource);

            // å†™å…¥å†…å­˜ç®¡é“å­˜å‚¨å™¨
            _channel.Writer.WriteAsync(eventSource);

            // ç¡®è®¤è¯¥æ¶ˆæ¯å·²è¢«æ¶ˆè´¹
            _model.BasicAck(ea.DeliveryTag, false);
        };

        // å¯åŠ¨æ¶ˆè´¹è€… è®¾ç½®ä¸ºæ‰‹åŠ¨åº”ç­”æ¶ˆæ¯
        _model.BasicConsume(routeKey, false, consumer);
    }

    /// <summary>
    /// å°†äº‹ä»¶æºå†™å…¥å­˜å‚¨å™¨
    /// </summary>
    /// <param name="eventSource">äº‹ä»¶æºå¯¹è±¡</param>
    /// <param name="cancellationToken">å–æ¶ˆä»»åŠ¡ Token</param>
    /// <returns><see cref="ValueTask"/></returns>
    public async ValueTask WriteAsync(IEventSource eventSource, CancellationToken cancellationToken)
    {
        // ç©ºæ£€æŸ¥
        if (eventSource == default)
        {
            throw new ArgumentNullException(nameof(eventSource));
        }

        // è¿™é‡Œåˆ¤æ–­æ˜¯å¦æ˜¯ ChannelEventSource æˆ–è€… è‡ªå®šä¹‰çš„ EventSource
        if (eventSource is ChannelEventSource source)
        {
            // åºåˆ—åŒ–ï¼Œè¿™é‡Œå¯ä»¥é€‰æ‹©è‡ªå·±å–œæ¬¢çš„åºåˆ—åŒ–å·¥å…·
            var data = Encoding.UTF8.GetBytes(JsonSerializer.Serialize(source));

            // å‘å¸ƒ
            _model.BasicPublish("", _routeKey, null, data);
        }
        else
        {
            // è¿™é‡Œå¤„ç†åŠ¨æ€è®¢é˜…é—®é¢˜
            await _channel.Writer.WriteAsync(eventSource, cancellationToken);
        }
    }

    /// <summary>
    /// ä»å­˜å‚¨å™¨ä¸­è¯»å–ä¸€æ¡äº‹ä»¶æº
    /// </summary>
    /// <param name="cancellationToken">å–æ¶ˆä»»åŠ¡ Token</param>
    /// <returns>äº‹ä»¶æºå¯¹è±¡</returns>
    public async ValueTask<IEventSource> ReadAsync(CancellationToken cancellationToken)
    {
        // è¯»å–ä¸€æ¡äº‹ä»¶æº
        var eventSource = await _channel.Reader.ReadAsync(cancellationToken);
        return eventSource;
    }

    /// <summary>
    /// é‡Šæ”¾éæ‰˜ç®¡èµ„æº
    /// </summary>
    public void Dispose()
    {
        _model.Dispose();
        _connection.Dispose();
    }
}
```

**3. æ›¿æ¢é»˜è®¤äº‹ä»¶å­˜å‚¨å™¨**

```cs showLineNumbers {1,4-8,11,14-16}
services.AddEventBus(options =>
{
    // åˆ›å»ºè¿æ¥å·¥å‚
    var factory = new ConnectionFactory
    {
        UserName = "admin",
        Password = "q1w2e3",
    };

    // åˆ›å»ºé»˜è®¤å†…å­˜é€šé“äº‹ä»¶æºå¯¹è±¡ï¼Œå¯è‡ªå®šä¹‰é˜Ÿåˆ—è·¯ç”±keyï¼Œæ¯”å¦‚è¿™é‡Œæ˜¯ eventbus
    var rbmqEventSourceStorer = new RabbitMQEventSourceStorer(factory, "eventbus", 3000);

    // æ›¿æ¢é»˜è®¤äº‹ä»¶æ€»çº¿å­˜å‚¨å™¨
    options.ReplaceStorer(serviceProvider =>
    {
        return rbmqEventSourceStorer;
    });
});
```

<img src={useBaseUrl("img/evs1.png")} />

### 22.4.3 `Kafka` è‡ªå®šä¹‰æŒ‡å—

**1. å®‰è£… `Confluent.Kafka` æ‹“å±•åŒ…**

```bash showLineNumbers
Install-Package Confluent.Kafka
```

**2. åˆ›å»º `EventConsumer` è®¢é˜…ç±»**

```cs showLineNumbers {10}
using Confluent.Kafka;

namespace Furion.Core;

/// <summary>
/// Kafka æ¶ˆæ¯æ‰©å±•
/// </summary>
/// <typeparam name="TKey"></typeparam>
/// <typeparam name="TValue"></typeparam>
public class EventConsumer<TKey, TValue> : IDisposable
{
    private Task _consumerTask;
    private CancellationTokenSource _consumerCts;

    /// <summary>
    /// æ¶ˆè´¹è€…
    /// </summary>
    public IConsumer<TKey, TValue> Consumer { get; }

    /// <summary>
    /// ConsumerBuilder
    /// </summary>
    public ConsumerBuilder<TKey, TValue> Builder { get; set; }

    /// <summary>
    /// æ¶ˆæ¯å›è°ƒ
    /// </summary>
    public event EventHandler<ConsumeResult<TKey, TValue>> Received;

    /// <summary>
    /// å¼‚å¸¸å›è°ƒ
    /// </summary>
    public event EventHandler<ConsumeException> OnConsumeException;

    /// <summary>
    /// æ„é€ å‡½æ•°
    /// </summary>
    /// <param name="config"></param>
    public EventConsumer(IEnumerable<KeyValuePair<string, string>> config)
    {
        Builder = new ConsumerBuilder<TKey, TValue>(config);
        Consumer = Builder.Build();
    }

    /// <summary>
    /// å¯åŠ¨
    /// </summary>
    /// <exception cref="InvalidOperationException"></exception>
    public void Start()
    {
        if (Consumer.Subscription?.Any() != true)
        {
            throw new InvalidOperationException("Subscribe first using the Consumer.Subscribe() function");
        }
        if (_consumerTask != null)
        {
            return;
        }
        _consumerCts = new CancellationTokenSource();
        var ct = _consumerCts.Token;
        _consumerTask = Task.Factory.StartNew(() =>
        {
            while (!ct.IsCancellationRequested)
            {
                try
                {
                    var cr = Consumer.Consume(TimeSpan.FromSeconds(1));
                    if (cr == null) continue;
                    Received?.Invoke(this, cr);
                }
                catch (ConsumeException e)
                {
                    OnConsumeException?.Invoke(this, e);
                }
            }
        }, ct, TaskCreationOptions.LongRunning, System.Threading.Tasks.TaskScheduler.Default);
    }

    /// <summary>
    /// åœæ­¢
    /// </summary>
    /// <returns></returns>
    public async Task Stop()
    {
        if (_consumerCts == null || _consumerTask == null) return;
        _consumerCts.Cancel();
        try
        {
            await _consumerTask;
        }
        finally
        {
            _consumerTask = null;
            _consumerCts = null;
        }
    }

    /// <summary>
    /// é‡Šæ”¾
    /// </summary>
    public void Dispose()
    {
        Dispose(true);
        GC.SuppressFinalize(this);
    }

    /// <summary>
    /// é‡Šæ”¾
    /// </summary>
    /// <param name="disposing"></param>
    protected virtual void Dispose(bool disposing)
    {
        if (disposing)
        {
            if (_consumerTask != null)
            {
                Stop().Wait();
            }
            Consumer?.Dispose();
        }
    }
}
```

**3. åˆ›å»º `KafkaEventSourceStore` è‡ªå®šä¹‰å­˜å‚¨å™¨**

```cs showLineNumbers {11,55-63,84-99,109-110,119-120}
using Confluent.Kafka;
using Furion.EventBus;
using Newtonsoft.Json;
using System.Threading.Channels;

namespace Furion.Core;

/// <summary>
/// Kafka å­˜å‚¨æº
/// </summary>
public class KafkaEventSourceStore : IEventSourceStorer, IDisposable
{
    /// <summary>
    /// å†…å­˜é€šé“äº‹ä»¶æºå­˜å‚¨å™¨
    /// </summary>
    private readonly Channel<IEventSource> _channel;
    /// <summary>
    /// ä¸»é¢˜
    /// </summary>
    private readonly string _topic;
    /// <summary>
    /// æ¶ˆè´¹è€…
    /// </summary>
    private readonly EventConsumer<Null, string> _eventConsumer;
    /// <summary>
    /// ç”Ÿäº§è€…
    /// </summary>
    private readonly IProducer<Null, string> _producer;

    /// <summary>
    /// æ„é€ å‡½æ•°
    /// </summary>
    /// <param name="consumerConf">æ¶ˆè´¹è€…é…ç½®</param>
    /// <param name="producerConf">ç”Ÿäº§è€…é…ç½®</param>
    /// <param name="topic">ä¸»é¢˜</param>
    /// <param name="capacity">å­˜å‚¨å™¨æœ€å¤šèƒ½å¤Ÿå¤„ç†å¤šå°‘æ¶ˆæ¯ï¼Œè¶…è¿‡è¯¥å®¹é‡è¿›å…¥ç­‰å¾…å†™å…¥</param>
    public KafkaEventSourceStore(ConsumerConfig consumerConf, ProducerConfig producerConf, string topic, int capacity)
    {
        // é…ç½®é€šé“ï¼Œè®¾ç½®è¶…å‡ºé»˜è®¤å®¹é‡åè¿›å…¥ç­‰å¾…
        var boundedChannelOptions = new BoundedChannelOptions(capacity)
        {
            FullMode = BoundedChannelFullMode.Wait
        };

        // åˆ›å»ºæœ‰é™å®¹é‡é€šé“
        _channel = Channel.CreateBounded<IEventSource>(boundedChannelOptions);

        // ä¸»é¢˜
        _topic = topic;

        // åˆ›å»ºæ¶ˆæ¯è®¢é˜…è€…
        _eventConsumer = new EventConsumer<Null, string>(consumerConf);
        _eventConsumer.Consumer.Subscribe(new[] { topic });

        // è®¢é˜…æ¶ˆæ¯å†™å…¥ Channel
        _eventConsumer.Received += (send, cr) =>
        {
            // ååºåˆ—åŒ–æ¶ˆæ¯
            var eventSource = JsonConvert.DeserializeObject<ChannelEventSource>(cr.Message.Value);

            // å†™å…¥å†…å­˜ç®¡é“å­˜å‚¨å™¨
            _channel.Writer.WriteAsync(eventSource);
        };

        // å¯åŠ¨æ¶ˆè´¹è€…
        _eventConsumer.Start();

        // åˆ›å»ºç”Ÿäº§è€…
        _producer = new ProducerBuilder<Null, string>(producerConf).Build();
    }

    /// <summary>
    /// å°†äº‹ä»¶æºå†™å…¥å­˜å‚¨å™¨
    /// </summary>
    /// <param name="eventSource">äº‹ä»¶æºå¯¹è±¡</param>
    /// <param name="cancellationToken">å–æ¶ˆä»»åŠ¡ Token</param>
    /// <returns><see cref="ValueTask"/></returns>
    public async ValueTask WriteAsync(IEventSource eventSource, CancellationToken cancellationToken)
    {
        if (eventSource == default)
        {
            throw new ArgumentNullException(nameof(eventSource));
        }
        // è¿™é‡Œåˆ¤æ–­æ˜¯å¦æ˜¯ ChannelEventSource æˆ–è€… è‡ªå®šä¹‰çš„ EventSource
        if (eventSource is ChannelEventSource source)
        {
            // åºåˆ—åŒ–
            var data = JsonConvert.SerializeObject(source);
            // å¼‚æ­¥å‘å¸ƒ
            await _producer.ProduceAsync(_topic, new Message<Null, string>
            {
                Value = data
            }, cancellationToken);
        }
        else
        {
            // è¿™é‡Œå¤„ç†åŠ¨æ€è®¢é˜…é—®é¢˜
            await _channel.Writer.WriteAsync(eventSource, cancellationToken);
        }
    }

    /// <summary>
    /// ä»å­˜å‚¨å™¨ä¸­è¯»å–ä¸€æ¡äº‹ä»¶æº
    /// </summary>
    /// <param name="cancellationToken">å–æ¶ˆä»»åŠ¡ Token</param>
    /// <returns>äº‹ä»¶æºå¯¹è±¡</returns>
    public async ValueTask<IEventSource> ReadAsync(CancellationToken cancellationToken)
    {
        // è¯»å–ä¸€æ¡äº‹ä»¶æº
        var eventSource = await _channel.Reader.ReadAsync(cancellationToken);
        return eventSource;
    }

    /// <summary>
    /// é‡Šæ”¾éæ‰˜ç®¡èµ„æº
    /// </summary>
    public async void Dispose()
    {
        await _eventConsumer.Stop();
        GC.SuppressFinalize(this);
    }
}
```

**4. æ›¿æ¢é»˜è®¤äº‹ä»¶å­˜å‚¨å™¨**

```cs showLineNumbers {1,3-8,10-15,18,21-24}
services.AddEventBus(options =>
{
    var consumerConf = new ConsumerConfig
    {
        BootstrapServers = "xxx.xxx.xxx.xxx:9092",
        GroupId = "Consumer",
        AutoOffsetReset = AutoOffsetReset.Earliest // ä»æœ€æ—©çš„å¼€å§‹æ¶ˆè´¹èµ·
    };

    var producerConf = new ProducerConfig
    {
        BootstrapServers = "xxx.xxx.xxx.xxx:9092",
        BatchSize = 16384, // ä¿®æ”¹æ‰¹æ¬¡å¤§å°ä¸º16K
        LingerMs = 20 // ä¿®æ”¹ç­‰å¾…æ—¶é—´ä¸º20ms
    };

    // åˆ›å»ºé»˜è®¤å†…å­˜é€šé“äº‹ä»¶æºå¯¹è±¡ï¼Œå¯è‡ªå®šä¹‰é˜Ÿåˆ—è·¯ç”±keyï¼Œæ¯”å¦‚è¿™é‡Œæ˜¯ eventbus
    var kafkaEventSourceStorer = new KafkaEventSourceStore(consumerConf, producerConf, "testTopic", 30000);

    // æ›¿æ¢é»˜è®¤äº‹ä»¶æ€»çº¿å­˜å‚¨å™¨
    options.ReplaceStorer(serviceProvider =>
    {
        return kafkaEventSourceStorer;
    });
});
```

## 22.5 è‡ªå®šä¹‰äº‹ä»¶å‘å¸ƒè€…

`Furion` é»˜è®¤å†…ç½®åŸºäº `Channel` çš„äº‹ä»¶å‘å¸ƒè€… `ChannelEventPublisher`ã€‚

å¦‚éœ€è‡ªå®šä¹‰ï¼Œåªéœ€å®ç° `IEventPublisher` æ¥å£å³å¯ï¼š

```cs showLineNumbers  {1,10}
public class ToDoEventPublisher : IEventPublisher
{
    private readonly IEventSourceStorer _eventSourceStorer;

    public ToDoEventPublisher(IEventSourceStorer eventSourceStorer)
    {
        _eventSourceStorer = eventSourceStorer;
    }

    public async Task PublishAsync(IEventSource eventSource)
    {
        await _eventSourceStorer.WriteAsync(eventSource, eventSource.CancellationToken);
    }

    // .... å…¶ä»–æ¥å£å®ç°
}
```

æœ€åï¼Œåœ¨æ³¨å†Œ `EventBus` æœåŠ¡ä¸­æ›¿æ¢é»˜è®¤ `IEventPublisher`ï¼š

```cs showLineNumbers  {4}
services.AddEventBus(builder =>
{
    // æ›¿æ¢äº‹ä»¶æºå­˜å‚¨å™¨
    builder.ReplacePublisher<ToDoEventPublisher>();
});
```

## 22.6 æ·»åŠ äº‹ä»¶æ‰§è¡Œç›‘è§†å™¨

`Furion` æä¾›äº† `IEventHandlerMonitor` ç›‘è§†å™¨æ¥å£ï¼Œå®ç°è¯¥æ¥å£å¯ä»¥ç›‘è§†æ‰€æœ‰è®¢é˜…äº‹ä»¶ï¼ŒåŒ…æ‹¬ `æ‰§è¡Œä¹‹å‰ã€æ‰§è¡Œä¹‹åï¼Œæ‰§è¡Œå¼‚å¸¸ï¼Œå…±äº«ä¸Šä¸‹æ–‡æ•°æ®`ã€‚

å¦‚æ·»åŠ  `ToDoEventHandlerMonitor`ï¼š

```cs showLineNumbers  {1,9,15}
public class ToDoEventHandlerMonitor : IEventHandlerMonitor
{
    private readonly ILogger<ToDoEventHandlerMonitor> _logger;
    public ToDoEventHandlerMonitor(ILogger<ToDoEventHandlerMonitor> logger)
    {
        _logger = logger;
    }

    public Task OnExecutingAsync(EventHandlerExecutingContext context)
    {
        _logger.LogInformation("æ‰§è¡Œä¹‹å‰ï¼š{EventId}", context.Source.EventId);
        return Task.CompletedTask;
    }

    public Task OnExecutedAsync(EventHandlerExecutedContext context)
    {
        _logger.LogInformation("æ‰§è¡Œä¹‹åï¼š{EventId}", context.Source.EventId);

        if (context.Exception != null)
        {
            _logger.LogError(context.Exception, "æ‰§è¡Œå‡ºé”™å•¦ï¼š{EventId}", context.Source.EventId);
        }

        return Task.CompletedTask;
    }
}
```

æœ€åï¼Œåœ¨æ³¨å†Œ `EventBus` æœåŠ¡ä¸­æ³¨å†Œ `ToDoEventHandlerMonitor`ï¼š

```cs showLineNumbers  {4}
services.AddEventBus(builder =>
{
    // æ·»åŠ äº‹ä»¶æ‰§è¡Œç›‘è§†å™¨
    builder.AddMonitor<ToDoEventHandlerMonitor>();
});
```

## 22.7 æ·»åŠ äº‹ä»¶æ‰§è¡Œå™¨

`Furion` æä¾›äº† `IEventHandlerExecutor` æ‰§è¡Œå™¨æ¥å£ï¼Œå¯ä»¥è®©å¼€å‘è€…è‡ªå®šä¹‰äº‹ä»¶å¤„ç†å‡½æ•°æ‰§è¡Œç­–ç•¥ï¼Œå¦‚ `è¶…æ—¶æ§åˆ¶ï¼Œå¤±è´¥é‡è¯•ã€ç†”æ–­ç­‰ç­‰`ã€‚

å¦‚æ·»åŠ  `RetryEventHandlerExecutor`ï¼š

```cs showLineNumbers  {1,3}
public class RetryEventHandlerExecutor : IEventHandlerExecutor
{
    public async Task ExecuteAsync(EventHandlerExecutingContext context, Func<EventHandlerExecutingContext, Task> handler)
    {
        // å¦‚æœæ‰§è¡Œå¤±è´¥ï¼Œæ¯éš” 1s é‡è¯•ï¼Œæœ€å¤šä¸‰æ¬¡
        await Retry.InvokeAsync(async () => {
            await handler(context);
        }, 3, 1000);
    }
}
```

æœ€åï¼Œåœ¨æ³¨å†Œ `EventBus` æœåŠ¡ä¸­æ³¨å†Œ `RetryEventHandlerExecutor`ï¼š

```cs showLineNumbers  {4}
services.AddEventBus(builder =>
{
    // æ·»åŠ äº‹ä»¶æ‰§è¡Œå™¨
    builder.AddExecutor<RetryEventHandlerExecutor>();
});
```

## 22.8 ä½¿ç”¨æœ‰ä½œç”¨åŸŸçš„æœåŠ¡

åœ¨ `Furion` ä¸­ï¼Œ `Event Bus` æ‰€æœ‰æœåŠ¡å‡æ³¨å†Œä¸ºå•ä¾‹ï¼Œå¦‚éœ€ä½¿ç”¨ä½œç”¨åŸŸæœåŠ¡ï¼ˆå•ä¾‹æœåŠ¡å¯ç›´æ¥æ³¨å…¥ï¼‰ï¼Œå¯é€šè¿‡ä¾èµ–æ³¨å…¥ `IServiceScopeFactory` å®ä¾‹å¹¶é€šè¿‡ `CreateScope()` åˆ›å»ºä¸€ä¸ªä½œç”¨åŸŸï¼Œå¦‚ï¼š

```cs showLineNumbers  {5,8,10,13,18-22}
public class ToDoEventSubscriber : IEventSubscriber
{
    private readonly ILogger<ToDoEventSubscriber> _logger;

    public ToDoEventSubscriber(IServiceScopeFactory scopeFactory    // å•ä¾‹æœåŠ¡å¯ä»¥ç›´æ¥æ³¨å…¥
        , ILogger<ToDoEventSubscriber> logger)  // å•ä¾‹æœåŠ¡å¯ä»¥ç›´æ¥æ³¨å…¥
    {
        ScopeFactory = scopeFactory;
        _logger = logger;
        // é¿å…åœ¨è¿™é‡Œè§£æéå•ä¾‹æœåŠ¡
    }

    public IServiceScopeFactory ScopeFactory { get; }

    [EventSubscribe("ToDo:Create")]
    public async Task CreateToDo(EventHandlerExecutingContext context)
    {
        // åˆ›å»ºæ–°çš„ä½œç”¨åŸŸ
        using var scope = ScopeFactory.CreateScope();

        // è§£ææœåŠ¡
        var scopedProcessingService = scope.ServiceProvider.GetRequiredService<IScopedProcessingService>();
        // ....
    }
}
```

:::important ç‰¹åˆ«æ³¨æ„

å¦‚æœæ˜¯éå•ä¾‹å¯¹è±¡ï¼Œåº”é¿å…åœ¨æ„é€ å‡½æ•°ä¸­è§£ææœåŠ¡ï¼Œå¦‚æŠŠ `scope.ServiceProvider.GetRequiredService<T>()` æ”¾åœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–ä¼šå¯¼è‡´ä¸€äº›æœåŠ¡æ— æ³•ä½¿ç”¨ã€‚

:::

## 22.9 è®¢é˜…æ‰§è¡Œä»»åŠ¡æ„å¤–å¼‚å¸¸

äº‹ä»¶å¤„ç†ç¨‹åºä½¿ç”¨çš„æ˜¯ `Task` å¯¹è±¡è¿›è¡Œåˆ›å»ºå¹¶æ‰§è¡Œï¼Œä½†å¯èƒ½å­˜åœ¨ä¸€äº›æ„å¤–ä¸”éš¾ä»¥æ•è·çš„å¼‚å¸¸ï¼Œè¿™æ—¶å€™å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¢é˜…ï¼š

```cs showLineNumbers  {4}
services.AddEventBus(builder =>
{
    // è®¢é˜… EventBus æ„å¤–æœªæ•è·å¼‚å¸¸
    builder.UnobservedTaskExceptionHandler = (obj, args) =>
    {
        // ....
    };
});
```

## 22.10 äº‹ä»¶æ€»çº¿å·¥å‚

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.2.10 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

åœ¨è¯¥ç‰ˆæœ¬ä¸­ï¼Œ`Furion` æä¾›äº† `IEventBusFactory` å·¥å‚æœåŠ¡ï¼Œå¯åœ¨è¿è¡Œæ—¶åŠ¨æ€æ–°å¢æˆ–åˆ é™¤è®¢é˜…ï¼Œå¦‚ï¼š

```cs showLineNumbers {4,14-17,24}
public class TestEventBus : IDynamicApiController
{
    private readonly IEventPublisher _eventPublisher;
    private readonly IEventBusFactory _eventBusFactory;
    public TestEventBus(IEventPublisher eventPublisher, IEventBusFactory eventBusFactory)
    {
        _eventPublisher = eventPublisher;
        _eventBusFactory = eventBusFactory;
    }

    // è¿è¡Œæ—¶åŠ¨æ€æ·»åŠ ä¸€ä¸ªè®¢é˜…å™¨
    public async Task AddSubscriber()
    {
        await _eventBusFactory.Subscribe("xxx", async (ctx) =>
        {
            Console.WriteLine("æˆ‘æ˜¯åŠ¨æ€çš„");
            await Task.CompletedTask;
        });
    }

    // è¿è¡Œæ—¶åŠ¨æ€åˆ é™¤ä¸€ä¸ªè®¢é˜…å™¨
    public async Task RemoveDynamic(string eventId)
    {
        await _eventBusFactory.Unsubscribe(eventId);
    }
}
```

## 22.11 `MessageCenter` é™æ€ç±»

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.3.3 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

åœ¨ `Furion 4.3.3` ç‰ˆæœ¬æ–°å¢äº† `MessageCenter` é™æ€ç±»ï¼Œå¯åœ¨ä»»ä½•åœ°æ–¹å‘é€äº‹ä»¶æ¶ˆæ¯æˆ–è®¢é˜…æ¶ˆæ¯ã€‚

```cs showLineNumbers {2,5,11}
// å‘é€æ¶ˆæ¯ï¼ˆå«è¯¸å¤šé‡è½½ï¼‰
await MessageCenter.PublishAsync("messageId", new {});

// åŠ¨æ€è®¢é˜…æ¶ˆæ¯
MessageCenter.Subscribe("messageId", async (ctx) => {
    Console.WriteLine("æˆ‘æ˜¯åŠ¨æ€çš„");
    await Task.CompletedTask;
});

// å–æ¶ˆè®¢é˜…
MessageCenter.Unsubscribe("messageId");
```

## 22.12 é…ç½®é‡è¯•å¤±è´¥å›è°ƒ

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.6.1 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

1. åˆ›å»º `IEventFallbackPolicy` å®ç°ç±»å¹¶å®ç° `Callback` æ–¹æ³•ï¼Œå¦‚ `EventFallbackPolicy`ï¼š

```cs showLineNumbers {1,9}
public class EventFallbackPolicy : IEventFallbackPolicy
{
    private readonly ILogger<EventFallbackPolicy> _logger;
    public EventFallbackPolicy(ILogger<EventFallbackPolicy> logger)
    {
        _logger = logger;
    }

    public async Task CallbackAsync(EventHandlerExecutingContext context, Exception ex)
    {
        _logger.LogError(ex, "é‡è¯•äº†å¤šæ¬¡æœ€ç»ˆè¿˜æ˜¯å¤±è´¥äº†");
        await Task.CompletedTask;
    }
}
```

2. æ³¨å†Œ `EventFallbackPolicy` ç±»å‹æœåŠ¡

```cs showLineNumbers {1,3}
services.AddEventBus(options =>
{
    options.AddFallbackPolicy<EventFallbackPolicy>();
});
```

3. é€šè¿‡ `[EventSubscribe]` ç‰¹æ€§é…ç½® `FallbackPolicy` å±æ€§ä½¿ç”¨

```cs showLineNumbers {1}
[EventSubscribe("test:error", NumRetries = 3, FallbackPolicy = typeof(EventFallbackPolicy))]  // é‡è¯•ä¸‰æ¬¡
public async Task TestError(EventHandlerExecutingContext context)
{
    Console.WriteLine("æˆ‘æ‰§è¡Œå•¦~~");
    throw new NotImplementedException();
}
```

<img src={useBaseUrl("img/nrs.png")} />

:::note å°çŸ¥è¯†

å¯ä»¥å®šä¹‰å¤šä¸ª `IEventFallbackPolicy` å®ç°ç±»ï¼Œç„¶åé€šè¿‡ `options.AddFallbackPolicy<T>()` æ³¨å†Œå¤šä¸ªï¼Œè¿™æ ·å®ç°ä¸åŒçš„äº‹ä»¶è®¢é˜…ç¨‹åºæ‰§è¡Œä¸åŒçš„ç­–ç•¥ã€‚å¦‚ï¼š

```cs showLineNumbers {1,3}
[EventSubscribe("test:error", NumRetries = 3, FallbackPolicy = typeof(EventFallbackPolicy))]

[EventSubscribe("test:error", NumRetries = 1010, FallbackPolicy = typeof(OtherEventFallbackPolicy))]
```

:::

## 22.13 è‡ªå®šä¹‰äº‹ä»¶æºå­˜å‚¨å™¨ä¸å¯ç”¨æ—¶å›é€€

æœ‰æ—¶å€™æˆ‘ä»¬è‡ªå®šä¹‰äº†äº‹ä»¶æºå­˜å‚¨å™¨å¦‚ä½¿ç”¨ `Redis`ã€`RabbitMQ` ç­‰ç¬¬ä¸‰æ–¹å­˜å‚¨ä»‹è´¨ï¼Œä½†ç”±äºä¸€äº›åŸå› å¯¼è‡´å¯åŠ¨æ—¶ä¸å¯ç”¨å¦‚ `Redis` æœåŠ¡æœªå¯åŠ¨ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥é…ç½®é€‰æ‹©å›é€€åˆ°é»˜è®¤äº‹ä»¶æºå­˜å‚¨å™¨ï¼ˆå†…å­˜ï¼‰ä¸­ï¼Œå¦‚ï¼š

```cs showLineNumbers {3,9-12}
services.AddEventBus(options =>
{
    options.ReplaceStorerOrFallback(() => new RedisEventSourceStorer(......));
});

// è¿˜å¯ä»¥è§£ææœåŠ¡ä¼ å…¥
services.AddEventBus(options =>
{
    options.ReplaceStorerOrFallback(serviceProvider =>    // æä¾› IServiceProvider å¯è§£ææœåŠ¡
    {
        // var someService = serviceProvider.GetRequiredService<ISomeSerivce>();
        return new RedisEventSourceStorer(......);
    });
});
```

:::tip ç‰¹åˆ«è¯´æ˜

ç›®å‰åªæ”¯æŒåœ¨åº”ç”¨å¯åŠ¨æ—¶æ£€æŸ¥ï¼Œä¸æ”¯æŒåœ¨è¿è¡Œæ—¶å®ç°æ•…éšœè½¬ç§»åˆ‡æ¢ã€‚

:::

## 22.14 `EventBusOptionsBuilder` é…ç½®

`EventBusOptionsBuilder` æ˜¯ `AddEventBus` æ„å»ºæœåŠ¡é€‰é¡¹ï¼Œè¯¥é€‰é¡¹åŒ…å«ä»¥ä¸‹å±æ€§å’Œæ–¹æ³•ï¼š

- å±æ€§
  - `ChannelCapacity`ï¼šé»˜è®¤å†…å­˜é€šé“å®¹é‡
  - `UnobservedTaskExceptionHandler`ï¼šè®¢é˜…æ‰§è¡Œä»»åŠ¡æœªå¯Ÿè§‰å¼‚å¸¸
  - `UseUtcTimestamp`ï¼šæ˜¯å¦ä½¿ç”¨ `UTC` æ—¶é—´ï¼Œ`bool` ç±»å‹ï¼Œé»˜è®¤ `false`
  - `FuzzyMatch`ï¼šæ˜¯å¦å¼€å¯å…¨å±€æ¨¡ç³ŠåŒ¹é…ï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼‰äº‹ä»¶ `Id`ï¼Œ`bool` ç±»å‹ï¼Œé»˜è®¤ `false`
  - `LogEnabled`ï¼šæ˜¯å¦å¯ç”¨æ—¥å¿—è¾“å‡ºï¼Œ`bool` ç±»å‹ï¼Œé»˜è®¤ `true`
- æ–¹æ³•
  - `AddSubscriber<TEventSubscriber>`ï¼šæ·»åŠ è®¢é˜…è€…
  - `ReplacePublisher<TEventPublisher>`ï¼šæ›¿æ¢å‘å¸ƒè€…
  - `ReplaceStorer(Func<IServiceProvider, IEventSourceStorer>)`ï¼šæ›¿æ¢å­˜å‚¨å™¨
  - `ReplaceStorerOrFallback(Func<IServiceProvider, IEventSourceStorer>)`ï¼šæ›¿æ¢å­˜å‚¨å™¨å¦‚æœå¤±è´¥åˆ™å›æ»šé»˜è®¤
  - `AddMonitor<TEventHandlerMonitor>`ï¼šæ·»åŠ ç›‘è§†å™¨
  - `AddExecutor<TEventHandlerExecutor>`ï¼šæ·»åŠ æ‰§è¡Œå™¨

## 22.15 å…³äºé«˜é¢‘æ¶ˆæ¯å¤„ç†æ–¹å¼

åœ¨ä¸€äº›é«˜é¢‘å‘é€æ¶ˆæ¯çš„åœºæ™¯å¦‚ `IoT`ã€æ—¥å¿—è®°å½•ã€æ•°æ®é‡‡é›†ï¼Œä¸ºé¿å…é¢‘ç¹è§£ææœåŠ¡å’Œåˆ›å»ºä½œç”¨åŸŸï¼Œå¯ä½¿ç”¨ **ç±»å…¨å±€ä½œç”¨åŸŸ** å’Œæ‰€æœ‰æœåŠ¡éƒ½é‡‡å–å•ä¾‹çš„æ–¹å¼ï¼š

```cs showLineNumbers {1,4,6,9,17,24-26}
public class ToDoEventSubscriber : IEventSubscriber, IDisposable
{
    private readonly ILogger<ToDoEventSubscriber> _logger;
    private readonly IServiceScope _serviceScope;

    public ToDoEventSubscriber(IServiceScopeFactory scopeFactory
        , ILogger<ToDoEventSubscriber> logger)
    {
        _serviceScope = scopeFactory.CreateScope();
        _logger = logger;
    }

    [EventSubscribe("iot:log")]
    public async Task LogFromIoT(EventHandlerExecutingContext context)
    {
        // è§£ææœåŠ¡
        var scopedProcessingService = _serviceScope.ServiceProvider.GetRequiredService<IScopedProcessingService>();
        // ....
    }

    /// <summary>
    /// é‡Šæ”¾æœåŠ¡ä½œç”¨åŸŸ
    /// </summary>
    public void Dispose()
    {
        _serviceScope.Dispose();
    }
}
```

## 22.16 IIS éƒ¨ç½²å›æ”¶è®¾ç½®

å¦‚æœåœ¨é¡¹ç›®ä¸­ä½¿ç”¨äº†äº‹ä»¶æ€»çº¿ä¸”éƒ¨ç½²åˆ° `IIS` ä¸­ï¼Œé‚£ä¹ˆéœ€è¦è®¾ç½® `IIS` ç¦æ­¢å›æ”¶ï¼Œé¿å…äº‹ä»¶æ€»çº¿æœåŠ¡è¿›å…¥ä¼‘çœ ï¼Œ[ç‚¹å‡»æŸ¥çœ‹ `IIS` å›æ”¶é—®é¢˜è§£å†³æ–¹æ¡ˆ](./deploy-iis#3415-iis-%E5%9B%9E%E6%94%B6%E9%97%AE%E9%A2%98%E5%92%8C%E9%85%8D%E7%BD%AE)

## 22.17 ä½¿ç”¨ç¬¬ä¸‰æ–¹äº‹ä»¶æ€»çº¿ `CAP` ç¤ºä¾‹

```cs showLineNumbers {1,5}
builder.Services.AddCap(options =>
{
    options.UseInMemoryStorage();
    options.UseInMemoryMessageQueue();
}).AddSubscriberAssembly(App.Assemblies.ToArray());
```

## 22.18 åœ¨ `WinForm/WPF` ä¸­ä½¿ç”¨

äº‹ä»¶æ€»çº¿æ”¯æŒåœ¨ `WinForm/WPF` ä¸­å®Œæ•´çš„ä½¿ç”¨ã€‚

- å‘é€äº‹ä»¶

```cs showLineNumbers {3}
private async void button1_Click(object sender, EventArgs e)
{
    await _eventPublisher.PublishAsync("update.textbox", textBox1); // å¯å°† TextBox æ§ä»¶ä½œä¸º Payload ä¼ é€’
}
```

- è®¢é˜…äº‹ä»¶å¹¶æ›´æ–° `UI`

```cs showLineNumbers {7,10,16}
public class UIEventSubscriber : IEventSubscriber
{
    [EventSubscribe("update.textbox")]
    public async Task UpdateTextBox(EventHandlerExecutingContext context)
    {
        // å°† Palload è½¬ TextBox
        var textbox = context.Source.Payload as TextBox;

        // å¤šçº¿ç¨‹æ›´æ–° UI ç»„ä»¶ï¼ˆWinForm)
        textbox?.BeginInvoke(() =>
        {
            text.Text = "æˆ‘æ˜¯äº‹ä»¶æ€»çº¿æ›´æ–°çš„";
        });

        // å¤šçº¿ç¨‹æ›´æ–° UI ç»„ä»¶ï¼ˆWPFï¼‰
        textbox?.Dispatcher?.BeginInvoke(() =>
        {
            text.Content = " æˆ‘æ˜¯äº‹ä»¶æ€»çº¿æ›´æ–°çš„";
        });

        await Task.CompletedTask;
    }
}
```

## 22.19 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::
