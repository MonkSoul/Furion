---
id: dependency-injection
title: 12. ä¾èµ–æ³¨å…¥/æ§åˆ¶åè½¬
sidebar_label: 12. ä¾èµ–æ³¨å…¥/æ§åˆ¶åè½¬
---

import useBaseUrl from "@docusaurus/useBaseUrl";

import Tag from "@site/src/components/Tag.js";

<details>
  <summary>ğŸ“ æ¨¡å—æ›´æ–°æ—¥å¿—</summary>
  <div>
<div>

- **æ–°ç‰¹æ€§**

  - &nbsp;<Tag>æ–°å¢</Tag> **`WinForm/WPF` æ”¯æŒä¾èµ–æ³¨å…¥çš„ `Native.CreateInstance<T>()` é™æ€æ–¹æ³•** <sup>4.8.7.23</sup> <sup>â±ï¸2023.03.27</sup> [53d51c3](https://gitee.com/dotnetchina/Furion/commit/53d51c3645f4066f5d68d4726d78e389fd544560)

- **é—®é¢˜ä¿®å¤**

  - &nbsp;<Tag>ä¿®å¤</Tag> å›  [9d8cb82](https://gitee.com/dotnetchina/Furion/commit/9d8cb82e4ce983839cf13c3c74640b08f258c325) ä»£ç æäº¤å¯¼è‡´å‘½åæœåŠ¡è§£æå¼‚å¸¸é—®é¢˜ <sup>4.8.8.21</sup> <sup>â±ï¸2023.05.18</sup> [#I76JZR](https://gitee.com/dotnetchina/Furion/issues/I76JZR)
  - &nbsp;<Tag>ä¿®å¤</Tag> å›  [9d8cb82](https://gitee.com/dotnetchina/Furion/commit/9d8cb82e4ce983839cf13c3c74640b08f258c325) ä»£ç æäº¤å¯¼è‡´æœåŠ¡ `AOP` å¼‚å¸¸æ‹¦æˆªé—®é¢˜ <sup>4.8.8.17</sup> <sup>â±ï¸2023.05.15</sup> [#I73A8E](https://gitee.com/dotnetchina/Furion/issues/I73A8E)

</div>
  </div>
</details>

## 12.1 ä¾èµ–æ³¨å…¥

æ‰€è°“ä¾èµ–æ³¨å…¥ï¼Œæ˜¯æŒ‡ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœéœ€è¦è°ƒç”¨å¦ä¸€ä¸ªå¯¹è±¡ååŠ©æ—¶ï¼Œæ— é¡»åœ¨ä»£ç ä¸­åˆ›å»ºè¢«è°ƒç”¨è€…ï¼Œè€Œæ˜¯ä¾èµ–äºå¤–éƒ¨çš„æ³¨å…¥ã€‚

é€šä¿—æ¥è®²ï¼Œå°±æ˜¯æŠŠæœ‰ä¾èµ–å…³ç³»çš„ç±»æ”¾åˆ°å®¹å™¨ä¸­ï¼Œç„¶ååœ¨æˆ‘ä»¬éœ€è¦è¿™äº›ç±»æ—¶ï¼Œå®¹å™¨è‡ªåŠ¨è§£æå‡ºè¿™äº›ç±»çš„å®ä¾‹ã€‚

ä¾èµ–æ³¨å…¥æœ€å¤§çš„å¥½å¤„æ˜¯å®ç°ç±»çš„è§£è€¦ï¼Œåˆ©äºç¨‹åºæ‹“å±•ã€å•å…ƒæµ‹è¯•ã€è‡ªåŠ¨åŒ–æ¨¡æ‹Ÿæµ‹è¯•ç­‰ã€‚

ä¾èµ–æ³¨å…¥çš„è‹±æ–‡ä¸ºï¼š`Dependency Injection`ï¼Œç®€ç§° `DI`

## 12.2 æ§åˆ¶åè½¬

æ§åˆ¶åè½¬åªæ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯å°†åˆ›å»ºå¯¹è±¡å®ä¾‹çš„æ§åˆ¶æƒï¼ˆåŸæœ¬æ˜¯ç¨‹åºå‘˜ï¼‰ä»ä»£ç æ§åˆ¶æƒå‰¥ç¦»åˆ° `IOC å®¹å™¨` ä¸­æ§åˆ¶ã€‚

æ§åˆ¶åè½¬çš„è‹±æ–‡ä¸ºï¼š`Inversion of Control`ï¼Œç®€ç§° `IOC`

## 12.3 `IOC/DI` ä¼˜ç¼ºç‚¹

ä¼ ç»Ÿçš„ä»£ç ï¼Œæ¯ä¸ªå¯¹è±¡è´Ÿè´£ç®¡ç†ä¸è‡ªå·±éœ€è¦ä¾èµ–çš„å¯¹è±¡ï¼Œå¯¼è‡´å¦‚æœéœ€è¦åˆ‡æ¢ä¾èµ–å¯¹è±¡çš„å®ç°ç±»æ—¶ï¼Œéœ€è¦ä¿®æ”¹å¤šå¤„åœ°æ–¹ã€‚åŒæ—¶ï¼Œè¿‡åº¦è€¦åˆä¹Ÿä½¿å¾—å¯¹è±¡éš¾ä»¥è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚

- ä¼˜ç‚¹

  - ä¾èµ–æ³¨å…¥æŠŠå¯¹è±¡çš„åˆ›å»ºäº¤ç»™å¤–éƒ¨å»ç®¡ç†,å¾ˆå¥½çš„è§£å†³äº†ä»£ç ç´§è€¦åˆï¼ˆtight coupleï¼‰çš„é—®é¢˜ï¼Œæ˜¯ä¸€ç§è®©ä»£ç å®ç°æ¾è€¦åˆï¼ˆloose coupleï¼‰çš„æœºåˆ¶
  - æ¾è€¦åˆè®©ä»£ç æ›´å…·çµæ´»æ€§ï¼Œèƒ½æ›´å¥½åœ°åº”å¯¹éœ€æ±‚å˜åŠ¨ï¼Œä»¥åŠæ–¹ä¾¿å•å…ƒæµ‹è¯•

- ç¼ºç‚¹

  - ç›®å‰ä¸»æµçš„ `IOC/DI` åŸºæœ¬é‡‡ç”¨åå°„çš„æ–¹å¼æ¥å®ç°ä¾èµ–æ³¨å…¥ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¼šå½±å“æ€§èƒ½

:::important ç‰¹åˆ«è¯´æ˜

åœ¨æœ¬ç« èŠ‚ä¸æ‰“ç®—ç»†è®² `ä¾èµ–æ³¨å…¥/æ§åˆ¶åè½¬` å…·ä½“å®ç°å’Œåº”ç”¨åœºæ™¯ï¼Œæƒ³äº†è§£æ›´å¤šçŸ¥è¯†ï¼Œå¯æŸ¥é˜… ã€[ASP.NET Core ä¾èµ–æ³¨å…¥](https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-5.0)ã€‘ å®˜æ–¹æ–‡æ¡£ã€‚

:::

## 12.4 ä¾èµ–æ³¨å…¥çš„ä¸‰ç§æ–¹å¼

### 12.4.1 æ„é€ æ–¹æ³•æ³¨å…¥

ç›®å‰æ„é€ æ–¹æ³•æ³¨å…¥æ˜¯ä¾èµ–æ³¨å…¥æ¨èä½¿ç”¨æ–¹å¼ã€‚

- ä¼˜ç‚¹

  - åœ¨æ„é€ æ–¹æ³•ä¸­ä½“ç°å‡ºå¯¹å…¶ä»–ç±»çš„ä¾èµ–ï¼Œä¸€çœ¼å°±èƒ½çœ‹å‡ºè¿™ä¸ªç±»éœ€è¦ä¾èµ–å“ªäº›ç±»æ‰èƒ½å·¥ä½œ
  - è„±ç¦»äº† IOC æ¡†æ¶ï¼Œè¿™ä¸ªç±»ä»ç„¶å¯ä»¥å·¥ä½œ
  - ä¸€æ—¦å¯¹è±¡åˆå§‹åŒ–æˆåŠŸäº†ï¼Œè¿™ä¸ªå¯¹è±¡çš„çŠ¶æ€è‚¯å®šæ˜¯æ­£ç¡®çš„

- ç¼ºç‚¹

  - æ„é€ å‡½æ•°ä¼šæœ‰å¾ˆå¤šå‚æ•°
  - æœ‰äº›ç±»æ˜¯éœ€è¦é»˜è®¤æ„é€ å‡½æ•°çš„ï¼Œæ¯”å¦‚ MVC æ¡†æ¶çš„ Controller ç±»ï¼Œä¸€æ—¦ä½¿ç”¨æ„é€ å‡½æ•°æ³¨å…¥ï¼Œå°±æ— æ³•ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°
  - è¿™ä¸ªç±»é‡Œé¢çš„æœ‰äº›æ–¹æ³•å¹¶ä¸éœ€è¦ç”¨åˆ°è¿™äº›ä¾èµ–

ä»£ç ç¤ºä¾‹ï¼š

```cs showLineNumbers  {4}
public class FurionService
{
    private readonly IRepository _repository;
    public FurionService(IRepository repository)
    {
        _repository = repository;
    }
}
```

### 12.4.2 å±æ€§æ–¹å¼æ³¨å…¥

:::warning ç‰¹åˆ«å£°æ˜

åœ¨ `Furion` æ–°ç‰ˆæœ¬ä¸­ï¼Œå·²ç»ç§»é™¤å±æ€§æ³¨å…¥åŠŸèƒ½ï¼Œå»ºè®®ä½¿ç”¨æ„é€ å‡½æ•°æˆ–æ–¹æ³•æ–¹å¼æ³¨å…¥ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ `App.GetService<TService>` æ–¹å¼æ³¨å…¥ã€‚

:::

**é€šè¿‡å±æ€§æ–¹å¼æ³¨å…¥å®¹æ˜“å’Œç±»çš„å®ä¾‹å±æ€§æ··æ·†ï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚**

- ä¼˜ç‚¹

  - åœ¨å¯¹è±¡çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…ï¼Œå¯ä»¥éšæ—¶åŠ¨æ€çš„æ”¹å˜ä¾èµ–
  - éå¸¸çµæ´»

- ç¼ºç‚¹

  - å¯¹è±¡åœ¨åˆ›å»ºåï¼Œè¢«è®¾ç½®ä¾èµ–å¯¹è±¡ä¹‹å‰è¿™æ®µæ—¶é—´çŠ¶æ€æ˜¯ä¸å¯¹çš„
  - ä¸ç›´è§‚ï¼Œæ— æ³•æ¸…æ™°åœ°è¡¨ç¤ºå“ªäº›å±æ€§æ˜¯å¿…é¡»çš„

```cs showLineNumbers  {3}
public class FurionService
{
    public IRepository Repository { get; set; }
}
```

### 12.4.3 æ–¹æ³•å‚æ•°æ³¨å…¥

æ–¹æ³•å‚æ•°æ³¨å…¥çš„æ„æ€æ˜¯åœ¨åˆ›å»ºå¯¹è±¡åï¼Œé€šè¿‡è‡ªåŠ¨è°ƒç”¨æŸä¸ªæ–¹æ³•æ¥æ³¨å…¥ä¾èµ–ã€‚

- ä¼˜ç‚¹ï¼š

  - æ¯”è¾ƒçµæ´»

- ç¼ºç‚¹ï¼š

  - æ–°åŠ å…¥ä¾èµ–æ—¶ä¼šç ´ååŸæœ‰çš„æ–¹æ³•ç­¾åï¼Œå¦‚æœè¿™ä¸ªæ–¹æ³•å·²ç»è¢«å…¶ä»–å¾ˆå¤šæ¨¡å—ç”¨åˆ°å°±å¾ˆéº»çƒ¦
  - ä¸æ„é€ æ–¹æ³•æ³¨å…¥ä¸€æ ·ï¼Œä¼šæœ‰å¾ˆå¤šå‚æ•°

```cs showLineNumbers  {3}
public class FurionService
{
    public Person GetById([FromServices]IRepository repository, int id)
    {
        return repository.Find(id);
    }
}
```

## 12.5 æ³¨å†Œå¯¹è±¡ç”Ÿå­˜æœŸ

### 12.5.1 `æš‚æ—¶/ç¬æ—¶` ç”Ÿå­˜æœŸ

æš‚æ—¶ç”Ÿå­˜æœŸæœåŠ¡æ˜¯æ¯æ¬¡ä»æœåŠ¡å®¹å™¨è¿›è¡Œè¯·æ±‚æ—¶åˆ›å»ºçš„ã€‚ è¿™ç§ç”Ÿå­˜æœŸé€‚åˆè½»é‡çº§ã€ æ— çŠ¶æ€çš„æœåŠ¡ã€‚

åœ¨å¤„ç†è¯·æ±‚çš„åº”ç”¨ä¸­ï¼Œåœ¨è¯·æ±‚ç»“æŸæ—¶ä¼šé‡Šæ”¾æš‚æ—¶æœåŠ¡ã€‚

é€šå¸¸æˆ‘ä»¬ä½¿ç”¨ `ITransient` æ¥å£ä¾èµ–è¡¨ç¤ºè¯¥ç”Ÿå‘½å‘¨æœŸã€‚

### 12.5.2 `ä½œç”¨åŸŸ` ç”Ÿå­˜æœŸ

ä½œç”¨åŸŸç”Ÿå­˜æœŸæœåŠ¡é’ˆå¯¹æ¯ä¸ªå®¢æˆ·ç«¯è¯·æ±‚ï¼ˆè¿æ¥ï¼‰åˆ›å»ºä¸€æ¬¡ã€‚åœ¨å¤„ç†è¯·æ±‚çš„åº”ç”¨ä¸­ï¼Œåœ¨è¯·æ±‚ç»“æŸæ—¶ä¼šé‡Šæ”¾æœ‰ä½œç”¨åŸŸçš„æœåŠ¡ã€‚

é€šå¸¸æˆ‘ä»¬ä½¿ç”¨ `IScoped` æ¥å£ä¾èµ–è¡¨ç¤ºè¯¥ç”Ÿå‘½å‘¨æœŸã€‚

### 12.5.3 `å•ä¾‹` ç”Ÿå­˜æœŸ

åœ¨é¦–æ¬¡è¯·æ±‚å®ƒä»¬æ—¶è¿›è¡Œåˆ›å»ºï¼Œä¹‹åæ¯ä¸ªåç»­è¯·æ±‚éƒ½ä½¿ç”¨ç›¸åŒçš„å®ä¾‹ã€‚

é€šå¸¸æˆ‘ä»¬ä½¿ç”¨ `ISingleton` æ¥å£ä¾èµ–è¡¨ç¤ºè¯¥ç”Ÿå‘½å‘¨æœŸã€‚

:::note äº†è§£æ›´å¤š

æƒ³äº†è§£æ›´å¤š `æœåŠ¡ç”Ÿå­˜æœŸ` çŸ¥è¯†å¯æŸ¥é˜… [ASP.NET Core - ä¾èµ–æ³¨å…¥ - æœåŠ¡ç”Ÿå­˜æœŸ](https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-5.0#service-lifetimes) ç« èŠ‚ã€‚

:::

## 12.6 å†…ç½®ä¾èµ–æ¥å£

`Furion` æ¡†æ¶æä¾›ä¸‰ä¸ªæ¥å£ä¾èµ–åˆ†åˆ«å¯¹åº”ä¸åŒçš„æœåŠ¡ç”Ÿå­˜æœŸï¼š

- `ITransient`ï¼šå¯¹åº”æš‚æ—¶/ç¬æ—¶ä½œç”¨åŸŸæœåŠ¡ç”Ÿå­˜æœŸ
- `IScoped`ï¼šå¯¹åº”è¯·æ±‚ä½œç”¨åŸŸæœåŠ¡ç”Ÿå­˜æœŸ
- `ISingleton`ï¼šå¯¹åº”å•ä¾‹ä½œç”¨åŸŸæœåŠ¡ç”Ÿå­˜æœŸ

:::warning ç‰¹åˆ«æ³¨æ„

ä»¥ä¸Šä¸‰ä¸ªæ¥å£åªèƒ½å®ä¾‹ç±»å®ç°ï¼Œå…¶ä»–é™æ€ç±»ã€æŠ½è±¡ç±»ã€åŠæ¥å£ä¸èƒ½å®ç°ã€‚

:::

## 12.7 å¸¸è§ä½¿ç”¨

### 12.7.1 ç¬¬ä¸€ä¸ªä¾‹å­

åˆ›å»º `IBusinessService` æ¥å£å’Œ `BusinessService` å®ç°ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š

```cs showLineNumbers  {7,12}
using Furion.Core;
using Furion.DatabaseAccessor;
using Furion.DependencyInjection;

namespace Furion.Application
{
    public interface IBusinessService
    {
        Person Get(int id);
    }

    public class BusinessService : IBusinessService, ITransient
    {
        private readonly IRepository<Person> _personRepository;

        public BusinessService(IRepository<Person> personRepository)
        {
            _personRepository = personRepository;
        }

        public Person Get(int id)
        {
            return _personRepository.Find(id);
        }
    }
}
```

åˆ›å»º `PersonController` æ§åˆ¶å™¨ï¼Œä»£ç å¦‚ä¸‹ï¼š

```cs showLineNumbers  {11,19}
using Furion.Application;
using Microsoft.AspNetCore.Mvc;

namespace Furion.Web.Entry.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class PersonController : ControllerBase
    {
        private readonly IBusinessService _businessService;
        public PersonController(IBusinessService businessService)
        {
            _businessService = businessService;
        }

        [HttpGet]
        public IActionResult Get(int id)
        {
            var person = _businessService.Get(id);
            return new JsonResult(person);
        }
    }
}
```

<img src={useBaseUrl("img/di1.gif")} />

---

**ä¾‹å­è§£è¯´**

`Furion` æ¡†æ¶æä¾›äº†éå¸¸çµæ´»ä¸”æ–¹ä¾¿çš„å®ç°ä¾èµ–æ³¨å…¥çš„æ–¹å¼ï¼Œåªéœ€è¦å®ä¾‹ç±»ç»§æ‰¿å¯¹åº”ç”Ÿå­˜æœŸçš„æ¥å£å³å¯ï¼Œè¿™é‡Œç»§æ‰¿äº† `ITransient`ï¼Œä¹Ÿå°±è¡¨æ˜äº†è¿™æ˜¯ä¸€ä¸ª `æš‚æ—¶/ç¬æ—¶` ä½œç”¨åŸŸå®ä¾‹ç±»ã€‚è¯¥ç±»å°±å¯ä»¥ä½œä¸ºè¢«æ³¨å…¥å¯¹è±¡ï¼ŒåŒæ—¶ä¹Ÿèƒ½æ³¨å…¥å…¶ä»–æ¥å£å¯¹è±¡ã€‚

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ`BusinessService` æ³¨å…¥äº† `IRepository<Person>` ä»“å‚¨æ¥å£ï¼ŒåŒæ—¶ `PersonController` æ§åˆ¶å™¨æ³¨å…¥äº† `IBusinessService` æ¥å£ã€‚

è¿™æ · `PersonController` å’Œ `BusinessService` ä¹‹é—´å°±å®ç°äº†è§£è€¦ï¼Œä¸å†ä¾èµ–äºå…·ä½“çš„ `BusinessService` å®ä¾‹ã€‚

è¿™å°±æ˜¯ä¾èµ–æ³¨å…¥/æ§åˆ¶åè½¬æœ€ç»å…¸çš„ä¾‹å­ã€‚

### 12.7.2 æ³¨å†Œæ³›å‹å®ä¾‹

åˆ›å»º `IBusinessService<T>` æ¥å£å’Œ `BusinessService<T>` å®ç°ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š

```cs showLineNumbers  {7,12}
using Furion.Core;
using Furion.DatabaseAccessor;
using Furion.DependencyInjection;

namespace Furion.Application
{
    public interface IBusinessService<T>
    {
        Person Get(int id);
    }

    public class BusinessService<T> : IBusinessService<T>, ITransient
    {
        private readonly IRepository<Person> _personRepository;

        public BusinessService(IRepository<Person> personRepository)
        {
            _personRepository = personRepository;
        }

        public Person Get(int id)
        {
            return _personRepository.Find(id);
        }
    }
}
```

åˆ›å»º `PersonController` æ§åˆ¶å™¨ï¼Œä»£ç å¦‚ä¸‹ï¼š

```cs showLineNumbers  {11,19}
using Furion.Application;
using Microsoft.AspNetCore.Mvc;

namespace Furion.Web.Entry.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class PersonController : ControllerBase
    {
        private readonly IBusinessService<int> _businessService;
        public PersonController(IBusinessService<int> businessService)
        {
            _businessService = businessService;
        }

        [HttpGet]
        public IActionResult Get(int id)
        {
            var person = _businessService.Get(id);
            return new JsonResult(person);
        }
    }
}
```

### 12.7.3 ä¸€ä¸ªæ¥å£å¤šä¸ªå®ç°

é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ¥å£åªå¯¹åº”ä¸€ä¸ªå®ç°ç±»ï¼Œä½†æœ‰äº›ç‰¹æ®Šæƒ…å†µï¼Œéœ€è¦å¤šä¸ªå®ç°ç±»æ³¨å†ŒåŒä¸€ä¸ªæ¥å£ï¼Œå¦‚ `DbContext` å¤šæ•°æ®åº“æƒ…å†µã€‚

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¾èµ–æ³¨å…¥ `Func<string, IPrivateDependency, object>` å§”æ‰˜æ¥è§£æå¤šä¸ªå®ä¾‹ï¼Œå…¶ä¸­å§”æ‰˜çš„å‚æ•°åˆ†åˆ«ä¸ºï¼š

- å‚æ•° 1ï¼š`string` ç±»å‹ï¼Œä¸åŒå®ç°ç±»å”¯ä¸€æ ‡è¯†ï¼Œé»˜è®¤ä¸º `nameof(å®ç°ç±»)` åç§°
- å‚æ•° 2ï¼š`Type` ç±»å‹ï¼Œ`IPrivateDependency` æ´¾ç”Ÿæ¥å£ï¼Œä¹Ÿå°±æ˜¯ `ITransient`ã€`IScoped`ã€`ISingleton`
- è¿”å›å€¼ï¼š`object` ç±»å‹ï¼Œè¿”å›å…·ä½“çš„å®ç°ç±»å®ä¾‹

åˆ›å»º `IBusinessService` æ¥å£å’Œ `BusinessService`ã€`OtherBusinessService` ä¸¤ä¸ªå®ç°ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š

```cs showLineNumbers  {5,10,18}
using Furion.DependencyInjection;

namespace Furion.Application
{
    public interface IBusinessService
    {
        string GetName();
    }

    public class BusinessService : IBusinessService, ITransient
    {
        public string GetName()
        {
            return "æˆ‘æ˜¯ï¼š" + nameof(BusinessService);
        }
    }

    public class OtherBusinessService : IBusinessService, ITransient
    {
        public string GetName()
        {
            return "æˆ‘æ˜¯ï¼š" + nameof(OtherBusinessService);
        }
    }
}
```

:::tip æ–°ç‰ˆæœ¬ï¼Œæ¨èä½¿ç”¨

åœ¨ `Furion 3.8.6+` ç‰ˆæœ¬ä¹‹åæ–°å¢äº† `INamedServiceProvider` æœåŠ¡æ¥å£ï¼Œå¯æ›¿ä»£ `Func<string, ILifetime, object>` æ–¹å¼ï¼š

```cs showLineNumbers {8,15-17,19-23}
using Furion.Application.Services;

namespace Furion.Application;

public class TestNamedServices : IDynamicApiController
{
    private readonly INamedServiceProvider<IBusinessService> _namedServiceProvider;
    public TestNamedServices(INamedServiceProvider<IBusinessService> namedServiceProvider)
    {
        _namedServiceProvider = namedServiceProvider;
    }

    public string GetName()
    {
        // ç¬¬ä¸€ç§ç”¨æ³•ï¼Œé€šè¿‡åå°„è§£ææœåŠ¡å‘¨æœŸï¼Œæ€§èƒ½æœ‰æŸè€—
        var service1 = _namedServiceProvider.GetService(nameof(BusinessService));
        var service2 = _namedServiceProvider.GetService(nameof(OtherBusinessService));

        // ç¬¬äºŒç§ç”¨æ³•ï¼Œæ— éœ€åå°„ï¼Œæ³¨æ„ä¸‹é¢çš„æ³›å‹å‚æ•°ä¼ å…¥çš„æ˜¯ç”Ÿå‘½å‘¨æœŸä¾èµ–æ¥å£ï¼ŒITransient, IScoped, ISingleton
        var service3 = _namedServiceProvider.GetService<ITransient>(nameof(BusinessService));
        var service4 = _namedServiceProvider.GetService<ITransient>(nameof(OtherBusinessService));

        return service1.GetName() + "-" + service2.GetName() + "-" + service3.GetName() + "-" + service4.GetName();
    }
}
```

:::

:::important ä¸å†æ¨è `Func<string, TLifetime, object>` æ–¹å¼

```cs showLineNumbers  {15,17,18}
using Furion.Application;
using Furion.DependencyInjection;
using Microsoft.AspNetCore.Mvc;
using System;

namespace Furion.Web.Entry.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class ValueController : ControllerBase
    {
        private readonly IBusinessService _businessService;
        private readonly IBusinessService _otherBusinessService;

        public ValueController(Func<string, ITransient, object> resolveNamed)
        {
            _businessService = resolveNamed("BusinessService", default) as IBusinessService;
            _otherBusinessService = resolveNamed("OtherBusinessService", default) as IBusinessService;
        }

        [HttpGet]
        public string GetName()
        {
            return _businessService.GetName() + "----------" + _otherBusinessService.GetName();
        }
    }
}
```

:::

<img src={useBaseUrl("img/di2.gif")} />

:::tip å°çŸ¥è¯†

å¦‚æœéœ€è¦è‡ªå®šä¹‰è§£æåç§°ï¼Œåªéœ€è¦è´´ `[Injection(Named = "åç§°")]` å³å¯ï¼Œå¦‚ï¼š

```cs showLineNumbers  {5,11}
using Furion.DependencyInjection;

namespace Furion.Application
{
    [Injection(Named = "BusName1")]
    public class BusinessService : IBusinessService, ITransient
    {
        // ...
    }

    [Injection(Named = "BusName2")]
    public class OtherBusinessService : IBusinessService, ITransient
    {
        // ...
    }
}
```

è§£ææœåŠ¡ï¼š

```cs showLineNumbers
_businessService = resolveNamed("BusName1", default) as IBusinessService;
_otherBusinessService = resolveNamed("BusName2", default) as IBusinessService;
```

:::

### 12.7.4 æ— æ¥å£æ–¹å¼

æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬ä¸æƒ³å®šä¹‰æ¥å£ï¼Œè€Œæ˜¯æƒ³æŠŠå®ä¾‹ç±»ä½œä¸ºå¯ä¾èµ–æ³¨å…¥çš„å¯¹è±¡ï¼Œå¦‚ MVC ä¸­çš„æ§åˆ¶å™¨ã€‚

åˆ›å»º `SelfService` å®ä¾‹ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š

```cs showLineNumbers  {7,11}
using Furion.Core;
using Furion.DatabaseAccessor;
using Furion.DependencyInjection;

namespace Furion.Application
{
    public class SelfService : ITransient
    {
        private readonly IRepository<Person> _personRepository;

        public SelfService(IRepository<Person> personRepository)
        {
            _personRepository = personRepository;
        }

        public Person Get(int id)
        {
            return _personRepository.Find(id);
        }
    }
}
```

åˆ›å»º `ValueController` æ§åˆ¶å™¨ï¼Œä»£ç å¦‚ä¸‹ï¼š

```cs showLineNumbers  {13,21}
using Furion.Application;
using Furion.Core;
using Microsoft.AspNetCore.Mvc;

namespace Furion.Web.Entry.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class ValueController : ControllerBase
    {
        private readonly SelfService _selfService;

        public ValueController(SelfService selfService)
        {
            _selfService = selfService;
        }

        [HttpGet]
        public Person Get(int id)
        {
            return _selfService.Get(id);
        }
    }
}
```

## 12.8 `[Injection]` ç‰¹æ€§é…ç½®

`Furion` æ¡†æ¶æä¾› `[Injection]` ç‰¹æ€§å¯ä»¥æ”¹å˜æ³¨å†Œæ–¹å¼ï¼ŒåŒæ—¶è¿˜èƒ½é…ç½® `AOP` æ‹¦æˆªã€‚

`[Injection]` æä¾›ä»¥ä¸‹é…ç½®æ”¯æŒï¼š

- `Action`ï¼šé…ç½®æ³¨å†Œè¡Œä¸ºï¼Œ`InjectionActions` ç±»å‹ï¼Œå¯é€‰å€¼ï¼š
  - `Add`ï¼š**é»˜è®¤å€¼**ï¼Œè¡¨ç¤ºæ— é™åˆ¶æ·»åŠ æ³¨å†ŒæœåŠ¡ï¼Œè¯¥æ–¹å¼æ”¯æŒä¸€ä¸ªæ¥å£å¤šä¸ªå®ç°
  - `TryAdd`ï¼šè¡¨ç¤ºæ³¨å†Œå·²å­˜åœ¨åˆ™è·³è¿‡æ³¨å†Œ
- `Pattern`ï¼šé…ç½®æ³¨å†Œé€‰é¡¹ï¼Œ`InjectionPatterns` ç±»å‹ï¼Œå¯é€‰å€¼ï¼š
  - `Self`ï¼šåªæ³¨å†Œè‡ªå·±
  - `FirstInterface`ï¼šåªæ³¨å†Œç¬¬ä¸€ä¸ªæ¥å£
  - `SelfWithFirstInterface`ï¼šæ³¨å†Œè‡ªå·±å’Œç¬¬ä¸€ä¸ªæ¥å£
  - `ImplementedInterfaces`ï¼šæ³¨å†Œæ‰€æœ‰æ¥å£
  - `All`ï¼šæ³¨å†Œè‡ªå·±åŒ…æ‹¬æ‰€æœ‰æ¥å£ ï¼Œ**é»˜è®¤å€¼**
- `Named`ï¼šé…ç½®å®ä¾‹åˆ«åï¼Œé€šè¿‡åˆ«åå¯ä»¥è§£ææ¥å£ï¼Œå¦‚åŒä¸€ä¸ªæ¥å£æœ‰å¤šä¸ªå®ç°ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡åˆ«åè§£æä¸åŒçš„å®ç°ï¼Œé»˜è®¤å€¼ä¸ºå®ç°ç±»çš„ç±»å
- `Order`ï¼šæ³¨å†Œæ’åºï¼Œæ•°å­—è¶Šå¤§ï¼Œåˆ™è¶Šåœ¨æœ€åæ³¨å†Œï¼Œé»˜è®¤ `0`
- `Proxy`ï¼šé…ç½®ä»£ç†æ‹¦æˆªç±»å‹ï¼Œä¹Ÿå°±æ˜¯ `AOP`ï¼Œ**ä»£ç†ç±»å‹å¿…é¡»ç»§æ‰¿ `AspectDispatchProxy` ç±»å’Œ `IDispatchProxy` æ¥å£**ï¼Œæ— é»˜è®¤å€¼
- `ExceptInterfaces`ï¼šé…ç½®å¿½ç•¥æ³¨å†Œçš„æ¥å£ï¼Œ`Type[]` ç±»å‹

## 12.9 è‡ªå®šä¹‰é«˜çº§æ³¨å†Œ

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`Furion` æä¾›çš„æ³¨å†Œæ–¹å¼å¯ä»¥æ»¡è¶³å¤§å¤šæ•°ä¾èµ–æ³¨å…¥çš„éœ€æ±‚ï¼Œå¦‚æœ‰ç‰¹åˆ«æ³¨å†Œéœ€æ±‚ï¼Œåªéœ€è¦åœ¨ `Startup` ä¸­é…ç½®å³å¯ï¼Œå¦‚ï¼š

```cs showLineNumbers
services.AddScoped(typeof(ISpecService), provider = > {
    // è‡ªå®šä¹‰ä»»ä½•åˆ›å»ºå®ä¾‹çš„æ–¹å¼
    var instance = new SpecService();  // æˆ–è€…å¯ä»¥é€šè¿‡ AOPæ’ä»¶è¿”å›ä»£ç†å®ä¾‹

    return instance;
});
```

:::note è¡¥å……è¯´æ˜

`Furion` æ¡†æ¶ä¸­çš„ `AppDbContext` æ•°æ®åº“ä¸Šä¸‹æ–‡è¿˜æœ‰ `ISqlDispatchProxy` éƒ½æ˜¯é€šè¿‡è¿™ç§æ–¹å¼åˆ›å»ºçš„ã€‚

:::

:::tip çŸ¥è¯†å¯¼èˆª

æƒ³äº†è§£æ›´å¤šè‡ªå®šä¹‰é«˜çº§ä¸­æ³¨å†Œï¼Œå¯æŸ¥é˜… ã€[ASP.NET Core ä¾èµ–æ³¨å…¥](https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-5.0)ã€‘ å®˜æ–¹æ–‡æ¡£ã€‚

:::

## 12.10 `appsettings.json` é…ç½®æ³¨å†Œ

é™¤äº†åœ¨ä»£ç ä¸­å®ç°ä¾èµ–æ³¨å…¥ï¼Œä¹Ÿå¯ä»¥å®ç°åŠ¨æ€ä¾èµ–æ³¨å…¥ï¼Œæ— éœ€ä¿®æ”¹ä»£ç æˆ–é‡æ–°ç¼–è¯‘å³å¯å®ç°çƒ­æ’æ‹”ï¼ˆæ’ä»¶ï¼‰æ•ˆæœã€‚é…ç½®å¦‚ä¸‹ï¼š

```json showLineNumbers  {2}
{
  "DependencyInjectionSettings": {
    "Definitions": [
      {
        "Interface": "Furion.Application;Furion.Application.ITestService",
        "Service": "Furion.Application;Furion.Application.TestService",
        "RegisterType": "Transient",
        "Action": "Add",
        "Pattern": "SelfWithFirstInterface",
        "Named": "TestService",
        "Order": 1,
        "Proxy": "Furion.Application;Furion.Application.LogDispathProxy"
      }
    ]
  }
}
```

é…ç½®è¯´æ˜ï¼š

- `DependencyInjectionSettings`ï¼šä¾èµ–æ³¨å…¥é…ç½®æ ¹èŠ‚ç‚¹
  - `Definitions`ï¼šåŠ¨æ€ä¾èµ–æ³¨å…¥é…ç½®èŠ‚ç‚¹ï¼Œ`ExternalService` æ•°ç»„ç±»å‹
    - `ExternalService`ï¼šé…ç½®å•ä¸ªä¾èµ–æ³¨å…¥ä¿¡æ¯
      - `Interface`ï¼šé…ç½®ä¾èµ–æ¥å£ä¿¡æ¯ï¼Œæ ¼å¼ï¼š`ç¨‹åºé›†åç§°;æ¥å£å®Œæ•´åç§°`ï¼Œå¦‚ï¼š`Furion.Application;Furion.Application.ITestService`
      - `Service`ï¼šé…ç½®æ¥å£å®ç°ä¿¡æ¯ï¼Œæ ¼å¼åŒä¸Š
      - `RegisterType`ï¼šé…ç½®ä¾èµ–æ³¨å…¥çš„å¯¹è±¡ç”Ÿå­˜æœŸï¼Œå–å€¼ï¼š`Transient`ï¼Œ`Scoped`ï¼Œ`Singleton`
      - `Action`ï¼šæ³¨å†Œè¡Œä¸ºï¼Œå¯é€‰å€¼ï¼š`Add`ï¼Œ`TryAdd`ï¼Œå‚è§ [#128-injection-ç‰¹æ€§é…ç½®](#128-injection-ç‰¹æ€§é…ç½®)
      - `Pattern`ï¼šæ³¨å†Œé€‰é¡¹ï¼Œå‚è§ [#128-injection-ç‰¹æ€§é…ç½®](#128-injection-ç‰¹æ€§é…ç½®)
      - `Named`ï¼šæ³¨å†Œåˆ«åï¼Œå‚è§ [#128-injection-ç‰¹æ€§é…ç½®](#128-injection-ç‰¹æ€§é…ç½®)
      - `Order`ï¼šæ³¨å†Œæ’åºï¼Œå‚è§ [#128-injection-ç‰¹æ€§é…ç½®](#128-injection-ç‰¹æ€§é…ç½®)
      - `Proxy`ï¼šé…ç½®ä»£ç†æ‹¦æˆªï¼Œæ ¼å¼ï¼š`ç¨‹åºé›†åç§°;ä»£ç†ç±»å®Œæ•´åç§°`ï¼Œå‚è§ [#128-injection-ç‰¹æ€§é…ç½®](#128-injection-ç‰¹æ€§é…ç½®)

:::important å…³äºå¤–éƒ¨ç¨‹åºé›†

å¦‚æœåŠ¨æ€æ³¨å…¥çš„å¯¹è±¡æ˜¯å¤–éƒ¨ç¨‹åºé›†ï¼Œé‚£ä¹ˆé¦–å…ˆå…ˆæ³¨å†Œå¤–éƒ¨ç¨‹åºé›†ï¼š

```json showLineNumbers
{
  "AppSettings": {
    "ExternalAssemblies": ["å¤–éƒ¨ç¨‹åºé›†åç§°", "Taobao.Pay"] // æ”¯æŒå¤šä¸ª
  }
}
```

:::

## 12.11 æ³¨å†Œé¡ºåºå’Œä¼˜å…ˆçº§

`Furion` æ¡†æ¶ä¸­ï¼Œé»˜è®¤æ³¨å†Œé¡ºåºæ˜¯æŒ‰ç…§ç¨‹åºé›†æ‰«æé¡ºåºè¿›è¡Œæ³¨å†Œï¼Œå¦‚æœéœ€è¦æ”¹å˜æ³¨å†Œé¡ºåºï¼Œå¯é€šè¿‡ `[Injection(Order)]` ç‰¹æ€§æŒ‡å®šï¼Œ`Order` å€¼è¶Šå¤§ï¼Œåˆ™è¶Šåœ¨æœ€åæ³¨å†Œã€‚

å¦å¤– `appsettings.json` é…ç½®çš„ä¼˜å…ˆçº§æœ€å¤§ï¼Œ`appsettings.json` é…ç½®çš„æ³¨å†Œä¼šè¦†ç›–ä¹‹å‰æ‰€æœ‰æ³¨å†Œã€‚

## 12.12 `Aop` æ³¨å†Œæ‹¦æˆª

:::warning å…³äºåŠ¨æ€ API å’ŒæœåŠ¡çš„åŒºåˆ«

å¦‚æœæ‚¨çš„æœåŠ¡æ˜¯åŠ¨æ€ APIï¼Œé‚£ä¹ˆè¯·ä½¿ç”¨ [åŠ¨æ€ API - AOP æ‹¦æˆª](/docs/dynamic-api-controller#511-å…³äº-aop-æ‹¦æˆª)ï¼ŒåŸå› æ˜¯åŠ¨æ€ API æœ¬è´¨æ˜¯æ§åˆ¶å™¨ï¼Œæ‰€ä»¥é‡‡ç”¨ `Filter` æ–¹å¼ã€‚

:::

`AOP` æ˜¯éå¸¸é‡è¦çš„æ€æƒ³å’ŒæŠ€æœ¯ï¼Œä¹Ÿå°±æ˜¯ `é¢å‘åˆ‡é¢` ç¼–ç¨‹ï¼Œå¯ä»¥è®©æˆ‘ä»¬åœ¨ä¸æ”¹åŠ¨åŸæ¥ä»£ç çš„æƒ…å†µä¸‹è¿›è¡ŒåŠ¨æ€ç¯¡æ”¹ä¸šåŠ¡ä»£ç ã€‚

åœ¨ `Furion` æ¡†æ¶ä¸­ï¼Œå®ç° `Aop` éå¸¸ç®€å•ï¼Œå¦‚ï¼š

å‡è®¾æˆ‘ä»¬æœ‰ `ITestService` å’Œ `TestService` ä¸¤ä¸ªç±»å‹ï¼š

```cs showLineNumbers
public interface ITestService
{
    string SayHello(string word);
}
```

```cs showLineNumbers
public class TestService: ITestService, ITransient
{
    public string SayHello(string word)
    {
        return $"Hello {word}";
    }
}
```

ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªéœ€æ±‚ï¼Œæˆ‘ä»¬å¸Œæœ›è°ƒç”¨ `SayHello` çš„æ—¶å€™å¯ä»¥è®°å½•æ—¥å¿—å’Œæƒé™æ§åˆ¶ï¼ˆä¹‹å‰æ²¡æœ‰è€ƒè™‘åˆ°çš„éœ€æ±‚ï¼‰ã€‚

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€ä¸ªä»£ç†ç±»å³å¯ï¼Œå¦‚ `LogDispatchProxy`

```cs showLineNumbers  {1,3,7,25,37,48}
using Furion.DependencyInjection;
using System;
using System.Reflection;

namespace Furion.Application
{
    public class LogDispatchProxy : AspectDispatchProxy, IDispatchProxy
    {
        /// <summary>
        /// å½“å‰æœåŠ¡å®ä¾‹
        /// </summary>
        public object Target { get; set; }

        /// <summary>
        /// æœåŠ¡æä¾›å™¨ï¼Œå¯ä»¥ç”¨æ¥è§£ææœåŠ¡ï¼Œå¦‚ï¼šServices.GetService()
        /// </summary>
        public IServiceProvider Services { get; set; }

        /// <summary>
        /// æ‹¦æˆªæ–¹æ³•
        /// </summary>
        /// <param name="method"></param>
        /// <param name="args"></param>
        /// <returns></returns>
        public override object Invoke(MethodInfo method, object[] args)
        {
            Console.WriteLine("SayHello æ–¹æ³•è¢«è°ƒç”¨äº†");

            var result = method.Invoke(Target, args);

            Console.WriteLine("SayHello æ–¹æ³•è¿”å›å€¼ï¼š" + result);

            return result;
        }

        // å¼‚æ­¥æ— è¿”å›å€¼
        public async override Task InvokeAsync(MethodInfo method, object[] args)
        {
            Console.WriteLine("SayHello æ–¹æ³•è¢«è°ƒç”¨äº†");

            var task = method.Invoke(Target, args) as Task;
            await task;

             Console.WriteLine("SayHello æ–¹æ³•è°ƒç”¨å®Œæˆ");
        }

        // å¼‚æ­¥å¸¦è¿”å›å€¼
        public async override Task<T> InvokeAsyncT<T>(MethodInfo method, object[] args)
        {
            Console.WriteLine("SayHello æ–¹æ³•è¢«è°ƒç”¨äº†");

            var taskT = method.Invoke(Target, args) as Task<T>;
            var result = await taskT;

            Console.WriteLine("SayHello æ–¹æ³•è¿”å›å€¼ï¼š" + result);

            return result;
        }
    }
}
```

:::important è·å–ç‰¹æ€§

å¦‚æœéœ€è¦è·å–æ–¹æ³•çš„ç‰¹æ€§ï¼Œåªéœ€è¦é€šè¿‡ `method.GetActualCustomAttribute<TArrbute>()` å³å¯ã€‚æ‰€æœ‰è·å–çœŸå®çš„ç‰¹æ€§ç»Ÿä¸€é‡‡ç”¨ `method.GetActual....()` æ–¹æ³•å¼€å¤´ã€‚

:::

ä¹‹åæˆ‘ä»¬åªéœ€è¦ä¸º `TestService` å¢åŠ  `[Injection]` ç‰¹æ€§å³å¯ï¼Œå¦‚ï¼š

```cs showLineNumbers  {1}
[Injection(Proxy = typeof(LogDispatchProxy))]
public class TestService: ITestService, ITransient
{
    public string SayHello(string word)
    {
        return $"Hello {word}";
    }
}
```

ä¹‹å `SayHello` æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™å°±å¯ä»¥å®ç°åŠ¨æ€æ‹¦æˆªäº†ï¼Œæ¯”å¦‚è¿™é‡Œå†™æ—¥å¿—ã€‚

### 12.12.1 `å…¨å±€Aopæ‹¦æˆª`

`Furion` æ¡†æ¶ä¹Ÿæä¾›äº†å…¨å±€æ‹¦æˆªçš„æ–¹å¼ï¼Œåªéœ€è¦å°† `IDispatchProxy` ä¿®æ”¹ä¸º `IGlobalDispatchProxy` å³å¯ã€‚

```cs showLineNumbers
using Furion;
using System.Reflection;

namespace Furion.Application
{
    public class LogDispatchProxy : AspectDispatchProxy, IGlobalDispatchProxy
    {
        // ....
    }
}
```

è¿™æ ·å°±ä¼šæ‹¦æˆªæ‰€æœ‰çš„ `Service`ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡ç»™ç‰¹å®šç±»è´´ `[SuppressProxy]` è·³è¿‡å…¨å±€æ‹¦æˆªæ“ä½œã€‚

:::important æ‹¦æˆªä¼˜å…ˆçº§

`[SuppressProxy]` > `[Injection(Proxy = typeof(LogDispatchProxy))]` > `å…¨å±€æ‹¦æˆª`ã€‚

:::

### 12.12.2 `AOP` æ³¨å…¥è§£ææœåŠ¡

`Furion` æ¡†æ¶æœªæä¾› `Proxy` æ„é€ å‡½æ•°æ³¨å…¥åŠŸèƒ½ï¼Œä½†æ˜¯æä¾›äº† `Services` å±æ€§ï¼Œå¦‚æœéœ€è¦è§£ææœåŠ¡ï¼Œåˆ™å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ï¼š

```cs showLineNumbers
var someServices = Services.GetService<ISomeService>(); // æ¨èæ–¹å¼
// æˆ–
var someServices = App.GetService<ISomeService>();
```

### 12.12.3 `AOP` çš„ä½œç”¨

è¿™ç§é¢å‘åˆ‡é¢çš„èƒ½åŠ›ï¼ˆåŠ¨æ€æ‹¦æˆª/ä»£ç†ï¼‰å¯ä»¥å®ç°å¾ˆå¤šå¾ˆå¤šåŠŸèƒ½ï¼Œå¦‚ï¼š

- åŠ¨æ€æ—¥å¿—è®°å½•
- åŠ¨æ€ä¿®æ”¹å‚æ•°
- åŠ¨æ€ä¿®æ”¹è¿”å›å€¼
- åŠ¨æ€æ–¹æ³•é‡å®šå‘
- åŠ¨æ€ä¿®æ”¹ä»£ç é€»è¾‘
- åŠ¨æ€å®ç°å¼‚å¸¸ç›‘å¬

è¿˜å¯ä»¥åšæ›´å¤šæ›´å¤šçš„äº‹æƒ…ã€‚

## 12.13 åœ¨é `Web` æˆ–å¤šçº¿ç¨‹è§£ææœåŠ¡

é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨ `Web` è¯·æ±‚å¼€å§‹ä¹‹å‰ä¼šè‡ªåŠ¨åˆ›å»ºèŒƒå›´ä½œç”¨åŸŸï¼Œè¿™ä¸ªä½œç”¨åŸŸçš„ç”Ÿå­˜å‘¨æœŸæ˜¯è¯·æ±‚ä¹‹å‰å’Œå“åº”ä¹‹åï¼Œä¹Ÿå°±æ˜¯åœ¨è¿™ä¸ªä½œç”¨åŸŸå†…çš„æ‰€æœ‰æœåŠ¡éƒ½å®ç°äº†è‡ªåŠ¨ç®¡ç†ï¼Œæ¯”å¦‚åˆ›å»ºæœåŠ¡å’Œé‡Šæ”¾æœåŠ¡çš„æ—¶æœºã€‚

**ä½†åœ¨é `Web` æˆ–å¤šçº¿ç¨‹ä¸­ï¼Œæ¡†æ¶å¹¶ä¸ä¼šåšè¿™æ ·çš„äº‹æƒ…ï¼Œä¹Ÿå°±æ˜¯æ¡†æ¶åªè´Ÿè´£äº†æœåŠ¡çš„åˆ›å»ºï¼Œä½†æ˜¯æ²¡æœ‰è´Ÿè´£é”€æ¯ï¼ŒåŸå› æ˜¯æ¡†æ¶æ— æ³•å¾—çŸ¥å…·ä½“çš„é”€æ¯æ—¶æœºï¼Œè¿™æ ·å°±å¯¼è‡´äº†å†…å­˜æº¢å‡ºã€‚**

è§£å†³æ–¹å¼æ˜¯ï¼šåœ¨é `Web` æˆ–å¤šçº¿ç¨‹ä¸­ä½¿ç”¨ **éå•ä¾‹** æœåŠ¡ï¼Œåº”è¯¥ä¸»åŠ¨åˆ›å»ºä½œç”¨åŸŸï¼Œç±»ä¼¼è¿‡å»çš„ `using`ï¼Œç›®å‰æ¡†æ¶æä¾›äº†å‡ ç§æ–¹å¼ã€‚

### 12.13.1 `IServiceProvider` æ–¹å¼

```cs showLineNumbers {1-2,5,8,11-12}
using var scope = serviceProvider.CreateScope();
var services = scope.ServiceProvider;

// è·å–æ•°æ®åº“ä¸Šä¸‹æ–‡
var dbContext = Db.GetDbContext(services);

// è·å–ä»“å‚¨
var respository = Db.GetRepository<Person>(services);

// è§£æå…¶ä»–æœåŠ¡
var otherService = services.GetService<XXX>();
var otherService2 = App.GetService<XXX>(services);
```

### 12.13.2 `IServiceScopeFactory` æ–¹å¼

```cs showLineNumbers
using var scope = serviceScopeFactory.CreateScope();
var services = scope.ServiceProvider;
```

### 12.13.3 `Scoped` é™æ€ç±»

ä¸ºäº†æ–¹æ³•å¿«é€Ÿåˆ›å»ºæœåŠ¡ä½œç”¨åŸŸï¼Œ`Furion` æ¡†æ¶æä¾›äº† `Scoped` é™æ€ç±»ï¼Œå¦‚ï¼š

```cs showLineNumbers {1-2}
Scoped.Create((factory, scope) => {
     var services = scope.ServiceProvider;
});
```

## 12.14 åœ¨ `WinForm/WPF` ä¸­ä½¿ç”¨

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.7.23 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`WinForm/WPF` ä¸æ”¯æŒä¾èµ–æ³¨å…¥åŠŸèƒ½ï¼Œä½† `Furion` æ¡†æ¶æä¾›äº†å®Œæ•´çš„æ”¯æŒï¼Œ**åªéœ€è¦å°†æ‰€æœ‰ `new Form()` æˆ– `new Window()` æ›¿æ¢ä¸º `Native.CreateInstance<Form>()` æˆ– `Native.CreateInstance<Window>()` å³å¯**ã€‚

### 12.14.1 åœ¨ `WinForm` ä¸­ä½¿ç”¨

- ä¿®æ”¹ `Progame.cs` ä»£ç 

```cs showLineNumbers {9,12} title="Progame.cs"
namespace WinFormsApp1;

internal static class Program
{
    [STAThread]
    static void Main()
    {
        // åˆå§‹åŒ– Furion é…ç½®
        Serve.RunNative();

        ApplicationConfiguration.Initialize();
        Application.Run(Native.CreateInstance<Form1>());    // æ›¿æ¢ new Form1() ä¸º Native.CreateInstance<Form1>()
    }
}
```

- ä½¿ç”¨å®Œæ•´çš„ä¾èµ–æ³¨å…¥åŠŸèƒ½

```cs showLineNumbers {11-12,16-17,21}
using Furion.DependencyInjection;
using Microsoft.Extensions.Configuration;

namespace WinFormsApp1;

public partial class Form1 : Form
{
    private readonly IConfiguration _configuration;
    private readonly ITest _test;

    public Form1(IConfiguration configuration
        , ITest test)
    {
        InitializeComponent();

        _configuration = configuration;
        _test = test;
    }
}

public class Test : ITest, ITransient
{
}

public interface ITest
{
}
```

- æ‰“å¼€æ–°çª—å£ `Form2`

```cs showLineNumbers {10,14-15}
using Furion.DependencyInjection;
using Microsoft.Extensions.Configuration;

namespace WinFormsApp1;

public partial class Form2 : Form
{
    private readonly IConfiguration _configuration;

    public Form2(IConfiguration configuration, string parameter)    // æ”¯æŒå…¶ä»–å‚æ•° parameter
    {
        InitializeComponent();

        _configuration = configuration;
        label1.Text = parameter;
    }
}
```

åœ¨ `Form1` ä¸­æ‰“å¼€ `From2`

```cs showLineNumbers {3}
private void button1_Click(object sender, EventArgs e)
{
    Native.CreateInstance<Form2>("æˆ‘æ˜¯å…¶ä»–å‚æ•°").ShowDialog();  // new Form2() æ”¹ä¸º  Native.CreateInstance<Form2>();
}
```

:::tip è·å–æ‰“å¼€çª—å£å®ä¾‹

`Native.CreateInstance<>` æ¯æ¬¡éƒ½ä¼šåˆ›å»ºæ–°çš„å®ä¾‹ï¼Œå¦‚æœåªæ˜¯æƒ³è·å–æ‰“å¼€çš„çª—å£çš„å®ä¾‹å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼ï¼š

```cs showLineNumbers
var form1 = Application.OpenForms.OfType<Form>().FirstOrDefault(f => f is Form1);
```

:::

### 12.14.2 åœ¨ `WPF` ä¸­ä½¿ç”¨

- ä¿®æ”¹ `App.xaml` ä»£ç å¹¶åˆ é™¤ `StartupUri="MainWindow.xaml"` å±æ€§

```xml showLineNumbers {5}
<Application x:Class="WpfApp1.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:WpfApp1">
             <!--StartupUri="MainWindow.xaml"-->
    <Application.Resources>

    </Application.Resources>
</Application>
```

- ä¿®æ”¹ `App.xaml.cs` ä»£ç 

```cs showLineNumbers {7-10,12-16}
using System.Windows;

namespace WpfApp1;

public partial class App : Application
{
    public App()
    {
        Serve.RunNative();
    }

    protected override void OnStartup(StartupEventArgs e)
    {
        Native.CreateInstance<MainWindow>().Show();
        base.OnStartup(e);
    }
}
```

- ä½¿ç”¨å®Œæ•´çš„ä¾èµ–æ³¨å…¥åŠŸèƒ½

```cs showLineNumbers {12-13,17-18,22}
using Furion.DependencyInjection;
using Microsoft.Extensions.Configuration;
using System.Windows;

namespace WpfApp1;

public partial class MainWindow : Window
{
    private readonly IConfiguration _configuration;
    private readonly ITest _test;

    public MainWindow(IConfiguration configuration
        , ITest test)
    {
        InitializeComponent();

        _configuration = configuration;
        _test = test;
    }
}

public class Test : ITest, ITransient
{
}

public interface ITest
{
}
```

- æ‰“å¼€æ–°çª—å£ `Window1`

```cs showLineNumbers {7,11,15-16}
using Furion.DependencyInjection;
using Microsoft.Extensions.Configuration;
using System.Windows;

namespace WpfApp1;

public partial class Window1 : Window
{
    private readonly IConfiguration _configuration;

    public Window1(IConfiguration configuration, string parameter)  // æ”¯æŒå…¶ä»–å‚æ•° parameter
    {
        InitializeComponent();

        _configuration = configuration;
        label1.Content = parameter;
    }
}

```

åœ¨ `MainWindow` ä¸­æ‰“å¼€ `Window1`

```cs showLineNumbers {3}
private void Button_Click(object sender, RoutedEventArgs e)
{
    Native.CreateInstance<Window1>("æˆ‘æ˜¯å…¶ä»–å‚æ•°").Show();
}
```

:::tip è·å–æ‰“å¼€çª—å£å®ä¾‹

`Native.CreateInstance<>` æ¯æ¬¡éƒ½ä¼šåˆ›å»ºæ–°çš„å®ä¾‹ï¼Œå¦‚æœåªæ˜¯æƒ³è·å–æ‰“å¼€çš„çª—å£çš„å®ä¾‹å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼ï¼š

```cs showLineNumbers
var window1 = Application.Current.Windows.OfType<Window>().FirstOrDefault(w => w is MainWindow);
```

:::

### 12.14.3 `Native.CreateInstance<T>()` é™æ€æ–¹æ³•

`Furion` æ¡†æ¶æä¾›äº† `Native.CreateInstance<T>()` é™æ€æ–¹æ³•å¯åœ¨ `WinForm/WPF` ä¸­åˆ›å»ºçª—å£å®ä¾‹ï¼Œå¯æ›¿ä»£ `new T()` æ“ä½œï¼Œé€šè¿‡æ­¤æ–¹æ³•åˆ›å»ºå®ä¾‹æ”¯æŒæ„é€ å‡½æ•°æ³¨å…¥æœåŠ¡æ“ä½œã€‚

## 12.15 è‡ªå®šä¹‰æ‰«æ/ç­›é€‰æ³¨å†ŒæœåŠ¡

`Furion` æ¡†æ¶ä¸­å¹¶æœªæä¾›å®Œå…¨è‡ªå®šä¹‰ä¾èµ–æ³¨å…¥æ‰«æçš„æœºåˆ¶ï¼Œä½†æ¨èä¸€ä¸ªéå¸¸ä¼˜ç§€çš„ `.NET Core` ä¾èµ–æ³¨å…¥æ‹“å±•åº“ï¼š`Scrutor`ï¼Œä½¿ç”¨éå¸¸ç®€å•ï¼Œä¸»è¦é€šè¿‡ `FromAssemblyOf<>` æ‰«æç¨‹åºé›†å’Œ `AddClasses(o)` è¿›è¡Œç­›é€‰æ³¨å†Œã€‚

ä½¿ç”¨å¦‚ä¸‹ï¼š

```cs showLineNumbers {1,3,6,13,19,22}
services.Scan(scan => scan
    // æ‰«æç‰¹å®šç±»å‹æ‰€åœ¨çš„ç¨‹åºé›†ï¼Œè¿™é‡Œæ˜¯ ITransientService æ‰€åœ¨çš„ç¨‹åºé›†
    .FromAssemblyOf<ITransientService>()
        // .AddClasses åœ¨ä¸Šé¢è·å–åˆ°çš„ç¨‹åºé›†ä¸­æ‰«ææ‰€æœ‰å…¬å¼€ã€éæŠ½è±¡ç±»å‹
        // ä¹‹åå¯ä»¥é€šè¿‡å§”æ‰˜è¿›è¡Œç±»å‹ç­›é€‰ï¼Œä¾‹å¦‚ä¸‹é¢åªæ‰«æå®ç° ITransientService çš„ç±»å‹
        .AddClasses(classes => classes.AssignableTo<ITransientService>())
            // å°†ä¸Šé¢çš„ç±»å‹ä½œä¸ºå®ƒå®ç°çš„æ‰€æœ‰æ¥å£è¿›è¡Œæ³¨å†Œ
            // å¦‚æœç±»å‹å®ç°äº† N ä¸ªæ¥å£ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰ä¸‰ä¸ªç‹¬ç«‹çš„æ³¨å†Œ
            .AsImplementedInterfaces()
            // æœ€åæŒ‡å®šæ³¨å†Œçš„ç”Ÿå­˜æœŸï¼Œå¦‚ç¬æ—¶ï¼Œä½œç”¨åŸŸï¼Œè¿˜æ˜¯å•ä¾‹
            .WithTransientLifetime()
        // é‡å¤ä¸Šé¢æ“ä½œï¼Œæ¯”å¦‚è¿™é‡Œæ‰«æ IScopedService æ‰€åœ¨çš„ç¨‹åºé›†
        .AddClasses(classes => classes.AssignableTo<IScopedService>())
            // è¿™é‡Œå’Œä¸Šé¢ä¸ä¸€æ ·çš„æ˜¯ï¼Œè¿™é‡ŒæŒ‡å®šåªå®ç°ç‰¹å®šçš„å‡ å£ï¼Œä¹Ÿå°±æ˜¯åªæ³¨å†Œä¸€æ¬¡
            .As<IScopedService>()
            // æŒ‡å®šæ³¨å†Œçš„ç”Ÿå­˜æœŸ
            .WithScopedLifetime()
        // ä¹Ÿæ”¯æŒæ³›å‹æ³¨å†Œï¼Œå•ä¸ªæ³›å‹å‚æ•°
        .AddClasses(classes => classes.AssignableTo(typeof(IOpenGeneric<>)))
            .AsImplementedInterfaces()
        // å¤šä¸ªæ³›å‹å‚æ•°
        .AddClasses(classes => classes.AssignableTo(typeof(IQueryHandler<,>)))
            .AsImplementedInterfaces());
```

è¯¦ç»†æ–‡æ¡£è¯·æŸ¥é˜… [https://github.com/khellang/Scrutor](https://github.com/khellang/Scrutor)

## 12.16 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::
