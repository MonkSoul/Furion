---
id: dbcontext
title: 9.2 æ•°æ®åº“ä¸Šä¸‹æ–‡
sidebar_label: 9.2 æ•°æ®åº“ä¸Šä¸‹æ–‡
---

import Tag from "@site/src/components/Tag.js";

<details>
  <summary>ğŸ“ æ¨¡å—æ›´æ–°æ—¥å¿—</summary>
  <div>
<div>

- **æ–°ç‰¹æ€§**

  - &nbsp;<Tag>æ–°å¢</Tag> `[AppDbContext]` ç‰¹æ€§æ”¯æŒ `UseSnakeCaseNaming` å±æ€§é…ç½®è¡¨åä½¿ç”¨è›‡å½¢å‘½å <sup>4.9.1.5</sup> <sup>â±ï¸2023.11.20</sup> [#I8HGR2](https://gitee.com/dotnetchina/Furion/issues/I8HGR2) [!863](https://gitee.com/dotnetchina/Furion/pulls/863)
  - &nbsp;<Tag>æ–°å¢</Tag> `Db.GetNewDbContext()` å¤šä¸ªé‡è½½æ–¹æ³•ï¼Œå®ç°ç±»ä¼¼ `new DbContext()` æ“ä½œ <sup>4.8.8.55</sup> <sup>â±ï¸2023.11.09</sup> [4157629](https://gitee.com/dotnetchina/Furion/commit/41576295473fefc47f6961154909a690d7c5ed58)

</div>
  </div>
</details>

:::warning è¿æ¥å­—ç¬¦ä¸²é…ç½®æ³¨æ„äº‹é¡¹

å¦‚æœè¿æ¥å­—ç¬¦ä¸²æ˜¯é…ç½®åœ¨è‡ªå®šä¹‰çš„ `.json` æ–‡ä»¶ä¸­ï¼Œé‚£ä¹ˆå¿…é¡»åœ¨ `Visual Studio` ä¸­é…ç½® `.json` å³é”®å±æ€§ï¼Œè®¾ç½® `å¤åˆ¶` è¾“å‡ºç›®å½•ä¸º `å¦‚æœè¾ƒæ–°åˆ™å¤åˆ¶`ï¼Œç”Ÿæˆæ“ä½œä¸ºï¼š`å†…å®¹`ã€‚

å¦åˆ™å°±ä¼šæç¤ºæ‰¾ä¸åˆ°é…ç½®æˆ–è¿æ¥å­—ç¬¦ä¸²çš„é”™è¯¯ã€‚

:::

## 9.2.1 æ•°æ®åº“ä¸Šä¸‹æ–‡

ç®€å•æ¥è¯´ï¼Œæ•°æ®åº“ä¸Šä¸‹æ–‡æ˜¯è´Ÿè´£å’Œæ•°æ®åº“äº¤äº’çš„å¯¹è±¡ï¼Œæä¾›ç¨‹åºå¯¹æ•°æ®åº“å­˜å–æä¾›äº†å¤§é‡çš„æ–¹æ³•ã€‚

åœ¨ `Furion` æ¡†æ¶ä¸­ï¼Œé»˜è®¤é›†æˆäº†å¾®è½¯äº²å„¿å­ï¼š`EntityFramework Core` ï¼Œä¹Ÿå°±æ˜¯é€šå¸¸æ•°æ®åº“ä¸Šä¸‹æ–‡æŒ‡çš„æ˜¯ `DbContext` ç±»æˆ–å®ƒçš„å®ç°ç±»ã€‚

## 9.2.2 `AppDbContext`

åœ¨æˆ‘ä»¬å®é™…é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨ `EFCore` æä¾›çš„ `DbContext` æ“ä½œå¯¹è±¡æ“ä½œæ•°æ®åº“æœ‰äº›ç¹çå’Œå¤æ‚ï¼Œä¸”é»˜è®¤ä¸å…·å¤‡è¯»å†™åˆ†ç¦»ã€å¤šåº“ç­‰æ“ä½œåŠŸèƒ½ã€‚

æ‰€ä»¥ï¼Œ`Furion` æ¡†æ¶æä¾›äº† `AppDbContext<TDbContext, TDbContextLocator>` æ•°æ®åº“ä¸Šä¸‹æ–‡ï¼Œè¯¥ä¸Šä¸‹æ–‡ç»§æ‰¿è‡ª `DbContext`ã€‚

:::note ç‰¹åˆ«è¯´æ˜
åç»­ç« èŠ‚ï¼Œçš†é‡‡ç”¨ `EFCore` ä»£æ›¿ `EntityFramework Core`ã€‚
:::

## 9.2.3 `AppDbContext` å’Œ `DbContext` åŒºåˆ«

- `AppDbContext` ç»§æ‰¿è‡ª `DbContext`ï¼Œå…·å¤‡ `DbContext` æ‰€æœ‰åŠŸèƒ½ã€‚
- `AppDbContext` æ”¯æŒå¤šæ•°æ®åº“æ“ä½œæ³›å‹ç‰ˆæœ¬ï¼Œå¦‚ï¼š`AppDbContext<TDbContext, TDbContextLocator>`
- `AppDbContext` è‡ªåŠ¨é…ç½®å®ä½“ä¿¡æ¯ï¼Œæ— éœ€åœ¨ `OnModelCreating` ä¸­é…ç½®
- `AppDbContext` æ”¯æŒå†…ç½®å¤šç§Ÿæˆ·æ”¯æŒ
- `AppDbContext` æ”¯æŒå…¨å±€æ¨¡å‹é…ç½®æ‹¦æˆªå™¨
- `AppDbContext` æ”¯æŒæ•°æ®æäº¤æ›´æ”¹å¤šä¸ªäº‹ä»¶
- `AppDbContext` æä¾›æ›´åŠ å¼ºå¤§çš„æ¨¡å‹æ“ä½œèƒ½åŠ›ï¼Œå¦‚ `Sql` æ“ä½œï¼Œè¯»å†™åˆ†ç¦»ç­‰
- `AppDbContext` èƒ½å¤Ÿå¾—åˆ° `Furion` æ¡†æ¶æ›´å¤šçš„åŠŸèƒ½æ”¯æŒ

## 9.2.4 å¦‚ä½•å®šä¹‰æ•°æ®åº“ä¸Šä¸‹æ–‡

åœ¨ `Furion` æ¡†æ¶ä¸­äº†ï¼Œæä¾›äº†ä¸¤ç§ `AppDbContext` å®šä¹‰æ–¹å¼ï¼š

- `AppDbContext<TDbContext>` æ“ä½œé»˜è®¤æ•°æ®åº“
- `AppDbContext<TDbContext, TDbContextLocator>` æ“ä½œ N ä¸ªæ•°æ®åº“

å…¶ä¸­ `AppDbContext<TDbContext>` é»˜è®¤ç»§æ‰¿è‡ª `AppDbContext<TDbContext, TDbContextLocator>`ã€‚

ä¸‹é¢æ˜¯æ•°æ®åº“ä¸Šä¸‹æ–‡åˆ›å»ºçš„å¤šä¸ªä¾‹å­ï¼š

### 9.2.4.1 åˆ›å»ºé»˜è®¤æ•°æ®åº“ä¸Šä¸‹æ–‡

```cs showLineNumbers  {1,6,12}
using Furion.DatabaseAccessor;
using Microsoft.EntityFrameworkCore;

namespace Furion.EntityFramework.Core
{
    [AppDbContext("è¿æ¥å­—ç¬¦ä¸²æˆ–appsetting.json é”®")]
    public class FurionDbContext : AppDbContext<FurionDbContext>  // ç»§æ‰¿ AppDbContext<> ç±»
    {
        /// <summary>
        /// ç»§æ‰¿çˆ¶ç±»æ„é€ å‡½æ•°
        /// </summary>
        /// <param name="options"></param>
        public FurionDbContext(DbContextOptions<FurionDbContext> options) : base(options)
        {
        }
    }
}
```

### 9.2.4.2 åˆ›å»ºå…¶ä»–æ•°æ®åº“ä¸Šä¸‹æ–‡

```cs showLineNumbers  {1,6,12}
using Furion.DatabaseAccessor;
using Microsoft.EntityFrameworkCore;

namespace Furion.EntityFramework.Core
{
    [AppDbContext("è¿æ¥å­—ç¬¦ä¸²æˆ–appsetting.json é”®")]
    public class FurOtherDbContext : AppDbContext<FurOtherDbContext, FurOtherDbContextLocator>  // ç»§æ‰¿ AppDbContext<> ç±»
    {
        /// <summary>
        /// ç»§æ‰¿çˆ¶ç±»æ„é€ å‡½æ•°
        /// </summary>
        /// <param name="options"></param>
        public FurOtherDbContext(DbContextOptions<FurOtherDbContext> options) : base(options)
        {
        }
    }
}
```

:::important ç‰¹åˆ«æ³¨æ„
æ‰€æœ‰æ•°æ®åº“ä¸Šä¸‹æ–‡éƒ½åº”è¯¥åœ¨ `Furion.EntityFramework.Core` é¡¹ç›®ä¸­åˆ›å»ºã€‚å¦å¤–å¦‚æœç³»ç»Ÿç”¨åˆ°äº†å¤šä¸ªæ•°æ®åº“ï¼Œé‚£ä¹ˆä»ç¬¬äºŒä¸ªå¼€å§‹å¿…é¡»æŒ‡å®šæ•°æ®åº“ä¸Šä¸‹æ–‡å®šä½å™¨ã€‚å…³äº `TDbContextLocator` å°†åœ¨ä¸‹ä¸€ç« èŠ‚ ã€Š[9.3 æ•°æ®åº“ä¸Šä¸‹æ–‡å®šä½å™¨](dbcontext-locator)ã€‹é˜è¿°ã€‚
:::

## 9.2.5 é…ç½®è¿æ¥å­—ç¬¦ä¸²

`Furion` æ¡†æ¶æä¾›å¤šç§æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²é…ç½®æ–¹å¼ï¼š

- åœ¨æ³¨å†Œæ•°æ®åº“æœåŠ¡æ—¶é…ç½®ï¼š`AddDbPool<TDbContext>("è¿æ¥å­—ç¬¦ä¸²")` æ–¹å¼
- ä½¿ç”¨ `[AppDbContext("è¿æ¥å­—ç¬¦ä¸²/Key")]` ç‰¹æ€§æ–¹å¼ï¼ˆåªåœ¨ `AppDbContext å®ç°ç±»æœ‰æ•ˆ`ï¼‰**æ¨è**
- é€šè¿‡é‡å†™ `OnConfiguring(DbContextOptionsBuilder optionsBuilder)` é…ç½®

### 9.2.5.1 åœ¨æ³¨å†Œæ•°æ®åº“æœåŠ¡æ—¶é…ç½®

```cs showLineNumbers  {12-19} title="Furion.EntityFramework.Core\Startup.cs"
using Furion.DependencyInjection;
using Microsoft.Extensions.DependencyInjection;

namespace Furion.EntityFramework.Core
{
    [AppStartup(600)]
    public sealed class FurEntityFrameworkCoreStartup : AppStartup
    {
        public void ConfigureServices(IServiceCollection services)
        {
            // é…ç½®æ•°æ®åº“ä¸Šä¸‹æ–‡ï¼Œæ”¯æŒNä¸ªæ•°æ®åº“
            services.AddDatabaseAccessor(options =>
            {
                // é…ç½®é»˜è®¤æ•°æ®åº“
                options.AddDbPool<FurionDbContext>(DbProvider.SqlServer, connectionMetadata:"è¿æ¥å­—ç¬¦ä¸²");

                // é…ç½®å¤šä¸ªæ•°æ®åº“ï¼Œå¤šä¸ªæ•°æ®åº“å¿…é¡»æŒ‡å®šæ•°æ®åº“ä¸Šä¸‹æ–‡å®šä½å™¨
                options.AddDbPool<SqliteDbContext, SqliteDbContextLocaotr>(DbProvider.Sqlite, connectionMetadata:"è¿æ¥å­—ç¬¦ä¸²");
            });
        }
    }
}
```

:::caution æ–°ç‰ˆ MySQL æ³¨æ„

`MySQL` åœ¨æ–°ç‰ˆæœ¬åŒ…ä¸­æ³¨å†Œæœ‰æ‰€ä¿®æ”¹ï¼Œæ‰€ä»¥æ³¨å†Œæ–¹å¼ä¸ºï¼š

```cs showLineNumbers
services.AddDatabaseAccessor(options =>
{
    options.AddDbPool<FurionDbContext>($"{DbProvider.MySql}@8.0.22");
});
```

:::

### 9.2.5.2 `[AppDbContext]` æ–¹å¼é…ç½®

```cs showLineNumbers  {1,6}
using Furion.DatabaseAccessor;
using Microsoft.EntityFrameworkCore;

namespace Furion.EntityFramework.Core
{
    [AppDbContext("DbConnectionString")]   // æ”¯æŒ `appsetting.json` åæˆ– è¿æ¥å­—ç¬¦ä¸²
    public class FurionDbContext : AppDbContext<FurionDbContext>
    {
        /// <summary>
        /// ç»§æ‰¿çˆ¶ç±»æ„é€ å‡½æ•°
        /// </summary>
        /// <param name="options"></param>
        public FurionDbContext(DbContextOptions<FurionDbContext> options) : base(options)
        {
        }
    }
}
```

:::tip å°æç¤º

`Furion` æ¨èä½¿ç”¨æ­¤æ–¹å¼é…ç½®æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚

:::

**`[AppDbContext]`** å†…ç½®å±æ€§ï¼š

- `ConnectionMetadata`ï¼šæ”¯æŒæ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œé…ç½®æ–‡ä»¶çš„ `ConnectionStrings` ä¸­çš„ `Key` æˆ–é…ç½®æ–‡ä»¶çš„å®Œæ•´çš„é…ç½®è·¯å¾„ï¼Œå¦‚æœæ˜¯å†…å­˜æ•°æ®åº“ï¼Œåˆ™ä¸ºæ•°æ®åº“åç§°ã€‚
- `TablePrefix`ï¼šå½“å‰æ•°æ®åº“ä¸Šä¸‹æ–‡è¡¨ç»Ÿä¸€å‰ç¼€
- `TableSuffix`ï¼šå½“å‰æ•°æ®åº“ä¸Šä¸‹æ–‡è¡¨ç»Ÿä¸€åç¼€
- `ProviderName`ï¼šé…ç½®æ•°æ®åº“æä¾›å™¨ç±»å‹ï¼Œä¼ å…¥ `DbProvider.Xxx`
- `Mode`ï¼šé…ç½®æ•°æ®åº“ä¸Šä¸‹æ–‡æ¨¡å¼ï¼Œ`DbContextMode` æšä¸¾ç±»å‹ï¼Œå–å€¼ï¼š
  - `Cached`ï¼šç¼“å­˜æ¨¡å‹æ•°æ®åº“ä¸Šä¸‹æ–‡ï¼Œé»˜è®¤å€¼
  - `Dynamic`ï¼šåŠ¨æ€æ¨¡å‹æ•°æ®åº“ä¸Šä¸‹æ–‡
- `SlaveDbContextLocators`ï¼šä¸»ä»åº“é…ç½®ï¼Œè®¾ç½®å¤šä¸ªä»åº“å®šä½å™¨ï¼Œ`Type[]` ç±»å‹
- `UseSnakeCaseNaming`ï¼šè¡¨åä½¿ç”¨è›‡å½¢å‘½åï¼Œ`bool` ç±»å‹ï¼Œé»˜è®¤ `false`ï¼Œ`Furion 4.9.1.5+` ç‰ˆæœ¬æ”¯æŒ

### 9.2.5.3 `OnConfiguring` æ–¹å¼é…ç½®

```cs showLineNumbers  {16-20}
using Furion.DatabaseAccessor;
using Microsoft.EntityFrameworkCore;

namespace Furion.EntityFramework.Core
{
    public class FurionDbContext : AppDbContext<FurionDbContext>
    {
        /// <summary>
        /// ç»§æ‰¿çˆ¶ç±»æ„é€ å‡½æ•°
        /// </summary>
        /// <param name="options"></param>
        public FurionDbContext(DbContextOptions<FurionDbContext> options) : base(options)
        {
        }

        protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
        {
            base.OnConfiguring(optionsBuilder);

            optionsBuilder.UseSqlServer("æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²");
        }
    }
}
```

:::important ç‰¹åˆ«æ³¨æ„

è¿™ä¸‰ç§æ–¹å¼å¯ä»¥åŒæ—¶ä½¿ç”¨ï¼Œä½†æ˜¯æœ‰ä¼˜å…ˆçº§ï¼š`[AppDbContext]` -> `åœ¨æ³¨å†Œæ•°æ®åº“æœåŠ¡æ—¶é…ç½®` -> `OnConfiguring`ï¼ˆä½åˆ°é«˜ï¼‰

ä¹Ÿå°±æ˜¯ `OnConfiguring` é…ç½®ä¼šè¦†ç›– `åœ¨æ³¨å†Œæ•°æ®åº“æœåŠ¡æ—¶é…ç½®` é…ç½®ï¼Œ`åœ¨æ³¨å†Œæ•°æ®åº“æœåŠ¡æ—¶é…ç½®` é…ç½®ä¼šè¦†ç›– `[AppDbContext]` é…ç½®æ‰€é…ç½®çš„è¿æ¥å­—ç¬¦ä¸²ã€‚

:::

### 9.2.5.4 å„ç±»æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²é…ç½®ç¤ºä¾‹

- `Sqlite`ï¼š`Data Source=./Furion.db`
- `MySql`ï¼š`Data Source=localhost;Database=Furion;User ID=root;Password=000000;pooling=true;port=3306;sslmode=none;CharSet=utf8;`
- `SqlServer`ï¼š`Server=localhost;Database=Furion;User=sa;Password=000000;MultipleActiveResultSets=True;`
- `Oracle`ï¼š`User Id=orcl;Password=orcl;Data Source=(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=TCP)(HOST=127.0.0.1)(PORT=1521)))(CONNECT_DATA=(SERVICE_NAME=orcl)))`
- `PostgreSQL`ï¼š`PORT=5432;DATABASE=postgres;HOST=127.0.0.1;PASSWORD=postgres;USER ID=postgres;`

## 9.2.6 æ•°æ®åº“ä¸Šä¸‹æ–‡å®šä¹‰ä½ç½®

:::important ç‰¹åˆ«æ³¨æ„

åœ¨ `Furion` æ¡†æ¶ä¸­ï¼Œæ•°æ®åº“ä¸Šä¸‹æ–‡éœ€å®šä¹‰åœ¨ `Furion.EntityFramework.Core` ä¸­ï¼Œä¸”æ¯ä¸€ä¸ªæ•°æ®åº“ä¸Šä¸‹æ–‡éƒ½å¿…é¡»æ‹¥æœ‰å”¯ä¸€çš„ `DbContextLocator` å®šä½å™¨

:::

## 9.2.7 æ•°æ®åº“ä¸Šä¸‹æ–‡æ³¨å†Œ

æ•°æ®åº“ä¸Šä¸‹æ–‡é…ç½®å¥½æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²åï¼Œéœ€è¦æ³¨å†Œè¯¥æ•°æ®åº“ä¸Šä¸‹æ–‡ï¼Œå¹¶æŒ‡å®šæ•°æ®åº“ç±»å‹ï¼Œå¦‚ï¼š

```cs showLineNumbers  {11-13} title="Furion\framework\Furion.EntityFramework.Core\FurEntityFrameworkCoreStartup.cs"
using Furion.DatabaseAccessor;
using Microsoft.Extensions.DependencyInjection;

namespace Furion.EntityFramework.Core
{
    [AppStartup(600)]
    public sealed class FurEntityFrameworkCoreStartup : AppStartup
    {
        public void ConfigureServices(IServiceCollection services)
        {
            services.AddDatabaseAccessor(options =>
            {
                options.AddDbPool<FurionDbContext>(DbProvider.Sqlite);
            });
        }
    }
}
```

å¦‚æœæœ‰å¤šä¸ªæ•°æ®åº“æ“ä½œï¼Œ**é‚£ä¹ˆä»ç¬¬äºŒä¸ªèµ·ï¼Œå°±éœ€è¦ç»‘å®šæ•°æ®åº“ä¸Šä¸‹æ–‡å®šä½å™¨**ï¼Œå¦‚ï¼š

```cs showLineNumbers
options.AddDbPool<FurionDbContext>(DbProvider.Sqlite); // ç¬¬ä¸€ä¸ªæ•°æ®åº“

options.AddDbPool<SecondDbContext, SecondDbContextDbContextLocator>(DbProvider.SqlServer);  // ç¬¬äºŒä¸ªæ•°æ®åº“

options.AddDbPool<ThirdDbContext, ThirdDbContextDbContextLocator>(DbProvider.SqlServer);  // ç¬¬ä¸‰ä¸ªæ•°æ®åº“
```

## 9.2.8 è‡ªå®šä¹‰é«˜çº§æ³¨å†Œ

åœ¨ `Furion` æ¡†æ¶ä¸­ï¼Œä¸ºäº†èƒ½å¤Ÿå®ç°æ•°æ®åº“çš„ç®€å•ä½¿ç”¨è¿›è¡Œäº†æ³¨å†Œå°è£…ï¼Œä½†æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦æ·»åŠ æ›´å¤šé…ç½®ï¼Œè¿™æ—¶å°±éœ€è¦ä½¿ç”¨åŸç”Ÿè‡ªå®šä¹‰é…ç½®æ–¹å¼ï¼Œå¦‚ï¼š

```cs showLineNumbers
services.AddDatabaseAccessor(options =>
{
    // è‡ªå®šä¹‰åŸç”Ÿé…ç½®
    options.AddDb<YourDbContext>((services, builder) =>
    {
        builder.UseSqlite(...);
    }
});
```

:::tip å°çŸ¥è¯†

`Furion` æ¡†æ¶æä¾›äº†å¿«é€Ÿè§£æè¿æ¥å­—ç¬¦ä¸²çš„é™æ€æ–¹æ³•ï¼Œè‡ªåŠ¨æ ¹æ®åç§°è¯»å–é…ç½®ï¼Œè‡ªåŠ¨è§£æ `[AppContext("...")]` ä¿¡æ¯ï¼Œå¦‚ï¼š

```cs showLineNumbers
// è·å–è¿æ¥å­—ç¬¦ä¸²
var connStr = DbProvider.GetConnectionString<YourDbContext>(/*è¿™é‡Œå¯å†™å¯ä¸å†™*/);

options.AddDb<YourDbContext>((services, builder) =>
{
    builder.UseSqlite(connStr, ...);
}
```

:::

## 9.2.9 åŠ¨æ€æ•°æ®åº“ä¸Šä¸‹æ–‡å¯¹è±¡

åœ¨ `Furion` æ¡†æ¶ä¸­ï¼Œæ•°æ®åº“ä¸Šä¸‹æ–‡æ˜¯å®šä¹‰åœ¨ `Furion.EntityFramework.Core` é¡¹ç›®å±‚ï¼Œå¹¶ä¸”è¯¥å±‚ä¸è¢« `Furion.Application` å’Œ `Furion.Core` ç­‰å±‚å¼•ç”¨ã€‚

æ‰€ä»¥å°±ä¸èƒ½ç›´æ¥åœ¨ `Furion.Application` é¡¹ç›®å±‚ç›´æ¥ä½¿ç”¨ `Furion.EntityFramework.Core` å®šä¹‰çš„æ•°æ®åº“ä¸Šä¸‹æ–‡ã€‚

`Furion` ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæä¾›äº†ä¸¤ç§æ–¹å¼å¤„ç†ï¼š

- `repository.Context` ï¼šå½“å‰æ•°æ®åº“ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œè¿”å›æ˜¯ `DbContext` æŠ½è±¡ç±»å‹
- `repository.DynamicContext`ï¼šå½“å‰æ•°æ®åº“ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œè¿”å›çš„æ˜¯ `dynamic` ç±»å‹

å¦‚æœä½ åªæ˜¯æƒ³ä½¿ç”¨ `DbContext` çš„åŠŸèƒ½ï¼Œç›´æ¥ä½¿ç”¨ `repository.Context` å³å¯ï¼Œå¦‚ï¼š

```cs showLineNumbers
repository.Context.SaveChanges();
```

å¦‚æœä½ æƒ³èƒ½å¤Ÿè·å–å…·ä½“çš„æ•°æ®åº“ä¸Šä¸‹æ–‡ç±»å‹ï¼Œå¦‚ `MyDbContext`ï¼Œé‚£ä¹ˆä½¿ç”¨ `repository.DynamicContext` å°±å¯ä»¥è·å–åˆ°å…·ä½“çš„ `MyDbContext` ç±»å‹ã€‚å¦‚ï¼š

```cs showLineNumbers
var persons = repository.DynamicContext.Persons.Find(1);
var users = repository.DynamicContext.Users;
```

è¿™æ ·å°±å¯ä»¥ç›´æ¥æ“ä½œ `MyDbContext` å®šä¹‰çš„å±æ€§å’Œæ–¹æ³•äº†ã€‚

## 9.2.10 åœ¨åå°ä»»åŠ¡ä¸­ä½¿ç”¨

ç”±äº `DbContext` é»˜è®¤æ³¨å†Œä¸º `Scoped` ç”Ÿå­˜å‘¨æœŸï¼Œæ‰€ä»¥åœ¨åå°ä»»åŠ¡ä¸­ä½¿ç”¨ `IServiceScopeFactory` è·å–æ‰€æœ‰æœåŠ¡ï¼Œå¦‚ï¼š

```cs showLineNumbers {8-9,19,21,24}
public class JobService : BackgroundService
{
    // æ—¥å¿—å¯¹è±¡
    private readonly ILogger<JobService> _logger;

    // æœåŠ¡å·¥å‚
    private readonly IServiceScopeFactory _scopeFactory;
    public JobService(ILogger<JobService> logger
        , IServiceScopeFactory scopeFactory)
    {
        _logger = logger;
        _scopeFactory = scopeFactory;
    }

    protected override Task ExecuteAsync(CancellationToken stoppingToken)
    {
        _logger.LogInformation("å†™æ—¥å¿—~~");

        using (var scope = _scopeFactory.CreateScope())
        {
            var services = scope.ServiceProvider;

            // è·å–æ•°æ®åº“ä¸Šä¸‹æ–‡
            var dbContext = Db.GetDbContext(services);

            // è·å–ä»“å‚¨
            var repository = Db.GetRepository<Person>(services);

            // è§£æå…¶ä»–æœåŠ¡
            var otherService = services.GetService<XXX>();
        }

        return Task.CompletedTask;
    }
}
```

:::important æ•°æ®åº“æ“ä½œæ³¨æ„

å¦‚æœä½œç”¨åŸŸä¸­å¯¹**æ•°æ®åº“æœ‰ä»»ä½•å˜æ›´æ“ä½œ**ï¼Œéœ€æ‰‹åŠ¨è°ƒç”¨ `SaveChanges` æˆ–å¸¦ `Now` ç»“å°¾çš„æ–¹æ³•ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ `Scoped.CreateUow(handler)` ä»£æ›¿ã€‚

:::

## 9.2.11 `AppDbContext` å…¨å±€é…ç½®å±æ€§

- `InsertOrUpdateIgnoreNullValues`ï¼šæ–°å¢æˆ–æ›´æ–°å¿½ç•¥ç©ºå€¼ï¼Œé»˜è®¤ `false`ï¼Œ**åœ¨æ„é€ å‡½æ•°ä¸­é…ç½®**
- `EnabledEntityStateTracked`ï¼šå¯ç”¨å®ä½“è·Ÿè¸ªï¼Œé»˜è®¤ `true`ï¼Œ**åœ¨æ„é€ å‡½æ•°ä¸­é…ç½®**
- `EnabledEntityChangedListener`ï¼šå¯ç”¨å®ä½“æ•°æ®æ›´æ”¹ç›‘å¬ï¼Œé»˜è®¤ `false`ï¼Œ**åœ¨æ„é€ å‡½æ•°ä¸­é…ç½®**
- `Tenant`ï¼šé»˜è®¤å†…ç½®å¤šç§Ÿæˆ·
- `FailedAutoRollback`ï¼šæ˜¯å¦å¯ç”¨ä¿å­˜å¤±è´¥åäº‹åŠ¡è‡ªåŠ¨å›æ»šï¼Œé»˜è®¤ `true`ï¼Œå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹é…ç½®

## 9.2.12 é…ç½®å®ä½“ `æ‡’åŠ è½½`

- ç¬¬ä¸€æ­¥ï¼šå®‰è£… `EFCore` æ‹“å±•åŒ…

åœ¨æ•°æ®åº“ä¸Šä¸‹æ–‡å®šä¹‰æ‰€åœ¨çš„å±‚å®‰è£… `Microsoft.EntityFrameworkCore.Proxies` æ‹“å±•åŒ…

- ç¬¬äºŒæ­¥ï¼šé‡‡ç”¨ `AddDb<TDbContext>` æ–¹å¼æ³¨å†Œ

ç¡®ä¿æ•°æ®åº“ä¸Šä¸‹æ–‡é‡‡ç”¨ `AddDb<TDbContext>` æ³¨å†Œè€Œé `AddDbPool<TDbContext>`ã€‚

- ç¬¬ä¸‰æ­¥ï¼šé‡å†™ `OnConfiguring` æ–¹æ³•

```cs showLineNumbers  {13,15}
using Furion.DatabaseAccessor;
using Microsoft.EntityFrameworkCore;

namespace Furion.EntityFramework.Core
{
    [AppDbContext("Sqlite3ConnectionString", DbProvider.Sqlite)]
    public class DefaultDbContext : AppDbContext<DefaultDbContext>
    {
        public DefaultDbContext(DbContextOptions<DefaultDbContext> options) : base(options)
        {
        }

        protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
        {
            optionsBuilder.UseLazyLoadingProxies()
                          .UseSqlite(DbProvider.GetConnectionString<DefaultDbContext>());

            base.OnConfiguring(optionsBuilder);
        }
    }
}
```

:::note å°çŸ¥è¯†

æ›´å¤š `EFCore` æ‡’åŠ è½½å¯æŸ¥çœ‹ **[ã€EFCore - å»¶è¿ŸåŠ è½½ã€‘](https://docs.microsoft.com/zh-cn/ef/core/querying/related-data/lazy)** æ–‡æ¡£ã€‚

:::

## 9.2.13 `Db` é™æ€ç±»è·å–ä¸Šä¸‹æ–‡

`Db` é™æ€ç±»æä¾›äº†å¤šç§è·å– `DbContext` ä¸Šä¸‹æ–‡çš„æ–¹æ³•ï¼Œå¦‚ï¼š

```cs showLineNumbers {2,5-6,9,12-13}
// è·å–é»˜è®¤æ•°æ®åº“ä¸Šä¸‹æ–‡
var dbContext = Db.GetDbContext();

// è·å–å®šä½å™¨æ•°æ®åº“ä¸Šä¸‹æ–‡
var locatorDbContext = Db.GetDbContext<TDbContextLocator>();
var locatorDbContext2 = Db.GetDbContext(typeof(TDbContextLocator));

// åˆ›å»ºæ–°çš„é»˜è®¤æ•°æ®åº“ä¸Šä¸‹æ–‡ï¼ˆç›¸å½“äº new YourDbContextï¼‰
using var dbContext = Db.GetNewDbContext(); // åˆ«å¿˜è®° usingï¼ŒFurion 4.8.8.55+ ç‰ˆæœ¬æœ‰æ•ˆ

// åˆ›å»ºæ–°çš„å®šä½å™¨æ•°æ®åº“ä¸Šä¸‹æ–‡ï¼ˆç›¸å½“äº new YourDbContextï¼‰
using var locatorDbContext = Db.GetNewDbContext<TDbContextLocator>(); // åˆ«å¿˜è®° usingï¼ŒFurion 4.8.8.55+ ç‰ˆæœ¬æœ‰æ•ˆ
using var locatorDbContext2 = Db.GetNewDbContext(typeof(TDbContextLocator)); // åˆ«å¿˜è®° usingï¼ŒFurion 4.8.8.55+ ç‰ˆæœ¬æœ‰æ•ˆ
```

:::caution ç‰¹åˆ«æ³¨æ„

é»˜è®¤æƒ…å†µä¸‹ `Db.GetDbContext(...)` åˆ›å»ºæ•°æ®åº“ä¸Šä¸‹æ–‡çš„ä½œç”¨åŸŸå’Œ `Web` ç›¸åŒï¼Œ**å¦‚æœæ‚¨åœ¨åå°çº¿ç¨‹æˆ–å¤šçº¿ç¨‹ä¸­ä½¿ç”¨ï¼Œé‚£ä¹ˆå¿…é¡»ä¼ å…¥ç¬¬äºŒä¸ª `serviceProvider` å‚æ•°ã€‚**

**ä¹Ÿå¯ä»¥é€šè¿‡ `Db.GetNewDbContext(...)` çš„æ–¹å¼è·å–ä¸€ä¸ªæ–°çš„æ•°æ®åº“ä¸Šä¸‹æ–‡ï¼Œä½†æ˜¯éœ€è¦æ‰‹åŠ¨ `using` é‡Šæ”¾ã€‚**

:::

## 9.2.14 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::

---

:::note äº†è§£æ›´å¤š

æƒ³äº†è§£æ›´å¤š `æ•°æ®åº“ä¸Šä¸‹æ–‡` çŸ¥è¯†å¯æŸ¥é˜… [EF Core - é…ç½® DbContext](https://docs.microsoft.com/zh-cn/ef/core/miscellaneous/configuring-dbcontext) ç« èŠ‚ã€‚

:::
