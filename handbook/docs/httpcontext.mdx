---
id: httpcontext
title: 5.2 HttpContext
sidebar_label: 5.2 HttpContext
description: å’Œå®¢æˆ·ç«¯äº¤äº’ï¼Œæ²¡å®ƒçœŸä¸è¡Œ
---

import useBaseUrl from "@docusaurus/useBaseUrl";

import Tag from "@site/src/components/Tag.js";

<details>
  <summary>ğŸ“ æ¨¡å—æ›´æ–°æ—¥å¿—</summary>
  <div>
<div>

- **é—®é¢˜ä¿®å¤**

  - &nbsp;<Tag>ä¿®å¤</Tag> å¯ç”¨è¯·æ±‚ `Body` é‡å¤è¯»ä¸”åœ¨æˆæƒä¹‹å‰è¯»å–å¯¼è‡´é `GET/HEAD/OPTION` è¯·æ±‚å¼‚å¸¸ <sup>4.8.7.15</sup> <sup>â±ï¸2023.03.19</sup> [#I6NX9E](https://gitee.com/dotnetchina/Furion/issues/I6NX9E)

</div>
  </div>
</details>

## 5.2.1 å…³äº `HttpContext`

åœ¨ `ASP.NET` çš„æ—¶ä»£ï¼Œæˆ‘ä»¬é€šå¸¸é€šè¿‡ `HttpContext` å…¨å±€é™æ€ç±»è·å–è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œä½†åœ¨ `ASP.NET Core` ä¸­ï¼Œ`HttpContext` æ˜¯ä¸€ä¸ªéé™æ€çš„æŠ½è±¡ç±»ï¼Œæ— æ³•æ‰‹åŠ¨åˆ›å»ºï¼Œä¹Ÿæ— æ³•é€šè¿‡é™æ€è·å–ã€‚

è™½ç„¶åœ¨ `ASP.NET Core` ä¸­æ— æ³•ç›´æ¥è·å– `HttpContext` å¯¹è±¡ã€‚ä½†æ˜¯å¾®è½¯ä¹Ÿæä¾›äº†æ³¨å…¥ `IHttpContextAccessor` æ–¹å¼è·å–ã€‚

## 5.2.2 è·å– `HttpContext`

`ASP.NET Core` å’Œ `Furion` æä¾›äº†å¤šç§è®¿é—® `HttpContext` çš„æ–¹å¼ã€‚

### 5.2.2.1 åœ¨ `ControllerBase` æ´¾ç”Ÿç±»ä¸­

åœ¨ `ControllerBase` æ´¾ç”Ÿç±»ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ `HttpContext` å±æ€§è·å– `HttpContext` å¯¹è±¡ã€‚

```cs showLineNumbers {5-6}
public class HomeController : Controller
{
    public IActionResult Index()
    {
        // åœ¨è¿™é‡ŒHttpContext æ˜¯ Controller/ControllerBase å¯¹è±¡çš„å±æ€§
        var httpContext = HttpContext;

        return View();
    }
}
```

### 5.2.2.2 æ³¨å…¥ `IHttpContextAccessor`

åœ¨ `Furion` æ¡†æ¶ä¸­ï¼Œé»˜è®¤å·²ç»æ³¨å†Œäº† `IHttpContextAccessor` æœåŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥è¯¥æ¥å£è·å–ã€‚

```cs showLineNumbers  {3,5}
public class AppService
{
    public AppService(IHttpContextAccessor httpContextAccessor)
    {
        var httpContext = httpContextAccessor.HttpContext;
    }
}
```

### 5.2.2.3 é€šè¿‡ `App.HttpContext`

`App` é™æ€ç±»ä¹Ÿæä¾›äº† `App.HttpContext` è·å– `HttpContext` å¯¹è±¡ã€‚

```cs showLineNumbers
var request = App.HttpContext.Request;
```

:::tip é `Web` ä¸­è®¿é—®

åœ¨ `Web` å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œ`App.HttpContext` éƒ½æ˜¯æœ‰æ•ˆçš„ï¼Œä½†åœ¨é `Web` ä¸­è¿”å› `null`ï¼Œé¿å…åœ¨å¤šçº¿ç¨‹ï¼Œäº‹ä»¶æ€»çº¿ï¼Œå®šæ—¶ä»»åŠ¡ç­‰ä¸­ä½¿ç”¨ã€‚

:::

## 5.2.3 `HttpContext` æ‹“å±•æ–¹æ³•

`Furion` æ¡†æ¶åŸºäº `HttpContext` æä¾›äº†ä¸€äº›å¸¸ç”¨çš„æ‹“å±•æ–¹æ³•ã€‚

### 5.2.3.1 è·å–å½“å‰è¯·æ±‚çš„ç‰¹æ€§ `Attribute`

ä¸‹åˆ—ä»£ç é€šå¸¸ç”¨äºæˆæƒ `Handler` ä¸­ã€‚

```cs showLineNumbers
var attribute = httpContext.GetMetadata<SomeAttribute>();
```

:::tip `Middleware` ä¸­é—´ä»¶è·å–ç‰¹æ€§æ–¹å¼

åœ¨ `Middleware` ä¸­é—´ä»¶ä¸­è·å–æœ‰æ‰€åŒºåˆ«ï¼Œä¸»è¦é€šè¿‡ `HttpContext` çš„ `Features` è·å–ï¼Œå¦‚ï¼š

```cs showLineNumbers
var endpointFeature = httpContext.Features.Get<IEndpointFeature>();
var attribute =  endpointFeature?.Endpoint?.Metadata?.GetMetadata<SomeAttribute>();
```

:::

### 5.2.3.2 è®¾ç½® `Swagger` è‡ªåŠ¨æˆæƒ

**`Swagger` é»˜è®¤ä¸èƒ½è®°ä½æˆæƒä¿¡æ¯ï¼Œä¸€æ—¦åˆ·æ–°æµè§ˆå™¨å°±è‡ªåŠ¨æ¸…ç©º**ï¼Œæ‰€ä»¥ `Furion` æä¾›äº†è¯¥æ‹“å±•ï¼Œå³ä½¿åˆ·æ–°æµè§ˆå™¨ä¹Ÿèƒ½ä¿æŒæˆæƒçŠ¶æ€ã€‚

```cs showLineNumbers {4-5}
// æ£€æŸ¥ç”¨æˆ·ç™»å½•å’Œç”Ÿæˆ token ä»£ç ...
// .....

// ä¹‹åè°ƒç”¨è¯¥æ‹“å±•ï¼Œè¿™æ ·å°±å¯ä»¥å®ç° Swagger åˆ·æ–°ä¹Ÿèƒ½è®°ä½ç™»å½•äº†
httpContext.SigninToSwagger("ä½ çš„token");
```

### 5.2.3.3 é€€å‡º `Swagger` æˆæƒ

é€šè¿‡åç«¯ä»£ç å¼ºåˆ¶æ€§è®© `Swagger` æˆæƒå®ç°ï¼Œ**åªé’ˆå¯¹ä¸‹ä¸€æ¬¡è¯·æ±‚æœ‰æ•ˆï¼**

```cs showLineNumbers
httpContext.SignoutToSwagger();
```

### 5.2.3.4 è·å–æœ¬åœ° IP åœ°å€

```cs showLineNumbers
// ipv4
var ipv4 = httpContext.GetLocalIpAddressToIPv4();

// ipv6
var ipv6 = httpContext.GetLocalIpAddressToIPv6();
```

### 5.2.3.5 è·å–å®¢æˆ·ç«¯ IP åœ°å€

```cs showLineNumbers
// ipv4
var ipv4 = httpContext.GetRemoteIpAddressToIPv4();

// ipv6
var ipv6 = httpContext.GetRemoteIpAddressToIPv6();
```

:::tip `Nginx/IIS` æ— æ³•è·å–æ­£ç¡®å®¢æˆ·ç«¯ `IP` é—®é¢˜

å¦‚æœæœåŠ¡å™¨ç«¯ä½¿ç”¨äº† `nginx/iis` ç­‰åå‘ä»£ç†å·¥å…·ï¼Œå¯æ·»åŠ ä»¥ä¸‹ä»£ç é…ç½®ï¼š

```cs showLineNumbers title="Startup.cs" {1,3,5-8,12}
services.Configure<ForwardedHeadersOptions>(options =>
{
    options.ForwardedHeaders = ForwardedHeaders.All;

    // è‹¥ä¸Šé¢é…ç½®æ— æ•ˆå¯å°è¯•ä¸‹åˆ—ä»£ç ï¼Œæ¯”å¦‚åœ¨ IIS ä¸­
    options.ForwardedHeaders = ForwardedHeaders.XForwardedFor | ForwardedHeaders.XForwardedProto;
    options.KnownNetworks.Clear();
    options.KnownProxies.Clear();
});

// æ³¨æ„åœ¨ Configure æœ€å‰é¢é…ç½®
app.UseForwardedHeaders();
```

:::

### 5.2.3.6 è®¾ç½®å“åº”å¤´ `Token`

```cs showLineNumbers
httpContext.SetTokensOfResponseHeaders("token", "åˆ·æ–°token");
```

## 5.2.4 è¯»å– `Body` å†…å®¹ï¼ˆé‡å¤è¯»ï¼‰

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.7.9 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`ASP.NET Core` ä¸æ”¯æŒé‡å¤è¯»å– `Body` å†…å®¹ï¼Œ`Furion` æ¡†æ¶æä¾›äº†æ‹“å±•æ–¹æ³•ï¼Œéœ€è¦æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

1. **åœ¨ `Startup.cs` çš„ `Configure` å¯ç”¨ `Body` é‡å¤è¯»åŠŸèƒ½**ï¼š

- `.NET5` ç‰ˆæœ¬ï¼š

```cs showLineNumbers {1,4}
public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    // ...
    app.EnableBuffering();
    app.UseRouting();
    // ....
}
```

- `.NET6+` ç‰ˆæœ¬ï¼š

```cs showLineNumbers {7}
var builder = WebApplication.CreateBuilder(args).Inject();
// ...
var app = builder.Build();
// ...
app.UseInject();

app.EnableBuffering();
app.MapControllers();

app.Run();
```

æ³¨æ„ï¼š`app.EnableBuffering()` å¿…é¡»åœ¨ `app.UseRouting()` æˆ– `app.MapControllers()` ä¹‹å‰æ³¨å†Œã€‚

2. **ä½¿ç”¨ `HttpContext` æˆ– `HttpRequest` æ‹“å±• `.ReadBodyContentAsync()` å³å¯**ã€‚

```cs showLineNumbers {2,5}
// HttpContext æ‹“å±•
var body = await httpContext.ReadBodyContentAsync();

// HttpRequest æ‹“å±•
var body = await httpContext.Request.ReadBodyContentAsync();
```

## 5.2.5 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::
