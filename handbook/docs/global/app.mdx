---
id: app
title: 1. App é™æ€ç±»
sidebar_label: 1. App é™æ€ç±»
---

import Tag from "@site/src/components/Tag.js";

<details>
  <summary>ğŸ“ æ¨¡å—æ›´æ–°æ—¥å¿—</summary>
  <div>
<div>

- **æ–°ç‰¹æ€§**

  - &nbsp;<Tag>æ–°å¢</Tag> `App.CompileCSharpClassCode(code)` åŠ¨æ€ç¼–è¯‘ç±»å®šä¹‰ä»£ç  <sup>4.8.8.7</sup> <sup>â±ï¸2023.04.30</sup> [fe1e8a1](https://gitee.com/dotnetchina/Furion/commit/fe1e8a1768c7020477684689b35a2a1349ec2b01)
  - &nbsp;<Tag>æ–°å¢</Tag> `App.GetServices(type)` å’Œ `App.GetServices<T>()` è·å–æœåŠ¡å®ä¾‹é›†åˆ <sup>4.8.7.33</sup> <sup>â±ï¸2023.04.03</sup> [c3e9957](https://gitee.com/dotnetchina/Furion/commit/c3e9957fd276920b3a8366eda3e347500334458e)
  - &nbsp;<Tag>æ–°å¢</Tag> `App.GetServiceLifetime(type)` è·å–æœåŠ¡æ³¨å†Œç”Ÿå‘½å‘¨æœŸç±»å‹ <sup>4.8.5.3</sup> <sup>â±ï¸2023.01.31</sup> [4a573a8](https://gitee.com/dotnetchina/Furion/commit/4a573a8934784b1d7e11f7d1fa3cfa65b5ec2b3a)
  - &nbsp;<Tag>æ–°å¢</Tag> **`App.GetThreadId()` å’Œ `App.GetTraceId()` è·å–çº¿ç¨‹ `Id` å’Œè¯·æ±‚ `TraceId`** <sup>4.8.2.4</sup> <sup>â±ï¸2022.11.29</sup> [910fc1f](https://gitee.com/dotnetchina/Furion/commit/910fc1fbad9e40245c5694f30457cd4d2ca0d630)
  - &nbsp;<Tag>æ–°å¢</Tag> **`App.GetExecutionTime(() => { /*Your Code*/ })` è·å–ä»£ç æ‰§è¡Œè€—æ—¶** <sup>4.8.2.4</sup> <sup>â±ï¸2022.11.29</sup> [5ab4b19](https://gitee.com/dotnetchina/Furion/commit/5ab4b19786e53d8934de08fd2f5430fc66c3b9a1)

- **é—®é¢˜ä¿®å¤**

  - &nbsp;<Tag>ä¿®å¤</Tag> `App.CompileCSharpClassCode(code)` è¿è¡Œæ—¶æ·»åŠ åŒ¿åç¨‹åºé›†ç¼–è¯‘å¼‚å¸¸é—®é¢˜ <sup>4.8.8.8</sup> <sup>â±ï¸2023.05.04</sup> [322ea59](https://gitee.com/dotnetchina/Furion/commit/322ea599ed58b1804e9f8ab85d7ed44882b3e5a8)

</div>
  </div>
</details>

## 1.1 è·å–å…¨å±€é…ç½®

```cs showLineNumbers
var settings = App.Settings;
```

## 1.2 è·å–é…ç½®å¯¹è±¡

```cs showLineNumbers {1,6,9}
// è·å– IConfiguration å¯¹è±¡
var configuration = App.Configuration;
var value = configuration["xxx:xxx"];

// è·å–æŒ‡å®šèŠ‚ç‚¹å€¼å¹¶è½¬æˆ T ç±»å‹
var data = App.GetConfig<TConfig>("key:key2");

// é‡è½½/åˆ·æ–°é…ç½®
App.Configuration.Reload();
```

## 1.3 è·å–ç¯å¢ƒå¯¹è±¡

```cs showLineNumbers
var webHostEnvironment = App.HostEnvironment;
```

## 1.4 è·å–é¡¹ç›®æ‰€æœ‰ç¨‹åºé›†

```cs showLineNumbers
var assemblies = App.Assemblies;
```

## 1.5 è·å–é¡¹ç›®æ‰€æœ‰æœ‰æ•ˆç±»å‹

```cs showLineNumbers
var types = App.EffectiveTypes;
```

## 1.6 è·å– `HttpContext`

```cs showLineNumbers
var httpContext = App.HttpContext;
```

## 1.7 è·å–ç™»å½•çš„ `User` å¯¹è±¡

```cs showLineNumbers
var contextUser = App.User;

// è·å– `Jwt` å­˜å‚¨çš„ä¿¡æ¯
var userId = App.User?.FindFirstValue("é”®");
```

**æ³¨æ„å¼•å…¥ `System.Security.Claims` å‘½åç©ºé—´**

## 1.8 è·å–æœåŠ¡æä¾›å™¨

```cs showLineNumbers
var serviceProvider = App.ServiceProvider;

// è·å–æ ¹æœåŠ¡ï¼Œé€šå¸¸ç”¨æ¥è§£æå•ä¾‹ï¼Œå¯ä¼˜åŒ–æ€§èƒ½
var rootService = App.RootServices;
```

## 1.9 è§£ææœåŠ¡

```cs showLineNumbers
var service = App.GetService<TService>([IServiceProvider]);
var service2 = App.GetService(typeof(TService), [IServiceProvider]);

var service3 = App.GetRequiredService<TService>([IServiceProvider]);
var service4 = App.GetRequiredService(typeof(TService), [IServiceProvider]);

// Furion 4.8.7.33+ æ”¯æŒ
var services = App.GetServices<TService>([IServiceProvider]);
var services = App.GetServices(typeof(TService), [IServiceProvider]);
```

## 1.10 è·å–é€‰é¡¹é…ç½®

```cs showLineNumbers
var options = App.GetOptions<TOptions>([IServiceProvider]);
var options2 = App.GetOptionsMonitor<TOptions>([IServiceProvider]);
var options3 = App.GetOptionsSnapshot<TOptions>([IServiceProvider]);
```

## 1.11 æ‰“å°æ•°æ®åˆ° `MiniProfiler`

```cs showLineNumbers
App.PrintToMiniProfiler("åˆ†ç±»", "çŠ¶æ€", "è¦æ‰“å°çš„æ¶ˆæ¯");
```

## 1.12 è·å–åº”ç”¨åç§°

```cs showLineNumbers
var applicationName = App.HostEnvironment.ApplicationName;
```

## 1.13 è·å–å¯åŠ¨é¡¹ç›®æ ¹ç›®å½•

```cs showLineNumbers
var webRootPath = App.HostEnvironment.ContentRootPath;
```

## 1.14 è·å–ç½‘ç«™æ ¹ç›®å½• `wwwroot` ç›®å½•

```cs showLineNumbers
var wwwroot = App.WebHostEnvironment.WebRootPath;
```

æ³¨æ„ï¼šå¯èƒ½ä¸ªåˆ«æ“ä½œç³»ç»Ÿè·å–å€¼ä¸º `null`ã€‚

## 1.15 è·å–å¯åŠ¨é¡¹ç›®æ‰€åœ¨ç¨‹åºé›†

```cs showLineNumbers
var webAssembly = Assembly.GetEntryAssembly();
```

## 1.16 è·å–å¯åŠ¨é¡¹ç›® `bin` ç›®å½•

```cs showLineNumbers
var binPath = AppContext.BaseDirectory;
```

## 1.17 è·å–ç¯å¢ƒå˜é‡å

```cs showLineNumbers
var environmentName = App.HostEnvironment.EnvironmentName;
```

## 1.18 åˆ¤æ–­ç³»ç»Ÿç¯å¢ƒ

```cs showLineNumbers {2,5,8,11}
// åˆ¤æ–­æ˜¯å¦å¼€å‘ç¯å¢ƒ
var isDevelopment = App.HostEnvironment.IsDevelopment();

// åˆ¤æ–­æ˜¯å¦ç”Ÿäº§ç¯å¢ƒ
var isProduction = App.HostEnvironment.IsProduction();

// åˆ¤æ–­æ˜¯å¦ Stage ç¯å¢ƒ
var isStaging = App.HostEnvironment.IsStaging();

// åˆ¤æ–­æ˜¯å¦æ˜¯ç‰¹å®šç¯å¢ƒï¼Œæ¯”å¦‚è‡ªå®šä¹‰æµ‹è¯•ç¯å¢ƒ
var isTest = App.HostEnvironment.IsEnvironment("TestEnvironment");
```

**æ³¨æ„ï¼Œéœ€å¼•ç”¨ `Microsoft.Extensions.Hosting` å‘½åç©ºé—´**

## 1.19 è·å–æœåŠ¡å™¨ä¿¡æ¯

```cs showLineNumbers {2,5,8,11}
// è·å–ç³»ç»Ÿæ¶æ„
var osArchitecture = RuntimeInformation.OSArchitecture; // => X64

// è·å–ç³»ç»Ÿåç§°
var osDescription = RuntimeInformation.OSDescription;   // => Windows 10 ä¼ä¸šç‰ˆ

// è·å–è¿›ç¨‹æ¶æ„
var processArchitecture = RuntimeInformation.ProcessArchitecture;   // => X64

// æ˜¯å¦æ˜¯64ä½æ“ä½œç³»ç»Ÿ
var is64BitOperatingSystem = Environment.Is64BitOperatingSystem;    // => True
```

## 1.20 è·å–æ¡†æ¶åº•å±‚æ‰€æœ‰æœªæ‰˜ç®¡å¯¹è±¡

```cs showLineNumbers
var objs = App.UnmanagedObjects;
```

## 1.21 æ‰‹åŠ¨é‡Šæ”¾éæ‰˜ç®¡å¯¹è±¡

```cs showLineNumbers
App.DisposeUnmanagedObjects();  // é€šå¸¸åœ¨é `Web` ç¯å¢ƒä¸­æ‰‹åŠ¨å¤„ç†é‡Šæ”¾æ—¶æœº
```

## 1.22 åˆ¤æ–­æ˜¯å¦æ˜¯å•æ–‡ä»¶ç¯å¢ƒ

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 3.6.8 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

```cs showLineNumbers
bool isSingleFileEnviroment = App.SingleFileEnvironment;
```

## 1.23 è§£æå‘½ä»¤è¡Œå‚æ•°

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.4.5 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

```cs showLineNumbers
var cmdConfig = App.GetCommandLineConfiguration(args);
cmdConfig.TryGet("å‚æ•°", out var value);
```

## 1.24 è·å–å½“å‰çº¿ç¨‹ `Id`

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.2.4 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

```cs showLineNumbers
var threadId = App.GetThreadId();
```

## 1.25 è·å–å½“å‰è¯·æ±‚ `TraceId`

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.2.4 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

```cs showLineNumbers
var traceId = App.GetTraceId();
```

## 1.26 è·å–ä»£ç æ‰§è¡Œè€—æ—¶

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.2.4 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

```cs showLineNumbers
var elapsedMilliseconds = App.GetExecutionTime(() =>
{
    Console.WriteLine("Hello, Furion");
});
```

## 1.27 è·å–æœåŠ¡æ³¨å†Œç”Ÿå‘½å‘¨æœŸç±»å‹

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.5.3 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

```cs showLineNumbers
var lifetime = App.GetServiceLifetime(typeof(IConfiguration));  // => ServiceLifetime.Singleton
var license = App.GetServiceLifetime(typeof(IRepository<Person>));  // => ServiceLifetime.Scoped
```

## 1.28 åŠ¨æ€ç¼–è¯‘ç±»å®šä¹‰ä»£ç 

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 4.8.8.7 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

```cs showLineNumbers {1,28}
var jobAssembly = App.CompileCSharpClassCode(@"
using Furion.Schedule;
using Microsoft.Extensions.Logging;
using System;
using System.Threading;
using System.Threading.Tasks;

namespace YourProject;

public class MyJob : IJob
{
    private readonly ILogger<MyJob> _logger;

    public MyJob(ILogger<MyJob> logger)
    {
        _logger = logger;
    }

    public async Task ExecuteAsync(JobExecutingContext context, CancellationToken stoppingToken)
    {
        _logger.LogInformation($""æˆ‘æ˜¯ Roslyn æ–¹å¼åˆ›å»ºçš„ï¼š{context}"");
        await Task.CompletedTask;
    }
}
");

// ç”Ÿæˆè¿è¡Œæ—¶ MyJob ç±»å‹
var jobType = jobAssembly.GetType("YourProject.MyJob");
```

- æ”¯æŒè¿”å› `MemoryStream` å¯¹è±¡

```cs showLineNumbers {2}
// è¿”å›å†…å­˜
var memoryStream = App.CompileCSharpClassCodeToStream("C# ç±»å®šä¹‰ä»£ç ");

// è½¬æ¢æˆç¨‹åºé›†
var assembly = Assembly.Load(memoryStream.ToArray());
```

- æ”¯æŒä¿å­˜ä¸º `dll` æ–‡ä»¶

```cs showLineNumbers {2}
// ä¿å­˜ä¸º .dll æ–‡ä»¶å¹¶è¿”å›ç¨‹åºé›†
var assembly = App.CompileCSharpClassCodeToDllFile("C# ç±»å®šä¹‰ä»£ç ");
```
