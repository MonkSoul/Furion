---
id: dbcontext-add
title: 9.6 æ–°å¢æ“ä½œ
sidebar_label: 9.6 æ–°å¢æ“ä½œ
---

import Tag from "@site/src/components/Tag.js";

<details>
  <summary>ğŸ“ æ¨¡å—æ›´æ–°æ—¥å¿—</summary>
  <div>
<div>

- **é—®é¢˜ä¿®å¤**

  - &nbsp;<Tag>ä¿®å¤</Tag> å®ä½“æ‹“å±•æ–¹å¼æ“ä½œæ•°æ®åº“å‡ºç°ç©ºå¼‚å¸¸é—®é¢˜ <sup>4.8.5</sup> <sup>â±ï¸2023.01.28</sup> [#I6AXU6](https://gitee.com/dotnetchina/Furion/issues/I6AXU6)

</div>
  </div>
</details>

`Furion` æ¡†æ¶æä¾›éå¸¸å¤šçš„è¯­æ³•ç³–è¿›è¡Œæ•°æ®åº“æ“ä½œã€‚

## 9.6.1 æ–°å¢ä¸€æ¡ï¼Œæ— è¿”å›å€¼

```cs showLineNumbers
var user = new User { Name = "ç™¾å°åƒ§", Age = 27 };

// ==== åŒæ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
repository.Insert(user);

// ç¤ºä¾‹äºŒ
user.Insert();

// ç¤ºä¾‹ä¸‰
repository.Entities.Add(user);

// ç¤ºä¾‹å››
repository.ChangeEntityState(user, EntityState.Added);

// ==== å¼‚æ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
await repository.InsertAsync(user);

// ç¤ºä¾‹äºŒ
await user.InsertAsync();

// ç¤ºä¾‹ä¸‰
await repository.Entities.AddAsync(user);

```

## 9.6.2 æ–°å¢ä¸€æ¡ï¼Œè¿”å›æœ€æ–°æ•°æ®

```cs showLineNumbers
// ==== åŒæ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
var newEntity = repository.InsertNow(user);

// ç¤ºä¾‹ä¸‰
var newEntity = user.InsertNow();

// ==== å¼‚æ­¥æ“ä½œ ====

// ç¤ºä¾‹äºŒ
var newEntity = await repository.InsertNowAsync(user); // æœ‰ä¸‰ä¸ªé‡è½½

// ç¤ºä¾‹å››
var newEntity = await user.InsertNowAsync();  // æœ‰ä¸‰ä¸ªé‡è½½
```

## 9.6.3 æ–°å¢å¤šæ¡ï¼ˆä¸ç«‹å³æäº¤ï¼‰

```cs showLineNumbers
// ==== åŒæ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
repository.Insert(user, user2);

// ç¤ºä¾‹äºŒ
repository.Insert(new List<User> { user, user2 });

// ç¤ºä¾‹ä¸‰
repository.Insert(new[] {user, user2 });

// ==== å¼‚æ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
await repository.InsertAsync(user, user2);

// ç¤ºä¾‹äºŒ
await repository.InsertAsync(new List<User> { user, user2 });

// ç¤ºä¾‹ä¸‰
await repository.InsertAsync(new[] {user, user2 });
```

## 9.6.4 æ–°å¢å¤šæ¡ï¼ˆç«‹å³æäº¤ï¼‰

```cs showLineNumbers
// ==== åŒæ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
repository.InsertNow(user, user2);

// ç¤ºä¾‹äºŒ
repository.InsertNow(new List<User> { user, user2 });

// ç¤ºä¾‹ä¸‰
repository.InsertNow(new[] {user, user2 });

// ==== å¼‚æ­¥æ“ä½œ ====

// ç¤ºä¾‹ä¸€
await repository.InsertNowAsync(user, user2);

// ç¤ºä¾‹äºŒ
await repository.InsertNowAsync(new List<User> { user, user2 });

// ç¤ºä¾‹ä¸‰
await repository.InsertNowAsync(new[] {user, user2 });
```

:::tip å°çŸ¥è¯†

æ‰€æœ‰å¸¦ `Now` ç»“å°¾çš„è¡¨ç¤ºç«‹å³æäº¤åˆ°æ•°æ®åº“ï¼Œä¹Ÿå°±æ˜¯ç«‹å³è°ƒç”¨ `SaveChanges` æˆ– `SaveChangesAsync`ã€‚

:::

## 9.6.5 å¿½ç•¥ç©ºå€¼æ–°å¢

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`EFCore` æ–°å¢ä¼šæ’å…¥å…¨éƒ¨åˆ—ï¼ˆé™¤å®ä½“è·Ÿè¸ªæ–¹å¼ä»¥å¤–ï¼‰ï¼Œæœ‰äº›æ—¶å€™æˆ‘ä»¬å¸Œæœ› `Null` å€¼æ— éœ€æ’å…¥ï¼Œè¿™æ˜¯æˆ‘ä»¬åªéœ€è¦åœ¨æ›´æ–°æ—¶å€™é…ç½® `ignoreNullValues` å‚æ•°å³å¯ï¼Œå¦‚ï¼š

```cs showLineNumbers
repository.Insert(entity, ignoreNullValues: true);
```

æ³¨æ„ï¼š`EFCore` è¿˜æ˜¯ä¼šå¯¹ `NULL` å€¼åˆ—ç”Ÿæˆ `SQL` è¯­å¥ã€‚

ä¹Ÿå¯ä»¥å…¨å±€é…ç½®ï¼Œåœ¨ `AppDbContext` çš„æ´¾ç”Ÿç±»çš„æ„é€ å‡½æ•°ä¸­å¯ç”¨å³å¯ï¼š

```cs showLineNumbers  {11}
using Furion.DatabaseAccessor;
using Microsoft.EntityFrameworkCore;

namespace Furion.EntityFramework.Core
{
    [AppDbContext("Sqlite3ConnectionString", DbProvider.Sqlite)]
    public class DefaultDbContext : AppDbContext<DefaultDbContext>
    {
        public DefaultDbContext(DbContextOptions<DefaultDbContext> options) : base(options)
        {
            InsertOrUpdateIgnoreNullValues = true;
        }
    }
}
```

## 9.6.6 è¡¨å¸¦è§¦å‘å™¨å¼‚å¸¸è§£å†³

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ•°æ®åº“è¡¨å­˜åœ¨è§¦å‘å™¨ï¼Œè¿™æ—¶å€™å¯èƒ½ä¼šå‡ºç°ä¸‹åˆ—å¼‚å¸¸ï¼š

```txt showLineNumbers
Microsoft.EntityFrameworkCore.DbUpdateException:
    Could not save changes because the target table has database triggers.
    Please configure your entity type accordingly,
    see https://aka.ms/efcore-docs-sqlserver-save-changes-and-triggers for more information.
```

è¿™æ—¶æˆ‘ä»¬åªéœ€è¦æ·»åŠ  `HasTrigger` å³å¯ï¼Œå¦‚ï¼š

```cs showLineNumbers {3}
public void Configure(EntityTypeBuilder<YourEntity> entityBuilder, DbContext dbContext, Type dbContextLocator)
{
    entityBuilder.ToTable(tb => tb.HasTrigger("TriggerName")); // æ ‡è®°æ•°æ®åº“è¡¨å­˜åœ¨è§¦å‘å™¨ï¼Œè§¦å‘å™¨åç§°å¯éšæ„
}
```

ç›¸å…³ Issue [https://gitee.com/dotnetchina/Furion/issues/I5S4EC](https://gitee.com/dotnetchina/Furion/issues/I5S4EC)

## 9.6.7 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::
