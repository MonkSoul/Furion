---
id: deploy-docker-auto
title: 35.1 Docker ç¯å¢ƒæŒç»­éƒ¨ç½²
sidebar_label: 35.1 Docker ç¯å¢ƒæŒç»­éƒ¨ç½²
---

import useBaseUrl from "@docusaurus/useBaseUrl";

## 35.1.1 å…³äºå…¨ `Docker` ç¯å¢ƒéƒ¨ç½²

åˆ©ç”¨æ‹¥æœ‰ `.NET` ç¯å¢ƒçš„ `Jenkins`ï¼Œè¿›è¡ŒæŒç»­åŒ–éƒ¨ç½²

## 35.1.2 å®‰è£… `Docker` ç‰ˆ `Jenkins`

æ­£å¸¸åœ¨ `Docker` ä¸­æ‹‰å–çš„ `Jenkins:lts` æ˜¯æ— æ³•æ‰§è¡Œ `dotnet` å‘½ä»¤çš„ï¼ˆå°±ç®—ä½ å®¿ä¸»æœºæœ‰ `dotnet` ç¯å¢ƒã€`docker` ä¸­ä¹Ÿæœ‰ `dotnet` ç¯å¢ƒä¹Ÿä¸å¯ä»¥ï¼‰ï¼Œ
æ‰€ä»¥æˆ‘ä»¬åªèƒ½æ„å»ºä¸€ä¸ªåŒ…å« `dotnet` çš„é•œåƒ

### 35.1.2.1 ä½¿ç”¨ Dockerfile åˆ¶ä½œé•œåƒ

ä½¿ç”¨ `Dockerfile` åˆ›å»ºåŒ…å« `dotnet` çš„ `Jenkins` é•œåƒ

- ğŸ‘‰ ç¼–å†™ `Dockerfile`

```bash showLineNumbers
# å°è£…Jenkinsé•œåƒï¼ˆå¸¦æœ‰dotnetç¯å¢ƒçš„ï¼‰ sdk=5.1
FROM jenkins/jenkins:lts
USER root
WORKDIR /dotnet
RUN apt-get update && apt-get install -y wget && rm -rf /var/lib/apt/lists/*
RUN wget -O dotnet.tar.gz https://download.visualstudio.microsoft.com/download/pr/820db713-c9a5-466e-b72a-16f2f5ed00e2/628aa2a75f6aa270e77f4a83b3742fb8/dotnet-sdk-5.0.100-linux-x64.tar.gz
RUN tar zxf dotnet.tar.gz -C ./
RUN rm -rf dotnet.tar.gz
ENV PATH="${PATH}:/dotnet:/var/jenkins_home/.dotnet/tools"
ENV DOTNET_ROOT="/dotnet"
RUN apt update -y
RUN apt install icu-devtools vim zip unzip -y
RUN usermod -a -G root jenkins
USER jenkins
```

- ğŸ‘‰ å‘½ä»¤è§£é‡Š

```bash showLineNumbers
- 1. è¿™ä¸ªDockeré•œåƒåŸºäºjenkins
- 2. è®¾ç½®å½“å‰ç”¨æˆ·ä¸ºrootï¼Œå› ä¸ºåé¢å®‰è£…éœ€è¦ä½¿ç”¨root
- 3. è®¾ç½®å½“å‰å·¥ä½œç›®å½•ä¸ºdotnet
- 4. ä¸‹è½½dotnet SDKåŒ…ï¼Œä¿å­˜ä¸ºdotnet.tar.gzã€‚è¿™é‡Œè¦æ³¨æ„ä¸‹è½½æ­£ç¡®ç‰ˆæœ¬çš„SDKï¼Œå¯å‰å¾€å¾®è½¯å®˜æ–¹ç½‘ç«™è·å–ä¸‹è½½é“¾æ¥ï¼šhttps://dotnet.microsoft.com/download
- 5. è§£å‹dotnet SDKåˆ°å½“å‰ç›®å½•ï¼Œå³/dotnetç›®å½•
- 6. åˆ é™¤dotnet SDKåŒ…
- 7. æŠŠdotnetç›®å½•å’Œdotnet toolsç›®å½•æ·»åŠ åˆ°ç¯å¢ƒå˜é‡PATHï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨dotnetå‘½ä»¤äº†
- 8. è®¾ç½®DOTNET_ROOTå˜é‡
- 9. æ›´æ–°æº
- 10. å®‰è£…ä¸€äº›å¿…éœ€çš„ï¼Œå¸¸ç”¨çš„å·¥å…·åŒ…ï¼Œå…¶ä¸­icu-devtoolsæ˜¯è¿è¡Œdotnetéœ€è¦çš„
- 11. ä¿®æ”¹jenkinsç”¨æˆ·åˆ°rooté™„åŠ ç»„
- 12. è®¾ç½®å½“å‰ç”¨æˆ·ä¸ºjenkins
```

- ğŸ‘‰ æ„å»º `Docker` é•œåƒ `name=jenkins:dotnet`

`cd` åˆ°æ ¹ç›®å½•ä¸‹ï¼ˆå¿…é¡»å« `Dockerfile`ï¼‰ åªéœ€æ„å»ºå‘½ä»¤ï¼š

```bash showLineNumbers
 docker build -t jenkins:dotnet .
```

:::important ç‰¹åˆ«æ³¨æ„

ç»“å°¾ `.` ä¸èƒ½çœç•¥

:::

### 35.1.2.2 è¿è¡Œ `Jenkins:dotnet` é•œåƒ

```bash showLineNumbers
docker run -d -p 8080:8080 -p 50000:50000 --name mjenkins  \
           --privileged=true \
           --restart always \
           -u root \
           -e TZ="Asia/Shanghai" \
           -v /mudata/jenkins:/var/jenkins_home \
           -v /usr/bin/docker:/usr/bin/docker \
           -v /var/run/docker.sock:/var/run/docker.sock \
           -v /mudata/webroot/:/mudata/webroot \
           jenkins:dotnet
```

æ¥ä¸‹æ¥å°±æ˜¯æ¯”è¾ƒä¿—å¥—çš„å®‰è£… `Jenkins` æ­¥éª¤ï¼Œç½‘ä¸Šèµ„æ–™å¾ˆå¤šï¼Œä¸å±•å¼€äº†ã€‚

## 35.1.3 `Jenkins` çš„è‡ªåŠ¨åŒ–éƒ¨ç½²

### 35.1.3.1 ç¼–å†™ Shell è„šæœ¬

```bash showLineNumbers
# Jenkins æ„å»º æµ‹è¯•æœ

echo '============æŸ¥çœ‹æ‰“åŒ…ç¯å¢ƒ================'
pwd
ls
echo $PATH

image_version=`date +%Y%m%d%H%M`;
echo $image_version;

dotnet --info
dotnet --version

# è·å–çŸ­ç‰ˆæœ¬å·
GITHASH=`git rev-parse --short HEAD`

echo '============================begin restore======================================='
dotnet restore
echo '============================end restore======================================='

#è¦æ„å»ºçš„è§£å†³æ–¹æ¡ˆåç§°
solutionName=MUSaas.SCM.BasicData
#docker runçš„å®¹å™¨åç§°
containerName=jenkinsscmbasic
#æŒ‡å®šrunçš„ç«¯å£
port=9994
#.slnæ–‡ä»¶å…¨è·¯å¾„
#solutionDir=20-Solution/${solutionName}.sln
#.csprojæ–‡ä»¶å…¨è·¯å¾„
csprojDir=${solutionName}/${solutionName}.csproj

#é¡¹ç›®å‘å¸ƒçš„ç›®å½•
webDir=/mudata/webroot/jenkins/publish/webapp

#å½’æ¡£ç›®å½•
archivesDir=/mudata/webroot/jenkins/publish/archives

#æ¸…ç©ºæ–‡ä»¶å¤¹
rm -rf ${webDir}/${JOB_NAME}/*

#å‘å¸ƒç½‘ç«™åˆ°webDir
dotnet publish ${JENKINS_HOME}/workspace/${JOB_NAME}/${csprojDir} -c Release -o ${webDir}/${JOB_NAME} /p:Version=1.0.${BUILD_NUMBER}
#å¤åˆ¶é…ç½®æ–‡ä»¶
#cp -rf /vdb1/jenkins/DotNetCoreWebPublishToDockerCommonConfigs/* ${webDir}/${JOB_NAME}/

#åˆ¤æ–·æ˜¯å¦å­˜åœ¨
CID=$(docker ps | grep "${containerName}" | awk '{print $1}')
echo $CID
if [ "$CID" != "" ];then
    docker stop ${containerName}
    docker rm ${containerName}
    docker rmi ${containerName}
#docker stop $CID
#docker rm $CID
fi


#é€šè¿‡Dockerfileé‡æ–°æ„å»ºé•œåƒ
docker build -t ${containerName} ${webDir}/${JOB_NAME}/.
#docker runå®¹å™¨å¹¶ç»‘å®šåˆ°ç«¯å£
#docker run -d -p ${port}:80 --name ${containerName} ${containerName}
docker run --name ${containerName} --restart=always -d -p ${port}:${port} -v /etc/localtime:/etc/localtime:ro ${containerName}
echo "success!"

```

> å°±è¿™æ ·è‡ªåŠ¨åŒ–éƒ¨ç½²å°±å¥½äº†ã€‚ æµ‹è¯•æœçš„ `Jenkins` å°†æºç æ‹‰ä¸‹æ¥ï¼Œ`Publishï¼ŒDocker Buildï¼ŒDocker Run`ã€‚

> è¿™é‡Œæƒ³è¦å‘å¸ƒçš„æ—¶å€™ï¼Œæ¯æ¬¡éƒ½éœ€è¦æ‰‹åŠ¨å»ç‚¹å‡»â€œæ„å»ºâ€æ‰ä¼šæ‰§è¡Œã€‚ä¹Ÿå¯ä»¥åšæˆå½“åˆ†æ”¯åˆå¹¶æˆåŠŸåè‡ªåŠ¨è¿è¡Œã€‚åæ­£ `Jenkins` è£…å¥½ä¹‹åï¼Œä½ æƒ³è¦ä»€ä¹ˆéƒ½èƒ½ç©èµ·æ¥ã€‚æ¯”å¦‚æŒ‡å®šåˆ†æ”¯æäº¤åè‡ªåŠ¨â€œæ„å»ºâ€ã€æ¯”å¦‚æ„å»ºæˆåŠŸååˆå¹¶åˆ° Master ç­‰ç­‰

## 35.1.4 `Jenkins` çš„è‡ªåŠ¨åŒ–è¿œç¨‹éƒ¨ç½²

### 35.1.4.1 å®‰è£…æ’ä»¶

> `Publish Over SSH`

### 35.1.4.2 é…ç½®

> ç³»ç»Ÿç®¡ç† => `Publish over SSH`

### 35.1.4.3 å†™è„šæœ¬

```bash showLineNumbers
# Jenkins æ„å»º  æ­£å¼æœ

echo '============æŸ¥çœ‹æ‰“åŒ…ç¯å¢ƒ================'
pwd
ls
echo $PATH

image_version=`date +%Y%m%d%H%M`;
echo $image_version;

dotnet --info
dotnet --version

# è·å–çŸ­ç‰ˆæœ¬å·
GITHASH=`git rev-parse --short HEAD`

echo '============================begin restore======================================='
dotnet restore
echo '============================end restore======================================='

#è¦æ„å»ºçš„è§£å†³æ–¹æ¡ˆåç§°
solutionName=MUSaas.SCM.BulkOrder
#docker runçš„å®¹å™¨åç§°
containerName=jenkinsscmbulk
#æŒ‡å®šrunçš„ç«¯å£
port=9986
#.csprojæ–‡ä»¶å…¨è·¯å¾„
csprojDir=/${solutionName}/${solutionName}.csproj

#é¡¹ç›®å‘å¸ƒçš„ç›®å½•
webDir=/mudata/webroot/jenkins/publish/webapp

#å½’æ¡£ç›®å½•
archivesDir=/mudata/webroot/jenkins/publish/archives

#æ¸…ç©ºæ–‡ä»¶å¤¹
rm -rf ${webDir}/${JOB_NAME}/*

#å‘å¸ƒç½‘ç«™åˆ°webDir
dotnet publish ${JENKINS_HOME}/workspace/${JOB_NAME}/${csprojDir} -c Release -o ${webDir}/${JOB_NAME} /p:Version=1.0.${BUILD_NUMBER}
#å¤åˆ¶é…ç½®æ–‡ä»¶
#cp -rf /vdb1/jenkins/DotNetCoreWebPublishToDockerCommonConfigs/* ${webDir}/${JOB_NAME}/


#æ„å»ºè¿œç¨‹åŒ…

rm -rf ${JENKINS_HOME}/workspace/${JOB_NAME}/publish
mkdir ${JENKINS_HOME}/workspace/${JOB_NAME}/publish

tar -czvf ${JENKINS_HOME}/workspace/${JOB_NAME}/publish/${JOB_NAME}.${BUILD_NUMBER}.tar.gz -C ${webDir}/${JOB_NAME} .

echo "success!"
```

> å¤§æ¦‚é€»è¾‘å°±æ˜¯å‘å¸ƒåï¼Œæ‰“ä¸ªåŒ…ã€‚ç„¶åä¸¢ç»™è¿œç¨‹ï¼Œè¿œç¨‹å†æ‰§è¡Œ `shell`

> æ³¨æ„è¿™é‡Œä¸€å®šè¦å‘å¸ƒåˆ°è‡ªå·±çš„ `workspace` ä¸‹ï¼Œé˜²æ­¢ä¸‹ä¸€æ­¥æ­»æ´»æ‰¾ä¸åˆ°ä½ç½®ã€‚å¦‚æœæ‰¾ä¸åˆ°ä½ç½®ï¼Œåªèƒ½æ…¢æ…¢ç”¨ `ls` å‘½ä»¤ï¼Œä¸€çº§ä¸€çº§å»æµ‹ï¼Œå¾ˆéº»çƒ¦

### 35.1.4.4 æ„å»ºåæ“ä½œï¼ˆå…³é”®ï¼‰

é€‰æ‹© `Send Build artifacts over SSH`

```bash showLineNumbers
Source files: publish/
Remove prefix(ä¸å¡«)
Remote directory:/mudata/webroot/publish/
Exec command:bash /mudata/shell/publish.sh  ${JOB_NAME} jenkinsscmbase ${JOB_NAME}.${BUILD_NUMBER}  9994
```

- é€‰æ‹©è‡ªå·±çš„ SSH æœåŠ¡å™¨
- `Source files`ï¼šä¸€å®šæ˜¯ `workspace` ä¸‹çš„åœ°å€
- `Remote directory`ï¼šè¿œç¨‹åœ°å€ï¼Œä»æ ¹ç›®å½•å¼€å§‹
- `Exec command`ï¼šè¦æ‰§è¡Œçš„ shellã€‚è¿™é‡Œæ‰€æœ‰çš„ `Jenkins` ç¯å¢ƒå˜é‡éƒ½å¯ä»¥ç”¨

### 35.1.4.5 è¿œç¨‹æ‰§è¡Œ

```bash showLineNumbers  title="publish.sh"
# Jenkins Prodæœ è°ƒç”¨è„šæœ¬
solutionName=$1
containerName=$2
filename=$3
port=$4
#.publis
echo ${solutionName}
echo ${containerName}
echo ${filename}
baseDir=/mudata/webroot/publish

webDir=${baseDir}/publish/${filename}

rm -rf ${webDir}
mkdir ${webDir}

tar -zxvf ${baseDir}/publish/${filename}.tar.gz -C ${webDir}/
rm -f  ${webDir}/appsettings.json && mv  ${webDir}/appsettings.Prod.json  ${webDir}/appsettings.json

#åˆ¤æ–·æ˜¯å¦å­˜åœ¨
CID=$(docker ps | grep "${containerName}" | awk '{print $1}')
echo $CID
if [ "$CID" != "" ];then
    docker stop ${containerName}
    docker rm ${containerName}
    docker rmi ${containerName}
#docker stop $CID
#docker rm $CID
fi

cd  ${webDir}/ && docker build -t ${containerName} .
docker run --name ${containerName} --restart=always -d -p ${port}:${port} --link myredis:myredis  -v /etc/localtime:/etc/localtime:ro ${containerName}
```

> è¿™é‡Œçš„é€»è¾‘å°±æ˜¯è§£å‹ï¼Œç„¶å `Docker` ç›¸å…³ã€‚æ¯æ¬¡æ„å»ºéƒ½æ˜¯å¸¦ç€ç‰ˆæœ¬å·æ¥çš„ã€‚

## 35.1.5 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::
