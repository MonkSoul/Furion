---
id: json-serialization
title: 23. JSON åºåˆ—åŒ–
sidebar_label: 23. JSON åºåˆ—åŒ–
---

import Tag from "@site/src/components/Tag.js";

<details>
  <summary>ğŸ“ æ¨¡å—æ›´æ–°æ—¥å¿—</summary>
  <div>
<div>

- **æ–°ç‰¹æ€§**

  - &nbsp;<Tag>æ–°å¢</Tag> `System.Text.Json` å’Œ `Newtonsoft.Json` å¯¹ç²˜åœŸå¯¹è±¡ `Clay` æ”¯æŒ <sup>4.8.8.1</sup> <sup>â±ï¸2023.04.18</sup> [#I6WKRZ](https://gitee.com/dotnetchina/Furion/issues/I6WKRZ)

- **çªç ´æ€§å˜åŒ–**

  - &nbsp;<Tag>è°ƒæ•´</Tag> **`IJsonSerializerProvider` åºåˆ—åŒ–æ¥å£ï¼Œæ·»åŠ  `Deserialize` ååºåˆ—åŒ–æ–¹æ³•** <sup>4.8.8.15</sup> <sup>â±ï¸2023.05.15</sup> [!815](https://gitee.com/dotnetchina/Furion/pulls/815) æ„Ÿè°¢ [@YaChengMu](https://gitee.com/YaChengMu)

<details style={{ marginLeft: 50 }}>
  <summary>æŸ¥çœ‹å˜åŒ–</summary>
  <div>

æ·»åŠ  `25-32è¡Œ` æ¥å£æ–¹æ³•ï¼š

```cs showLineNumbers {25-32}
namespace Furion.JsonSerialization;

/// <summary>
/// Json åºåˆ—åŒ–æä¾›å™¨
/// </summary>
public interface IJsonSerializerProvider
{
    /// <summary>
    /// åºåˆ—åŒ–å¯¹è±¡
    /// </summary>
    /// <param name="value"></param>
    /// <param name="jsonSerializerOptions"></param>
    /// <returns></returns>
    string Serialize(object value, object jsonSerializerOptions = default);

    /// <summary>
    /// ååºåˆ—åŒ–å­—ç¬¦ä¸²
    /// </summary>
    /// <typeparam name="T"></typeparam>
    /// <param name="json"></param>
    /// <param name="jsonSerializerOptions"></param>
    /// <returns></returns>
    T Deserialize<T>(string json, object jsonSerializerOptions = default);

    /// <summary>
    /// ååºåˆ—åŒ–å­—ç¬¦ä¸²
    /// </summary>
    /// <param name="json"></param>
    /// <param name="returnType"></param>
    /// <param name="jsonSerializerOptions"></param>
    /// <returns></returns>
    object Deserialize(string json, Type returnType, object jsonSerializerOptions = default);

    /// <summary>
    /// è¿”å›è¯»å–å…¨å±€é…ç½®çš„ JSON é€‰é¡¹
    /// </summary>
    /// <returns></returns>
    object GetSerializerOptions();
}
```

å¦‚æœä½¿ç”¨ `Newtonsoft.Json` åˆ™åªéœ€æ·»åŠ ä»¥ä¸‹å®ç°å³å¯ï¼š

```cs showLineNumbers {8-11}
/// <summary>
/// ååºåˆ—åŒ–å­—ç¬¦ä¸²
/// </summary>
/// <param name="json"></param>
/// <param name="returnType"></param>
/// <param name="jsonSerializerOptions"></param>
/// <returns></returns>
public object Deserialize(string json, Type returnType, object jsonSerializerOptions = null)
{
    return JsonConvert.DeserializeObject(json, returnType, (jsonSerializerOptions ?? GetSerializerOptions()) as JsonSerializerSettings);
}
```

  </div>
</details>

</div>
  </div>
</details>

:::important ç‰ˆæœ¬è¯´æ˜

ä»¥ä¸‹å†…å®¹ä»…é™ `Furion 1.16.0 +` ç‰ˆæœ¬ä½¿ç”¨ã€‚

:::

## 23.1 ä»€ä¹ˆæ˜¯ `JSON`

> JSON (JavaScript Object Notation, JS å¯¹è±¡æ ‡è®°) æ˜¯ä¸€ç§è½»é‡çº§çš„æ•°æ®äº¤æ¢æ ¼å¼ã€‚å®ƒåŸºäº ECMAScript (w3c åˆ¶å®šçš„ js è§„èŒƒ)çš„ä¸€ä¸ªå­é›†ï¼Œé‡‡ç”¨å®Œå…¨ç‹¬ç«‹äºç¼–ç¨‹è¯­è¨€çš„æ–‡æœ¬æ ¼å¼æ¥å­˜å‚¨å’Œè¡¨ç¤ºæ•°æ®ã€‚ç®€æ´å’Œæ¸…æ™°çš„å±‚æ¬¡ç»“æ„ä½¿å¾— JSON æˆä¸ºç†æƒ³çš„æ•°æ®äº¤æ¢è¯­è¨€ã€‚ æ˜“äºäººé˜…è¯»å’Œç¼–å†™ï¼ŒåŒæ—¶ä¹Ÿæ˜“äºæœºå™¨è§£æå’Œç”Ÿæˆï¼Œå¹¶æœ‰æ•ˆåœ°æå‡ç½‘ç»œä¼ è¾“æ•ˆç‡ã€‚

ç®€å•æ¥è¯´ï¼ŒJSONï¼Œæ˜¯ä¸€ç§æ•°æ®æ ¼å¼ï¼Œåœ¨ä¸åç«¯çš„æ•°æ®äº¤äº’ä¸­æœ‰è¾ƒä¸ºå¹¿æ³›çš„åº”ç”¨ã€‚

## 23.2 å…³äºåºåˆ—åŒ–åº“

ç›®å‰åœ¨ C# è¯­è¨€ä¸­æœ‰ä¸¤ä¸ªä¸»æµçš„ `JSON` åºåˆ—åŒ–æ“ä½œåº“ï¼š

- `System.Text.Json`ï¼š`.NET Core` å†…ç½® `JSON` åºåˆ—åŒ–åº“ï¼Œä¹Ÿæ˜¯ `Furion` æ¡†æ¶é»˜è®¤å®ç°
- `Newtonsoft.Json`ï¼šç›®å‰ä½¿ç”¨äººæ•°æœ€å¤šçš„ `JSON` åºåˆ—åŒ–åº“ï¼Œéœ€è¦å®‰è£… `Microsoft.AspNetCore.Mvc.NewtonsoftJson` æ‹“å±•åŒ…

ç”±äºç›®å‰ `System.Text.Json` ç›¸æ¯” `Newtonsoft.Json` åŠŸèƒ½å’Œç¨³å®šæ€§æœ‰è®¸å¤šä¸è¶³ä¹‹å¤„ï¼Œæ¯”å¦‚å¾ªç¯å¼•ç”¨é—®é¢˜åœ¨ `System.Text.Json` æ— è§£ã€‚ä½†åœ¨ `.NET 6` ä¹‹åå¾—åˆ°è§£å†³ã€‚

`Furion` æ¡†æ¶ä¸ºäº†è§£å†³å¤šç§åºåˆ—åŒ–å·¥å…·é…ç½®å’Œç”¨æ³•ä¸Šçš„å·®å¼‚é—®é¢˜ï¼ŒæŠ½è±¡å‡ºäº† `IJsonSerializerProvider` æ¥å£ã€‚

## 23.3 `IJsonSerializerProvider` æ¥å£

`Furion` æ¡†æ¶æä¾›äº† `IJsonSerializerProvider` æ¥å£è§„èŒƒï¼ŒåŒæ—¶**è¦æ±‚å®ç°è¯¥æ¥å£çš„å®ä½“éƒ½å¿…é¡»é‡‡ç”¨å•ä¾‹æ¨¡å¼**ï¼Œè¯¥æ¥å£å®šä¹‰ä»£ç å¦‚ä¸‹ï¼š

```cs showLineNumbers
namespace Furion.JsonSerialization
{
    /// <summary>
    /// Json åºåˆ—åŒ–æä¾›å™¨
    /// </summary>
    public interface IJsonSerializerProvider
    {
        /// <summary>
        /// åºåˆ—åŒ–å¯¹è±¡
        /// </summary>
        /// <param name="value"></param>
        /// <param name="jsonSerializerOptions"></param>
        /// <returns></returns>
        string Serialize(object value, object jsonSerializerOptions = default);

        /// <summary>
        /// ååºåˆ—åŒ–å­—ç¬¦ä¸²
        /// </summary>
        /// <typeparam name="T"></typeparam>
        /// <param name="json"></param>
        /// <param name="jsonSerializerOptions"></param>
        /// <returns></returns>
        T Deserialize<T>(string json, object jsonSerializerOptions = default);

        /// <summary>
        /// è¿”å›è¯»å–å…¨å±€é…ç½®çš„ JSON é€‰é¡¹
        /// </summary>
        /// <returns></returns>
        object GetSerializerOptions();
    }
}
```

:::important é»˜è®¤å®ç°

`SystemTextJsonSerializerProvider` ç±»æ˜¯ `IJsonSerializerProvider` æ¥å£çš„é»˜è®¤å®ç°ï¼Œåœ¨åº”ç”¨å¯åŠ¨æ—¶å·²é»˜è®¤æ³¨å†Œã€‚

:::

## 23.4 å¦‚ä½•ä½¿ç”¨

### 23.4.1 è·å–åºåˆ—åŒ–å¯¹è±¡

`Furion` æ¡†æ¶æä¾›äº†ä¸¤ç§æ–¹å¼è·å– `IJsonSerializerProvider` å®ä¾‹ï¼š

- æ„é€ å‡½æ•°æ³¨å…¥ `IJsonSerializerProvider`
- é™æ€ç±» `JSON.GetJsonSerializer()` æ–¹å¼ï¼Œ**æŸ¥çœ‹ [JSON é™æ€ç±»](./global/json.mdx)**

å¦‚ï¼š

```cs showLineNumbers  {10,13}
using Furion.DynamicApiController;
using Furion.JsonSerialization;

namespace Furion.Application
{
    public class JsonDemo : IDynamicApiController
    {
        private readonly IJsonSerializerProvider _jsonSerializer;
        private readonly IJsonSerializerProvider _jsonSerializer2;
        public JsonDemo(IJsonSerializerProvider jsonSerializer)
        {
            _jsonSerializer = jsonSerializer;
            _jsonSerializer2 = JSON.GetJsonSerializer();
        }
    }
}
```

### 23.4.2 åºåˆ—åŒ–å¯¹è±¡

```cs showLineNumbers
public string GetText()
{
    return _jsonSerializer.Serialize(new
    {
        Id = 1,
        Name = "Furion"
    });
}
```

### 23.4.3 ååºåˆ—åŒ–å­—ç¬¦ä¸²

```cs showLineNumbers
public object GetObject()
{
    var json = "{\"Id\":1,\"Name\":\"Furion\"}";
    var obj = _jsonSerializer.Deserialize<object>(json);
    return obj;
}
```

:::important ç‰¹åˆ«æ³¨æ„

`System.Text.Json` é»˜è®¤ååºåˆ—åŒ–å¤§å°å†™æ•æ„Ÿï¼Œä¹Ÿå°±æ˜¯ä¸å®Œå…¨åŒ¹é…çš„å±æ€§åç§°ä¸ä¼šè‡ªåŠ¨èµ‹å€¼ã€‚è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥å…¨å±€é…ç½®æˆ–å•ç‹¬é…ç½®ã€‚

- å…¨å±€é…ç½®

```cs showLineNumbers
services.AddControllersWithViews()
        .AddJsonOptions(options => {
            options.JsonSerializerOptions.PropertyNameCaseInsensitive = true;
        });
```

- å•ç‹¬é…ç½®

```cs showLineNumbers
var obj = _jsonSerializer.Deserialize<object>(json, new JsonSerializerOptions
   {
       PropertyNameCaseInsensitive = true
   });
```

:::

### 23.4.4 åºåˆ—åŒ–æ›´å¤šé…ç½®

`Furion` æ¡†æ¶ä¸æ¨èä¸€ä¸ªæ¡†æ¶ä¸­æœ‰å¤šç§åºåˆ—åŒ–å®ç°ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´ä½¿ç”¨ `System.Text.Json` å°±ä¸è¦ä½¿ç”¨ `Newtonsoft.Json`ï¼Œåä¹‹äº¦ç„¶ã€‚

å¦‚éœ€é…ç½®æ›´å¤šé€‰é¡¹ï¼Œåªéœ€åˆ›å»º `JsonSerializerOptions` é…ç½®å¯¹è±¡å³å¯ï¼Œå¦‚ï¼š

```cs showLineNumbers  {5}
var json =  _jsonSerializer.Serialize(new
            {
                Id = 1,
                Name = "Furion"
            }, new JsonSerializerOptions {
                WriteIndented = true
            });
```

## 23.5 é«˜çº§ç”¨æ³•

### 23.5.1 è‡ªå®šä¹‰åºåˆ—åŒ–æä¾›å™¨

æ­£å¦‚ä¸Šæ–‡æ‰€è¯´ï¼Œ`Furion` é»˜è®¤çš„ `IJsonSerializerProvider` å®ç°æ–¹å¼æ˜¯ `System.Text.Json` åº“ï¼Œå¦‚éœ€æ›¿æ¢ä¸º `Newtonsoft.Json`ï¼Œåªéœ€ä»¥ä¸‹æ­¥éª¤å³å¯ï¼š

:::tip æ— éœ€å®‰è£…

åœ¨ `Furion 4.6.5+` ç‰ˆæœ¬å·²ç»å†…ç½®äº† `Microsoft.AspNetCore.Mvc.NewtonsoftJson` æ‹“å±•åŒ…ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥åœ¨ `Startup.cs` ä¸­æ³¨å†Œå³å¯ã€‚

:::

1. å®‰è£… `Microsoft.AspNetCore.Mvc.NewtonsoftJson` æ‹“å±•ï¼Œå¹¶åœ¨ `Startup.cs` ä¸­æ³¨å†Œ

```cs showLineNumbers  {2}
services.AddControllersWithViews()
        .AddNewtonsoftJson();
```

2. å®ç° `IJsonSerializerProvider` æä¾›å™¨

```cs showLineNumbers {9}
using Furion.JsonSerialization;
using Newtonsoft.Json;

namespace Furion.Core;

/// <summary>
/// Newtonsoft.Json å®ç°
/// </summary>
public class NewtonsoftJsonSerializerProvider : IJsonSerializerProvider, ISingleton
{
    /// <summary>
    /// åºåˆ—åŒ–å¯¹è±¡
    /// </summary>
    /// <param name="value"></param>
    /// <param name="jsonSerializerOptions"></param>
    /// <returns></returns>
    public string Serialize(object value, object jsonSerializerOptions = null)
    {
        return JsonConvert.SerializeObject(value, (jsonSerializerOptions ?? GetSerializerOptions()) as JsonSerializerSettings);
    }

    /// <summary>
    /// ååºåˆ—åŒ–å­—ç¬¦ä¸²
    /// </summary>
    /// <typeparam name="T"></typeparam>
    /// <param name="json"></param>
    /// <param name="jsonSerializerOptions"></param>
    /// <returns></returns>
    public T Deserialize<T>(string json, object jsonSerializerOptions = null)
    {
        return JsonConvert.DeserializeObject<T>(json, (jsonSerializerOptions ?? GetSerializerOptions()) as JsonSerializerSettings);
    }

    /// <summary>
    /// ååºåˆ—åŒ–å­—ç¬¦ä¸²
    /// </summary>
    /// <param name="json"></param>
    /// <param name="returnType"></param>
    /// <param name="jsonSerializerOptions"></param>
    /// <returns></returns>
    public object Deserialize(string json, Type returnType, object jsonSerializerOptions = null)
    {
        return JsonConvert.DeserializeObject(json, returnType, (jsonSerializerOptions ?? GetSerializerOptions()) as JsonSerializerSettings);
    }

    /// <summary>
    /// è¿”å›è¯»å–å…¨å±€é…ç½®çš„ JSON é€‰é¡¹
    /// </summary>
    /// <returns></returns>
    public object GetSerializerOptions()
    {
        return App.GetOptions<MvcNewtonsoftJsonOptions>()?.SerializerSettings;
    }
}
```

### 23.5.2 åºåˆ—åŒ–å±æ€§åå¤§å†™ï¼ˆå±æ€§åŸæ ·è¾“å‡ºï¼‰

- `System.Text.Json` æ–¹å¼

```cs showLineNumbers
services.AddControllersWithViews()
        .AddJsonOptions(options => {
            options.JsonSerializerOptions.PropertyNamingPolicy = null;
            // options.JsonSerializerOptions.DictionaryKeyPolicy = null;    // é…ç½® Dictionary ç±»å‹åºåˆ—åŒ–è¾“å‡º
        });
```

- `Newtonsoft.Json` æ–¹å¼

```cs showLineNumbers
services.AddControllersWithViews()
        .AddNewtonsoftJson(options =>
        {
            options.SerializerSettings.ContractResolver = new DefaultContractResolver();
        });
```

:::important ç‰¹åˆ«æ³¨æ„

é‡‡ç”¨ `Newtonsoft.Json` æ–¹å¼æ¥å£è¿”å›å€¼èƒ½å¤Ÿæ­£å¸¸è¾“å‡ºï¼Œä½†æ˜¯ `Swagger` ç•Œé¢ä¸­çš„ `Example Values` ä¾ç„¶æ˜¾ç¤ºå°å†™å­—æ¯å¼€å¤´çš„å±æ€§ï¼Œè¿™æ—¶åªéœ€è¦å†æ·»åŠ  `System.Text.Json` é…ç½®å³å¯ï¼Œå¦‚ï¼š

```cs showLineNumbers
.AddJsonOptions(options => {
            options.JsonSerializerOptions.PropertyNamingPolicy = null;
        });
```

ä¸»è¦åŸå› æ˜¯ `Swagger` æ‹“å±•åŒ…åº•å±‚ä¾èµ–äº† `System.Text.Json`ã€‚

:::

### 23.5.3 æ—¶é—´æ ¼å¼åŒ–

- `System.Text.Json` æ–¹å¼

```cs showLineNumbers {2,5}
services.AddControllersWithViews()
        .AddJsonOptions(options =>
        {
            // åœ¨ 4.6.5 ä¹‹å‰çš„ç‰ˆæœ¬ä½¿ç”¨ .AddDateFormatString
            options.JsonSerializerOptions.Converters.AddDateTimeTypeConverters("yyyy-MM-dd HH:mm:ss");
        });
```

:::note å°æç¤º

å¦‚æœä½¿ç”¨ä½¿ç”¨äº† `DateTimeOffset` ç±»å‹ï¼Œé‚£ä¹ˆå¯ä»¥è®¾ç½® `.AddDateTimeTypeConverters("yyyy-MM-dd HH:mm:ss", true)` ç¬¬äºŒä¸ªå‚æ•°ä¸º `true`ï¼Œè‡ªåŠ¨è½¬æ¢æˆæœ¬åœ°æ—¶é—´ã€‚

å¦‚æœä½¿ç”¨äº† `Mysql` æ•°æ®åº“ï¼Œä¸”ä½¿ç”¨äº† `Pomelo.EntityFrameworkCore.MySql` åŒ…ï¼Œé‚£ä¹ˆä¼šå‡ºç°æ—¶åŒºé—®é¢˜ï¼Œæ¯”å¦‚å°‘ 8 å°æ—¶ï¼Œå¯ä»¥å°è¯•é…ç½®ç¬¬äºŒä¸ªå‚æ•°ä¸º `true`ã€‚

:::

éœ€å¼•ç”¨ `System.Text.Json` å‘½åç©ºé—´ã€‚

- `Newtonsoft.Json` æ–¹å¼

```cs showLineNumbers {2,4}
services.AddControllersWithViews()
        .AddNewtonsoftJson(options =>
        {
            options.SerializerSettings.DateFormatString = "yyyy-MM-dd HH:mm:ss";
        });
```

### 23.5.4 å¿½ç•¥å¾ªç¯å¼•ç”¨

- `System.Text.Json` æ–¹å¼

```cs showLineNumbers
services.AddControllersWithViews()
        .AddJsonOptions(options =>
        {
            options.JsonSerializerOptions.ReferenceHandler = ReferenceHandler.IgnoreCycles;
        });
```

:::important ç‰¹åˆ«è¯´æ˜

åœ¨ `.NET 5` ä¸­ï¼Œ`System.Text.Json` å¹¶ä¸æ”¯æŒå¤„ç†å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œä»¥ä¸Šçš„è§£å†³æ–¹æ¡ˆä»…é™ç”¨äº `.NET 6 Preview 2+`ã€‚ğŸ˜‚

:::

éœ€å¼•ç”¨ `System.Text.Json` å‘½åç©ºé—´ã€‚

- `Newtonsoft.Json` æ–¹å¼

```cs showLineNumbers
services.AddControllersWithViews()
        .AddNewtonsoftJson(options =>
        {
            options.SerializerSettings.ReferenceLoopHandling = ReferenceLoopHandling.Ignore;
        });
```

### 23.5.5 åŒ…å«æˆå‘˜å­—æ®µåºåˆ—åŒ–

- `System.Text.Json` æ–¹å¼

```cs showLineNumbers
services.AddControllersWithViews()
        .AddJsonOptions(options =>
        {
            options.JsonSerializerOptions.IncludeFields = true;
        });
```

éœ€å¼•ç”¨ `System.Text.Json` å‘½åç©ºé—´ã€‚

- `Newtonsoft.Json` æ–¹å¼

æ— éœ€é…ç½®ã€‚

### 23.5.6 å…è®¸å°¾éšé€—å·

- `System.Text.Json` æ–¹å¼

```cs showLineNumbers
services.AddControllersWithViews()
        .AddJsonOptions(options =>
        {
            options.JsonSerializerOptions.AllowTrailingCommas = true;
        });
```

éœ€å¼•ç”¨ `System.Text.Json` å‘½åç©ºé—´ã€‚

- `Newtonsoft.Json` æ–¹å¼

æ— éœ€é…ç½®ã€‚

### 23.5.7 å…è®¸æ³¨é‡Š

- `System.Text.Json` æ–¹å¼

```cs showLineNumbers
services.AddControllersWithViews()
        .AddJsonOptions(options =>
        {
            options.JsonSerializerOptions.ReadCommentHandling = JsonCommentHandling.Skip;
        });
```

éœ€å¼•ç”¨ `System.Text.Json` å‘½åç©ºé—´ã€‚

- `Newtonsoft.Json` æ–¹å¼

æ— éœ€é…ç½®ã€‚

### 23.5.8 å¤„ç†ä¹±ç é—®é¢˜

- `System.Text.Json` æ–¹å¼

```cs showLineNumbers
services.AddControllersWithViews()
        .AddJsonOptions(options =>
        {
            options.JsonSerializerOptions.Encoder = JavaScriptEncoder.UnsafeRelaxedJsonEscaping;
        });
```

éœ€å¼•ç”¨ `System.Text.Json` å‘½åç©ºé—´ã€‚

- `Newtonsoft.Json` æ–¹å¼

æ— éœ€é…ç½®ã€‚

### 23.5.9 ä¸åŒºåˆ†å¤§å°å†™

- `System.Text.Json` æ–¹å¼

```cs showLineNumbers
services.AddControllersWithViews()
        .AddJsonOptions(options =>
        {
            options.JsonSerializerOptions.PropertyNameCaseInsensitive = true;
        });
```

éœ€å¼•ç”¨ `System.Text.Json` å‘½åç©ºé—´ã€‚

- `Newtonsoft.Json` æ–¹å¼

:::tip æ›´å¤šåºåˆ—åŒ–é…ç½®

è¿™é‡Œåªåˆ—ä¸¾å¸¸ç”¨è§çš„åºåˆ—åŒ–é…ç½®ï¼Œå¦‚éœ€æŸ¥çœ‹æ›´å¤šé…ç½®ï¼Œå¯æŸ¥é˜… [System.Text.Json æ–‡æ¡£](https://docs.microsoft.com/zh-cn/dotnet/standard/serialization/system-text-json-configure-options?pivots=dotnet-5-0)

:::

### 23.5.10 å¿½ç•¥ç‰¹å®šå±æ€§åºåˆ—åŒ–

æœ‰æ—¶å€™æˆ‘ä»¬ä¸å¸Œæœ›å¯¹è±¡ä¸­æŸä¸ªå¯¹è±¡è¢«åºåˆ—åŒ–å‡ºæ¥æˆ–è€…ä¸æƒ³åœ¨ `Swagger` ä¸­æ˜¾ç¤ºï¼Œè¿™æ—¶å€™åªéœ€è¦åœ¨å±æ€§è´´è¯¥ç‰¹æ€§å³å¯ï¼š

```cs showLineNumbers
[Newtonsoft.Json.JsonIgnore]    // é’ˆå¯¹ Newtonsoft
[System.Text.Json.Serialization.JsonIgnore] // é’ˆå¯¹ System.Text.Json
public string PropertyName {get; set;}
```

### 23.5.11 åŠ¨æ€å¯¹è±¡å±æ€§åå¤§å†™é—®é¢˜

æœ‰æ—¶å€™ä½¿ç”¨äº†åŠ¨æ€å¯¹è±¡åå‘ç°å±æ€§åå‡ºç°äº†å¤§å†™æƒ…å†µï¼ˆé¦–å­—æ¯ï¼‰ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥å°è¯•ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è§£å†³ï¼š

```cs showLineNumbers
.AddNewtonsoftJson(options =>
{
    options.SerializerSettings.ContractResolver = new CamelCasePropertyNamesContractResolver();
})
```

### 23.5.12 å¿½ç•¥æ‰€æœ‰ `null` å±æ€§

- `System.Text.Json` æ–¹å¼

```cs showLineNumbers {4}
services.AddControllersWithViews()
        .AddJsonOptions(options =>
        {
            options.JsonSerializerOptions.DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull;
        });
```

- `Newtonsoft.Json` æ–¹å¼

```cs showLineNumbers {3}
.AddNewtonsoftJson(options =>
{
        options.SerializerSettings.NullValueHandling = NullValueHandling.Ignore;
})
```

### 23.5.13 å¿½ç•¥æ‰€æœ‰é»˜è®¤å€¼å±æ€§

- `System.Text.Json` æ–¹å¼

```cs showLineNumbers {4}
services.AddControllersWithViews()
        .AddJsonOptions(options =>
        {
            options.JsonSerializerOptions.DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingDefault;
        });
```

- `Newtonsoft.Json` æ–¹å¼

```cs showLineNumbers {3}
.AddNewtonsoftJson(options =>
{
        options.SerializerSettings.DefaultValueHandling = DefaultValueHandling.Ignore;
})
```

### 23.5.14 æ§åˆ¶å±æ€§åºåˆ—åŒ–é¡ºåº

```cs showLineNumbers
[Newtonsoft.Json.JsonProperty(Order = 0)]    // é’ˆå¯¹ Newtonsoft
[System.Text.Json.Serialization.JsonPropertyOrder(0)] // é’ˆå¯¹ System.Text.Json
public string PropertyName {get; set;}
```

### 23.5.15 é‡å‘½ååºåˆ—åŒ–å±æ€§

```cs showLineNumbers
[Newtonsoft.Json.JsonProperty("newName")]    // é’ˆå¯¹ Newtonsoft
[System.Text.Json.Serialization.JsonPropertyName("newName")] // é’ˆå¯¹ System.Text.Json
public string PropertyName {get; set;}
```

### 23.5.16 `JSON` å­—ç¬¦ä¸²ç¼©è¿›

- `System.Text.Json` æ–¹å¼

```cs showLineNumbers {4}
services.AddControllersWithViews()
        .AddJsonOptions(options =>
        {
            options.JsonSerializerOptions.WriteIndented = true;
        });
```

- `Newtonsoft.Json` æ–¹å¼

```cs showLineNumbers {3}
.AddNewtonsoftJson(options =>
{
        options.SerializerSettings.Formatting = Newtonsoft.Json.Formatting.Indented;
})
```

### 23.5.17 `long` ç±»å‹åºåˆ—åŒ–æ—¶è½¬ `string`

æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦å°† ` long` ç±»å‹åºåˆ—åŒ–æ—¶è½¬ä¸º `string` ç±»å‹ï¼Œé˜²æ­¢ `JavaScript` å‡ºç°ç²¾åº¦æº¢å‡ºé—®é¢˜ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥å°è¯•ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è§£å†³ï¼š

- `System.Text.Json` æ–¹å¼

```cs showLineNumbers {2,4}
services.AddControllersWithViews()
        .AddJsonOptions(options =>
        {
            options.JsonSerializerOptions.Converters.AddLongTypeConverters();
        });
```

- `Newtonsoft.Json` æ–¹å¼

```cs showLineNumbers {3}
.AddNewtonsoftJson(options =>
{
     options.SerializerSettings.Converters.AddLongTypeConverters();
})
```

:::note å…³äº `Dictionary<,>` ç±»å‹åŒ…å« `long` å¤„ç†

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`System.Text.Json` ä¸æ”¯æŒ `Dictionary<,>` ç±»å‹çš„åºåˆ—åŒ–è®¾ç½® `Converter` æ“ä½œï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥æ¢æˆ `Newtonsoft.Json` å¤„ç†ï¼Œå¦‚ï¼š

```cs showLineNumbers {3}
.AddNewtonsoftJson(options =>
{
    options.SerializerSettings.Converters.AddLongTypeConverters();
})
```

åŒæ—¶åˆ›å»º `NewtonsoftJsonSerializerProvider.cs` æ–‡ä»¶å†™å…¥å³å¯ï¼š

```cs showLineNumbers
namespace YourProject.Core;

public class NewtonsoftJsonSerializerProvider : IJsonSerializerProvider, ISingleton
{
    public string Serialize(object value, object jsonSerializerOptions = null)
    {
        return JsonConvert.SerializeObject(value, (jsonSerializerOptions ?? GetSerializerOptions()) as JsonSerializerSettings);
    }

    public T Deserialize<T>(string json, object jsonSerializerOptions = null)
    {
        return JsonConvert.DeserializeObject<T>(json, (jsonSerializerOptions ?? GetSerializerOptions()) as JsonSerializerSettings);
    }

    public object GetSerializerOptions()
    {
        return App.GetOptions<MvcNewtonsoftJsonOptions>()?.SerializerSettings;
    }
}
```

:::

### 23.5.18 `DateOnly` å’Œ `TimeOnly` ç±»å‹åºåˆ—åŒ–æ”¯æŒ

åœ¨ `.NET6+` æ·»åŠ äº† `DateOnly` å’Œ `TimeOnly` ç±»å‹ï¼Œ`Furion 4.7.9+` æä¾›äº†æ”¯æŒã€‚

- `System.Text.Json` æ–¹å¼

```cs showLineNumbers {2,4-5}
services.AddControllersWithViews()
        .AddJsonOptions(options =>
        {
            options.JsonSerializerOptions.Converters.AddDateOnlyConverters();   // DateOnly
            options.JsonSerializerOptions.Converters.AddTimeOnlyConverters();   // TimeOnly
        });
```

- `Newtonsoft.Json` æ–¹å¼

```cs showLineNumbers {3-4}
.AddNewtonsoftJson(options =>
{
        options.SerializerSettings.Converters.AddDateOnlyConverters();   // DateOnly
        options.SerializerSettings.Converters.AddTimeOnlyConverters();   // TimeOnly
})
```

### 23.5.19 ç²˜åœŸå¯¹è±¡ `Clay` ç±»å‹åºåˆ—åŒ–æ”¯æŒ

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`Clay` ä¸ºåŠ¨æ€ç±»å‹å¯¹è±¡ï¼Œä¸æ”¯æŒç›´æ¥é€šè¿‡ `System.Text.Json` å’Œ `Newtonsoft.Json` è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œè¿™æ—¶åªéœ€æ·»åŠ ä»¥ä¸‹é…ç½®å³å¯ã€‚

- `System.Text.Json` æ–¹å¼

```cs showLineNumbers {2,4}
services.AddControllersWithViews()
        .AddJsonOptions(options =>
        {
            options.JsonSerializerOptions.Converters.AddClayConverters();
        });
```

- `Newtonsoft.Json` æ–¹å¼

```cs showLineNumbers {3}
.AddNewtonsoftJson(options =>
{
     options.SerializerSettings.Converters.AddClayConverters();
})
```

### 23.5.20 `DateTimeOffset` ååºåˆ—åŒ–å¼‚å¸¸

ä»¥ä¸‹å¤„ç†åªé’ˆå¯¹ `Newtonsoft.Json`ï¼Œæ•°æ®ä¸º `0001-01-01 00:00:00` çš„æƒ…å½¢ä¸‹ååºåˆ—åŒ–ä¸º `DateTimeOffset` ç±»å‹æŠ¥é”™ï¼š

```txt showLineNumbers
Could not convert string to DateTimeOffset: 0001-01-01 00:00:00
```

ç›¸å…³é—®é¢˜è®¨è®ºï¼š[https://stackoverflow.com/questions/50628374/json-net-deserializing-datetimeoffset-value-fails-for-datetimeoffset-minvalue-wi/50631270#50631270](https://stackoverflow.com/questions/50628374/json-net-deserializing-datetimeoffset-value-fails-for-datetimeoffset-minvalue-wi/50631270#50631270)

- `System.Text.Json` æ–¹å¼

æ— éœ€é…ç½®

- `Newtonsoft.Json` æ–¹å¼

```cs showLineNumbers {3-5}
.AddNewtonsoftJson(options =>
{
    options.SerializerSettings.MetadataPropertyHandling = MetadataPropertyHandling.Ignore;
    options.SerializerSettings.DateParseHandling = DateParseHandling.None;
    options.SerializerSettings.Converters.Add(new IsoDateTimeConverter { DateTimeStyles = DateTimeStyles.AssumeUniversal });
});
```

### 23.5.21 ç»§æ‰¿/æ´¾ç”Ÿç±»åºåˆ—åŒ–é—®é¢˜

åœ¨ `.NET7` ä¹‹å‰ï¼Œ`System.Text.Json` é»˜è®¤ä¸æ”¯æŒåºåˆ—åŒ–åŸºç±»å±æ€§ï¼Œä½†ä¹Ÿæä¾›äº†è§£å†³æ–¹æ³•ï¼š

```cs showLineNumbers {1,4}
// ç¬¬ä¸€ç§ï¼Œä½¿ç”¨ <object> æ³›å‹
var json = JsonSerializer.Serialize<object>(value);

// ç¬¬äºŒç§ï¼Œä½¿ç”¨ Type å‚æ•°
var json = JsonSerializer.Serialize(value, value.GetType());
```

æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£ï¼š[https://learn.microsoft.com/zh-cn/dotnet/standard/serialization/system-text-json/polymorphism?pivots=dotnet-6-0](https://learn.microsoft.com/zh-cn/dotnet/standard/serialization/system-text-json/polymorphism?pivots=dotnet-6-0)

## 23.6 `DataTable`ã€`DataSet`ã€`Tuple` ã€`JArray`ï¼Œ`JObject`ï¼Œ`JToken` ç­‰åºåˆ—åŒ–é—®é¢˜

ç”±äº `Furion` é»˜è®¤é‡‡ç”¨ `System.Text.Json` è¿›è¡Œåºåˆ—åŒ–ï¼Œä½†æ˜¯ä¸æ”¯æŒå¤æ‚ç±»å‹ï¼Œå¦‚ `DataTable`ã€`DataSet`ã€`Tuple` ã€`JArray`ï¼Œ`JObject`ã€`JToken` ç­‰ç±»å‹ï¼Œæ‰€ä»¥éœ€è¦æ›´æ¢æˆ `NewtonsoftJson` å³å¯ï¼Œè§ [JSON åºåˆ—åŒ– - 23.5.1 è‡ªå®šä¹‰åºåˆ—åŒ–æä¾›å™¨](./json-serialization#2351-è‡ªå®šä¹‰åºåˆ—åŒ–æä¾›å™¨)

## 23.7 `System.Text.Json` å’Œ `Newtonsoft.Json` å®Œæ•´å·®å¼‚åŒ–å¯¹æ¯”

[https://docs.microsoft.com/zh-cn/dotnet/standard/serialization/system-text-json-migrate-from-newtonsoft-how-to?pivots=dotnet-5-0](https://docs.microsoft.com/zh-cn/dotnet/standard/serialization/system-text-json-migrate-from-newtonsoft-how-to?pivots=dotnet-5-0)

## 23.8 åé¦ˆä¸å»ºè®®

:::note ä¸æˆ‘ä»¬äº¤æµ

ç»™ Furion æ [Issue](https://gitee.com/dotnetchina/Furion/issues/new?issue)ã€‚

:::
